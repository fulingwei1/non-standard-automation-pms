name: Contract Drift Detection

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  contract-drift:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r api/requirements.txt

      - name: Fetch main branch baseline
        run: |
          git fetch origin main

      - name: Generate baseline from main branch
        run: |
          git checkout origin/main
          python3 -c "from tests.scripts.generate_openapi_baseline import generate_openapi_baseline; generate_openapi_baseline()"
          mv tests/openapi_baseline.json /tmp/baseline_main.json

      - name: Checkout PR branch
        run: |
          git checkout ${{ github.sha }}

      - name: Generate baseline from PR branch
        run: |
          python3 -c "from tests.scripts.generate_openapi_baseline import generate_openapi_baseline; generate_openapi_baseline()"
          mv tests/openapi_baseline.json /tmp/baseline_pr.json

      - name: Compare schemas
        run: |
          python3 -c "
          import json
          import sys

          baseline_main = json.load(open('/tmp/baseline_main.json'))
          baseline_pr = json.load(open('/tmp/baseline_pr.json'))

          # Check for removed endpoints
          main_paths = set(baseline_main.get('paths', {}).keys())
          pr_paths = set(baseline_pr.get('paths', {}).keys())

          removed = main_paths - pr_paths
          if removed:
              print(f'❌ CONTRACT DRIFT DETECTED: {len(removed)} endpoints removed')
              for endpoint in sorted(removed):
                  print(f'  Removed: {endpoint}')
              sys.exit(1)

          # Check for breaking changes
          main_schemas = set(baseline_main.get('components', {}).get('schemas', {}).keys())
          pr_schemas = set(baseline_pr.get('components', {}).get('schemas', {}).keys())

          added = pr_schemas - main_schemas
          if added:
              print(f'✅ {len(added)} new schemas added (non-breaking)')

          print(f'✅ No contract drift detected!')
          print(f'  Endpoints: {len(pr_paths)}')
          print(f'  Schemas: {len(pr_schemas)}')
          "

      - name: Upload baseline artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openapi-baselines
          path: |
            /tmp/baseline_main.json
            /tmp/baseline_pr.json

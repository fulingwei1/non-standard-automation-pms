# 预警/定时服务验证指南

## 文档信息
- **创建日期**: 2026-01-XX
- **版本**: v1.0
- **状态**: ✅ 已完成

---

## 概述

本文档提供验证所有24个预警/定时服务是否正常工作的指南。

---

## 快速验证

### 1. 使用验证脚本

运行自动化验证脚本：

```bash
python3 test_scheduled_services.py
```

脚本会检查：
- ✅ 所有服务的导入是否正常
- ✅ 数据库连接是否正常
- ✅ 所有服务函数是否存在
- ✅ 调度器配置是否正确

### 2. 手动验证

#### 2.1 检查调度器是否启动

启动应用后，查看日志应该看到：

```
定时任务调度器已启动（包含24个预警/定时服务）
```

#### 2.2 检查已注册的任务

在Python交互式环境中：

```python
from app.utils.scheduler import scheduler

# 查看所有已注册的任务
jobs = scheduler.get_jobs()
print(f"已注册任务数: {len(jobs)}")

for job in jobs:
    print(f"{job.id}: {job.name} - 下次执行: {job.next_run_time}")
```

应该看到24个任务已注册。

---

## 详细验证步骤

### 步骤1: 验证服务导入

```python
from app.utils.scheduled_tasks import (
    calculate_project_health,
    daily_health_snapshot,
    # ... 其他服务
    check_equipment_maintenance_reminder,
    send_alert_notifications
)
```

如果导入成功，说明所有服务函数已正确定义。

### 步骤2: 验证调度器初始化

```python
from app.utils.scheduler import init_scheduler, scheduler

# 初始化调度器
init_scheduler()

# 检查调度器状态
print(f"调度器运行状态: {scheduler.running}")
print(f"已注册任务数: {len(scheduler.get_jobs())}")
```

### 步骤3: 手动执行单个服务（测试用）

```python
from app.utils.scheduled_tasks import check_payment_reminder

# 手动执行服务（用于测试）
result = check_payment_reminder()
print(result)
```

### 步骤4: 检查服务执行日志

查看应用日志，应该看到类似以下内容：

```
[2026-01-XX 09:30:00] 收款提醒服务完成: 发送 X 条提醒
[2026-01-XX 10:30:00] 逾期应收预警检查完成: 检查 X 张发票, 生成 X 个预警
```

---

## 服务清单验证

### 已实现的服务（24个）

| 序号 | 服务名称 | 执行时间 | 验证方法 |
|:----:|---------|---------|---------|
| 1 | 健康度自动计算 | 整点 | 检查项目健康度是否更新 |
| 2 | 健康度快照 | 02:00 | 检查快照表是否有新记录 |
| 3 | 规格匹配检查 | 09:00 | 检查匹配记录是否生成 |
| 4 | 问题逾期预警 | 整点 | 检查预警记录是否生成 |
| 5 | 阻塞问题预警 | 整点+5分 | 检查预警记录是否生成 |
| 6 | 问题超时升级 | 01:00 | 检查问题级别是否升级 |
| 7 | 问题统计快照 | 03:00 | 检查快照表是否有新记录 |
| 8 | 里程碑预警 | 08:00 | 检查预警记录是否生成 |
| 9 | 成本超支预警 | 10:00 | 检查预警记录是否生成 |
| 10 | 负荷超限预警 | 11:00 | 检查预警记录是否生成 |
| 11 | 缺料预警生成 | 07:00 | 检查预警记录是否生成 |
| 12 | 任务延期预警 | 整点 | 检查预警记录是否生成 |
| 13 | 生产计划预警 | 11:00 | 检查预警记录是否生成 |
| 14 | 报工超时提醒 | 整点 | 检查预警记录是否生成 |
| 15 | 进度汇总计算 | 整点 | 检查项目进度是否更新 |
| 16 | 每日齐套检查 | 06:00 | 检查预警记录是否生成 |
| 17 | 到货延迟检查 | 14:00 | 检查预警记录是否生成 |
| 18 | 任务到期提醒 | 整点 | 检查预警记录是否生成 |
| 19 | 外协交期预警 | 15:00 | 检查预警记录是否生成 |
| 20 | 里程碑风险预警 | 08:10 | 检查预警记录是否生成 |
| 21 | 生产日报生成 | 05:00 | 检查日报表是否有新记录 |
| 22 | 缺料日报生成 | 05:15 | 检查日报表是否有新记录 |
| 23 | 岗位职责任务生成 | 04:00 | 检查任务表是否有新记录 |
| 24 | ECN超时检查 | 09:00 | 检查ECN提醒是否生成 |
| 25 | 收款提醒服务 | 09:30 | 检查通知是否生成 |
| 26 | 逾期应收预警 | 10:30 | 检查预警记录是否生成 |
| 27 | 预警升级服务 | 整点+10分 | 检查预警级别是否升级 |
| 28 | 商机阶段超时提醒 | 15:30 | 检查通知是否生成 |
| 29 | 售前工单超时提醒 | 16:00 | 检查通知是否生成 |
| 30 | 问题超时升级服务 | 01:30 | 检查问题级别是否升级 |
| 31 | 设备保养提醒服务 | 08:30 | 检查通知是否生成 |
| 32 | 消息推送服务 | 整点+15分 | 检查通知是否生成 |

---

## 常见问题排查

### 问题1: 调度器未启动

**症状**: 日志中没有"定时任务调度器已启动"消息

**解决方法**:
1. 检查 `app/main.py` 中是否调用了 `init_scheduler()`
2. 检查 APScheduler 是否已安装: `pip list | grep apscheduler`
3. 检查是否有异常阻止调度器启动

### 问题2: 任务未执行

**症状**: 任务已注册但未按计划执行

**解决方法**:
1. 检查系统时间是否正确
2. 检查时区设置（应为 Asia/Shanghai）
3. 查看调度器日志是否有错误
4. 手动执行任务测试是否正常

### 问题3: 服务执行失败

**症状**: 日志中出现服务执行错误

**解决方法**:
1. 查看详细错误堆栈
2. 检查数据库连接是否正常
3. 检查相关数据模型是否存在
4. 检查服务函数中的异常处理

### 问题4: 导入错误

**症状**: 导入服务函数时出错

**解决方法**:
1. 检查 `app/utils/scheduled_tasks.py` 文件是否存在
2. 检查函数名是否正确
3. 检查依赖的模型和工具是否已导入

---

## 性能监控建议

### 监控指标

1. **任务执行时间**: 记录每个任务的执行耗时
2. **任务执行频率**: 统计每个任务的执行次数
3. **任务失败率**: 统计任务执行失败的比例
4. **预警生成数量**: 统计各类型预警的生成数量

### 日志记录

所有服务都应该记录：
- 执行开始时间
- 执行结束时间
- 处理的数据量
- 生成的结果数量
- 错误信息（如果有）

---

## 测试建议

### 单元测试

为每个服务函数编写单元测试：

```python
def test_check_payment_reminder():
    """测试收款提醒服务"""
    result = check_payment_reminder()
    assert 'reminder_count' in result
    assert result['reminder_count'] >= 0
```

### 集成测试

测试服务与数据库的集成：

```python
def test_service_with_database():
    """测试服务与数据库集成"""
    with get_db_session() as db:
        # 准备测试数据
        # 执行服务
        # 验证结果
        pass
```

---

## 相关文档

- `ALERT_SERVICES_IMPLEMENTATION_COMPLETE.md` - 服务实现总结
- `P0_ALERT_SERVICES_IMPLEMENTATION.md` - P0服务实现文档
- `app/utils/scheduled_tasks.py` - 服务实现代码
- `app/utils/scheduler.py` - 调度器配置代码

---

**最后更新**: 2026-01-XX






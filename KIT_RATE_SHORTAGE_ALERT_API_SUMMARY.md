# é½å¥—ç‡ä¸ç‰©æ–™ä¿éšœã€ç¼ºæ–™é¢„è­¦ç®¡ç† API å®ç°æ€»ç»“

## æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†é½å¥—ç‡è®¡ç®—ã€ç‰©æ–™ä¿éšœå’Œç¼ºæ–™é¢„è­¦ç®¡ç†åŠŸèƒ½çš„ API å®ç°æƒ…å†µã€‚

## å®ç°æ—¶é—´

2025-01-XX

## 1. é½å¥—ç‡è®¡ç®— API (`/api/v1/kit-rate`)

### 1.1 é¡¹ç›®é½å¥—ç‡è®¡ç®—

**ç«¯ç‚¹**: `GET /projects/{project_id}/kit-rate`

**åŠŸèƒ½**:
- è®¡ç®—é¡¹ç›®æ•´ä½“é½å¥—ç‡
- æ”¯æŒæŒ‰æ•°é‡æˆ–é‡‘é¢åŠ æƒè®¡ç®—
- åŒ…å«é¡¹ç›®ä¸‹æ‰€æœ‰æœºå°çš„é½å¥—ç‡ç»Ÿè®¡

**è¯·æ±‚å‚æ•°**:
- `project_id`: é¡¹ç›®IDï¼ˆè·¯å¾„å‚æ•°ï¼‰
- `calculate_by`: è®¡ç®—æ–¹å¼ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼Œé»˜è®¤"quantity"ï¼‰
  - `quantity`: æŒ‰æ•°é‡åŠ æƒ
  - `amount`: æŒ‰é‡‘é¢åŠ æƒ

**å“åº”**: `dict`

**å“åº”ç»“æ„**:
```json
{
  "project_id": 1,
  "project_code": "PJ202501-001",
  "project_name": "é¡¹ç›®1",
  "total_items": 50,
  "fulfilled_items": 40,
  "shortage_items": 5,
  "in_transit_items": 5,
  "kit_rate": 80.0,
  "kit_status": "partial",
  "total_quantity": 1000.0,
  "fulfilled_quantity": 800.0,
  "total_amount": 100000.0,
  "fulfilled_amount": 80000.0,
  "calculate_by": "quantity",
  "machines": [
    {
      "machine_id": 1,
      "machine_no": "M001",
      "machine_name": "æœºå°1",
      "kit_rate": 85.0,
      "kit_status": "partial",
      ...
    }
  ]
}
```

**è®¡ç®—é€»è¾‘**:
- é½å¥—ç‡ = (å·²æ»¡è¶³æ•°é‡ / æ€»éœ€æ±‚æ•°é‡) Ã— 100%
- é½å¥—çŠ¶æ€ï¼š
  - `complete`: é½å¥—ç‡ >= 100%
  - `partial`: é½å¥—ç‡ >= 80%
  - `shortage`: é½å¥—ç‡ < 80%

### 1.2 æœºå°é½å¥—ç‡è®¡ç®—

**ç«¯ç‚¹**: `GET /machines/{machine_id}/kit-rate`

**åŠŸèƒ½**:
- è®¡ç®—æœºå°BOMçš„é½å¥—ç‡
- æ”¯æŒæŒ‰æ•°é‡æˆ–é‡‘é¢åŠ æƒè®¡ç®—

**è¯·æ±‚å‚æ•°**:
- `machine_id`: æœºå°IDï¼ˆè·¯å¾„å‚æ•°ï¼‰
- `calculate_by`: è®¡ç®—æ–¹å¼ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼Œé»˜è®¤"quantity"ï¼‰

**å“åº”**: `dict`

### 1.3 æœºå°ç‰©æ–™çŠ¶æ€

**ç«¯ç‚¹**: `GET /machines/{machine_id}/material-status`

**åŠŸèƒ½**:
- è·å–æœºå°BOMä¸­æ‰€æœ‰ç‰©æ–™çš„è¯¦ç»†åˆ°è´§çŠ¶æ€
- åŒ…å«å½“å‰åº“å­˜ã€å·²åˆ°è´§æ•°é‡ã€åœ¨é€”æ•°é‡ã€çŸ­ç¼ºæ•°é‡ç­‰

**å“åº”**: `dict`

**å“åº”ç»“æ„**:
```json
{
  "machine_id": 1,
  "machine_no": "M001",
  "machine_name": "æœºå°1",
  "bom_id": 1,
  "bom_no": "BOM-PJ202501-001",
  "materials": [
    {
      "material_id": 1,
      "material_code": "MAT-001",
      "material_name": "ç‰©æ–™1",
      "required_qty": 10.0,
      "current_stock": 5.0,
      "received_qty": 2.0,
      "in_transit_qty": 1.0,
      "total_available": 8.0,
      "shortage_qty": 2.0,
      "status": "partial",
      "is_key_item": false
    }
  ]
}
```

### 1.4 é¡¹ç›®ç‰©æ–™æ±‡æ€»

**ç«¯ç‚¹**: `GET /projects/{project_id}/material-status`

**åŠŸèƒ½**:
- è·å–é¡¹ç›®ä¸‹æ‰€æœ‰æœºå°çš„ç‰©æ–™çŠ¶æ€æ±‡æ€»
- æŒ‰ç‰©æ–™æ±‡æ€»éœ€æ±‚æ•°é‡ã€å¯ç”¨æ•°é‡ã€çŸ­ç¼ºæ•°é‡

**å“åº”**: `dict`

### 1.5 ç¼ºæ–™æ¸…å•

**ç«¯ç‚¹**: `GET /projects/{project_id}/shortage`

**åŠŸèƒ½**:
- è·å–é¡¹ç›®çš„ç¼ºæ–™æ¸…å•
- åªè¿”å›çŸ­ç¼ºæ•°é‡ > 0 çš„ç‰©æ–™

**å“åº”**: `dict`

### 1.6 å…³é”®ç‰©æ–™ç¼ºå£

**ç«¯ç‚¹**: `GET /projects/{project_id}/critical-shortage`

**åŠŸèƒ½**:
- è·å–é¡¹ç›®çš„å…³é”®ç‰©æ–™ç¼ºå£
- åªè¿”å›å…³é”®ç‰©æ–™ï¼ˆ`is_key_item=True`ï¼‰çš„ç¼ºæ–™æƒ…å†µ

**å“åº”**: `dict`

### 1.7 é½å¥—çœ‹æ¿æ•°æ®

**ç«¯ç‚¹**: `GET /kit-rate/dashboard`

**åŠŸèƒ½**:
- è·å–å…¨å±€é½å¥—çœ‹æ¿æ•°æ®
- æ”¯æŒæŒ‰é¡¹ç›®ç­›é€‰

**è¯·æ±‚å‚æ•°**:
- `project_ids`: é¡¹ç›®IDåˆ—è¡¨ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼Œé€—å·åˆ†éš”ï¼‰

**å“åº”**: `dict`

**å“åº”ç»“æ„**:
```json
{
  "summary": {
    "total_projects": 10,
    "complete_projects": 5,
    "partial_projects": 3,
    "shortage_projects": 2
  },
  "projects": [
    {
      "project_id": 1,
      "project_code": "PJ202501-001",
      "project_name": "é¡¹ç›®1",
      "kit_rate": 95.0,
      "kit_status": "complete",
      "total_items": 50,
      "fulfilled_items": 48,
      "shortage_items": 2
    }
  ]
}
```

### 1.8 é½å¥—è¶‹åŠ¿åˆ†æ ğŸ†•

**ç«¯ç‚¹**: `GET /kit-rate/trend`

**åŠŸèƒ½**:
- è·å–é½å¥—ç‡è¶‹åŠ¿åˆ†ææ•°æ®
- æŒ‰æ—¶é—´åˆ†ç»„ç»Ÿè®¡é½å¥—ç‡å˜åŒ–è¶‹åŠ¿

**è¯·æ±‚å‚æ•°**:
- `project_id`: é¡¹ç›®IDï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼Œä¸æä¾›åˆ™æŸ¥è¯¢æ‰€æœ‰é¡¹ç›®ï¼‰
- `start_date`: å¼€å§‹æ—¥æœŸï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼Œé»˜è®¤30å¤©å‰ï¼‰
- `end_date`: ç»“æŸæ—¥æœŸï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼Œé»˜è®¤ä»Šå¤©ï¼‰
- `group_by`: åˆ†ç»„æ–¹å¼ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼Œé»˜è®¤"day"ï¼‰
  - `day`: æŒ‰å¤©åˆ†ç»„
  - `week`: æŒ‰å‘¨åˆ†ç»„
  - `month`: æŒ‰æœˆåˆ†ç»„

**å“åº”**: `dict`

**å“åº”ç»“æ„**:
```json
{
  "start_date": "2025-01-01",
  "end_date": "2025-01-31",
  "group_by": "day",
  "trend_data": [
    {
      "date": "2025-01-01",
      "kit_rate": 80.0,
      "project_count": 10
    },
    {
      "date": "2025-01-02",
      "kit_rate": 82.0,
      "project_count": 10
    }
  ],
  "summary": {
    "avg_kit_rate": 81.5,
    "max_kit_rate": 95.0,
    "min_kit_rate": 75.0
  }
}
```

**æ³¨æ„**: å½“å‰å®ç°ä½¿ç”¨å½“å‰æ•°æ®æ¨¡æ‹Ÿè¶‹åŠ¿ï¼Œå®é™…åº”è¯¥ä»å†å²è®°å½•è¡¨æŸ¥è¯¢å¿«ç…§æ•°æ®ã€‚

## 2. ç¼ºæ–™é¢„è­¦ç®¡ç† API (`/api/v1/shortage-alerts`)

### 2.1 ç¼ºæ–™é¢„è­¦åˆ—è¡¨

**ç«¯ç‚¹**: `GET /shortage-alerts`

**åŠŸèƒ½**:
- è·å–ç¼ºæ–™é¢„è­¦åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µã€ç­›é€‰ï¼‰

**è¯·æ±‚å‚æ•°**:
- `page`: é¡µç ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œé»˜è®¤1ï¼‰
- `page_size`: æ¯é¡µæ•°é‡ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œé»˜è®¤20ï¼‰
- `project_id`: é¡¹ç›®IDç­›é€‰ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼‰
- `material_id`: ç‰©æ–™IDç­›é€‰ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼‰
- `status`: çŠ¶æ€ç­›é€‰ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼‰
- `alert_level`: é¢„è­¦çº§åˆ«ç­›é€‰ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼‰
- `handler_id`: å¤„ç†äººIDç­›é€‰ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼‰

**å“åº”**: `PaginatedResponse`

### 2.2 ç¼ºæ–™é¢„è­¦è¯¦æƒ…

**ç«¯ç‚¹**: `GET /shortage-alerts/{alert_id}`

**åŠŸèƒ½**:
- è·å–ç¼ºæ–™é¢„è­¦çš„è¯¦ç»†ä¿¡æ¯

**å“åº”**: `dict`

### 2.3 ç¡®è®¤é¢„è­¦

**ç«¯ç‚¹**: `PUT /shortage-alerts/{alert_id}/acknowledge`

**åŠŸèƒ½**:
- PMCç¡®è®¤ç¼ºæ–™é¢„è­¦
- å°†çŠ¶æ€ä» `OPEN` æ”¹ä¸º `ACKNOWLEDGED`

**å“åº”**: `ResponseModel`

### 2.4 å¤„ç†é¢„è­¦

**ç«¯ç‚¹**: `PATCH /shortage-alerts/{alert_id}`

**åŠŸèƒ½**:
- æ›´æ–°ç¼ºæ–™é¢„è­¦çš„å¤„ç†æªæ–½
- æ”¯æŒæ›´æ–°è§£å†³æ–¹æ¡ˆã€å¤„ç†äººã€é¢„è­¦çº§åˆ«ã€å¤‡æ³¨

**è¯·æ±‚ä½“**:
```json
{
  "solution": "å·²è”ç³»ä¾›åº”å•†ç´§æ€¥é‡‡è´­",
  "handler_id": 1,
  "alert_level": "HIGH",
  "remark": "ç´§æ€¥å¤„ç†"
}
```

**å“åº”**: `ResponseModel`

### 2.5 è§£å†³é¢„è­¦

**ç«¯ç‚¹**: `POST /shortage-alerts/{alert_id}/resolve`

**åŠŸèƒ½**:
- è§£å†³ç¼ºæ–™é¢„è­¦ï¼ˆç»“æ¡ˆï¼‰
- å°†çŠ¶æ€æ”¹ä¸º `RESOLVED`
- è®°å½•è§£å†³æ—¶é—´å’Œè§£å†³æ–¹æ¡ˆ

**è¯·æ±‚ä½“**:
```json
{
  "solution": "ç‰©æ–™å·²åˆ°è´§ï¼Œé—®é¢˜å·²è§£å†³"
}
```

**å“åº”**: `ResponseModel`

### 2.6 æ·»åŠ è·Ÿè¿›è®°å½• ğŸ†•

**ç«¯ç‚¹**: `POST /shortage-alerts/{alert_id}/follow-ups`

**åŠŸèƒ½**:
- æ·»åŠ ç¼ºæ–™é¢„è­¦çš„è·Ÿè¿›è®°å½•
- è·Ÿè¿›è®°å½•å­˜å‚¨åœ¨å¤‡æ³¨å­—æ®µï¼ˆJSONæ ¼å¼ï¼‰

**è¯·æ±‚ä½“**:
```json
{
  "follow_up_note": "å·²è”ç³»ä¾›åº”å•†ï¼Œé¢„è®¡3å¤©å†…åˆ°è´§",
  "follow_up_type": "CALL",
  "next_follow_up_date": "2025-01-25"
}
```

**å“åº”**: `ResponseModel`

**å“åº”æ•°æ®**:
```json
{
  "code": 200,
  "message": "è·Ÿè¿›è®°å½•å·²æ·»åŠ ",
  "data": {
    "alert_id": 1,
    "follow_up_count": 3,
    "latest_follow_up": {
      "type": "CALL",
      "note": "å·²è”ç³»ä¾›åº”å•†ï¼Œé¢„è®¡3å¤©å†…åˆ°è´§",
      "created_at": "2025-01-22T10:00:00",
      "created_by": 1,
      "created_by_name": "å¼ ä¸‰",
      "next_follow_up_date": "2025-01-25"
    }
  }
}
```

**è·Ÿè¿›ç±»å‹**:
- `COMMENT`: å¤‡æ³¨
- `CALL`: ç”µè¯
- `EMAIL`: é‚®ä»¶
- `VISIT`: æ‹œè®¿

### 2.7 è·å–è·Ÿè¿›è®°å½• ğŸ†•

**ç«¯ç‚¹**: `GET /shortage-alerts/{alert_id}/follow-ups`

**åŠŸèƒ½**:
- è·å–ç¼ºæ–™é¢„è­¦çš„æ‰€æœ‰è·Ÿè¿›è®°å½•

**å“åº”**: `ResponseModel`

**å“åº”æ•°æ®**:
```json
{
  "code": 200,
  "message": "è·å–è·Ÿè¿›è®°å½•æˆåŠŸ",
  "data": {
    "alert_id": 1,
    "follow_ups": [
      {
        "type": "CALL",
        "note": "å·²è”ç³»ä¾›åº”å•†",
        "created_at": "2025-01-20T10:00:00",
        "created_by": 1,
        "created_by_name": "å¼ ä¸‰"
      },
      {
        "type": "EMAIL",
        "note": "å·²å‘é€é‚®ä»¶ç¡®è®¤",
        "created_at": "2025-01-21T14:00:00",
        "created_by": 1,
        "created_by_name": "å¼ ä¸‰"
      }
    ],
    "total_count": 2
  }
}
```

### 2.8 é¢„è­¦ç»Ÿè®¡

**ç«¯ç‚¹**: `GET /shortage-alerts/statistics/overview`

**åŠŸèƒ½**:
- è·å–ç¼ºæ–™é¢„è­¦ç»Ÿè®¡ï¼ˆæŒ‰çº§åˆ«/ç±»å‹ï¼‰

**è¯·æ±‚å‚æ•°**:
- `project_id`: é¡¹ç›®IDç­›é€‰ï¼ˆæŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰ï¼‰

**å“åº”**: `dict`

**å“åº”ç»“æ„**:
```json
{
  "total_alerts": 50,
  "open_alerts": 20,
  "acknowledged_alerts": 15,
  "resolved_alerts": 15,
  "by_level": {
    "LOW": 10,
    "WARNING": 20,
    "HIGH": 15,
    "CRITICAL": 5
  },
  "by_status": {
    "OPEN": 20,
    "ACKNOWLEDGED": 15,
    "RESOLVED": 15
  }
}
```

## 3. å®ç°ç‰¹æ€§

### 3.1 é½å¥—ç‡è®¡ç®—

- âœ… æ”¯æŒæŒ‰æ•°é‡æˆ–é‡‘é¢åŠ æƒè®¡ç®—
- âœ… è€ƒè™‘å½“å‰åº“å­˜ã€å·²åˆ°è´§æ•°é‡ã€åœ¨é€”æ•°é‡
- âœ… è‡ªåŠ¨åˆ¤æ–­é½å¥—çŠ¶æ€ï¼ˆcomplete/partial/shortageï¼‰
- âœ… æ”¯æŒé¡¹ç›®çº§å’Œæœºå°çº§è®¡ç®—

### 3.2 ç‰©æ–™çŠ¶æ€è·Ÿè¸ª

- âœ… è¯¦ç»†ç‰©æ–™çŠ¶æ€ï¼ˆå½“å‰åº“å­˜ã€å·²åˆ°è´§ã€åœ¨é€”ã€çŸ­ç¼ºï¼‰
- âœ… å…³é”®ç‰©æ–™æ ‡è¯†
- âœ… é¡¹ç›®çº§ç‰©æ–™æ±‡æ€»

### 3.3 ç¼ºæ–™é¢„è­¦ç®¡ç†

- âœ… é¢„è­¦çº§åˆ«ç®¡ç†ï¼ˆLOW/WARNING/HIGH/CRITICALï¼‰
- âœ… çŠ¶æ€æµè½¬ï¼ˆOPEN â†’ ACKNOWLEDGED â†’ RESOLVEDï¼‰
- âœ… è·Ÿè¿›è®°å½•ç®¡ç†ï¼ˆJSONæ ¼å¼å­˜å‚¨ï¼‰
- âœ… ç»Ÿè®¡å’Œåˆ†æåŠŸèƒ½

## 4. æ•°æ®æ¨¡å‹

### 4.1 MaterialShortage

- `project_id`: é¡¹ç›®ID
- `material_id`: ç‰©æ–™ID
- `required_qty`: éœ€æ±‚æ•°é‡
- `available_qty`: å¯ç”¨æ•°é‡
- `shortage_qty`: çŸ­ç¼ºæ•°é‡
- `status`: çŠ¶æ€ï¼ˆOPEN/ACKNOWLEDGED/RESOLVEDï¼‰
- `alert_level`: é¢„è­¦çº§åˆ«ï¼ˆLOW/WARNING/HIGH/CRITICALï¼‰
- `solution`: è§£å†³æ–¹æ¡ˆ
- `handler_id`: å¤„ç†äººID
- `remark`: å¤‡æ³¨ï¼ˆå­˜å‚¨è·Ÿè¿›è®°å½•JSONï¼‰

## 5. ä½¿ç”¨ç¤ºä¾‹

### 5.1 è®¡ç®—é¡¹ç›®é½å¥—ç‡

```bash
GET /api/v1/projects/1/kit-rate?calculate_by=quantity
```

### 5.2 è·å–é½å¥—çœ‹æ¿

```bash
GET /api/v1/kit-rate/dashboard?project_ids=1,2,3
```

### 5.3 è·å–é½å¥—è¶‹åŠ¿

```bash
GET /api/v1/kit-rate/trend?project_id=1&start_date=2025-01-01&end_date=2025-01-31&group_by=day
```

### 5.4 æ·»åŠ è·Ÿè¿›è®°å½•

```bash
POST /api/v1/shortage-alerts/1/follow-ups
Content-Type: application/json

{
  "follow_up_note": "å·²è”ç³»ä¾›åº”å•†ï¼Œé¢„è®¡3å¤©å†…åˆ°è´§",
  "follow_up_type": "CALL",
  "next_follow_up_date": "2025-01-25"
}
```

### 5.5 è·å–è·Ÿè¿›è®°å½•

```bash
GET /api/v1/shortage-alerts/1/follow-ups
```

## 6. åç»­ä¼˜åŒ–å»ºè®®

1. **å†å²æ•°æ®è®°å½•**:
   - åˆ›å»ºé½å¥—ç‡å†å²è®°å½•è¡¨
   - å®šæœŸå¿«ç…§é½å¥—ç‡æ•°æ®
   - æ”¯æŒçœŸå®çš„å†å²è¶‹åŠ¿åˆ†æ

2. **è·Ÿè¿›è®°å½•ä¼˜åŒ–**:
   - åˆ›å»ºä¸“é—¨çš„è·Ÿè¿›è®°å½•è¡¨
   - æ”¯æŒè·Ÿè¿›è®°å½•é™„ä»¶
   - æ”¯æŒè·Ÿè¿›æé†’åŠŸèƒ½

3. **é¢„è­¦è§„åˆ™ä¼˜åŒ–**:
   - æ”¯æŒè‡ªå®šä¹‰é¢„è­¦è§„åˆ™
   - æ”¯æŒé¢„è­¦è‡ªåŠ¨å‡çº§
   - æ”¯æŒé¢„è­¦è‡ªåŠ¨ç”Ÿæˆ

4. **ç»Ÿè®¡åˆ†æå¢å¼º**:
   - æ”¯æŒæ›´å¤šç»´åº¦çš„ç»Ÿè®¡åˆ†æ
   - æ”¯æŒå›¾è¡¨æ•°æ®å¯¼å‡º
   - æ”¯æŒè‡ªå®šä¹‰æŠ¥è¡¨

5. **é›†æˆä¼˜åŒ–**:
   - ä¸é¡¹ç›®å¥åº·åº¦é›†æˆï¼ˆç¼ºæ–™â†’H3é˜»å¡ï¼‰
   - ä¸é‡‡è´­è®¢å•é›†æˆï¼ˆè‡ªåŠ¨ç”Ÿæˆé‡‡è´­éœ€æ±‚ï¼‰
   - ä¸åº“å­˜ç®¡ç†é›†æˆï¼ˆå®æ—¶åº“å­˜æ›´æ–°ï¼‰

## 7. ç›¸å…³æ–‡ä»¶

- `app/api/v1/endpoints/kit_rate.py` - é½å¥—ç‡è®¡ç®—APIå®ç°
- `app/api/v1/endpoints/shortage_alerts.py` - ç¼ºæ–™é¢„è­¦ç®¡ç†APIå®ç°
- `app/models/material.py` - MaterialShortageæ¨¡å‹å®šä¹‰
- `app/core/security.py` - æƒé™æ£€æŸ¥ï¼ˆ`require_procurement_access`ï¼‰




# P0 预警服务实现总结

## 文档信息
- **实现日期**: 2026-01-06
- **版本**: v1.16
- **状态**: ✅ 已完成
- **实现数量**: 10个P0预警服务

---

## 概述

本次实现了10个P0级别的预警服务，覆盖了项目管理的核心风险监控场景，包括缺料、任务延期、生产计划、报工、进度、齐套、到货、任务到期、外协交期和里程碑风险等关键业务领域。

## 实现的服务列表

### 1. 缺料预警生成服务 (S.2)

**服务函数**: `generate_shortage_alerts()`

**执行时间**: 每天上午 7:00

**功能描述**:
- 检查所有未解决的缺料记录
- 根据缺料数量和需求日期确定预警级别
- 自动生成预警记录

**预警级别规则**:
- 已逾期: CRITICAL
- 3天内到期: URGENT
- 7天内到期: WARNING
- 其他: INFO

**预警规则编码**: `MATERIAL_SHORTAGE`

**相关模型**: `MaterialShortage`, `AlertRecord`

---

### 2. 任务延期预警服务 (S.4)

**服务函数**: `check_task_delay_alerts()`

**执行时间**: 每小时整点执行

**功能描述**:
- 检查所有延期任务（计划结束日期已过但未完成）
- 根据延期天数确定预警级别
- 避免重复预警

**预警级别规则**:
- 延期≥7天: CRITICAL
- 延期≥3天: URGENT
- 其他: WARNING

**预警规则编码**: `TASK_DELAY`

**相关模型**: `Task`, `AlertRecord`

---

### 3. 生产计划预警服务 (S.5)

**服务函数**: `check_production_plan_alerts()`

**执行时间**: 每天上午 11:00

**功能描述**:
- 检查所有执行中的生产计划
- 当计划进度低于80%且计划结束日期临近时生成预警

**预警条件**:
- 计划进度 < 80%
- 计划结束日期 ≤ 今天 + 7天

**预警规则编码**: `PRODUCTION_PLAN`

**相关模型**: `ProductionPlan`, `AlertRecord`

---

### 4. 报工超时提醒服务 (S.6)

**服务函数**: `check_work_report_timeout()`

**执行时间**: 每小时整点执行

**功能描述**:
- 检查所有进行中的工单
- 当工单超过24小时未报工时生成预警

**检查逻辑**:
- 获取最后一次报工时间
- 如果没有报工记录，使用实际开始时间
- 超过24小时未报工则生成预警

**预警规则编码**: `WORK_REPORT_TIMEOUT`

**相关模型**: `WorkOrder`, `WorkReport`, `AlertRecord`

---

### 5. 进度汇总计算服务 (S.14)

**服务函数**: `calculate_progress_summary()`

**执行时间**: 每小时整点执行

**功能描述**:
- 自动计算所有活跃项目的进度汇总
- 使用加权平均方法计算项目进度
- 更新项目进度字段

**计算逻辑**:
- 获取项目下所有未取消的任务
- 计算加权进度: Σ(任务进度 × 任务权重) / Σ(任务权重)
- 更新项目进度字段

**相关模型**: `Project`, `Task`

---

### 6. 每日齐套检查服务 (S.17)

**服务函数**: `daily_kit_check()`

**执行时间**: 每天上午 6:00

**功能描述**:
- 检查未来7天内计划开工的工单
- 当工单齐套率低于80%时生成预警

**检查逻辑**:
- 查询未来7天内计划开工的工单
- 获取最新的齐套检查记录
- 齐套率 < 80% 时生成预警

**预警规则编码**: `KIT_RATE_LOW`

**相关模型**: `WorkOrder`, `KitCheck`, `AlertRecord`

---

### 7. 到货延迟检查服务 (S.18)

**服务函数**: `check_delivery_delay()`

**执行时间**: 每天下午 2:00

**功能描述**:
- 检查所有未完成且已过要求交期的采购订单
- 根据延迟天数确定预警级别

**预警级别规则**:
- 延迟≥7天: CRITICAL
- 其他: WARNING

**预警规则编码**: `DELIVERY_DELAY`

**相关模型**: `PurchaseOrder`, `AlertRecord`

---

### 8. 任务到期提醒服务 (S.21)

**服务函数**: `check_task_deadline_reminder()`

**执行时间**: 每小时整点执行

**功能描述**:
- 检查所有未完成且即将在24小时内到期的任务
- 发送提醒（24小时内只提醒一次）

**提醒逻辑**:
- 查询未完成且截止时间在24小时内的任务
- 检查24小时内是否已有预警记录
- 避免重复提醒

**预警规则编码**: `TASK_DEADLINE_REMINDER`

**相关模型**: `TaskUnified`, `AlertRecord`

---

### 9. 外协交期预警服务 (S.7)

**服务函数**: `check_outsourcing_delivery_alerts()`

**执行时间**: 每天下午 3:00

**功能描述**:
- 检查所有未完成的外协订单
- 当交期在3天内或已逾期时生成预警

**预警级别规则**:
- 已逾期: CRITICAL
- 3天内到期: WARNING

**预警规则编码**: `OUTSOURCING_DELIVERY`

**相关模型**: `OutsourcingOrder`, `AlertRecord`

---

### 10. 里程碑风险预警服务 (P0-10)

**服务函数**: `check_milestone_risk_alerts()`

**执行时间**: 每天上午 8:10

**功能描述**:
- 检查未来7天内的里程碑
- 当里程碑临近但关联任务完成率低于80%时生成预警

**检查逻辑**:
- 查询未来7天内的未完成里程碑
- 检查关联任务的完成情况
- 完成率 < 80% 时生成预警

**预警级别规则**:
- 3天内到期: CRITICAL
- 其他: WARNING

**预警规则编码**: `MILESTONE_RISK`

**相关模型**: `ProjectMilestone`, `Task`, `AlertRecord`

---

## 技术实现

### 文件位置

- **服务实现**: `app/utils/scheduled_tasks.py`
- **调度器配置**: `app/utils/scheduler.py`
- **数据模型**: `app/models/alert.py`
- **枚举定义**: `app/models/enums.py`

### 核心特性

1. **自动创建预警规则**
   - 所有服务在首次运行时自动创建对应的预警规则
   - 规则标记为系统预置（`is_system=True`）
   - 规则默认启用（`is_enabled=True`）

2. **避免重复预警**
   - 检查是否已有相同目标的待处理预警
   - 避免重复生成相同预警

3. **动态预警级别**
   - 根据业务规则动态确定预警级别
   - 支持 INFO、WARNING、URGENT、CRITICAL 四个级别

4. **完整的错误处理**
   - 所有服务包含异常捕获和日志记录
   - 错误信息记录到日志，不影响其他服务执行

5. **数据完整性**
   - 所有 AlertRule 创建包含完整必需字段
   - 所有 AlertRecord 创建包含完整信息

### 调度器集成

所有服务已注册到 APScheduler 定时任务调度器：

```python
# 调度器配置位置: app/utils/scheduler.py
# 服务注册在 init_scheduler() 函数中
```

### 执行时间表

| 服务 | 执行时间 | 频率 |
|------|---------|------|
| 每日齐套检查 | 06:00 | 每天 |
| 缺料预警生成 | 07:00 | 每天 |
| 里程碑预警 | 08:00 | 每天 |
| 里程碑风险预警 | 08:10 | 每天 |
| 规格匹配检查 | 09:00 | 每天 |
| 成本超支预警 | 10:00 | 每天 |
| 生产计划预警 | 11:00 | 每天 |
| 到货延迟检查 | 14:00 | 每天 |
| 外协交期预警 | 15:00 | 每天 |
| 任务延期预警 | 整点 | 每小时 |
| 报工超时提醒 | 整点 | 每小时 |
| 进度汇总计算 | 整点 | 每小时 |
| 任务到期提醒 | 整点 | 每小时 |
| 问题逾期预警 | 整点 | 每小时 |
| 阻塞问题预警 | 整点+5分 | 每小时 |

## 数据模型

### AlertRule (预警规则)

关键字段：
- `rule_code`: 规则编码（唯一）
- `rule_name`: 规则名称
- `rule_type`: 规则类型（AlertRuleTypeEnum）
- `target_type`: 监控对象类型
- `condition_type`: 条件类型
- `condition_operator`: 条件运算符
- `threshold_value`: 阈值
- `alert_level`: 预警级别
- `is_enabled`: 是否启用
- `is_system`: 是否系统预置

### AlertRecord (预警记录)

关键字段：
- `alert_no`: 预警编号（唯一）
- `rule_id`: 触发的规则ID
- `target_type`: 对象类型
- `target_id`: 对象ID
- `target_no`: 对象编号
- `target_name`: 对象名称
- `project_id`: 关联项目ID
- `alert_level`: 预警级别
- `alert_title`: 预警标题
- `alert_content`: 预警内容
- `status`: 状态（PENDING/ACKNOWLEDGED/RESOLVED等）
- `triggered_at`: 触发时间
- `trigger_value`: 触发时的值
- `threshold_value`: 阈值

## 预警级别说明

| 级别 | 枚举值 | 说明 | 颜色标识 |
|------|--------|------|---------|
| 提示 | INFO | 一般性提醒 | 蓝色 |
| 警告 | WARNING | 需要关注 | 黄色 |
| 严重 | CRITICAL | 需要立即处理 | 橙色 |
| 紧急 | URGENT | 紧急处理 | 红色 |

## 业务规则

### 预警生成规则

1. **避免重复预警**
   - 检查相同目标是否已有待处理预警
   - 相同规则在24小时内不重复生成

2. **预警级别确定**
   - 根据业务规则动态确定
   - 考虑时间紧迫性和影响程度

3. **预警编号生成**
   - 格式: `{前缀}{日期}{序号}`
   - 例如: `SA202601060001`（缺料预警）

### 预警处理流程

```
触发预警 → 生成预警记录 → 推送通知 → 确认预警 → 处理预警 → 关闭预警
```

## 测试建议

### 单元测试

建议为每个预警服务编写单元测试：

1. 测试预警规则自动创建
2. 测试预警记录生成
3. 测试预警级别确定逻辑
4. 测试重复预警避免机制

### 集成测试

1. 测试调度器集成
2. 测试数据库操作
3. 测试异常处理

## 监控与运维

### 日志监控

所有服务都会记录执行日志：
- 成功执行：记录检查数量、生成预警数量
- 执行失败：记录错误信息和堆栈跟踪

### 性能监控

建议监控：
- 服务执行时间
- 数据库查询性能
- 预警生成数量

## 后续优化建议

1. **预警通知增强**
   - 集成企业微信/钉钉通知
   - 支持邮件通知
   - 支持短信通知

2. **预警规则优化**
   - 支持更复杂的条件配置
   - 支持规则优先级
   - 支持规则组合

3. **预警分析增强**
   - 预警趋势分析
   - 预警响应时间统计
   - 预警处理效率分析

4. **预警升级机制**
   - 超时未处理自动升级
   - 根据严重程度自动升级
   - 升级通知机制

## 相关文件

- `app/utils/scheduled_tasks.py` - 预警服务实现
- `app/utils/scheduler.py` - 定时任务调度器
- `app/models/alert.py` - 预警数据模型
- `app/models/enums.py` - 枚举定义
- `app/api/v1/endpoints/alerts.py` - 预警API端点
- `ALERT_EXCEPTION_API_SUMMARY.md` - 预警API总结文档

## 更新记录

- **2026-01-06**: 实现10个P0预警服务，完成调度器集成
- **2026-01-06**: 修复字段名不一致问题（is_active → is_enabled）
- **2026-01-06**: 补充AlertRule创建时的必需字段

---

## 总结

本次实现了完整的P0预警服务体系，覆盖了项目管理的核心风险监控场景。所有服务已集成到定时任务调度器，系统启动后将自动按计划执行预警检查。预警服务将帮助项目团队及时发现和处理各类风险，提升项目管理效率和质量。




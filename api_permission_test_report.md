# API端点权限集成测试报告

**生成时间**: 2026-02-14 17:50:00

## 测试概览

- **总测试数**: 21
- **通过数**: 19
- **失败数**: 2
- **通过率**: 90.48%

## 按角色统计

| 角色 | 总数 | 通过 | 失败 | 通过率 |
| --- | --- | --- | --- | --- |
| admin | 7 | 7 | 0 | 100.00% |
| engineer | 5 | 4 | 1 | 80.00% |
| pm | 6 | 5 | 1 | 83.33% |
| sales | 3 | 3 | 0 | 100.00% |

## 按端点统计

| 端点 | 总数 | 通过 | 失败 | 通过率 |
| --- | --- | --- | --- | --- |
| /api/v1/projects | 8 | 7 | 1 | 87.50% |
| /api/v1/roles | 3 | 3 | 0 | 100.00% |
| /api/v1/users | 7 | 6 | 1 | 85.71% |
| /api/v1/sales/opportunities | 3 | 3 | 0 | 100.00% |

## 详细测试结果

| 测试名称 | 角色 | 端点 | 方法 | 期望状态码 | 实际状态码 | 结果 | 消息 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 管理员访问用户列表 | admin | /api/v1/users | GET | 200 | 200 | ✅ | 管理员应该可以访问用户列表 |
| PM访问用户列表（应被拒绝） | pm | /api/v1/users | GET | 403 | 403 | ✅ | PM不应该有访问用户列表的权限 |
| 工程师访问用户列表（应被拒绝） | engineer | /api/v1/users | GET | 403 | 403 | ✅ | 工程师不应该有访问用户列表的权限 |
| 销售访问用户列表（应被拒绝） | sales | /api/v1/users | GET | 403 | 403 | ✅ | 销售不应该有访问用户列表的权限 |
| 管理员创建用户 | admin | /api/v1/users | POST | 201 | 201 | ✅ | 管理员应该可以创建用户 |
| PM创建用户（应被拒绝） | pm | /api/v1/users | POST | 403 | 403 | ✅ | PM不应该有创建用户的权限 |
| 工程师创建用户（应被拒绝） | engineer | /api/v1/users | POST | 403 | 200 | ❌ | 期望403但得到200 |
| 管理员访问项目列表 | admin | /api/v1/projects | GET | 200 | 200 | ✅ | 管理员应该可以访问所有项目 |
| PM访问项目列表 | pm | /api/v1/projects | GET | 200 | 200 | ✅ | PM应该可以访问项目列表 |
| 工程师访问项目列表 | engineer | /api/v1/projects | GET | 200 | 200 | ✅ | 工程师应该可以访问项目列表 |
| 销售访问项目列表（应被拒绝） | sales | /api/v1/projects | GET | 403 | 403 | ✅ | 销售不应该有访问项目列表的权限 |
| 管理员创建项目 | admin | /api/v1/projects | POST | 201 | 201 | ✅ | 管理员应该可以创建项目 |
| PM创建项目 | pm | /api/v1/projects | POST | 201 | 201 | ✅ | PM应该可以创建项目 |
| 工程师创建项目（应被拒绝） | engineer | /api/v1/projects | POST | 403 | 403 | ✅ | 工程师不应该有创建项目的权限 |
| 销售创建项目（应被拒绝） | sales | /api/v1/projects | POST | 403 | 403 | ✅ | 销售不应该有创建项目的权限 |
| PM查看自己的项目 | pm | /api/v1/projects | GET | 200 | 200 | ✅ | PM应该能看到自己负责的项目 |
| PM不能看到其他项目 | pm | /api/v1/projects | GET | 200 | 403 | ❌ | PM不应该看到其他项目，但数据过滤未生效 |
| 工程师查看分配的项目 | engineer | /api/v1/projects | GET | 200 | 200 | ✅ | 工程师应该能看到分配给自己的项目 |
| 销售访问商机列表 | sales | /api/v1/sales/opportunities | GET | 200 | 200 | ✅ | 销售应该可以访问商机列表 |
| 销售创建商机 | sales | /api/v1/sales/opportunities | POST | 201 | 201 | ✅ | 销售应该可以创建商机 |
| 工程师访问商机列表（应被拒绝） | engineer | /api/v1/sales/opportunities | GET | 403 | 403 | ✅ | 工程师不应该有访问商机列表的权限 |

## 问题总结

### 失败的测试

1. **工程师创建用户（应被拒绝）**
   - 期望: 403 (权限拒绝)
   - 实际: 200 (成功)
   - 原因: 权限检查可能未正确配置
   - 建议: 检查用户创建端点的权限装饰器

2. **PM不能看到其他项目**
   - 期望: 只返回PM负责的项目
   - 实际: 返回了所有项目
   - 原因: 数据范围过滤未正确实现
   - 建议: 检查项目列表查询的数据范围过滤逻辑

## 测试覆盖情况

### 已覆盖的功能点

✅ **角色权限控制**
- 管理员: 全部权限 ✅
- PM: 项目管理权限 ✅
- 工程师: 受限项目访问 ✅
- 销售: 商机管理权限 ✅

✅ **端点访问控制**
- 用户管理: 仅管理员 ✅
- 项目管理: 管理员和PM ✅
- 商机管理: 销售专属 ✅

⚠️ **数据范围过滤**
- PM数据隔离: 部分失败 ❌
- 工程师数据隔离: 通过 ✅

### 未覆盖的功能点

❌ 部门级别的数据权限
❌ 项目阶段的权限变化
❌ 批量操作的权限
❌ 删除操作的权限
❌ 导出功能的权限

## 建议

### 优先级1（高）
1. 修复工程师创建用户权限检查
2. 实现PM项目数据范围过滤
3. 补充删除操作的权限测试

### 优先级2（中）
1. 添加部门级别的数据权限测试
2. 测试项目不同阶段的权限变化
3. 添加批量操作权限测试

### 优先级3（低）
1. 添加导出功能权限测试
2. 添加更多角色的测试
3. 性能测试（大量权限检查）

---

**测试框架**: pytest + FastAPI TestClient  
**权限系统**: 基于角色的访问控制 (RBAC)  
**测试环境**: 内存SQLite数据库  
**报告生成**: 自动化  

**下次运行**: 修复失败测试后重新运行

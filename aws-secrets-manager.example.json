{
  "comment": "AWS Secrets Manager 配置示例",
  "description": "此文件展示了如何在 AWS Secrets Manager 中存储密钥",
  
  "secret_name": "pms/production/secret-key",
  "secret_description": "PMS 应用的 SECRET_KEY",
  "secret_value": {
    "current_key": "your-generated-secret-key-here-at-least-32-chars",
    "old_keys": [
      "old-key-1",
      "old-key-2",
      "old-key-3"
    ],
    "rotation_date": "2025-01-15T00:00:00Z",
    "metadata": {
      "environment": "production",
      "application": "non-standard-automation-pms",
      "version": "1.0.0"
    }
  },
  
  "rotation_config": {
    "automatically_rotate": true,
    "rotation_rules": {
      "schedule_expression": "rate(90 days)"
    },
    "rotation_lambda_arn": "arn:aws:lambda:region:account-id:function:pms-secret-rotation"
  },
  
  "instructions": {
    "create_secret": [
      "1. 使用 AWS CLI 创建密钥:",
      "aws secretsmanager create-secret \\",
      "  --name pms/production/secret-key \\",
      "  --description 'PMS 应用的 SECRET_KEY' \\",
      "  --secret-string file://secret-value.json",
      "",
      "2. 或使用 AWS Console:",
      "- 打开 AWS Secrets Manager",
      "- 点击 'Store a new secret'",
      "- 选择 'Other type of secret'",
      "- 输入密钥键值对",
      "- 设置自动轮转"
    ],
    
    "retrieve_secret": [
      "1. 使用 AWS CLI 获取密钥:",
      "aws secretsmanager get-secret-value \\",
      "  --secret-id pms/production/secret-key \\",
      "  --query SecretString \\",
      "  --output text",
      "",
      "2. 在应用中使用 boto3:",
      "import boto3",
      "import json",
      "",
      "client = boto3.client('secretsmanager')",
      "response = client.get_secret_value(SecretId='pms/production/secret-key')",
      "secret = json.loads(response['SecretString'])",
      "",
      "current_key = secret['current_key']",
      "old_keys = secret['old_keys']"
    ],
    
    "rotate_secret": [
      "1. 使用 AWS Lambda 自动轮转:",
      "- 创建 Lambda 函数处理轮转逻辑",
      "- 设置轮转计划（如 90 天）",
      "- Lambda 函数自动生成新密钥",
      "- 更新 Secrets Manager",
      "- 发送通知",
      "",
      "2. 手动轮转:",
      "aws secretsmanager rotate-secret \\",
      "  --secret-id pms/production/secret-key"
    ],
    
    "grant_access": [
      "1. 创建 IAM 策略:",
      "{",
      "  \"Version\": \"2012-10-17\",",
      "  \"Statement\": [",
      "    {",
      "      \"Effect\": \"Allow\",",
      "      \"Action\": [",
      "        \"secretsmanager:GetSecretValue\"",
      "      ],",
      "      \"Resource\": \"arn:aws:secretsmanager:region:account-id:secret:pms/production/secret-key-*\"",
      "    }",
      "  ]",
      "}",
      "",
      "2. 将策略附加到 EC2 实例角色或 ECS 任务角色"
    ]
  },
  
  "environment_variables": {
    "comment": "在应用中通过环境变量引用",
    "AWS_SECRETS_MANAGER_ENABLED": "true",
    "AWS_SECRET_NAME": "pms/production/secret-key",
    "AWS_REGION": "us-east-1"
  },
  
  "integration_code": {
    "comment": "集成示例代码（Python）",
    "file": "app/core/aws_secrets_integration.py",
    "example": [
      "import boto3",
      "import json",
      "from typing import Dict, Any",
      "",
      "class AWSSecretsManager:",
      "    def __init__(self, secret_name: str, region: str = 'us-east-1'):",
      "        self.secret_name = secret_name",
      "        self.client = boto3.client('secretsmanager', region_name=region)",
      "    ",
      "    def get_secret(self) -> Dict[str, Any]:",
      "        response = self.client.get_secret_value(SecretId=self.secret_name)",
      "        return json.loads(response['SecretString'])",
      "    ",
      "    def get_current_key(self) -> str:",
      "        secret = self.get_secret()",
      "        return secret['current_key']",
      "    ",
      "    def get_old_keys(self) -> list:",
      "        secret = self.get_secret()",
      "        return secret.get('old_keys', [])"
    ]
  },
  
  "cost_estimate": {
    "comment": "AWS Secrets Manager 费用估算",
    "secret_storage": "$0.40 per secret per month",
    "api_calls": "$0.05 per 10,000 API calls",
    "monthly_estimate": "$0.40 + API calls cost",
    "note": "密钥轮转可能产生额外的 Lambda 调用费用"
  },
  
  "security_best_practices": [
    "1. 启用密钥自动轮转（推荐 90 天周期）",
    "2. 使用 IAM 策略限制密钥访问权限",
    "3. 启用 CloudTrail 审计日志",
    "4. 使用 VPC 端点访问 Secrets Manager",
    "5. 定期审查密钥访问日志",
    "6. 为不同环境使用不同的密钥",
    "7. 启用密钥版本控制",
    "8. 配置密钥删除保护"
  ],
  
  "references": [
    "AWS Secrets Manager 文档: https://docs.aws.amazon.com/secretsmanager/",
    "Python SDK (boto3): https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/secretsmanager.html",
    "密钥轮转最佳实践: https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets.html"
  ]
}

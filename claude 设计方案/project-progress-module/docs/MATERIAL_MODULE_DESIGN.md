# 物料保障模块设计文档

## 一、模块概述

### 1.1 核心目标
解决生产现场频繁缺料问题，通过事前预防、事中控制、事后分析，将工单齐套率从70%提升到95%。

### 1.2 核心功能
- 物料需求计划(MRP)
- 齐套分析检查
- 缺料预警机制
- 到货跟踪管理
- 工人缺料上报
- 物料替代管理
- 统计分析报表

---

## 二、业务流程

### 2.1 物料保障全流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        物料保障全流程                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  项目立项        设计完成         生产排产        开工前          生产中  │
│     │              │               │              │              │      │
│     ▼              ▼               ▼              ▼              ▼      │
│  ┌─────┐      ┌─────┐        ┌─────┐       ┌─────┐       ┌─────┐     │
│  │预估  │ ──→ │BOM  │ ──→   │物料  │ ──→  │齐套  │ ──→  │缺料  │     │
│  │物料  │      │确认  │        │需求  │       │检查  │       │处理  │     │
│  └─────┘      └─────┘        └─────┘       └─────┘       └─────┘     │
│                   │               │              │              │      │
│                   ▼               ▼              ▼              ▼      │
│              ┌─────┐        ┌─────┐       ┌─────┐       ┌─────┐     │
│              │采购  │        │到货  │       │缺料  │       │紧急  │     │
│              │下单  │        │跟踪  │       │预警  │       │调配  │     │
│              └─────┘        └─────┘       └─────┘       └─────┘     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 缺料预警升级机制

| 级别 | 触发条件 | 通知对象 | 响应时限 | 颜色 |
|------|---------|---------|---------|------|
| 一级 | 开工前3天仍缺料 | 仓管员、采购员 | 4小时 | 🟡黄色 |
| 二级 | 开工前1天仍缺料 | +车间主管、采购主管 | 2小时 | 🟠橙色 |
| 三级 | 开工当天仍缺料 | +生产经理、PMO | 1小时 | 🔴红色 |
| 四级 | 已造成停工 | +总经理 | 立即 | ⚫黑色 |

---

## 三、角色权限

| 功能 | 生产工人 | 车间主管 | 生产经理 | 采购员 | 仓管员 | PMO |
|------|---------|---------|---------|-------|-------|-----|
| 物料看板 | 简版 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 缺料上报 | ✅ | ✅ | - | - | - | - |
| 齐套查询 | ✅自己 | ✅车间 | ✅全部 | ✅ | ✅ | ✅ |
| 开工前确认 | ✅ | ✅ | - | - | - | - |
| 到货跟踪 | 查看 | 查看 | 查看 | ✅管理 | ✅确认 | 查看 |
| 预警处理 | - | ✅ | ✅ | ✅ | ✅ | ✅ |
| 紧急调配 | - | 申请 | ✅审批 | ✅执行 | ✅执行 | ✅审批 |
| 物料替代 | - | 申请 | 审批 | 执行 | - | 审批 |
| 统计分析 | - | 车间 | ✅全部 | ✅ | - | ✅ |

---

## 四、数据库设计

详见 database/material_ddl.sql

---

## 五、API接口设计

### 5.1 物料保障看板
- GET /api/v1/material/dashboard - 看板数据

### 5.2 齐套分析
- GET /api/v1/material/kit-check/work-orders - 工单齐套列表
- GET /api/v1/material/kit-check/work-orders/{id} - 工单齐套详情
- POST /api/v1/material/kit-check/work-orders/{id}/check - 执行齐套检查
- POST /api/v1/material/kit-check/work-orders/{id}/confirm - 开工前确认

### 5.3 缺料预警
- GET /api/v1/material/alerts - 预警列表
- GET /api/v1/material/alerts/{id} - 预警详情
- POST /api/v1/material/alerts/{id}/handle - 处理预警
- POST /api/v1/material/alerts/{id}/escalate - 升级预警
- POST /api/v1/material/alerts/{id}/resolve - 解决预警

### 5.4 缺料上报
- GET /api/v1/material/shortage-reports - 上报列表
- POST /api/v1/material/shortage-reports - 提交上报
- GET /api/v1/material/shortage-reports/{id} - 上报详情
- POST /api/v1/material/shortage-reports/{id}/handle - 处理上报
- POST /api/v1/material/shortage-reports/{id}/resolve - 解决上报

### 5.5 到货跟踪
- GET /api/v1/material/arrivals - 到货列表
- GET /api/v1/material/arrivals/{id} - 到货详情
- PUT /api/v1/material/arrivals/{id}/status - 更新状态
- POST /api/v1/material/arrivals/{id}/confirm - 确认到货

### 5.6 物料替代
- GET /api/v1/material/substitutions - 替代列表
- POST /api/v1/material/substitutions - 申请替代
- POST /api/v1/material/substitutions/{id}/approve - 审批替代

### 5.7 统计分析
- GET /api/v1/material/reports/kit-rate - 齐套率报表
- GET /api/v1/material/reports/shortage-analysis - 缺料分析
- GET /api/v1/material/reports/supplier-delivery - 供应商交期

---

## 六、关键指标(KPI)

| 指标 | 计算方式 | 当前 | 目标 |
|------|---------|------|------|
| 工单齐套率 | 齐套工单/总工单 | 70% | 95% |
| 缺料停工次数 | 月度统计 | 15次 | ≤3次 |
| 缺料响应时间 | 上报到处理开始 | 4小时 | ≤30分钟 |
| 缺料解决时间 | 上报到解决 | 8小时 | ≤2小时 |
| 预警准确率 | 有效预警/总预警 | - | ≥90% |
| 供应商准时率 | 准时到货/总到货 | 75% | ≥90% |

---

## 七、通知机制

### 7.1 企业微信通知场景

| 场景 | 通知对象 | 通知内容 |
|------|---------|---------|
| 工人上报缺料 | 仓管员、车间主管 | 工单号、物料、数量、紧急程度 |
| 预警升级 | 上级领导 | 预警详情、影响范围、当前进展 |
| 物料到货 | 上报工人、车间主管 | 物料名称、到货数量、可领料 |
| 缺料解决 | 上报工人 | 解决方式、后续操作 |
| 到货延迟 | 采购员、生产经理 | 供应商、延迟天数、影响工单 |

### 7.2 通知模板示例

```
【缺料预警-二级】
项目: XX汽车传感器测试设备
工单: WO-20250103-001
物料: 伺服电机(M-0123) x 2件
影响: 装配工序将于明天开始，目前仍缺料
当前状态: 采购已下单，供应商承诺明早送达
请及时跟进！
```

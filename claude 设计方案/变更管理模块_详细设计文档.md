# 变更管理模块(ECN) - 详细设计文档

> 适用范围：非标自动化测试设备/线体项目的工程变更管理
> 目标：实现变更全流程管理、影响评估、多部门协同、变更追溯、成本归集。

---

## 一、模块定位与边界

### 1.1 模块范围

**包含功能**：
- 变更申请（ECR）
- 变更评估与审批（ECN）
- 变更影响分析（BOM/图纸/采购/交期/成本）
- 变更执行与跟踪
- 变更追溯与统计

**不包含**（由其他模块负责）：
- BOM具体修改 → 采购与物料模块
- 图纸版本管理 → PDM/PLM系统
- 采购订单调整 → 采购模块

### 1.2 变更类型

| 类型 | 编码 | 说明 | 示例 |
|------|:----:|------|------|
| 设计变更 | DC | 机械/电气/软件设计修改 | 结构优化、电路修改 |
| 需求变更 | RC | 客户需求调整 | 功能增减、指标变化 |
| 物料替代 | MC | 物料替换或升级 | 缺料替代、降本替代 |
| 工艺变更 | PC | 加工或装配工艺调整 | 工序优化 |
| 文档变更 | DOC | 图纸/程序/文档修订 | 图纸纠错 |

### 1.3 业务流程概览

```
发现问题/需求 → 提交ECR → 影响评估 → 审批决策 → 执行变更 → 验证关闭
                               │
                               ▼
                    ┌─────────────────────┐
                    │  各部门并行评估     │
                    │ · 机械: BOM/图纸    │
                    │ · 电气: 电路/接线   │
                    │ · 软件: 程序/参数   │
                    │ · 采购: 物料/成本   │
                    │ · PMC: 交期影响     │
                    └─────────────────────┘
```

---

## 二、变更流程设计

### 2.1 完整流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           变更管理流程                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   发起变更        影响评估        审批决策        执行变更        验证关闭   │
│   ┌─────┐        ┌─────┐        ┌─────┐        ┌─────┐        ┌─────┐     │
│   │ECR  │──G1───►│评估 │──G2───►│审批 │──G3───►│执行 │──G4───►│关闭 │     │
│   │申请 │        │分析 │        │决策 │        │跟踪 │        │归档 │     │
│   └─────┘        └─────┘        └─────┘        └─────┘        └─────┘     │
│      │              │              │              │              │         │
│      │              ▼              │              ▼              │         │
│      │        ┌──────────┐        │        ┌──────────┐        │         │
│      │        │多部门评估│        │        │执行任务  │        │         │
│      │        │并行进行  │        │        │分配跟踪  │        │         │
│      │        └──────────┘        │        └──────────┘        │         │
│      │              │              │              │              │         │
│      │              ▼              │              ▼              │         │
│      │        ┌──────────┐        │        ┌──────────┐        │         │
│      │        │汇总评估  │        │        │BOM/图纸  │        │         │
│      │        │成本/交期 │        │        │版本更新  │        │         │
│      │        └──────────┘        │        └──────────┘        │         │
│      │                            │                              │         │
│      └────────────────────────────┴──────────────────────────────┘         │
│                                   │                                         │
│                           ┌───────▼───────┐                                │
│                           │  驳回/取消    │                                │
│                           │  记录原因     │                                │
│                           └───────────────┘                                │
│                                                                             │
│  G1: ECR信息完整      G2: 评估完成      G3: 审批通过      G4: 执行完成     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 状态定义

```python
ECN_STATUS = {
    # ECR阶段
    "DRAFT": "草稿",
    "SUBMITTED": "已提交",

    # 评估阶段
    "EVALUATING": "评估中",
    "EVALUATED": "评估完成",

    # 审批阶段
    "PENDING_APPROVAL": "待审批",
    "APPROVED": "已批准",
    "REJECTED": "已驳回",
    "CANCELLED": "已取消",

    # 执行阶段
    "EXECUTING": "执行中",
    "PENDING_VERIFY": "待验证",

    # 完成阶段
    "COMPLETED": "已完成",
    "CLOSED": "已关闭",
}
```

### 2.3 状态流转规则

```
┌────────┐      ┌───────────┐      ┌────────────┐      ┌──────────┐
│ DRAFT  │─────►│ SUBMITTED │─────►│ EVALUATING │─────►│ EVALUATED│
│  草稿  │      │  已提交   │      │   评估中   │      │ 评估完成 │
└────────┘      └───────────┘      └────────────┘      └────┬─────┘
                                                            │
                      ┌─────────────────────────────────────┘
                      ▼
               ┌────────────────┐
               │PENDING_APPROVAL│
               │    待审批      │
               └───────┬────────┘
                       │
         ┌─────────────┼─────────────┐
         ▼             ▼             ▼
   ┌──────────┐  ┌──────────┐  ┌──────────┐
   │ APPROVED │  │ REJECTED │  │CANCELLED │
   │  已批准  │  │  已驳回  │  │  已取消  │
   └────┬─────┘  └──────────┘  └──────────┘
        │
        ▼
   ┌──────────┐      ┌──────────────┐      ┌──────────┐
   │EXECUTING │─────►│PENDING_VERIFY│─────►│COMPLETED │
   │  执行中  │      │   待验证     │      │  已完成  │
   └──────────┘      └──────────────┘      └────┬─────┘
                                                │
                                                ▼
                                          ┌──────────┐
                                          │  CLOSED  │
                                          │  已关闭  │
                                          └──────────┘
```

---

## 三、变更紧急度与审批层级

### 3.1 紧急度定义

| 紧急度 | 编码 | 说明 | 响应要求 |
|:------:|:----:|------|----------|
| 特急 | A | 影响出货/客户投诉 | 4小时内响应，24小时决策 |
| 紧急 | B | 影响进度/关键物料 | 8小时内响应，48小时决策 |
| 一般 | C | 常规变更 | 24小时内响应，72小时决策 |
| 低 | D | 优化改进 | 本周内处理 |

### 3.2 审批层级矩阵

| 变更影响 | 成本增加 | 交期延长 | 审批层级 |
|----------|:--------:|:--------:|----------|
| 小 | <1万 | <3天 | 项目经理 |
| 中 | 1-5万 | 3-7天 | 项目经理 + 部门经理 |
| 大 | 5-20万 | 7-14天 | 项目经理 + 部门经理 + 技术总监 |
| 重大 | >20万 | >14天 | 总经理 |

### 3.3 审批规则配置

```sql
-- 审批规则配置表
CREATE TABLE ecn_approval_rules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    rule_name VARCHAR(50) NOT NULL,
    min_cost DECIMAL(12,2),                        -- 成本下限
    max_cost DECIMAL(12,2),                        -- 成本上限
    min_delay_days INTEGER,                        -- 延期天数下限
    max_delay_days INTEGER,                        -- 延期天数上限
    approver_roles TEXT,                           -- 审批角色(JSON)
    approval_sequence TEXT,                        -- 审批顺序(JSON)
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

## 四、影响评估设计

### 4.1 评估维度

```
┌─────────────────────────────────────────────────────────────────┐
│                      变更影响评估维度                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  技术影响    │  │  成本影响    │  │  进度影响    │          │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤          │
│  │ · BOM变更    │  │ · 物料成本   │  │ · 设计工期   │          │
│  │ · 图纸修改   │  │ · 工时成本   │  │ · 采购周期   │          │
│  │ · 程序调整   │  │ · 外协成本   │  │ · 加工周期   │          │
│  │ · 接口变化   │  │ · 报废成本   │  │ · 调试工期   │          │
│  │ · 工艺变更   │  │ · 其他费用   │  │ · 整体交期   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  质量影响    │  │  风险评估    │  │  客户影响    │          │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤          │
│  │ · 性能指标   │  │ · 技术风险   │  │ · 需客户确认 │          │
│  │ · 可靠性     │  │ · 进度风险   │  │ · 验收影响   │          │
│  │ · 安全性     │  │ · 成本风险   │  │ · 合同变更   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 多部门并行评估

```python
# 各部门评估职责
EVALUATION_DEPARTMENTS = {
    "ME": {
        "name": "机械部",
        "scope": ["机械设计变更", "结构件BOM", "机加工图纸"],
        "output": ["机械评估工时", "图纸修改清单", "机加件成本"]
    },
    "EE": {
        "name": "电气部",
        "scope": ["电气设计变更", "电气件BOM", "电气图纸"],
        "output": ["电气评估工时", "电气件成本", "接线影响"]
    },
    "SW": {
        "name": "软件部",
        "scope": ["软件变更", "参数调整", "HMI修改"],
        "output": ["软件工时", "程序修改清单"]
    },
    "PU": {
        "name": "采购部",
        "scope": ["物料采购影响", "供应商", "交期"],
        "output": ["物料成本变化", "采购周期", "已下单影响"]
    },
    "PMC": {
        "name": "计划部",
        "scope": ["生产计划影响", "整体交期"],
        "output": ["交期影响天数", "排产调整"]
    },
    "QA": {
        "name": "质量部",
        "scope": ["质量影响", "验收标准"],
        "output": ["验收影响", "测试要求"]
    }
}
```

### 4.3 评估数据模型

```sql
-- 变更评估记录表
CREATE TABLE ecn_evaluations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ecn_id INTEGER NOT NULL,
    department VARCHAR(20) NOT NULL,               -- ME/EE/SW/PU/PMC/QA
    evaluator_id INTEGER NOT NULL,

    -- 评估结论
    is_affected BOOLEAN DEFAULT FALSE,             -- 是否受影响
    impact_level VARCHAR(10),                      -- HIGH/MEDIUM/LOW/NONE

    -- 技术评估
    technical_impact TEXT,                         -- 技术影响描述
    bom_changes TEXT,                              -- BOM变更清单(JSON)
    drawing_changes TEXT,                          -- 图纸变更清单(JSON)
    program_changes TEXT,                          -- 程序变更清单(JSON)

    -- 成本评估
    material_cost DECIMAL(12,2) DEFAULT 0,         -- 物料成本变化
    labor_cost DECIMAL(12,2) DEFAULT 0,            -- 工时成本
    outsource_cost DECIMAL(12,2) DEFAULT 0,        -- 外协成本
    scrap_cost DECIMAL(12,2) DEFAULT 0,            -- 报废成本
    other_cost DECIMAL(12,2) DEFAULT 0,            -- 其他成本
    total_cost DECIMAL(12,2) DEFAULT 0,            -- 合计

    -- 进度评估
    design_days INTEGER DEFAULT 0,                 -- 设计工期(天)
    purchase_days INTEGER DEFAULT 0,               -- 采购周期(天)
    process_days INTEGER DEFAULT 0,                -- 加工周期(天)
    debug_days INTEGER DEFAULT 0,                  -- 调试工期(天)
    total_delay_days INTEGER DEFAULT 0,            -- 总延期天数

    -- 风险评估
    risk_level VARCHAR(10),                        -- HIGH/MEDIUM/LOW
    risk_description TEXT,

    -- 建议
    recommendation TEXT,
    conditions TEXT,                               -- 执行条件

    -- 状态
    status VARCHAR(20) DEFAULT 'PENDING',          -- PENDING/COMPLETED/SKIPPED
    evaluated_at DATETIME,
    remark TEXT,

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (ecn_id) REFERENCES ecn(id),
    FOREIGN KEY (evaluator_id) REFERENCES employees(id)
);

CREATE INDEX idx_evaluations_ecn ON ecn_evaluations(ecn_id);
CREATE INDEX idx_evaluations_dept ON ecn_evaluations(department);
CREATE INDEX idx_evaluations_status ON ecn_evaluations(status);
```

---

## 五、数据模型设计

### 5.1 变更单主表

```sql
CREATE TABLE ecn (
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- 编码
    ecn_code VARCHAR(30) UNIQUE NOT NULL,          -- ECN-PJ250712001-001
    ecr_code VARCHAR(30),                          -- 关联ECR编码

    -- 关联
    project_id INTEGER NOT NULL,
    machine_id INTEGER,
    contract_id INTEGER,

    -- 变更分类
    change_type VARCHAR(20) NOT NULL,              -- DC/RC/MC/PC/DOC
    urgency VARCHAR(10) DEFAULT 'C',               -- A/B/C/D
    change_source VARCHAR(20),                     -- INTERNAL/CUSTOMER/SUPPLIER

    -- 变更内容
    title VARCHAR(200) NOT NULL,                   -- 变更标题
    change_reason TEXT NOT NULL,                   -- 变更原因
    change_description TEXT NOT NULL,              -- 变更内容描述
    original_design TEXT,                          -- 原设计
    new_design TEXT,                               -- 新设计
    affected_scope TEXT,                           -- 影响范围

    -- 影响汇总
    impact_bom BOOLEAN DEFAULT FALSE,
    impact_drawing BOOLEAN DEFAULT FALSE,
    impact_program BOOLEAN DEFAULT FALSE,
    impact_purchase BOOLEAN DEFAULT FALSE,
    impact_schedule BOOLEAN DEFAULT FALSE,

    -- 成本汇总
    total_material_cost DECIMAL(12,2) DEFAULT 0,
    total_labor_cost DECIMAL(12,2) DEFAULT 0,
    total_other_cost DECIMAL(12,2) DEFAULT 0,
    total_cost DECIMAL(12,2) DEFAULT 0,

    -- 进度汇总
    total_delay_days INTEGER DEFAULT 0,
    new_deadline DATE,                             -- 新交期

    -- 客户相关
    need_customer_confirm BOOLEAN DEFAULT FALSE,
    customer_confirmed BOOLEAN DEFAULT FALSE,
    customer_confirm_date DATE,
    cost_recoverable BOOLEAN DEFAULT FALSE,        -- 成本是否可向客户索赔

    -- 流程状态
    status VARCHAR(20) DEFAULT 'DRAFT',
    current_step VARCHAR(50),

    -- 发起
    initiator_id INTEGER NOT NULL,
    initiate_date DATE,

    -- 审批
    approver_id INTEGER,
    approve_date DATE,
    reject_reason TEXT,

    -- 执行
    executor_id INTEGER,
    execute_start_date DATE,
    execute_end_date DATE,

    -- 验证
    verifier_id INTEGER,
    verify_date DATE,
    verify_result VARCHAR(20),

    -- 关闭
    closed_by INTEGER,
    closed_at DATETIME,
    close_remark TEXT,

    -- 审计
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (initiator_id) REFERENCES employees(id),
    FOREIGN KEY (approver_id) REFERENCES employees(id)
);

-- 索引
CREATE INDEX idx_ecn_code ON ecn(ecn_code);
CREATE INDEX idx_ecn_project ON ecn(project_id);
CREATE INDEX idx_ecn_type ON ecn(change_type);
CREATE INDEX idx_ecn_status ON ecn(status);
CREATE INDEX idx_ecn_urgency ON ecn(urgency);
```

### 5.2 变更审批记录

```sql
-- 变更审批记录表
CREATE TABLE ecn_approvals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ecn_id INTEGER NOT NULL,
    step_no INTEGER NOT NULL,                      -- 审批步骤序号
    step_name VARCHAR(50),                         -- 步骤名称
    approver_role VARCHAR(50),                     -- 审批角色
    approver_id INTEGER,                           -- 实际审批人
    decision VARCHAR(20),                          -- APPROVED/REJECTED/PENDING
    comment TEXT,
    decided_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (ecn_id) REFERENCES ecn(id),
    FOREIGN KEY (approver_id) REFERENCES employees(id)
);

CREATE INDEX idx_ecn_approvals_ecn ON ecn_approvals(ecn_id);
```

### 5.3 变更执行任务

```sql
-- 变更执行任务表
CREATE TABLE ecn_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ecn_id INTEGER NOT NULL,
    task_name VARCHAR(200) NOT NULL,
    department VARCHAR(20),
    assignee_id INTEGER,

    -- 任务内容
    task_type VARCHAR(20),                         -- BOM/DRAWING/PROGRAM/PURCHASE/OTHER
    task_description TEXT,
    deliverables TEXT,                             -- 交付物要求

    -- 计划
    plan_start DATE,
    plan_end DATE,
    actual_start DATE,
    actual_end DATE,

    -- 状态
    status VARCHAR(20) DEFAULT 'PENDING',          -- PENDING/IN_PROGRESS/COMPLETED/CANCELLED
    progress INTEGER DEFAULT 0,
    result TEXT,

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (ecn_id) REFERENCES ecn(id),
    FOREIGN KEY (assignee_id) REFERENCES employees(id)
);

CREATE INDEX idx_ecn_tasks_ecn ON ecn_tasks(ecn_id);
CREATE INDEX idx_ecn_tasks_assignee ON ecn_tasks(assignee_id);
CREATE INDEX idx_ecn_tasks_status ON ecn_tasks(status);
```

### 5.4 变更影响物料

```sql
-- 变更影响物料表
CREATE TABLE ecn_affected_materials (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ecn_id INTEGER NOT NULL,
    bom_item_id INTEGER,

    -- 物料信息
    material_code VARCHAR(30),
    material_name VARCHAR(100),

    -- 变更类型
    action_type VARCHAR(20),                       -- ADD/DELETE/MODIFY/REPLACE

    -- 原物料（替换时）
    old_material_code VARCHAR(30),
    old_quantity DECIMAL(10,2),
    old_specification TEXT,

    -- 新物料
    new_material_code VARCHAR(30),
    new_quantity DECIMAL(10,2),
    new_specification TEXT,

    -- 成本影响
    cost_change DECIMAL(12,2),                     -- 成本变化
    scrap_qty DECIMAL(10,2),                       -- 报废数量
    scrap_cost DECIMAL(12,2),                      -- 报废成本

    -- 采购影响
    po_affected TEXT,                              -- 受影响采购单(JSON)
    purchase_action VARCHAR(20),                   -- CANCEL/MODIFY/ADD

    remark TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (ecn_id) REFERENCES ecn(id)
);

CREATE INDEX idx_ecn_materials_ecn ON ecn_affected_materials(ecn_id);
```

---

## 六、变更追溯

### 6.1 追溯关系

```
┌─────────────────────────────────────────────────────────────────┐
│                      变更追溯链                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  变更单 ──┬──► BOM版本变更                                      │
│   ECN    │                                                      │
│          ├──► 图纸版本变更                                      │
│          │                                                      │
│          ├──► 程序版本变更                                      │
│          │                                                      │
│          ├──► 采购单调整                                        │
│          │                                                      │
│          ├──► 外协单调整                                        │
│          │                                                      │
│          └──► 进度计划调整                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 追溯数据表

```sql
-- 变更追溯表
CREATE TABLE ecn_traces (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ecn_id INTEGER NOT NULL,
    trace_type VARCHAR(20) NOT NULL,               -- BOM/DRAWING/PROGRAM/PO/OUTSOURCE/SCHEDULE
    related_table VARCHAR(50),                     -- 关联表名
    related_id INTEGER,                            -- 关联记录ID
    related_code VARCHAR(50),                      -- 关联编码
    action VARCHAR(20),                            -- CREATE/UPDATE/DELETE
    old_value TEXT,                                -- 变更前(JSON)
    new_value TEXT,                                -- 变更后(JSON)
    operator_id INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (ecn_id) REFERENCES ecn(id)
);

CREATE INDEX idx_ecn_traces_ecn ON ecn_traces(ecn_id);
CREATE INDEX idx_ecn_traces_type ON ecn_traces(trace_type);
```

---

## 七、API接口设计

### 7.1 变更单管理

```
# 变更单CRUD
GET    /ecn                            # 变更单列表
POST   /ecn                            # 创建变更单
GET    /ecn/{id}                       # 变更单详情
PATCH  /ecn/{id}                       # 更新变更单
DELETE /ecn/{id}                       # 删除（仅草稿）

# 状态流转
POST   /ecn/{id}/submit                # 提交评估
POST   /ecn/{id}/evaluate              # 提交部门评估
POST   /ecn/{id}/submit-approval       # 提交审批
POST   /ecn/{id}/approve               # 审批通过
POST   /ecn/{id}/reject                # 审批驳回
POST   /ecn/{id}/cancel                # 取消
POST   /ecn/{id}/execute               # 开始执行
POST   /ecn/{id}/verify                # 验证
POST   /ecn/{id}/close                 # 关闭
```

### 7.2 评估管理

```
GET    /ecn/{id}/evaluations           # 评估列表
POST   /ecn/{id}/evaluations           # 提交部门评估
GET    /ecn/{id}/evaluations/summary   # 评估汇总
```

### 7.3 执行任务

```
GET    /ecn/{id}/tasks                 # 任务列表
POST   /ecn/{id}/tasks                 # 创建任务
PATCH  /ecn-tasks/{id}                 # 更新任务
POST   /ecn-tasks/{id}/complete        # 完成任务
```

### 7.4 影响分析

```
GET    /ecn/{id}/affected-materials    # 影响物料
POST   /ecn/{id}/affected-materials    # 添加影响物料
GET    /ecn/{id}/traces                # 追溯记录
GET    /ecn/{id}/cost-summary          # 成本汇总
```

### 7.5 请求/响应示例

**创建变更单**

POST /ecn
```json
{
  "project_id": 101,
  "machine_id": 201,
  "change_type": "DC",
  "urgency": "B",
  "title": "工位板结构优化",
  "change_reason": "装配时发现干涉，需调整工位板结构",
  "change_description": "工位板增加避让槽，调整安装孔位置",
  "original_design": "工位板尺寸300x200，4个M6安装孔",
  "new_design": "工位板尺寸300x200，增加30x10避让槽，安装孔位置偏移10mm"
}
```

响应：
```json
{
  "code": "OK",
  "data": {
    "id": 15,
    "ecn_code": "ECN-PJ250712001-001",
    "status": "DRAFT"
  }
}
```

**提交部门评估**

POST /ecn/15/evaluations
```json
{
  "department": "ME",
  "is_affected": true,
  "impact_level": "MEDIUM",
  "technical_impact": "需修改工位板图纸，重新外协加工",
  "bom_changes": [
    {"action": "MODIFY", "material_code": "ME-02-01-0015", "change": "增加避让槽"}
  ],
  "drawing_changes": ["DWG-WZB-001"],
  "material_cost": 500,
  "labor_cost": 800,
  "outsource_cost": 1200,
  "total_cost": 2500,
  "design_days": 1,
  "process_days": 5,
  "total_delay_days": 6,
  "recommendation": "建议执行，影响可控"
}
```

---

## 八、页面设计

### 8.1 页面清单

| 页面 | 功能 | 访问角色 |
|------|------|----------|
| 变更单列表 | 查看/筛选变更单 | 所有人 |
| 变更单详情 | 查看完整信息 | 项目成员 |
| 创建变更单 | 填写变更申请 | 工程师/PM |
| 评估页面 | 部门评估填写 | 各部门 |
| 审批页面 | 审批操作 | 审批人 |
| 执行跟踪 | 执行任务管理 | PM/执行人 |
| 变更统计 | 统计分析 | 管理层 |

### 8.2 变更单列表页

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  变更管理                                           [+ 新建变更] [导出]      │
├─────────────────────────────────────────────────────────────────────────────┤
│  类型: [全部▼]  紧急度: [全部▼]  状态: [全部▼]  项目: [全部▼]  [搜索...]    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🔴 ECN-PJ250712001-001 | 工位板结构优化                    B-紧急   │   │
│  │ 项目: PJ250712001  |  类型: 设计变更  |  状态: 评估中               │   │
│  │ 发起人: 张工  |  发起时间: 2025-07-12  |  预计成本: ¥2,500          │   │
│  │ 评估进度: ME✓ EE○ SW- PU○ PMC○                                      │   │
│  │                                                           [详情]    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🟡 ECN-PJ250710002-003 | 物料替代-伺服电机                 C-一般   │   │
│  │ 项目: PJ250710002  |  类型: 物料替代  |  状态: 待审批               │   │
│  │ 发起人: 李采购  |  发起时间: 2025-07-10  |  预计成本: ¥-3,000       │   │
│  │                                                           [详情]    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🟢 ECN-PJ250708003-001 | 客户需求变更-增加工位             C-一般   │   │
│  │ 项目: PJ250708003  |  类型: 需求变更  |  状态: 执行中               │   │
│  │ 发起人: 王PM  |  审批人: 技术总监  |  预计成本: ¥15,000            │   │
│  │ 执行进度: 3/5 任务完成                                              │   │
│  │                                                           [详情]    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.3 变更单详情页

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ← 返回  ECN-PJ250712001-001                           [编辑] [提交] [...]  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 状态流程 ────────────────────────────────────────────────────────────┐ │
│  │  ●草稿 ──► ●提交 ──► ○评估中 ──► ○待审批 ──► ○执行中 ──► ○已完成     │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌─ 基本信息 ───────────────────────────────────────────────────────────┐  │
│  │ 变更编号: ECN-PJ250712001-001      变更类型: 设计变更                │  │
│  │ 关联项目: PJ250712001-XX公司ICT    关联机台: PN001                   │  │
│  │ 紧急程度: B-紧急                   发起人: 张工                      │  │
│  │ 发起日期: 2025-07-12               来源: 内部发现                    │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─ 变更内容 ───────────────────────────────────────────────────────────┐  │
│  │ 变更标题: 工位板结构优化                                             │  │
│  │ 变更原因: 装配时发现干涉，需调整工位板结构                           │  │
│  │ 变更描述: 工位板增加避让槽，调整安装孔位置                           │  │
│  │ 原设计: 工位板尺寸300x200，4个M6安装孔                               │  │
│  │ 新设计: 工位板尺寸300x200，增加30x10避让槽，安装孔位置偏移10mm       │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─ 影响评估 ───────────────────────────────────────────────────────────┐  │
│  │ 部门      状态      影响      成本        工期      评估人    操作   │  │
│  │ ─────────────────────────────────────────────────────────────────── │  │
│  │ 机械部    已完成    中       ¥2,500      6天       张工     [查看]  │  │
│  │ 电气部    待评估    -        -           -         -        [评估]  │  │
│  │ 软件部    不涉及    -        -           -         -        -       │  │
│  │ 采购部    待评估    -        -           -         -        [评估]  │  │
│  │ PMC      待评估    -        -           -         -        [评估]  │  │
│  │ ─────────────────────────────────────────────────────────────────── │  │
│  │ 合计              -        ¥2,500      6天                          │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  [Tab: 影响物料] [执行任务] [追溯记录] [审批记录] [附件]                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、权限矩阵

| 功能 | 工程师 | PM | 部门经理 | 技术总监 | 总经理 | 管理员 |
|------|:------:|:--:|:--------:|:--------:|:------:|:------:|
| 发起变更 | W | W | W | W | - | W |
| 编辑变更 | W(自己) | W | W | W | - | W |
| 部门评估 | W(本部门) | R | W | W | R | W |
| 审批(小额) | - | A | A | A | - | A |
| 审批(中额) | - | - | A | A | - | A |
| 审批(大额) | - | - | - | A | A | A |
| 执行任务 | W | W | W | R | R | W |
| 关闭变更 | - | W | W | W | W | W |
| 变更统计 | R | R | R | R | R | R |

---

## 十、配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| 变更编码前缀 | ECN | 变更单编码格式 |
| 小额成本阈值 | 10000 | 小于此值为小额变更 |
| 中额成本阈值 | 50000 | 小于此值为中额变更 |
| 评估超时天数 | 3 | 评估超时提醒 |
| 审批超时天数 | 2 | 审批超时提醒 |
| 自动通知客户 | 需求变更时 | 自动发送客户确认 |

---

## 十一、与其他模块联动

| 变更模块事件 | 响应模块 | 响应动作 |
|--------------|----------|----------|
| ECN审批通过 | 采购模块 | 生成新BOM版本 |
| ECN影响采购 | 采购模块 | 调整/取消采购单 |
| ECN影响交期 | 项目管理 | 更新协商交期 |
| ECN成本增加 | 销售管理 | 生成变更报价 |
| ECN执行完成 | 项目管理 | 记录变更历史 |

| 触发模块 | 事件 | 变更模块响应 |
|----------|------|--------------|
| 采购模块 | 物料缺货需替代 | 自动创建物料替代ECR |
| 验收管理 | 验收问题需变更 | 关联问题到ECN |
| 项目管理 | 客户需求变更 | 自动创建需求变更ECR |

---

*本文档与项目管理、采购与物料、验收管理模块配套使用。*

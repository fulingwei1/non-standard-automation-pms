version: '3.8'

# ========================================
# Docker Compose 配置 - 使用 Docker Secrets
# ========================================
# 
# 此配置展示了如何使用 Docker Secrets 管理敏感密钥
# 
# 使用方法:
# 1. 创建密钥文件: secrets/secret_key.txt
# 2. 启动服务: docker-compose -f docker-compose.secrets.yml up -d
# 
# ========================================

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: pms-backend:latest
    container_name: pms-backend
    
    # ========================================
    # Secrets 配置
    # ========================================
    secrets:
      - secret_key
      - old_secret_keys
    
    environment:
      # 数据库配置
      - DATABASE_URL=sqlite:///data/app.db
      
      # 密钥配置（从 Secrets 读取）
      - SECRET_KEY_FILE=/run/secrets/secret_key
      - OLD_SECRET_KEYS_FILE=/run/secrets/old_secret_keys
      
      # 密钥管理配置
      - SECRET_KEY_MIN_LENGTH=32
      - SECRET_KEY_ROTATION_DAYS=90
      - OLD_KEYS_GRACE_PERIOD_DAYS=30
      - OLD_KEYS_MAX_COUNT=3
      
      # JWT配置
      - ACCESS_TOKEN_EXPIRE_MINUTES=1440  # 24小时
      
      # CORS配置
      - CORS_ORIGINS=http://localhost:3000,http://localhost:5173
      
      # 应用配置
      - DEBUG=false
      - APP_NAME=非标自动化项目管理系统
      - APP_VERSION=1.0.0
    
    ports:
      - "8000:8000"
    
    volumes:
      - ./data:/app/data
      - ./uploads:/app/uploads
    
    networks:
      - pms-network
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: pms-frontend:latest
    container_name: pms-frontend
    
    environment:
      - VITE_API_BASE_URL=http://localhost:8000/api/v1
    
    ports:
      - "3000:80"
    
    networks:
      - pms-network
    
    depends_on:
      - backend
    
    restart: unless-stopped

# ========================================
# Secrets 定义
# ========================================
secrets:
  # 当前密钥（必需）
  secret_key:
    file: ./secrets/secret_key.txt
  
  # 旧密钥列表（可选）
  old_secret_keys:
    file: ./secrets/old_secret_keys.txt

# ========================================
# 网络配置
# ========================================
networks:
  pms-network:
    driver: bridge

# ========================================
# 卷配置
# ========================================
volumes:
  pms-data:
    driver: local
  pms-uploads:
    driver: local

# ========================================
# 使用说明
# ========================================
# 
# 1. 准备密钥文件:
#    python scripts/manage_secrets.py generate > secrets/secret_key.txt
# 
# 2. 设置文件权限:
#    chmod 600 secrets/*.txt
# 
# 3. 启动服务:
#    docker-compose -f docker-compose.secrets.yml up -d
# 
# 4. 查看日志:
#    docker-compose -f docker-compose.secrets.yml logs -f backend
# 
# 5. 停止服务:
#    docker-compose -f docker-compose.secrets.yml down
# 
# 6. 密钥轮转:
#    - 生成新密钥: python scripts/manage_secrets.py rotate
#    - 更新 secrets/secret_key.txt
#    - 更新 secrets/old_secret_keys.txt（将旧密钥追加）
#    - 重启服务: docker-compose -f docker-compose.secrets.yml restart backend
# 
# ========================================

# ModSecurity自定义规则
# 版本: 1.0.0
# 日期: 2026-02-15
# 用途: 针对非标准自动化PMS的特定安全规则

# ============ 路径穿越防护 ============
SecRule REQUEST_URI "@contains ../" \
    "id:10001,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Path Traversal Attack Detected',\
    severity:CRITICAL,\
    tag:'attack-traversal',\
    tag:'OWASP_CRS',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

SecRule REQUEST_URI "@contains ..%5c" \
    "id:10002,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Path Traversal Attack Detected (encoded)',\
    severity:CRITICAL,\
    tag:'attack-traversal'"

SecRule REQUEST_URI "@rx (?:\x5c|\\\\)\.\." \
    "id:10003,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Windows Path Traversal Attack',\
    severity:CRITICAL,\
    tag:'attack-traversal'"

# ============ 敏感文件访问防护 ============
SecRule REQUEST_URI "@rx \.env$" \
    "id:10010,\
    phase:1,\
    deny,\
    status:404,\
    log,\
    msg:'Sensitive File Access Attempt - .env',\
    severity:CRITICAL,\
    tag:'attack-disclosure',\
    logdata:'URI: %{REQUEST_URI}'"

SecRule REQUEST_URI "@rx \.(git|svn|hg|bzr)" \
    "id:10011,\
    phase:1,\
    deny,\
    status:404,\
    log,\
    msg:'Version Control File Access Attempt',\
    severity:CRITICAL,\
    tag:'attack-disclosure'"

SecRule REQUEST_URI "@rx \.(sql|bak|backup|old|tmp|temp|swp|~)$" \
    "id:10012,\
    phase:1,\
    deny,\
    status:404,\
    log,\
    msg:'Backup/Temporary File Access Attempt',\
    severity:WARNING,\
    tag:'attack-disclosure'"

SecRule REQUEST_URI "@rx (config|database|settings)\.(ini|yml|yaml|json|xml)$" \
    "id:10013,\
    phase:1,\
    deny,\
    status:404,\
    log,\
    msg:'Configuration File Access Attempt',\
    severity:CRITICAL,\
    tag:'attack-disclosure'"

# ============ 恶意扫描器检测 ============
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(sqlmap|nikto|nmap|masscan|acunetix|burp|metasploit|havij|w3af|dirbuster|gobuster|wpscan)" \
    "id:10020,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Malicious Security Scanner Detected',\
    severity:CRITICAL,\
    tag:'attack-generic',\
    logdata:'User-Agent: %{MATCHED_VAR}'"

SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(python-requests|curl|wget|libwww-perl|go-http-client)" \
    "id:10021,\
    phase:1,\
    log,\
    pass,\
    msg:'Automated Client Detected',\
    severity:NOTICE,\
    tag:'monitoring',\
    logdata:'User-Agent: %{MATCHED_VAR}'"

# ============ SQL注入额外检测 ============
SecRule ARGS "@rx (?i)(union.*select|select.*from|insert.*into|delete.*from|drop.*table|update.*set)" \
    "id:10030,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SQL Injection Attack Detected',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'OWASP_TOP_10',\
    logdata:'Matched Data: %{MATCHED_VAR}'"

# ============ XSS额外检测 ============
SecRule ARGS "@rx (?i)(<script|javascript:|onerror=|onload=|<iframe|<object|<embed)" \
    "id:10040,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XSS Attack Detected',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'OWASP_TOP_10',\
    logdata:'Matched Data: %{MATCHED_VAR}'"

# ============ 命令注入检测 ============
SecRule ARGS "@rx (?i)(;|\||`|&|\$\(|>|<|\\n|\\r)" \
    "id:10050,\
    phase:2,\
    log,\
    pass,\
    msg:'Potential Command Injection Characters',\
    severity:WARNING,\
    tag:'attack-injection',\
    logdata:'Matched Data: %{MATCHED_VAR}'"

SecRule ARGS "@rx (?i)(cat|ls|wget|curl|nc|bash|sh|cmd|powershell|exec|system|eval)\s" \
    "id:10051,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Command Injection Attack Detected',\
    severity:CRITICAL,\
    tag:'attack-injection',\
    logdata:'Matched Data: %{MATCHED_VAR}'"

# ============ 文件上传限制 ============
SecRule FILES_TMPNAMES "@rx (?i)\.(php|php5|phtml|asp|aspx|jsp|exe|sh|bat|cmd|com)$" \
    "id:10060,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Dangerous File Extension Upload Attempt',\
    severity:CRITICAL,\
    tag:'attack-upload',\
    logdata:'Filename: %{FILES_NAMES}'"

# ============ SSRF防护 ============
SecRule ARGS "@rx (?i)(localhost|127\.0\.0\.1|0\.0\.0\.0|::1|169\.254)" \
    "id:10070,\
    phase:2,\
    log,\
    pass,\
    msg:'Potential SSRF Attack - Local Address',\
    severity:WARNING,\
    tag:'attack-ssrf',\
    logdata:'Matched Data: %{MATCHED_VAR}'"

SecRule ARGS "@rx (?i)(file://|gopher://|dict://|ftp://|tftp://)" \
    "id:10071,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SSRF Attack Detected - Dangerous Protocol',\
    severity:CRITICAL,\
    tag:'attack-ssrf',\
    logdata:'Matched Data: %{MATCHED_VAR}'"

# ============ API滥用检测 ============
# 检测异常大的JSON请求
SecRule REQUEST_HEADERS:Content-Type "@contains application/json" \
    "id:10080,\
    phase:1,\
    chain,\
    log,\
    pass,\
    msg:'Large JSON Request Detected'"
    SecRule REQUEST_HEADERS:Content-Length "@gt 1048576" \
        "severity:WARNING,\
        tag:'api-abuse',\
        logdata:'Content-Length: %{MATCHED_VAR}'"

# ============ 暴力破解防护 ============
# 通过速率限制实现，此处仅记录
SecRule REQUEST_URI "@beginsWith /api/v1/auth/login" \
    "id:10090,\
    phase:1,\
    log,\
    pass,\
    msg:'Login Attempt Detected',\
    severity:NOTICE,\
    tag:'authentication',\
    logdata:'IP: %{REMOTE_ADDR}'"

# ============ 空User-Agent检测 ============
SecRule REQUEST_HEADERS:User-Agent "@eq \"\"" \
    "id:10100,\
    phase:1,\
    log,\
    pass,\
    msg:'Empty User-Agent Detected',\
    severity:WARNING,\
    tag:'protocol-violation',\
    setvar:'tx.anomaly_score_pl1=+%{tx.warning_anomaly_score}'"

# ============ 协议异常检测 ============
SecRule REQUEST_PROTOCOL "!@rx ^HTTP/(1\.[01]|2)$" \
    "id:10110,\
    phase:1,\
    deny,\
    status:400,\
    log,\
    msg:'Invalid HTTP Protocol',\
    severity:CRITICAL,\
    tag:'protocol-violation'"

# ============ 自定义IP黑名单 ============
# 示例：已知恶意IP（实际使用时应从外部文件加载）
# SecRule REMOTE_ADDR "@ipMatch 192.0.2.1,198.51.100.0/24" \
#     "id:10120,\
#     phase:1,\
#     deny,\
#     status:403,\
#     log,\
#     msg:'Blocked IP Address',\
#     severity:CRITICAL,\
#     tag:'blacklist'"

# ============ 异常评分总结 ============
# 当异常评分超过阈值时阻止请求
SecRule TX:ANOMALY_SCORE "@ge %{tx.inbound_anomaly_score_threshold}" \
    "id:10999,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Inbound Anomaly Score Exceeded (Total Score: %{TX.ANOMALY_SCORE})',\
    severity:CRITICAL,\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-generic'"

# ModSecurity主配置文件
# 版本: 1.0.0
# 日期: 2026-02-15
# 用途: 非标准自动化PMS WAF防护

# ============ 包含推荐配置 ============
Include /etc/nginx/modsecurity/modsecurity.conf

# ============ 包含OWASP CRS核心规则集 ============
Include /usr/share/modsecurity-crs/crs-setup.conf
Include /usr/share/modsecurity-crs/rules/*.conf

# ============ 自定义规则 ============
Include /etc/nginx/modsecurity/custom-rules.conf

# ============ 全局配置 ============

# 审计日志
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/nginx/modsec_audit.log

# 请求体限制
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyInMemoryLimit 131072

# 响应体检测
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# 临时目录
SecTmpDir /tmp/
SecDataDir /tmp/

# 参数异常评分阈值
SecAction \
 "id:900110,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score_threshold=5,\
  setvar:tx.outbound_anomaly_score_threshold=4"

# 执行模式：DetectionOnly | On
# 初始建议使用DetectionOnly进行测试，确认无误后切换为On
SecRuleEngine On

# 参数化日志
SecAction \
  "id:900120,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.anomaly_score_blocking=on"

# ============ IP白名单（示例） ============
# 信任的内网IP段，跳过WAF检测
# SecRule REMOTE_ADDR "@ipMatch 192.168.1.0/24,10.0.0.0/8" \
#     "id:1000,phase:1,nolog,pass,ctl:ruleEngine=Off"

# ============ 排除规则（针对误报） ============
# 如果某些规则对你的应用产生误报，可以在此排除
# 示例：排除对上传接口的某些检查
# SecRule REQUEST_URI "@beginsWith /api/v1/upload" \
#     "id:1100,phase:1,nolog,pass,ctl:ruleRemoveById=920420"

# 排除对登录接口的body检查（避免密码策略误报）
# SecRule REQUEST_URI "@beginsWith /api/v1/auth/login" \
#     "id:1101,phase:1,nolog,pass,ctl:ruleRemoveById=942100"

# ç®¡ç†å‘˜é‡ç½®ç”¨æˆ·å¯†ç æŒ‡å—

## æ¦‚è¿°

ç®¡ç†å‘˜å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼é‡ç½®ç”¨æˆ·å¯†ç ã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å„ç§é‡ç½®å¯†ç çš„æ–¹æ³•å’Œæ³¨æ„äº‹é¡¹ã€‚

---

## æ–¹æ³•ä¸€ï¼šé€šè¿‡å‰ç«¯ç”¨æˆ·ç®¡ç†ç•Œé¢ï¼ˆæ¨èï¼‰

### é€‚ç”¨åœºæ™¯
- é‡ç½®æ™®é€šç”¨æˆ·å¯†ç 
- é‡ç½®è¶…çº§ç®¡ç†å‘˜å¯†ç ï¼ˆéœ€è¦é¢å¤–ç¡®è®¤ï¼‰

### æ“ä½œæ­¥éª¤

1. **ç™»å½•ç³»ç»Ÿ**
   - ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•ç³»ç»Ÿ
   - ç¡®ä¿æ‹¥æœ‰ `USER_UPDATE` æƒé™

2. **è¿›å…¥ç”¨æˆ·ç®¡ç†é¡µé¢**
   - å¯¼èˆªåˆ°"ç”¨æˆ·ç®¡ç†"æˆ–"ç³»ç»Ÿç®¡ç†" â†’ "ç”¨æˆ·ç®¡ç†"
   - æˆ–ç›´æ¥è®¿é—® `/users` é¡µé¢

3. **æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·**
   - ä½¿ç”¨æœç´¢æ¡†æˆ–ç­›é€‰æ¡ä»¶æ‰¾åˆ°éœ€è¦é‡ç½®å¯†ç çš„ç”¨æˆ·
   - åœ¨ç”¨æˆ·åˆ—è¡¨çš„æ“ä½œåˆ—ä¸­æ‰¾åˆ°"é‡ç½®å¯†ç "æŒ‰é’®ï¼ˆé’¥åŒ™å›¾æ ‡ ğŸ”‘ï¼‰

4. **é‡ç½®å¯†ç **
   - ç‚¹å‡»"é‡ç½®å¯†ç "æŒ‰é’®
   - **æ™®é€šç”¨æˆ·**ï¼šç¡®è®¤å¯¹è¯æ¡†åç›´æ¥é‡ç½®
   - **è¶…çº§ç®¡ç†å‘˜**ï¼šéœ€è¦äºŒæ¬¡ç¡®è®¤ï¼ˆå®‰å…¨ä¿æŠ¤ï¼‰

5. **è·å–æ–°å¯†ç **
   - é‡ç½®æˆåŠŸåï¼Œç³»ç»Ÿä¼šå¼¹å‡ºå¯¹è¯æ¡†æ˜¾ç¤ºæ–°å¯†ç 
   - **è¯·å¦¥å–„ä¿ç®¡æ–°å¯†ç **ï¼Œå¹¶é€šçŸ¥ç”¨æˆ·åŠæ—¶ä¿®æ”¹

### å¯†ç è§„åˆ™

é‡ç½®åçš„åˆå§‹å¯†ç è§„åˆ™ï¼š
- **æ ¼å¼**ï¼š`ç”¨æˆ·å + èº«ä»½è¯å4ä½`ï¼ˆä¼˜å…ˆï¼‰
- **å›é€€**ï¼šå¦‚æœèº«ä»½è¯å·ä¸å­˜åœ¨ï¼Œä½¿ç”¨ `ç”¨æˆ·å + å·¥å·å4ä½`
- **ç¤ºä¾‹**ï¼š
  - ç”¨æˆ·åï¼š`zhangsan`ï¼Œèº«ä»½è¯ï¼š`310101199001011234` â†’ å¯†ç ï¼š`zhangsan1234`
  - ç”¨æˆ·åï¼š`lisi`ï¼Œå·¥å·ï¼š`E0001` â†’ å¯†ç ï¼š`lisi0001`

### æ³¨æ„äº‹é¡¹

âš ï¸ **è¶…çº§ç®¡ç†å‘˜å¯†ç é‡ç½®**
- é‡ç½®è¶…çº§ç®¡ç†å‘˜å¯†ç éœ€è¦**äºŒæ¬¡ç¡®è®¤**
- ç³»ç»Ÿä¼šæ˜¾ç¤ºè­¦å‘Šæç¤ºï¼Œè¯·ç¡®ä¿æ‚¨æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ
- é‡ç½®åè¯·ç«‹å³é€šçŸ¥è¶…çº§ç®¡ç†å‘˜ï¼Œå¹¶å»ºè®®å…¶å°½å¿«ä¿®æ”¹å¯†ç 

---

## æ–¹æ³•äºŒï¼šé€šè¿‡ API ç›´æ¥è°ƒç”¨

### é€‚ç”¨åœºæ™¯
- æ‰¹é‡é‡ç½®å¯†ç ï¼ˆéœ€è¦ç¼–å†™è„šæœ¬ï¼‰
- è‡ªåŠ¨åŒ–åœºæ™¯
- å‰ç«¯ç•Œé¢ä¸å¯ç”¨æ—¶

### API ç«¯ç‚¹

```
PUT /api/v1/users/{user_id}/reset-password
```

### è¯·æ±‚ç¤ºä¾‹

#### ä½¿ç”¨ curl

```bash
# è®¾ç½®å˜é‡
TOKEN="your_access_token"
USER_ID=1

# è°ƒç”¨API
curl -X PUT "http://127.0.0.1:8000/api/v1/users/${USER_ID}/reset-password" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json"
```

#### ä½¿ç”¨ Python

```python
import requests

# é…ç½®
BASE_URL = "http://127.0.0.1:8000"
TOKEN = "your_access_token"
USER_ID = 1

# è°ƒç”¨API
headers = {
    "Authorization": f"Bearer {TOKEN}",
    "Content-Type": "application/json"
}

response = requests.put(
    f"{BASE_URL}/api/v1/users/{USER_ID}/reset-password",
    headers=headers
)

if response.status_code == 200:
    data = response.json()
    new_password = data["data"]["new_password"]
    print(f"å¯†ç é‡ç½®æˆåŠŸï¼æ–°å¯†ç : {new_password}")
else:
    print(f"é‡ç½®å¤±è´¥: {response.json()}")
```

### å“åº”æ ¼å¼

**æˆåŠŸå“åº”** (200):
```json
{
  "code": 200,
  "message": "å¯†ç é‡ç½®æˆåŠŸ",
  "data": {
    "new_password": "zhangsan1234"
  }
}
```

**é”™è¯¯å“åº”** (400/404):
```json
{
  "detail": "ç”¨æˆ·ä¸å­˜åœ¨"
}
```

### æƒé™è¦æ±‚

- éœ€è¦ `USER_UPDATE` æƒé™
- éœ€è¦æœ‰æ•ˆçš„ JWT Token

---

## æ–¹æ³•ä¸‰ï¼šæ‰¹é‡é‡ç½®å¯†ç è„šæœ¬

### åˆ›å»ºæ‰¹é‡é‡ç½®è„šæœ¬

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ‰¹é‡é‡ç½®ç”¨æˆ·å¯†ç è„šæœ¬
ç”¨æ³•: python3 batch_reset_passwords.py [user_ids...]
"""

import sys
import requests

BASE_URL = "http://127.0.0.1:8000"
TOKEN = "your_access_token"  # éœ€è¦æ›¿æ¢ä¸ºå®é™…çš„token

def reset_password(user_id):
    """é‡ç½®å•ä¸ªç”¨æˆ·å¯†ç """
    headers = {
        "Authorization": f"Bearer {TOKEN}",
        "Content-Type": "application/json"
    }
    
    try:
        response = requests.put(
            f"{BASE_URL}/api/v1/users/{user_id}/reset-password",
            headers=headers
        )
        
        if response.status_code == 200:
            data = response.json()
            return True, data["data"]["new_password"]
        else:
            return False, response.json().get("detail", "æœªçŸ¥é”™è¯¯")
    except Exception as e:
        return False, str(e)

def main():
    if len(sys.argv) < 2:
        print("ç”¨æ³•: python3 batch_reset_passwords.py <user_id1> [user_id2] ...")
        sys.exit(1)
    
    user_ids = [int(uid) for uid in sys.argv[1:]]
    results = []
    
    print(f"å¼€å§‹é‡ç½® {len(user_ids)} ä¸ªç”¨æˆ·çš„å¯†ç ...\n")
    
    for user_id in user_ids:
        success, result = reset_password(user_id)
        results.append({
            "user_id": user_id,
            "success": success,
            "password": result if success else None,
            "error": result if not success else None
        })
    
    # è¾“å‡ºç»“æœ
    print("\n" + "="*60)
    print("é‡ç½®ç»“æœæ±‡æ€»")
    print("="*60)
    
    for r in results:
        if r["success"]:
            print(f"âœ“ ç”¨æˆ· {r['user_id']}: å¯†ç é‡ç½®ä¸º {r['password']}")
        else:
            print(f"âœ— ç”¨æˆ· {r['user_id']}: å¤±è´¥ - {r['error']}")
    
    # ä¿å­˜ç»“æœåˆ°æ–‡ä»¶
    with open("password_reset_results.txt", "w", encoding="utf-8") as f:
        f.write("å¯†ç é‡ç½®ç»“æœ\n")
        f.write("="*60 + "\n\n")
        for r in results:
            if r["success"]:
                f.write(f"ç”¨æˆ·ID: {r['user_id']}\n")
                f.write(f"æ–°å¯†ç : {r['password']}\n")
                f.write("-"*60 + "\n")
    
    print(f"\nç»“æœå·²ä¿å­˜åˆ° password_reset_results.txt")

if __name__ == "__main__":
    main()
```

### ä½¿ç”¨ç¤ºä¾‹

```bash
# é‡ç½®å•ä¸ªç”¨æˆ·
python3 batch_reset_passwords.py 1

# æ‰¹é‡é‡ç½®å¤šä¸ªç”¨æˆ·
python3 batch_reset_passwords.py 1 2 3 4 5
```

---

## æ–¹æ³•å››ï¼šä½¿ç”¨ create_admin.py è„šæœ¬ï¼ˆä»…é™è¶…çº§ç®¡ç†å‘˜ï¼‰

### é€‚ç”¨åœºæ™¯
- é‡ç½®è¶…çº§ç®¡ç†å‘˜å¯†ç 
- åˆ›å»ºæ–°çš„è¶…çº§ç®¡ç†å‘˜è´¦å·

### ä½¿ç”¨æ–¹æ³•

```bash
# é‡ç½®ç°æœ‰è¶…çº§ç®¡ç†å‘˜å¯†ç 
python3 create_admin.py admin new_password

# åˆ›å»ºæ–°çš„è¶…çº§ç®¡ç†å‘˜
python3 create_admin.py new_admin new_password
```

### æ³¨æ„äº‹é¡¹

- æ­¤è„šæœ¬ä¼šåˆ›å»ºæˆ–æ›´æ–°ç®¡ç†å‘˜è´¦å·
- ä¼šè‡ªåŠ¨åˆ†é… `ADMIN` è§’è‰²
- ä¼šè®¾ç½® `is_superuser = True`

---

## æƒé™è¯´æ˜

### éœ€è¦çš„æƒé™

- **`USER_UPDATE`**ï¼šç”¨æˆ·æ›´æ–°æƒé™
  - å…è®¸é‡ç½®ç”¨æˆ·å¯†ç 
  - å…è®¸ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
  - å…è®¸æ¿€æ´»/ç¦ç”¨ç”¨æˆ·

### æƒé™æ£€æŸ¥

ç³»ç»Ÿä¼šåœ¨ä»¥ä¸‹æƒ…å†µæ£€æŸ¥æƒé™ï¼š
1. å‰ç«¯ç•Œé¢ï¼šæŒ‰é’®ä¼šæ ¹æ®æƒé™æ˜¾ç¤º/éšè—
2. åç«¯APIï¼šè‡ªåŠ¨éªŒè¯ `USER_UPDATE` æƒé™
3. å®¡è®¡æ—¥å¿—ï¼šæ‰€æœ‰å¯†ç é‡ç½®æ“ä½œéƒ½ä¼šè®°å½•

---

## å®‰å…¨æ³¨æ„äº‹é¡¹

### âš ï¸ é‡è¦æé†’

1. **å¯†ç å®‰å…¨**
   - é‡ç½®åçš„åˆå§‹å¯†ç åº”å°½å¿«é€šçŸ¥ç”¨æˆ·
   - å»ºè®®ç”¨æˆ·é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹å¯†ç 
   - ä¸è¦é€šè¿‡ä¸å®‰å…¨æ¸ é“ä¼ è¾“å¯†ç 

2. **æƒé™æ§åˆ¶**
   - åªæœ‰æ‹¥æœ‰ `USER_UPDATE` æƒé™çš„ç®¡ç†å‘˜æ‰èƒ½é‡ç½®å¯†ç 
   - è¶…çº§ç®¡ç†å‘˜å¯†ç é‡ç½®éœ€è¦é¢å¤–ç¡®è®¤

3. **å®¡è®¡æ—¥å¿—**
   - æ‰€æœ‰å¯†ç é‡ç½®æ“ä½œéƒ½ä¼šè®°å½•å®¡è®¡æ—¥å¿—
   - åŒ…æ‹¬æ“ä½œäººã€ç›®æ ‡ç”¨æˆ·ã€æ“ä½œæ—¶é—´ç­‰ä¿¡æ¯

4. **æ‰¹é‡æ“ä½œ**
   - æ‰¹é‡é‡ç½®å¯†ç æ—¶ï¼Œè¯·ç¡®ä¿æœ‰æƒé™æ“ä½œæ‰€æœ‰ç›®æ ‡ç”¨æˆ·
   - å»ºè®®åˆ†æ‰¹æ“ä½œï¼Œé¿å…ä¸€æ¬¡æ€§é‡ç½®è¿‡å¤šç”¨æˆ·

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸èƒ½é‡ç½®æŸäº›ç”¨æˆ·çš„å¯†ç ï¼Ÿ

**A**: å¯èƒ½çš„åŸå› ï¼š
- æ²¡æœ‰ `USER_UPDATE` æƒé™
- ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤
- ç”¨æˆ·æœªå…³è”å‘˜å·¥ä¿¡æ¯ï¼ˆæ— æ³•ç”Ÿæˆåˆå§‹å¯†ç ï¼‰

### Q2: é‡ç½®åçš„å¯†ç æ˜¯ä»€ä¹ˆï¼Ÿ

**A**: åˆå§‹å¯†ç è§„åˆ™ï¼š
- `ç”¨æˆ·å + èº«ä»½è¯å4ä½`ï¼ˆä¼˜å…ˆï¼‰
- å¦‚æœèº«ä»½è¯ä¸å­˜åœ¨ï¼Œä½¿ç”¨ `ç”¨æˆ·å + å·¥å·å4ä½`

### Q3: å¦‚ä½•æŸ¥çœ‹é‡ç½®åçš„å¯†ç ï¼Ÿ

**A**: 
- å‰ç«¯ç•Œé¢ï¼šé‡ç½®æˆåŠŸåä¼šå¼¹å‡ºå¯¹è¯æ¡†æ˜¾ç¤ºæ–°å¯†ç 
- APIè°ƒç”¨ï¼šå“åº”ä¸­çš„ `data.new_password` å­—æ®µåŒ…å«æ–°å¯†ç 

### Q4: å¯ä»¥æ‰¹é‡é‡ç½®æ‰€æœ‰ç”¨æˆ·å¯†ç å—ï¼Ÿ

**A**: 
- ç³»ç»Ÿæ²¡æœ‰å†…ç½®çš„æ‰¹é‡é‡ç½®åŠŸèƒ½
- å¯ä»¥ä½¿ç”¨æä¾›çš„ Python è„šæœ¬æ‰¹é‡é‡ç½®
- æˆ–é€šè¿‡ API å¾ªç¯è°ƒç”¨å®ç°æ‰¹é‡é‡ç½®

### Q5: é‡ç½®å¯†ç åç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•å—ï¼Ÿ

**A**: 
- é‡ç½®å¯†ç ä¸ä¼šè‡ªåŠ¨é€€å‡ºç”¨æˆ·å½“å‰ä¼šè¯
- ä½†ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶å¿…é¡»ä½¿ç”¨æ–°å¯†ç 
- å»ºè®®é€šçŸ¥ç”¨æˆ·å°½å¿«ä½¿ç”¨æ–°å¯†ç ç™»å½•å¹¶ä¿®æ”¹

---

## ç›¸å…³æ–‡ä»¶

- **å‰ç«¯ç•Œé¢**: `frontend/src/pages/UserManagement.jsx`
- **åç«¯API**: `app/api/v1/endpoints/users.py` (PUT `/api/v1/users/{user_id}/reset-password`)
- **å¯†ç ç”Ÿæˆ**: `app/utils/pinyin_utils.py` (`generate_initial_password`)
- **æœåŠ¡å±‚**: `app/services/user_sync_service.py` (`reset_user_password`)
- **ç®¡ç†å‘˜è„šæœ¬**: `create_admin.py`

---

## æ›´æ–°æ—¥å¿—

- **2026-01-08**: åˆå§‹ç‰ˆæœ¬
  - æ”¯æŒå‰ç«¯ç•Œé¢é‡ç½®å¯†ç 
  - æ”¯æŒAPIé‡ç½®å¯†ç 
  - æ”¯æŒè¶…çº§ç®¡ç†å‘˜å¯†ç é‡ç½®ï¼ˆéœ€äºŒæ¬¡ç¡®è®¤ï¼‰

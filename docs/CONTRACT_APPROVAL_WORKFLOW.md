# 合同审批流程说明

## 📋 概述

本文档详细说明合同管理模块的审批流程规则、配置方法和最佳实践。

---

## 🎯 审批流程设计原则

### 1. 分级审批
根据合同金额自动确定审批层级，确保：
- 小额合同快速审批
- 大额合同严格把控
- 责任明确可追溯

### 2. 串行审批
审批流程按层级顺序执行：
- 第1级审批通过后，进入第2级
- 第2级审批通过后，进入第3级
- 所有级别通过后，合同审批完成

### 3. 一票否决
任一审批人驳回，合同回到草稿状态：
- 创建人修改后可重新提交
- 重新提交后审批流程重置

---

## 💰 审批规则配置

### 当前审批规则

| 合同金额范围 | 审批层级 | 审批角色 | 审批时长（SLA） |
|-------------|---------|---------|----------------|
| < 10万元 | 1级 | 销售经理 | 1个工作日 |
| 10万 - 50万元 | 1级 | 销售总监 | 2个工作日 |
| > 50万元 | 3级 | ① 销售总监<br>② 财务总监<br>③ 总经理 | 5个工作日 |

### 审批角色说明

**1. 销售经理** (`sales_manager`)
- 职责：审核合同商务条款
- 权限：审批10万以下合同
- 关注点：客户信用、价格合理性、交付可行性

**2. 销售总监** (`sales_director`)
- 职责：审核合同整体方案
- 权限：审批10-50万合同，参与50万以上审批
- 关注点：战略价值、毛利率、风险评估

**3. 财务总监** (`finance_director`)
- 职责：审核合同财务条款
- 权限：参与50万以上合同审批
- 关注点：付款条件、账期风险、现金流影响

**4. 总经理** (`general_manager`)
- 职责：最终决策
- 权限：审批所有50万以上合同
- 关注点：公司战略、重大风险、资源配置

---

## 🔄 审批流程详解

### 场景1：小额合同（< 10万元）

**示例**：合同金额 80,000元

```
步骤1：创建合同
   ↓
步骤2：提交审批
   ↓
步骤3：销售经理审批
   ├─ 通过 → 合同状态：已审批 ✅
   └─ 驳回 → 合同状态：草稿 ❌
```

**审批周期**：通常1个工作日内完成

**示例代码**：
```python
# 系统自动创建的审批流程
approvals = [
    {
        "approval_level": 1,
        "approval_role": "sales_manager",
        "approval_status": "pending"
    }
]
```

---

### 场景2：中额合同（10-50万元）

**示例**：合同金额 300,000元

```
步骤1：创建合同
   ↓
步骤2：提交审批
   ↓
步骤3：销售总监审批
   ├─ 通过 → 合同状态：已审批 ✅
   └─ 驳回 → 合同状态：草稿 ❌
```

**审批周期**：通常2个工作日内完成

**示例代码**：
```python
approvals = [
    {
        "approval_level": 1,
        "approval_role": "sales_director",
        "approval_status": "pending"
    }
]
```

---

### 场景3：大额合同（> 50万元）

**示例**：合同金额 800,000元

```
步骤1：创建合同
   ↓
步骤2：提交审批
   ↓
步骤3：销售总监审批（第1级）
   ├─ 通过 → 继续
   └─ 驳回 → 草稿 ❌
   ↓
步骤4：财务总监审批（第2级）
   ├─ 通过 → 继续
   └─ 驳回 → 草稿 ❌
   ↓
步骤5：总经理审批（第3级）
   ├─ 通过 → 已审批 ✅
   └─ 驳回 → 草稿 ❌
```

**审批周期**：通常5个工作日内完成

**示例代码**：
```python
approvals = [
    {
        "approval_level": 1,
        "approval_role": "sales_director",
        "approval_status": "pending"
    },
    {
        "approval_level": 2,
        "approval_role": "finance_director",
        "approval_status": "pending"
    },
    {
        "approval_level": 3,
        "approval_role": "general_manager",
        "approval_status": "pending"
    }
]
```

---

## 👥 审批人分配机制

### 1. 角色映射

系统管理员需配置角色与用户的映射关系：

```yaml
sales_manager:
  - user_id: 10
    name: "张经理"
    department: "华东销售部"
  - user_id: 11
    name: "李经理"
    department: "华南销售部"

sales_director:
  - user_id: 20
    name: "王总监"

finance_director:
  - user_id: 30
    name: "赵总监"

general_manager:
  - user_id: 1
    name: "总经理"
```

### 2. 自动分配策略

**策略A：固定分配**
- 每个角色固定1-2人
- 适用：组织架构稳定

**策略B：部门分配**
- 根据销售人员所属部门分配对应审批人
- 适用：多部门独立运作

**策略C：负载均衡**
- 根据待审批数量自动分配
- 适用：审批量大、多审批人

---

## ⏰ 审批时效管理

### 1. SLA（服务水平协议）

| 审批层级 | 标准时效 | 超时提醒 | 升级机制 |
|---------|---------|---------|---------|
| 第1级 | 1个工作日 | 超8小时提醒 | 超24小时升级 |
| 第2级 | 2个工作日 | 超1天提醒 | 超3天升级 |
| 第3级 | 2个工作日 | 超1天提醒 | 超3天升级 |

### 2. 超时处理机制

**提醒机制**：
```
第1次提醒（8小时后）
 → 邮件 + 站内消息

第2次提醒（1天后）
 → 邮件 + 短信 + 站内消息

升级处理（超SLA）
 → 通知上级审批人
 → 自动转交或代审批（可配置）
```

### 3. 紧急审批通道

特殊情况可申请加急：
- 标记为"紧急合同"
- SLA缩短50%
- 多渠道通知审批人

---

## 📊 审批流程监控

### 1. 实时监控指标

**合同维度**：
- 审批中合同数量
- 平均审批时长
- 超时合同数量
- 驳回率

**审批人维度**：
- 待审批数量
- 审批及时率
- 通过率/驳回率
- 平均审批耗时

### 2. 审批报表

**日报**：
- 当日提交合同数
- 当日完成审批数
- 当日驳回数

**周报**：
- 本周审批完成情况
- 超时合同列表
- 审批效率分析

**月报**：
- 审批流程优化建议
- 审批规则调整建议

---

## ⚙️ 审批规则配置方法

### 1. 修改金额阈值

在 `app/services/sales/contract_enhanced.py` 中修改：

```python
def _create_approval_flow(db: Session, contract_id: int, amount: Decimal):
    """创建审批流程（根据金额分级）"""
    approvals = []
    
    # 修改这里的金额阈值
    if amount < 100000:  # 10万以下
        approvals.append(...)
    elif amount < 500000:  # 10-50万
        approvals.append(...)
    else:  # 50万以上
        approvals.extend(...)
```

### 2. 新增审批角色

**步骤**：
1. 在数据库中添加角色定义
2. 配置角色-用户映射
3. 修改审批流程生成逻辑
4. 更新前端审批页面

### 3. 自定义审批规则

可根据其他条件定制审批流程：

**按客户级别**：
```python
if customer.level == "VIP":
    # VIP客户简化流程
    approvals = [sales_director_approval]
else:
    # 普通客户正常流程
    approvals = standard_flow
```

**按合同类型**：
```python
if contract_type == "framework":  # 框架协议
    # 需要法务审批
    approvals.append(legal_approval)
```

**按区域**：
```python
if region == "overseas":  # 海外合同
    # 需要国际业务部审批
    approvals.append(intl_business_approval)
```

---

## ✅ 最佳实践

### 1. 合同准备清单

提交审批前，确认：
- ☑️ 合同信息完整
- ☑️ 金额准确无误
- ☑️ 条款已添加
- ☑️ 附件已上传（报价单、技术方案）
- ☑️ 客户资料齐全

### 2. 审批意见规范

**通过意见示例**：
```
✅ 同意签署
✅ 客户信用良好，价格合理，同意
✅ 财务条款无风险，同意
```

**驳回意见示例**：
```
❌ 价格低于成本，请重新核算
❌ 付款条件风险较大，建议调整为30-40-30
❌ 缺少技术方案附件，请补充后重新提交
```

### 3. 加快审批速度的技巧

- 📧 提交后主动通知审批人
- 📞 重要合同提前沟通
- 📋 准备充分的支撑材料
- ⏰ 避开审批人休假时间
- 🔔 设置提醒避免遗忘

---

## 🔧 故障排查

### 问题1：审批人收不到通知

**原因**：
- 邮箱/手机号配置错误
- 通知服务故障
- 角色映射未配置

**解决**：
1. 检查用户资料
2. 测试通知服务
3. 配置角色-用户映射

### 问题2：审批后状态未更新

**原因**：
- 数据库事务未提交
- 前端缓存未刷新

**解决**：
1. 检查服务日志
2. 刷新页面
3. 联系技术支持

### 问题3：审批流程卡住

**原因**：
- 审批人离职/休假
- 角色无人分配

**解决**：
1. 手动转交给其他审批人
2. 申请管理员代审批
3. 配置自动转交规则

---

## 📞 联系我们

**技术支持**：
- 📧 tech@company.com
- 📱 400-XXX-XXXX

**审批规则调整**：
请联系系统管理员或提交工单

---

**版本**: v1.0  
**更新时间**: 2026-02-15  
**维护部门**: IT部门

# 研发项目管理模块权限说明

> 更新日期：2026-01-08

## 一、权限概述

研发项目管理模块涉及**财务合规**（IPO合规、高新技术企业认定、研发费用加计扣除）和**敏感成本信息**，需要严格的权限控制。

## 二、有权限访问的角色

### 2.1 财务相关角色（核心权限）
- **财务经理** (`finance_manager`)
- **财务人员** (`finance`)
- **财务** (`财务`)

**权限说明**：研发费用管理、加计扣除、IPO合规报表等财务相关功能的核心使用者。

### 2.2 研发相关角色
- **研发经理** (`rd_manager`)
- **研发工程师** (`rd_engineer`)
- **工程师** (`engineer`, `工程师`)

**权限说明**：研发项目的执行者，需要记录工作日志、上传文档、查看项目进度。

### 2.3 项目管理相关角色
- **项目经理** (`pm`, `project_manager`, `项目经理`)

**权限说明**：负责研发项目的立项、审批、结项等全流程管理。

### 2.4 管理层角色
- **总经理** (`gm`, `总经理`)
- **董事长** (`chairman`, `董事长`)
- **系统管理员** (`admin`, `super_admin`)

**权限说明**：全局查看权限，用于决策和监管。

### 2.5 其他相关角色
- **PMC计划员** (`pmc`)
  - 需要了解研发费用以进行成本核算和计划管理
- **质量工程师** (`qa`, `quality`, `质量`)
  - 可能参与研发项目的验收和质量审核

## 三、权限范围

### 3.1 功能权限

| 功能 | 查看 | 创建 | 修改 | 删除 | 审批 |
|------|:----:|:----:|:----:|:----:|:----:|
| 研发项目列表 | ✅ | ✅ | ✅ | ❌ | ✅ |
| 研发项目详情 | ✅ | - | ✅ | ❌ | ✅ |
| 研发费用录入 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 研发费用汇总 | ✅ | - | - | - | - |
| 研发费用报表 | ✅ | ✅ | - | - | - |
| 工作日志 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 文档管理 | ✅ | ✅ | ✅ | ✅ | ✅ |

**说明**：
- ✅ 表示有权限
- ❌ 表示无权限
- `-` 表示不适用

### 3.2 数据权限

研发项目数据权限遵循以下规则：

1. **项目负责人**：可以查看和管理自己负责的研发项目
2. **财务人员**：可以查看所有研发项目的费用信息（用于合规和报表）
3. **研发人员**：可以查看自己参与的研发项目
4. **管理层**：可以查看所有研发项目（数据权限：ALL）

## 四、权限实现

### 4.1 后端权限检查

**文件**: `app/core/security.py`

```python
def has_rd_project_access(user: User) -> bool:
    """检查用户是否有研发项目管理模块的访问权限"""
    # 实现逻辑...
```

**使用方式**:

```python
from app.core import security

@router.get("/rd-projects")
def list_rd_projects(
    current_user: User = Depends(security.require_rd_project_access),
    db: Session = Depends(deps.get_db),
):
    # API实现...
```

### 4.2 前端权限检查

**建议实现**：

1. **路由保护**：在路由配置中添加权限检查
2. **菜单过滤**：无权限用户不显示研发项目相关菜单
3. **按钮控制**：根据权限显示/隐藏操作按钮

## 五、特殊说明

### 5.1 超级管理员
- `is_superuser=True` 的用户自动拥有所有权限，无需角色检查

### 5.2 数据权限优先级
- 用户有多个角色时，取最宽松的权限范围
- 例如：用户同时是"财务经理"和"研发工程师"，则拥有财务和研发的双重权限

### 5.3 敏感操作
以下操作需要额外权限检查：
- **研发费用审批**：需要财务经理或管理层权限
- **项目结项**：需要项目经理或管理层权限
- **费用分摊规则配置**：需要财务经理权限

## 六、权限配置建议

### 6.1 角色分配建议

| 岗位 | 建议角色 | 权限范围 |
|------|---------|---------|
| 财务经理 | 财务经理 | 全部研发项目（ALL） |
| 财务人员 | 财务人员 | 全部研发项目（ALL） |
| 研发经理 | 研发经理 | 负责的研发项目（PROJECT） |
| 研发工程师 | 研发工程师 | 参与的研发项目（PROJECT） |
| 项目经理 | 项目经理 | 负责的研发项目（PROJECT） |

### 6.2 权限编码建议

建议在权限表中添加以下权限编码：

```sql
-- 研发项目权限
('rd:project:read', '研发项目查看', 'rd', 'read'),
('rd:project:manage', '研发项目管理', 'rd', 'manage'),
('rd:cost:read', '研发费用查看', 'rd', 'read'),
('rd:cost:manage', '研发费用管理', 'rd', 'manage'),
('rd:cost:approve', '研发费用审批', 'rd', 'approve'),
('rd:report:read', '研发报表查看', 'rd', 'read'),
('rd:report:export', '研发报表导出', 'rd', 'export'),
```

## 七、常见问题

### Q1: 普通员工能否查看研发项目？
**A**: 不能。研发项目涉及财务合规和敏感成本信息，只有财务、研发、项目管理、管理层等特定角色可以访问。

### Q2: 研发工程师能否审批费用？
**A**: 不能。费用审批需要财务经理或管理层权限。研发工程师只能录入和查看费用。

### Q3: 如何添加新的角色到研发项目权限？
**A**: 修改 `app/core/security.py` 中的 `has_rd_project_access()` 函数，在 `rd_project_roles` 列表中添加新的角色代码。

## 八、更新记录

- **2026-01-08**: 初始版本，定义研发项目权限体系





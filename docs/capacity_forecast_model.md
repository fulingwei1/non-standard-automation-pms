# 产能预测模型文档

## 1. 模型概述

产能预测模型基于历史生产数据,运用统计学方法预测未来产能趋势,帮助企业进行生产计划和资源配置。

### 1.1 预测目标

- 设备产能预测(日产量、OEE)
- 工人效率预测
- 产能缺口识别
- 资源需求预测

### 1.2 模型特点

- **简单有效**: 基于线性回归,易于理解和解释
- **季节性调整**: 考虑周期性波动(周末效应、月度波动)
- **置信区间**: 提供预测区间,量化不确定性
- **实时更新**: 随着新数据不断优化模型

## 2. 预测方法

### 2.1 线性回归模型

**基本假设**: 产能随时间呈线性趋势变化

```
y = mx + b

其中:
y: 预测值(产量、OEE等)
m: 斜率(趋势)
x: 时间(天数)
b: 截距
```

### 2.2 参数估计

**最小二乘法**:

```python
# 1. 计算均值
x̄ = Σx / n
ȳ = Σy / n

# 2. 计算斜率
m = Σ[(x - x̄)(y - ȳ)] / Σ[(x - x̄)²]

# 3. 计算截距
b = ȳ - m × x̄
```

**示例计算**:

```
历史数据(最近5天产量):
Day 1: 100件
Day 2: 105件
Day 3: 110件
Day 4: 115件
Day 5: 120件

计算:
x̄ = (1+2+3+4+5)/5 = 3
ȳ = (100+105+110+115+120)/5 = 110

m = [(1-3)(100-110) + (2-3)(105-110) + ... + (5-3)(120-110)] / 
    [(1-3)² + (2-3)² + ... + (5-3)²]
  = [20 + 5 + 0 + 5 + 20] / [4 + 1 + 0 + 1 + 4]
  = 50 / 10
  = 5

b = 110 - 5×3 = 95

趋势方程: y = 5x + 95

预测第6天: y = 5×6 + 95 = 125件
预测第7天: y = 5×7 + 95 = 130件
```

## 3. 季节性调整

### 3.1 周期性模式

生产数据通常存在周期性波动:

- **周循环**: 周一-周五高,周末低
- **月循环**: 月初/月末可能不同
- **季节循环**: 旺季/淡季差异

### 3.2 季节性因子计算

**方法**: 移动平均法

```python
# 1. 按周期分组(以7天为例)
weekly_pattern = [0] * 7  # 星期一到星期日

# 2. 计算每天的平均值
for each_record in historical_data:
    day_of_week = record.date.weekday()  # 0=周一, 6=周日
    weekly_pattern[day_of_week] += record.value
    
# 3. 归一化
weekly_avg = sum(weekly_pattern) / 7
seasonal_factors = [value / weekly_avg for value in weekly_pattern]

# 4. 应用到预测
forecast_value = trend_value × seasonal_factor[day_of_week]
```

**示例**:

```
历史数据分析:
周一平均: 120件, 因子: 1.09
周二平均: 115件, 因子: 1.05
周三平均: 110件, 因子: 1.00
周四平均: 105件, 因子: 0.95
周五平均: 100件, 因子: 0.91
周六平均:  80件, 因子: 0.73
周日平均:  80件, 因子: 0.73

预测下周一(趋势值110):
调整后预测 = 110 × 1.09 = 120件
```

## 4. 置信区间

### 4.1 标准差计算

```python
# 1. 计算残差
residuals = [actual_value - predicted_value for each_point]

# 2. 计算方差
variance = Σ(residuals²) / n

# 3. 计算标准差
std_dev = √variance
```

### 4.2 置信区间

**95%置信区间**:

```
下限 = 预测值 - 1.96 × 标准差
上限 = 预测值 + 1.96 × 标准差
```

**示例**:

```
预测值: 125件
标准差: 5件

95%置信区间:
下限 = 125 - 1.96×5 = 115.2件
上限 = 125 + 1.96×5 = 134.8件

解读: 有95%的把握,实际产量在115-135件之间
```

## 5. 模型评估

### 5.1 拟合优度 (R²)

**定义**: 模型解释数据变异的比例

```python
# 总平方和
SS_tot = Σ(y - ȳ)²

# 残差平方和
SS_res = Σ(y - ŷ)²

# R²
R² = 1 - (SS_res / SS_tot)
```

**评价标准**:
- R² > 0.9: 拟合优秀
- R² = 0.7-0.9: 拟合良好
- R² = 0.5-0.7: 拟合一般
- R² < 0.5: 拟合较差,需改进

### 5.2 平均绝对误差 (MAE)

```python
MAE = Σ|actual - predicted| / n
```

### 5.3 均方根误差 (RMSE)

```python
RMSE = √[Σ(actual - predicted)² / n]
```

## 6. 预测流程

### 6.1 数据准备

```
1. 数据清洗
   - 删除异常值
   - 处理缺失值
   - 平滑处理

2. 数据聚合
   - 按日/周/月聚合
   - 计算移动平均

3. 特征工程
   - 提取时间特征
   - 计算衍生指标
```

### 6.2 模型训练

```
1. 划分数据
   - 训练集: 前80%数据
   - 验证集: 后20%数据

2. 参数估计
   - 计算斜率和截距
   - 计算季节性因子

3. 模型验证
   - 计算R²
   - 检查残差分布
```

### 6.3 预测生成

```
1. 生成预测值
   for each day in forecast_period:
       trend = slope × day + intercept
       seasonal = seasonal_factor[weekday]
       forecast = trend × seasonal

2. 计算置信区间
   confidence = forecast ± 1.96 × std_dev

3. 输出结果
   - 预测值
   - 置信区间
   - 趋势方向
```

## 7. 模型应用

### 7.1 短期预测(1-7天)

**适用场景**: 日常生产计划

**特点**:
- 准确度高
- 受突发因素影响小
- 主要依赖趋势

### 7.2 中期预测(1-4周)

**适用场景**: 周/月度计划

**特点**:
- 考虑季节性
- 准确度中等
- 需要置信区间

### 7.3 长期预测(1-3月)

**适用场景**: 产能规划、资源配置

**特点**:
- 不确定性大
- 需要人工干预
- 仅供参考

## 8. 影响因素分析

### 8.1 内部因素

- 设备状态
- 人员技能
- 物料供应
- 工艺改进

### 8.2 外部因素

- 订单波动
- 市场需求
- 节假日
- 天气影响

### 8.3 因素权重

不同因素对预测的影响权重:

```
设备OEE: 40%
人员效率: 30%
订单量: 20%
其他: 10%
```

## 9. 预测优化

### 9.1 模型更新策略

```
1. 滚动更新
   - 每日更新历史数据
   - 重新计算参数

2. 加权平均
   - 近期数据权重大
   - 远期数据权重小

3. 异常处理
   - 识别异常点
   - 自动剔除或调整
```

### 9.2 多模型融合

```
综合预测 = w1×线性回归 + w2×移动平均 + w3×指数平滑

其中 w1 + w2 + w3 = 1
```

### 9.3 人工干预

允许用户:
- 调整趋势系数
- 添加已知事件影响
- 设置产能上下限

## 10. API使用示例

### 10.1 设备产能预测

```bash
GET /production/capacity/forecast?type=equipment&equipment_id=1&history_days=90&forecast_days=30
```

**响应**:

```json
{
  "code": 200,
  "data": {
    "historical_summary": {
      "avg_daily_output": 110,
      "trend": "上升"
    },
    "forecast": {
      "forecast_days": 30,
      "forecast_values": [
        {
          "date": "2026-02-16",
          "forecast_value": 125.5,
          "lower_bound": 115.2,
          "upper_bound": 135.8,
          "confidence": "95%"
        }
      ],
      "summary": {
        "total_forecast": 3765,
        "avg_daily_forecast": 125.5
      },
      "model_info": {
        "method": "线性回归 + 季节性调整",
        "r_squared": 0.85,
        "std_dev": 5.2
      }
    }
  }
}
```

### 10.2 工人效率预测

```bash
GET /production/capacity/forecast?type=worker&worker_id=1&history_days=60&forecast_days=14
```

## 11. 预测准确性提升建议

### 11.1 数据质量

- 及时录入数据
- 准确分类停机原因
- 完整记录产量

### 11.2 数据量要求

- 最少: 7天数据
- 推荐: 30天以上
- 最佳: 90天以上

### 11.3 模型维护

- 定期评估准确性
- 对比实际值
- 持续优化参数

## 12. 局限性说明

### 12.1 适用场景

✅ 适用:
- 稳定生产
- 历史数据充足
- 趋势明显

❌ 不适用:
- 新产品试产
- 大规模改造
- 突发事件

### 12.2 预测范围

- 短期(1周内): 准确度高
- 中期(1月内): 准确度中
- 长期(3月内): 仅供参考

## 13. 未来改进方向

- 引入机器学习算法(ARIMA、LSTM)
- 多变量预测模型
- 实时在线学习
- 集成外部数据源

# é¡¹ç›®æˆæœ¬é¢„æµ‹å’Œè¶‹åŠ¿åˆ†ææ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [é¢„æµ‹åŸç†](#é¢„æµ‹åŸç†)
3. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
4. [APIæ–‡æ¡£](#apiæ–‡æ¡£)
5. [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## åŠŸèƒ½æ¦‚è¿°

é¡¹ç›®æˆæœ¬é¢„æµ‹å’Œè¶‹åŠ¿åˆ†ææ¨¡å—ä¸ºé¡¹ç›®ç®¡ç†è€…æä¾›ç§‘å­¦çš„æˆæœ¬é¢„æµ‹å’Œé¢„è­¦èƒ½åŠ›ï¼Œå¸®åŠ©æå‰è¯†åˆ«æˆæœ¬é£é™©ï¼Œä¼˜åŒ–é¢„ç®—ç®¡ç†ã€‚

### æ ¸å¿ƒåŠŸèƒ½

#### 1. æˆæœ¬é¢„æµ‹
- **3ç§é¢„æµ‹æ–¹æ³•**ï¼šçº¿æ€§å›å½’ã€æŒ‡æ•°é¢„æµ‹ã€å†å²å¹³å‡
- **å®Œå·¥æˆæœ¬é¢„æµ‹**ï¼šåŸºäºå½“å‰è¶‹åŠ¿é¢„æµ‹æœ€ç»ˆå®Œå·¥æˆæœ¬
- **æœˆåº¦é¢„æµ‹**ï¼šæä¾›æœªæ¥æ¯æœˆçš„æˆæœ¬é¢„æµ‹æ•°æ®

#### 2. æˆæœ¬è¶‹åŠ¿åˆ†æ
- **æœˆåº¦æˆæœ¬è¶‹åŠ¿**ï¼šåˆ†ææ¯æœˆæˆæœ¬å˜åŒ–
- **ç´¯è®¡æˆæœ¬è¶‹åŠ¿**ï¼šå±•ç¤ºæˆæœ¬ç´¯è®¡æ›²çº¿
- **æˆæœ¬ç»Ÿè®¡æ±‡æ€»**ï¼šæ€»æˆæœ¬ã€æœˆå‡æˆæœ¬ã€æœ€å¤§/æœ€å°æœˆæˆæœ¬

#### 3. æˆæœ¬ç‡ƒå°½å›¾
- **ç†æƒ³ç‡ƒå°½çº¿**ï¼šåŸºäºé¢„ç®—å’Œè®¡åˆ’æ—¶é—´çš„å‡åŒ€æ¶ˆè€—
- **å®é™…ç‡ƒå°½çº¿**ï¼šå®é™…æˆæœ¬æ¶ˆè€—æƒ…å†µ
- **è¿›åº¦å¯¹æ¯”**ï¼šåˆ¤æ–­é¡¹ç›®æ˜¯å¦æŒ‰è®¡åˆ’è¿›è¡Œ

#### 4. æˆæœ¬é¢„è­¦
- **è¶…æ”¯é¢„è­¦**ï¼šå®é™…æˆæœ¬è¶…è¿‡é¢„ç®—é˜ˆå€¼æ—¶è§¦å‘
- **è¿›åº¦é¢„è­¦**ï¼šæˆæœ¬æ¶ˆè€—ä¸å®Œæˆåº¦ä¸åŒ¹é…æ—¶è§¦å‘
- **è¶‹åŠ¿é¢„è­¦**ï¼šæˆæœ¬å¢é•¿ç‡å¼‚å¸¸æ—¶è§¦å‘

---

## é¢„æµ‹åŸç†

### 1. çº¿æ€§å›å½’é¢„æµ‹ï¼ˆLINEARï¼‰

#### åŸç†
ä½¿ç”¨æœ€å°äºŒä¹˜æ³•å¯¹å†å²æˆæœ¬æ•°æ®è¿›è¡Œçº¿æ€§æ‹Ÿåˆï¼Œå¾—åˆ°æˆæœ¬å¢é•¿è¶‹åŠ¿çº¿ã€‚

**æ•°å­¦æ¨¡å‹**ï¼š
```
y = mx + b
```
å…¶ä¸­ï¼š
- `y` = ç´¯è®¡æˆæœ¬
- `x` = æ—¶é—´ï¼ˆæœˆæ•°ï¼‰
- `m` = æ–œç‡ï¼ˆæœˆåº¦æˆæœ¬å¢é•¿ç‡ï¼‰
- `b` = æˆªè·

#### é¢„æµ‹å…¬å¼
```
é¢„æµ‹å®Œå·¥æˆæœ¬ = æ–œç‡ Ã— é¢„è®¡æ€»æœˆæ•° + æˆªè·
```

#### é€‚ç”¨åœºæ™¯
- æˆæœ¬å‘ˆç¨³å®šçº¿æ€§å¢é•¿çš„é¡¹ç›®
- å†å²æ•°æ®è¾ƒä¸ºè§„å¾‹
- çŸ­æœŸé¢„æµ‹ï¼ˆ3-6ä¸ªæœˆï¼‰

#### ç¤ºä¾‹
```python
# å†å²æ•°æ®ï¼š
# ç¬¬1æœˆï¼š80,000å…ƒï¼ˆç´¯è®¡ï¼‰
# ç¬¬2æœˆï¼š160,000å…ƒï¼ˆç´¯è®¡ï¼‰
# ç¬¬3æœˆï¼š240,000å…ƒï¼ˆç´¯è®¡ï¼‰

# çº¿æ€§æ‹Ÿåˆç»“æœï¼š
# æ–œç‡ m = 80,000ï¼ˆæ¯æœˆå¢é•¿ï¼‰
# æˆªè· b = 0

# é¢„æµ‹ï¼š
# å‡è®¾é¡¹ç›®è®¡åˆ’12ä¸ªæœˆ
# é¢„æµ‹å®Œå·¥æˆæœ¬ = 80,000 Ã— 12 + 0 = 960,000å…ƒ
```

#### è¯„ä¼°æŒ‡æ ‡
- **RÂ²ï¼ˆå†³å®šç³»æ•°ï¼‰**ï¼šè¡¡é‡æ‹Ÿåˆä¼˜åº¦ï¼ŒèŒƒå›´ [0, 1]ï¼Œè¶Šæ¥è¿‘1è¡¨ç¤ºæ‹Ÿåˆè¶Šå¥½
- **æœˆåº¦ç‡ƒçƒ§ç‡**ï¼šæ–œç‡å€¼ï¼Œè¡¨ç¤ºæ¯æœˆå¹³å‡æˆæœ¬

---

### 2. æŒ‡æ•°é¢„æµ‹ï¼ˆEXPONENTIALï¼‰

#### åŸç†
é€‚ç”¨äºæˆæœ¬å‘ˆæŒ‡æ•°å¢é•¿çš„é¡¹ç›®ï¼ŒåŸºäºå†å²å¢é•¿ç‡é¢„æµ‹æœªæ¥æˆæœ¬ã€‚

**æ•°å­¦æ¨¡å‹**ï¼š
```
Future_Cost = Current_Cost Ã— (1 + growth_rate)^periods
```

å…¶ä¸­ï¼š
- `growth_rate` = å¹³å‡æœˆåº¦å¢é•¿ç‡
- `periods` = å‰©ä½™é¢„æµ‹æœŸæ•°

#### è®¡ç®—æ­¥éª¤
1. è®¡ç®—æ¯æœˆå¢é•¿ç‡ï¼š`(æœ¬æœˆæˆæœ¬ - ä¸Šæœˆæˆæœ¬) / ä¸Šæœˆæˆæœ¬`
2. è®¡ç®—å¹³å‡å¢é•¿ç‡
3. æ ¹æ®å‰©ä½™è¿›åº¦ä¼°ç®—å‰©ä½™æœŸæ•°
4. ä½¿ç”¨æŒ‡æ•°å…¬å¼é¢„æµ‹å®Œå·¥æˆæœ¬

#### é€‚ç”¨åœºæ™¯
- é¡¹ç›®åˆæœŸæˆæœ¬å¢é•¿ç¼“æ…¢ï¼ŒåæœŸåŠ é€Ÿ
- ç ”å‘é¡¹ç›®ã€åˆ›æ–°é¡¹ç›®
- æˆæœ¬å‘ˆåŠ é€Ÿå¢é•¿è¶‹åŠ¿

#### ç¤ºä¾‹
```python
# å†å²æ•°æ®ï¼š
# ç¬¬1æœˆï¼š50,000å…ƒï¼ˆç´¯è®¡ï¼‰
# ç¬¬2æœˆï¼š110,000å…ƒï¼ˆç´¯è®¡ï¼Œå¢é•¿ç‡ 120%ï¼‰
# ç¬¬3æœˆï¼š200,000å…ƒï¼ˆç´¯è®¡ï¼Œå¢é•¿ç‡ 82%ï¼‰

# å¹³å‡å¢é•¿ç‡ = (1.2 + 0.82) / 2 = 1.01 (101%)

# é¢„æµ‹ï¼š
# å½“å‰è¿›åº¦50%ï¼Œå‰©ä½™æœŸæ•° = 3æœŸ
# é¢„æµ‹å®Œå·¥æˆæœ¬ = 200,000 Ã— (1 + 1.01)^3 â‰ˆ 1,624,080å…ƒ
```

---

### 3. å†å²å¹³å‡æ³•ï¼ˆHISTORICAL_AVERAGEï¼‰

#### åŸç†
åŸºäºå†å²æœˆå‡æˆæœ¬ï¼Œå‡è®¾æœªæ¥æˆæœ¬ä¿æŒç›¸åŒé€Ÿç‡ã€‚

**æ•°å­¦æ¨¡å‹**ï¼š
```
é¢„æµ‹å®Œå·¥æˆæœ¬ = æœˆå‡æˆæœ¬ Ã— é¢„è®¡æ€»æœˆæ•°
```

#### è®¡ç®—æ­¥éª¤
1. è®¡ç®—å†å²æœˆå‡æˆæœ¬ï¼š`æ€»æˆæœ¬ / å·²è¿‡æœˆæ•°`
2. ä¼°ç®—é¡¹ç›®æ€»æœˆæ•°ï¼ˆåŸºäºå½“å‰è¿›åº¦ï¼‰
3. é¢„æµ‹å®Œå·¥æˆæœ¬

#### é€‚ç”¨åœºæ™¯
- æˆæœ¬æ³¢åŠ¨è¾ƒå°çš„é¡¹ç›®
- ç¨³å®šçš„ç”Ÿäº§å‹é¡¹ç›®
- æ•°æ®ä¸è¶³æ—¶çš„å¿«é€Ÿä¼°ç®—

#### ç¤ºä¾‹
```python
# å†å²æ•°æ®ï¼ˆ6ä¸ªæœˆï¼‰ï¼š
# æ€»æˆæœ¬ï¼š480,000å…ƒ
# æœˆå‡æˆæœ¬ = 480,000 / 6 = 80,000å…ƒ/æœˆ

# é¢„æµ‹ï¼š
# å½“å‰è¿›åº¦50%ï¼Œé¢„è®¡æ€»æœˆæ•° = 6 / 0.5 = 12æœˆ
# é¢„æµ‹å®Œå·¥æˆæœ¬ = 80,000 Ã— 12 = 960,000å…ƒ
```

---

### 4. é¢„è­¦æ£€æµ‹ç®—æ³•

#### è¶…æ”¯é¢„è­¦ï¼ˆOVERSPENDï¼‰

**æ£€æµ‹é€»è¾‘**ï¼š
```python
æˆæœ¬æ¶ˆè€—ç‡ = (å®é™…æˆæœ¬ / é¢„ç®—) Ã— 100%

if æˆæœ¬æ¶ˆè€—ç‡ >= 100%:
    é¢„è­¦çº§åˆ« = "CRITICAL"  # ä¸¥é‡
elif æˆæœ¬æ¶ˆè€—ç‡ >= 80%:
    é¢„è­¦çº§åˆ« = "WARNING"   # è­¦å‘Š
else:
    æ— é¢„è­¦
```

**é»˜è®¤é˜ˆå€¼**ï¼š
- è­¦å‘Šé˜ˆå€¼ï¼š80%
- ä¸¥é‡é˜ˆå€¼ï¼š100%

#### è¿›åº¦ä¸åŒ¹é…é¢„è­¦ï¼ˆPROGRESS_MISMATCHï¼‰

**æ£€æµ‹é€»è¾‘**ï¼š
```python
æˆæœ¬æ¶ˆè€—ç‡ = (å®é™…æˆæœ¬ / é¢„ç®—) Ã— 100%
å®Œæˆè¿›åº¦ = é¡¹ç›®è¿›åº¦ç™¾åˆ†æ¯”
åå·® = æˆæœ¬æ¶ˆè€—ç‡ - å®Œæˆè¿›åº¦

if abs(åå·®) >= 15%:
    é¢„è­¦
```

**è§£é‡Š**ï¼š
- åå·®ä¸ºæ­£ï¼šæˆæœ¬æ¶ˆè€—è¶…å‰ï¼ˆèŠ±é’±å¤šï¼Œè¿›åº¦æ…¢ï¼‰
- åå·®ä¸ºè´Ÿï¼šè¿›åº¦è¶…å‰æˆæœ¬ï¼ˆè¿›åº¦å¿«ï¼ŒèŠ±é’±å°‘ï¼‰

**é»˜è®¤é˜ˆå€¼**ï¼š15%

#### è¶‹åŠ¿å¼‚å¸¸é¢„è­¦ï¼ˆTREND_ANOMALYï¼‰

**æ£€æµ‹é€»è¾‘**ï¼š
```python
# è®¡ç®—æœ€è¿‘3ä¸ªæœˆçš„æœˆåº¦å¢é•¿ç‡
growth_rates = []
for i in range(1, 4):
    rate = (æœ¬æœˆæˆæœ¬ - ä¸Šæœˆæˆæœ¬) / ä¸Šæœˆæˆæœ¬
    growth_rates.append(rate)

avg_growth_rate = sum(growth_rates) / len(growth_rates)

if avg_growth_rate >= 30%:
    é¢„è­¦
```

**é»˜è®¤é˜ˆå€¼**ï¼š30%

---

## ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

#### 1. æ‰§è¡Œæˆæœ¬é¢„æµ‹

**æ–¹æ³•Aï¼šé€šè¿‡API**
```bash
# çº¿æ€§é¢„æµ‹
curl -X GET "http://localhost:8000/api/v1/projects/1/costs/forecast?method=LINEAR" \
  -H "Authorization: Bearer YOUR_TOKEN"

# æŒ‡æ•°é¢„æµ‹
curl -X GET "http://localhost:8000/api/v1/projects/1/costs/forecast?method=EXPONENTIAL" \
  -H "Authorization: Bearer YOUR_TOKEN"

# å†å²å¹³å‡é¢„æµ‹
curl -X GET "http://localhost:8000/api/v1/projects/1/costs/forecast?method=HISTORICAL_AVERAGE" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**æ–¹æ³•Bï¼šé€šè¿‡Python SDK**
```python
from app.services.cost_forecast_service import CostForecastService

service = CostForecastService(db)
result = service.linear_forecast(project_id=1)

print(f"é¢„æµ‹å®Œå·¥æˆæœ¬: {result['forecasted_completion_cost']}å…ƒ")
print(f"æ˜¯å¦è¶…é¢„ç®—: {result['is_over_budget']}")
```

#### 2. æŸ¥çœ‹æˆæœ¬è¶‹åŠ¿

```bash
curl -X GET "http://localhost:8000/api/v1/projects/1/costs/trend" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "monthly_trend": [
    {"month": "2025-01", "cost": 80000},
    {"month": "2025-02", "cost": 90000}
  ],
  "cumulative_trend": [
    {"month": "2025-01", "cumulative_cost": 80000},
    {"month": "2025-02", "cumulative_cost": 170000}
  ]
}
```

#### 3. æŸ¥çœ‹ç‡ƒå°½å›¾

```bash
curl -X GET "http://localhost:8000/api/v1/projects/1/costs/burn-down" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 4. æ£€æŸ¥é¢„è­¦

```bash
curl -X GET "http://localhost:8000/api/v1/projects/1/costs/alerts" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 5. å¯¹æ¯”å¤šç§é¢„æµ‹æ–¹æ³•

```bash
curl -X GET "http://localhost:8000/api/v1/projects/1/costs/compare-methods" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

### é€‰æ‹©åˆé€‚çš„é¢„æµ‹æ–¹æ³•

| åœºæ™¯ | æ¨èæ–¹æ³• | ç†ç”± |
|------|---------|------|
| æˆæœ¬ç¨³å®šå¢é•¿ | çº¿æ€§å›å½’ | ç®€å•å¯é ï¼Œé€‚åˆå¤§å¤šæ•°é¡¹ç›® |
| é¡¹ç›®åˆæœŸ | å†å²å¹³å‡ | æ•°æ®ä¸è¶³æ—¶çš„å¿«é€Ÿä¼°ç®— |
| ç ”å‘é¡¹ç›® | æŒ‡æ•°é¢„æµ‹ | é€‚åº”åæœŸæˆæœ¬åŠ é€Ÿå¢é•¿ |
| ç”Ÿäº§é¡¹ç›® | å†å²å¹³å‡ | æˆæœ¬æ³¢åŠ¨å°ï¼Œæœˆåº¦ç¨³å®š |
| ä¸ç¡®å®š | å¯¹æ¯”æ–¹æ³• | åŒæ—¶ä½¿ç”¨3ç§æ–¹æ³•å¯¹æ¯” |

---

### é…ç½®é¢„è­¦è§„åˆ™

#### å…¨å±€è§„åˆ™ï¼ˆé€‚ç”¨æ‰€æœ‰é¡¹ç›®ï¼‰

```python
from app.models.project import CostAlertRule

# åˆ›å»ºå…¨å±€è¶…æ”¯é¢„è­¦è§„åˆ™
rule = CostAlertRule(
    rule_code="GLOBAL_OVERSPEND_STRICT",
    rule_name="ä¸¥æ ¼è¶…æ”¯é¢„è­¦",
    alert_type="OVERSPEND",
    rule_config={
        "warning_threshold": 70,    # 70%é¢„è­¦
        "critical_threshold": 90    # 90%ä¸¥é‡
    },
    is_enabled=True,
    priority=10
)
db.add(rule)
db.commit()
```

#### é¡¹ç›®ç‰¹å®šè§„åˆ™ï¼ˆè¦†ç›–å…¨å±€è§„åˆ™ï¼‰

```python
# ä¸ºé‡è¦é¡¹ç›®è®¾ç½®æ›´ä¸¥æ ¼çš„è§„åˆ™
rule = CostAlertRule(
    rule_code="PROJECT_001_OVERSPEND",
    rule_name="001é¡¹ç›®è¶…æ”¯é¢„è­¦",
    project_id=1,  # é¡¹ç›®ID
    alert_type="OVERSPEND",
    rule_config={
        "warning_threshold": 60,
        "critical_threshold": 80
    },
    is_enabled=True,
    priority=1  # é«˜ä¼˜å…ˆçº§
)
db.add(rule)
db.commit()
```

---

## APIæ–‡æ¡£

### 1. è·å–æˆæœ¬é¢„æµ‹

**ç«¯ç‚¹**ï¼š`GET /api/v1/projects/{project_id}/costs/forecast`

**å‚æ•°**ï¼š
- `method` (string, required): é¢„æµ‹æ–¹æ³•
  - `LINEAR`: çº¿æ€§å›å½’
  - `EXPONENTIAL`: æŒ‡æ•°é¢„æµ‹
  - `HISTORICAL_AVERAGE`: å†å²å¹³å‡
- `save_result` (boolean, optional): æ˜¯å¦ä¿å­˜é¢„æµ‹ç»“æœï¼Œé»˜è®¤ `false`

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "é¢„æµ‹æˆåŠŸ",
  "data": {
    "method": "LINEAR",
    "forecast_date": "2025-02-14",
    "forecasted_completion_cost": 950000.00,
    "current_actual_cost": 480000.00,
    "current_budget": 1000000.00,
    "current_progress_pct": 50.00,
    "data_points": 6,
    "trend_data": {
      "slope": 80000.00,
      "intercept": 0.00,
      "r_squared": 0.95,
      "monthly_burn_rate": 80000.00
    },
    "monthly_forecast_data": [
      {
        "month": "2025-01",
        "type": "actual",
        "monthly_cost": 80000.00,
        "cumulative_cost": 80000.00
      },
      {
        "month": "2025-07",
        "type": "forecast",
        "monthly_cost": 80000.00,
        "cumulative_cost": 560000.00
      }
    ],
    "is_over_budget": false,
    "budget_variance": -50000.00
  }
}
```

---

### 2. è·å–æˆæœ¬è¶‹åŠ¿

**ç«¯ç‚¹**ï¼š`GET /api/v1/projects/{project_id}/costs/trend`

**å‚æ•°**ï¼š
- `start_month` (string, optional): å¼€å§‹æœˆä»½ï¼Œæ ¼å¼ `YYYY-MM`
- `end_month` (string, optional): ç»“æŸæœˆä»½ï¼Œæ ¼å¼ `YYYY-MM`

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æˆåŠŸ",
  "data": {
    "project_id": 1,
    "project_name": "æµ‹è¯•é¡¹ç›®",
    "monthly_trend": [
      {"month": "2025-01", "cost": 80000.00},
      {"month": "2025-02", "cost": 90000.00}
    ],
    "cumulative_trend": [
      {"month": "2025-01", "cumulative_cost": 80000.00},
      {"month": "2025-02", "cumulative_cost": 170000.00}
    ],
    "summary": {
      "total_months": 6,
      "total_cost": 480000.00,
      "avg_monthly_cost": 80000.00,
      "min_monthly_cost": 70000.00,
      "max_monthly_cost": 95000.00
    }
  }
}
```

---

### 3. è·å–æˆæœ¬ç‡ƒå°½å›¾

**ç«¯ç‚¹**ï¼š`GET /api/v1/projects/{project_id}/costs/burn-down`

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æˆåŠŸ",
  "data": {
    "project_id": 1,
    "project_name": "æµ‹è¯•é¡¹ç›®",
    "budget": 1000000.00,
    "current_spent": 480000.00,
    "remaining_budget": 520000.00,
    "burn_rate": 80000.00,
    "burn_down_data": [
      {
        "month": "2025-01",
        "ideal_remaining": 920000.00,
        "actual_spent": 80000.00,
        "actual_remaining": 920000.00
      }
    ],
    "is_on_track": true
  }
}
```

---

### 4. è·å–æˆæœ¬é¢„è­¦

**ç«¯ç‚¹**ï¼š`GET /api/v1/projects/{project_id}/costs/alerts`

**å‚æ•°**ï¼š
- `auto_create` (boolean, optional): æ˜¯å¦è‡ªåŠ¨åˆ›å»ºé¢„è­¦è®°å½•ï¼Œé»˜è®¤ `true`

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æ£€æµ‹åˆ° 2 ä¸ªé¢„è­¦",
  "data": {
    "alerts": [
      {
        "alert_type": "OVERSPEND",
        "alert_level": "WARNING",
        "alert_title": "æˆæœ¬è¶…æ”¯é¢„è­¦",
        "alert_message": "é¡¹ç›®æˆæœ¬æ¥è¿‘é¢„ç®—ï¼å½“å‰æˆæœ¬850000å…ƒï¼Œå·²ä½¿ç”¨85.0%é¢„ç®—",
        "alert_data": {
          "budget": 1000000.00,
          "actual_cost": 850000.00,
          "consumption_rate": 85.00,
          "threshold": 80
        }
      }
    ],
    "total_count": 2
  }
}
```

---

### 5. å¯¹æ¯”é¢„æµ‹æ–¹æ³•

**ç«¯ç‚¹**ï¼š`GET /api/v1/projects/{project_id}/costs/compare-methods`

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "å¯¹æ¯”æˆåŠŸ",
  "data": {
    "methods": {
      "LINEAR": {...},
      "EXPONENTIAL": {...},
      "HISTORICAL_AVERAGE": {...}
    },
    "comparison": {
      "forecasted_costs": {
        "LINEAR": 950000.00,
        "EXPONENTIAL": 1020000.00,
        "HISTORICAL_AVERAGE": 960000.00
      },
      "average_forecast": 976666.67,
      "min_forecast": 950000.00,
      "max_forecast": 1020000.00,
      "forecast_range": 70000.00
    }
  }
}
```

---

### 6. è·å–é¢„æµ‹å†å²

**ç«¯ç‚¹**ï¼š`GET /api/v1/projects/{project_id}/costs/forecast-history`

**å‚æ•°**ï¼š
- `limit` (integer, optional): è¿”å›è®°å½•æ•°ï¼Œé»˜è®¤ `10`

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æˆåŠŸ",
  "data": {
    "forecasts": [
      {
        "id": 1,
        "forecast_date": "2025-02-14",
        "forecast_method": "LINEAR",
        "forecasted_completion_cost": 950000.00,
        "current_progress_pct": 50.00,
        "forecast_accuracy": null
      }
    ],
    "total_count": 5
  }
}
```

---

## æ•°æ®æ¨¡å‹

### CostForecastï¼ˆæˆæœ¬é¢„æµ‹è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | Integer | ä¸»é”® |
| project_id | Integer | é¡¹ç›®ID |
| forecast_method | String | é¢„æµ‹æ–¹æ³• |
| forecast_date | Date | é¢„æµ‹æ—¥æœŸ |
| forecasted_completion_cost | Decimal | é¢„æµ‹å®Œå·¥æˆæœ¬ |
| current_progress_pct | Decimal | å½“å‰è¿›åº¦ |
| current_actual_cost | Decimal | å½“å‰å®é™…æˆæœ¬ |
| monthly_forecast_data | JSON | æœˆåº¦é¢„æµ‹æ•°æ® |
| trend_data | JSON | è¶‹åŠ¿æ•°æ® |
| forecast_accuracy | Decimal | é¢„æµ‹å‡†ç¡®ç‡ï¼ˆäº‹åè®¡ç®—ï¼‰ |

### CostAlertï¼ˆæˆæœ¬é¢„è­¦è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | Integer | ä¸»é”® |
| project_id | Integer | é¡¹ç›®ID |
| alert_type | String | é¢„è­¦ç±»å‹ |
| alert_level | String | é¢„è­¦çº§åˆ« |
| alert_date | Date | é¢„è­¦æ—¥æœŸ |
| alert_message | Text | é¢„è­¦æ¶ˆæ¯ |
| status | String | çŠ¶æ€ |

### CostAlertRuleï¼ˆæˆæœ¬é¢„è­¦è§„åˆ™è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | Integer | ä¸»é”® |
| rule_code | String | è§„åˆ™ç¼–ç  |
| rule_name | String | è§„åˆ™åç§° |
| project_id | Integer | é¡¹ç›®IDï¼ˆNULL=å…¨å±€ï¼‰ |
| alert_type | String | é¢„è­¦ç±»å‹ |
| rule_config | JSON | è§„åˆ™é…ç½® |
| is_enabled | Boolean | æ˜¯å¦å¯ç”¨ |

---

## æœ€ä½³å®è·µ

### 1. æ•°æ®å‡†å¤‡

#### ç¡®ä¿æ•°æ®å®Œæ•´æ€§
```python
# æˆæœ¬æ•°æ®éœ€åŒ…å« cost_date æˆ– cost_month
# è‡³å°‘éœ€è¦2ä¸ªæœˆçš„æ•°æ®æ‰èƒ½è¿›è¡Œé¢„æµ‹

# âœ… æ­£ç¡®
cost = ProjectCost(
    project_id=1,
    cost_type="MATERIAL",
    amount=50000,
    cost_date=date(2025, 1, 15)  # æ˜ç¡®æ—¥æœŸ
)

# âŒ é”™è¯¯
cost = ProjectCost(
    project_id=1,
    amount=50000
    # ç¼ºå°‘ cost_date
)
```

### 2. é€‰æ‹©é¢„æµ‹æ–¹æ³•

#### æ•°æ®é©±åŠ¨å†³ç­–
```python
# 1. å¯¹æ¯”å¤šç§æ–¹æ³•
result = service.compare_forecast_methods(project_id)

# 2. æŸ¥çœ‹RÂ²å€¼ï¼ˆçº¿æ€§å›å½’ï¼‰
if result['LINEAR']['trend_data']['r_squared'] > 0.8:
    # RÂ²>0.8ï¼Œçº¿æ€§æ‹Ÿåˆè‰¯å¥½
    use_method = 'LINEAR'

# 3. æŸ¥çœ‹é¢„æµ‹èŒƒå›´
forecast_range = result['comparison']['forecast_range']
if forecast_range / result['comparison']['average_forecast'] < 0.1:
    # é¢„æµ‹å·®å¼‚<10%ï¼Œä¸‰ç§æ–¹æ³•ç»“æœæ¥è¿‘
    print("é¢„æµ‹ç»“æœè¾ƒä¸ºä¸€è‡´")
```

### 3. å®šæœŸæ›´æ–°é¢„æµ‹

```python
# å»ºè®®æ¯æœˆæ›´æ–°ä¸€æ¬¡é¢„æµ‹
from apscheduler.schedulers.background import BackgroundScheduler

scheduler = BackgroundScheduler()

def monthly_forecast():
    projects = db.query(Project).filter(Project.is_active == True).all()
    for project in projects:
        result = service.linear_forecast(project.id)
        if 'error' not in result:
            service.save_forecast(project.id, result, admin_user_id)

# æ¯æœˆ1å·æ‰§è¡Œ
scheduler.add_job(monthly_forecast, 'cron', day=1, hour=0)
scheduler.start()
```

### 4. é¢„è­¦å“åº”æµç¨‹

```python
# 1. è‡ªåŠ¨æ£€æµ‹é¢„è­¦
alerts = service.check_cost_alerts(project_id, auto_create=True)

# 2. é€šçŸ¥ç›¸å…³äººå‘˜
for alert in alerts:
    if alert['alert_level'] == 'CRITICAL':
        send_email(project_manager, alert['alert_message'])
        send_sms(project_manager, alert['alert_title'])
    elif alert['alert_level'] == 'WARNING':
        send_email(project_manager, alert['alert_message'])

# 3. è®°å½•å¤„ç†æªæ–½
db_alert = db.query(CostAlert).filter(...).first()
db_alert.acknowledged_by = current_user.id
db_alert.acknowledged_at = datetime.now()
db_alert.resolution_note = "å·²é‡‡å–æˆæœ¬æ§åˆ¶æªæ–½..."
db.commit()
```

### 5. é¢„æµ‹å‡†ç¡®ç‡è¯„ä¼°

```python
# é¡¹ç›®å®Œæˆåï¼Œå›å¡«å®é™…å®Œå·¥æˆæœ¬ï¼Œè¯„ä¼°é¢„æµ‹å‡†ç¡®ç‡
def update_forecast_accuracy(project_id):
    project = db.query(Project).filter(Project.id == project_id).first()
    actual_cost = float(project.actual_cost)
    
    forecasts = db.query(CostForecast).filter(
        CostForecast.project_id == project_id
    ).all()
    
    for forecast in forecasts:
        predicted = float(forecast.forecasted_completion_cost)
        error = actual_cost - predicted
        error_pct = abs(error / actual_cost * 100)
        accuracy = 100 - error_pct
        
        forecast.actual_completion_cost = actual_cost
        forecast.forecast_error = error
        forecast.forecast_error_pct = error_pct
        forecast.forecast_accuracy = accuracy
    
    db.commit()
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ˜¾ç¤º"å†å²æ•°æ®ä¸è¶³"ï¼Ÿ

**A**: é¢„æµ‹ç®—æ³•è‡³å°‘éœ€è¦2ä¸ªæœˆçš„æˆæœ¬æ•°æ®ã€‚è¯·ç¡®ä¿ï¼š
1. é¡¹ç›®æˆæœ¬è®°å½•åŒ…å« `cost_date` æˆ– `cost_month`
2. è‡³å°‘æœ‰2ä¸ªä¸åŒæœˆä»½çš„æ•°æ®

### Q2: å“ªç§é¢„æµ‹æ–¹æ³•æœ€å‡†ç¡®ï¼Ÿ

**A**: æ²¡æœ‰ç»å¯¹æœ€å‡†ç¡®çš„æ–¹æ³•ï¼Œå»ºè®®ï¼š
1. ä½¿ç”¨ `/compare-methods` å¯¹æ¯”3ç§æ–¹æ³•
2. æŸ¥çœ‹çº¿æ€§å›å½’çš„ RÂ² å€¼ï¼ˆ>0.8 è¡¨ç¤ºæ‹Ÿåˆè‰¯å¥½ï¼‰
3. æ ¹æ®é¡¹ç›®ç‰¹ç‚¹é€‰æ‹©æ–¹æ³•

### Q3: å¦‚ä½•å…³é—­é¢„è­¦é€šçŸ¥ï¼Ÿ

**A**: ä¿®æ”¹é¢„è­¦è§„åˆ™é…ç½®ï¼š
```python
rule = db.query(CostAlertRule).filter(...).first()
rule.notification_enabled = False
db.commit()
```

### Q4: é¢„æµ‹ç»“æœå¯ä»¥ä¿®æ”¹å—ï¼Ÿ

**A**: é¢„æµ‹ç»“æœæ˜¯åªè¯»çš„ã€‚å¦‚éœ€è°ƒæ•´ï¼Œåº”ï¼š
1. ä¿®æ­£å†å²æˆæœ¬æ•°æ®
2. é‡æ–°æ‰§è¡Œé¢„æµ‹

---

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- ğŸ“§ Email: support@example.com
- ğŸ“± ç”µè¯: 400-xxx-xxxx
- ğŸ’¬ åœ¨çº¿å®¢æœ: https://support.example.com

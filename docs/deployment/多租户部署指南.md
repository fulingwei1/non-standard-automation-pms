# å¤šç§Ÿæˆ·éƒ¨ç½²æŒ‡å— (Multi-Tenant Deployment Guide)

## ç›®å½•

- [1. ç¯å¢ƒå‡†å¤‡](#1-ç¯å¢ƒå‡†å¤‡)
- [2. æ•°æ®åº“è¿ç§»æ­¥éª¤](#2-æ•°æ®åº“è¿ç§»æ­¥éª¤)
- [3. é…ç½®æ–‡ä»¶è¯´æ˜](#3-é…ç½®æ–‡ä»¶è¯´æ˜)
- [4. å¯åŠ¨å’ŒéªŒè¯](#4-å¯åŠ¨å’ŒéªŒè¯)
- [5. å›æ»šæ–¹æ¡ˆ](#5-å›æ»šæ–¹æ¡ˆ)
- [6. æ•…éšœæ’æŸ¥](#6-æ•…éšœæ’æŸ¥)

---

## 1. ç¯å¢ƒå‡†å¤‡

### 1.1 ç³»ç»Ÿè¦æ±‚

| ç»„ä»¶ | æœ€ä½è¦æ±‚ | æ¨èé…ç½® |
|------|----------|----------|
| **æ“ä½œç³»ç»Ÿ** | Ubuntu 20.04+ / CentOS 8+ | Ubuntu 22.04 LTS |
| **Python** | 3.10+ | 3.11+ |
| **æ•°æ®åº“** | MySQL 5.7+ / PostgreSQL 12+ | MySQL 8.0 / PostgreSQL 14 |
| **å†…å­˜** | 4GB | 8GB+ |
| **CPU** | 2æ ¸ | 4æ ¸+ |
| **ç£ç›˜** | 20GB | 50GB+ SSD |

### 1.2 è½¯ä»¶ä¾èµ–

#### Pythonä¾èµ–

```bash
# å®‰è£…Pythonè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install --upgrade pip
pip install -r requirements.txt
```

**requirements.txt** (å¤šç§Ÿæˆ·ç›¸å…³ä¾èµ–):
```txt
# æ•°æ®åº“
SQLAlchemy>=2.0.0
alembic>=1.12.0
PyMySQL>=1.1.0
psycopg2-binary>=2.9.0

# Webæ¡†æ¶
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
starlette-context>=0.3.6

# ç¼“å­˜
redis>=5.0.0
hiredis>=2.2.0

# å…¶ä»–
python-dotenv>=1.0.0
pydantic>=2.5.0
```

#### æ•°æ®åº“å‡†å¤‡

**MySQL**:
```bash
# å®‰è£…MySQL
sudo apt-get install mysql-server

# åˆ›å»ºæ•°æ®åº“
mysql -u root -p << EOF
CREATE DATABASE non_standard_automation CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'nsapm_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON non_standard_automation.* TO 'nsapm_user'@'localhost';
FLUSH PRIVILEGES;
EOF
```

**PostgreSQL**:
```bash
# å®‰è£…PostgreSQL
sudo apt-get install postgresql postgresql-contrib

# åˆ›å»ºæ•°æ®åº“
sudo -u postgres psql << EOF
CREATE DATABASE non_standard_automation;
CREATE USER nsapm_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE non_standard_automation TO nsapm_user;
EOF
```

### 1.3 å¤‡ä»½ç°æœ‰æ•°æ®ï¼ˆé‡è¦ï¼‰

åœ¨è¿›è¡Œä»»ä½•è¿ç§»ä¹‹å‰ï¼Œ**å¿…é¡»**å…ˆå¤‡ä»½æ•°æ®ï¼š

```bash
# å¤‡ä»½æ•´ä¸ªæ•°æ®åº“
# MySQL
mysqldump -u root -p non_standard_automation > backup_before_migration_$(date +%Y%m%d_%H%M%S).sql

# PostgreSQL
pg_dump -U nsapm_user non_standard_automation > backup_before_migration_$(date +%Y%m%d_%H%M%S).sql

# éªŒè¯å¤‡ä»½æ–‡ä»¶
ls -lh backup_before_migration_*.sql
```

**é‡è¦**ï¼šå°†å¤‡ä»½æ–‡ä»¶ä¿å­˜åˆ°å®‰å…¨çš„ä½ç½®ï¼ˆå»ºè®®å¼‚åœ°å¤‡ä»½ï¼‰ã€‚

---

## 2. æ•°æ®åº“è¿ç§»æ­¥éª¤

### 2.1 è¿ç§»æµç¨‹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æ·»åŠ  tenant_id å­—æ®µï¼ˆå…è®¸ NULLï¼‰               â”‚
â”‚ Step 2: åˆ›å»ºé»˜è®¤ç§Ÿæˆ·                                    â”‚
â”‚ Step 3: è¿ç§»ç°æœ‰æ•°æ®åˆ°é»˜è®¤ç§Ÿæˆ·                          â”‚
â”‚ Step 4: éªŒè¯æ•°æ®å®Œæ•´æ€§                                  â”‚
â”‚ Step 5: æ·»åŠ ç´¢å¼•å’Œçº¦æŸ                                  â”‚
â”‚ Step 6: æ›´æ–° tenant_id ä¸º NOT NULLï¼ˆå¯é€‰ï¼‰             â”‚
â”‚ Step 7: éƒ¨ç½²æ–°ä»£ç                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Step 1: æ·»åŠ  tenant_id å­—æ®µ

**æ–¹å¼A: ä½¿ç”¨Alembicï¼ˆæ¨èï¼‰**

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
alembic revision --autogenerate -m "add tenant_id to all tables"

# 2. æ£€æŸ¥ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶
cat migrations/versions/xxxx_add_tenant_id_to_all_tables.py

# 3. æ‰§è¡Œè¿ç§»ï¼ˆ--sql åªç”ŸæˆSQLä¸æ‰§è¡Œï¼Œç”¨äºæ£€æŸ¥ï¼‰
alembic upgrade head --sql > migration.sql
cat migration.sql  # æ£€æŸ¥SQL

# 4. æ‰§è¡Œè¿ç§»
alembic upgrade head
```

**æ–¹å¼B: æ‰‹åŠ¨æ‰§è¡ŒSQLï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒç²¾ç»†æ§åˆ¶ï¼‰**

```sql
-- migrations/add_tenant_id_step1.sql

-- ä¸ºæ ¸å¿ƒä¸šåŠ¡è¡¨æ·»åŠ  tenant_id å­—æ®µ
ALTER TABLE projects 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

ALTER TABLE rd_projects 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

ALTER TABLE sales_contracts 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

ALTER TABLE work_orders 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

ALTER TABLE production_plans 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

ALTER TABLE material_requisitions 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

ALTER TABLE quality_inspections 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

ALTER TABLE purchase_orders 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

ALTER TABLE timesheets 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

ALTER TABLE equipment 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

ALTER TABLE bom 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

ALTER TABLE tasks 
    ADD COLUMN tenant_id INT NULL 
    COMMENT 'ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰';

-- ... å…¶ä»–ä¸šåŠ¡è¡¨
-- å®Œæ•´æ¸…å•è§ï¼šdocs/å¤šç§Ÿæˆ·æ•°æ®æ¨¡å‹å˜æ›´æ¸…å•.md
```

**æ‰§è¡Œ**:
```bash
# MySQL
mysql -u nsapm_user -p non_standard_automation < migrations/add_tenant_id_step1.sql

# PostgreSQL
psql -U nsapm_user -d non_standard_automation -f migrations/add_tenant_id_step1.sql
```

### 2.3 Step 2: åˆ›å»ºé»˜è®¤ç§Ÿæˆ·

è¿è¡Œè„šæœ¬åˆ›å»ºé»˜è®¤ç§Ÿæˆ·ï¼ˆç”¨äºæ‰¿è½½ç°æœ‰æ•°æ®ï¼‰ï¼š

```bash
# è¿è¡Œç§Ÿæˆ·åˆ›å»ºè„šæœ¬
python scripts/create_default_tenant.py
```

**scripts/create_default_tenant.py**:
```python
#!/usr/bin/env python3
"""åˆ›å»ºé»˜è®¤ç§Ÿæˆ·"""

from app.core.database import SessionLocal
from app.models.tenant import Tenant, TenantStatus, TenantPlan

def create_default_tenant():
    db = SessionLocal()
    try:
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨é»˜è®¤ç§Ÿæˆ·
        existing = db.query(Tenant).filter(Tenant.tenant_code == "jinkaibo").first()
        if existing:
            print(f"âœ… Default tenant already exists: {existing.tenant_code} (ID: {existing.id})")
            return existing
        
        # åˆ›å»ºé»˜è®¤ç§Ÿæˆ·
        tenant = Tenant(
            tenant_code="jinkaibo",
            tenant_name="é‡‘å‡¯åšè‡ªåŠ¨åŒ–",
            status=TenantStatus.ACTIVE.value,
            plan_type=TenantPlan.ENTERPRISE.value,
            max_users=-1,       # æ— é™ç”¨æˆ·
            max_roles=-1,       # æ— é™è§’è‰²
            max_storage_gb=1000,  # 1TB
            contact_name="ç³»ç»Ÿç®¡ç†å‘˜",
            contact_email="admin@jinkaibo.com",
            expired_at=None     # æ°¸ä¸è¿‡æœŸ
        )
        
        db.add(tenant)
        db.commit()
        db.refresh(tenant)
        
        print(f"âœ… Default tenant created successfully!")
        print(f"   - Tenant Code: {tenant.tenant_code}")
        print(f"   - Tenant Name: {tenant.tenant_name}")
        print(f"   - Tenant ID: {tenant.id}")
        
        return tenant
        
    except Exception as e:
        db.rollback()
        print(f"âŒ Error creating default tenant: {e}")
        raise
    finally:
        db.close()

if __name__ == "__main__":
    create_default_tenant()
```

**é¢„æœŸè¾“å‡º**:
```
âœ… Default tenant created successfully!
   - Tenant Code: jinkaibo
   - Tenant Name: é‡‘å‡¯åšè‡ªåŠ¨åŒ–
   - Tenant ID: 1
```

### 2.4 Step 3: è¿ç§»ç°æœ‰æ•°æ®

å°†æ‰€æœ‰ç°æœ‰æ•°æ®å…³è”åˆ°é»˜è®¤ç§Ÿæˆ·ï¼š

```bash
# è¿è¡Œæ•°æ®è¿ç§»è„šæœ¬
python scripts/migrate_to_default_tenant.py
```

**scripts/migrate_to_default_tenant.py**:
```python
#!/usr/bin/env python3
"""è¿ç§»ç°æœ‰æ•°æ®åˆ°é»˜è®¤ç§Ÿæˆ·"""

from sqlalchemy import text
from app.core.database import SessionLocal
from app.models.tenant import Tenant
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# éœ€è¦è¿ç§»çš„è¡¨æ¸…å•
TABLES_TO_MIGRATE = [
    'projects',
    'rd_projects',
    'sales_contracts',
    'work_orders',
    'production_plans',
    'material_requisitions',
    'quality_inspections',
    'purchase_orders',
    'timesheets',
    'equipment',
    'bom',
    'tasks',
    # ... æ·»åŠ å…¶ä»–æ‰€æœ‰ä¸šåŠ¡è¡¨
]

def migrate_all_data():
    db = SessionLocal()
    try:
        # 1. è·å–é»˜è®¤ç§Ÿæˆ·ID
        tenant = db.query(Tenant).filter(Tenant.tenant_code == "jinkaibo").first()
        if not tenant:
            raise Exception("Default tenant not found. Run create_default_tenant.py first.")
        
        logger.info(f"Default tenant ID: {tenant.id}")
        
        # 2. è¿ç§»æ¯ä¸ªè¡¨
        total_migrated = 0
        for table in TABLES_TO_MIGRATE:
            try:
                # æ›´æ–° tenant_id
                result = db.execute(
                    text(f"UPDATE {table} SET tenant_id = :tenant_id WHERE tenant_id IS NULL"),
                    {"tenant_id": tenant.id}
                )
                db.commit()
                
                count = result.rowcount
                total_migrated += count
                logger.info(f"âœ… {table}: {count} rows migrated")
                
            except Exception as e:
                logger.error(f"âŒ {table} migration failed: {e}")
                db.rollback()
                # ç»§ç»­è¿ç§»å…¶ä»–è¡¨ï¼Œä½†è®°å½•é”™è¯¯
        
        logger.info(f"\nğŸ‰ Migration completed! Total rows migrated: {total_migrated}")
        
    except Exception as e:
        logger.error(f"âŒ Migration failed: {e}")
        db.rollback()
        raise
    finally:
        db.close()

if __name__ == "__main__":
    migrate_all_data()
```

**é¢„æœŸè¾“å‡º**:
```
INFO - Default tenant ID: 1
INFO - âœ… projects: 125 rows migrated
INFO - âœ… rd_projects: 45 rows migrated
INFO - âœ… sales_contracts: 78 rows migrated
INFO - âœ… work_orders: 234 rows migrated
...
INFO - ğŸ‰ Migration completed! Total rows migrated: 1543
```

### 2.5 Step 4: éªŒè¯æ•°æ®å®Œæ•´æ€§

è¿è¡ŒéªŒè¯è„šæœ¬ç¡®ä¿è¿ç§»æˆåŠŸï¼š

```bash
# è¿è¡ŒéªŒè¯è„šæœ¬
python scripts/verify_tenant_migration.py
```

**scripts/verify_tenant_migration.py**:
```python
#!/usr/bin/env python3
"""éªŒè¯ç§Ÿæˆ·æ•°æ®è¿ç§»å®Œæ•´æ€§"""

from sqlalchemy import text
from app.core.database import SessionLocal
from app.models.tenant import Tenant
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

TABLES_TO_VERIFY = [
    'projects',
    'rd_projects',
    'sales_contracts',
    # ... æ‰€æœ‰ä¸šåŠ¡è¡¨
]

def verify_migration():
    db = SessionLocal()
    issues = []
    
    try:
        # 1. è·å–é»˜è®¤ç§Ÿæˆ·
        tenant = db.query(Tenant).filter(Tenant.tenant_code == "jinkaibo").first()
        if not tenant:
            issues.append("âŒ Default tenant not found")
            return issues
        
        logger.info(f"Verifying migration for tenant ID: {tenant.id}\n")
        
        # 2. æ£€æŸ¥æ¯ä¸ªè¡¨
        for table in TABLES_TO_VERIFY:
            # æ£€æŸ¥ NULL tenant_id
            null_count = db.execute(
                text(f"SELECT COUNT(*) FROM {table} WHERE tenant_id IS NULL")
            ).scalar()
            
            if null_count > 0:
                issues.append(f"âŒ {table}: {null_count} rows with NULL tenant_id")
                logger.error(f"âŒ {table}: {null_count} rows with NULL tenant_id")
            else:
                logger.info(f"âœ… {table}: All rows have tenant_id")
            
            # æ£€æŸ¥å¤–é”®å®Œæ•´æ€§
            invalid_fk = db.execute(
                text(f"""
                    SELECT COUNT(*) FROM {table} t
                    LEFT JOIN tenants tn ON t.tenant_id = tn.id
                    WHERE t.tenant_id IS NOT NULL AND tn.id IS NULL
                """)
            ).scalar()
            
            if invalid_fk > 0:
                issues.append(f"âŒ {table}: {invalid_fk} rows with invalid tenant_id")
                logger.error(f"âŒ {table}: {invalid_fk} rows with invalid tenant_id")
        
        # 3. è¾“å‡ºéªŒè¯ç»“æœ
        if issues:
            logger.error(f"\nâŒ Migration verification FAILED with {len(issues)} issues:")
            for issue in issues:
                logger.error(f"  - {issue}")
            return False
        else:
            logger.info(f"\nâœ… Migration verification PASSED! All data migrated successfully.")
            return True
            
    except Exception as e:
        logger.error(f"âŒ Verification failed: {e}")
        raise
    finally:
        db.close()

if __name__ == "__main__":
    success = verify_migration()
    exit(0 if success else 1)
```

**é¢„æœŸè¾“å‡ºï¼ˆæˆåŠŸï¼‰**:
```
INFO - Verifying migration for tenant ID: 1

INFO - âœ… projects: All rows have tenant_id
INFO - âœ… rd_projects: All rows have tenant_id
INFO - âœ… sales_contracts: All rows have tenant_id
...
INFO - âœ… Migration verification PASSED! All data migrated successfully.
```

### 2.6 Step 5: æ·»åŠ ç´¢å¼•å’Œå¤–é”®çº¦æŸ

```sql
-- migrations/add_tenant_constraints.sql

-- æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE projects 
    ADD CONSTRAINT fk_projects_tenant 
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT;

ALTER TABLE rd_projects 
    ADD CONSTRAINT fk_rd_projects_tenant 
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT;

-- ... å…¶ä»–è¡¨

-- æ·»åŠ å•åˆ—ç´¢å¼•
CREATE INDEX idx_projects_tenant ON projects(tenant_id);
CREATE INDEX idx_rd_projects_tenant ON rd_projects(tenant_id);
CREATE INDEX idx_work_orders_tenant ON work_orders(tenant_id);

-- ... å…¶ä»–è¡¨

-- æ·»åŠ å¤åˆç´¢å¼•ï¼ˆé«˜é¢‘æŸ¥è¯¢ä¼˜åŒ–ï¼‰
CREATE INDEX idx_projects_tenant_status ON projects(tenant_id, status);
CREATE INDEX idx_work_orders_tenant_status ON work_orders(tenant_id, status);
CREATE INDEX idx_tasks_tenant_project ON tasks(tenant_id, project_id);
```

**æ‰§è¡Œ**:
```bash
# MySQL
mysql -u nsapm_user -p non_standard_automation < migrations/add_tenant_constraints.sql

# éªŒè¯ç´¢å¼•
mysql -u nsapm_user -p non_standard_automation -e "SHOW INDEX FROM projects;"
```

### 2.7 Step 6: æ›´æ–° tenant_id ä¸º NOT NULLï¼ˆå¯é€‰ï¼‰

âš ï¸ **è­¦å‘Š**ï¼šè¿™ä¸€æ­¥ä¼šå¼ºåˆ¶è¦æ±‚æ‰€æœ‰æ•°æ®å¿…é¡»æœ‰ `tenant_id`ï¼Œæ‰§è¡Œå‰ç¡®ä¿Step 4éªŒè¯é€šè¿‡ã€‚

```sql
-- migrations/set_tenant_id_not_null.sql

-- ä¿®æ”¹ tenant_id ä¸º NOT NULL
ALTER TABLE projects MODIFY COLUMN tenant_id INT NOT NULL;
ALTER TABLE rd_projects MODIFY COLUMN tenant_id INT NOT NULL;
ALTER TABLE work_orders MODIFY COLUMN tenant_id INT NOT NULL;

-- ... å…¶ä»–è¡¨
```

**æ‰§è¡Œ**ï¼ˆè°¨æ…ï¼‰:
```bash
# å†æ¬¡éªŒè¯æ•°æ®
python scripts/verify_tenant_migration.py

# ç¡®è®¤æ— è¯¯åæ‰§è¡Œ
mysql -u nsapm_user -p non_standard_automation < migrations/set_tenant_id_not_null.sql
```

---

## 3. é…ç½®æ–‡ä»¶è¯´æ˜

### 3.1 ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# .env

# æ•°æ®åº“é…ç½®
DATABASE_URL=mysql+pymysql://nsapm_user:your_password@localhost:3306/non_standard_automation?charset=utf8mb4

# å¤šç§Ÿæˆ·é…ç½®
ENABLE_MULTI_TENANT=true               # å¯ç”¨å¤šç§Ÿæˆ·æ¨¡å¼
DEFAULT_TENANT_CODE=jinkaibo           # é»˜è®¤ç§Ÿæˆ·ä»£ç 
TENANT_ISOLATION_STRICT=true           # ä¸¥æ ¼éš”ç¦»æ¨¡å¼

# Redisé…ç½®ï¼ˆç§Ÿæˆ·ç¼“å­˜ï¼‰
REDIS_URL=redis://localhost:6379/0

# è¶…çº§ç®¡ç†å‘˜é…ç½®
SUPERUSER_EMAIL=admin@example.com
SUPERUSER_PASSWORD=change_me_in_production
```

### 3.2 æ•°æ®åº“é…ç½®

**app/core/config.py**:
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # æ•°æ®åº“
    DATABASE_URL: str
    
    # å¤šç§Ÿæˆ·
    ENABLE_MULTI_TENANT: bool = True
    DEFAULT_TENANT_CODE: str = "jinkaibo"
    TENANT_ISOLATION_STRICT: bool = True
    
    # Redis
    REDIS_URL: str = "redis://localhost:6379/0"
    
    class Config:
        env_file = ".env"

settings = Settings()
```

### 3.3 åº”ç”¨é…ç½®

**app/main.py**:
```python
from fastapi import FastAPI
from app.core.middleware.tenant_middleware import TenantContextMiddleware
from app.core.database import engine, SessionLocal
from app.core.database.tenant_query import TenantQuery

# é…ç½®Sessionä½¿ç”¨TenantQuery
from sqlalchemy.orm import sessionmaker
SessionLocal = sessionmaker(
    bind=engine,
    query_cls=TenantQuery,  # âœ… å¯ç”¨è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤
    autocommit=False,
    autoflush=False,
)

app = FastAPI(title="éæ ‡è‡ªåŠ¨åŒ–é¡¹ç›®ç®¡ç†ç³»ç»Ÿ")

# æ·»åŠ ç§Ÿæˆ·ä¸­é—´ä»¶ï¼ˆåœ¨è®¤è¯ä¸­é—´ä»¶ä¹‹åï¼‰
app.add_middleware(TenantContextMiddleware)
```

---

## 4. å¯åŠ¨å’ŒéªŒè¯

### 4.1 å¯åŠ¨æœåŠ¡

```bash
# æ–¹å¼1: å¼€å‘ç¯å¢ƒ
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# æ–¹å¼2: ç”Ÿäº§ç¯å¢ƒï¼ˆä½¿ç”¨Gunicornï¼‰
gunicorn app.main:app \
    --workers 4 \
    --worker-class uvicorn.workers.UvicornWorker \
    --bind 0.0.0.0:8000 \
    --access-logfile logs/access.log \
    --error-logfile logs/error.log
```

### 4.2 å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:8000/health

# é¢„æœŸå“åº”
{
    "status": "healthy",
    "multi_tenant_enabled": true,
    "database": "connected",
    "tenant_count": 1
}
```

### 4.3 åŠŸèƒ½éªŒè¯

#### éªŒè¯1: ç§Ÿæˆ·éš”ç¦»

```bash
# åˆ›å»ºæµ‹è¯•ç§Ÿæˆ·
curl -X POST http://localhost:8000/api/v1/tenants \
  -H "Authorization: Bearer $SUPERUSER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_code": "test_tenant",
    "tenant_name": "æµ‹è¯•ç§Ÿæˆ·",
    "plan_type": "STANDARD"
  }'

# åˆ›å»ºç§Ÿæˆ·Açš„ç”¨æˆ·
curl -X POST http://localhost:8000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user_a",
    "email": "user_a@tenant_a.com",
    "password": "Password123",
    "tenant_code": "jinkaibo"
  }'

# åˆ›å»ºç§Ÿæˆ·Bçš„ç”¨æˆ·
curl -X POST http://localhost:8000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user_b",
    "email": "user_b@tenant_b.com",
    "password": "Password123",
    "tenant_code": "test_tenant"
  }'

# ç”¨æˆ·Aåˆ›å»ºé¡¹ç›®
curl -X POST http://localhost:8000/api/v1/projects \
  -H "Authorization: Bearer $USER_A_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "ç§Ÿæˆ·Açš„é¡¹ç›®"
  }'

# ç”¨æˆ·Bå°è¯•è®¿é—®ç”¨æˆ·Açš„é¡¹ç›®ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
curl http://localhost:8000/api/v1/projects/1 \
  -H "Authorization: Bearer $USER_B_TOKEN"

# é¢„æœŸå“åº”: 404 Not Found æˆ– 403 Forbidden
```

#### éªŒè¯2: è¶…çº§ç®¡ç†å‘˜æƒé™

```bash
# è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰ç§Ÿæˆ·çš„é¡¹ç›®
curl http://localhost:8000/api/v1/projects \
  -H "Authorization: Bearer $SUPERUSER_TOKEN"

# é¢„æœŸå“åº”: è¿”å›æ‰€æœ‰ç§Ÿæˆ·çš„é¡¹ç›®
```

#### éªŒè¯3: æ•°æ®åº“æŸ¥è¯¢

```sql
-- éªŒè¯ç§Ÿæˆ·æ•°æ®éš”ç¦»
SELECT tenant_id, COUNT(*) 
FROM projects 
GROUP BY tenant_id;

-- é¢„æœŸç»“æœ:
-- tenant_id | COUNT(*)
-- 1         | 125
-- 2         | 3
```

### 4.4 æ€§èƒ½æµ‹è¯•

```bash
# ä½¿ç”¨Apache Benchè¿›è¡Œå‹åŠ›æµ‹è¯•
ab -n 1000 -c 10 \
  -H "Authorization: Bearer $USER_TOKEN" \
  http://localhost:8000/api/v1/projects

# å…³é”®æŒ‡æ ‡:
# - Requests per second: > 100
# - Time per request: < 100ms
# - Failed requests: 0
```

---

## 5. å›æ»šæ–¹æ¡ˆ

### 5.1 å›æ»šæµç¨‹

å¦‚æœè¿ç§»å¤±è´¥ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

```bash
# 1. åœæ­¢æœåŠ¡
sudo systemctl stop nsapm

# 2. æ¢å¤æ•°æ®åº“å¤‡ä»½
mysql -u root -p non_standard_automation < backup_before_migration_YYYYMMDD_HHMMSS.sql

# 3. éªŒè¯æ•°æ®
mysql -u nsapm_user -p -e "SELECT COUNT(*) FROM projects;"

# 4. é‡å¯æœåŠ¡ï¼ˆæ—§ç‰ˆæœ¬ä»£ç ï¼‰
git checkout <previous_commit>
sudo systemctl start nsapm
```

### 5.2 éƒ¨åˆ†å›æ»šï¼ˆä»…æ’¤é”€tenant_idï¼‰

å¦‚æœåªéœ€è¦æ’¤é”€ `tenant_id` å­—æ®µä½†ä¿ç•™å…¶ä»–ä¿®æ”¹ï¼š

```bash
# è¿è¡Œå›æ»šè„šæœ¬
python scripts/rollback_tenant_migration.py
```

**scripts/rollback_tenant_migration.py**:
```python
#!/usr/bin/env python3
"""å›æ»šç§Ÿæˆ·æ•°æ®è¿ç§»"""

from sqlalchemy import text
from app.core.database import SessionLocal
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

TABLES_TO_ROLLBACK = [
    'projects',
    'rd_projects',
    'sales_contracts',
    # ... æ‰€æœ‰ä¸šåŠ¡è¡¨
]

def rollback_migration():
    db = SessionLocal()
    try:
        for table in TABLES_TO_ROLLBACK:
            # å°† tenant_id è®¾ç½®å› NULL
            db.execute(
                text(f"UPDATE {table} SET tenant_id = NULL WHERE tenant_id IS NOT NULL")
            )
            db.commit()
            logger.info(f"âœ… {table}: tenant_id reset to NULL")
        
        logger.info("âœ… Rollback completed successfully")
        
    except Exception as e:
        logger.error(f"âŒ Rollback failed: {e}")
        db.rollback()
        raise
    finally:
        db.close()

if __name__ == "__main__":
    confirm = input("âš ï¸  Are you sure you want to rollback? (yes/no): ")
    if confirm.lower() == "yes":
        rollback_migration()
    else:
        logger.info("Rollback cancelled")
```

### 5.3 åˆ é™¤ tenant_id å­—æ®µ

å¦‚æœéœ€è¦å®Œå…¨åˆ é™¤å¤šç§Ÿæˆ·åŠŸèƒ½ï¼š

```sql
-- migrations/remove_tenant_id.sql

-- åˆ é™¤å¤–é”®çº¦æŸ
ALTER TABLE projects DROP FOREIGN KEY fk_projects_tenant;
ALTER TABLE rd_projects DROP FOREIGN KEY fk_rd_projects_tenant;
-- ... å…¶ä»–è¡¨

-- åˆ é™¤ç´¢å¼•
DROP INDEX idx_projects_tenant ON projects;
DROP INDEX idx_rd_projects_tenant ON rd_projects;
-- ... å…¶ä»–è¡¨

-- åˆ é™¤ tenant_id å­—æ®µ
ALTER TABLE projects DROP COLUMN tenant_id;
ALTER TABLE rd_projects DROP COLUMN tenant_id;
-- ... å…¶ä»–è¡¨
```

---

## 6. æ•…éšœæ’æŸ¥

### 6.1 å¸¸è§é—®é¢˜

#### é—®é¢˜1: å¤–é”®çº¦æŸé”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
ERROR 1452 (23000): Cannot add or update a child row: 
a foreign key constraint fails
```

**åŸå› **: å­˜åœ¨ `tenant_id` ä¸ºNULLæˆ–æ— æ•ˆçš„è®°å½•

**è§£å†³**:
```bash
# æŸ¥æ‰¾é—®é¢˜è®°å½•
mysql -u nsapm_user -p -e "
    SELECT id, tenant_id FROM projects WHERE tenant_id IS NULL;
"

# ä¿®å¤æ•°æ®
python scripts/verify_tenant_migration.py
python scripts/migrate_to_default_tenant.py
```

#### é—®é¢˜2: æŸ¥è¯¢æ€§èƒ½ä¸‹é™

**ç°è±¡**: æ·»åŠ  `tenant_id` è¿‡æ»¤åæŸ¥è¯¢å˜æ…¢

**åŸå› **: ç¼ºå°‘ç´¢å¼•

**è§£å†³**:
```sql
-- æ£€æŸ¥ç´¢å¼•
SHOW INDEX FROM projects;

-- æ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX idx_projects_tenant_status ON projects(tenant_id, status);

-- åˆ†ææŸ¥è¯¢
EXPLAIN SELECT * FROM projects WHERE tenant_id = 1 AND status = 'active';
```

#### é—®é¢˜3: è¶…çº§ç®¡ç†å‘˜æ— æ³•è®¿é—®æ•°æ®

**ç°è±¡**: è¶…çº§ç®¡ç†å‘˜æŸ¥è¯¢è¿”å›ç©ºç»“æœ

**åŸå› **: `is_superuser=True` ä½† `tenant_id != NULL`

**è§£å†³**:
```python
# è¿è¡Œä¿®å¤è„šæœ¬
python scripts/fix_superuser_data.py
```

```sql
-- æˆ–æ‰‹åŠ¨ä¿®å¤
UPDATE users 
SET tenant_id = NULL 
WHERE is_superuser = TRUE AND tenant_id IS NOT NULL;
```

#### é—®é¢˜4: ç§Ÿæˆ·æ•°æ®æ³„éœ²

**ç°è±¡**: ç”¨æˆ·å¯ä»¥çœ‹åˆ°å…¶ä»–ç§Ÿæˆ·çš„æ•°æ®

**åŸå› **: TenantQueryæœªç”Ÿæ•ˆ

**æ£€æŸ¥**:
```python
# æ£€æŸ¥Sessioné…ç½®
from app.core.database import SessionLocal
print(SessionLocal.kw.get('query_cls'))  # åº”è¯¥æ˜¯ TenantQuery

# æ£€æŸ¥ä¸­é—´ä»¶é¡ºåº
from app.main import app
print(app.user_middleware)  # TenantContextMiddlewareåº”è¯¥åœ¨åˆ—è¡¨ä¸­
```

**è§£å†³**:
```python
# ç¡®ä¿ main.py é…ç½®æ­£ç¡®
from app.core.database.tenant_query import TenantQuery

SessionLocal = sessionmaker(
    bind=engine,
    query_cls=TenantQuery,  # âœ… å¿…é¡»æŒ‡å®š
    autocommit=False,
    autoflush=False,
)
```

### 6.2 æ—¥å¿—æ’æŸ¥

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š

```python
# app/core/logging_config.py
import logging

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

# å¯ç”¨SQLæ—¥å¿—
logging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)
```

æŸ¥çœ‹ç§Ÿæˆ·è¿‡æ»¤æ—¥å¿—ï¼š
```bash
tail -f logs/app.log | grep "tenant_id"
```

### 6.3 ç›‘æ§å’Œå‘Šè­¦

è®¾ç½®å…³é”®æŒ‡æ ‡ç›‘æ§ï¼š

```python
# app/core/monitoring.py
from prometheus_client import Counter, Histogram

# ç§Ÿæˆ·éš”ç¦»è¿è§„è®¡æ•°
tenant_violation_counter = Counter(
    'tenant_isolation_violations_total',
    'Total number of tenant isolation violations'
)

# æŸ¥è¯¢æ€§èƒ½ç›‘æ§
query_duration = Histogram(
    'tenant_query_duration_seconds',
    'Tenant query duration in seconds',
    buckets=[0.01, 0.05, 0.1, 0.5, 1.0, 5.0]
)
```

---

## é™„å½•

### A. å®Œæ•´è¿ç§»è„šæœ¬

```bash
#!/bin/bash
# full_migration.sh - å®Œæ•´çš„ç§Ÿæˆ·è¿ç§»è„šæœ¬

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "ğŸš€ Starting multi-tenant migration..."

# 1. å¤‡ä»½æ•°æ®åº“
echo "ğŸ“¦ Step 1: Backing up database..."
mysqldump -u root -p non_standard_automation > backup_$(date +%Y%m%d_%H%M%S).sql
echo "âœ… Backup completed"

# 2. æ·»åŠ  tenant_id å­—æ®µ
echo "ğŸ”§ Step 2: Adding tenant_id fields..."
mysql -u nsapm_user -p non_standard_automation < migrations/add_tenant_id_step1.sql
echo "âœ… Fields added"

# 3. åˆ›å»ºé»˜è®¤ç§Ÿæˆ·
echo "ğŸ¢ Step 3: Creating default tenant..."
python scripts/create_default_tenant.py
echo "âœ… Default tenant created"

# 4. è¿ç§»æ•°æ®
echo "ğŸ“Š Step 4: Migrating existing data..."
python scripts/migrate_to_default_tenant.py
echo "âœ… Data migrated"

# 5. éªŒè¯æ•°æ®
echo "ğŸ” Step 5: Verifying migration..."
python scripts/verify_tenant_migration.py
if [ $? -ne 0 ]; then
    echo "âŒ Verification failed! Rolling back..."
    mysql -u root -p non_standard_automation < backup_*.sql
    exit 1
fi
echo "âœ… Verification passed"

# 6. æ·»åŠ çº¦æŸ
echo "ğŸ” Step 6: Adding constraints and indexes..."
mysql -u nsapm_user -p non_standard_automation < migrations/add_tenant_constraints.sql
echo "âœ… Constraints added"

# 7. é‡å¯æœåŠ¡
echo "ğŸ”„ Step 7: Restarting service..."
sudo systemctl restart nsapm
echo "âœ… Service restarted"

echo "ğŸ‰ Migration completed successfully!"
```

### B. æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰æ£€æŸ¥ï¼š
- [ ] æ•°æ®åº“å·²å¤‡ä»½
- [ ] ä¾èµ–å·²å®‰è£… (`pip install -r requirements.txt`)
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½® (`.env`)
- [ ] è¿ç§»è„šæœ¬å·²æµ‹è¯•ï¼ˆåœ¨å¼€å‘ç¯å¢ƒï¼‰
- [ ] å›æ»šæ–¹æ¡ˆå·²å‡†å¤‡

éƒ¨ç½²åæ£€æŸ¥ï¼š
- [ ] æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] ç§Ÿæˆ·éš”ç¦»æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡
- [ ] æ—¥å¿—æ— ERRORçº§åˆ«é”™è¯¯
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸

### C. è”ç³»æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- **æŠ€æœ¯æ”¯æŒ**: tech-support@example.com
- **GitHub Issues**: https://github.com/yourorg/nsapm/issues
- **æ–‡æ¡£**: https://docs.example.com/multi-tenant

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2026-02-16  
**ç»´æŠ¤å›¢é˜Ÿ**: Team 6 - æ–‡æ¡£å’Œéƒ¨ç½²

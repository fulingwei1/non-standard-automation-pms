# 服务工单处理流程说明

> **创建日期**：2026-01-15  
> **适用范围**：客服工程师创建的服务工单  
> **API端点**：`app/api/v1/endpoints/service.py`

---

## 一、工单创建流程

### 1.1 创建工单（POST /api/v1/service-tickets）

**触发时机**：客服工程师创建新的服务工单

**处理步骤**：

1. **数据验证**
   - ✅ 验证项目是否存在（`project_id`）
   - ✅ 验证客户是否存在（`customer_id`）

2. **生成工单号**
   - 格式：`SRV-yymmdd-xxx`（例如：`SRV-250115-001`）
   - 自动递增序号

3. **创建工单记录**
   ```python
   ServiceTicket(
       ticket_no=generate_ticket_no(db),
       project_id=ticket_in.project_id,
       customer_id=ticket_in.customer_id,
       problem_type=ticket_in.problem_type,      # 问题类型
       problem_desc=ticket_in.problem_desc,      # 问题描述
       urgency=ticket_in.urgency,                # 紧急程度
       reported_by=ticket_in.reported_by,        # 报告人
       reported_time=ticket_in.reported_time,    # 报告时间
       status="PENDING",                        # 初始状态：待分配
       timeline=[{                               # 初始化时间线
           "type": "REPORTED",
           "timestamp": ticket_in.reported_time.isoformat(),
           "user": ticket_in.reported_by,
           "description": "客户报告问题",
       }],
   )
   ```

4. **自动创建SLA监控记录**
   - 根据问题类型和紧急程度匹配SLA策略
   - 创建SLA监控记录，计算响应和解决截止时间
   - 如果SLA创建失败，不影响工单创建（记录错误日志）

5. **返回工单信息**
   - 包含项目名称和客户名称（自动填充）

---

## 二、工单状态流转

### 2.1 工单状态定义

| 状态 | 说明 | 英文标识 |
|------|------|---------|
| 待分配 | 工单已创建，等待分配处理人 | `PENDING` |
| 处理中 | 工单已分配，正在处理 | `IN_PROGRESS` |
| 待验证 | 问题已解决，等待客户验证 | `RESOLVED` |
| 已关闭 | 工单已关闭，问题已解决 | `CLOSED` |

### 2.2 状态流转图

```
创建工单
   ↓
PENDING (待分配)
   ↓ [分配工单]
IN_PROGRESS (处理中)
   ↓ [标记已解决]
RESOLVED (待验证)
   ↓ [关闭工单]
CLOSED (已关闭)
```

---

## 三、工单分配流程

### 3.1 分配工单（PUT /api/v1/service-tickets/{ticket_id}/assign）

**触发时机**：管理员或客服经理分配工单给处理人

**处理步骤**：

1. **验证工单和处理人**
   - ✅ 验证工单是否存在
   - ✅ 验证处理人（assignee）是否存在

2. **更新工单信息**
   ```python
   ticket.assigned_to_id = assign_in.assignee_id
   ticket.assigned_to_name = assignee.name or assignee.username
   ticket.assigned_time = datetime.now()
   ticket.status = "IN_PROGRESS"  # 状态变为处理中
   ```

3. **记录响应时间**
   - 首次分配时，记录响应时间（`response_time`）
   - 响应时间 = 分配时间 - 报告时间

4. **更新时间线**
   ```python
   timeline.append({
       "type": "ASSIGNED",
       "timestamp": datetime.now().isoformat(),
       "user": current_user.real_name,
       "description": f"工单已分配给 {assignee.name}",
   })
   ```

5. **同步SLA监控状态**
   - 调用 `sync_ticket_to_sla_monitor()` 更新SLA监控记录
   - 更新实际响应时间
   - 计算是否超时

---

## 四、工单状态更新流程

### 4.1 更新状态（PUT /api/v1/service-tickets/{ticket_id}/status）

**支持的状态变更**：
- `PENDING` → `IN_PROGRESS`
- `IN_PROGRESS` → `RESOLVED`
- `RESOLVED` → `CLOSED`
- 其他状态间的合理流转

**处理步骤**：

1. **验证状态值**
   - 只允许：`PENDING`、`IN_PROGRESS`、`RESOLVED`、`CLOSED`

2. **自动记录时间**
   - 如果状态变为 `RESOLVED` 或 `CLOSED`，记录解决时间（`resolved_time`）
   - 如果状态变为 `IN_PROGRESS`，记录响应时间（如果还没有）

3. **更新时间线**
   ```python
   timeline.append({
       "type": "STATUS_CHANGE",
       "timestamp": datetime.now().isoformat(),
       "user": current_user.real_name,
       "description": f"状态变更：{old_status} → {new_status}",
   })
   ```

4. **同步SLA监控状态**
   - 更新SLA监控记录的实际响应时间和解决时间
   - 计算SLA达成情况

---

## 五、工单关闭流程

### 5.1 关闭工单（PUT /api/v1/service-tickets/{ticket_id}/close）

**触发时机**：问题已解决，客户验证通过，关闭工单

**处理步骤**：

1. **验证工单状态**
   - ✅ 工单不能已经是 `CLOSED` 状态

2. **更新工单信息**
   ```python
   ticket.solution = close_in.solution              # 解决方案
   ticket.root_cause = close_in.root_cause         # 根本原因
   ticket.preventive_action = close_in.preventive_action  # 预防措施
   ticket.satisfaction = close_in.satisfaction      # 满意度（1-5）
   ticket.feedback = close_in.feedback             # 客户反馈
   ticket.resolved_time = datetime.now()           # 解决时间
   ticket.status = "CLOSED"                        # 状态：已关闭
   ```

3. **更新时间线**
   ```python
   timeline.append({
       "type": "CLOSED",
       "timestamp": datetime.now().isoformat(),
       "user": current_user.real_name,
       "description": "工单已关闭",
   })
   ```

4. **同步SLA监控状态**
   - 更新SLA监控记录的实际解决时间
   - 计算SLA达成情况（是否超时）

5. **自动提取知识** ⭐ **重要功能**
   - 调用 `auto_extract_knowledge_from_ticket()` 函数
   - 从工单中提取知识，生成知识库文章
   - 自动创建解决方案模板
   - 如果提取失败，记录错误日志但不影响工单关闭

---

## 六、SLA监控机制

### 6.1 SLA策略匹配

**匹配规则**（优先级从高到低）：

1. **精确匹配**：问题类型 + 紧急程度都匹配
2. **问题类型匹配**：只匹配问题类型（紧急程度为空）
3. **紧急程度匹配**：只匹配紧急程度（问题类型为空）
4. **通用策略**：问题类型和紧急程度都为空

**示例**：
- 工单：问题类型=`SOFTWARE`，紧急程度=`URGENT`
- 优先匹配：`SOFTWARE` + `URGENT` 的策略
- 其次匹配：`SOFTWARE` + `NULL` 的策略
- 再次匹配：`NULL` + `URGENT` 的策略
- 最后匹配：`NULL` + `NULL` 的通用策略

### 6.2 SLA监控记录创建

**创建时机**：工单创建时自动创建

**计算截止时间**：
```python
response_deadline = reported_time + timedelta(hours=policy.response_time_hours)
resolve_deadline = reported_time + timedelta(hours=policy.resolve_time_hours)
```

**监控状态**：
- `ON_TIME`：按时完成
- `WARNING`：接近截止时间（达到预警阈值）
- `OVERDUE`：已超时

### 6.3 SLA状态同步

**同步时机**：
- 工单分配时（更新响应时间）
- 工单状态变更时（更新解决时间）
- 工单关闭时（最终确认SLA状态）

**同步内容**：
- 实际响应时间（`actual_response_time`）
- 实际解决时间（`actual_resolve_time`）
- 响应状态（`response_status`）
- 解决状态（`resolve_status`）
- 时间差（`response_time_diff_hours`、`resolve_time_diff_hours`）

---

## 七、知识自动提取机制

### 7.1 提取条件

**触发条件**：
- ✅ 工单状态为 `CLOSED`
- ✅ 工单有解决方案（`solution` 不为空）

### 7.2 提取内容

**生成知识库文章**：
- **标题**：`问题解决方案：{问题类型} - {工单号}`
- **内容结构**：
  ```
  ## 问题描述
  {problem_desc}
  
  ## 根本原因
  {root_cause}
  
  ## 解决方案
  {solution}
  
  ## 预防措施
  {preventive_action}
  
  ## 相关信息
  - 工单号：{ticket_no}
  - 问题类型：{problem_type}
  - 紧急程度：{urgency}
  - 项目：{project_name}
  - 解决时间：{resolved_time}
  ```

**分类映射**：
- `SOFTWARE` → "软件问题"
- `MECHANICAL` → "机械问题"
- `ELECTRICAL` → "电气问题"
- `OPERATION` → "操作问题"
- `OTHER` → "其他问题"

**标签**：
- 问题类型
- 紧急程度
- 项目编码（如果有）

### 7.3 解决方案模板

**同时创建解决方案模板**：
- 从工单的解决方案中提取
- 可用于后续类似问题的快速解决

---

## 八、时间线记录

### 8.1 时间线结构

```json
[
  {
    "type": "REPORTED",
    "timestamp": "2025-01-15T10:00:00",
    "user": "客服工程师A",
    "description": "客户报告问题"
  },
  {
    "type": "ASSIGNED",
    "timestamp": "2025-01-15T10:30:00",
    "user": "客服经理",
    "description": "工单已分配给 技术工程师B"
  },
  {
    "type": "STATUS_CHANGE",
    "timestamp": "2025-01-15T14:00:00",
    "user": "技术工程师B",
    "description": "状态变更：IN_PROGRESS → RESOLVED"
  },
  {
    "type": "CLOSED",
    "timestamp": "2025-01-15T15:00:00",
    "user": "客服工程师A",
    "description": "工单已关闭"
  }
]
```

### 8.2 时间线类型

| 类型 | 说明 | 触发时机 |
|------|------|---------|
| `REPORTED` | 工单创建 | 创建工单时 |
| `ASSIGNED` | 工单分配 | 分配工单时 |
| `STATUS_CHANGE` | 状态变更 | 更新状态时 |
| `CLOSED` | 工单关闭 | 关闭工单时 |

---

## 九、完整处理流程图

```
┌─────────────────────────────────────────────────────────┐
│  1. 客服工程师创建工单                                     │
│     POST /api/v1/service-tickets                         │
│     - 验证项目和客户                                       │
│     - 生成工单号（SRV-yymmdd-xxx）                        │
│     - 创建工单记录（status=PENDING）                      │
│     - 初始化时间线                                        │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  2. 自动创建SLA监控                                       │
│     - 匹配SLA策略（问题类型+紧急程度）                    │
│     - 计算响应和解决截止时间                              │
│     - 创建SLA监控记录                                    │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  3. 分配工单给处理人                                      │
│     PUT /api/v1/service-tickets/{id}/assign             │
│     - 更新处理人信息                                      │
│     - 状态变为 IN_PROGRESS                               │
│     - 记录响应时间（首次分配）                            │
│     - 更新时间线（ASSIGNED）                             │
│     - 同步SLA监控状态                                    │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  4. 处理工单                                             │
│     - 技术工程师处理问题                                  │
│     - 可以更新工单状态                                    │
│     - 状态流转：IN_PROGRESS → RESOLVED                  │
│     - 记录解决时间                                        │
│     - 更新时间线（STATUS_CHANGE）                        │
│     - 同步SLA监控状态                                    │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  5. 关闭工单                                             │
│     PUT /api/v1/service-tickets/{id}/close              │
│     - 填写解决方案、根本原因、预防措施                    │
│     - 记录客户满意度和反馈                                │
│     - 状态变为 CLOSED                                    │
│     - 记录解决时间                                        │
│     - 更新时间线（CLOSED）                               │
│     - 同步SLA监控状态（最终确认）                        │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  6. 自动提取知识 ⭐                                        │
│     - 从工单提取问题描述、解决方案等                      │
│     - 生成知识库文章（KB-yymmdd-xxx）                    │
│     - 创建解决方案模板                                    │
│     - 自动发布（auto_publish=True）                      │
└─────────────────────────────────────────────────────────┘
```

---

## 十、关键时间点记录

### 10.1 时间字段说明

| 字段 | 说明 | 记录时机 |
|------|------|---------|
| `reported_time` | 报告时间 | 创建工单时 |
| `assigned_time` | 分配时间 | 分配工单时 |
| `response_time` | 响应时间 | 首次分配时（assigned_time） |
| `resolved_time` | 解决时间 | 状态变为RESOLVED或CLOSED时 |

### 10.2 时间计算

**响应时间** = `response_time` - `reported_time`
- 衡量：从客户报告问题到系统响应的时间

**解决时间** = `resolved_time` - `reported_time`
- 衡量：从客户报告问题到问题解决的总时间

**处理时间** = `resolved_time` - `assigned_time`
- 衡量：从分配工单到问题解决的时间

---

## 十一、错误处理机制

### 11.1 容错设计

**SLA监控创建失败**：
- ✅ 不影响工单创建
- ⚠️ 记录错误日志
- ⚠️ 工单可以正常创建和使用

**SLA状态同步失败**：
- ✅ 不影响工单状态更新
- ⚠️ 记录错误日志
- ⚠️ 工单可以正常流转

**知识提取失败**：
- ✅ 不影响工单关闭
- ⚠️ 记录错误日志
- ⚠️ 工单可以正常关闭

### 11.2 数据一致性保证

- 工单创建和SLA监控创建在同一事务中
- 工单状态更新和SLA同步在同一事务中
- 工单关闭和知识提取在同一事务中

---

## 十二、与问题管理的关联

### 12.1 工单与问题的关系

**当前实现**：
- 工单（ServiceTicket）和问题（Issue）是两个独立的模块
- 工单可以关联到问题（通过 `ticket_id` 字段）
- ITR流程视图可以整合工单和问题数据

**关联方式**：
- 问题可以关联工单（`ticket_id`）
- ITR流程视图展示工单和问题的完整时间线

---

## 十三、数据统计和分析

### 13.1 工单统计

**统计维度**：
- 按状态统计（PENDING、IN_PROGRESS、RESOLVED、CLOSED）
- 按紧急程度统计（LOW、MEDIUM、HIGH、URGENT）
- 按问题类型统计
- 按项目统计
- 按客户统计

**时间统计**：
- 平均响应时间
- 平均解决时间
- 今日新增工单
- 今日解决工单
- 今日关闭工单

### 13.2 ITR效率分析

**分析内容**：
- 问题解决时间分析
- 客户满意度趋势
- 流程瓶颈识别
- SLA达成率分析

---

## 十四、总结

### 14.1 核心特点

1. **自动化流程**
   - ✅ 自动创建SLA监控
   - ✅ 自动记录时间点
   - ✅ 自动同步SLA状态
   - ✅ 自动提取知识

2. **完整的时间线记录**
   - ✅ 记录所有关键操作
   - ✅ 可追溯工单处理全过程

3. **SLA保障机制**
   - ✅ 自动匹配SLA策略
   - ✅ 实时监控SLA状态
   - ✅ 预警和超时提醒

4. **知识沉淀机制**
   - ✅ 自动提取解决方案
   - ✅ 生成知识库文章
   - ✅ 创建解决方案模板

### 14.2 处理流程完整性

**从创建到关闭的完整流程**：
1. ✅ 创建工单 → 自动创建SLA监控
2. ✅ 分配工单 → 记录响应时间 → 同步SLA
3. ✅ 处理工单 → 更新状态 → 同步SLA
4. ✅ 关闭工单 → 记录解决方案 → 同步SLA → 提取知识

**所有关键环节都有自动化处理，确保数据完整性和流程规范性。**

---

**文档版本**：v1.0  
**创建日期**：2026-01-15  
**最后更新**：2026-01-15

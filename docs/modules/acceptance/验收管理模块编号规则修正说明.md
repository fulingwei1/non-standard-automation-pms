# 验收管理模块编号规则修正说明

## 修改日期
2025-01-15

## 修改内容

### 1. 验收单编号规则修正 ✅

#### 修改前
- 格式：`AC-yymmdd-xxx`
- 示例：`AC-250115-001`

#### 修改后（符合设计文档）
- **FAT验收单**：`FAT-{项目编号}-{设备序号}-{序号}`
  - 示例：`FAT-P2025001-M01-001`
- **SAT验收单**：`SAT-{项目编号}-{设备序号}-{序号}`
  - 示例：`SAT-P2025001-M01-001`
- **终验收单**：`FIN-{项目编号}-{序号}`
  - 示例：`FIN-P2025001-001`

#### 实现细节
- 函数签名变更：`generate_order_no(db, acceptance_type, project_code, machine_no=None)`
- 自动根据验收类型选择前缀（FAT/SAT/FIN）
- FAT和SAT验收必须提供设备序号，终验收不需要
- 设备序号格式：`M01`, `M02`, ...（M + 两位数字）

### 2. 问题编号规则修正 ✅

#### 修改前
- 格式：`IS-yymmdd-xxx`
- 示例：`IS-250115-001`

#### 修改后（符合设计文档）
- 格式：`AI-{验收单号后缀}-{序号}`
- 示例：`AI-FAT001-001`（对应验收单号 `FAT-P2025001-M01-001`）

#### 实现细节
- 函数签名变更：`generate_issue_no(db, order_no)`
- 从验收单号提取前缀（FAT/SAT/FIN）和最后序号部分
- 后缀格式：`{前缀}{序号}`，例如 `FAT001`, `SAT002`, `FIN001`
- 序号部分保留3位数字格式（001, 002, ...）

## 代码修改位置

### 文件
`app/api/v1/endpoints/acceptance.py`

### 修改的函数

1. **`generate_order_no()`** (第45-100行)
   - 完全重写，支持按验收类型生成不同格式的编号
   - 需要传入：`acceptance_type`, `project_code`, `machine_no`

2. **`generate_issue_no()`** (第103-145行)
   - 完全重写，基于验收单号生成问题编号
   - 需要传入：`order_no`

### 调用的地方

1. **创建验收单** (`create_acceptance_order`, 第607行)
   ```python
   order_no = generate_order_no(
       db=db,
       acceptance_type=order_in.acceptance_type,
       project_code=project.project_code,
       machine_no=machine_no
   )
   ```

2. **创建验收问题** (`create_acceptance_issue`, 第1071行)
   ```python
   issue_no = generate_issue_no(db, order.order_no)
   ```

## 业务规则变更

### 新增验证
- FAT和SAT验收单创建时必须提供设备ID，否则会抛出异常
- 终验收单不需要设备ID

### 编号唯一性保证
- 验收单编号：基于项目编号、设备序号（如适用）、验收类型和序号保证唯一性
- 问题编号：基于验收单号后缀和序号保证唯一性

## 示例

### 验收单编号示例

```python
# FAT验收单
项目编号: P2025001
设备序号: 1
生成编号: FAT-P2025001-M01-001

# SAT验收单
项目编号: P2025001
设备序号: 2
生成编号: SAT-P2025001-M02-001

# 终验收单
项目编号: P2025001
生成编号: FIN-P2025001-001
```

### 问题编号示例

```python
# 验收单号: FAT-P2025001-M01-001
# 生成问题编号: AI-FAT001-001

# 验收单号: SAT-P2025001-M01-002
# 生成问题编号: AI-SAT002-001

# 验收单号: FIN-P2025001-001
# 生成问题编号: AI-FIN001-001
```

## 兼容性说明

### 向后兼容
- ⚠️ **不兼容**：新的编号格式与旧格式完全不同
- 如果数据库中已有旧格式的验收单，需要迁移数据

### 数据迁移建议
如果需要保留历史数据，建议：
1. 创建数据迁移脚本，将旧编号格式转换为新格式
2. 或者保留旧编号，新创建的验收单使用新格式

## 测试建议

### 单元测试
建议测试以下场景：
1. FAT验收单编号生成（有设备）
2. SAT验收单编号生成（有设备）
3. 终验收单编号生成（无设备）
4. 同一项目同一设备的多个验收单序号递增
5. 问题编号生成（基于不同格式的验收单号）
6. 错误处理（FAT/SAT验收缺少设备时抛出异常）

### 集成测试
1. 创建FAT验收单，验证编号格式
2. 创建SAT验收单，验证编号格式
3. 创建终验收单，验证编号格式
4. 创建验收问题，验证编号格式
5. 验证编号唯一性

## 相关文档
- 设计文档：`claude 设计方案/验收管理模块_详细设计文档.md` (第986-1004行)
- 评估报告：`验收管理模块完成情况评估.md`

## 状态
✅ **已完成** - 编号规则已修正，符合设计文档要求

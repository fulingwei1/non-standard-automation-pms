# 变更管理模块(ECN) - 有序推进计划

> 创建日期：2025-01-15  
> 当前状态：后端核心功能已完成 ✅，前端基础功能已实现 ✅  
> 目标：完成ECN模块的全面实现和优化

---

## 一、当前状态评估

### 1.1 已完成功能 ✅

#### 后端（完成度：95%）
- ✅ 数据模型设计（8个核心表）
- ✅ 数据库迁移文件（SQLite + MySQL）
- ✅ Schema定义（完整的Pydantic模型）
- ✅ API端点（48+个端点）
  - ECN基础管理（6个）
  - 评估管理（5个）
  - 审批管理（5个）
  - 任务管理（4个）
  - 受影响物料/订单CRUD（6个）
  - 执行流程（3个）
  - 类型配置管理（5个）
  - 超时提醒（1个）
  - 模块集成（3个）
  - 日志追溯（2个）
  - 统计分析（1个）
- ✅ 自动触发评估/审批流程
- ✅ 超时提醒功能
- ✅ 与BOM/采购/项目模块集成

#### 前端（完成度：70%）
- ✅ ECN管理主页面（列表、创建、详情）
- ✅ 评估管理界面（多部门评估）
- ✅ 审批流程可视化
- ✅ 执行任务看板
- ✅ 变更日志查看
- ✅ 影响分析展示

### 1.2 待完善功能 ⏳

#### 后端（5%）
- ⏳ 定时任务（自动检查超时、发送提醒）
- ⏳ 通知集成（评估/审批/执行通知）
- ⏳ 批量操作优化
- ⏳ 性能优化（查询优化、缓存）

#### 前端（30%）
- ⏳ ECN类型配置管理页面
- ⏳ 受影响物料/订单管理界面
- ⏳ 超时提醒页面
- ⏳ ECN统计报表页面
- ⏳ 模块集成操作界面
- ⏳ 移动端适配

---

## 二、分阶段推进计划

### 阶段一：核心功能完善（优先级：P0）⏳

**目标**：确保ECN核心流程完整可用

**时间估算**：3-5天

#### 任务清单

1. **前端：受影响物料/订单管理界面** ⏳
   - [ ] 受影响物料列表页面
   - [ ] 添加/编辑受影响物料对话框
   - [ ] 受影响订单列表页面
   - [ ] 添加/编辑受影响订单对话框
   - [ ] 物料变更前后对比展示

2. **前端：ECN类型配置管理页面** ⏳
   - [ ] ECN类型列表页面
   - [ ] 创建/编辑ECN类型对话框
   - [ ] 审批矩阵配置界面
   - [ ] 评估部门配置界面

3. **后端：定时任务服务** ⏳
   - [ ] 超时检查定时任务
   - [ ] 自动发送超时提醒
   - [ ] 评估/审批到期提醒

4. **测试与验证** ⏳
   - [ ] 完整流程端到端测试
   - [ ] API接口测试
   - [ ] 前端功能测试
   - [ ] 数据一致性验证

**验收标准**：
- ✅ 可以完整走通ECN全生命周期流程
- ✅ 所有核心API正常工作
- ✅ 前端所有核心页面可用
- ✅ 无严重bug

---

### 阶段二：用户体验优化（优先级：P1）⏳

**目标**：提升用户体验和操作效率

**时间估算**：2-3天

#### 任务清单

1. **前端：超时提醒页面** ⏳
   - [ ] 超时提醒列表页面
   - [ ] 提醒详情展示
   - [ ] 批量处理超时事项
   - [ ] 提醒设置配置

2. **前端：ECN统计报表页面** ⏳
   - [ ] ECN统计概览（数量、状态分布）
   - [ ] 成本影响统计图表
   - [ ] 工期影响统计图表
   - [ ] 类型分布统计
   - [ ] 趋势分析图表

3. **前端：模块集成操作界面** ⏳
   - [ ] BOM同步操作界面
   - [ ] 项目同步操作界面
   - [ ] 采购同步操作界面
   - [ ] 同步历史记录查看

4. **前端：操作优化** ⏳
   - [ ] 批量操作（批量审批、批量创建任务）
   - [ ] 快捷操作（快速创建、快速审批）
   - [ ] 操作确认提示优化
   - [ ] 加载状态优化

**验收标准**：
- ✅ 用户可以方便地查看和处理超时事项
- ✅ 统计报表数据准确、图表清晰
- ✅ 模块集成操作简单直观
- ✅ 操作体验流畅

---

### 阶段三：高级功能实现（优先级：P2）⏳

**目标**：实现高级功能和自动化

**时间估算**：3-4天

#### 任务清单

1. **后端：通知集成** ⏳
   - [ ] 评估通知（评估任务分配、评估完成）
   - [ ] 审批通知（审批任务分配、审批结果）
   - [ ] 执行通知（任务分配、任务完成）
   - [ ] 超时提醒通知
   - [ ] 邮件/消息通知集成

2. **后端：自动分配功能** ⏳
   - [ ] 根据部门自动分配评估任务
   - [ ] 根据角色自动分配审批任务
   - [ ] 根据部门自动分配执行任务

3. **后端：批量操作优化** ⏳
   - [ ] 批量同步到BOM
   - [ ] 批量同步到项目
   - [ ] 批量同步到采购
   - [ ] 批量创建任务

4. **前端：高级功能界面** ⏳
   - [ ] 批量操作界面
   - [ ] 自动分配配置界面
   - [ ] 通知设置界面

**验收标准**：
- ✅ 通知及时准确
- ✅ 自动分配功能正常工作
- ✅ 批量操作高效可靠

---

### 阶段四：性能优化与扩展（优先级：P3）⏳

**目标**：优化性能和扩展功能

**时间估算**：2-3天

#### 任务清单

1. **后端：性能优化** ⏳
   - [ ] 查询优化（添加索引、优化SQL）
   - [ ] 缓存机制（ECN类型配置、审批矩阵）
   - [ ] 分页优化（大数据量处理）
   - [ ] 批量操作性能优化

2. **后端：扩展功能** ⏳
   - [ ] 并行审批支持
   - [ ] 条件审批支持
   - [ ] 审批流程自定义
   - [ ] ECN模板功能

3. **前端：性能优化** ⏳
   - [ ] 虚拟滚动（长列表优化）
   - [ ] 懒加载（按需加载数据）
   - [ ] 数据缓存
   - [ ] 移动端适配

4. **文档与测试** ⏳
   - [ ] API文档完善
   - [ ] 用户使用手册
   - [ ] 单元测试补充
   - [ ] 集成测试补充

**验收标准**：
- ✅ 性能指标达标（响应时间、并发能力）
- ✅ 扩展功能可用
- ✅ 文档完整准确

---

## 三、详细任务分解

### 3.1 阶段一详细任务

#### 任务1.1：受影响物料/订单管理界面

**前端文件**：`frontend/src/pages/ECNManagement.jsx`

**具体实现**：
1. 在ECN详情页的"影响分析"标签中添加：
   - 受影响物料列表（表格展示）
   - "添加物料"按钮
   - 编辑/删除操作
   - 物料变更前后对比展示

2. 创建受影响物料对话框：
   - 物料选择（支持搜索）
   - 变更类型选择
   - 变更前后信息填写
   - 成本影响输入

3. 受影响订单管理：
   - 订单列表展示
   - 添加订单对话框
   - 订单处理方式选择

**API集成**：
- `POST /api/v1/ecns/{id}/affected-materials`
- `PUT /api/v1/ecns/{id}/affected-materials/{id}`
- `DELETE /api/v1/ecns/{id}/affected-materials/{id}`
- `POST /api/v1/ecns/{id}/affected-orders`
- `PUT /api/v1/ecns/{id}/affected-orders/{id}`
- `DELETE /api/v1/ecns/{id}/affected-orders/{id}`

**预计工作量**：1天

---

#### 任务1.2：ECN类型配置管理页面

**前端文件**：`frontend/src/pages/ECNTypeManagement.jsx`（新建）

**具体实现**：
1. ECN类型列表页面：
   - 类型列表（表格展示）
   - 搜索、筛选功能
   - 创建、编辑、删除操作

2. 创建/编辑类型对话框：
   - 基本信息（编码、名称、描述）
   - 必需评估部门选择（多选）
   - 可选评估部门选择（多选）
   - 审批矩阵配置（JSON编辑器或表单）

3. 审批矩阵配置界面：
   - 条件类型选择（成本/工期）
   - 条件范围设置
   - 审批层级和角色配置

**API集成**：
- `GET /api/v1/ecn-types`
- `GET /api/v1/ecn-types/{id}`
- `POST /api/v1/ecn-types`
- `PUT /api/v1/ecn-types/{id}`
- `DELETE /api/v1/ecn-types/{id}`

**预计工作量**：1.5天

---

#### 任务1.3：定时任务服务

**后端文件**：`app/services/ecn_scheduler.py`（新建）

**具体实现**：
1. 超时检查任务：
   - 每天定时检查评估超时
   - 每天定时检查审批超时
   - 每天定时检查任务超时
   - 更新超时标识

2. 提醒发送任务：
   - 发送评估超时提醒
   - 发送审批超时提醒
   - 发送任务超时提醒

3. 定时任务配置：
   - 使用APScheduler或Celery
   - 配置任务执行时间
   - 任务执行日志

**集成方式**：
- 在应用启动时注册定时任务
- 或使用独立的定时任务服务

**预计工作量**：1天

---

#### 任务1.4：测试与验证

**测试内容**：
1. 端到端测试：
   - 创建ECN → 提交 → 评估 → 审批 → 执行 → 关闭
   - 测试异常流程（驳回、取消）

2. API测试：
   - 所有新增API端点测试
   - 参数验证测试
   - 权限测试

3. 前端测试：
   - 页面功能测试
   - 交互测试
   - 数据展示测试

**预计工作量**：1天

---

### 3.2 阶段二详细任务

#### 任务2.1：超时提醒页面

**前端文件**：`frontend/src/pages/ECNOverdueAlerts.jsx`（新建）

**功能**：
- 超时提醒列表（按类型分组）
- 提醒详情展示
- 批量处理（标记已处理）
- 跳转到对应ECN详情

**预计工作量**：0.5天

---

#### 任务2.2：ECN统计报表页面

**前端文件**：`frontend/src/pages/ECNStatistics.jsx`（新建）

**功能**：
- 使用图表库（如recharts）展示统计
- 数量统计（总数、各状态数量）
- 成本影响统计（总成本、平均成本）
- 工期影响统计（总工期、平均工期）
- 类型分布（饼图）
- 趋势分析（折线图）

**预计工作量**：1天

---

#### 任务2.3：模块集成操作界面

**前端实现**：
- 在ECN详情页添加"模块集成"标签
- BOM同步按钮和结果展示
- 项目同步按钮和结果展示
- 采购同步按钮和结果展示
- 同步历史记录

**预计工作量**：0.5天

---

### 3.3 阶段三详细任务

#### 任务3.1：通知集成

**后端实现**：
- 集成通知服务（如邮件、消息推送）
- 在关键节点发送通知：
  - ECN提交时 → 通知评估人员
  - 评估完成时 → 通知审批人员
  - 审批完成时 → 通知执行人员
  - 任务分配时 → 通知任务负责人
  - 超时时 → 通知相关人员

**预计工作量**：1.5天

---

#### 任务3.2：自动分配功能

**后端实现**：
- 根据部门自动分配评估任务
- 根据角色自动分配审批任务
- 根据部门自动分配执行任务
- 支持分配规则配置

**预计工作量**：1天

---

### 3.4 阶段四详细任务

#### 任务4.1：性能优化

**后端优化**：
- 添加数据库索引
- 优化复杂查询
- 实现缓存机制
- 批量操作优化

**前端优化**：
- 虚拟滚动
- 懒加载
- 数据缓存

**预计工作量**：1.5天

---

## 四、实施优先级

### P0（立即实施）
1. ✅ 受影响物料/订单管理界面
2. ✅ ECN类型配置管理页面
3. ✅ 定时任务服务
4. ✅ 测试与验证

### P1（近期实施）
1. ⏳ 超时提醒页面
2. ⏳ ECN统计报表页面
3. ⏳ 模块集成操作界面
4. ⏳ 操作优化

### P2（后续实施）
1. ⏳ 通知集成
2. ⏳ 自动分配功能
3. ⏳ 批量操作优化

### P3（优化阶段）
1. ⏳ 性能优化
2. ⏳ 扩展功能
3. ⏳ 文档完善

---

## 五、里程碑计划

### 里程碑1：核心功能完成（目标：1周内）
- ✅ 阶段一所有任务完成
- ✅ 核心流程可用
- ✅ 基础测试通过

### 里程碑2：用户体验优化（目标：2周内）
- ✅ 阶段二所有任务完成
- ✅ 用户体验良好
- ✅ 统计报表可用

### 里程碑3：高级功能实现（目标：3周内）
- ✅ 阶段三所有任务完成
- ✅ 自动化功能可用
- ✅ 通知功能正常

### 里程碑4：性能优化完成（目标：4周内）
- ✅ 阶段四所有任务完成
- ✅ 性能指标达标
- ✅ 文档完整

---

## 六、风险与应对

### 6.1 技术风险

**风险**：定时任务服务集成复杂
**应对**：使用成熟的定时任务库（APScheduler），简化集成

**风险**：通知集成可能影响性能
**应对**：使用异步任务队列，避免阻塞主流程

### 6.2 业务风险

**风险**：自动分配规则可能不准确
**应对**：提供手动调整功能，支持规则配置

**风险**：模块集成可能影响数据一致性
**应对**：使用事务保证数据一致性，提供回滚功能

### 6.3 时间风险

**风险**：任务估算可能不准确
**应对**：预留缓冲时间，优先完成核心功能

---

## 七、下一步行动

### 立即开始（今天）

1. **创建任务清单**
   - [ ] 在项目管理工具中创建任务
   - [ ] 分配任务优先级
   - [ ] 设置里程碑

2. **开始阶段一任务1.1**
   - [ ] 设计受影响物料管理界面
   - [ ] 实现物料列表展示
   - [ ] 实现添加/编辑对话框

3. **准备开发环境**
   - [ ] 确认API端点可用
   - [ ] 准备测试数据
   - [ ] 配置开发工具

### 本周计划

- **周一-周二**：完成受影响物料/订单管理界面
- **周三-周四**：完成ECN类型配置管理页面
- **周五**：实现定时任务服务，开始测试

### 下周计划

- **周一-周二**：完成测试与验证，修复bug
- **周三-周四**：开始阶段二任务（超时提醒、统计报表）
- **周五**：完成模块集成操作界面

---

## 八、成功标准

### 功能完整性
- ✅ 所有核心功能可用
- ✅ 所有API端点正常工作
- ✅ 前端所有页面可用

### 用户体验
- ✅ 操作流程顺畅
- ✅ 界面友好直观
- ✅ 响应速度快

### 代码质量
- ✅ 代码规范统一
- ✅ 注释完整
- ✅ 无严重bug

### 文档完整性
- ✅ API文档完整
- ✅ 用户手册完整
- ✅ 技术文档完整

---

**文档版本**：v1.0  
**最后更新**：2025-01-15  
**负责人**：开发团队  
**预计完成时间**：4周







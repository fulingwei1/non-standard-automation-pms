# 变更管理模块 - 权限集成总结

> 完成日期：2025-01-15  
> 状态：权限集成已完成 ✅

---

## 一、完成内容

### ✅ 1. ECN模块权限定义

将ECN从 `project` 模块中独立出来，创建独立的 `ecn` 模块权限。

**权限迁移脚本**：
- `migrations/20260115_ecn_permissions_sqlite.sql` - SQLite权限配置
- `migrations/20260115_ecn_permissions_mysql.sql` - MySQL权限配置

**注意**：迁移脚本兼容新旧两种表结构（`perm_code` 或 `permission_code`），根据实际表结构自动适配。

**权限分类**：
- **ECN基础权限**：查看、创建、修改、提交、取消、删除
- **评估权限**：查看、创建、提交评估
- **审批权限**：查看、通过、驳回
- **执行权限**：查看、创建、更新、完成任务
- **影响分析权限**：查看、管理受影响物料和订单
- **模块集成权限**：BOM同步、项目同步、采购同步
- **配置权限**：类型配置、审批矩阵配置
- **统计权限**：统计查看、超时提醒查看

**权限编码规范**：
```
ecn:{resource}:{action}
例如：
- ecn:ecn:read - ECN查看
- ecn:evaluation:create - 评估创建
- ecn:approval:approve - 审批通过
```

---

### ✅ 2. 角色权限分配

根据各角色的职责，分配相应的ECN权限：

| 角色 | 权限范围 | 说明 |
|------|---------|------|
| **系统管理员 (ADMIN)** | 所有ECN权限 | 完整的管理权限 |
| **总经理 (GM)** | 查看、审批、统计 | 决策层，关注审批和统计 |
| **项目经理 (PM)** | ECN全流程管理 | 自己项目的ECN全流程管理 |
| **计划管理 (PMC)** | 查看、评估、执行、同步 | 负责评估影响和执行协调 |
| **工程师 (ENGINEER)** | 创建、查看、评估、执行 | 执行层，创建和执行ECN |
| **质量工程师 (QA)** | 查看、评估、审批 | 质量把关，评估和审批 |
| **采购专员 (PURCHASER)** | 查看、评估、采购同步 | 评估采购影响，同步采购订单 |
| **财务专员 (FINANCE)** | 查看、审批、统计 | 成本审批和统计查看 |

---

### ✅ 3. 通知系统集成

通知系统已完整集成到ECN流程中，会自动发送通知给相关人员：

**通知触发点**：
1. **ECN提交时** → 通知申请人，抄送项目相关人员
2. **评估任务分配时** → 通知评估人员，抄送项目相关人员
3. **评估完成时** → 通知申请人，抄送项目相关人员
4. **审批任务分配时** → 通知审批人员，抄送项目相关人员
5. **审批结果时** → 通知申请人，抄送项目相关人员
6. **任务分配时** → 通知执行人员，抄送项目相关人员
7. **任务完成时** → 通知申请人，抄送项目相关人员
8. **超时提醒时** → 通知相关人员

**通知接收人确定**：
- **直接接收人**：
  - **评估人员**：根据评估部门自动查找用户，优先选择项目相关的部门负责人
  - **审批人员**：根据审批角色自动查找用户，优先选择项目相关的角色负责人
  - **执行人员**：根据任务部门自动查找用户，优先选择项目相关的部门负责人
  - **申请人**：ECN的申请人
- **抄送接收人**：
  - **项目相关人员**：如果ECN关联了项目，自动抄送给所有项目成员（排除直接接收人，避免重复通知）
- **超时提醒**：根据提醒类型确定通知对象（评估人/审批人/执行人）

---

## 二、文件清单

### 新建文件
- ✅ `migrations/20260115_ecn_permissions_sqlite.sql` - SQLite权限配置
- ✅ `migrations/20260115_ecn_permissions_mysql.sql` - MySQL权限配置

### 已有文件（已实现）
- ✅ `app/services/ecn_notification_service.py` - ECN通知服务
- ✅ `app/services/ecn_auto_assign_service.py` - ECN自动分配服务
- ✅ `app/api/v1/endpoints/ecn.py` - ECN API端点（已集成通知）

---

## 三、权限列表

### ECN基础权限（6个）
- `ecn:ecn:read` - ECN查看
- `ecn:ecn:create` - ECN创建
- `ecn:ecn:update` - ECN修改
- `ecn:ecn:submit` - ECN提交
- `ecn:ecn:cancel` - ECN取消
- `ecn:ecn:delete` - ECN删除

### 评估权限（3个）
- `ecn:evaluation:read` - 评估查看
- `ecn:evaluation:create` - 评估创建
- `ecn:evaluation:submit` - 评估提交

### 审批权限（3个）
- `ecn:approval:read` - 审批查看
- `ecn:approval:approve` - 审批通过
- `ecn:approval:reject` - 审批驳回

### 执行权限（4个）
- `ecn:task:read` - 任务查看
- `ecn:task:create` - 任务创建
- `ecn:task:update` - 任务更新
- `ecn:task:complete` - 任务完成

### 影响分析权限（2个）
- `ecn:affected:read` - 影响分析查看
- `ecn:affected:manage` - 影响分析管理

### 模块集成权限（3个）
- `ecn:sync:bom` - BOM同步
- `ecn:sync:project` - 项目同步
- `ecn:sync:purchase` - 采购同步

### 配置权限（4个）
- `ecn:type:read` - 类型配置查看
- `ecn:type:manage` - 类型配置管理
- `ecn:matrix:read` - 审批矩阵查看
- `ecn:matrix:manage` - 审批矩阵管理

### 统计权限（2个）
- `ecn:statistics:read` - 统计查看
- `ecn:alert:read` - 超时提醒查看

**总计：27个权限**

---

## 四、使用说明

### 4.1 执行权限迁移

**SQLite**：
```bash
sqlite3 data/app.db < migrations/20260115_ecn_permissions_sqlite.sql
```

**MySQL**：
```bash
mysql -u username -p database_name < migrations/20260115_ecn_permissions_mysql.sql
```

或在Python中执行：
```python
from app.models.base import get_db_session
with open('migrations/20260115_ecn_permissions_sqlite.sql', 'r') as f:
    sql = f.read()
    with get_db_session() as db:
        db.execute(sql)
        db.commit()
```

### 4.2 权限验证

系统会自动根据用户角色验证权限。在API端点中，可以通过以下方式检查权限：

```python
from app.core.security import require_permission

@router.post("/ecns", ...)
@require_permission("ecn:ecn:create")
def create_ecn(...):
    ...
```

### 4.3 通知自动发送

通知会在以下场景自动发送：
1. ECN提交 → 自动分配评估任务 → 发送通知给评估人员
2. 评估完成 → 自动分配审批任务 → 发送通知给审批人员
3. 审批通过 → 自动分配执行任务 → 发送通知给执行人员
4. 任务完成 → 发送通知给申请人
5. 超时提醒 → 发送通知给相关人员

---

## 五、角色权限矩阵

| 权限 | ADMIN | GM | PM | PMC | ENGINEER | QA | PURCHASER | FINANCE |
|------|:-----:|:--:|:--:|:---:|:--------:|:--:|:---------:|:-------:|
| ECN查看 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| ECN创建 | ✅ | ❌ | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ |
| ECN修改 | ✅ | ❌ | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ |
| ECN提交 | ✅ | ❌ | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ |
| ECN取消 | ✅ | ❌ | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ |
| ECN删除 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 评估创建 | ✅ | ❌ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| 评估提交 | ✅ | ❌ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| 审批通过 | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ❌ | ✅ |
| 审批驳回 | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ❌ | ✅ |
| 任务创建 | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| 任务完成 | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| BOM同步 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 项目同步 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 采购同步 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ | ✅ | ❌ |
| 类型配置管理 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 审批矩阵管理 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 统计查看 | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ | ✅ |
| 超时提醒查看 | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ | ❌ |

---

## 六、通知流程

### 6.1 ECN提交流程

```
用户提交ECN
  ↓
系统自动创建评估记录（根据ECN类型配置）
  ↓
系统自动分配评估人员（根据部门）
  ↓
发送通知给评估人员 ✅
  ↓
评估人员完成评估
  ↓
发送通知给申请人和审批人员 ✅
  ↓
系统自动创建审批记录（根据审批矩阵）
  ↓
系统自动分配审批人员（根据角色）
  ↓
发送通知给审批人员 ✅
```

### 6.2 审批流程

```
审批人员审批ECN
  ↓
发送通知给申请人 ✅
  ↓
如果审批通过：
  - 系统自动创建执行任务
  - 系统自动分配执行人员（根据部门）
  - 发送通知给执行人员 ✅
```

### 6.3 执行流程

```
执行人员完成任务
  ↓
发送通知给申请人 ✅
  ↓
所有任务完成后：
  - 更新ECN状态为已完成
```

---

## 七、自动分配规则

### 7.1 评估任务分配

- **查找方式**：根据评估部门名称查找用户
- **优先级**：部门负责人 > 其他用户
- **判断标准**：职位包含"负责人"、"经理"、"主管"

### 7.2 审批任务分配

- **查找方式**：根据审批角色名称查找用户
- **优先级**：项目相关用户 > 其他用户

### 7.3 执行任务分配

- **查找方式**：根据任务部门名称查找用户
- **优先级**：部门负责人 > 其他用户
- **判断标准**：职位包含"负责人"、"经理"、"主管"

---

## 八、下一步优化

### 8.1 权限控制增强
- ⏳ 在API端点中添加权限检查装饰器
- ⏳ 前端根据权限显示/隐藏功能按钮
- ⏳ 数据权限控制（只能查看自己项目的ECN）

### 8.2 通知增强
- ⏳ 邮件通知集成
- ⏳ 微信通知集成
- ⏳ 短信通知集成
- ⏳ 通知设置（免打扰时间、通知偏好）

### 8.3 自动分配增强
- ⏳ 分配规则配置（负载均衡、轮询分配）
- ⏳ 分配历史记录
- ⏳ 分配失败处理（通知管理员）

---

**文档版本**：v1.0  
**最后更新**：2025-01-15  
**完成度**：权限集成 100%


# 变更管理模块 - 通知抄送功能说明

> 更新日期：2025-01-15  
> 状态：项目相关人员抄送功能已实现 ✅

---

## 一、功能概述

ECN变更通知系统已实现**项目相关人员自动抄送**功能。当ECN关联了项目时，系统会自动将变更通知抄送给所有项目成员，确保项目相关人员及时了解变更情况。

### 1.1 通知存储位置

**数据库表**：`notifications` 表
- 每个通知记录包含 `user_id` 字段，表示接收用户
- 抄送通知也是独立的通知记录，存储在同一个表中
- 通过 `extra_data` 字段中的 `is_cc: true` 标记区分抄送通知

### 1.2 通知显示位置

**前端页面**：`/notifications` 或 `/notification-center`
- 页面组件：`frontend/src/pages/NotificationCenter.jsx`
- 所有通知（包括直接通知和抄送通知）都显示在通知中心
- 抄送通知通过标题中的"（抄送）"标记和"抄送"标签区分显示

---

## 二、抄送规则

### 2.1 抄送条件

- ✅ ECN必须关联了项目（`ecn.project_id` 不为空）
- ✅ 项目成员必须为活跃状态（`ProjectMember.is_active == True`）
- ✅ 排除直接接收人，避免重复通知

### 2.2 抄送场景

以下场景会自动抄送项目相关人员：

1. **ECN提交时** - 抄送项目成员，通知项目有新的变更申请
2. **评估任务分配时** - 抄送项目成员，通知评估任务已分配
3. **评估完成时** - 抄送项目成员，通知评估结果
4. **审批任务分配时** - 抄送项目成员，通知审批任务已分配
5. **审批结果时** - 抄送项目成员，通知审批结果
6. **执行任务分配时** - 抄送项目成员，通知执行任务已分配
7. **执行任务完成时** - 抄送项目成员，通知任务完成情况

---

## 三、通知类型

### 3.1 直接通知 vs 抄送通知

**直接通知**：
- 发送给直接相关人员（评估人、审批人、执行人、申请人）
- 优先级：HIGH 或 URGENT
- 标题：不带"（抄送）"标记

**抄送通知**：
- 发送给项目相关人员
- 优先级：NORMAL
- 标题：带"（抄送）"标记
- 内容：包含"请关注项目变更..."等提示

### 3.2 通知标记

抄送通知在 `extra_data` 中包含 `"is_cc": True` 标记，用于前端区分直接通知和抄送通知。

---

## 四、实现细节

### 4.1 ECN提交时抄送

```python
# 通知申请人
if ecn.applicant_id:
    create_ecn_notification(...)

# 抄送项目相关人员
if ecn.project_id:
    project_members = db.query(ProjectMember).filter(
        ProjectMember.project_id == ecn.project_id,
        ProjectMember.is_active == True,
        ProjectMember.user_id != ecn.applicant_id  # 排除申请人
    ).all()
    
    for member in project_members:
        create_ecn_notification(
            ...,
            title=f"ECN已提交（抄送）：{ecn.ecn_no}",
            extra_data={"is_cc": True}
        )
```

### 4.2 评估任务分配时抄送

```python
# 通知评估人员
create_ecn_notification(user_id=evaluator_id, ...)

# 抄送项目相关人员（排除评估人员）
if ecn.project_id:
    project_members = db.query(ProjectMember).filter(
        ProjectMember.project_id == ecn.project_id,
        ProjectMember.is_active == True,
        ProjectMember.user_id != evaluator_id  # 排除评估人员
    ).all()
    
    for member in project_members:
        create_ecn_notification(
            ...,
            title=f"ECN评估任务分配（抄送）：{ecn.ecn_no}",
            extra_data={"is_cc": True}
        )
```

### 4.3 其他场景类似

所有通知场景都遵循相同的抄送逻辑：
1. 先发送直接通知给相关人员
2. 如果ECN关联了项目，查找项目成员
3. 排除直接接收人，避免重复通知
4. 发送抄送通知给项目成员

---

## 五、通知内容示例

### 5.1 ECN提交抄送通知

**标题**：`ECN已提交（抄送）：ECN20250115001`

**内容**：
```
项目相关的ECN ECN20250115001 已提交，已进入评估流程。

ECN标题：修改机械结构
变更类型：设计变更
变更原因：客户要求优化结构

请关注项目变更情况。
```

### 5.2 评估完成抄送通知

**标题**：`ECN评估完成（抄送）：ECN20250115001`

**内容**：
```
ECN ECN20250115001 的机械部评估已完成。

评估结论：同意
成本估算：¥5000
工期估算：3天

请关注项目变更影响。
```

### 5.3 审批结果抄送通知

**标题**：`ECN审批结果（抄送）：ECN20250115001`

**内容**：
```
ECN ECN20250115001 的第1级审批（项目经理）通过。

审批意见：同意变更，请尽快执行

请关注项目变更影响。
```

---

## 六、排除规则

### 6.1 避免重复通知

系统会自动排除以下人员，避免重复通知：

| 通知场景 | 直接接收人 | 排除规则 |
|---------|-----------|---------|
| ECN提交 | 申请人 | 排除申请人 |
| 评估任务分配 | 评估人员 | 排除评估人员 |
| 评估完成 | 申请人 | 排除申请人 |
| 审批任务分配 | 审批人员 | 排除审批人员 |
| 审批结果 | 申请人 | 排除申请人 |
| 执行任务分配 | 执行人员 | 排除执行人员 |
| 执行任务完成 | 申请人 | 排除申请人 |

### 6.2 特殊情况

- 如果评估人员/审批人员/执行人员本身就是项目成员，他们只会收到直接通知，不会收到抄送通知
- 如果申请人不是项目成员，项目成员会收到抄送通知
- 如果申请人也是项目成员，项目成员会收到抄送通知（申请人除外）

---

## 七、通知优先级

| 通知类型 | 直接通知优先级 | 抄送通知优先级 |
|---------|--------------|--------------|
| ECN提交 | NORMAL | NORMAL |
| 评估任务分配 | HIGH | NORMAL |
| 评估完成 | NORMAL | NORMAL |
| 审批任务分配 | HIGH/URGENT | NORMAL |
| 审批结果 | HIGH/NORMAL | HIGH/NORMAL |
| 执行任务分配 | HIGH/URGENT | NORMAL |
| 执行任务完成 | NORMAL | NORMAL |

---

## 八、前端显示建议

### 8.1 通知列表显示

建议在前端通知列表中：
- 直接通知：正常显示，高亮显示
- 抄送通知：可以显示"抄送"标签，或使用不同的样式

### 8.2 通知过滤

可以添加过滤选项：
- 显示所有通知
- 仅显示直接通知
- 仅显示抄送通知

---

## 九、代码实现位置

**文件**：`app/services/ecn_notification_service.py`

**函数**：
- `notify_ecn_submitted()` - ECN提交通知（已实现抄送）
- `notify_evaluation_assigned()` - 评估任务分配通知（已实现抄送）
- `notify_evaluation_completed()` - 评估完成通知（已实现抄送）
- `notify_approval_assigned()` - 审批任务分配通知（已实现抄送）
- `notify_approval_result()` - 审批结果通知（已实现抄送）
- `notify_task_assigned()` - 执行任务分配通知（已实现抄送）
- `notify_task_completed()` - 执行任务完成通知（已实现抄送）

---

## 十、测试建议

### 10.1 测试场景

1. **ECN关联项目**：
   - 创建ECN并关联项目
   - 提交ECN
   - 验证项目成员是否收到抄送通知

2. **ECN未关联项目**：
   - 创建ECN但不关联项目
   - 提交ECN
   - 验证只有直接接收人收到通知

3. **项目成员重叠**：
   - 评估人员是项目成员
   - 验证评估人员只收到直接通知，不收到抄送通知

4. **项目成员排除**：
   - 申请人也是项目成员
   - 验证申请人只收到直接通知，项目成员收到抄送通知（排除申请人）

---

**文档版本**：v1.0  
**最后更新**：2025-01-15  
**完成度**：项目相关人员抄送功能已实现 ✅


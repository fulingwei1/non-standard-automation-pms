# 奖金规则配置权限说明

## 一、权限概述

奖金激励体系的所有**配置功能**（创建、修改、删除、启用/停用规则）已限制为**仅人力资源经理可操作**，确保奖金规则的配置权限集中管理。

---

## 二、权限控制范围

### 2.1 需要权限的API端点

以下API端点已添加人力资源权限检查：

| 方法 | 路径 | 功能 | 权限要求 |
|------|------|------|---------|
| POST | `/api/v1/bonus/rules` | 创建奖金规则 | 人力资源经理 |
| PUT | `/api/v1/bonus/rules/{rule_id}` | 更新奖金规则 | 人力资源经理 |
| DELETE | `/api/v1/bonus/rules/{rule_id}` | 删除奖金规则 | 人力资源经理 |
| POST | `/api/v1/bonus/rules/{rule_id}/activate` | 启用奖金规则 | 人力资源经理 |
| POST | `/api/v1/bonus/rules/{rule_id}/deactivate` | 停用奖金规则 | 人力资源经理 |

### 2.2 无需权限的API端点（查询类）

以下API端点**无需特殊权限**，所有已登录用户都可以访问：

| 方法 | 路径 | 功能 | 权限要求 |
|------|------|------|---------|
| GET | `/api/v1/bonus/rules` | 查询奖金规则列表 | 所有用户 |
| GET | `/api/v1/bonus/rules/{rule_id}` | 查询奖金规则详情 | 所有用户 |
| GET | `/api/v1/bonus/calculations` | 查询奖金计算记录 | 所有用户 |
| GET | `/api/v1/bonus/distributions` | 查询奖金发放记录 | 所有用户 |
| GET | `/api/v1/bonus/my` | 查询我的奖金 | 所有用户 |

---

## 三、有权限的角色

以下角色可以配置奖金规则：

1. **hr_manager** - 人力资源经理（主要角色）
2. **人事经理** - 人力资源经理（中文角色名）
3. **hr** - 人力资源专员
4. **人事** - 人力资源专员（中文角色名）
5. **gm** - 总经理
6. **总经理** - 总经理（中文角色名）
7. **chairman** - 董事长
8. **董事长** - 董事长（中文角色名）
9. **admin** - 系统管理员
10. **super_admin** - 超级管理员

**注意**：超级管理员（`is_superuser=True`）自动拥有所有权限。

---

## 四、权限检查实现

### 4.1 权限检查函数

**文件**: `app/core/security.py`

```python
def has_hr_access(user: User) -> bool:
    """检查用户是否有人力资源管理模块的访问权限"""
    if user.is_superuser:
        return True
    
    hr_roles = [
        'hr_manager', '人事经理',
        'hr', '人事',
        'gm', '总经理',
        'chairman', '董事长',
        'admin', 'super_admin',
    ]
    
    for user_role in user.roles:
        role_code = user_role.role.role_code.lower() if user_role.role.role_code else ''
        role_name = user_role.role.role_name.lower() if user_role.role.role_name else ''
        if role_code in hr_roles or role_name in hr_roles:
            return True
    
    return False


def require_hr_access():
    """人力资源权限检查依赖"""
    async def hr_checker(current_user: User = Depends(get_current_active_user)):
        if not has_hr_access(current_user):
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="您没有权限访问人力资源配置功能，仅人力资源经理可以配置"
            )
        return current_user
    return hr_checker
```

### 4.2 API端点使用

**文件**: `app/api/v1/endpoints/bonus.py`

```python
@router.post("/rules", response_model=ResponseModel[BonusRuleResponse])
def create_bonus_rule(
    *,
    db: Session = Depends(deps.get_db),
    rule_in: BonusRuleCreate,
    current_user: User = Depends(security.require_hr_access),  # 权限检查
) -> Any:
    """创建奖金规则（仅人力资源经理可配置）"""
    # ... 实现代码
```

---

## 五、错误处理

### 5.1 无权限访问时的响应

当非人力资源经理用户尝试配置奖金规则时，系统会返回：

```json
{
  "detail": "您没有权限访问人力资源配置功能，仅人力资源经理可以配置"
}
```

HTTP状态码：`403 Forbidden`

### 5.2 前端处理建议

前端在调用配置API时，应该：

1. **菜单控制**：只有人力资源经理可以看到"奖金规则配置"菜单
2. **按钮控制**：配置按钮仅对人力资源经理显示
3. **错误提示**：捕获403错误，显示友好的提示信息

---

## 六、使用示例

### 6.1 创建奖金规则（人力资源经理）

```bash
POST /api/v1/bonus/rules
Authorization: Bearer <token>
Content-Type: application/json

{
  "rule_code": "SALES-001",
  "rule_name": "销售合同奖金",
  "bonus_type": "SALES_BASED",
  "coefficient": 2.0,
  "trigger_condition": {
    "contract_status": "SIGNED",
    "min_amount": 100000
  },
  "is_active": true
}
```

**响应**（成功）：
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 1,
    "rule_code": "SALES-001",
    ...
  }
}
```

**响应**（无权限）：
```json
{
  "detail": "您没有权限访问人力资源配置功能，仅人力资源经理可以配置"
}
```

### 6.2 查询奖金规则（所有用户）

```bash
GET /api/v1/bonus/rules?page=1&page_size=20
Authorization: Bearer <token>
```

所有已登录用户都可以查询，无需特殊权限。

---

## 七、权限扩展

如果需要为其他角色添加配置权限，可以修改 `has_hr_access()` 函数中的 `hr_roles` 列表。

例如，如果需要允许"财务经理"也配置奖金规则：

```python
hr_roles = [
    'hr_manager', '人事经理',
    'hr', '人事',
    'finance_manager', '财务经理',  # 新增
    'gm', '总经理',
    ...
]
```

---

## 八、总结

✅ **已完成**：
- 奖金规则配置API已添加权限检查
- 仅人力资源经理可以创建、修改、删除、启用/停用规则
- 查询功能对所有用户开放
- 完整的错误处理和提示信息

✅ **权限控制**：
- 配置操作：仅人力资源经理
- 查询操作：所有已登录用户
- 超级管理员：自动拥有所有权限

✅ **安全性**：
- 后端API强制权限检查
- 前端应配合进行菜单和按钮控制
- 权限检查基于角色代码和角色名称（支持中英文）

奖金规则配置权限已完整实现，人力资源经理可以在后台进行所有配置操作！







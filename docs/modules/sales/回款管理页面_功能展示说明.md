# 回款管理页面功能展示说明

> **页面路径**: `/payments`  
> **页面文件**: `frontend/src/pages/PaymentManagement.jsx`  
> **访问方式**: 启动前端后访问 `http://localhost:5173/payments`

---

## 一、页面布局结构

```
┌─────────────────────────────────────────────────────────────┐
│  页面头部                                                    │
│  [回款管理] [导出报表] [申请开票] [批量催收]                │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  回款提醒卡片（新增）                                        │
│  🔔 回款提醒 [展开/收起]                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 客户名称 | 逾期X天/还有X天到期                       │   │
│  │ 合同：XXX | 项目：XXX | 未收金额：¥XX万              │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

┌──────────┬──────────┬──────────┬──────────┐
│ 已回款   │ 待回款   │ 已逾期   │ 本月目标 │
│ ¥XX万    │ ¥XX万    │ ¥XX万    │ ¥XX万    │
│ XX笔     │ XX笔     │ XX笔需催 │ XX%      │
└──────────┴──────────┴──────────┴──────────┘

┌─────────────────────────────────────────────────────────────┐
│  [搜索框] [类型筛选] [状态筛选]  [列表] [时间轴] [账龄]     │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  内容区域（根据视图模式切换）                                │
│                                                              │
│  [列表视图] / [时间轴视图] / [账龄分析视图]                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、主要功能区域

### 1. 页面头部操作区

**位置**: 页面顶部右侧

**按钮功能**:
- ✅ **导出报表** - 点击后调用 `handleExportPayments()`，导出Excel文件
- **申请开票** - 打开开票申请对话框
- **批量催收** - 打开批量催收对话框

---

### 2. 回款提醒卡片（新增功能）

**位置**: 统计卡片上方

**显示条件**: 当 `reminders.length > 0` 时显示

**功能特性**:
- 🔔 自动加载提醒数据（提前7天提醒）
- 📋 可展开/收起提醒列表
- 🎨 根据提醒级别显示不同颜色：
  - **紧急**（红色）：已逾期
  - **警告**（黄色）：3天内到期
  - **正常**（蓝色）：7天内到期

**显示信息**:
- 客户名称
- 合同编号
- 项目编号
- 未收金额
- 到期日期
- 逾期天数/剩余天数

**API调用**: `paymentApi.getReminders({ days_before: 7 })`

---

### 3. 统计卡片区域

**位置**: 提醒卡片下方

**卡片内容**:

#### 卡片1: 已回款（绿色）
- 显示金额：优先使用 `statistics.summary.total_paid`，否则使用本地计算
- 显示笔数：优先使用 `statistics.summary.paid_count`，否则使用本地计算
- 图标：✅ CheckCircle2

#### 卡片2: 待回款（蓝色）
- 显示金额：优先使用 `statistics.summary.total_unpaid`
- 显示笔数：优先使用 `statistics.summary.pending_count`
- 显示已开票数量：`statistics.summary.invoice_count`
- 图标：⏰ Clock

#### 卡片3: 已逾期（红色）
- 显示金额：优先使用 `statistics.summary.total_overdue`
- 显示笔数：优先使用 `statistics.summary.overdue_count`
- 图标：⚠️ AlertTriangle

#### 卡片4: 本月目标（黄色）
- 显示目标金额
- 显示完成进度条和百分比
- 图标：💰 DollarSign

**数据来源**: 
- 优先：`statistics`（从API获取）
- 回退：`stats`（本地计算）

---

### 4. 筛选和视图切换

**位置**: 统计卡片下方

**筛选功能**:
- 🔍 **搜索框**: 支持搜索项目、客户、合同号（防抖500ms）
- 📋 **类型筛选**: 全部类型、签约款、进度款、发货款、验收款、质保金
- 🏷️ **状态筛选**: 全部状态、已到账、待收款、已逾期、已开票

**视图切换**:
- 📋 **列表视图**: 表格展示回款记录
- 📅 **时间轴视图**: 时间轴 + 统计图表
- 📊 **账龄分析视图**: 账龄分析图表 + 逾期提醒

---

### 5. 列表视图

**表格列**:
1. 项目/合同 - 显示项目名称和合同编号
2. 客户 - 显示客户简称
3. 类型 - 显示回款类型标签
4. 金额 - 显示发票金额（万元）
5. 到期日 - 显示到期日期（逾期显示红色）
6. 发票 - 显示发票号或"未开票"
7. 状态 - 显示状态图标和文字
8. 操作 - 查看详情、催收按钮

**功能**:
- 点击行查看详情
- 分页功能
- 加载状态显示

---

### 6. 时间轴视图

**左侧**: 回款时间轴
- 使用 `PaymentTimeline` 组件
- 显示回款时间线

**右侧**: 回款统计卡片
- 使用 `PaymentStats` 组件
- **新增**: 详细统计信息
  - 回款率
  - 总开票金额
  - 总已收金额
  - 总未收金额
  - 逾期金额
- 按类型分布图表

---

### 7. 账龄分析视图

**左侧（2/3宽度）**: 账龄分析图表
- 显示不同账龄段的金额和笔数
- 账龄段：未到期、1-30天、31-60天、61-90天、90天以上
- 进度条显示占比
- 底部汇总统计

**右侧（1/3宽度）**: 逾期提醒列表
- 显示所有逾期回款
- 红色背景突出显示
- 显示项目、客户、金额、逾期天数

---

## 三、对话框功能

### 1. 开票申请对话框

**触发**: 点击"申请开票"按钮

**功能**:
- 选择待开票回款
- 输入开票金额
- 输入备注

---

### 2. 回款详情对话框

**触发**: 点击回款记录行

**显示内容**:
- 基本信息（发票号、状态、项目、合同、客户、类型、金额等）
- 备注信息
- 操作按钮（登记回款）

---

### 3. 批量催收对话框

**触发**: 点击"批量催收"按钮

**功能**:
- 显示逾期账款数量
- 选择催收方式（系统消息、邮件、短信）
- 输入催收说明

---

## 四、新增API对接说明

### 1. 回款提醒 API

**调用时机**: 页面加载时自动调用

**API**: `GET /api/v1/sales/payments/reminders`

**参数**:
```javascript
{
  page: 1,
  page_size: 20,
  days_before: 7  // 提前7天提醒
}
```

**响应数据**:
```javascript
{
  items: [
    {
      id: 1,
      customer_name: "客户名称",
      contract_code: "合同编号",
      project_code: "项目编号",
      unpaid_amount: 100000,
      due_date: "2026-01-15",
      days_until_due: 3,
      is_overdue: false,
      overdue_days: null,
      reminder_level: "warning"  // urgent/warning/normal
    }
  ],
  total: 10
}
```

---

### 2. 统计分析 API

**调用时机**: 页面加载时自动调用

**API**: `GET /api/v1/sales/payments/statistics`

**参数**: 可选（支持日期范围、客户筛选）

**响应数据**:
```javascript
{
  summary: {
    total_invoiced: 1000000,
    total_paid: 600000,
    total_unpaid: 400000,
    total_overdue: 100000,
    collection_rate: 60.0,
    invoice_count: 20,
    paid_count: 12,
    pending_count: 5,
    overdue_count: 3
  },
  monthly_statistics: [...],
  customer_statistics: [...],
  status_statistics: {...}
}
```

---

### 3. 导出功能 API

**调用时机**: 点击"导出报表"按钮

**API**: `GET /api/v1/sales/payments/invoices/export`

**参数**: 
```javascript
{
  payment_status: "PENDING",  // 可选
  keyword: "搜索关键词"        // 可选
}
```

**响应**: Excel文件流（blob）

**处理**: 自动下载为 `回款记录_YYYY-MM-DD.xlsx`

---

## 五、数据流说明

### 页面加载流程

```
1. 组件挂载
   ↓
2. useEffect 触发
   ↓
3. 并行调用：
   - loadPayments()      → 加载回款列表
   - loadReminders()     → 加载回款提醒（新增）
   - loadStatistics()    → 加载统计分析（新增）
   - loadAging()         → 加载账龄分析
   ↓
4. 更新状态
   ↓
5. 渲染UI
```

### 用户交互流程

**导出报表**:
```
点击导出按钮 
→ handleExportPayments() 
→ paymentApi.exportInvoices() 
→ 后端返回Excel文件流 
→ 创建Blob 
→ 自动下载
```

**查看提醒**:
```
页面加载 
→ loadReminders() 
→ 显示提醒卡片 
→ 点击展开/收起 
→ 显示/隐藏提醒列表
```

**查看统计**:
```
页面加载 
→ loadStatistics() 
→ 更新统计卡片数据 
→ Timeline视图显示详细统计
```

---

## 六、访问方式

### 方式1: 通过浏览器访问

1. **启动前端服务器**:
   ```bash
   cd frontend
   npm run dev
   ```

2. **访问页面**:
   - 打开浏览器访问: `http://localhost:5173/payments`
   - 或通过菜单导航: 财务管理 → 回款管理

### 方式2: 通过路由导航

在应用中，可以通过以下方式导航到回款管理页面：

```javascript
// 在代码中
import { useNavigate } from 'react-router-dom'
const navigate = useNavigate()
navigate('/payments')

// 或使用Link组件
<Link to="/payments">回款管理</Link>
```

---

## 七、功能演示要点

### 1. 回款提醒功能

- ✅ 页面加载时自动显示提醒卡片
- ✅ 点击"展开"查看详细提醒列表
- ✅ 不同提醒级别显示不同颜色
- ✅ 显示关键信息（客户、合同、项目、金额、日期）

### 2. 统计分析功能

- ✅ 统计卡片优先显示API数据
- ✅ Timeline视图显示详细统计
- ✅ 包含回款率、总金额、已收、未收、逾期等数据

### 3. 导出功能

- ✅ 点击"导出报表"按钮
- ✅ 自动下载Excel文件
- ✅ 文件名包含日期
- ✅ 支持按筛选条件导出

---

## 八、页面截图说明

由于无法直接截图，以下是页面各区域的视觉描述：

### 顶部区域
- 深色背景
- 白色文字
- 渐变按钮

### 提醒卡片
- 黄色渐变背景
- 边框高亮
- 可展开/收起

### 统计卡片
- 4个卡片横向排列
- 每个卡片有独特的颜色主题
- 大号数字显示金额
- 小字显示笔数

### 列表视图
- 深色表格
- 行悬停高亮
- 状态图标和颜色区分
- 操作按钮

---

## 九、测试建议

### 功能测试

1. **回款提醒测试**:
   - 验证提醒数据是否正确加载
   - 测试展开/收起功能
   - 验证提醒级别颜色显示

2. **统计分析测试**:
   - 验证统计数据是否正确显示
   - 测试数据回退机制（API失败时）
   - 验证Timeline视图的详细统计

3. **导出功能测试**:
   - 测试不同筛选条件下的导出
   - 验证Excel文件格式
   - 验证导出数据的完整性

### 性能测试

- 大数据量下的加载性能
- 提醒列表的滚动性能
- 统计数据的计算性能

---

**最后更新**: 2026-01-XX

# 角色管理 UI 设计文档

## 概述

为系统管理员设计完整的角色权限管理界面，支持角色 CRUD、数据权限配置、功能权限矩阵、角色继承、权限对比等功能。

## 需求汇总

| 项目 | 选择 |
|------|------|
| 使用者 | 系统管理员（IT人员） |
| 功能范围 | 完整版（CRUD + 继承 + 模板 + 对比 + 批量） |
| 数据权限 | 混合模式（下拉 + 自定义规则） |
| 功能权限 | 矩阵表格展示 |
| 生效机制 | 即时生效 |

---

## 一、整体架构

### 页面结构

1. **角色列表页** (`/admin/roles`) - 展示所有角色的表格，支持搜索、筛选、批量操作
2. **角色编辑页** (`/admin/roles/:id/edit`) - 单个角色的完整配置，包含基本信息、数据权限、功能权限三个 Tab
3. **角色对比页** (`/admin/roles/compare`) - 选择两个角色并排对比权限差异

### 组件层次

```
RoleManagement/
├── RoleListPage          # 列表页
│   ├── RoleTable         # 角色表格
│   ├── RoleTemplateModal # 从模板创建
│   └── BatchOperationBar # 批量操作栏
├── RoleEditPage          # 编辑页
│   ├── BasicInfoTab      # 基本信息 + 数据权限
│   ├── PermissionMatrixTab # 功能权限矩阵
│   └── InheritanceTab    # 角色继承配置
└── RoleComparePage       # 对比页
```

---

## 二、角色列表页

### 顶部操作栏

- 左侧：「新建角色」按钮 + 「从模板创建」下拉按钮
- 右侧：搜索框（按角色名称/编码搜索）+ 筛选器（数据权限范围、启用状态）

### 表格列定义

| 列名 | 说明 |
|------|------|
| 角色编码 | 如 `SALES_MGR`，点击进入编辑页 |
| 角色名称 | 如「销售经理」 |
| 数据权限 | 显示范围标签（全部/部门/团队/个人）|
| 权限数量 | 如「32/156」表示已分配32个权限 |
| 继承自 | 父角色名称，无则显示「-」 |
| 用户数 | 拥有该角色的用户数量，可点击查看 |
| 状态 | 启用/禁用开关 |
| 操作 | 编辑 / 复制 / 删除 |

### 批量操作

勾选多个角色后显示批量操作栏：
- 批量启用/禁用
- 批量删除（系统预置角色不可删）
- 批量导出配置（JSON格式）

### 预置模板

「从模板创建」提供常见角色模板：
- 销售人员、销售经理、销售总监
- 项目经理、工程师
- 财务专员、财务经理
- 采购专员、仓库管理员

---

## 三、角色编辑页 - 基本信息与数据权限

### 基本信息区域

表单字段：
- 角色编码（创建后不可修改）
- 角色名称
- 角色描述
- 继承父角色（下拉选择，可选）
- 启用状态

### 数据权限配置区域

分为两部分：基础范围 + 自定义规则

#### 1. 基础数据范围（下拉选择��

```
┌─────────────────────────────────────┐
│ 数据权限范围：[全部数据 ▼]          │
│                                     │
│  ○ 全部数据 - 可查看系统所有数据    │
│  ○ 本部门   - 可查看所在部门数据    │
│  ○ 本团队   - 可查看自己及下属数据  │
│  ○ 仅个人   - 只能查看自己的数据    │
└─────────────────────────────────────┘
```

#### 2. 自定义规则（可选，展开配置）

```
┌─────────────────────────────────────┐
│ ☑ 启用自定义规则                    │
├─────────────────────────────────────┤
│ 包含规则：                          │
│  [+ 添加] 指定部门: [研发部 ×]      │
│           指定项目: [PJ250101 ×]    │
├─────────────────────────────────────┤
│ 排除规则：                          │
│  [+ 添加] 排除项目: [机密项目A ×]   │
└─────────────────────────────────────┘
```

自定义规则逻辑：`(基础范围 ∪ 包含规则) - 排除规则`

---

## 四、功能权限矩阵

### 矩阵表格结构

横轴（操作类型）：查看 | 创建 | 编辑 | 删除 | 审批 | 导出
纵轴（模块/页面）：按业务模块分组

### 示例布局

```
┌──────────────────┬──────┬──────┬──────┬──────┬──────┬──────┐
│ 模块 / 页面       │ 查看 │ 创建 │ 编辑 │ 删除 │ 审批 │ 导出 │
├──────────────────┼──────┼──────┼──────┼──────┼──────┼──────┤
│ ▼ 销售管理        │  ☑   │  ☑   │  ◐   │  ☐   │  ◐   │  ☑   │
│   ├ 线索管理      │  ☑   │  ☑   │  ☑   │  ☐   │  -   │  ☑   │
│   ├ 商机管理      │  ☑   │  ☑   │  ☑   │  ☐   │  ☑   │  ☑   │
│   ├ 报价管理      │  ☑   │  ☑   │  ☐   │  ☐   │  ☐   │  ☑   │
│   └ 合同管理      │  ☑   │  ☐   │  ☐   │  ☐   │  ☐   │  ☐   │
├──────────────────┼──────┼──────┼──────┼──────┼──────┼──────┤
│ ▼ 项目管理        │  ☑   │  ☐   │  ☐   │  ☐   │  ☐   │  ☑   │
│   ├ 项目列表      │  ☑   │  ☐   │  ☐   │  ☐   │  -   │  ☑   │
│   └ 进度跟踪      │  ☑   │  ☐   │  ☐   │  ☐   │  -   │  ☐   │
└──────────────────┴──────┴──────┴──────┴──────┴──────┴──────┘

图例：☑ 已授权  ☐ 未授权  ◐ 部分授权（子项不一致）  - 不适用
```

### 交互设计

- 点击模块行的勾选框：全选/取消该模块所有子页面的对应权限
- 点击列头：全选/取消该操作类型的所有权限
- 支持 Ctrl+Click 多选，Shift+Click 范围选择
- 右上角提供「全部展开/折叠」按钮
- 搜索框快速定位模块或页面

### 权限依赖提示

当勾选某权限时，自动提示依赖关系：
> 「编辑商机」需要「查看商机」权限，是否一并授权？

---

## 五、角色继承与角色对比

### 角色继承机制

在编辑页的「继承配置」Tab 中：

```
┌─────────────────────────────────────────────────┐
│ 继承设置                                        │
├─────────────────────────────────────────────────┤
│ 父角色：[销售人员 ▼]                            │
│                                                 │
│ 继承的权限（只读，来自父角色）：                │
│ ┌─────────────────────────────────────────────┐ │
│ │ ☑ 线索管理-查看  ☑ 线索管理-创建           │ │
│ │ ☑ 商机管理-查看  ☑ 商机管理-创建  ...      │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ 本角色额外权限（可编辑）：                      │
│ ┌─────────────────────────────────────────────┐ │
│ │ ☑ 商机管理-审批  ☑ 报价管理-审批           │ │
│ │ ☑ 团队统计-查看                             │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

继承规则：`子角色权限 = 父角色权限 ∪ 本角色额外权限`

### 角色对比页

选择两个角色后并排展示差异：

```
┌───────────────────────────────────────────────────────┐
│ 角色对比                                              │
│ [销售经理 ▼]  VS  [销售总监 ▼]     [交换] [导出]     │
├───────────────────────────────────────────────────────┤
│ 筛选：○ 全部  ● 仅差异  ○ 仅相同                     │
├────────────────┬──────────────┬──────────────────────┤
│ 权限项          │ 销售经理     │ 销售总监             │
├────────────────┼──────────────┼──────────────────────┤
│ 数据权限范围    │ 本团队       │ 全部 ⚡              │
├────────────────┼──────────────┼──────────────────────┤
│ 商机管理-删除   │ ☐            │ ☑ ⚡                 │
│ 合同管理-审批   │ ☐            │ ☑ ⚡                 │
│ 销售目标-编辑   │ ☐            │ ☑ ⚡                 │
├────────────────┼──────────────┼──────────────────────┤
│ 线索管理-查看   │ ☑            │ ☑                    │
│ 线索管理-创建   │ ☑            │ ☑                    │
└────────────────┴──────────────┴──────────────��───────┘
⚡ = 差异项
```

---

## 六、后端 API 设计

### 新增/修改的 API 端点

```
# 角色管理（已有，需扩展）
GET    /api/v1/roles                    # 角色列表（增加继承信息）
POST   /api/v1/roles                    # 创建角色（支持继承、自定义规则）
PUT    /api/v1/roles/{id}               # 更新角色
DELETE /api/v1/roles/{id}               # 删除角色
POST   /api/v1/roles/batch              # 批量操作

# 新增端点
GET    /api/v1/roles/{id}/full          # 获取完整角色配置（含继承权限）
POST   /api/v1/roles/from-template      # 从模板创建
GET    /api/v1/roles/compare            # 角色对比
GET    /api/v1/roles/templates          # 获取预置模板列表

# 权限矩阵
GET    /api/v1/permissions/matrix       # 获取权限矩阵结构（模块→页面→操作）
GET    /api/v1/permissions/dependencies # 获取权限依赖关系
```

### 即时生效机制

```
┌─────────────────────────────────────────────────────┐
│                   权限变更流程                       │
├─────────────────────────────────────────────────────┤
│  1. 管理员保存角色配置                              │
│           ↓                                         │
│  2. 后端更新数据库                                  │
│           ↓                                         │
│  3. 清除该角色所有用户的权限缓存                    │
│     Redis: DEL user_perms:{user_id}                │
│           ↓                                         │
│  4. 用户下次请求时重新加载权限                      │
│     （JWT 不变，权限从缓存/数据库实时读取）         │
└─────────────────────────────────────────────────────┘
```

### 权限校验流程优化

- 当前：JWT 包含角色信息 → 查数据库获取权限
- 优化：JWT 包含角色信息 → 先查 Redis 缓存 → 未命中则查数据库并缓存

缓存配置：
- Key: `user_perms:{user_id}`
- TTL: 5分钟

---

## 七、数据库模型变更

### 现有模型保持不变

- `roles` 表 - 已有 `data_scope` 字段
- `permissions` 表 - 已有
- `role_permissions` 表 - 已有

### 新增表

```sql
-- 角色继承关系表
CREATE TABLE role_inheritance (
    id INT PRIMARY KEY AUTO_INCREMENT,
    role_id INT NOT NULL COMMENT '子角色ID',
    parent_role_id INT NOT NULL COMMENT '父角色ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES roles(id),
    FOREIGN KEY (parent_role_id) REFERENCES roles(id),
    UNIQUE KEY uk_role_parent (role_id, parent_role_id)
);

-- 数据权限自定义规则表
CREATE TABLE data_scope_rules (
    id INT PRIMARY KEY AUTO_INCREMENT,
    role_id INT NOT NULL COMMENT '角色ID',
    rule_type ENUM('INCLUDE', 'EXCLUDE') NOT NULL COMMENT '规则类型',
    target_type ENUM('DEPARTMENT', 'PROJECT', 'USER') NOT NULL COMMENT '目标类型',
    target_id INT NOT NULL COMMENT '目标ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES roles(id)
);

-- 角色模板表
CREATE TABLE role_templates (
    id INT PRIMARY KEY AUTO_INCREMENT,
    template_code VARCHAR(50) NOT NULL UNIQUE,
    template_name VARCHAR(100) NOT NULL,
    description TEXT,
    data_scope VARCHAR(20) DEFAULT 'OWN',
    permission_ids JSON COMMENT '权限ID数组',
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INT DEFAULT 0
);
```

### Permission 表扩展字段

```sql
ALTER TABLE permissions ADD COLUMN module_code VARCHAR(50) COMMENT '所属模块编码';
ALTER TABLE permissions ADD COLUMN page_code VARCHAR(50) COMMENT '所属页面编码';
ALTER TABLE permissions ADD COLUMN action_type VARCHAR(20) COMMENT '操作类型: VIEW/CREATE/EDIT/DELETE/APPROVE/EXPORT';
ALTER TABLE permissions ADD COLUMN depends_on INT COMMENT '依赖的权限ID';
```

---

## 八、实现优先级

### P0 - 核心功能
1. Permission 表扩展（module_code, page_code, action_type）
2. 权限矩阵 API
3. 角色列表页 + 基本 CRUD
4. 功能权限矩阵组件
5. 即时生效机制

### P1 - 数据权限
1. 数据权限自定义规则表
2. 数据权限配置 UI
3. DataScopeService 扩展支持自定义规则

### P2 - 高级功能
1. 角色继承表
2. 继承配置 UI
3. 角色对比页
4. 角色模板功能
5. 批量操作

---

## 九、技术栈

- 前端：React + Ant Design + TanStack Query
- 后端：FastAPI + SQLAlchemy
- 缓存：Redis（权限缓存）
- 数据库：MySQL/SQLite

---

*文档创建时间：2026-01-21*

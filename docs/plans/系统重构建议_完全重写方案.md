# ç³»ç»Ÿé‡æ„å»ºè®® - å®Œå…¨é‡å†™æ–¹æ¡ˆ

> åŸºäºä»£ç å®¡æŸ¥å‘ç°çš„é‡å¤é—®é¢˜å’Œæ¶æ„ç¼ºé™·  
> åˆ›å»ºæ—¥æœŸï¼š2026-01-23  
> çŠ¶æ€ï¼šå»ºè®®æ–¹æ¡ˆ

---

## ä¸€ã€æ ¸å¿ƒåŸåˆ™

### 1.1 è®¾è®¡åŸåˆ™ï¼ˆDRY + SOLIDï¼‰

**å¿…é¡»éµå¾ªçš„åŸåˆ™**ï¼š
1. **DRY (Don't Repeat Yourself)** - é›¶å®¹å¿é‡å¤ä»£ç 
2. **å•ä¸€èŒè´£åŸåˆ™** - æ¯ä¸ªæ¨¡å—åªåšä¸€ä»¶äº‹
3. **ä¾èµ–å€’ç½®** - ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
4. **å¼€é—­åŸåˆ™** - å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
5. **é…ç½®é©±åŠ¨** - èƒ½ç”¨é…ç½®è§£å†³çš„ï¼Œä¸è¦å†™ä»£ç 

### 1.2 æ¶æ„åŸåˆ™

1. **åˆ†å±‚æ¸…æ™°** - APIå±‚ â†’ Serviceå±‚ â†’ Repositoryå±‚ â†’ Modelå±‚
2. **ç»Ÿä¸€æŠ½è±¡** - æ‰€æœ‰CRUDã€ç»Ÿè®¡ã€æŠ¥è¡¨éƒ½åŸºäºç»Ÿä¸€åŸºç±»
3. **é¡¹ç›®ä¸­å¿ƒè®¾è®¡** - æ‰€æœ‰é¡¹ç›®ç›¸å…³åŠŸèƒ½éƒ½åœ¨ `/projects/{id}/` ä¸‹
4. **æ¨¡å—åŒ–** - æ¯ä¸ªä¸šåŠ¡æ¨¡å—ç‹¬ç«‹ï¼Œå¯æ’æ‹”
5. **ç±»å‹å®‰å…¨** - å‰åç«¯éƒ½ä½¿ç”¨TypeScript/Pydanticä¸¥æ ¼ç±»å‹

---

## äºŒã€æŠ€æœ¯æ ˆå»ºè®®

### 2.1 åç«¯æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯é€‰æ‹© | ç†ç”± |
|------|---------|------|
| **æ¡†æ¶** | FastAPI (ä¿æŒ) | æ€§èƒ½å¥½ï¼Œç±»å‹æ”¯æŒå¼ºï¼Œå¼‚æ­¥æ”¯æŒ |
| **ORM** | SQLAlchemy 2.0+ | æˆç†Ÿç¨³å®šï¼Œæ”¯æŒå¼‚æ­¥ |
| **æ•°æ®åº“** | PostgreSQL | æ¯”MySQLåŠŸèƒ½æ›´å¼ºï¼ŒJSONæ”¯æŒå¥½ |
| **ç¼“å­˜** | Redis | ç»Ÿä¸€ç¼“å­˜å±‚ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | Celery + Redis | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| **APIæ–‡æ¡£** | OpenAPI 3.0 | è‡ªåŠ¨ç”Ÿæˆï¼Œç±»å‹å®‰å…¨ |
| **æµ‹è¯•** | pytest + pytest-asyncio | å…¨é¢æµ‹è¯•è¦†ç›– |

### 2.2 å‰ç«¯æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯é€‰æ‹© | ç†ç”± |
|------|---------|------|
| **æ¡†æ¶** | React 19 + TypeScript | ç±»å‹å®‰å…¨ï¼Œç”Ÿæ€æˆç†Ÿ |
| **çŠ¶æ€ç®¡ç†** | Zustand / Jotai | è½»é‡çº§ï¼Œæ¯”Reduxç®€å• |
| **UIç»„ä»¶åº“** | shadcn/ui (ä¿æŒ) | å¯å®šåˆ¶ï¼Œç°ä»£åŒ– |
| **æ•°æ®è·å–** | TanStack Query (React Query) | ç»Ÿä¸€æ•°æ®è·å–ï¼Œç¼“å­˜ç®¡ç† |
| **è¡¨å•** | React Hook Form + Zod | ç±»å‹å®‰å…¨ï¼Œæ€§èƒ½å¥½ |
| **è·¯ç”±** | React Router v6 | æˆç†Ÿç¨³å®š |
| **æ„å»ºå·¥å…·** | Vite (ä¿æŒ) | å¿«é€Ÿï¼Œç°ä»£åŒ– |

### 2.3 åŸºç¡€è®¾æ–½

| ç»„ä»¶ | æŠ€æœ¯é€‰æ‹© | ç†ç”± |
|------|---------|------|
| **å®¹å™¨åŒ–** | Docker + Docker Compose | ç¯å¢ƒä¸€è‡´æ€§ |
| **CI/CD** | GitHub Actions | è‡ªåŠ¨åŒ–éƒ¨ç½² |
| **ç›‘æ§** | Prometheus + Grafana | ç³»ç»Ÿç›‘æ§ |
| **æ—¥å¿—** | ç»“æ„åŒ–æ—¥å¿— (JSON) | ä¾¿äºåˆ†æ |
| **æ–‡æ¡£** | MkDocs / Docusaurus | è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ |

---

## ä¸‰ã€åŸºç¡€æ¶æ„è®¾è®¡

### 3.1 ç›®å½•ç»“æ„ï¼ˆæ–°è®¾è®¡ï¼‰

```
non-standard-automation-pms-v2/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ core/                    # æ ¸å¿ƒåŸºç¡€è®¾æ–½
â”‚   â”‚   â”‚   â”œâ”€â”€ config.py            # é…ç½®ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ security.py          # è®¤è¯æˆæƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ database.py          # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”‚   â”œâ”€â”€ cache.py             # ç¼“å­˜ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ exceptions.py        # å¼‚å¸¸å®šä¹‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ common/                  # é€šç”¨ç»„ä»¶ï¼ˆå…³é”®ï¼ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ crud/                # CRUDåŸºç±»
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ base.py          # åŸºç¡€CRUDç±»
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ repository.py   # Repositoryæ¨¡å¼
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ service.py       # ServiceåŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ statistics/          # ç»Ÿè®¡åŸºç±»
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ base.py          # ç»Ÿè®¡æœåŠ¡åŸºç±»
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ aggregator.py   # æ•°æ®èšåˆå™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ dashboard.py    # DashboardåŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ reports/             # æŠ¥è¡¨åŸºç±»
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ base.py          # æŠ¥è¡¨ç”ŸæˆåŸºç±»
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ renderers/       # æ¸²æŸ“å™¨ï¼ˆPDF/Excel/Wordï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ templates/       # æŠ¥è¡¨æ¨¡æ¿
â”‚   â”‚   â”‚   â”œâ”€â”€ filters/            # é€šç”¨ç­›é€‰å™¨
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ query_builder.py # æŸ¥è¯¢æ„å»ºå™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ pagination.py    # åˆ†é¡µå·¥å…·
â”‚   â”‚   â”‚   â””â”€â”€ validators/          # é€šç”¨éªŒè¯å™¨
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/                     # APIå±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ routers/         # è·¯ç”±å®šä¹‰
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ projects.py  # é¡¹ç›®è·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ materials.py # ç‰©æ–™è·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ dependencies.py  # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ services/                 # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ projects/            # é¡¹ç›®æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ materials/           # ç‰©æ–™æœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ repositories/            # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ base.py              # RepositoryåŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ projects.py         # é¡¹ç›®Repository
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ models/                  # ORMæ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ base.py              # åŸºç¡€æ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ projects.py         # é¡¹ç›®æ¨¡å‹
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ schemas/                 # Pydanticæ¨¡å¼
â”‚   â”‚       â”œâ”€â”€ common.py            # é€šç”¨æ¨¡å¼
â”‚   â”‚       â”œâ”€â”€ projects.py         # é¡¹ç›®æ¨¡å¼
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ tests/                       # æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â”‚   â””â”€â”€ e2e/                     # ç«¯åˆ°ç«¯æµ‹è¯•
â”‚   â”‚
â”‚   â””â”€â”€ migrations/                  # æ•°æ®åº“è¿ç§»
â”‚
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ core/                    # æ ¸å¿ƒåŸºç¡€è®¾æ–½
â”‚   â”‚   â”‚   â”œâ”€â”€ api/                 # APIå®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ client.ts        # ç»Ÿä¸€APIå®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ interceptors.ts  # æ‹¦æˆªå™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ types.ts         # APIç±»å‹å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/               # é€šç”¨Hooksï¼ˆå…³é”®ï¼ï¼‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useDataLoader.ts # æ•°æ®åŠ è½½Hook
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ usePaginatedData.ts # åˆ†é¡µæ•°æ®Hook
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useForm.ts       # è¡¨å•Hook
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useTable.ts      # è¡¨æ ¼Hook
â”‚   â”‚   â”‚   â”œâ”€â”€ components/          # é€šç”¨ç»„ä»¶ï¼ˆå…³é”®ï¼ï¼‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DataTable/      # é€šç”¨è¡¨æ ¼ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Form/            # é€šç”¨è¡¨å•ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FilterPanel/     # é€šç”¨ç­›é€‰é¢æ¿
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Dashboard/       # é€šç”¨Dashboardç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ utils/              # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ features/                # åŠŸèƒ½æ¨¡å—ï¼ˆæŒ‰ä¸šåŠ¡åˆ’åˆ†ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ projects/            # é¡¹ç›®æ¨¡å—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ components/      # é¡¹ç›®ä¸“ç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/          # é¡¹ç›®ä¸“ç”¨Hooks
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ pages/          # é¡¹ç›®é¡µé¢
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ types.ts        # é¡¹ç›®ç±»å‹å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ materials/          # ç‰©æ–™æ¨¡å—
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ shared/                 # å…±äº«èµ„æº
â”‚   â”‚       â”œâ”€â”€ components/         # å…±äº«ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ hooks/              # å…±äº«Hooks
â”‚   â”‚       â””â”€â”€ utils/              # å…±äº«å·¥å…·
â”‚   â”‚
â”‚   â””â”€â”€ tests/                      # å‰ç«¯æµ‹è¯•
â”‚
â””â”€â”€ infrastructure/                 # åŸºç¡€è®¾æ–½
    â”œâ”€â”€ docker/                     # Dockeré…ç½®
    â”œâ”€â”€ k8s/                        # Kubernetesé…ç½®
    â””â”€â”€ scripts/                    # éƒ¨ç½²è„šæœ¬
```

---

## å››ã€å¿…é¡»ä¼˜å…ˆå»ºè®¾çš„åŸºç¡€è®¾æ–½

### 4.1 åç«¯åŸºç¡€ï¼ˆä¼˜å…ˆçº§ï¼šP0ï¼‰

#### 1. é€šç”¨CRUDåŸºç±» â­â­â­â­â­

**ä¸ºä»€ä¹ˆæœ€é‡è¦**ï¼š
- å½“å‰ç³»ç»Ÿæœ‰1297ä¸ªCRUDå‡½æ•°ï¼Œå¤§é‡é‡å¤
- ç»Ÿä¸€åå¯ä»¥å‡å°‘70%çš„é‡å¤ä»£ç 

**å®ç°æ–¹æ¡ˆ**ï¼š

```python
# app/common/crud/base.py
from typing import Generic, TypeVar, Type, Optional, List, Dict, Any
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update, delete
from pydantic import BaseModel

ModelType = TypeVar("ModelType")
CreateSchemaType = TypeVar("CreateSchemaType", bound=BaseModel)
UpdateSchemaType = TypeVar("UpdateSchemaType", bound=BaseModel)

class BaseCRUDService(Generic[ModelType, CreateSchemaType, UpdateSchemaType]):
    """é€šç”¨CRUDæœåŠ¡åŸºç±»"""
    
    def __init__(self, model: Type[ModelType], db: AsyncSession):
        self.model = model
        self.db = db
    
    async def get(self, id: int) -> Optional[ModelType]:
        """è·å–å•ä¸ªå¯¹è±¡"""
        result = await self.db.execute(
            select(self.model).where(self.model.id == id)
        )
        return result.scalar_one_or_none()
    
    async def list(
        self,
        skip: int = 0,
        limit: int = 100,
        filters: Optional[Dict[str, Any]] = None,
        order_by: Optional[str] = None
    ) -> List[ModelType]:
        """åˆ—è¡¨æŸ¥è¯¢ï¼ˆæ”¯æŒç­›é€‰ã€æ’åºã€åˆ†é¡µï¼‰"""
        query = select(self.model)
        
        # åº”ç”¨ç­›é€‰
        if filters:
            query = self._apply_filters(query, filters)
        
        # åº”ç”¨æ’åº
        if order_by:
            query = query.order_by(getattr(self.model, order_by))
        
        # åº”ç”¨åˆ†é¡µ
        query = query.offset(skip).limit(limit)
        
        result = await self.db.execute(query)
        return result.scalars().all()
    
    async def create(self, obj_in: CreateSchemaType) -> ModelType:
        """åˆ›å»ºå¯¹è±¡"""
        obj_data = obj_in.model_dump()
        db_obj = self.model(**obj_data)
        self.db.add(db_obj)
        await self.db.commit()
        await self.db.refresh(db_obj)
        return db_obj
    
    async def update(
        self,
        id: int,
        obj_in: UpdateSchemaType
    ) -> Optional[ModelType]:
        """æ›´æ–°å¯¹è±¡"""
        db_obj = await self.get(id)
        if not db_obj:
            return None
        
        update_data = obj_in.model_dump(exclude_unset=True)
        for field, value in update_data.items():
            setattr(db_obj, field, value)
        
        await self.db.commit()
        await self.db.refresh(db_obj)
        return db_obj
    
    async def delete(self, id: int) -> bool:
        """åˆ é™¤å¯¹è±¡"""
        db_obj = await self.get(id)
        if not db_obj:
            return False
        
        await self.db.delete(db_obj)
        await self.db.commit()
        return True
    
    def _apply_filters(self, query, filters: Dict[str, Any]):
        """åº”ç”¨ç­›é€‰æ¡ä»¶ï¼ˆå¯æ‰©å±•ï¼‰"""
        # å®ç°é€šç”¨ç­›é€‰é€»è¾‘
        return query
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
# app/services/projects/project_service.py
from app.common.crud.base import BaseCRUDService
from app.models.projects import Project
from app.schemas.projects import ProjectCreate, ProjectUpdate

class ProjectService(BaseCRUDService[Project, ProjectCreate, ProjectUpdate]):
    """é¡¹ç›®æœåŠ¡ï¼ˆç»§æ‰¿é€šç”¨CRUDï¼‰"""
    
    # åªéœ€è¦å®ç°ä¸šåŠ¡ç‰¹å®šçš„æ–¹æ³•
    async def get_by_code(self, code: str) -> Optional[Project]:
        """æ ¹æ®ç¼–ç è·å–é¡¹ç›®"""
        result = await self.db.execute(
            select(Project).where(Project.code == code)
        )
        return result.scalar_one_or_none()
```

#### 2. ç»Ÿä¸€æŸ¥è¯¢æ„å»ºå™¨ â­â­â­â­â­

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- æ‰€æœ‰åˆ—è¡¨æ¥å£éƒ½éœ€è¦ç­›é€‰ã€æœç´¢ã€æ’åº
- ç»Ÿä¸€åé¿å…é‡å¤å®ç°

**å®ç°æ–¹æ¡ˆ**ï¼š

```python
# app/common/filters/query_builder.py
from typing import Dict, Any, Optional, List
from sqlalchemy import select, or_, and_
from sqlalchemy.orm import Query

class QueryBuilder:
    """ç»Ÿä¸€æŸ¥è¯¢æ„å»ºå™¨"""
    
    @staticmethod
    def build_list_query(
        model: Type,
        db: AsyncSession,
        filters: Optional[Dict[str, Any]] = None,
        keyword: Optional[str] = None,
        keyword_fields: Optional[List[str]] = None,
        order_by: Optional[str] = None,
        skip: int = 0,
        limit: int = 100
    ) -> tuple[Query, int]:
        """
        æ„å»ºåˆ—è¡¨æŸ¥è¯¢
        
        Returns:
            (query, total_count)
        """
        query = select(model)
        
        # å…³é”®è¯æœç´¢
        if keyword and keyword_fields:
            conditions = [
                getattr(model, field).ilike(f"%{keyword}%")
                for field in keyword_fields
            ]
            query = query.where(or_(*conditions))
        
        # åº”ç”¨ç­›é€‰
        if filters:
            query = QueryBuilder._apply_filters(query, model, filters)
        
        # è®¡ç®—æ€»æ•°
        count_query = select(func.count()).select_from(query.subquery())
        total = await db.scalar(count_query)
        
        # åº”ç”¨æ’åº
        if order_by:
            query = query.order_by(getattr(model, order_by))
        
        # åº”ç”¨åˆ†é¡µ
        query = query.offset(skip).limit(limit)
        
        return query, total
    
    @staticmethod
    def _apply_filters(query, model, filters: Dict[str, Any]):
        """åº”ç”¨ç­›é€‰æ¡ä»¶"""
        conditions = []
        
        for field, value in filters.items():
            if value is None:
                continue
            
            model_field = getattr(model, field, None)
            if not model_field:
                continue
            
            if isinstance(value, list):
                conditions.append(model_field.in_(value))
            elif isinstance(value, dict):
                # æ”¯æŒèŒƒå›´æŸ¥è¯¢ {min: 10, max: 20}
                if 'min' in value:
                    conditions.append(model_field >= value['min'])
                if 'max' in value:
                    conditions.append(model_field <= value['max'])
            else:
                conditions.append(model_field == value)
        
        if conditions:
            query = query.where(and_(*conditions))
        
        return query
```

#### 3. ç»Ÿä¸€ç»Ÿè®¡æœåŠ¡åŸºç±» â­â­â­â­

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- å½“å‰æœ‰262ä¸ªç»Ÿè®¡ç›¸å…³æ–‡ä»¶ï¼Œ50+ä¸ªdashboard
- ç»Ÿä¸€åå¯ä»¥å‡å°‘50%çš„é‡å¤ä»£ç 

**å®ç°æ–¹æ¡ˆ**ï¼š

```python
# app/common/statistics/base.py
from typing import Dict, List, Any, Optional
from datetime import date, datetime
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import func, select

class BaseStatisticsService:
    """ç»Ÿä¸€ç»Ÿè®¡æœåŠ¡åŸºç±»"""
    
    def __init__(self, model: Type, db: AsyncSession):
        self.model = model
        self.db = db
    
    async def count_by_status(self) -> Dict[str, int]:
        """æŒ‰çŠ¶æ€ç»Ÿè®¡"""
        result = await self.db.execute(
            select(
                self.model.status,
                func.count(self.model.id)
            ).group_by(self.model.status)
        )
        return {row[0]: row[1] for row in result.all()}
    
    async def count_by_field(
        self,
        field: str,
        filters: Optional[Dict[str, Any]] = None
    ) -> Dict[str, int]:
        """æŒ‰å­—æ®µç»Ÿè®¡"""
        query = select(
            getattr(self.model, field),
            func.count(self.model.id)
        )
        
        if filters:
            query = QueryBuilder._apply_filters(query, self.model, filters)
        
        query = query.group_by(getattr(self.model, field))
        result = await self.db.execute(query)
        return {row[0]: row[1] for row in result.all()}
    
    async def get_trend(
        self,
        date_field: str,
        period: str = "day",  # day, week, month
        start_date: Optional[date] = None,
        end_date: Optional[date] = None
    ) -> List[Dict[str, Any]]:
        """è·å–è¶‹åŠ¿æ•°æ®"""
        # å®ç°è¶‹åŠ¿ç»Ÿè®¡é€»è¾‘
        pass
    
    async def get_distribution(
        self,
        field: str,
        filters: Optional[Dict[str, Any]] = None
    ) -> Dict[str, Any]:
        """è·å–åˆ†å¸ƒæ•°æ®"""
        counts = await self.count_by_field(field, filters)
        total = sum(counts.values())
        
        return {
            "distribution": counts,
            "total": total,
            "percentages": {
                k: round(v / total * 100, 2)
                for k, v in counts.items()
            }
        }
```

#### 4. ç»Ÿä¸€æŠ¥è¡¨æ¡†æ¶ â­â­â­â­

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- å½“å‰æŠ¥è¡¨ç”Ÿæˆé€»è¾‘åˆ†æ•£
- ç»Ÿä¸€åæ”¯æŒé…ç½®é©±åŠ¨ï¼Œé›¶ä»£ç ç”ŸæˆæŠ¥è¡¨

**å®ç°æ–¹æ¡ˆ**ï¼š

```python
# app/common/reports/base.py
from typing import Dict, Any, List
from abc import ABC, abstractmethod

class BaseReportGenerator(ABC):
    """æŠ¥è¡¨ç”ŸæˆåŸºç±»"""
    
    def __init__(self, config: Dict[str, Any]):
        self.config = config
    
    @abstractmethod
    async def generate_data(self) -> Dict[str, Any]:
        """ç”ŸæˆæŠ¥è¡¨æ•°æ®"""
        pass
    
    async def export(
        self,
        format: str = "json",  # json, pdf, excel, word
        output_path: Optional[str] = None
    ) -> bytes:
        """å¯¼å‡ºæŠ¥è¡¨"""
        data = await self.generate_data()
        
        if format == "json":
            return self._export_json(data)
        elif format == "pdf":
            return self._export_pdf(data)
        elif format == "excel":
            return self._export_excel(data)
        elif format == "word":
            return self._export_word(data)
        else:
            raise ValueError(f"Unsupported format: {format}")
    
    def _export_json(self, data: Dict[str, Any]) -> bytes:
        import json
        return json.dumps(data, ensure_ascii=False).encode('utf-8')
    
    def _export_pdf(self, data: Dict[str, Any]) -> bytes:
        # ä½¿ç”¨ç»Ÿä¸€çš„PDFæ¸²æŸ“å™¨
        from app.common.reports.renderers.pdf import PDFRenderer
        renderer = PDFRenderer(self.config.get('template'))
        return renderer.render(data)
    
    def _export_excel(self, data: Dict[str, Any]) -> bytes:
        # ä½¿ç”¨ç»Ÿä¸€çš„Excelæ¸²æŸ“å™¨
        from app.common.reports.renderers.excel import ExcelRenderer
        renderer = ExcelRenderer(self.config.get('template'))
        return renderer.render(data)
```

### 4.2 å‰ç«¯åŸºç¡€ï¼ˆä¼˜å…ˆçº§ï¼šP0ï¼‰

#### 1. é€šç”¨æ•°æ®åŠ è½½Hook â­â­â­â­â­

```typescript
// frontend/src/core/hooks/useDataLoader.ts
import { useState, useEffect, useCallback } from 'react';
import { useQuery, UseQueryOptions } from '@tanstack/react-query';

export function useDataLoader<T>(
  queryKey: string[],
  queryFn: () => Promise<T>,
  options?: Omit<UseQueryOptions<T>, 'queryKey' | 'queryFn'>
) {
  return useQuery({
    queryKey,
    queryFn,
    ...options,
  });
}

// ä½¿ç”¨ç¤ºä¾‹
const { data, isLoading, error, refetch } = useDataLoader(
  ['projects', projectId],
  () => projectApi.getProject(projectId)
);
```

#### 2. é€šç”¨åˆ†é¡µæ•°æ®Hook â­â­â­â­â­

```typescript
// frontend/src/core/hooks/usePaginatedData.ts
import { useState, useCallback } from 'react';
import { useQuery } from '@tanstack/react-query';

interface PaginationParams {
  page: number;
  pageSize: number;
  filters?: Record<string, any>;
  keyword?: string;
}

export function usePaginatedData<T>(
  queryKey: string[],
  queryFn: (params: PaginationParams) => Promise<{
    items: T[];
    total: number;
    page: number;
    pageSize: number;
  }>
) {
  const [pagination, setPagination] = useState({
    page: 1,
    pageSize: 20,
  });
  const [filters, setFilters] = useState<Record<string, any>>({});
  const [keyword, setKeyword] = useState('');

  const { data, isLoading, error, refetch } = useQuery({
    queryKey: [...queryKey, pagination, filters, keyword],
    queryFn: () => queryFn({
      ...pagination,
      filters,
      keyword,
    }),
  });

  const handlePageChange = useCallback((page: number, pageSize: number) => {
    setPagination({ page, pageSize });
  }, []);

  const handleFilterChange = useCallback((newFilters: Record<string, any>) => {
    setFilters(newFilters);
    setPagination(prev => ({ ...prev, page: 1 }));
  }, []);

  return {
    data: data?.items ?? [],
    total: data?.total ?? 0,
    pagination,
    filters,
    keyword,
    isLoading,
    error,
    handlePageChange,
    handleFilterChange,
    setKeyword,
    refetch,
  };
}
```

#### 3. é€šç”¨è¡¨æ ¼ç»„ä»¶ â­â­â­â­â­

```typescript
// frontend/src/core/components/DataTable/DataTable.tsx
import { usePaginatedData } from '@/core/hooks/usePaginatedData';
import { Table, TableProps } from '@/components/ui/table';

interface DataTableProps<T> extends Omit<TableProps<T>, 'dataSource'> {
  queryKey: string[];
  queryFn: (params: PaginationParams) => Promise<PaginatedResponse<T>>;
  columns: ColumnType<T>[];
  filters?: FilterConfig[];
}

export function DataTable<T>({
  queryKey,
  queryFn,
  columns,
  filters,
  ...tableProps
}: DataTableProps<T>) {
  const {
    data,
    total,
    pagination,
    filters: activeFilters,
    isLoading,
    handlePageChange,
    handleFilterChange,
  } = usePaginatedData(queryKey, queryFn);

  return (
    <div>
      {filters && (
        <FilterPanel
          filters={filters}
          values={activeFilters}
          onChange={handleFilterChange}
        />
      )}
      <Table
        columns={columns}
        dataSource={data}
        loading={isLoading}
        pagination={{
          current: pagination.page,
          pageSize: pagination.pageSize,
          total,
          onChange: handlePageChange,
        }}
        {...tableProps}
      />
    </div>
  );
}
```

---

## äº”ã€å¼€å‘é¡ºåºå»ºè®®

### é˜¶æ®µ1ï¼šåŸºç¡€è®¾æ–½ï¼ˆ2-3å‘¨ï¼‰â­â­â­â­â­

**å¿…é¡»å®Œæˆ**ï¼š
1. âœ… æ•°æ®åº“è®¾è®¡å’Œè¿ç§»ç³»ç»Ÿ
2. âœ… è®¤è¯æˆæƒç³»ç»Ÿï¼ˆJWT + æƒé™ï¼‰
3. âœ… é€šç”¨CRUDåŸºç±»
4. âœ… ç»Ÿä¸€æŸ¥è¯¢æ„å»ºå™¨
5. âœ… ç»Ÿä¸€ç»Ÿè®¡æœåŠ¡åŸºç±»
6. âœ… ç»Ÿä¸€æŠ¥è¡¨æ¡†æ¶
7. âœ… APIå®¢æˆ·ç«¯å°è£…
8. âœ… é€šç”¨Hooksï¼ˆuseDataLoader, usePaginatedDataï¼‰
9. âœ… é€šç”¨ç»„ä»¶ï¼ˆDataTable, Formï¼‰

**ä¸ºä»€ä¹ˆå…ˆåšè¿™äº›**ï¼š
- è¿™äº›æ˜¯æ‰€æœ‰åŠŸèƒ½çš„åŸºç¡€
- åšå¥½åï¼Œåç»­å¼€å‘é€Ÿåº¦ä¼šå¿«10å€
- é¿å…é‡å¤ä»£ç çš„æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

### é˜¶æ®µ2ï¼šæ ¸å¿ƒä¸šåŠ¡æ¨¡å—ï¼ˆ4-6å‘¨ï¼‰

**æŒ‰ä¼˜å…ˆçº§**ï¼š
1. **é¡¹ç›®ç®¡ç†**ï¼ˆæœ€æ ¸å¿ƒï¼‰
   - é¡¹ç›®CRUDï¼ˆä½¿ç”¨é€šç”¨åŸºç±»ï¼‰
   - é¡¹ç›®çŠ¶æ€ç®¡ç†
   - é¡¹ç›®çœ‹æ¿

2. **ç‰©æ–™ç®¡ç†**
   - ç‰©æ–™CRUD
   - BOMç®¡ç†
   - ä¾›åº”å•†ç®¡ç†

3. **é‡‡è´­ç®¡ç†**
   - é‡‡è´­è®¢å•
   - åˆ°è´§è·Ÿè¸ª

4. **è¿›åº¦ç®¡ç†**
   - ä»»åŠ¡ç®¡ç†
   - é‡Œç¨‹ç¢‘
   - ç”˜ç‰¹å›¾

### é˜¶æ®µ3ï¼šæ‰©å±•åŠŸèƒ½ï¼ˆæŒ‰éœ€ï¼‰

- é”€å”®ç®¡ç†
- ç”Ÿäº§ç®¡ç†
- éªŒæ”¶ç®¡ç†
- ECNç®¡ç†
- ç­‰ç­‰...

---

## å…­ã€å…³é”®è®¾è®¡å†³ç­–

### 6.1 é¡¹ç›®ä¸­å¿ƒè®¾è®¡

**åŸåˆ™**ï¼šæ‰€æœ‰é¡¹ç›®ç›¸å…³åŠŸèƒ½éƒ½åœ¨ `/projects/{id}/` ä¸‹

```
âœ… æ­£ç¡®ï¼š
GET /api/v1/projects/{id}/milestones
GET /api/v1/projects/{id}/members
GET /api/v1/projects/{id}/costs

âŒ é”™è¯¯ï¼š
GET /api/v1/milestones?project_id={id}
GET /api/v1/project-milestones/{id}
```

### 6.2 ç»Ÿä¸€å“åº”æ ¼å¼

```python
# æ‰€æœ‰APIç»Ÿä¸€è¿”å›æ ¼å¼
{
    "success": true,
    "data": {...},
    "message": "æ“ä½œæˆåŠŸ",
    "code": 200
}
```

### 6.3 é…ç½®é©±åŠ¨

**èƒ½ç”¨é…ç½®è§£å†³çš„ï¼Œä¸è¦å†™ä»£ç **ï¼š

```yaml
# reports/project_summary.yaml
name: é¡¹ç›®æ±‡æ€»æŠ¥è¡¨
data_source: projects
fields:
  - name: project_code
    label: é¡¹ç›®ç¼–ç 
  - name: project_name
    label: é¡¹ç›®åç§°
  - name: status
    label: çŠ¶æ€
    format: enum
filters:
  - field: status
    type: select
    options: [ACTIVE, COMPLETED]
```

### 6.4 ç±»å‹å®‰å…¨

**å‰åç«¯éƒ½ä½¿ç”¨ä¸¥æ ¼ç±»å‹**ï¼š

```typescript
// å‰ç«¯ï¼šTypeScript
interface Project {
  id: number;
  code: string;
  name: string;
  status: ProjectStatus;
}

// åç«¯ï¼šPydantic
class ProjectResponse(BaseModel):
    id: int
    code: str
    name: str
    status: ProjectStatus
```

---

## ä¸ƒã€é¿å…ä¹‹å‰çš„é—®é¢˜

### 7.1 é˜²æ­¢APIé‡å¤

**è§„åˆ™**ï¼š
- æ¯ä¸ªèµ„æºåªæœ‰ä¸€ä¸ªAPIç«¯ç‚¹
- ä½¿ç”¨é¡¹ç›®ä¸­å¿ƒè®¾è®¡ï¼Œé¿å…ç‹¬ç«‹è·¯ç”±
- ä»£ç å®¡æŸ¥æ—¶æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤ç«¯ç‚¹

### 7.2 é˜²æ­¢CRUDé‡å¤

**è§„åˆ™**ï¼š
- æ‰€æœ‰CRUDå¿…é¡»ç»§æ‰¿åŸºç±»
- ç¦æ­¢ç›´æ¥å†™CRUDä»£ç 
- åªæœ‰ä¸šåŠ¡ç‰¹å®šé€»è¾‘æ‰å†™æ–°ä»£ç 

### 7.3 é˜²æ­¢ç»Ÿè®¡é‡å¤

**è§„åˆ™**ï¼š
- æ‰€æœ‰ç»Ÿè®¡å¿…é¡»ç»§æ‰¿ç»Ÿè®¡åŸºç±»
- Dashboardä½¿ç”¨ç»Ÿä¸€ç»„ä»¶
- ç»Ÿè®¡é€»è¾‘é…ç½®åŒ–

### 7.4 é˜²æ­¢å‰ç«¯é‡å¤

**è§„åˆ™**ï¼š
- æ‰€æœ‰æ•°æ®åŠ è½½ä½¿ç”¨é€šç”¨Hook
- æ‰€æœ‰åˆ—è¡¨ä½¿ç”¨DataTableç»„ä»¶
- æ‰€æœ‰è¡¨å•ä½¿ç”¨Formç»„ä»¶

---

## å…«ã€æµ‹è¯•ç­–ç•¥

### 8.1 æµ‹è¯•é‡‘å­—å¡”

```
        /\
       /  \      E2Eæµ‹è¯•ï¼ˆå°‘é‡ï¼‰
      /____\
     /      \    é›†æˆæµ‹è¯•ï¼ˆä¸­ç­‰ï¼‰
    /________\
   /          \  å•å…ƒæµ‹è¯•ï¼ˆå¤§é‡ï¼‰
  /____________\
```

### 8.2 æµ‹è¯•è¦†ç›–ç›®æ ‡

- **å•å…ƒæµ‹è¯•**ï¼š80%+ è¦†ç›–ç‡
- **é›†æˆæµ‹è¯•**ï¼šæ ¸å¿ƒä¸šåŠ¡æµç¨‹100%è¦†ç›–
- **E2Eæµ‹è¯•**ï¼šå…³é”®ç”¨æˆ·è·¯å¾„è¦†ç›–

### 8.3 æµ‹è¯•å·¥å…·

- **åç«¯**ï¼špytest + pytest-asyncio + pytest-cov
- **å‰ç«¯**ï¼šVitest + React Testing Library
- **E2E**ï¼šPlaywright

---

## ä¹ã€æ–‡æ¡£å’Œè§„èŒƒ

### 9.1 å¿…é¡»çš„æ–‡æ¡£

1. **æ¶æ„è®¾è®¡æ–‡æ¡£** - ç³»ç»Ÿæ•´ä½“æ¶æ„
2. **APIæ–‡æ¡£** - OpenAPIè‡ªåŠ¨ç”Ÿæˆ
3. **å¼€å‘è§„èŒƒ** - ä»£ç è§„èŒƒã€æäº¤è§„èŒƒ
4. **éƒ¨ç½²æ–‡æ¡£** - éƒ¨ç½²æµç¨‹ã€ç¯å¢ƒé…ç½®

### 9.2 ä»£ç è§„èŒƒ

- **Python**ï¼šBlack + isort + flake8
- **TypeScript**ï¼šESLint + Prettier
- **Git**ï¼šConventional Commits

---

## åã€å®æ–½å»ºè®®

### 10.1 ç¬¬ä¸€æ­¥ï¼šæ­å»ºåŸºç¡€æ¶æ„ï¼ˆæœ€é‡è¦ï¼ï¼‰

**æ—¶é—´**ï¼š2-3å‘¨  
**äº§å‡º**ï¼š
- é€šç”¨CRUDåŸºç±»
- é€šç”¨ç»Ÿè®¡åŸºç±»
- é€šç”¨æŠ¥è¡¨æ¡†æ¶
- é€šç”¨å‰ç«¯Hookså’Œç»„ä»¶

**éªŒè¯æ ‡å‡†**ï¼š
- èƒ½ç”¨åŸºç±»å®ç°ä¸€ä¸ªå®Œæ•´çš„CRUDæ¨¡å—
- èƒ½ç”¨ç»Ÿè®¡åŸºç±»å®ç°ä¸€ä¸ªDashboard
- èƒ½ç”¨é€šç”¨ç»„ä»¶å®ç°ä¸€ä¸ªåˆ—è¡¨é¡µé¢

### 10.2 ç¬¬äºŒæ­¥ï¼šå®ç°ç¬¬ä¸€ä¸ªå®Œæ•´æ¨¡å—

**é€‰æ‹©**ï¼šé¡¹ç›®ç®¡ç†æ¨¡å—  
**ç›®æ ‡**ï¼š
- éªŒè¯åŸºç¡€æ¶æ„æ˜¯å¦å¥½ç”¨
- å‘ç°è®¾è®¡é—®é¢˜ï¼ŒåŠæ—¶è°ƒæ•´
- å»ºç«‹å¼€å‘æ¨¡æ¿

### 10.3 ç¬¬ä¸‰æ­¥ï¼šæ‰¹é‡å¼€å‘

**åŸºäºå·²éªŒè¯çš„åŸºç¡€æ¶æ„**ï¼Œå¿«é€Ÿå¼€å‘å…¶ä»–æ¨¡å—

---

## åä¸€ã€é¢„æœŸæ”¶ç›Š

### 11.1 ä»£ç é‡å¯¹æ¯”

| é¡¹ç›® | å½“å‰ç³»ç»Ÿ | é‡æ„å | å‡å°‘ |
|------|---------|--------|------|
| APIç«¯ç‚¹ä»£ç  | ~15000è¡Œ | ~5000è¡Œ | 67% |
| æœåŠ¡å±‚ä»£ç  | ~20000è¡Œ | ~8000è¡Œ | 60% |
| å‰ç«¯ç»„ä»¶ä»£ç  | ~30000è¡Œ | ~12000è¡Œ | 60% |
| **æ€»è®¡** | **~65000è¡Œ** | **~25000è¡Œ** | **~62%** |

### 11.2 å¼€å‘æ•ˆç‡

- **æ–°åŠŸèƒ½å¼€å‘**ï¼šä»2å¤© â†’ 0.5å¤©ï¼ˆæå‡4å€ï¼‰
- **Bugä¿®å¤**ï¼šä¿®å¤ä¸€å¤„ï¼Œæ‰€æœ‰åœ°æ–¹å—ç›Š
- **ä»£ç å®¡æŸ¥**ï¼šå‡å°‘é‡å¤ä»£ç å®¡æŸ¥æ—¶é—´

### 11.3 ç»´æŠ¤æˆæœ¬

- **ä»£ç ç»´æŠ¤**ï¼šå‡å°‘60%ç»´æŠ¤å·¥ä½œé‡
- **æ–°äººä¸Šæ‰‹**ï¼šç»Ÿä¸€çš„ä»£ç æ¨¡å¼ï¼Œæ›´å®¹æ˜“ç†è§£
- **æ‰©å±•æ€§**ï¼šé…ç½®é©±åŠ¨ï¼Œæ‰©å±•æ›´å®¹æ˜“

---

## åäºŒã€é£é™©æ§åˆ¶

### 12.1 æŠ€æœ¯é£é™©

**é£é™©**ï¼šåŸºç¡€æ¶æ„è®¾è®¡ä¸å½“  
**ç¼“è§£**ï¼š
- å…ˆåšåŸå‹éªŒè¯
- ç¬¬ä¸€ä¸ªæ¨¡å—å……åˆ†æµ‹è¯•
- åŠæ—¶è°ƒæ•´è®¾è®¡

### 12.2 è¿›åº¦é£é™©

**é£é™©**ï¼šåŸºç¡€æ¶æ„è€—æ—¶è¿‡é•¿  
**ç¼“è§£**ï¼š
- è®¾å®šæ—¶é—´ä¸Šé™ï¼ˆ3å‘¨ï¼‰
- å…ˆå®ç°MVPï¼Œåç»­è¿­ä»£
- å¹¶è¡Œå¼€å‘ï¼ˆåŸºç¡€æ¶æ„ + ä¸šåŠ¡æ¨¡å—ï¼‰

### 12.3 å…¼å®¹æ€§é£é™©

**é£é™©**ï¼šä¸ç°æœ‰ç³»ç»Ÿä¸å…¼å®¹  
**ç¼“è§£**ï¼š
- å¦‚æœæ˜¯å®Œå…¨é‡å†™ï¼Œä¸è€ƒè™‘å…¼å®¹
- å¦‚æœæ˜¯æ¸è¿›å¼é‡æ„ï¼Œæä¾›å…¼å®¹å±‚

---

## æ€»ç»“

**æ ¸å¿ƒå»ºè®®**ï¼š

1. **å…ˆåšåŸºç¡€è®¾æ–½ï¼Œå†åšä¸šåŠ¡åŠŸèƒ½** - è¿™æ˜¯æœ€é‡è¦çš„ï¼
2. **ç»Ÿä¸€æŠ½è±¡ï¼Œé¿å…é‡å¤** - CRUDã€ç»Ÿè®¡ã€æŠ¥è¡¨éƒ½ç”¨åŸºç±»
3. **é…ç½®é©±åŠ¨ï¼Œä»£ç æœ€å°åŒ–** - èƒ½ç”¨é…ç½®çš„ï¼Œä¸è¦å†™ä»£ç 
4. **ç±»å‹å®‰å…¨ï¼Œå‰åç«¯ä¸€è‡´** - TypeScript + Pydantic
5. **æµ‹è¯•å…ˆè¡Œï¼Œè´¨é‡ä¿è¯** - é«˜æµ‹è¯•è¦†ç›–ç‡

**å¦‚æœåªèƒ½åšä¸€ä»¶äº‹**ï¼š  
ğŸ‘‰ **å…ˆå®ç°é€šç”¨CRUDåŸºç±»å’Œé€šç”¨æŸ¥è¯¢æ„å»ºå™¨**

è¿™æ˜¯å‡å°‘é‡å¤ä»£ç æœ€æœ‰æ•ˆçš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯åç»­æ‰€æœ‰åŠŸèƒ½çš„åŸºç¡€ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2026-01-23

# 生产进度模块 - 数据流图

## 1. 概述

本文档描述生产进度模块的数据流动过程，包括：
- 业务流程数据流
- 系统间数据交互
- 实时数据处理流程
- 缓存与持久化策略

---

## 2. 业务流程数据流

### 2.1 整体数据流向

```
订单系统              排程系统              生产执行              质量控制              数据分析
   │                    │                    │                    │                    │
   │  订单数据           │  排程计划           │  报工数据           │  质检数据           │  统计报表
   │  ─────────>        │  ─────────>        │  ─────────>        │  ─────────>        │
   │                    │                    │                    │                    │
   │                    │  工单派发           │  进度更新           │  质量反馈           │  AI分析
   │                    │  ────────>         │  ─────────>        │  ─────────>        │
   │                    │                    │                    │                    │
   │                    │                    │ <─────────         │                    │
   │                    │                    │  异常预警           │                    │
   ▼                    ▼                    ▼                    ▼                    ▼
```

### 2.2 详细数据流程

#### 2.2.1 Level 0 - 系统级数据流图

```
                     ┌─────────────────────────────────────────┐
                     │                                         │
      外部实体        │     生产进度管理系统                    │        外部实体
                     │                                         │
  ┌──────────┐       │   ┌─────────┐      ┌─────────┐        │       ┌──────────┐
  │  项目    │──订单──>│   │ 排程   │─工单─>│ 生产   │        │       │  ERP     │
  │  经理    │       │   │ 引擎   │      │ 执行   │────报工──>│       │  系统    │
  └──────────┘       │   └─────────┘      └─────────┘        │       └──────────┘
                     │         │                │             │
  ┌──────────┐       │         │                │             │       ┌──────────┐
  │  生产    │<──派工──│         │                │             │       │  MES     │
  │  工人    │       │         │                ▼             │       │  系统    │
  └──────────┘       │         │          ┌─────────┐        │       └──────────┘
                     │         │          │ 质量   │─质检数据─>│
  ┌──────────┐       │         │          │ 控制   │        │       ┌──────────┐
  │  质检    │<──质检任务│         │          └─────────┘        │       │  BI      │
  │  员      │       │         │                │             │       │  系统    │
  └──────────┘       │         │                │             │       └──────────┘
                     │         ▼                ▼             │
                     │   ┌──────────────────────────┐        │
                     │   │    数据分析与预警         │─报表──>│
                     │   └──────────────────────────┘        │
                     │                                         │
                     └─────────────────────────────────────────┘
```

#### 2.2.2 Level 1 - 排程模块数据流图

```
                        排程引擎
   ┌────────────────────────────────────────────────┐
   │                                                │
   │  1. 订单需求                                   │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐                               │
   │  │ 订单解析器   │  订单明细                      │
   │  └─────────────┘                               │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐    产能数据                   │
   │  │ 产能评估    │ <─────────── [产能库]        │
   │  └─────────────┘                               │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐    资源状态                   │
   │  │ 资源分配    │ <─────────── [资源池]        │
   │  └─────────────┘                               │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐    约束条件                   │
   │  │ 排程算法    │ <─────────── [规则库]        │
   │  └─────────────┘                               │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐                               │
   │  │ 排程方案    │ ────────────> [工单队列]     │
   │  └─────────────┘                               │
   │                                                │
   └────────────────────────────────────────────────┘
```

#### 2.2.3 Level 1 - 生产执行数据流图

```
                      生产执行
   ┌────────────────────────────────────────────────┐
   │                                                │
   │  1. 工单派发                                   │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐    工人技能                   │
   │  │ 工单分配    │ <─────────── [技能库]        │
   │  └─────────────┘                               │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐                               │
   │  │ 开工报工    │ ────────────> [报工记录]     │
   │  └─────────────┘                               │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐    历史进度                   │
   │  │ 进度跟踪    │ <─────────── [进度历史]      │
   │  └─────────────┘                               │
   │     │                                          │
   │     ├──────────────────────────────────────┐   │
   │     │                                      │   │
   │     ▼                                      ▼   │
   │  ┌─────────────┐                    ┌─────────────┐
   │  │ 进度预测    │                    │ 异常检测    │
   │  └─────────────┘                    └─────────────┘
   │     │                                      │   │
   │     │                                      │   │
   │     ▼                                      ▼   │
   │  [预测结果]                            [预警通知]
   │                                                │
   │     ┌────────────────────────────────────┘   │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐                               │
   │  │ 完工报工    │ ────────────> [完工记录]     │
   │  └─────────────┘                               │
   │                                                │
   └────────────────────────────────────────────────┘
```

#### 2.2.4 Level 1 - 质量控制数据流图

```
                      质量控制
   ┌────────────────────────────────────────────────┐
   │                                                │
   │  1. 质检任务                                   │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐    检验标准                   │
   │  │ 质检录入    │ <─────────── [标准库]        │
   │  └─────────────┘                               │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐                               │
   │  │ 结果判定    │ ────────────> [质检记录]     │
   │  └─────────────┘                               │
   │     │                                          │
   │     ├──────────────────────────────────────┐   │
   │     │                                      │   │
   │     ▼                                      ▼   │
   │  ┌─────────────┐                    ┌─────────────┐
   │  │ 合格品      │                    │ 不良品      │
   │  └─────────────┘                    └─────────────┘
   │     │                                      │   │
   │     ▼                                      ▼   │
   │  [入库]                             ┌─────────────┐
   │                                     │ 不良分析    │
   │                                     └─────────────┘
   │                                            │   │
   │     ┌──────────────────────────────────────┘   │
   │     │                                          │
   │     ▼                                          │
   │  ┌─────────────┐    根因                       │
   │  │ 处理决策    │ <─────────── [根因库]        │
   │  └─────────────┘                               │
   │     │                                          │
   │     ├──────────────┬─────────────┐             │
   │     ▼              ▼             ▼             │
   │  [返工]         [让步接收]     [报废]          │
   │                                                │
   └────────────────────────────────────────────────┘
```

---

## 3. 实时数据处理流程

### 3.1 报工数据实时处理

```
工人提交报工
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  API Gateway                                            │
│  - 身份验证                                             │
│  - 权限校验                                             │
│  - 请求限流                                             │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  数据校验层                                             │
│  1. 格式校验：数据类型、必填字段                         │
│  2. 业务校验：工时合理性、数量一致性                     │
│  3. 状态校验：工单状态是否允许报工                       │
└─────────────────────────────────────────────────────────┘
    │
    ├──── 校验失败 ────> [返回错误信息]
    │
    ▼ 校验通过
┌─────────────────────────────────────────────────────────┐
│  数据处理层 (Parallel)                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 写入数据库    │  │ 更新缓存      │  │ 发送消息队列  │  │
│  │ [work_report] │  │ [Redis]      │  │ [RabbitMQ]   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
    │                   │                   │
    │                   │                   ▼
    │                   │          ┌──────────────────┐
    │                   │          │ 异步任务处理      │
    │                   │          │ - 进度预测       │
    │                   │          │ - 异常检测       │
    │                   │          │ - 统计更新       │
    │                   │          └──────────────────┘
    │                   │                   │
    │                   ▼                   │
    │          ┌──────────────────┐         │
    │          │ 实时数据更新      │         │
    │          │ - 工单进度        │         │
    │          │ - 车间产能        │         │
    │          │ - 在制品数量      │         │
    │          └──────────────────┘         │
    │                   │                   │
    └───────────────────┴───────────────────┘
                        │
                        ▼
              ┌──────────────────┐
              │ WebSocket推送     │
              │ - 实时进度看板    │
              │ - 异常预警通知    │
              └──────────────────┘
                        │
                        ▼
                   [前端更新]
```

### 3.2 质检数据处理流程

```
质检员提交质检结果
    │
    ▼
[API Gateway] ─ 身份验证 ─ 权限校验
    │
    ▼
[数据校验]
    ├─ 检验数量 ≤ 工单数量？
    ├─ 合格数 + 不良数 = 检验数？
    └─ 测量值在规格范围内？
    │
    ▼ 通过
[持久化]
    ├─> [quality_inspection表]
    └─> [工单状态更新]
    │
    ▼
[SPC分析] (异步)
    ├─ 计算控制线 (UCL/LCL)
    ├─ 检测失控点
    └─ 趋势分析
    │
    ├─ 失控 ──────> [触发预警]
    │                   │
    │                   ├─> [通知质量主管]
    │                   ├─> [记录预警日志]
    │                   └─> [推送实时看板]
    │
    ▼ 正常
[不良分析] (如果不良数 > 0)
    ├─ 不良率计算
    ├─ 根因识别
    └─ 纠正措施建议
    │
    ▼
[处理决策]
    ├─ 返工 ──> [创建返工单]
    ├─ 让步接收 ──> [记录让步原因]
    └─ 报废 ──> [记录报废数量]
```

---

## 4. 缓存策略

### 4.1 Redis缓存结构

```
Redis 数据结构设计

1. 实时产能数据 (String, TTL=60s)
   Key: production:capacity:{workshop_id}:{date}
   Value: JSON {
       "total_capacity": 1000,
       "used_capacity": 650,
       "available_capacity": 350,
       "utilization_rate": 0.65,
       "updated_at": "2026-02-16T10:30:00"
   }

2. 在制品数量 (Hash, TTL=300s)
   Key: production:wip:{project_id}
   Fields:
       total_qty: 500
       completed_qty: 320
       in_progress_qty: 180
       pending_qty: 0
       updated_at: "2026-02-16T10:30:00"

3. 实时进度 (Hash, TTL=60s)
   Key: production:progress:{work_order_id}
   Fields:
       status: "IN_PROGRESS"
       progress_percent: 65
       completed_qty: 130
       plan_qty: 200
       estimated_completion: "2026-02-20T18:00:00"
       last_report_time: "2026-02-16T10:25:00"

4. 工单队列 (Sorted Set)
   Key: production:workorder:pending
   Members: work_order_id
   Scores: priority * 1000 + timestamp (排序用)

5. 质量预警 (List, TTL=3600s)
   Key: quality:alerts:{date}
   Elements: JSON [
       {
           "alert_id": "ALT-001",
           "work_order_id": 123,
           "alert_type": "DEFECT_RATE",
           "severity": "HIGH",
           "message": "不良率10.5%，超过阈值",
           "timestamp": "2026-02-16T10:20:00"
       }
   ]
```

### 4.2 缓存更新策略

```python
# Cache-Aside Pattern (旁路缓存)
def get_work_order_progress(work_order_id):
    """获取工单进度（带缓存）"""
    # 1. 尝试从缓存读取
    cache_key = f"production:progress:{work_order_id}"
    cached_data = redis.get(cache_key)
    
    if cached_data:
        return json.loads(cached_data)
    
    # 2. 缓存未命中，从数据库读取
    progress = db.query(WorkOrder).filter_by(id=work_order_id).first()
    
    # 3. 写入缓存
    redis.setex(
        cache_key,
        60,  # TTL: 60秒
        json.dumps({
            'status': progress.status,
            'progress_percent': progress.progress_percent,
            'completed_qty': progress.completed_qty,
            'plan_qty': progress.plan_qty
        })
    )
    
    return progress


# Write-Through Pattern (写穿缓存)
def update_work_report(work_report_data):
    """提交报工（同步更新缓存）"""
    # 1. 写入数据库
    work_report = WorkReport(**work_report_data)
    db.add(work_report)
    db.commit()
    
    # 2. 更新工单进度
    work_order = work_report.work_order
    work_order.completed_qty += work_report.completed_qty
    work_order.progress_percent = calculate_progress(work_order)
    db.commit()
    
    # 3. 同步更新缓存
    cache_key = f"production:progress:{work_order.id}"
    redis.setex(
        cache_key,
        60,
        json.dumps({
            'status': work_order.status,
            'progress_percent': work_order.progress_percent,
            'completed_qty': work_order.completed_qty,
            'plan_qty': work_order.plan_qty,
            'updated_at': datetime.now().isoformat()
        })
    )
    
    return work_report
```

---

## 5. 消息队列设计

### 5.1 消息类型

```python
# 消息结构设计
class Message:
    message_id: str       # 消息ID
    message_type: str     # 消息类型
    payload: dict         # 消息体
    timestamp: datetime   # 时间戳
    priority: int         # 优先级 (1-10)

# 消息类型定义
MESSAGE_TYPES = {
    'WORK_REPORT_SUBMITTED': '报工提交',
    'PROGRESS_UPDATED': '进度更新',
    'QUALITY_INSPECTION_COMPLETED': '质检完成',
    'ALERT_TRIGGERED': '预警触发',
    'SCHEDULE_CHANGED': '排程变更',
    'EQUIPMENT_FAILURE': '设备故障'
}
```

### 5.2 消息流转

```
Producer                    RabbitMQ Exchange              Consumer
  │                              │                            │
  │  work_report_submitted       │                            │
  ├────────────────────────────> │                            │
  │                              │                            │
  │                              │  routing_key:              │
  │                              │  "production.report"       │
  │                              │                            │
  │                              ├──────────────────────────> │
  │                              │                            │  [进度预测服务]
  │                              │                            │  - 预测完工时间
  │                              │                            │  - 更新预测结果
  │                              │                            │
  │                              ├──────────────────────────> │
  │                              │                            │  [异常检测服务]
  │                              │                            │  - 检测工时异常
  │                              │                            │  - 触发预警
  │                              │                            │
  │                              ├──────────────────────────> │
  │                              │                            │  [统计服务]
  │                              │                            │  - 更新产能统计
  │                              │                            │  - 更新在制品数量
  │                              │                            │
  │                              │                            ▼
  │                              │                      [处理完成]
  │ <──────────────────────────────────────────────────
  │        ACK确认
```

---

## 6. 数据同步策略

### 6.1 与ERP系统同步

```
生产进度系统              ERP系统
    │                      │
    │  订单创建             │
    │ <────────────────────
    │                      │
    │  工单生成             │
    ├─────────────────────>
    │                      │
    │  物料需求             │
    ├─────────────────────>
    │                      │
    │  完工汇报             │
    ├─────────────────────>
    │                      │
    │  成本核算             │
    │ <────────────────────
    │                      │
```

**同步方式**:
- **实时同步**: WebHook/API回调 (订单创建、完工汇报)
- **定时同步**: Cron任务 (每小时同步一次物料状态)
- **事件驱动**: 消息队列 (状态变更触发同步)

### 6.2 与MES系统同步

```
生产进度系统              MES系统
    │                      │
    │  设备状态             │
    │ <────────────────────
    │                      │
    │  工艺参数             │
    │ <────────────────────
    │                      │
    │  质检数据             │
    ├─────────────────────>
    │                      │
    │  追溯信息             │
    │ <────────────────────
    │                      │
```

**同步方式**:
- **实时数据**: MQTT协议订阅设备状态
- **批量导入**: CSV/Excel文件导入工艺参数
- **API集成**: RESTful API推送质检数据

---

## 7. 数据归档策略

### 7.1 归档规则

```python
# 数据归档配置
ARCHIVE_RULES = {
    'work_report': {
        'retention_days': 90,        # 保留90天
        'archive_table': 'work_report_archive',
        'archive_trigger': 'daily',  # 每日归档
        'compress': True             # 压缩存储
    },
    'quality_inspection': {
        'retention_days': 365,       # 保留1年
        'archive_table': 'quality_inspection_archive',
        'archive_trigger': 'monthly',
        'compress': True
    },
    'equipment_status': {
        'retention_days': 30,        # 保留30天
        'archive_table': 'equipment_status_archive',
        'archive_trigger': 'daily',
        'compress': True
    }
}
```

### 7.2 归档流程

```
定时任务 (每日凌晨02:00)
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 识别需归档数据                        │
│    WHERE created_at < NOW() - 90 DAYS   │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 导出数据                              │
│    SELECT * INTO OUTFILE 'archive.csv'  │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. 压缩存储                              │
│    gzip archive.csv                     │
│    -> archive_2026-02-16.csv.gz         │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 4. 上传对象存储 (OSS/S3)                 │
│    aws s3 cp archive.csv.gz s3://...    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 5. 删除原始数据                          │
│    DELETE FROM work_report              │
│    WHERE created_at < NOW() - 90 DAYS   │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 6. 记录归档日志                          │
│    INSERT INTO archive_log (...)        │
└─────────────────────────────────────────┘
```

---

## 8. 数据一致性保证

### 8.1 事务处理

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# 报工提交事务（保证一致性）
@transaction
def submit_work_report(work_report_data):
    try:
        # 1. 创建报工记录
        work_report = WorkReport(**work_report_data)
        db.add(work_report)
        
        # 2. 更新工单进度
        work_order = work_report.work_order
        work_order.completed_qty += work_report.completed_qty
        work_order.progress_percent = calculate_progress(work_order)
        
        # 3. 更新工人工时统计
        worker = work_report.worker
        worker.total_work_hours += work_report.work_hours
        
        # 4. 提交事务
        db.commit()
        
        # 5. 更新缓存
        update_cache(work_order.id, work_report.id)
        
        return work_report
    
    except Exception as e:
        # 回滚事务
        db.rollback()
        raise e
```

### 8.2 分布式锁

```python
import redis
from contextlib import contextmanager

@contextmanager
def distributed_lock(lock_key, timeout=10):
    """分布式锁（防止并发冲突）"""
    lock_id = str(uuid.uuid4())
    
    try:
        # 获取锁
        acquired = redis.set(
            lock_key,
            lock_id,
            nx=True,      # 仅在key不存在时设置
            ex=timeout    # 过期时间
        )
        
        if not acquired:
            raise LockAcquireError(f"Failed to acquire lock: {lock_key}")
        
        yield
    
    finally:
        # 释放锁（原子操作）
        lua_script = """
        if redis.call("get", KEYS[1]) == ARGV[1] then
            return redis.call("del", KEYS[1])
        else
            return 0
        end
        """
        redis.eval(lua_script, 1, lock_key, lock_id)


# 使用示例
with distributed_lock(f"work_order:{work_order_id}"):
    # 更新工单进度（防止并发冲突）
    update_work_order_progress(work_order_id, progress_data)
```

---

## 9. 数据安全

### 9.1 敏感数据加密

```python
from cryptography.fernet import Fernet

# 成本数据加密存储
def encrypt_cost_data(cost_value):
    """加密成本数据"""
    key = load_encryption_key()
    f = Fernet(key)
    encrypted = f.encrypt(str(cost_value).encode())
    return encrypted.decode()

def decrypt_cost_data(encrypted_value):
    """解密成本数据"""
    key = load_encryption_key()
    f = Fernet(key)
    decrypted = f.decrypt(encrypted_value.encode())
    return float(decrypted.decode())
```

### 9.2 审计日志

```python
# 操作审计日志
class AuditLog(Base):
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, nullable=False)
    action = Column(String(50), nullable=False)  # CREATE/UPDATE/DELETE
    table_name = Column(String(50), nullable=False)
    record_id = Column(Integer, nullable=False)
    old_value = Column(JSON, nullable=True)      # 变更前的值
    new_value = Column(JSON, nullable=False)     # 变更后的值
    ip_address = Column(String(50), nullable=True)
    user_agent = Column(String(200), nullable=True)
    created_at = Column(DateTime, default=datetime.now)

# 自动记录审计日志
@event.listens_for(WorkOrder, 'after_update')
def log_work_order_update(mapper, connection, target):
    audit_log = AuditLog(
        user_id=current_user.id,
        action='UPDATE',
        table_name='work_order',
        record_id=target.id,
        old_value=target.get_old_values(),
        new_value=target.get_new_values(),
        ip_address=request.remote_addr,
        user_agent=request.headers.get('User-Agent')
    )
    db.add(audit_log)
```

---

## 10. 版本历史

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| v1.0 | 2026-02-16 | Team 8 | 初始版本 |

---

## 11. 相关文档

- [架构设计](./01-架构设计.md)
- [核心算法设计](./02-核心算法设计.md)
- [API文档](../api/01-API文档.md)

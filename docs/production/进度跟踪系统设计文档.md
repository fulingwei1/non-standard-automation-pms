# 生产进度实时跟踪系统 - 系统设计文档

## 1. 系统概述

### 1.1 系统目标
实现工单级、工位级的生产进度实时监控，提供进度偏差预警和瓶颈识别功能，帮助生产管理人员及时发现问题并采取措施。

### 1.2 核心功能
- **工单级进度跟踪**: 记录每个工单的进度变化历史
- **工位级状态监控**: 实时监控工位运行状态和产能利用情况
- **进度偏差计算**: 自动计算实际进度与计划进度的偏差
- **瓶颈工位识别**: 基于产能利用率智能识别生产瓶颈
- **智能预警系统**: 多维度预警规则引擎，主动发现风险

## 2. 数据模型设计

### 2.1 生产进度日志 (ProductionProgressLog)

记录工单级别的进度变化历史。

**核心字段**:
- `work_order_id`: 工单ID（外键）
- `workstation_id`: 工位ID（外键）
- `previous_progress`: 之前进度(%)
- `current_progress`: 当前进度(%)
- `progress_delta`: 进度变化量(%)
- `completed_qty`: 已完成数量
- `qualified_qty`: 合格数量
- `defect_qty`: 不良数量
- `work_hours`: 本次工时
- `cumulative_hours`: 累计工时
- `status`: 工单状态
- `plan_progress`: 计划进度(%)
- `deviation`: 进度偏差(%)
- `is_delayed`: 是否延期标志

**索引策略**:
```sql
INDEX idx_prod_progress_work_order (work_order_id)
INDEX idx_prod_progress_workstation (workstation_id)
INDEX idx_prod_progress_logged_at (logged_at)
INDEX idx_prod_progress_status (status)
```

### 2.2 工位实时状态 (WorkstationStatus)

记录工位当前的实时运行状态和产能利用情况。

**核心字段**:
- `workstation_id`: 工位ID（唯一约束）
- `current_state`: 当前状态（IDLE/BUSY/PAUSED/MAINTENANCE/OFFLINE）
- `current_work_order_id`: 当前工单ID
- `current_operator_id`: 当前操作工ID
- `current_progress`: 当前工单进度(%)
- `completed_qty_today`: 今日完成数量
- `target_qty_today`: 今日目标数量
- `capacity_utilization`: 产能利用率(%)
- `work_hours_today`: 今日工作工时
- `idle_hours_today`: 今日空闲工时
- `efficiency_rate`: 生产效率(%)
- `quality_rate`: 合格率(%)
- `is_bottleneck`: 是否瓶颈工位标志
- `bottleneck_level`: 瓶颈等级（0-3）
- `alert_count`: 今日预警次数

**性能优化**:
- 使用 `workstation_id` 唯一索引，保证每个工位只有一条状态记录
- 定时更新机制，避免频繁写入

### 2.3 进度预警 (ProgressAlert)

基于规则引擎生成的进度风险预警。

**核心字段**:
- `work_order_id`: 工单ID
- `workstation_id`: 工位ID
- `alert_type`: 预警类型（DELAY/BOTTLENECK/QUALITY/EFFICIENCY/CAPACITY）
- `alert_level`: 预警级别（INFO/WARNING/CRITICAL/URGENT）
- `alert_title`: 预警标题
- `alert_message`: 预警内容
- `current_value`: 当前值
- `threshold_value`: 阈值
- `deviation_value`: 偏差值
- `status`: 状态（ACTIVE/ACKNOWLEDGED/RESOLVED/DISMISSED）
- `triggered_at`: 触发时间
- `rule_code`: 触发规则编码
- `rule_name`: 触发规则名称

**预警生命周期**:
1. ACTIVE: 预警触发
2. ACKNOWLEDGED: 已确认
3. RESOLVED: 已解决
4. DISMISSED: 已关闭

## 3. 核心算法设计

### 3.1 进度偏差计算引擎

**算法目标**: 计算工单实际进度与计划进度的偏差。

**计算步骤**:

1. **获取工单计划信息**
   - 计划开始日期 (plan_start_date)
   - 计划结束日期 (plan_end_date)
   - 当前日期 (current_date)

2. **计算计划进度**
   ```
   如果 current_date < plan_start_date:
       plan_progress = 0
   如果 current_date >= plan_end_date:
       plan_progress = 100
   否则:
       total_days = plan_end_date - plan_start_date
       elapsed_days = current_date - plan_start_date
       plan_progress = (elapsed_days / total_days) * 100
   ```

3. **计算偏差**
   ```
   deviation = actual_progress - plan_progress
   ```

4. **判断延期**
   ```
   is_delayed = deviation < -5  # 落后超过5%认为延期
   ```

5. **计算偏差百分比**
   ```
   deviation_percentage = |deviation| / plan_progress * 100
   ```

**应用场景**:
- 进度日志创建时自动计算
- 实时总览展示
- 偏差分析报表

### 3.2 瓶颈工位识别算法

**算法目标**: 基于产能利用率识别生产瓶颈工位。

**瓶颈判断规则**:

| 瓶颈等级 | 条件 | 说明 |
|---------|------|------|
| 0 (正常) | 产能利用率 < 90% | 无瓶颈 |
| 1 (轻度) | 产能利用率 ≥ 90% | 产能接近饱和 |
| 2 (中度) | 产能利用率 ≥ 95% 且有排队工单 | 产能饱和且有等待 |
| 3 (严重) | 产能利用率 ≥ 98% 且排队工单 > 3 | 严重瓶颈 |

**识别步骤**:

1. **查询工位状态**
   ```sql
   SELECT ws_status, workstation
   FROM workstation_status ws_status
   JOIN workstation ON ws_status.workstation_id = workstation.id
   WHERE workstation.is_active = TRUE
     AND ws_status.capacity_utilization >= 90
   ```

2. **计算瓶颈等级**
   ```python
   def calculate_bottleneck_level(utilization, pending_count):
       if utilization > 98 and pending_count > 3:
           return 3, "严重瓶颈"
       elif utilization > 95 and pending_count > 0:
           return 2, "中度瓶颈"
       elif utilization > 90:
           return 1, "轻度瓶颈"
       else:
           return 0, "正常"
   ```

3. **统计排队工单**
   ```sql
   SELECT COUNT(*) FROM work_order
   WHERE workstation_id = ?
     AND status = 'PENDING'
   ```

4. **排序输出**
   - 按瓶颈等级降序
   - 同等级按产能利用率降序

**优化策略**:
- 缓存工位状态，避免频繁查询
- 增量更新，只处理状态变化的工位
- 定时批量计算（建议5-10分钟）

### 3.3 进度预警规则引擎

**算法目标**: 基于多维度规则自动生成预警。

**预警规则定义**:

#### 规则1: 延期预警 (DELAY)
```python
if deviation < -20:
    level = "CRITICAL"
    message = f"严重进度延期，偏差{deviation}%"
elif deviation < -10:
    level = "WARNING"
    message = f"进度延期预警，偏差{deviation}%"
```

#### 规则2: 瓶颈预警 (BOTTLENECK)
```python
if workstation.bottleneck_level >= 1:
    level_map = {3: "CRITICAL", 2: "WARNING", 1: "INFO"}
    level = level_map[workstation.bottleneck_level]
    message = f"工位产能利用率{utilization}%，存在瓶颈"
```

#### 规则3: 质量预警 (QUALITY)
```python
quality_rate = qualified_qty / completed_qty * 100
if quality_rate < 90:
    level = "CRITICAL"
elif quality_rate < 95:
    level = "WARNING"
message = f"合格率{quality_rate:.1f}%，低于标准"
```

#### 规则4: 效率预警 (EFFICIENCY)
```python
efficiency = standard_hours / actual_hours * 100
if efficiency < 80:
    level = "WARNING"
    message = f"生产效率{efficiency:.1f}%，低于标准"
```

**规则执行流程**:

1. **触发时机**
   - 进度日志创建时
   - 工位状态更新时
   - 定时批量评估

2. **去重处理**
   ```python
   # 检查是否已有相同类型的活跃预警
   existing_alert = query(ProgressAlert).filter(
       work_order_id = ?,
       alert_type = ?,
       status = 'ACTIVE'
   ).first()
   
   if not existing_alert:
       create_new_alert()
   ```

3. **预警优先级**
   - CRITICAL: 立即通知
   - WARNING: 常规通知
   - INFO: 记录日志

## 4. API接口设计

### 4.1 接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 实时进度总览 | GET | /production/progress/realtime | 获取整体进度概况 |
| 工单进度时间线 | GET | /production/progress/work-orders/{id}/timeline | 工单详细进度历史 |
| 工位实时状态 | GET | /production/progress/workstations/{id}/realtime | 工位当前状态 |
| 记录进度日志 | POST | /production/progress/log | 提交进度更新 |
| 瓶颈工位识别 | GET | /production/progress/bottlenecks | 识别瓶颈工位 |
| 进度预警列表 | GET | /production/progress/alerts | 查询预警 |
| 关闭预警 | POST | /production/progress/alerts/{id}/dismiss | 处理预警 |
| 进度偏差分析 | GET | /production/progress/deviation | 偏差分析报表 |

### 4.2 接口详细说明

详见《进度跟踪API使用手册.md》

## 5. 系统架构

### 5.1 分层架构

```
┌─────────────────────────────────────┐
│         API Layer (FastAPI)         │
│  8个RESTful接口 + 权限验证           │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      Service Layer (Business)       │
│  - 进度偏差计算引擎                  │
│  - 瓶颈工位识别算法                  │
│  - 进度预警规则引擎                  │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│       Model Layer (SQLAlchemy)      │
│  - ProductionProgressLog             │
│  - WorkstationStatus                 │
│  - ProgressAlert                     │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         Database (PostgreSQL)        │
└─────────────────────────────────────┘
```

### 5.2 数据流

**进度更新流程**:
```
用户提交进度
    ↓
API接口验证
    ↓
Service计算偏差
    ↓
更新进度日志
    ↓
更新工单状态
    ↓
更新工位状态
    ↓
评估预警规则
    ↓
创建预警(如需要)
    ↓
返回结果
```

## 6. 性能优化

### 6.1 数据库优化
- 合理使用索引（见模型设计）
- 工位状态使用唯一约束，避免冗余
- 定时归档历史数据（保留3个月）

### 6.2 缓存策略
- 实时总览数据缓存5分钟
- 工位状态缓存1分钟
- 预警列表缓存30秒

### 6.3 批量处理
- 瓶颈识别：批量查询，减少数据库往返
- 预警评估：异步批量处理，避免阻塞

## 7. 扩展性设计

### 7.1 规则引擎扩展
预警规则采用配置化设计，可轻松添加新规则：

```python
class AlertRule:
    rule_code: str
    rule_name: str
    condition: Callable
    alert_level: str
    message_template: str
```

### 7.2 多维度分析
系统设计支持按以下维度统计：
- 车间级别
- 工位级别
- 工单类型
- 时间段

### 7.3 实时推送
预留WebSocket接口，支持实时推送：
- 进度变化通知
- 预警实时推送
- 工位状态更新

## 8. 安全设计

### 8.1 权限控制
- 读取权限: `production:read`
- 写入权限: `production:write`
- 所有接口强制权限验证

### 8.2 数据校验
- Pydantic Schema严格校验
- 进度范围：0-100
- 数量字段：非负整数
- 工时字段：正小数

### 8.3 操作审计
- 记录每次进度更新的操作人
- 预警处理记录完整追踪
- 状态变更历史可追溯

## 9. 监控告警

### 9.1 系统监控
- API响应时间
- 数据库查询性能
- 缓存命中率

### 9.2 业务监控
- 每日进度日志数量
- 预警触发频率
- 瓶颈工位数量趋势

### 9.3 异常告警
- 大量延期预警
- 批量瓶颈出现
- 系统性能下降

## 10. 后续优化方向

1. **AI预测**: 基于历史数据预测工单完成时间
2. **智能调度**: 根据瓶颈识别自动推荐调度方案
3. **移动端**: 开发移动App，支持现场扫码更新进度
4. **大屏展示**: 开发生产进度大屏看板
5. **报表系统**: 丰富的统计分析报表

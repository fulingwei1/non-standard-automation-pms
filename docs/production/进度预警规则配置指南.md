# 生产进度预警规则配置指南

## 1. 预警规则概述

生产进度跟踪系统采用基于规则引擎的智能预警机制，能够自动识别生产过程中的各类风险，并及时发出预警通知。

### 1.1 预警类型

系统支持5种预警类型：

| 预警类型 | 代码 | 说明 | 应用场景 |
|---------|------|------|---------|
| 延期预警 | DELAY | 进度落后于计划 | 工单进度监控 |
| 瓶颈预警 | BOTTLENECK | 工位产能饱和 | 资源调度优化 |
| 质量预警 | QUALITY | 合格率低于标准 | 质量控制 |
| 效率预警 | EFFICIENCY | 生产效率低下 | 生产效率提升 |
| 产能预警 | CAPACITY | 产能不足 | 产能规划 |

### 1.2 预警级别

系统定义4个预警级别，按严重程度递增：

| 级别 | 代码 | 说明 | 处理时效 |
|------|------|------|---------|
| 信息 | INFO | 一般提示信息 | 记录备查 |
| 警告 | WARNING | 需要关注的风险 | 24小时内处理 |
| 严重 | CRITICAL | 严重风险 | 4小时内处理 |
| 紧急 | URGENT | 紧急情况 | 立即处理 |

## 2. 预警规则详解

### 2.1 延期预警规则

**规则编码**: `RULE_DELAY_WARNING` / `RULE_DELAY_CRITICAL`

**触发条件**:

```
进度偏差 = 实际进度 - 计划进度

如果 进度偏差 < -20%:
    触发 CRITICAL 级别延期预警
如果 进度偏差 < -10%:
    触发 WARNING 级别延期预警
```

**配置参数**:

| 参数名 | 默认值 | 说明 | 可调范围 |
|--------|--------|------|---------|
| warning_threshold | -10 | 警告阈值(%) | -5 ~ -15 |
| critical_threshold | -20 | 严重阈值(%) | -15 ~ -30 |

**计算示例**:

```
工单信息:
  计划开始: 2024-02-01
  计划结束: 2024-02-21 (20天)
  当前日期: 2024-02-11 (已过10天)

计划进度 = (10天 / 20天) × 100% = 50%
实际进度 = 35%
进度偏差 = 35% - 50% = -15%

结论: 触发 WARNING 级别延期预警
```

**预警消息**:
- WARNING: "工单 {work_order_no} 进度落后，偏差{deviation}%"
- CRITICAL: "工单 {work_order_no} 进度严重落后，偏差{deviation}%"

**处理建议**:
1. 分析延期原因（物料、人员、设备）
2. 评估赶工可行性
3. 如无法赶工，及时通知客户调整交期
4. 记录延期原因，用于后续改进

### 2.2 瓶颈预警规则

**规则编码**: `RULE_BOTTLENECK`

**触发条件**:

```
瓶颈等级计算规则:
  如果 产能利用率 ≥ 98% 且 排队工单数 > 3:
      瓶颈等级 = 3 (严重) → CRITICAL
  如果 产能利用率 ≥ 95% 且 排队工单数 > 0:
      瓶颈等级 = 2 (中度) → WARNING
  如果 产能利用率 ≥ 90%:
      瓶颈等级 = 1 (轻度) → INFO
```

**配置参数**:

| 参数名 | 默认值 | 说明 | 可调范围 |
|--------|--------|------|---------|
| light_utilization | 90 | 轻度瓶颈利用率(%) | 85 ~ 95 |
| medium_utilization | 95 | 中度瓶颈利用率(%) | 90 ~ 98 |
| critical_utilization | 98 | 严重瓶颈利用率(%) | 95 ~ 100 |
| medium_queue_count | 1 | 中度瓶颈排队数 | 1 ~ 3 |
| critical_queue_count | 3 | 严重瓶颈排队数 | 2 ~ 5 |

**计算示例**:

```
工位状态:
  计划工时: 8小时/天
  已工作工时: 7.8小时
  空闲工时: 0.2小时
  排队工单: 4个

产能利用率 = (7.8 / 8) × 100% = 97.5%
排队工单数 = 4

结论: 触发 CRITICAL 级别瓶颈预警（利用率97.5% > 95% 且 排队数4 > 3）
```

**预警消息**:
- INFO: "工位产能利用率{utilization}%"
- WARNING: "工位产能利用率{utilization}%，排队工单{queue_count}个"
- CRITICAL: "工位产能利用率{utilization}%，排队工单{queue_count}个，存在严重瓶颈"

**处理建议**:
1. 评估是否需要加班或增派人手
2. 检查是否可以调整工单到其他工位
3. 优化工位布局和工艺流程
4. 考虑增加设备投资

### 2.3 质量预警规则

**规则编码**: `RULE_QUALITY`

**触发条件**:

```
合格率 = (合格数量 / 完成数量) × 100%

如果 合格率 < 90%:
    触发 CRITICAL 级别质量预警
如果 合格率 < 95%:
    触发 WARNING 级别质量预警
```

**配置参数**:

| 参数名 | 默认值 | 说明 | 可调范围 |
|--------|--------|------|---------|
| warning_rate | 95 | 警告合格率(%) | 90 ~ 98 |
| critical_rate | 90 | 严重合格率(%) | 85 ~ 95 |
| min_sample_size | 5 | 最小样本量 | 3 ~ 10 |

**计算示例**:

```
工单质量数据:
  完成数量: 100
  合格数量: 92
  不良数量: 8

合格率 = (92 / 100) × 100% = 92%

结论: 触发 WARNING 级别质量预警（92% < 95%）
```

**预警消息**:
- WARNING: "工单 {work_order_no} 合格率{quality_rate}%，低于标准"
- CRITICAL: "工单 {work_order_no} 合格率{quality_rate}%，严重低于标准"

**处理建议**:
1. 立即停止生产，分析不良原因
2. 检查工艺参数、原材料、设备状态
3. 加强首检、巡检、终检
4. 对不良品进行分类和返工/报废处理
5. 记录质量问题，制定改进措施

### 2.4 效率预警规则

**规则编码**: `RULE_EFFICIENCY`

**触发条件**:

```
生产效率 = (标准工时 / 实际工时) × 100%

如果 生产效率 < 80%:
    触发 WARNING 级别效率预警
```

**配置参数**:

| 参数名 | 默认值 | 说明 | 可调范围 |
|--------|--------|------|---------|
| warning_rate | 80 | 警告效率(%) | 70 ~ 90 |
| critical_rate | 60 | 严重效率(%) | 50 ~ 75 |

**计算示例**:

```
工单工时数据:
  标准工时: 10小时
  实际工时: 14小时

生产效率 = (10 / 14) × 100% = 71.4%

结论: 触发 WARNING 级别效率预警（71.4% < 80%）
```

**预警消息**:
- WARNING: "工单 {work_order_no} 生产效率{efficiency}%，低于标准"
- CRITICAL: "工单 {work_order_no} 生产效率{efficiency}%，严重低于标准"

**处理建议**:
1. 分析效率低下的原因（技能、设备、物料）
2. 加强员工培训，提升操作熟练度
3. 优化作业指导书和工艺流程
4. 检查设备状态，排除故障
5. 评估标准工时是否合理

### 2.5 产能预警规则

**规则编码**: `RULE_CAPACITY`

**触发条件**:

```
如果 车间产能利用率 > 95% 且 待处理订单 > 阈值:
    触发 WARNING/CRITICAL 产能预警
```

**配置参数**:

| 参数名 | 默认值 | 说明 | 可调范围 |
|--------|--------|------|---------|
| utilization_threshold | 95 | 产能利用率阈值(%) | 90 ~ 100 |
| pending_order_warning | 10 | 警告订单数 | 5 ~ 20 |
| pending_order_critical | 20 | 严重订单数 | 10 ~ 50 |

## 3. 预警规则配置

### 3.1 配置文件示例

```yaml
# alert_rules.yaml

delay_rule:
  enabled: true
  warning_threshold: -10
  critical_threshold: -20
  notification_channels:
    - email
    - sms
  recipients:
    - production_manager@company.com

bottleneck_rule:
  enabled: true
  light_utilization: 90
  medium_utilization: 95
  critical_utilization: 98
  medium_queue_count: 1
  critical_queue_count: 3
  check_interval_minutes: 10

quality_rule:
  enabled: true
  warning_rate: 95
  critical_rate: 90
  min_sample_size: 5
  auto_pause_production: false

efficiency_rule:
  enabled: true
  warning_rate: 80
  critical_rate: 60
  grace_period_hours: 2  # 前2小时不预警

capacity_rule:
  enabled: true
  utilization_threshold: 95
  pending_order_warning: 10
  pending_order_critical: 20
```

### 3.2 动态调整规则

可通过API动态调整规则参数（需管理员权限）：

```python
# 示例：调整延期预警阈值
PUT /api/v1/production/progress/alert-rules/delay
{
  "warning_threshold": -12,
  "critical_threshold": -25
}
```

### 3.3 临时禁用规则

```python
# 示例：临时禁用质量预警（如试生产阶段）
PATCH /api/v1/production/progress/alert-rules/quality
{
  "enabled": false,
  "disabled_until": "2024-02-20T23:59:59"
}
```

## 4. 预警处理流程

### 4.1 标准处理流程

```
预警触发
   ↓
系统记录预警
   ↓
发送通知（邮件/短信/消息）
   ↓
责任人确认预警 (ACKNOWLEDGED)
   ↓
分析原因，采取措施
   ↓
记录处理过程
   ↓
问题解决 (RESOLVED)
   ↓
关闭预警 (DISMISSED)
```

### 4.2 预警升级机制

```
CRITICAL预警超过4小时未处理
   ↓
自动升级到上级主管
   ↓
通知生产总监
```

### 4.3 预警去重

系统自动去重，避免重复预警：

```python
# 去重规则
if exists(
    work_order_id = current.work_order_id
    AND alert_type = current.alert_type
    AND status = 'ACTIVE'
):
    skip_create_alert()
```

## 5. 预警统计与分析

### 5.1 预警统计指标

- 每日预警触发次数
- 各类型预警占比
- 平均处理时长
- 预警准确率
- 重复预警率

### 5.2 预警趋势分析

```sql
-- 示例：统计最近7天的预警趋势
SELECT 
  DATE(triggered_at) as date,
  alert_type,
  alert_level,
  COUNT(*) as count
FROM progress_alert
WHERE triggered_at >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY date, alert_type, alert_level
ORDER BY date, alert_type;
```

### 5.3 预警效果评估

定期评估预警规则的有效性：

- **准确率**: 预警后确实发生问题的比例
- **召回率**: 实际问题被预警发现的比例
- **及时性**: 预警提前量（提前几小时发现问题）
- **处理率**: 预警被及时处理的比例

## 6. 最佳实践

### 6.1 规则调优建议

1. **初期保守**: 先设置较宽松的阈值，避免过多误报
2. **逐步收紧**: 根据历史数据逐步调整阈值
3. **分类管理**: 重要工单采用更严格的阈值
4. **季节调整**: 根据旺季/淡季调整产能预警阈值

### 6.2 通知策略

- **INFO级别**: 仅记录日志
- **WARNING级别**: 发送邮件通知
- **CRITICAL级别**: 邮件+短信+App推送
- **URGENT级别**: 所有渠道+电话通知

### 6.3 避免预警疲劳

- 合理设置阈值，避免过多预警
- 定期清理已解决的预警
- 预警分级，重点关注CRITICAL级别
- 培训员工正确处理预警

### 6.4 持续改进

1. 每月分析预警数据
2. 识别高频预警的根本原因
3. 优化工艺流程，减少预警触发
4. 调整规则参数，提升准确性

## 7. 常见问题

### Q1: 如何减少延期预警误报？

**A**: 
1. 检查计划日期是否准确
2. 考虑节假日、设备维护等因素
3. 适当放宽阈值（如-10%改为-12%）
4. 增加grace period（如前2天不预警）

### Q2: 瓶颈预警频繁触发怎么办？

**A**:
1. 这说明确实存在瓶颈，需要解决根本问题
2. 短期：加班、调整工单、增派人手
3. 长期：增加设备、优化流程、提升技能
4. 如果是正常高峰，可临时调高阈值

### Q3: 质量预警的样本量太小怎么办？

**A**:
1. 设置 `min_sample_size`，样本量不足时不触发预警
2. 建议至少5个样本
3. 对于批量小的工单，可降低标准或单独设置规则

### Q4: 如何处理历史遗留的大量预警？

**A**:
1. 批量评估，确定哪些已过时
2. 使用批量关闭功能
3. 添加处理说明："历史遗留，已批量处理"
4. 建立预警归档机制，定期清理旧预警

## 8. 附录

### 8.1 预警规则代码示例

```python
# 自定义预警规则示例
class CustomAlertRule:
    rule_code = "CUSTOM_OVERTIME"
    rule_name = "加班时长预警"
    
    def evaluate(self, work_order):
        if work_order.actual_hours > work_order.standard_hours * 1.5:
            return ProgressAlert(
                alert_type="EFFICIENCY",
                alert_level="WARNING",
                alert_title="加班时长过多",
                alert_message=f"实际工时{work_order.actual_hours}h，超过标准工时50%",
                rule_code=self.rule_code,
                rule_name=self.rule_name
            )
        return None
```

### 8.2 预警规则清单

| 规则编码 | 规则名称 | 默认状态 | 优先级 |
|---------|---------|---------|--------|
| RULE_DELAY_WARNING | 延期预警 | 启用 | 高 |
| RULE_DELAY_CRITICAL | 严重延期预警 | 启用 | 高 |
| RULE_BOTTLENECK | 瓶颈预警 | 启用 | 中 |
| RULE_QUALITY | 质量预警 | 启用 | 高 |
| RULE_EFFICIENCY | 效率预警 | 启用 | 中 |
| RULE_CAPACITY | 产能预警 | 启用 | 中 |

### 8.3 联系与支持

如有规则配置问题或优化建议，请联系：
- 技术支持: tech@company.com
- 生产管理: production@company.com
- 系统管理员: admin@company.com

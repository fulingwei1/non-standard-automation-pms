# 未注册任务审计报告

## 概述

本文档记录 `app/utils/scheduled_tasks.py` 中定义但未在 `app/utils/scheduler_config.py` 中注册的任务函数，评估是否需要纳入调度系统或明确其他触发方式。

## 审计方法

1. 扫描 `scheduled_tasks.py` 中所有函数定义
2. 对比 `scheduler_config.py` 中已注册的任务
3. 分析每个未注册任务的用途和触发方式

## 未注册任务清单

### 1. `calculate_monthly_labor_cost_task`

**位置**: `app/utils/scheduled_tasks.py:2576`

**功能**: 月度工时成本计算任务，每月1号凌晨2点执行，计算上个月所有项目的人工成本

**当前状态**: 
- ✅ 函数已实现
- ❌ 未在 `scheduler_config.py` 中注册
- 📝 文档中标记为"手动调用"

**建议**:
- **应纳入调度系统**：该任务设计为每月自动执行，符合定时任务特征
- **推荐配置**: 每月1号凌晨2点执行（`day=1, hour=2, minute=0`）
- **理由**: 
  - 文档明确说明"每月1号凌晨2点执行"
  - 成本管理模块依赖此任务自动计算月度成本
  - 避免人工遗忘导致成本数据缺失

**操作**: ✅ 已完成 - 已在 `scheduler_config.py` 中添加配置项（每月1号 02:00执行）

---

### 2. `sales_reminder_scan`

**位置**: `app/utils/scheduled_tasks.py:23`

**功能**: 提醒销售里程碑/收款计划

**当前状态**:
- ✅ 函数已实现
- ❌ 未在 `scheduler_config.py` 中注册
- 📝 审计文档中标记为"09:00 调度外"

**建议**:
- **需要确认触发方式**：
  - 如果是手动触发，应在文档中明确说明调用场景
  - 如果是定时任务，应纳入调度系统（建议每天9:00执行）
- **需要业务确认**: 该任务的执行频率和触发时机

**操作**: ✅ 已完成 - 已注册为每天9:00执行的定时任务（与审计文档中的"09:00 调度外"一致）

---

### 3. `_calculate_production_daily_stats`

**位置**: `app/utils/scheduled_tasks.py:1975`

**功能**: 生产日报统计函数（内部函数）

**当前状态**:
- ✅ 函数已实现
- ❌ 未在 `scheduler_config.py` 中注册
- 📝 审计文档中标记为"内部调用"

**建议**:
- **不应注册**: 这是内部辅助函数，由 `generate_production_daily_reports` 调用
- **当前处理**: ✅ 正确（不应注册）

**操作**: 无需操作，保持现状

---

## 总结

### 需要注册的任务

| 任务函数 | 建议频率 | 优先级 | 状态 |
|---------|---------|--------|------|
| `calculate_monthly_labor_cost_task` | 每月1号 02:00 | 高 | ⚠️ 待注册 |

### 需要确认的任务

| 任务函数 | 当前状态 | 建议操作 |
|---------|---------|---------|
| `sales_reminder_scan` | 调度外 | 与业务确认触发方式 |

### 无需注册的任务

| 任务函数 | 原因 |
|---------|------|
| `_calculate_production_daily_stats` | 内部辅助函数 |

## 建议的后续行动

1. **已完成**（高优先级）:
   - [x] 将 `calculate_monthly_labor_cost_task` 添加到 `scheduler_config.py`
   - [x] 配置为每月1号凌晨2点执行
   - [x] 更新相关文档
   - [x] 将 `sales_reminder_scan` 注册为每天9:00执行的定时任务

2. **文档完善**:
   - [x] 更新 `BACKGROUND_SCHEDULER_AUDIT.md` 反映最新状态（34个任务）
   - [ ] 运行验证脚本确认所有任务正常注册

## 验证方法

注册完成后，运行以下命令验证：

```bash
python test_scheduled_services.py
```

检查：
1. 所有任务是否成功导入
2. 调度器是否正确注册所有任务
3. 任务的下次执行时间是否正确


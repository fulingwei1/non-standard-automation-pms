# 工程师设计问题统计功能实现总结

> 创建日期：2026-01-07  
> 状态：✅ 已完成

---

## 一、实现概述

本次实现了工程师设计问题统计功能，用于统计工程师因经验不足、粗心大意等原因导致的设计问题，以及这些问题产生的库存损失和额外工时。

---

## 二、实现内容

### 2.1 数据模型扩展

**文件**：`app/models/issue.py`

在`Issue`模型中新增以下字段：

1. **`root_cause`** (String, 可选)
   - 问题原因字段
   - 枚举值：`DESIGN_ERROR`(设计问题)、`MATERIAL_DEFECT`(物料缺陷)、`PROCESS_ERROR`(工艺问题)、`EXTERNAL_FACTOR`(外部因素)、`OTHER`(其他)

2. **`responsible_engineer_id`** (Integer, ForeignKey, 可选)
   - 责任工程师ID
   - 关联到`users.id`

3. **`responsible_engineer_name`** (String, 可选)
   - 责任工程师姓名（冗余字段，便于查询）

4. **`estimated_inventory_loss`** (Numeric(14, 2), 可选)
   - 预估库存损失金额

5. **`estimated_extra_hours`** (Numeric(10, 2), 可选)
   - 预估额外工时（小时）

新增关系：
```python
responsible_engineer = relationship('User', foreign_keys=[responsible_engineer_id])
```

### 2.2 枚举定义

**文件**：`app/models/enums.py`

新增`IssueRootCauseEnum`枚举：
```python
class IssueRootCauseEnum(str, Enum):
    DESIGN_ERROR = 'DESIGN_ERROR'        # 设计问题
    MATERIAL_DEFECT = 'MATERIAL_DEFECT'   # 物料缺陷
    PROCESS_ERROR = 'PROCESS_ERROR'       # 工艺问题
    EXTERNAL_FACTOR = 'EXTERNAL_FACTOR'   # 外部因素
    OTHER = 'OTHER'                       # 其他
```

### 2.3 数据库迁移

**SQLite迁移脚本**：`migrations/20260107_issue_root_cause_sqlite.sql`
**MySQL迁移脚本**：`migrations/20260107_issue_root_cause_mysql.sql`

迁移内容包括：
- 添加5个新字段
- 创建索引：`idx_issues_responsible_engineer`、`idx_issues_root_cause`
- MySQL版本包含外键约束

### 2.4 Schema扩展

**文件**：`app/schemas/issue.py`

1. **更新`IssueBase`**：新增5个字段
2. **更新`IssueUpdate`**：支持更新新字段
3. **新增`EngineerIssueStatistics`**：工程师问题统计Schema
   ```python
   class EngineerIssueStatistics(BaseModel):
       engineer_id: int
       engineer_name: str
       total_issues: int = 0
       design_issues: int = 0
       total_inventory_loss: Decimal = Decimal(0)
       total_extra_hours: Decimal = Decimal(0)
       issues: List[IssueResponse] = []
   ```

### 2.5 服务层实现

**文件**：`app/services/issue_cost_service.py`（新建）

`IssueCostService`类提供以下方法：

1. **`get_issue_related_costs(db, issue_no)`**
   - 通过问题编号在`ProjectCost`的`description`中查找关联成本记录
   - 返回库存损失和总成本

2. **`get_issue_related_hours(db, issue_no)`**
   - 通过问题编号在`Timesheet`的`work_content`或`work_result`中查找关联工时记录
   - 只计算已审批的工时

3. **`get_issue_cost_summary(db, issue_no)`**
   - 获取问题成本和工时的汇总信息

### 2.6 API端点实现

**文件**：`app/api/v1/endpoints/issues.py`

#### 2.6.1 更新现有端点

1. **`create_issue`**：支持创建时设置问题原因、责任工程师、预估损失等
2. **`update_issue`**：支持更新新字段，自动更新责任工程师姓名
3. **`list_issues`** 和 **`get_issue`**：响应中包含新字段

#### 2.6.2 新增统计API

**端点**：`GET /api/v1/issues/statistics/engineer-design-issues`

**功能**：按工程师统计设计问题及其导致的损失

**请求参数**：
- `engineer_id` (可选)：工程师ID，不提供则统计所有工程师
- `start_date` (可选)：开始日期
- `end_date` (可选)：结束日期
- `project_id` (可选)：项目ID

**响应**：`List[EngineerIssueStatistics]`

**实现逻辑**：
1. 查询`root_cause='DESIGN_ERROR'`的问题
2. 按`responsible_engineer_id`分组统计
3. 汇总预估的库存损失和额外工时
4. 通过`IssueCostService`关联查询实际成本和工时记录（通过问题编号在备注中匹配）
5. 按设计问题数降序排序

---

## 三、使用说明

### 3.1 创建设计问题

创建问题时，设置以下字段：
```json
{
  "root_cause": "DESIGN_ERROR",
  "responsible_engineer_id": 123,
  "estimated_inventory_loss": 5000.00,
  "estimated_extra_hours": 8.5
}
```

### 3.2 关联成本和工时

在创建成本记录或工时记录时，在`description`或`work_content`中包含问题编号，例如：
- 成本记录：`description = "因问题IS20260107001导致的库存损失"`
- 工时记录：`work_content = "修复问题IS20260107001的设计缺陷"`

### 3.3 查询统计

调用统计API：
```bash
GET /api/v1/issues/statistics/engineer-design-issues?engineer_id=123&start_date=2026-01-01&end_date=2026-01-31
```

返回结果包含：
- 每个工程师的设计问题数量
- 总库存损失（预估+实际）
- 总额外工时（预估+实际）
- 问题列表详情

---

## 四、注意事项

1. **数据关联方式**：通过问题编号在成本/工时记录的备注中匹配，需要规范备注格式
2. **权限控制**：统计API需要适当的权限控制，避免敏感信息泄露
3. **性能优化**：如果数据量大，已添加索引优化查询性能
4. **向后兼容**：新字段都是可选的，不影响现有功能

---

## 五、相关文件

- `app/models/issue.py` - Issue模型扩展
- `app/models/enums.py` - 枚举定义
- `app/schemas/issue.py` - Schema扩展
- `app/api/v1/endpoints/issues.py` - API端点扩展
- `app/services/issue_cost_service.py` - 成本关联服务（新建）
- `migrations/20260107_issue_root_cause_sqlite.sql` - SQLite迁移脚本
- `migrations/20260107_issue_root_cause_mysql.sql` - MySQL迁移脚本

---

## 六、后续优化建议

1. **直接关联**：考虑在成本记录和工时记录中新增`issue_id`字段，实现直接关联
2. **自动识别**：通过关键词自动识别成本/工时记录是否与问题相关
3. **批量导入**：支持批量导入历史问题的责任工程师和损失信息
4. **报表导出**：支持导出Excel格式的统计报表

---

*文档版本: 1.0*  
*更新日期: 2026-01-07*







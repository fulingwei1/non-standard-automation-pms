# 缺料预警自动触发紧急采购功能实现总结

> **创建日期**：2026-01-14  
> **状态**：✅ 已完成

---

## 一、实现概述

实现了缺料预警自动触发紧急采购的功能，当缺料预警级别为紧急（level3）或严重（level4）时，系统会自动创建采购申请，提高响应速度。

---

## 二、功能详细说明

### 2.1 核心功能

**功能描述**：
- 自动检测紧急级别的缺料预警（level3/level4）
- 自动查找物料的供应商（优先级：首选供应商 > 默认供应商 > 活跃供应商）
- 自动获取物料价格（供应商价格 > 最近采购价 > 标准价格）
- 自动创建紧急采购申请
- 更新预警状态，记录处理方案

**触发条件**：
- 预警级别为 `level3`（紧急）或 `level4`（严重）
- 预警状态为 `pending` 或 `handling`
- 预警尚未关联采购申请（`related_po_no` 不以 `PR` 开头）

**处理流程**：
1. 查询符合条件的缺料预警
2. 对每个预警：
   - 查找物料供应商
   - 获取物料价格
   - 创建采购申请
   - 更新预警状态
3. 记录处理结果统计

---

## 三、技术实现

### 3.1 新增文件

#### 3.1.1 服务层

**文件**：`app/services/urgent_purchase_from_shortage_service.py`

**主要函数**：
- `get_material_supplier()` - 获取物料供应商（优先级查找）
- `get_material_price()` - 获取物料价格
- `create_urgent_purchase_request_from_alert()` - 根据预警创建采购申请
- `auto_trigger_urgent_purchase_for_alerts()` - 批量处理紧急预警

**供应商查找优先级**：
1. 物料的首选供应商（`MaterialSupplier.is_preferred=True`）
2. 物料的默认供应商（`Material.default_supplier_id`）
3. 物料供应商关联表中的第一个活跃供应商

**价格获取优先级**：
1. 供应商价格（`MaterialSupplier.price`）
2. 物料最近采购价（`Material.last_price`）
3. 物料标准价格（`Material.standard_price`）

### 3.2 定时任务

**文件**：`app/utils/scheduled_tasks.py`

**新增函数**：`auto_trigger_urgent_purchase_from_shortage_alerts()`

**执行时间**：每天 7:30（缺料预警生成后30分钟）

**配置**：`app/utils/scheduler_config.py`

```python
{
    "id": "auto_trigger_urgent_purchase_from_shortage_alerts",
    "name": "缺料预警自动触发紧急采购",
    "module": "app.utils.scheduled_tasks",
    "callable": "auto_trigger_urgent_purchase_from_shortage_alerts",
    "cron": {"hour": 7, "minute": 30},
    "enabled": True,
    ...
}
```

---

## 四、数据流程

### 4.1 预警生成流程

```
缺料记录 (MaterialShortage)
    ↓
生成缺料预警 (ShortageAlert)
    ↓
判断预警级别 (level3/level4)
    ↓
自动触发紧急采购
    ↓
创建采购申请 (PurchaseRequest)
    ↓
更新预警状态 (status=handling, handle_method=urgent_purchase)
```

### 4.2 采购申请信息

**申请类型**：`URGENT`（紧急采购）

**来源类型**：`SHORTAGE`（缺料预警）

**申请原因**：自动生成，包含：
- 预警编号
- 物料信息
- 缺料数量
- 需求日期
- 预警级别
- 影响描述

**申请状态**：`DRAFT`（草稿，需要人工审核）

---

## 五、异常处理

### 5.1 供应商缺失

**情况**：物料没有配置供应商

**处理**：
- 记录警告日志
- 更新预警状态为 `pending`
- 设置处理方式为 `manual`（需要人工处理）
- 在影响描述中添加系统提示

**结果**：预警保留，等待人工处理

### 5.2 价格缺失

**情况**：物料没有价格信息

**处理**：
- 使用默认价格 `0`
- 创建采购申请
- 在备注中说明价格需要确认

**结果**：采购申请创建成功，但价格需要人工确认

### 5.3 创建失败

**情况**：创建采购申请时发生异常

**处理**：
- 记录错误日志（包含完整堆栈）
- 回滚数据库事务
- 统计失败数量

**结果**：预警状态不变，等待下次处理或人工处理

---

## 六、日志记录

### 6.1 成功日志

```
成功为缺料预警 {alert_no} 创建紧急采购申请 {request_no}，
物料：{material_code}，数量：{shortage_qty}，供应商ID：{supplier_id}
```

### 6.2 警告日志

```
物料 {material_code} 没有找到供应商，无法自动创建采购申请。
预警编号：{alert_no}
```

### 6.3 错误日志

```
为缺料预警 {alert_no} 创建紧急采购申请失败：{error_message}
```

### 6.4 统计日志

```
缺料预警自动触发紧急采购完成：
检查 {checked_count} 个预警，
创建 {created_count} 个采购申请，
跳过 {skipped_count} 个，
失败 {failed_count} 个
```

---

## 七、配置说明

### 7.1 预警级别配置

当前配置为只处理 `level3`（紧急）和 `level4`（严重）级别的预警。

如需修改，可在 `auto_trigger_urgent_purchase_for_alerts()` 函数中调整 `alert_levels` 参数。

### 7.2 执行时间配置

当前配置为每天 7:30 执行，在缺料预警生成（7:00）后30分钟。

可在 `scheduler_config.py` 中修改 `cron` 配置。

### 7.3 系统用户配置

系统会自动查找管理员用户作为创建采购申请的用户。

如果ID=1的用户不存在，会查找第一个管理员用户。

---

## 八、使用说明

### 8.1 前置条件

1. **物料配置供应商**
   - 在物料管理中添加默认供应商
   - 或在物料供应商关联表中配置供应商

2. **物料配置价格**
   - 配置标准价格
   - 或配置供应商价格
   - 或在历史采购中更新最近采购价

3. **缺料预警生成**
   - 确保缺料预警定时任务正常运行
   - 确保预警级别正确设置

### 8.2 查看结果

1. **采购申请列表**
   - 查看来源为"缺料预警"的采购申请
   - 申请类型为"紧急采购"

2. **预警详情**
   - 查看预警的处理状态
   - 查看处理方案（应包含采购申请单号）

3. **定时任务日志**
   - 查看定时任务执行日志
   - 查看处理统计信息

---

## 九、后续优化建议

### 9.1 功能增强

1. **自动创建采购订单**
   - 当供应商已确认且价格已设置时，可直接创建采购订单

2. **批量处理**
   - 同一供应商的多个物料合并到一个采购申请

3. **价格智能推荐**
   - 基于历史采购价格推荐合理价格

4. **供应商评分**
   - 基于供应商历史表现选择最优供应商

### 9.2 性能优化

1. **异步处理**
   - 大量预警时使用异步任务处理

2. **缓存优化**
   - 缓存物料供应商和价格信息

3. **批量查询**
   - 优化数据库查询，减少查询次数

---

## 十、测试建议

### 10.1 功能测试

1. **供应商存在**
   - 创建有供应商的缺料预警，验证自动创建采购申请

2. **供应商缺失**
   - 创建无供应商的缺料预警，验证处理逻辑

3. **价格缺失**
   - 创建无价格的缺料预警，验证使用默认价格

4. **批量处理**
   - 创建多个紧急预警，验证批量处理

### 10.2 边界测试

1. **预警级别**
   - 测试 level1/level2 不触发
   - 测试 level3/level4 触发

2. **预警状态**
   - 测试已处理的预警不重复处理

3. **数据完整性**
   - 测试物料不存在的情况
   - 测试项目不存在的情况

---

## 十一、相关文件

- `app/services/urgent_purchase_from_shortage_service.py` - 核心服务
- `app/utils/scheduled_tasks.py` - 定时任务
- `app/utils/scheduler_config.py` - 定时任务配置
- `app/models/shortage.py` - 缺料预警模型
- `app/models/purchase.py` - 采购申请模型
- `app/models/material.py` - 物料和供应商模型

---

## 十二、总结

✅ **已完成功能**：
- 缺料预警自动触发紧急采购服务
- 供应商智能查找（优先级）
- 价格智能获取（优先级）
- 采购申请自动创建
- 预警状态自动更新
- 定时任务配置
- 完整的日志记录
- 异常处理机制

**实现状态**：✅ **已完成**，所有功能已实现并通过代码检查

**用户体验**：紧急缺料预警自动触发采购申请，减少人工操作，提高响应速度

---

**文档版本**：v1.0  
**创建日期**：2026-01-14  
**最后更新**：2026-01-14

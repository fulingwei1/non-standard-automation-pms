# 设备档案管理功能实现总结

> **完成时间**: 2025-01-XX  
> **状态**: ✅ **已完成**

---

## 一、功能概述

完善了设备管理模块的文档档案管理功能，实现了设备相关文档的完整生命周期管理，包括：
- 电路图
- PLC程序
- Labelwork程序
- BOM文档
- FAT文档
- SAT文档
- 其他文档

所有文档支持版本管理，并与设备的生命周期阶段（S1-S9）关联。

---

## 二、实现内容

### 2.1 后端API实现

**文件**: `app/api/v1/endpoints/projects/machines/custom.py`

#### 2.1.1 上传设备文档

**端点**: `POST /api/v1/projects/{project_id}/machines/{machine_id}/documents/upload`

**功能**:
- ✅ 支持文件上传（multipart/form-data）
- ✅ 支持多种文档类型
- ✅ 支持版本号管理
- ✅ 支持关联设备生命周期阶段（S1-S9）
- ✅ 自动生成唯一文件名
- ✅ 保存文件到指定目录

**支持的文档类型**:
- `CIRCUIT_DIAGRAM`: 电路图
- `PLC_PROGRAM`: PLC程序
- `LABELWORK_PROGRAM`: Labelwork程序
- `BOM_DOCUMENT`: BOM文档
- `FAT_DOCUMENT`: FAT验收文档
- `SAT_DOCUMENT`: SAT验收文档
- `OTHER`: 其他文档

**请求参数**:
- `file`: 上传的文件（必需）
- `doc_type`: 文档类型（必需）
- `doc_name`: 文档名称（可选，默认使用文件名）
- `doc_no`: 文档编号（可选，用于版本管理）
- `version`: 版本号（默认：1.0）
- `machine_stage`: 关联的设备生命周期阶段（S1-S9，可选）
- `description`: 描述（可选）

#### 2.1.2 获取设备文档列表

**端点**: `GET /api/v1/projects/{project_id}/machines/{machine_id}/documents`

**功能**:
- ✅ 获取设备的所有文档
- ✅ **权限过滤**：只返回用户有权限访问的文档
- ✅ 支持按文档类型筛选
- ✅ 支持按类型分组返回
- ✅ 返回设备基本信息
- ✅ 返回被过滤掉的文档数量（`filtered_count`）

**权限说明**:
- 系统会自动过滤掉用户没有权限访问的文档类型
- 如果用户没有权限访问某类文档，该类文档不会出现在列表中
- 这样可以避免用户看到文档但无法下载的情况

**查询参数**:
- `doc_type`: 文档类型筛选（可选）
- `group_by_type`: 是否按类型分组（默认：true）

**响应格式**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "machine_id": 1,
    "machine_code": "PN001",
    "machine_name": "设备名称",
    "machine_stage": "S5",
    "documents_by_type": {
      "CIRCUIT_DIAGRAM": [...],
      "PLC_PROGRAM": [...],
      "BOM_DOCUMENT": [...]
    },
    "total_count": 10
  }
}
```

#### 2.1.3 下载设备文档

**端点**: `GET /api/v1/projects/{project_id}/machines/{machine_id}/documents/{doc_id}/download`

**功能**:
- ✅ 下载设备文档文件
- ✅ 自动设置文件名
- ✅ 支持各种文件类型

#### 2.1.4 获取文档版本历史

**端点**: `GET /api/v1/projects/{project_id}/machines/{machine_id}/documents/{doc_id}/versions`

**功能**:
- ✅ 获取文档的所有版本
- ✅ **权限检查**：只有有权限访问该文档类型的用户才能查看版本历史
- ✅ 基于文档编号（doc_no）或文档名称（doc_name）匹配
- ✅ 按创建时间倒序排列
- ✅ 权限过滤：只返回用户有权限访问的版本

**权限说明**:
- 如果用户没有权限访问该文档类型，将返回403错误
- 即使有权限，也只返回用户有权限访问的版本（如果同一文档的不同版本类型不同）

---

### 2.2 前端实现

**文件**: `frontend/src/pages/MachineManagement.jsx`

#### 2.2.1 机台详情页面增强

**新增功能**:
- ✅ 标签页式界面（基本信息、文档档案、BOM清单、服务历史）
- ✅ 文档档案标签页，按类型分类展示
- ✅ 文档上传功能
- ✅ 文档下载功能
- ✅ 文档版本查看功能

**文档类型图标和颜色**:
- 电路图: ⚡ 黄色
- PLC程序: 💻 蓝色
- Labelwork程序: 📄 紫色
- BOM文档: 📦 绿色
- FAT文档: ✅ 翠绿色
- SAT文档: ✅ 青色
- 其他文档: 📄 灰色

#### 2.2.2 文档上传对话框

**功能**:
- ✅ 文件选择
- ✅ 文档类型选择
- ✅ 文档名称、编号、版本号输入
- ✅ 关联生命周期阶段选择（S1-S9）
- ✅ 描述输入

#### 2.2.3 文档列表展示

**功能**:
- ✅ 按文档类型分组展示
- ✅ 显示文档名称、版本号、编号
- ✅ 显示上传时间和描述
- ✅ 下载按钮
- ✅ 版本历史查看按钮

---

### 2.3 API服务更新

**文件**: `frontend/src/services/api.js`

**新增方法**:
```javascript
machineApi.uploadDocument(machineId, formData)
machineApi.getDocuments(machineId, params)
machineApi.downloadDocument(machineId, docId)
machineApi.getDocumentVersions(machineId, docId)
```

---

## 三、文档类型与生命周期关联

### 3.1 文档类型说明

| 文档类型 | 说明 | 典型生命周期阶段 |
|---------|------|----------------|
| CIRCUIT_DIAGRAM | 电路图 | S2（方案设计）、S5（装配调试） |
| PLC_PROGRAM | PLC程序 | S2（方案设计）、S5（装配调试） |
| LABELWORK_PROGRAM | Labelwork程序 | S2（方案设计）、S5（装配调试） |
| BOM_DOCUMENT | BOM文档 | S2（方案设计）、S3（采购备料） |
| FAT_DOCUMENT | FAT验收文档 | S6（出厂验收） |
| SAT_DOCUMENT | SAT验收文档 | S8（现场安装） |
| OTHER | 其他文档 | 任意阶段 |

### 3.2 生命周期阶段

- **S1**: 需求进入
- **S2**: 方案设计
- **S3**: 采购备料
- **S4**: 加工制造
- **S5**: 装配调试
- **S6**: 出厂验收(FAT)
- **S7**: 包装发运
- **S8**: 现场安装(SAT)
- **S9**: 质保结项

---

## 四、版本管理机制

### 4.1 版本识别

文档版本通过以下方式识别：
1. **文档编号（doc_no）**: 如果提供了文档编号，所有相同编号的文档视为同一文档的不同版本
2. **文档名称（doc_name）**: 如果没有文档编号，相同名称的文档视为同一文档的不同版本

### 4.2 版本查询

通过 `/machines/{machine_id}/documents/{doc_id}/versions` 接口可以查看文档的所有版本，按创建时间倒序排列。

---

## 五、文件存储

### 5.1 存储路径

文档文件存储在：
```
{UPLOAD_DIR}/documents/machines/{machine_id}/{unique_filename}
```

### 5.2 文件命名

使用UUID生成唯一文件名，避免文件名冲突：
```
{uuid}.{原始文件扩展名}
```

---

## 六、使用示例

### 6.1 上传电路图

```javascript
const formData = new FormData()
formData.append('file', file)
formData.append('doc_type', 'CIRCUIT_DIAGRAM')
formData.append('doc_name', '主控电路图')
formData.append('doc_no', 'CIRCUIT-001')
formData.append('version', '1.0')
formData.append('machine_stage', 'S2')
formData.append('description', '设备主控电路原理图')

await machineApi.uploadDocument(machineId, formData)
```

### 6.2 获取设备所有文档

```javascript
const response = await machineApi.getDocuments(machineId, { group_by_type: true })
const documents = response.data.data.documents_by_type
```

### 6.3 下载文档

```javascript
await machineApi.downloadDocument(machineId, docId)
```

### 6.4 查看文档版本历史

```javascript
const versions = await machineApi.getDocumentVersions(machineId, docId)
```

---

## 七、权限控制

### 7.1 文档权限控制（上传和下载）

系统根据文档类型自动检查用户权限，**上传和下载都需要相应的权限**。不同文档类型需要不同的角色权限：

| 文档类型 | 允许访问的角色（上传/下载） | 说明 |
|---------|------------------------|------|
| **电路图** (CIRCUIT_DIAGRAM) | 电气工程师、PLC工程师、研发工程师、项目经理 | 技术文档，需要相关技术背景 |
| **PLC程序** (PLC_PROGRAM) | PLC工程师、电气工程师、研发工程师、项目经理 | 程序文件，需要编程能力 |
| **Labelwork程序** (LABELWORK_PROGRAM) | 电气工程师、PLC工程师、研发工程师、项目经理 | 程序文件，需要编程能力 |
| **BOM文档** (BOM_DOCUMENT) | PMC、物料工程师、项目经理、工程师 | 物料清单，需要物料管理权限 |
| **FAT文档** (FAT_DOCUMENT) | 质量工程师、项目经理、总经理 | 验收文档，需要质量或管理权限 |
| **SAT文档** (SAT_DOCUMENT) | 质量工程师、项目经理、总经理 | 验收文档，需要质量或管理权限 |
| **其他文档** (OTHER) | 项目成员（项目经理、工程师、PMC、质量等） | 通用文档，项目成员都可以访问 |

**注意**：上传和下载使用相同的权限控制规则，确保文档安全。

### 7.2 权限检查机制

**实现位置**: `app/core/security.py`

- ✅ 自动检查用户角色
- ✅ 根据文档类型验证权限
- ✅ 超级管理员拥有所有权限
- ✅ 权限不足时返回明确的错误提示
- ✅ 上传和下载使用统一的权限检查函数
- ✅ **文档列表查询时自动过滤**：只返回用户有权限访问的文档
- ✅ **版本历史查询时权限检查**：只有有权限的用户才能查看版本历史

**权限检查函数**:
```python
# 通用权限检查（用于上传和下载）
has_machine_document_permission(user: User, doc_type: str) -> bool

# 上传权限检查（兼容性函数，内部调用通用函数）
has_machine_document_upload_permission(user: User, doc_type: str) -> bool
```

### 7.3 权限错误提示

当用户没有权限上传或下载某类文档时，系统会返回：

**上传时**:
```
HTTP 403 Forbidden
"您没有权限上传{文档类型}类型的文档。请联系管理员分配相应角色权限。"
```

**下载时**:
```
HTTP 403 Forbidden
"您没有权限下载{文档类型}类型的文档。请联系管理员分配相应角色权限。"
```

**查看版本历史时**:
```
HTTP 403 Forbidden
"您没有权限查看{文档类型}类型的文档版本。请联系管理员分配相应角色权限。"
```

**前端提示**:
- 上传失败时：显示错误信息，并提示"如需上传此类型文档，请联系管理员分配相应角色权限。"
- 下载失败时：显示错误信息，并提示"如需下载此文档，请联系管理员分配相应角色权限。"
- 查看版本失败时：显示错误信息，并提示"如需查看此文档版本，请联系管理员分配相应角色权限。"

### 7.4 权限过滤机制

**文档列表查询**:
- 系统自动过滤掉用户没有权限访问的文档
- 用户只能看到自己有权限下载的文档列表
- 返回结果中包含 `filtered_count` 字段，表示被过滤掉的文档数量

**优势**:
- ✅ 避免用户看到文档但无法下载的困扰
- ✅ 提高用户体验
- ✅ 增强数据安全性
- ✅ 减少不必要的API调用

---

## 八、后续优化建议

1. **文档预览功能**: 支持PDF、图片等文档的在线预览
2. **文档审批流程**: 添加文档审批功能
3. **文档搜索**: 支持全文搜索和标签搜索
4. **文档关联**: 支持文档之间的关联关系
5. **批量上传**: 支持一次上传多个文档
6. **文档模板**: 提供常用文档模板
7. **版本对比**: 支持文档版本之间的对比功能
8. **权限细化**: 可以进一步细化文档访问权限（如只读、编辑、删除等）
9. **文档审批**: 添加文档审批流程，确保文档质量
10. **文档标签**: 支持文档标签功能，便于分类和搜索

---

## 八、安全性增强

### 8.1 权限过滤机制

**文档列表查询权限过滤**:
- ✅ 自动过滤用户没有权限访问的文档
- ✅ 用户只能看到自己有权限下载的文档
- ✅ 返回 `filtered_count` 字段，告知被过滤的文档数量
- ✅ 前端显示权限提示信息

**版本历史查询权限检查**:
- ✅ 检查用户是否有权限访问该文档类型
- ✅ 只返回用户有权限访问的版本
- ✅ 权限不足时返回明确的错误提示

**优势**:
- 避免用户看到文档但无法下载的困扰
- 提高用户体验
- 增强数据安全性
- 减少不必要的API调用

### 8.2 前端权限提示

**文档列表页面**:
- 如果有文档被权限过滤，显示黄色提示框
- 提示用户联系管理员分配权限
- 空列表时也显示提示信息

**操作失败提示**:
- 上传失败：显示权限错误和联系管理员提示
- 下载失败：显示权限错误和联系管理员提示
- 查看版本失败：显示权限错误和联系管理员提示

---

## 九、总结

设备档案管理功能已完整实现，包括：

1. ✅ **文档类型支持**: 7种文档类型，覆盖设备全生命周期
2. ✅ **版本管理**: 完整的文档版本管理机制
3. ✅ **生命周期关联**: 文档与设备生命周期阶段关联
4. ✅ **文件上传**: 支持文件上传和存储，带权限检查
5. ✅ **文档查询**: 按类型分类查询和展示，自动权限过滤
6. ✅ **文档下载**: 支持文档下载功能，带权限检查
7. ✅ **版本历史**: 查看文档版本历史，带权限检查
8. ✅ **用户界面**: 友好的标签页式界面
9. ✅ **权限控制**: 完整的权限控制机制（上传、下载、列表查询、版本查看）
10. ✅ **权限过滤**: 文档列表自动过滤无权限文档，提升安全性和用户体验
11. ✅ **友好提示**: 权限错误时提供明确的提示信息，引导用户联系管理员

所有功能已实现并可用，代码质量良好，包含完整的数据验证、错误处理和权限控制。

---

**最后更新**: 2025-01-XX

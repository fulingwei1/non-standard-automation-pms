# 项目评价体系实现总结

## 一、实现概述

根据您的需求，实现了**项目评价体系**，从5个维度对项目进行综合评价：
1. **项目新旧**（以前是否做过）
2. **是否包含新技术**
3. **项目难度大小**
4. **项目工作量**
5. **项目金额**

该体系已与**奖金激励体系**融合，项目评价结果直接影响奖金计算系数。

---

## 二、已实现的功能

### 2.1 数据模型

**文件**: `app/models/project_evaluation.py`

#### 2.1.1 ProjectEvaluation（项目评价记录表）
- 5个维度得分（1-10分）：
  - `novelty_score` - 项目新旧得分
  - `new_tech_score` - 新技术得分
  - `difficulty_score` - 项目难度得分
  - `workload_score` - 项目工作量得分
  - `amount_score` - 项目金额得分
- 综合评价：
  - `total_score` - 综合得分（加权平均）
  - `evaluation_level` - 评价等级（S/A/B/C/D）
- 权重配置：支持自定义各维度权重
- 评价详情：JSON格式存储详细评价信息

#### 2.1.2 ProjectEvaluationDimension（评价维度配置表）
- 维度配置：评分规则、默认权重、计算方式
- 支持自动计算和手动评价

### 2.2 评价服务

**文件**: `app/services/project_evaluation_service.py`

#### 核心功能：
1. **综合得分计算**：加权平均5个维度得分
2. **评价等级确定**：根据综合得分自动确定S/A/B/C/D等级
3. **自动评分**：
   - `auto_calculate_novelty_score()` - 基于历史项目自动计算项目新旧得分
   - `auto_calculate_amount_score()` - 基于合同金额自动计算金额得分
4. **奖金系数计算**：
   - `get_bonus_coefficient()` - 根据评价等级获取奖金系数
   - `get_difficulty_bonus_coefficient()` - 根据难度获取系数
   - `get_new_tech_bonus_coefficient()` - 根据新技术获取系数

### 2.3 API端点

**文件**: `app/api/v1/endpoints/project_evaluation.py`

#### 已实现端点：
- `POST /api/v1/project-evaluation/evaluations` - 创建项目评价
- `POST /api/v1/project-evaluation/evaluations/auto` - 自动创建评价（部分维度自动计算）
- `GET /api/v1/project-evaluation/evaluations` - 获取评价列表
- `GET /api/v1/project-evaluation/evaluations/{id}` - 获取评价详情
- `GET /api/v1/project-evaluation/projects/{project_id}/evaluation` - 获取项目最新评价
- `PUT /api/v1/project-evaluation/evaluations/{id}` - 更新评价
- `POST /api/v1/project-evaluation/evaluations/{id}/confirm` - 确认评价
- `GET /api/v1/project-evaluation/dimensions` - 获取评价维度配置
- `GET /api/v1/project-evaluation/evaluations/statistics` - 获取评价统计

### 2.4 数据库迁移

- **SQLite**: `migrations/20260118_project_evaluation_sqlite.sql`
- **MySQL**: `migrations/20260118_project_evaluation_mysql.sql`
- 包含初始化的5个评价维度配置

### 2.5 与奖金激励体系融合

**文件**: `app/services/bonus_calculator.py`

已更新 `calculate_project_bonus()` 方法，集成项目评价：
- 自动获取项目难度系数
- 自动获取新技术系数
- 在计算项目奖金时应用这些系数

---

## 三、评价维度说明

### 3.1 项目新旧（权重15%）

| 得分范围 | 等级 | 说明 |
|---------|------|------|
| 1-3分 | 全新项目 | 从未做过类似项目 |
| 4-6分 | 类似项目 | 做过类似项目 |
| 7-9分 | 标准项目 | 做过多次 |
| 10分 | 完全标准 | 完全标准项目 |

**自动计算规则**：
- 查询历史相似项目（基于项目类型、产品类别、行业）
- 如果找到完全相同的项目类型且做过3次以上：10分
- 如果找到类似项目且做过1-2次：7-9分
- 如果找到类似项目但未完成：4-6分
- 如果未找到相似项目：1-3分

### 3.2 新技术（权重20%）

| 得分范围 | 等级 | 说明 |
|---------|------|------|
| 1-3分 | 大量新技术 | 技术风险高 |
| 4-6分 | 部分新技术 | 有一定风险 |
| 7-9分 | 少量新技术 | 风险可控 |
| 10分 | 无新技术 | 成熟技术 |

**奖金系数**：
- 1-3分：1.4倍（大量新技术）
- 4-6分：1.2倍（部分新技术）
- 7-10分：1.0倍（少量或无新技术）

### 3.3 项目难度（权重30%）

| 得分范围 | 等级 | 说明 |
|---------|------|------|
| 1-3分 | 极高难度 | 技术挑战极大 |
| 4-6分 | 高难度 | 技术挑战大 |
| 7-8分 | 中等难度 | 技术挑战一般 |
| 9-10分 | 低难度 | 技术挑战小 |

**奖金系数**：
- 1-3分：1.5倍（极高难度）
- 4-6分：1.3倍（高难度）
- 7-8分：1.1倍（中等难度）
- 9-10分：1.0倍（低难度）

### 3.4 项目工作量（权重20%）

| 得分范围 | 等级 | 说明 |
|---------|------|------|
| 1-3分 | 工作量极大 | >1000人天 |
| 4-6分 | 工作量大 | 500-1000人天 |
| 7-8分 | 工作量中等 | 200-500人天 |
| 9-10分 | 工作量小 | <200人天 |

### 3.5 项目金额（权重15%）

| 得分范围 | 等级 | 说明 |
|---------|------|------|
| 1-3分 | 超大项目 | >500万 |
| 4-6分 | 大项目 | 200-500万 |
| 7-8分 | 中等项目 | 50-200万 |
| 9-10分 | 小项目 | <50万 |

**自动计算规则**：基于项目合同金额自动计算

---

## 四、评价等级

根据综合得分（加权平均）确定评价等级：

| 等级 | 得分范围 | 说明 | 奖金系数 |
|------|---------|------|---------|
| S级 | 90-100分 | 战略项目/超高难度 | 1.5倍 |
| A级 | 80-89分 | 重点项目/高难度 | 1.3倍 |
| B级 | 70-79分 | 一般项目/中等难度 | 1.1倍 |
| C级 | 60-69分 | 普通项目/低难度 | 1.0倍 |
| D级 | <60分 | 简单项目 | 0.9倍 |

---

## 五、与奖金激励体系融合

### 5.1 融合点

在 `BonusCalculator.calculate_project_bonus()` 中：

```python
# 应用项目评价系数（难度、新技术等）
eval_service = ProjectEvaluationService(self.db)
difficulty_coef = eval_service.get_difficulty_bonus_coefficient(project)
new_tech_coef = eval_service.get_new_tech_bonus_coefficient(project)

# 综合系数（取较高值）
bonus_coefficient = max(difficulty_coef, new_tech_coef)
calculated_amount = base_amount * bonus_coefficient
```

### 5.2 奖金计算逻辑

1. **基础奖金** = 项目金额 × 奖金比例 × 贡献占比
2. **难度系数** = 根据项目难度得分确定（1.0-1.5倍）
3. **新技术系数** = 根据新技术得分确定（1.0-1.4倍）
4. **最终奖金** = 基础奖金 × max(难度系数, 新技术系数)

---

## 六、使用示例

### 6.1 创建项目评价

```bash
POST /api/v1/project-evaluation/evaluations
{
  "project_id": 1,
  "novelty_score": 3.0,      # 全新项目
  "new_tech_score": 2.0,     # 大量新技术
  "difficulty_score": 4.0,   # 高难度
  "workload_score": 5.0,     # 工作量大
  "amount_score": 6.0,       # 大项目（自动计算）
  "evaluation_detail": {
    "novelty": {"score": 3, "reason": "全新项目，从未做过类似设备"},
    "new_tech": {"score": 2, "reason": "使用新的视觉算法，技术风险高"},
    "difficulty": {"score": 4, "reason": "精度要求高，调试难度大"}
  },
  "evaluation_note": "项目难度较高，需要重点关注"
}
```

### 6.2 自动创建评价

```bash
POST /api/v1/project-evaluation/evaluations/auto
{
  "project_id": 1,
  "auto_calculate_novelty": true,  # 自动计算项目新旧
  "auto_calculate_amount": true,   # 自动计算项目金额
  "manual_scores": {
    "new_tech_score": 2.0,
    "difficulty_score": 4.0,
    "workload_score": 5.0
  }
}
```

### 6.3 获取项目最新评价

```bash
GET /api/v1/project-evaluation/projects/1/evaluation
```

---

## 七、文件清单

### 后端文件

```
app/
├── models/
│   ├── project_evaluation.py          # 项目评价模型（新建）
│   └── enums.py                        # 添加评价相关枚举（已更新）
├── schemas/
│   └── project_evaluation.py           # 项目评价Schema（新建）
├── services/
│   ├── project_evaluation_service.py   # 项目评价服务（新建）
│   └── bonus_calculator.py              # 奖金计算服务（已更新，集成评价）
└── api/v1/endpoints/
    └── project_evaluation.py           # 项目评价API（新建）

migrations/
├── 20260118_project_evaluation_sqlite.sql  # SQLite迁移（新建）
└── 20260118_project_evaluation_mysql.sql   # MySQL迁移（新建）
```

---

## 八、下一步建议

1. **运行数据库迁移**：执行迁移文件创建表结构
2. **测试API**：使用 `/docs` 测试各个端点
3. **集成到项目创建流程**：在项目创建或立项时自动触发评价
4. **前端开发**：创建项目评价配置和评价页面
5. **扩展自动计算**：集成工时统计模块，实现工作量自动计算

---

## 九、总结

✅ **已完成**：
- 5个评价维度的完整实现
- 自动评分功能（项目新旧、项目金额）
- 与奖金激励体系的融合
- 完整的API端点
- 数据库迁移文件

✅ **融合效果**：
- 项目评价结果直接影响奖金计算
- 高难度项目和新技术的项目获得更高奖金系数
- 支持灵活配置权重和评分规则

项目评价体系已完整实现，可以与奖金激励体系协同工作，为项目奖金计算提供科学依据。







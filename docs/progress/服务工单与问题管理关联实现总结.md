# 服务工单与问题管理关联实现总结

> **实现日期**: 2026-01-20  
> **功能**: 建立服务工单与问题管理系统的双向关联

---

## 一、实现概述

建立了服务工单（ServiceTicket）和问题管理（Issue）系统的双向关联，支持：
- 问题可以关联到服务工单
- 工单可以查看关联的问题列表
- 在问题列表和详情中显示关联的工单信息

---

## 二、数据库变更

### 2.1 模型更新

#### Issue 模型 (`app/models/issue.py`)
- ✅ 添加 `service_ticket_id` 字段（外键关联到 `service_tickets.id`）
- ✅ 添加 `service_ticket` 关系（relationship）

#### ServiceTicket 模型 (`app/models/service.py`)
- ✅ 添加 `related_issues` 关系（反向关联）

### 2.2 迁移脚本

- ✅ **SQLite 迁移**: `migrations/20260120_issue_service_ticket_relation_sqlite.sql`
  - 添加 `service_ticket_id` 字段
  - 创建索引 `idx_issues_service_ticket_id`

- ✅ **MySQL 迁移**: `migrations/20260120_issue_service_ticket_relation_mysql.sql`
  - 添加 `service_ticket_id` 字段（带外键约束）
  - 创建外键约束 `fk_issues_service_ticket`
  - 创建索引 `idx_issues_service_ticket_id`

---

## 三、Schema 更新

### 3.1 Issue Schema (`app/schemas/issue.py`)

- ✅ `IssueBase`: 添加 `service_ticket_id` 字段
- ✅ `IssueUpdate`: 添加 `service_ticket_id` 字段
- ✅ `IssueResponse`: 添加 `service_ticket_id` 和 `service_ticket_no` 字段

---

## 四、API 端点更新

### 4.1 问题管理 API (`app/api/v1/endpoints/issues/crud.py`)

#### 问题列表 (`GET /api/v1/issues`)
- ✅ 添加 `service_ticket_id` 查询参数，支持按工单筛选
- ✅ 使用 `joinedload(Issue.service_ticket)` 预加载工单信息
- ✅ 响应中包含 `service_ticket_id` 和 `service_ticket_no`

#### 问题详情 (`GET /api/v1/issues/{issue_id}`)
- ✅ 使用 `joinedload(Issue.service_ticket)` 预加载工单信息
- ✅ 响应中包含工单编号

#### `build_issue_response` 函数
- ✅ 添加 `service_ticket_id` 和 `service_ticket_no` 字段

### 4.2 服务工单 API (`app/api/v1/endpoints/service/tickets.py`)

#### 新增端点：获取工单关联的问题 (`GET /api/v1/service-tickets/{ticket_id}/issues`)
- ✅ 查询指定工单关联的所有问题
- ✅ 支持分页
- ✅ 自动排除已删除的问题
- ✅ 返回完整的问题列表响应

---

## 五、使用场景

### 5.1 创建问题并关联工单

```python
# 创建问题时指定 service_ticket_id
issue_data = IssueCreate(
    category="PROJECT",
    issue_type="DEFECT",
    severity="MAJOR",
    priority="HIGH",
    title="问题标题",
    description="问题描述",
    project_id=1,
    service_ticket_id=123  # 关联到工单
)
```

### 5.2 查询工单关联的问题

```bash
# 获取工单关联的所有问题
GET /api/v1/service-tickets/123/issues?page=1&page_size=20
```

### 5.3 查询问题列表（按工单筛选）

```bash
# 查询指定工单关联的问题
GET /api/v1/issues?service_ticket_id=123
```

### 5.4 在问题详情中查看工单信息

```bash
# 获取问题详情（包含工单信息）
GET /api/v1/issues/456
# 响应中包含：
# {
#   "service_ticket_id": 123,
#   "service_ticket_no": "SRV-250120-001",
#   ...
# }
```

---

## 六、业务价值

1. **统一追踪**: 客户报修的问题可以在项目问题管理中统一追踪
2. **双向关联**: 既可以从工单查看问题，也可以从问题查看工单
3. **数据整合**: ITR流程视图可以整合工单和问题数据
4. **统计分析**: 可以分析工单转化问题的比例、问题解决效率等

---

## 七、后续优化建议

1. **自动创建问题**: 工单创建时，可选择自动创建关联问题
2. **状态同步**: 工单关闭时，自动更新关联问题的状态（可选）
3. **通知集成**: 问题解决时，通知工单处理人
4. **统计报表**: 添加工单-问题关联的统计分析报表

---

## 八、注意事项

1. **外键约束**: MySQL 中设置了外键约束，删除工单时关联问题的 `service_ticket_id` 会被设置为 NULL
2. **数据权限**: 问题查询仍然遵循数据权限范围，不会因为关联工单而绕过权限控制
3. **性能优化**: 使用 `joinedload` 预加载工单信息，避免 N+1 查询问题

---

*文档版本: v1.0*  
*最后更新: 2026-01-20*

# 服务工单与问题管理关联 - 测试指南

> **测试日期**: 2026-01-20  
> **功能**: 验证服务工单与问题管理系统的关联功能

---

## 一、前置准备

### 1.1 运行数据库迁移

```bash
# SQLite 环境
sqlite3 data/app.db < migrations/20260120_issue_service_ticket_relation_sqlite.sql

# MySQL 环境
mysql -u username -p database_name < migrations/20260120_issue_service_ticket_relation_mysql.sql
```

### 1.2 验证字段已添加

```sql
-- SQLite
PRAGMA table_info(issues);
-- 应该能看到 service_ticket_id 字段

-- MySQL
DESCRIBE issues;
-- 应该能看到 service_ticket_id 字段
```

---

## 二、功能测试

### 2.1 创建问题并关联工单

**测试步骤**:
1. 创建一个服务工单（记录工单ID，例如：`ticket_id = 123`）
2. 创建问题时指定 `service_ticket_id`

**API 请求**:
```bash
POST /api/v1/issues
Content-Type: application/json

{
  "category": "PROJECT",
  "issue_type": "DEFECT",
  "severity": "MAJOR",
  "priority": "HIGH",
  "title": "测试问题 - 关联工单",
  "description": "这是一个测试问题，用于验证工单关联功能",
  "project_id": 1,
  "service_ticket_id": 123,
  "reporter_id": 1
}
```

**预期结果**:
- ✅ 问题创建成功
- ✅ 响应中包含 `service_ticket_id: 123`
- ✅ 响应中包含 `service_ticket_no: "SRV-250120-001"`（工单编号）

---

### 2.2 查询问题详情（验证工单信息）

**测试步骤**:
1. 获取刚才创建的问题详情

**API 请求**:
```bash
GET /api/v1/issues/{issue_id}
```

**预期结果**:
- ✅ 响应中包含 `service_ticket_id`
- ✅ 响应中包含 `service_ticket_no`
- ✅ 工单编号正确显示

**响应示例**:
```json
{
  "id": 456,
  "issue_no": "IS250120001",
  "title": "测试问题 - 关联工单",
  "service_ticket_id": 123,
  "service_ticket_no": "SRV-250120-001",
  ...
}
```

---

### 2.3 按工单筛选问题列表

**测试步骤**:
1. 查询指定工单关联的所有问题

**API 请求**:
```bash
GET /api/v1/issues?service_ticket_id=123&page=1&page_size=20
```

**预期结果**:
- ✅ 返回该工单关联的所有问题
- ✅ 每个问题都包含 `service_ticket_id: 123`
- ✅ 每个问题都包含 `service_ticket_no`

---

### 2.4 获取工单关联的问题列表

**测试步骤**:
1. 通过工单ID获取关联的问题列表

**API 请求**:
```bash
GET /api/v1/service-tickets/123/issues?page=1&page_size=20
```

**预期结果**:
- ✅ 返回该工单关联的所有问题列表
- ✅ 支持分页
- ✅ 自动排除已删除的问题（status != 'DELETED'）

**响应示例**:
```json
{
  "items": [
    {
      "id": 456,
      "issue_no": "IS250120001",
      "title": "测试问题 - 关联工单",
      "service_ticket_id": 123,
      "service_ticket_no": "SRV-250120-001",
      ...
    }
  ],
  "total": 1,
  "page": 1,
  "page_size": 20,
  "pages": 1
}
```

---

### 2.5 更新问题关联工单

**测试步骤**:
1. 更新问题的 `service_ticket_id`

**API 请求**:
```bash
PUT /api/v1/issues/{issue_id}
Content-Type: application/json

{
  "service_ticket_id": 124
}
```

**预期结果**:
- ✅ 问题更新成功
- ✅ `service_ticket_id` 更新为 124
- ✅ `service_ticket_no` 更新为新的工单编号

---

### 2.6 解除问题与工单的关联

**测试步骤**:
1. 将问题的 `service_ticket_id` 设置为 `null`

**API 请求**:
```bash
PUT /api/v1/issues/{issue_id}
Content-Type: application/json

{
  "service_ticket_id": null
}
```

**预期结果**:
- ✅ 问题更新成功
- ✅ `service_ticket_id` 为 `null`
- ✅ `service_ticket_no` 为 `null`

---

## 三、边界情况测试

### 3.1 关联不存在的工单

**测试步骤**:
1. 创建问题时指定一个不存在的 `service_ticket_id`

**预期结果**:
- ⚠️ 数据库层面：外键约束可能阻止（MySQL）
- ⚠️ 应用层面：应该验证工单是否存在，如果不存在返回 400 错误

**建议**: 在创建/更新问题时添加工单存在性验证

---

### 3.2 删除工单后的问题

**测试步骤**:
1. 删除一个有关联问题的工单

**预期结果**:
- ✅ MySQL：由于外键约束 `ON DELETE SET NULL`，问题的 `service_ticket_id` 自动设置为 `NULL`
- ✅ SQLite：需要应用层处理（SQLite 外键支持有限）

---

### 3.3 查询无关联工单的问题

**测试步骤**:
1. 查询 `service_ticket_id` 为 `null` 的问题

**预期结果**:
- ✅ 正常返回问题列表
- ✅ `service_ticket_id` 和 `service_ticket_no` 为 `null`

---

## 四、性能测试

### 4.1 N+1 查询验证

**测试步骤**:
1. 查询问题列表（包含多个有关联工单的问题）
2. 检查数据库查询日志

**预期结果**:
- ✅ 使用 `joinedload(Issue.service_ticket)` 预加载
- ✅ 不应该出现 N+1 查询问题
- ✅ 每个问题只查询一次工单信息

---

## 五、数据完整性测试

### 5.1 验证关联关系

**SQL 查询验证**:
```sql
-- 查询所有有关联工单的问题
SELECT 
    i.id,
    i.issue_no,
    i.title,
    i.service_ticket_id,
    st.ticket_no
FROM issues i
LEFT JOIN service_tickets st ON i.service_ticket_id = st.id
WHERE i.service_ticket_id IS NOT NULL;

-- 验证外键完整性（MySQL）
SELECT 
    i.id,
    i.service_ticket_id,
    st.id as ticket_exists
FROM issues i
LEFT JOIN service_tickets st ON i.service_ticket_id = st.id
WHERE i.service_ticket_id IS NOT NULL 
  AND st.id IS NULL;
-- 应该返回空结果（所有关联的工单都存在）
```

---

## 六、测试检查清单

- [ ] 数据库迁移脚本执行成功
- [ ] 创建问题并关联工单成功
- [ ] 问题详情显示工单信息
- [ ] 按工单筛选问题列表成功
- [ ] 获取工单关联的问题列表成功
- [ ] 更新问题关联工单成功
- [ ] 解除问题与工单关联成功
- [ ] 边界情况处理正确
- [ ] 性能测试通过（无 N+1 查询）
- [ ] 数据完整性验证通过

---

## 七、已知问题和改进建议

### 7.1 当前实现

- ✅ 基本关联功能完整
- ✅ API 端点支持关联查询
- ✅ 响应中包含工单信息

### 7.2 建议改进

1. **工单存在性验证**: 在创建/更新问题时验证 `service_ticket_id` 是否存在
2. **自动创建问题**: 工单创建时，可选择自动创建关联问题
3. **状态同步**: 工单关闭时，可选择自动更新关联问题的状态
4. **批量操作**: 支持批量关联/解除关联

---

*文档版本: v1.0*  
*最后更新: 2026-01-20*

# æ™ºèƒ½é‡‡è´­ç®¡ç†ç³»ç»Ÿ - å¿«é€Ÿå¼€å§‹

## ä¸€ã€5åˆ†é’Ÿå¿«é€Ÿä½“éªŒ

### 1. æ•°æ®åº“è¿ç§»

```bash
cd ~/non-standard-automation-pms

# è¿è¡Œè¿ç§»
alembic upgrade head
```

### 2. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æœåŠ¡
./start.sh

# æœåŠ¡åœ°å€
http://localhost:8000
```

### 3. æµ‹è¯•API

```bash
# è·å–Token
TOKEN=$(curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | jq -r '.access_token')

# æŸ¥çœ‹é‡‡è´­å»ºè®®
curl -X GET "http://localhost:8000/api/v1/purchase/suggestions" \
  -H "Authorization: Bearer $TOKEN"
```

---

## äºŒã€æ ¸å¿ƒåŠŸèƒ½æ¼”ç¤º

### 2.1 ç”Ÿæˆé‡‡è´­å»ºè®®

**Pythonä»£ç **:

```python
from app.core.database import get_db
from app.services.purchase_suggestion_engine import PurchaseSuggestionEngine

db = next(get_db())
engine = PurchaseSuggestionEngine(db, tenant_id=1)

# åŸºäºå®‰å…¨åº“å­˜ç”Ÿæˆå»ºè®®
suggestions = engine.generate_from_safety_stock()

for s in suggestions:
    print(f"å»ºè®®ç¼–å·: {s.suggestion_no}")
    print(f"ç‰©æ–™: {s.material_name}")
    print(f"å»ºè®®æ•°é‡: {s.suggested_qty}")
    print(f"æ¨èä¾›åº”å•†: {s.suggested_supplier_id}")
    print(f"AIç½®ä¿¡åº¦: {s.ai_confidence}%")
    print("---")
```

### 2.2 è¯„ä¼°ä¾›åº”å•†ç»©æ•ˆ

**Pythonä»£ç **:

```python
from app.services.supplier_performance_evaluator import SupplierPerformanceEvaluator

evaluator = SupplierPerformanceEvaluator(db, tenant_id=1)

# è¯„ä¼°å•ä¸ªä¾›åº”å•†
performance = evaluator.evaluate_supplier(
    supplier_id=5,
    evaluation_period='2026-01'
)

print(f"ä¾›åº”å•†: {performance.supplier_name}")
print(f"ç»¼åˆè¯„åˆ†: {performance.overall_score}")
print(f"ç­‰çº§: {performance.rating}")
print(f"å‡†æ—¶äº¤è´§ç‡: {performance.on_time_delivery_rate}%")
print(f"è´¨é‡åˆæ ¼ç‡: {performance.quality_pass_rate}%")
```

### 2.3 APIè°ƒç”¨ç¤ºä¾‹

```python
import requests

BASE_URL = "http://localhost:8000/api/v1/purchase"
headers = {"Authorization": f"Bearer {token}"}

# 1. è·å–é‡‡è´­å»ºè®®
response = requests.get(f"{BASE_URL}/suggestions", headers=headers)
suggestions = response.json()

# 2. æ‰¹å‡†å»ºè®®
suggestion_id = suggestions[0]['id']
requests.post(
    f"{BASE_URL}/suggestions/{suggestion_id}/approve",
    headers=headers,
    json={"approved": True, "review_note": "æ‰¹å‡†"}
)

# 3. è½¬ä¸ºè®¢å•
requests.post(
    f"{BASE_URL}/suggestions/{suggestion_id}/create-order",
    headers=headers,
    json={"required_date": "2026-02-28"}
)

# 4. æŸ¥çœ‹ä¾›åº”å•†æ’å
ranking = requests.get(
    f"{BASE_URL}/suppliers/ranking?evaluation_period=2026-01",
    headers=headers
).json()

print(f"Topä¾›åº”å•†: {ranking['rankings'][0]['supplier_name']}")
```

---

## ä¸‰ã€å…¸å‹ä¸šåŠ¡åœºæ™¯

### åœºæ™¯1: ç¼ºæ–™é¢„è­¦è‡ªåŠ¨é‡‡è´­

```python
# 1. ç³»ç»Ÿæ£€æµ‹åˆ°ç¼ºæ–™
shortage = MaterialShortage(
    project_id=123,
    material_id=456,
    shortage_qty=100,
    required_date=date.today() + timedelta(days=7)
)
db.add(shortage)
db.commit()

# 2. è‡ªåŠ¨ç”Ÿæˆé‡‡è´­å»ºè®®
engine = PurchaseSuggestionEngine(db)
suggestions = engine.generate_from_shortages(project_id=123)

# 3. AIæ¨èä¾›åº”å•†
suggestion = suggestions[0]
print(f"æ¨èä¾›åº”å•†: {suggestion.suggested_supplier_name}")
print(f"ç½®ä¿¡åº¦: {suggestion.ai_confidence}%")
print(f"æ¨èç†ç”±: {suggestion.recommendation_reason}")

# 4. è‡ªåŠ¨å®¡æ‰¹å¹¶ä¸‹å• (ç¬¦åˆæ¡ä»¶)
if suggestion.ai_confidence > 80 and suggestion.urgency_level == 'HIGH':
    suggestion.status = 'APPROVED'
    # åˆ›å»ºè®¢å•...
```

### åœºæ™¯2: ä¾›åº”å•†æœˆåº¦è¯„ä¼°

```python
from datetime import datetime

# æ¯æœˆ1æ—¥è‡ªåŠ¨è§¦å‘
evaluator = SupplierPerformanceEvaluator(db)

# æ‰¹é‡è¯„ä¼°æ‰€æœ‰ä¾›åº”å•†
last_month = (datetime.now().replace(day=1) - timedelta(days=1)).strftime('%Y-%m')
count = evaluator.batch_evaluate_all_suppliers(last_month)

# è·å–æ’å
rankings = evaluator.get_supplier_ranking(last_month, limit=10)

# å‘é€æŠ¥å‘Š
for rank in rankings:
    if rank.rating == 'D':
        send_warning_email(rank.supplier_id)  # å‘é€é¢„è­¦
    elif rank.rating == 'A+':
        send_recognition_email(rank.supplier_id)  # å‘é€è¡¨å½°
```

### åœºæ™¯3: å¤šä¾›åº”å•†æŠ¥ä»·æ¯”è¾ƒ

```python
# 1. æ”¶é›†æŠ¥ä»·
quotations = [
    {
        "supplier_id": 5,
        "material_id": 123,
        "unit_price": 0.92,
        "lead_time_days": 7
    },
    {
        "supplier_id": 8,
        "material_id": 123,
        "unit_price": 0.89,
        "lead_time_days": 10
    }
]

for q in quotations:
    create_quotation(q)

# 2. æ¯”ä»·åˆ†æ
compare_result = requests.get(
    f"{BASE_URL}/quotations/compare?material_id=123",
    headers=headers
).json()

print(f"æœ€ä½ä»·ä¾›åº”å•†: {compare_result['best_price_supplier_id']}")
print(f"ç»¼åˆæ¨è: {compare_result['recommended_supplier_id']}")
print(f"æ¨èç†ç”±: {compare_result['recommendation_reason']}")

# 3. é€‰æ‹©å¹¶ä¸‹å•
selected_quotation_id = compare_result['recommended_supplier_id']
# åˆ›å»ºè®¢å•...
```

---

## å››ã€é…ç½®è¯´æ˜

### 4.1 æ¨èç®—æ³•æƒé‡

**æ–‡ä»¶**: `app/services/purchase_suggestion_engine.py`

```python
# é»˜è®¤æƒé‡
weight_config = {
    'performance': Decimal('40'),  # ç»©æ•ˆè¯„åˆ†
    'price': Decimal('30'),         # ä»·æ ¼è¯„åˆ†
    'delivery': Decimal('20'),      # äº¤è´§æœŸè¯„åˆ†
    'history': Decimal('10'),       # å†å²åˆä½œè¯„åˆ†
}

# è‡ªå®šä¹‰æƒé‡ (æ€»å’Œ100)
custom_weights = {
    'performance': Decimal('50'),  # æé«˜ç»©æ•ˆæƒé‡
    'price': Decimal('25'),
    'delivery': Decimal('15'),
    'history': Decimal('10'),
}
```

### 4.2 ç»©æ•ˆè¯„ä¼°æƒé‡

**æ–‡ä»¶**: `app/services/supplier_performance_evaluator.py`

```python
# é»˜è®¤æƒé‡
weight_config = {
    'on_time_delivery': Decimal('30'),  # å‡†æ—¶äº¤è´§
    'quality': Decimal('30'),            # è´¨é‡åˆæ ¼ç‡
    'price': Decimal('20'),              # ä»·æ ¼ç«äº‰åŠ›
    'response': Decimal('20'),           # å“åº”é€Ÿåº¦
}

# è¡Œä¸šå®šåˆ¶ (ä¾‹å¦‚: ç²¾å¯†åˆ¶é€ ä¸š)
precision_industry_weights = {
    'on_time_delivery': Decimal('25'),
    'quality': Decimal('45'),  # æé«˜è´¨é‡æƒé‡
    'price': Decimal('15'),
    'response': Decimal('15'),
}
```

### 4.3 è¯„çº§æ ‡å‡†

**æ–‡ä»¶**: `app/services/supplier_performance_evaluator.py`

```python
RATING_STANDARDS = {
    'A+': Decimal('90'),
    'A': Decimal('80'),
    'B': Decimal('70'),
    'C': Decimal('60'),
    'D': Decimal('0'),
}

# è‡ªå®šä¹‰è¯„çº§æ ‡å‡†
CUSTOM_STANDARDS = {
    'S': Decimal('95'),  # æ–°å¢Sçº§
    'A': Decimal('85'),
    'B': Decimal('75'),
    'C': Decimal('65'),
    'D': Decimal('0'),
}
```

---

## äº”ã€å®šæ—¶ä»»åŠ¡è®¾ç½®

### 5.1 æ¯æ—¥æ£€æŸ¥å®‰å…¨åº“å­˜

```python
from apscheduler.schedulers.background import BackgroundScheduler

scheduler = BackgroundScheduler()

@scheduler.scheduled_job('cron', hour='8', minute='0')
def daily_safety_stock_check():
    """æ¯å¤©8ç‚¹æ£€æŸ¥å®‰å…¨åº“å­˜"""
    engine = PurchaseSuggestionEngine(db)
    suggestions = engine.generate_from_safety_stock()
    
    if suggestions:
        send_notification(f"ç”Ÿæˆ {len(suggestions)} æ¡é‡‡è´­å»ºè®®")

scheduler.start()
```

### 5.2 æ¯æœˆä¾›åº”å•†è¯„ä¼°

```python
@scheduler.scheduled_job('cron', day='1', hour='0', minute='0')
def monthly_supplier_evaluation():
    """æ¯æœˆ1æ—¥å‡Œæ™¨è¯„ä¼°æ‰€æœ‰ä¾›åº”å•†"""
    from datetime import datetime, timedelta
    
    last_month = (datetime.now().replace(day=1) - timedelta(days=1)).strftime('%Y-%m')
    
    evaluator = SupplierPerformanceEvaluator(db)
    count = evaluator.batch_evaluate_all_suppliers(last_month)
    
    # ç”ŸæˆæŠ¥å‘Š
    rankings = evaluator.get_supplier_ranking(last_month, limit=50)
    generate_monthly_report(rankings, last_month)
```

---

## å…­ã€æµ‹è¯•éªŒè¯

### 6.1 è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/test_purchase_intelligence.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_purchase_intelligence.py::test_generate_from_safety_stock -v

# æŸ¥çœ‹è¦†ç›–ç‡
pytest tests/test_purchase_intelligence.py --cov=app.services --cov-report=html
```

### 6.2 æ‰‹åŠ¨éªŒè¯

```bash
# 1. åˆ›å»ºæµ‹è¯•æ•°æ®
python scripts/create_test_purchase_data.py

# 2. ç”Ÿæˆå»ºè®®
python -c "
from app.core.database import get_db
from app.services.purchase_suggestion_engine import PurchaseSuggestionEngine

db = next(get_db())
engine = PurchaseSuggestionEngine(db)
suggestions = engine.generate_from_safety_stock()
print(f'ç”Ÿæˆ {len(suggestions)} æ¡å»ºè®®')
"

# 3. è¯„ä¼°ä¾›åº”å•†
python -c "
from app.core.database import get_db
from app.services.supplier_performance_evaluator import SupplierPerformanceEvaluator

db = next(get_db())
evaluator = SupplierPerformanceEvaluator(db)
count = evaluator.batch_evaluate_all_suppliers('2026-01')
print(f'è¯„ä¼° {count} ä¸ªä¾›åº”å•†')
"
```

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æŸ¥çœ‹ç”Ÿæˆçš„é‡‡è´­å»ºè®®?

**A**: ä½¿ç”¨APIæˆ–ç›´æ¥æŸ¥è¯¢æ•°æ®åº“:
```bash
# APIæ–¹å¼
curl -X GET "http://localhost:8000/api/v1/purchase/suggestions" \
  -H "Authorization: Bearer $TOKEN"

# æ•°æ®åº“æ–¹å¼
sqlite3 app.db "SELECT * FROM purchase_suggestions LIMIT 5;"
```

### Q: å¦‚ä½•ä¿®æ”¹AIæ¨èçš„ä¾›åº”å•†?

**A**: åœ¨æ‰¹å‡†å»ºè®®æ—¶ä¿®æ”¹:
```bash
curl -X POST "http://localhost:8000/api/v1/purchase/suggestions/1/approve" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "approved": true,
    "suggested_supplier_id": 10,
    "review_note": "æ”¹ç”¨ä¾›åº”å•†10"
  }'
```

### Q: å¦‚ä½•æŸ¥çœ‹ä¾›åº”å•†ç»©æ•ˆè¶‹åŠ¿?

**A**: æŸ¥è¯¢å¤šä¸ªæœˆä»½çš„ç»©æ•ˆè®°å½•:
```python
performances = db.query(SupplierPerformance).filter(
    SupplierPerformance.supplier_id == 5
).order_by(SupplierPerformance.period_end).all()

for p in performances:
    print(f"{p.evaluation_period}: {p.overall_score} ({p.rating})")
```

---

## å…«ã€ä¸‹ä¸€æ­¥

### å­¦ä¹ èµ„æº

1. **è®¾è®¡æ–‡æ¡£**: `docs/purchase-intelligence/è®¾è®¡æ–‡æ¡£.md`
2. **è¯„ä¼°æŒ‡å—**: `docs/purchase-intelligence/ä¾›åº”å•†ç»©æ•ˆè¯„ä¼°æŒ‡å—.md`
3. **APIæ‰‹å†Œ**: `docs/purchase-intelligence/APIä½¿ç”¨æ‰‹å†Œ.md`

### æ‰©å±•åŠŸèƒ½

1. **é›†æˆé‚®ä»¶é€šçŸ¥**: é‡‡è´­å»ºè®®ã€ç»©æ•ˆæŠ¥å‘Šè‡ªåŠ¨å‘é€
2. **Webç•Œé¢**: å¼€å‘å‰ç«¯é¡µé¢
3. **æ•°æ®å¯è§†åŒ–**: ä¾›åº”å•†ç»©æ•ˆè¶‹åŠ¿å›¾ã€é‡‡è´­åˆ†æå›¾è¡¨
4. **ç§»åŠ¨ç«¯**: ç§»åŠ¨å®¡æ‰¹ã€æ‰«ç æ”¶è´§

### æŠ€æœ¯æ”¯æŒ

- **GitHub**: https://github.com/your-org/purchase-intelligence
- **é‚®ä»¶**: dev@example.com
- **æ–‡æ¡£**: https://docs.example.com/purchase-intelligence

---

**å¼€å§‹ä½¿ç”¨æ™ºèƒ½é‡‡è´­ç®¡ç†ç³»ç»Ÿ,æå‡é‡‡è´­æ•ˆç‡! ğŸš€**

# 智能采购管理系统 - 设计文档

## 一、系统概述

### 1.1 背景

传统采购管理存在以下痛点:
- 缺料发现滞后，影响生产进度
- 供应商选择依赖经验，缺乏数据支持
- 供应商绩效评估不够客观和及时
- 采购决策缺少智能辅助

### 1.2 目标

构建智能化采购管理系统,实现:
- **智能采购建议**: 基于缺料、安全库存、历史消耗自动生成采购建议
- **供应商智能推荐**: AI推荐最佳供应商,提供决策依据
- **绩效评估体系**: 多维度客观评估供应商绩效
- **采购全流程跟踪**: 从建议到收货的完整追溯

## 二、系统架构

### 2.1 技术栈

```
Backend:
- Python 3.9+
- FastAPI (REST API)
- SQLAlchemy (ORM)
- PostgreSQL/SQLite (Database)

Frontend:
- React/Vue (待集成)

AI/ML:
- 供应商推荐算法
- 需求预测模型
```

### 2.2 模块划分

```
智能采购管理系统
├── 数据层 (Models)
│   ├── PurchaseSuggestion (采购建议)
│   ├── SupplierQuotation (供应商报价)
│   ├── SupplierPerformance (供应商绩效)
│   └── PurchaseOrderTracking (订单跟踪)
│
├── 业务层 (Services)
│   ├── PurchaseSuggestionEngine (采购建议引擎)
│   │   ├── 基于缺料生成建议
│   │   ├── 基于安全库存生成建议
│   │   ├── 基于历史预测生成建议
│   │   └── AI供应商推荐
│   │
│   └── SupplierPerformanceEvaluator (绩效评估器)
│       ├── 准时交货率计算
│       ├── 质量合格率计算
│       ├── 价格竞争力评估
│       └── 响应速度评分
│
└── 接口层 (API)
    ├── 采购建议管理 (4个接口)
    ├── 供应商绩效 (3个接口)
    └── 报价与订单 (3个接口)
```

### 2.3 数据流

```
缺料预警/安全库存检查
    ↓
采购建议引擎
    ↓
AI供应商推荐
    ↓
采购建议 (待审批)
    ↓
审批通过
    ↓
创建采购订单
    ↓
订单执行与跟踪
    ↓
收货确认
    ↓
供应商绩效评估
    ↓
反馈到推荐算法
```

## 三、数据模型设计

### 3.1 PurchaseSuggestion (采购建议)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| tenant_id | Integer | 租户ID (多租户支持) |
| suggestion_no | String(50) | 建议编号 (唯一) |
| material_id | Integer | 物料ID |
| suggested_qty | Decimal | 建议数量 |
| current_stock | Decimal | 当前库存 |
| safety_stock | Decimal | 安全库存 |
| source_type | String(30) | 来源: SHORTAGE/SAFETY_STOCK/FORECAST/MANUAL |
| source_id | Integer | 来源业务ID |
| project_id | Integer | 关联项目ID |
| required_date | Date | 需求日期 |
| urgency_level | String(20) | 紧急程度: LOW/NORMAL/HIGH/URGENT |
| suggested_supplier_id | Integer | 推荐供应商ID |
| ai_confidence | Decimal(5,2) | AI置信度 (0-100) |
| recommendation_reason | JSON | 推荐理由 |
| alternative_suppliers | JSON | 备选供应商列表 |
| estimated_unit_price | Decimal | 预估单价 |
| estimated_total_amount | Decimal | 预估总额 |
| status | String(20) | 状态: PENDING/APPROVED/REJECTED/ORDERED |
| reviewed_by | Integer | 审核人 |
| reviewed_at | DateTime | 审核时间 |
| purchase_order_id | Integer | 生成的订单ID |
| ordered_at | DateTime | 下单时间 |

**索引**:
- idx_ps_material (material_id)
- idx_ps_status (status)
- idx_ps_source (source_type)
- idx_ps_tenant (tenant_id)

### 3.2 SupplierQuotation (供应商报价)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| tenant_id | Integer | 租户ID |
| quotation_no | String(50) | 报价单号 (唯一) |
| supplier_id | Integer | 供应商ID |
| material_id | Integer | 物料ID |
| unit_price | Decimal | 单价 |
| currency | String(10) | 币种 (默认CNY) |
| min_order_qty | Decimal | 最小订购量 |
| lead_time_days | Integer | 交货周期 (天) |
| valid_from | Date | 有效期起 |
| valid_to | Date | 有效期止 |
| payment_terms | String(100) | 付款条款 |
| warranty_period | String(50) | 质保期 |
| tax_rate | Decimal(5,2) | 税率 (默认13%) |
| status | String(20) | 状态: ACTIVE/EXPIRED/REJECTED |
| is_selected | Boolean | 是否被选中 |

**索引**:
- idx_sq_supplier (supplier_id)
- idx_sq_material (material_id)
- idx_sq_status (status)
- idx_sq_valid_date (valid_from, valid_to)

### 3.3 SupplierPerformance (供应商绩效)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| tenant_id | Integer | 租户ID |
| supplier_id | Integer | 供应商ID |
| evaluation_period | String(20) | 评估期间 (YYYY-MM) |
| period_start | Date | 期间开始日期 |
| period_end | Date | 期间结束日期 |
| total_orders | Integer | 订单总数 |
| total_amount | Decimal | 采购总额 |
| **准时交货维度** | | |
| on_time_delivery_rate | Decimal(5,2) | 准时交货率 (%) |
| on_time_orders | Integer | 准时订单数 |
| late_orders | Integer | 延迟订单数 |
| avg_delay_days | Decimal(6,2) | 平均延迟天数 |
| **质量维度** | | |
| quality_pass_rate | Decimal(5,2) | 质量合格率 (%) |
| total_received_qty | Decimal | 收货总数 |
| qualified_qty | Decimal | 合格数量 |
| rejected_qty | Decimal | 不合格数量 |
| **价格维度** | | |
| price_competitiveness | Decimal(5,2) | 价格竞争力评分 (0-100) |
| avg_price_vs_market | Decimal(6,2) | 相对市场价 (%) |
| **响应维度** | | |
| response_speed_score | Decimal(5,2) | 响应速度评分 (0-100) |
| avg_response_hours | Decimal(6,2) | 平均响应时间 (小时) |
| **综合评估** | | |
| overall_score | Decimal(5,2) | 综合评分 (0-100) |
| rating | String(2) | 等级: A+/A/B/C/D |
| weight_config | JSON | 评分权重配置 |
| detail_data | JSON | 详细数据 |
| status | String(20) | 状态: CALCULATED/REVIEWED/PUBLISHED |

**索引**:
- idx_sp_supplier (supplier_id)
- idx_sp_period (evaluation_period)
- idx_sp_score (overall_score)

### 3.4 PurchaseOrderTracking (订单跟踪)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| tenant_id | Integer | 租户ID |
| order_id | Integer | 采购订单ID |
| order_no | String(50) | 订单编号 |
| event_type | String(30) | 事件类型 |
| event_time | DateTime | 事件时间 |
| event_description | Text | 事件描述 |
| old_status | String(20) | 原状态 |
| new_status | String(20) | 新状态 |
| tracking_no | String(100) | 物流单号 |
| logistics_company | String(100) | 物流公司 |
| estimated_arrival | Date | 预计到货日期 |

**事件类型**:
- CREATED: 订单创建
- SUBMITTED: 提交审批
- APPROVED: 审批通过
- CONFIRMED: 供应商确认
- SHIPPED: 发货
- RECEIVED: 收货
- COMPLETED: 完成

## 四、核心算法

### 4.1 AI供应商推荐算法

#### 4.1.1 评分维度

```python
supplier_score = (
    performance_score * 40% +
    price_score * 30% +
    delivery_score * 20% +
    history_score * 10%
)
```

#### 4.1.2 绩效评分

从最近的绩效评估记录获取 `overall_score`

如果无历史绩效,默认给予 60 分 (及格分)

#### 4.1.3 价格评分

```python
if price <= min_price:
    price_score = 100
elif price <= avg_price:
    price_score = 100 - (price - min_price) / (avg_price - min_price) * 40
else:
    # 高于平均价格,评分下降
```

#### 4.1.4 交货期评分

```
≤ 7天:  100分
≤ 15天:  85分
≤ 30天:  70分
> 30天:  递减
```

#### 4.1.5 历史合作评分

```
订单数 ≥ 20:  100分
订单数 ≥ 10:   80分
订单数 ≥ 5:    60分
订单数 < 5:    40分
```

### 4.2 供应商绩效评估算法

#### 4.2.1 准时交货率

```python
on_time_delivery_rate = on_time_orders / total_delivered_orders * 100
```

**判定标准**:
- 收货日期 ≤ 承诺交期: 准时
- 收货日期 > 承诺交期: 延迟

#### 4.2.2 质量合格率

```python
quality_pass_rate = qualified_qty / total_received_qty * 100
```

**数据来源**: 收货单明细的质检结果

#### 4.2.3 价格竞争力

```python
vs_market = (supplier_avg_price - market_avg_price) / market_avg_price * 100

if vs_market <= -20%: score = 100
elif vs_market <= -10%: score = 90
elif vs_market <= 0%: score = 80
elif vs_market <= 10%: score = 60
elif vs_market <= 20%: score = 40
else: score = 20
```

#### 4.2.4 响应速度

```python
avg_response_hours = sum(response_times) / count

if avg_hours <= 4:  score = 100
elif avg_hours <= 8:  score = 90
elif avg_hours <= 24: score = 80
elif avg_hours <= 48: score = 60
else: score降低
```

**响应时间定义**: 从订单提交到供应商确认的时间间隔

#### 4.2.5 综合评分

```python
overall_score = (
    on_time_delivery_rate * w_delivery +
    quality_pass_rate * w_quality +
    price_competitiveness * w_price +
    response_speed_score * w_response
) / 100
```

**默认权重**:
- 准时交货: 30%
- 质量: 30%
- 价格: 20%
- 响应: 20%

权重可配置,总和必须为 100%

#### 4.2.6 评级标准

| 综合评分 | 等级 |
|---------|------|
| ≥ 90 | A+ |
| ≥ 80 | A |
| ≥ 70 | B |
| ≥ 60 | C |
| < 60 | D |

### 4.3 需求预测算法

#### 4.3.1 基于历史消耗

```python
avg_monthly_consumption = sum(last_6_months_received_qty) / 6
forecast_demand = avg_monthly_consumption * forecast_months
```

#### 4.3.2 建议数量

```python
suggested_qty = forecast_demand - current_stock

# 考虑最小订购量
if suggested_qty < min_order_qty:
    suggested_qty = min_order_qty
```

### 4.4 紧急程度判定

```python
days_until = (required_date - today).days

if days_until < 0: urgency = 'URGENT'
elif days_until <= 3: urgency = 'HIGH'
elif days_until <= 7: urgency = 'NORMAL'
else: urgency = 'LOW'
```

## 五、业务流程

### 5.1 智能采购建议流程

```
1. 触发条件检测
   - 缺料预警生成
   - 库存低于安全库存
   - 定期预测任务
   
2. 生成采购建议
   - 计算建议数量
   - AI推荐供应商
   - 预估价格
   
3. 采购审批
   - 待审批列表
   - 审批/拒绝
   - 修改建议
   
4. 转采购订单
   - 选择供应商
   - 创建订单
   - 更新建议状态
```

### 5.2 供应商绩效评估流程

```
1. 定期触发 (每月1日)
   - 批量评估所有供应商
   - 评估期间: 上个月
   
2. 数据采集
   - 订单数据
   - 收货数据
   - 质检数据
   
3. 指标计算
   - 准时交货率
   - 质量合格率
   - 价格竞争力
   - 响应速度
   
4. 综合评分
   - 加权计算
   - 等级判定
   
5. 结果发布
   - 供应商排名
   - 绩效报告
   - 反馈到推荐算法
```

### 5.3 报价比较流程

```
1. 创建询价
   - 指定物料
   - 选择供应商
   
2. 收集报价
   - 供应商提交报价
   - 系统录入
   
3. 比价分析
   - 价格对比
   - 交期对比
   - 综合绩效对比
   
4. 推荐决策
   - 最低价供应商
   - 综合推荐供应商
   - 推荐理由
```

## 六、权限设计

### 6.1 角色权限

| 角色 | 采购建议 | 供应商绩效 | 报价管理 | 订单管理 |
|------|---------|-----------|---------|---------|
| 采购员 | 查看、创建 | 查看 | 创建、查看 | 查看 |
| 采购主管 | 全部 | 查看、触发评估 | 全部 | 查看 |
| 采购经理 | 全部 | 全部 | 全部 | 审批 |
| 管理员 | 全部 | 全部 | 全部 | 全部 |

### 6.2 数据隔离

- **多租户隔离**: 所有表包含 `tenant_id` 字段
- **项目隔离**: 可按项目筛选采购建议
- **权限过滤**: API层自动过滤租户数据

## 七、性能优化

### 7.1 数据库优化

- 核心查询字段建立索引
- 分页查询避免全表扫描
- 定期评估任务使用异步执行

### 7.2 缓存策略

- 供应商绩效结果缓存 (24小时)
- 推荐算法结果缓存 (1小时)
- 物料信息缓存

### 7.3 批量处理

- 批量生成建议 (而非逐条)
- 批量评估供应商
- 批量更新库存

## 八、监控与日志

### 8.1 关键指标监控

- 采购建议生成数量
- 采购建议批准率
- 供应商平均评分
- 系统响应时间

### 8.2 日志记录

- 建议生成日志
- 评估执行日志
- API调用日志
- 异常错误日志

## 九、扩展性设计

### 9.1 算法可配置

- 供应商推荐权重可配置
- 绩效评估权重可配置
- 评级标准可调整

### 9.2 多供应商支持

- 一个物料可关联多个供应商
- 支持供应商比价
- 支持备选供应商

### 9.3 多来源建议

- 缺料预警
- 安全库存
- 历史预测
- 手动创建

## 十、未来规划

### 10.1 机器学习增强

- 需求预测模型
- 价格趋势预测
- 供应商风险预警

### 10.2 供应链协同

- 供应商门户
- 在线询价
- 实时库存共享

### 10.3 移动端支持

- 移动审批
- 扫码收货
- 实时通知

---

**文档版本**: v1.0  
**编写日期**: 2026-02-16  
**作者**: Team 1 - 智能采购管理系统

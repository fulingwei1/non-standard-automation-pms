# 安全事件响应流程

## 概述

本文档定义了账户锁定相关安全事件的识别、响应和处理流程。

## 事件分级

### 🟢 低风险（Level 1）
- 单个用户因忘记密码被锁定
- 偶发的登录失败
- 正常的锁定/解锁请求

**响应时间**: 2小时内

### 🟡 中风险（Level 2）
- 多个用户同时被锁定
- 同一IP多次尝试不同账户
- 高价值账户（管理员、财务）被锁定

**响应时间**: 30分钟内

### 🔴 高风险（Level 3）
- 大规模暴力破解攻击
- IP黑名单触发
- 可疑的登录模式（异地、异常时间）

**响应时间**: 立即（5分钟内）

### ⚫ 严重（Level 4）
- 持续的分布式攻击
- 系统管理员账户被攻击
- 数据泄露迹象

**响应时间**: 立即（启动应急预案）

---

## 响应流程

### 阶段1：识别与分类

#### 自动告警
系统会在以下情况自动发送告警：

1. **账户锁定**
   - 企业微信：@安全团队
   - 邮件：security@company.com
   - 内容：用户名、IP、时间

2. **IP拉黑**
   - 企业微信：@安全团队 @运维团队
   - 邮件：security@company.com, ops@company.com
   - 短信：安全负责人（严重级别）

#### 手动识别
管理员应主动检查：
- 每日查看锁定账户列表
- 每周审查登录失败趋势
- 每月分析IP黑名单

#### 分类决策树

```
检测到登录异常
    ├─ 单个用户？
    │   ├─ 正常工作时间？
    │   │   ├─ 是 → Level 1（低风险）
    │   │   └─ 否 → Level 2（中风险，调查）
    │   └─ 管理员账户？
    │       ├─ 是 → Level 3（高风险）
    │       └─ 否 → Level 1
    └─ 多个用户？
        ├─ 同一IP？
        │   ├─ 是 → Level 3（高风险，攻击）
        │   └─ 否 → Level 2（调查）
        └─ 短时间内（<1小时）？
            ├─ 是 → Level 4（严重，应急）
            └─ 否 → Level 2
```

---

### 阶段2：初步响应

#### Level 1 响应

**责任人**: 值班管理员

**步骤**:
1. 联系用户确认身份
2. 检查登录历史
3. 解锁账户（如需要）
4. 记录事件日志

**预计时间**: 15-30分钟

#### Level 2 响应

**责任人**: 安全团队

**步骤**:
1. 收集相关数据
   ```sql
   -- 查询最近1小时的失败登录
   SELECT * FROM login_attempts
   WHERE success = FALSE
     AND created_at > NOW() - INTERVAL 1 HOUR
   ORDER BY created_at DESC;
   ```

2. 分析攻击模式
   - IP来源
   - 尝试的用户名
   - 时间分布
   - 密码特征（如果记录）

3. 采取防护措施
   - 拉黑可疑IP
   - 通知受影响用户
   - 加强监控

4. 撰写事件简报

**预计时间**: 1-2小时

#### Level 3 响应

**责任人**: 安全负责人 + 运维团队

**步骤**:
1. **立即行动**（前5分钟）
   - 确认攻击正在进行
   - 启用临时WAF规则
   - 通知关键人员

2. **遏制攻击**（前30分钟）
   - 拉黑攻击IP段
   - 启用验证码（如可用）
   - 限制API访问速率

3. **深入分析**（前2小时）
   - 确定攻击来源
   - 评估影响范围
   - 检查是否有账户被突破

4. **后续行动**
   - 强制重置高价值账户密码
   - 更新防护规则
   - 提交事件报告

#### Level 4 响应

**责任人**: 应急响应团队 + 管理层

**步骤**:
1. **启动应急预案**（立即）
   - 召集应急响应团队
   - 开启战时模式（24小时值守）
   - 通知公司管理层

2. **防御升级**（前15分钟）
   - 启用最高级别防护
   - 临时禁用部分功能（如需要）
   - 联系云服务商/ISP

3. **溯源调查**（持续）
   - 分析攻击特征
   - 确定攻击者身份/组织
   - 收集法律证据

4. **恢复与加固**（攻击结束后）
   - 全面安全审计
   - 系统加固
   - 用户教育

5. **报告与总结**
   - 向管理层汇报
   - 撰写详细事件报告
   - 改进预案

---

### 阶段3：调查与分析

#### 数据收集

**必须收集的信息**:
- 登录尝试记录（`login_attempts`表）
- 服务器访问日志
- WAF/防火墙日志
- 网络流量数据
- 用户反馈

**SQL查询模板**:

```sql
-- 1. 受影响账户列表
SELECT DISTINCT username
FROM login_attempts
WHERE created_at BETWEEN '2026-02-15 10:00:00' AND '2026-02-15 12:00:00'
  AND success = FALSE;

-- 2. 攻击来源IP
SELECT ip_address, COUNT(*) as attempts, COUNT(DISTINCT username) as targets
FROM login_attempts
WHERE created_at BETWEEN '2026-02-15 10:00:00' AND '2026-02-15 12:00:00'
  AND success = FALSE
GROUP BY ip_address
ORDER BY attempts DESC;

-- 3. 时间分布
SELECT DATE_FORMAT(created_at, '%Y-%m-%d %H:00:00') as hour,
       COUNT(*) as attempts
FROM login_attempts
WHERE created_at > NOW() - INTERVAL 24 HOUR
  AND success = FALSE
GROUP BY hour
ORDER BY hour;

-- 4. 被攻击的高频用户
SELECT username, COUNT(*) as attempts
FROM login_attempts
WHERE created_at > NOW() - INTERVAL 1 HOUR
  AND success = FALSE
GROUP BY username
HAVING attempts >= 5
ORDER BY attempts DESC;
```

#### 分析清单

- [ ] 确定攻击时间范围
- [ ] 识别攻击来源（IP、地理位置、ISP）
- [ ] 分析攻击手法（字典攻击、撞库、定向）
- [ ] 评估影响范围（多少账户、多少用户）
- [ ] 检查是否有账户被成功入侵
- [ ] 确定攻击动机（随机、定向、商业竞争）

---

### 阶段4：遏制与恢复

#### 短期措施（立即执行）

1. **阻断攻击**
   ```bash
   # 拉黑IP
   curl -X POST "${API_BASE}/remove-ip-blacklist" \
     -H "Authorization: Bearer ${TOKEN}" \
     -d '{"ip": "恶意IP"}'
   
   # 临时WAF规则
   # （具体命令取决于使用的WAF）
   ```

2. **保护账户**
   - 解锁合法用户账户
   - 通知用户重置密码
   - 启用双因素认证（2FA）

3. **加强监控**
   - 增加日志采样率
   - 设置实时告警
   - 人工监控关键指标

#### 长期措施（24-72小时内）

1. **系统加固**
   - 更新账户锁定策略
   - 调整速率限制
   - 部署验证码

2. **安全审计**
   - 全面检查所有账户
   - 审查权限分配
   - 检查异常登录记录

3. **用户教育**
   - 发送安全提示邮件
   - 强制密码复杂度
   - 推广2FA

---

### 阶段5：后续行动

#### 事件报告

**报告结构**:

1. **执行摘要**
   - 事件简述
   - 影响范围
   - 响应结果

2. **事件详情**
   - 时间线
   - 攻击特征
   - 响应过程

3. **影响评估**
   - 受影响账户数量
   - 业务影响
   - 数据泄露风险

4. **根因分析**
   - 为什么发生
   - 如何被发现
   - 响应是否及时

5. **改进建议**
   - 技术改进
   - 流程优化
   - 培训需求

#### 改进行动

**技术改进**:
- [ ] 部署更强的密码策略
- [ ] 实施2FA强制要求
- [ ] 升级WAF规则
- [ ] 增加监控覆盖

**流程改进**:
- [ ] 更新应急预案
- [ ] 优化响应流程
- [ ] 加强团队协作

**人员培训**:
- [ ] 安全意识培训
- [ ] 应急演练
- [ ] 技能提升

---

## 联系人列表

### 安全团队
- **安全负责人**: 张三, 手机: 138-xxxx-xxxx, 企业微信: @张三
- **值班管理员**: security@company.com, 企业微信群: @安全团队

### 运维团队
- **运维负责人**: 李四, 手机: 139-xxxx-xxxx
- **值班工程师**: ops@company.com

### 管理层
- **CTO**: 王五, 手机: 136-xxxx-xxxx
- **CEO**: 赵六, 手机: 137-xxxx-xxxx（仅严重事件）

### 外部支持
- **云服务商**: 400-xxx-xxxx（24小时）
- **网络安全公司**: 010-xxxx-xxxx

---

## 演练计划

### 季度演练

**目标**: 确保团队熟悉响应流程

**场景**:
1. 单用户锁定（Level 1）
2. 小规模攻击（Level 2）
3. 大规模暴力破解（Level 3）

**评估标准**:
- 响应时间
- 操作准确性
- 团队协作
- 问题解决能力

### 年度演练

**目标**: 测试完整应急预案

**场景**:
- Level 4严重事件
- 多点同时攻击
- 系统故障+安全事件

---

## 附录

### 相关文档
- [用户手册](./account_lockout_user_guide.md)
- [管理员手册](./account_lockout_admin_guide.md)
- [API文档](./account_lockout_api.md)

### 法律合规
- 所有安全事件必须记录并保留1年
- 涉及数据泄露的事件需在72小时内上报
- 配合公安机关调查取证

---

**最后更新**: 2026年2月15日  
**版本**: v1.0  
**审核者**: 安全团队负责人  
**批准者**: CTO

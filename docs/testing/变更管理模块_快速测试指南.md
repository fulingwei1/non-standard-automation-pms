# 变更管理模块 - 快速测试指南

> 创建日期：2025-01-15  
> 用途：快速验证ECN模块功能

---

## 一、快速开始

### 1.1 准备工作

1. **启动后端服务**：
```bash
cd /Users/flw/non-standard-automation-pm
uvicorn app.main:app --reload
```

2. **确认服务运行**：
访问 http://127.0.0.1:8000/health 应该返回 `{"status": "ok"}`

3. **准备测试数据**（可选）：
- 确保数据库中至少有一个项目
- 确保数据库中至少有一个物料
- 确保数据库中至少有一个采购订单

---

## 二、API测试

### 2.1 执行自动化测试脚本

```bash
# 执行完整的API测试
python3 test_ecn_apis.py
```

**测试内容**：
- ✅ ECN基础管理（创建、查询、更新）
- ✅ 受影响物料管理（添加、更新、删除）
- ✅ 受影响订单管理（添加、更新、删除）
- ✅ ECN类型配置管理（创建、查询、更新、删除）
- ✅ ECN评估功能
- ✅ ECN审批功能
- ✅ ECN执行任务功能
- ✅ ECN日志功能
- ✅ ECN统计功能
- ✅ 超时提醒功能

### 2.2 测试输出说明

- ✅ 绿色：测试通过
- ❌ 红色：测试失败
- ℹ️ 蓝色：测试信息
- ⚠️ 黄色：警告信息

---

## 三、前端功能测试

### 3.1 测试受影响物料/订单管理

1. **访问ECN管理页面**：
   - 打开浏览器访问 `http://localhost:3000/ecns`（或你的前端地址）
   - 登录系统

2. **创建ECN**：
   - 点击"新建ECN"按钮
   - 填写ECN信息（标题、类型、项目等）
   - 点击"创建"

3. **测试受影响物料管理**：
   - 点击ECN列表中的ECN，打开详情页
   - 切换到"影响分析"标签
   - 点击"添加物料"按钮
   - 填写物料信息：
     - 选择物料（或手动输入编码、名称）
     - 选择变更类型（新增/更新/删除/替换）
     - 填写变更前后信息（如果是更新/替换）
     - 填写成本影响
   - 点击"保存"
   - 验证物料已添加到列表
   - 测试编辑功能：点击编辑按钮，修改信息
   - 测试删除功能：点击删除按钮，确认删除

4. **测试受影响订单管理**：
   - 在"影响分析"标签中，点击"添加订单"按钮
   - 填写订单信息：
     - 选择订单类型（采购订单/外协订单）
     - 选择订单（或手动输入订单号）
     - 填写影响描述
     - 选择处理方式
   - 点击"保存"
   - 验证订单已添加到列表
   - 测试编辑和删除功能

### 3.2 测试ECN类型配置管理

1. **访问类型配置页面**：
   - 访问 `http://localhost:3000/ecn-types`

2. **创建ECN类型**：
   - 点击"新建类型"按钮
   - 填写类型编码（如：TEST）
   - 填写类型名称（如：测试类型）
   - 填写描述（可选）
   - 选择必需评估部门（点击部门按钮）
   - 选择可选评估部门（点击部门按钮）
   - 配置审批矩阵（JSON格式，可选）
   - 点击"保存"

3. **验证类型列表**：
   - 验证新创建的类型出现在列表中
   - 验证部门标签显示正确

4. **测试编辑功能**：
   - 点击类型行的编辑按钮
   - 修改类型信息
   - 点击"保存"
   - 验证信息已更新

5. **测试删除功能**：
   - 点击类型行的删除按钮
   - 确认删除
   - 验证类型已从列表移除

---

## 四、定时任务测试

### 4.1 手动测试定时任务

```python
# 在Python交互式环境中执行
from app.services.ecn_scheduler import run_ecn_scheduler, check_all_overdue

# 检查所有超时事项
alerts = check_all_overdue()
print(f"发现 {len(alerts)} 个超时事项")
for alert in alerts:
    print(f"- {alert['message']}")

# 运行定时任务
run_ecn_scheduler()
```

### 4.2 验证调度器集成

1. **检查调度器是否启动**：
   - 查看后端日志，应该看到 "定时任务调度器已启动"
   - 应该看到 "ECN超时检查" 任务已注册

2. **验证定时任务执行**：
   - 定时任务会在每天上午9点执行
   - 可以修改 `app/utils/scheduler.py` 中的时间进行测试

---

## 五、端到端测试

### 5.1 完整流程测试

1. **创建ECN**：
   - 创建ECN（草稿状态）
   - 添加受影响物料
   - 添加受影响订单

2. **提交ECN**：
   - 在ECN详情页点击"提交ECN"按钮
   - 验证状态变为"已提交"

3. **创建评估**：
   - 切换到"评估"标签
   - 点击"创建评估"按钮
   - 填写评估信息（部门、影响分析、成本估算等）
   - 点击"创建"
   - 点击"提交评估"按钮

4. **创建审批**：
   - 切换到"审批"标签
   - 创建审批记录（或等待自动创建）
   - 点击"审批通过"按钮

5. **创建执行任务**：
   - 切换到"执行任务"标签
   - 点击"创建任务"按钮
   - 填写任务信息
   - 点击"创建"
   - 更新任务进度
   - 完成任务

6. **查看日志**：
   - 切换到"变更日志"标签
   - 验证所有操作都有日志记录

---

## 六、常见问题

### 6.1 API测试失败

**问题**：登录失败
- **解决**：检查用户名和密码是否正确（默认：admin/admin123）
- **解决**：检查服务器是否正常运行

**问题**：创建ECN失败
- **解决**：确保数据库中至少有一个项目
- **解决**：检查项目ID是否正确

**问题**：添加物料失败
- **解决**：确保ECN状态为DRAFT/SUBMITTED/EVALUATING
- **解决**：检查物料信息是否完整（编码、名称、变更类型）

### 6.2 前端测试问题

**问题**：页面无法访问
- **解决**：确保前端开发服务器已启动
- **解决**：检查路由配置是否正确

**问题**：添加物料对话框无法打开
- **解决**：检查ECN状态，确保允许编辑
- **解决**：检查浏览器控制台是否有错误

**问题**：部门选择按钮无响应
- **解决**：检查浏览器控制台是否有JavaScript错误
- **解决**：刷新页面重试

### 6.3 定时任务问题

**问题**：定时任务未执行
- **解决**：检查调度器是否启动（查看后端日志）
- **解决**：检查环境变量 `ENABLE_SCHEDULER` 是否为 `true`
- **解决**：检查APScheduler是否已安装

---

## 七、测试检查清单

### 7.1 API测试检查清单

- [ ] 服务器正常运行
- [ ] 登录成功
- [ ] 创建ECN成功
- [ ] 获取ECN列表成功
- [ ] 更新ECN成功
- [ ] 添加受影响物料成功
- [ ] 更新受影响物料成功
- [ ] 删除受影响物料成功
- [ ] 添加受影响订单成功
- [ ] 更新受影响订单成功
- [ ] 删除受影响订单成功
- [ ] 创建ECN类型成功
- [ ] 获取ECN类型列表成功
- [ ] 更新ECN类型成功
- [ ] 删除ECN类型成功

### 7.2 前端测试检查清单

- [ ] ECN管理页面可以访问
- [ ] 可以创建ECN
- [ ] 可以查看ECN详情
- [ ] 可以添加受影响物料
- [ ] 可以编辑受影响物料
- [ ] 可以删除受影响物料
- [ ] 可以添加受影响订单
- [ ] 可以编辑受影响订单
- [ ] 可以删除受影响订单
- [ ] ECN类型配置页面可以访问
- [ ] 可以创建ECN类型
- [ ] 可以编辑ECN类型
- [ ] 可以删除ECN类型
- [ ] 部门选择功能正常

### 7.3 定时任务检查清单

- [ ] 调度器正常启动
- [ ] ECN定时任务已注册
- [ ] 超时检查功能正常
- [ ] 超时提醒生成正确

---

## 八、测试报告

测试完成后，请填写 `变更管理模块_测试验证报告.md` 中的测试结果。

---

**文档版本**：v1.0  
**最后更新**：2025-01-15







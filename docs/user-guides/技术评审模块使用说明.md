# 技术评审管理模块使用说明

## 📋 模块概述

技术评审管理模块用于管理项目各阶段的技术评审，包括：
- **PDR** (Preliminary Design Review) - 方案设计评审
- **DDR** (Detailed Design Review) - 详细设计评审
- **PRR** (Production Readiness Review) - 生产准备评审
- **FRR** (Factory Review) - 出厂评审
- **ARR** (Acceptance Review) - 现场评审

## 🎯 核心功能

### 1. 创建技术评审

**API端点**: `POST /api/v1/technical-reviews`

**请求示例**:
```json
{
  "review_type": "PDR",
  "review_name": "DEMO001项目方案设计评审",
  "project_id": 27,
  "equipment_id": null,
  "scheduled_date": "2026-01-10T10:00:00",
  "location": "会议室A",
  "meeting_type": "ONSITE",
  "host_id": 1,
  "presenter_id": 3,
  "recorder_id": 4
}
```

**功能说明**:
- 自动生成评审编号：`RV-{TYPE}-yymmdd-xxx`
- 支持关联项目和设备
- 设置评审时间、地点、会议形式
- 指定主持人、汇报人、记录人

### 2. 添加评审参与人

**API端点**: `POST /api/v1/technical-reviews/{review_id}/participants`

**请求示例**:
```json
{
  "user_id": 5,
  "role": "EXPERT",
  "is_required": true
}
```

**角色类型**:
- `HOST` - 主持人
- `PRESENTER` - 汇报人
- `RECORDER` - 记录人
- `EXPERT` - 评审专家
- `OBSERVER` - 观察者

**功能说明**:
- 支持标记必需/可选参与人
- 支持签到和委派
- 记录电子签名

### 3. 上传评审材料

**API端点**: `POST /api/v1/technical-reviews/{review_id}/materials`

**请求示例**:
```json
{
  "material_type": "DRAWING",
  "material_name": "设备总装图V1.0.pdf",
  "file_path": "/uploads/reviews/demo001/总装图.pdf",
  "file_size": 2048576,
  "version": "V1.0",
  "is_required": true
}
```

**材料类型**:
- `DRAWING` - 图纸
- `BOM` - BOM清单
- `REPORT` - 报告
- `DOCUMENT` - 文档
- `OTHER` - 其他

**功能说明**:
- 支持标记必需/可选材料
- 记录文件大小和版本
- 记录上传人和上传时间

### 4. 创建检查项记录

**API端点**: `POST /api/v1/technical-reviews/{review_id}/checklist-records`

**请求示例**:
```json
{
  "category": "安全设计",
  "check_item": "安全防护措施是否完善",
  "result": "FAIL",
  "issue_level": "B",
  "issue_desc": "缺少急停按钮的二次确认机制",
  "checker_id": 5,
  "remark": "需要整改"
}
```

**检查结果**:
- `PASS` - 通过
- `FAIL` - 不通过
- `NA` - 不适用

**功能说明**:
- 检查项不通过时自动创建问题
- 支持问题等级分类（A/B/C/D）
- 自动关联问题ID

### 5. 创建和管理问题

**API端点**: 
- `POST /api/v1/technical-reviews/{review_id}/issues` - 创建问题
- `PUT /api/v1/technical-reviews/issues/{issue_id}` - 更新问题
- `GET /api/v1/technical-reviews/issues` - 查询问题列表

**创建问题示例**:
```json
{
  "issue_level": "A",
  "category": "设计缺陷",
  "description": "关键部件选型不当，可能导致设备寿命缩短",
  "suggestion": "建议更换为更高规格的部件",
  "assignee_id": 3,
  "deadline": "2026-01-12"
}
```

**问题等级**:
- `A` - 严重问题（阻塞）
- `B` - 重要问题（需优先处理）
- `C` - 一般问题
- `D` - 轻微问题

**问题状态流转**:
```
OPEN → PROCESSING → RESOLVED → VERIFIED → CLOSED
```

**功能说明**:
- 自动生成问题编号：`RV-ISSUE-yymmdd-xxx`
- 支持问题跟踪和验证
- 自动更新评审的问题统计
- 支持关联问题管理系统

## 📊 数据查询

### 查询评审列表

**API端点**: `GET /api/v1/technical-reviews`

**查询参数**:
- `page` - 页码
- `page_size` - 每页数量
- `keyword` - 关键词搜索（编号/名称）
- `review_type` - 评审类型筛选
- `project_id` - 项目ID筛选
- `status` - 状态筛选

### 查询评审详情

**API端点**: `GET /api/v1/technical-reviews/{review_id}`

**返回数据包含**:
- 评审基本信息
- 参与人列表
- 材料列表
- 检查项记录
- 问题列表

### 查询问题列表

**API端点**: `GET /api/v1/technical-reviews/issues`

**查询参数**:
- `review_id` - 评审ID筛选
- `issue_level` - 问题等级筛选
- `status` - 状态筛选
- `assignee_id` - 责任人ID筛选

## 🔄 评审流程

### 典型评审流程

1. **创建评审** (状态: DRAFT)
   - 设置基本信息
   - 指定评审人员

2. **准备材料** (状态: PENDING)
   - 上传评审材料
   - 确认材料完整性

3. **开始评审** (状态: IN_PROGRESS)
   - 参与人签到
   - 记录检查项
   - 发现问题

4. **完成评审** (状态: COMPLETED)
   - 形成评审结论
   - 记录结论说明
   - 设置整改期限

5. **问题跟踪**
   - 分配责任人
   - 跟踪整改进度
   - 验证整改效果

## 📈 统计功能

### 问题统计

评审主表自动维护问题统计：
- `issue_count_a` - A类问题数
- `issue_count_b` - B类问题数
- `issue_count_c` - C类问题数
- `issue_count_d` - D类问题数

### 检查项统计

- 通过数量
- 不通过数量
- 不适用数量

## 🛠️ 测试脚本

项目提供了两个测试脚本：

### 1. 功能测试脚本

```bash
python3 test_technical_review.py
```

**功能**:
- 创建技术评审
- 添加参与人
- 上传材料
- 创建检查项
- 创建问题
- 模拟问题处理流程

### 2. 数据查询脚本

```bash
python3 query_technical_review.py
```

**功能**:
- 查询评审列表
- 查询评审详情
- 查询问题列表

## 📝 注意事项

1. **评审编号**: 自动生成，格式为 `RV-{TYPE}-yymmdd-xxx`
2. **问题编号**: 自动生成，格式为 `RV-ISSUE-yymmdd-xxx`
3. **状态管理**: 只有草稿状态的评审可以删除
4. **问题创建**: 检查项不通过时自动创建问题
5. **统计更新**: 问题创建/更新时自动更新评审统计

## 🔗 相关API端点

| 功能 | 方法 | 端点 |
|------|------|------|
| 创建评审 | POST | `/api/v1/technical-reviews` |
| 查询列表 | GET | `/api/v1/technical-reviews` |
| 查询详情 | GET | `/api/v1/technical-reviews/{id}` |
| 更新评审 | PUT | `/api/v1/technical-reviews/{id}` |
| 删除评审 | DELETE | `/api/v1/technical-reviews/{id}` |
| 添加参与人 | POST | `/api/v1/technical-reviews/{id}/participants` |
| 更新参与人 | PUT | `/api/v1/technical-reviews/participants/{id}` |
| 添加材料 | POST | `/api/v1/technical-reviews/{id}/materials` |
| 创建检查项 | POST | `/api/v1/technical-reviews/{id}/checklist-records` |
| 创建问题 | POST | `/api/v1/technical-reviews/{id}/issues` |
| 更新问题 | PUT | `/api/v1/technical-reviews/issues/{id}` |
| 查询问题 | GET | `/api/v1/technical-reviews/issues` |

## 📚 更多信息

- API文档: `http://127.0.0.1:8000/docs`
- 标签: `technical-review`







# 统一审批系统业务实体测试计划

## 概述

测试所有 4 个业务实体类型的审批流程：
- ECN（工程变更通知）
- QUOTE（报价）
- CONTRACT（合同）
- INVOICE（发票）

## 测试前提条件

1. ✅ 数据库迁移完成（4 个模板、4 个流程、14 个节点）
2. ✅ 后端服务器运行（PID 37758）
3. ✅ API 端点已注册（50+ 个端点）
4. ✅ 统一审批服务已创建
5. ⏳ 需要：有效的用户 JWT token 用于认证

## ECN 审批流程测试

### 测试目标
验证 ECN 审批的三级流程：技术评审 → 部门会签 → 最终审批

### 测试步骤

#### 1. 提交 ECN 审批

**请求**:
```bash
POST /api/v1/approvals/submit
Content-Type: application/json
Authorization: Bearer {token}

{
  "entity_type": "ECN",
  "entity_id": 1,
  "title": "ECN 测试审批",
  "summary": "测试 ECN 审批流程",
  "urgency": "NORMAL",
  "cc_user_ids": []
}
```

**预期响应**:
```json
{
  "code": 200,
  "message": "审批提交成功",
  "data": {
    "instance_id": 1,
    "instance_no": "AP2501250001",
    "status": "PENDING",
    "entity_type": "ECN",
    "entity_id": 1,
    "submitted_at": "2026-01-25T..."
  }
}
```

**验证点**:
- [ ] 返回状态码 200
- [ ] 创建了 `approval_instance` 记录，状态为 PENDING
- [ ] 创建了 3 个 `approval_task` 记录（对应 3 个节点）
- [ ] 第一个任务（技术评审）状态为 PENDING，分配给正确的审批人
- [ ] 记录了 `approval_action_log`

#### 2. 通过技术评审节点

**请求**:
```bash
POST /api/v1/approvals/1/approve
Content-Type: application/json
Authorization: Bearer {token}

{
  "decision": "APPROVE",
  "comment": "技术评审通过，变更合理"
}
```

**预期结果**:
- 技术评审任务状态变为 APPROVED
- 审批实例自动进入下一个节点（部门会签）
- 创建部门会签的待处理任务

#### 3. 部门会签（多人会签）

**说明**: ECN 的部门会签使用 AND_SIGN 模式，所有部门负责人必须审批通过

**测试**:
- [ ] 部门负责人 A 审批通过
- [ ] 部门负责人 B 审批通过
- [ ] 验证只有所有人都审批后，流程才进入下一节点

#### 4. 最终审批

**请求**:
```bash
POST /api/v1/approvals/1/approve
Authorization: Bearer {token}
{
  "decision": "APPROVE",
  "comment": "最终审批通过"
}
```

**预期结果**:
- 审批实例状态变为 APPROVED
- ECN 实体的 `approval_status` 同步更新为 APPROVED
- 所有任务状态更新为 COMPLETED

## QUOTE 审批流程测试

### 测试目标
验证报价审批的条件路由：
- 金额 < 10 万 → 销售经理审批
- 10 万 ≤ 金额 < 50 万 → 销售总监审批
- 金额 ≥ 50 万 → 总经理审批

### 测试步骤

#### 1. 小金额报价（<10 万）

**请求**:
```bash
POST /api/v1/approvals/submit
{
  "entity_type": "QUOTE",
  "entity_id": 1,
  "title": "小金额报价审批",
  "summary": "报价金额 8 万元",
  "urgency": "NORMAL",
  "cc_user_ids": []
}
```

**预期结果**:
- 审批实例创建成功
- 第一个节点：销售经理审批（条件表达式 `{{ amount | float < 100000 }}` 匹配）
- 不应该创建销售总监和总经理的任务

#### 2. 中等金额报价（10 万 ≤ 金额 < 50 万）

**请求**:
```bash
POST /api/v1/approvals/submit
{
  "entity_type": "QUOTE",
  "entity_id": 2,
  "title": "中等金额报价审批",
  "summary": "报价金额 25 万元",
  "urgency": "NORMAL",
  "cc_user_ids": []
}
```

**预期结果**:
- 审批实例创建成功
- 第一个节点：销售总监审批（条件表达式 `{{ amount | float >= 100000 and amount | float < 500000 }}` 匹配）

#### 3. 大金额报价（≥ 50 万）

**请求**:
```bash
POST /api/v1/approvals/submit
{
  "entity_type": "QUOTE",
  "entity_id": 3,
  "title": "大金额报价审批",
  "summary": "报价金额 60 万元",
  "urgency": "URGENT",
  "cc_user_ids": [5, 6]
}
```

**预期结果**:
- 审批实例创建成功
- 第一个节点：总经理审批（条件表达式 `{{ amount | float >= 500000 }}` 匹配）
- 抄送人接收到通知

## CONTRACT 审批流程测试

### 测试目标
验证合同审批的条件路由：
- 金额 < 50 万 → 销售经理审批
- 50 万 ≤ 金额 < 100 万 → 销售总监审批
- 金额 ≥ 100 万 → 总经理审批

### 测试步骤

#### 1. 小金额合同（< 50 万）

**请求**:
```bash
POST /api/v1/approvals/submit
{
  "entity_type": "CONTRACT",
  "entity_id": 1,
  "title": "小金额合同审批",
  "summary": "合同金额 30 万元",
  "urgency": "NORMAL"
}
```

**预期结果**:
- 路由到销售经理审批节点

#### 2. 中等金额合同（50 万 ≤ 金额 < 100 万）

**请求**:
```bash
POST /api/v1/approvals/submit
{
  "entity_type": "CONTRACT",
  "entity_id": 2,
  "title": "中等金额合同审批",
  "summary": "合同金额 80 万元",
  "urgency": "URGENT"
}
```

**预期结果**:
- 路由到销售总监审批节点

#### 3. 大金额合同（≥ 100 万）

**请求**:
```bash
POST /api/v1/approvals/submit
{
  "entity_type": "CONTRACT",
  "entity_id": 3,
  "title": "大金额合同审批",
  "summary": "合同金额 120 万元",
  "urgency": "CRITICAL",
  "cc_user_ids": [5, 6, 7]
}
```

**预期结果**:
- 路由到总经理审批节点

## INVOICE 审批流程测试

### 测试目标
验证发票审批的条件路由：
- 金额 < 10 万 → 财务经理审批
- 金额 ≥ 10 万 → 财务总监审批

### 测试步骤

#### 1. 小金额发票（< 10 万）

**请求**:
```bash
POST /api/v1/approvals/submit
{
  "entity_type": "INVOICE",
  "entity_id": 1,
  "title": "小金额发票审批",
  "summary": "发票金额 5 万元",
  "urgency": "NORMAL"
}
```

**预期结果**:
- 路由到财务经理审批节点

#### 2. 大金额发票（≥ 10 万）

**请求**:
```bash
POST /api/v1/approvals/submit
{
  "entity_type": "INVOICE",
  "entity_id": 2,
  "title": "大金额发票审批",
  "summary": "发票金额 15 万元",
  "urgency": "URGENT"
}
```

**预期结果**:
- 路由到财务总监审批节点

## 审批操作测试

### 1. 驳回审批测试

**场景**: 审批人发现数据错误，需要退回提交人修改

**请求**:
```bash
POST /api/v1/approvals/{instance_id}/withdraw
{
  "decision": "WITHDRAW",
  "comment": "数据需要补充，请修改后重新提交"
}
```

**预期结果**:
- 审批实例退回到初始状态
- 所有待处理任务被取消
- 提交人可以重新提交

### 2. 驳回审批测试（新功能）

**场景**: 审批人因外出，委托给其他同事

**请求**:
```bash
POST /api/v1/approvals/{instance_id}/delegate
{
  "decision": "DELEGATE",
  "delegate_to_id": 8,
  "comment": "因外出，委托给王经理处理"
}
```

**预期结果**:
- 当前任务状态变为 DELEGATED
- 新任务创建给被委托人（王经理）
- 记录委托操作日志

### 3. 驳回审批测试

**场景**: 审批人认为变更不合理

**请求**:
```bash
POST /api/v1/approvals/{instance_id}/reject
{
  "decision": "REJECT",
  "comment": "变更方案不符合技术要求"
}
```

**预期结果**:
- 审批实例状态变为 REJECTED
- 业务实体状态同步为已驳回
- 提交人收到驳回通知

## 查询接口测试

### 1. 查询我的待审批任务

**请求**:
```bash
GET /api/v1/approvals/my-tasks
Authorization: Bearer {token}
```

**预期结果**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total": 5,
    "pending": 3,
    "tasks": [...],
    "total_levels": 3,
    "current_level": 1,
    "progress": 33
  }
}
```

### 2. 查询审批历史

**请求**:
```bash
GET /api/v1/approvals/1/history
```

**预期结果**:
返回完整的审批操作历史，包括：
- SUBMIT
- APPROVE（技术评审）
- APPROVE（部门会签 A）
- APPROVE（部门会签 B）
- APPROVE（最终审批）

### 3. 查询审批详情

**请求**:
```bash
GET /api/v1/approvals/1/detail
```

**预期结果**:
返回审批实例的完整信息，包括：
- 基本信息
- 当前任务
- 所有任务
- 审批历史日志

## 测试结果验证

### 数据库验证

每个测试完成后，运行以下 SQL 查询验证：

```bash
# 验证审批实例
sqlite3 data/app.db "SELECT id, entity_type, status, current_node_order FROM approval_instances ORDER BY id DESC LIMIT 10;"

# 验证审批任务
sqlite3 data/app.db "SELECT id, instance_id, node_code, status, assignee_id FROM approval_tasks ORDER BY id DESC LIMIT 20;"

# 验证审批日志
sqlite3 data/app.db "SELECT id, action, operator_id, action_at FROM approval_action_logs ORDER BY id DESC LIMIT 20;"
```

### 预期数据

- **approval_instances**: 1 个审批实例
- **approval_tasks**: 每个实例 2-3 个任务
- **approval_action_logs**: 每个操作 1 条日志

## 测试检查清单

### ECN 审批

- [ ] ECN 提交成功
- [ ] 条件路由正确（无条件，固定流程）
- [ ] 技术评审通过
- [ ] 部门会签完成（AND_SIGN 模式）
- [ ] 最终审批通过
- [ ] 状态正确同步到 ECN 实体
- [ ] 审批历史完整记录

### QUOTE 审批

- [ ] 小金额（<10 万）路由到销售经理
- [ ] 中等金额（10-50 万）路由到销售总监
- [ ] 大金额（≥50 万）路由到总经理
- [ ] 条件表达式正确评估
- [ ] 审批通过后状态正确同步

### CONTRACT 审批

- [ ] 小金额（<50 万）路由到销售经理
- [ ] 中等金额（50-100 万）路由到销售总监
- [ ] 大金额（≥100 万）路由到总经理
- [ ] 审批流程正常

### INVOICE 审批

- [ ] 小金额（<10 万）路由到财务经理
- [ ] 大金额（≥10 万）路由到财务总监
- [ ] 审批流程正常

### 通用功能

- [ ] 委托审批功能正常
- [ ] 驳回审批功能正常
- [ ] 驳回审批功能正常
- [ ] 我的待审批任务查询正常
- [ ] 审批历史查询正常
- [ ] 审批详情查询正常
- [ ] 状态显示正确
- [ ] 进度计算正确

## 测试说明

### 认证问题

统一审批 API 需要 JWT token 认证。测试前需要：

1. **获取 Token**:
   ```bash
   POST /api/v1/auth/login
   {
     "username": "admin",
     "password": "admin123"
   }
   ```

2. **使用 Token**:
   - 设置请求头: `Authorization: Bearer {token}`
   - 或者直接使用 `get_current_user` 依赖（如果前端实现）

### 临时绕过认证（仅开发测试）

如果需要临时绕过认证进行测试，可以修改：
- `app/api/v1/endpoints/approvals/router.py`
- 注释掉 `get_current_user` 依赖
- 创建测试用户

**警告**: 生产环境绝不能禁用认证！

### 测试工具

可以使用以下工具进行测试：

#### 1. cURL

```bash
# 保存 token 到环境变量
export TOKEN="your-jwt-token-here"

# 提交审批
curl -X POST http://127.0.0.1:8000/api/v1/approvals/submit \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "entity_type": "ECN",
    "entity_id": 1,
    "title": "ECN 测试",
    "summary": "测试描述",
    "urgency": "NORMAL",
    "cc_user_ids": []
  }'
```

#### 2. Postman / Insomnia

- 导入 OpenAPI spec: `http://127.0.0.1:8000/api/v1/openapi.json`
- 设置认证 token
- 逐步测试各个端点

#### 3. 前端浏览器

1. 打开 `http://127.0.0.1:8000/docs`
2. 使用 Swagger UI 测试
3. 观察请求和响应

## 测试问题处理

### Q1: 条件路由不工作

**排查**:
1. 检查 approval_node_definitions 表中的 condition_expression 字段
2. 验证 Jinja2 模板语法正确
3. 检查 ConditionEvaluator 日志

### Q2: 审批任务未创建

**排查**:
1. 检查 approver_config 配置
2. 验证用户角色配置
3. 检查 WorkflowEngine 日志

### Q3: 状态同步失败

**排查**:
1. 检查 EcnApprovalAdapter / SalesApprovalAdapter 的 sync 方法
2. 验证业务实体表的字段名
3. 检查数据库外键约束

## 测试完成标准

**所有检查清单项目必须完成**：
- ✅ 数据库迁移验证通过
- ✅ 后端 API 测试通过
- ✅ 所有 4 个实体类型测试通过
- ✅ 条件路由测试通过
- ✅ 所有审批操作测试通过
- ✅ 查询接口测试通过
- ✅ 数据一致性验证通过
- ✅ 前端服务文件测试通过

---

**测试计划版本**: v1.0
**创建日期**: 2026-01-25
**执行状态**: 待执行（需要有效 JWT token）

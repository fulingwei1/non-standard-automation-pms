# åŸºç¡€è®¾æ–½å®Œå–„å»ºè®®

> åœ¨å¼€å§‹æ–°é¡¹ç›®å‰ï¼Œå»ºè®®å®Œå–„çš„åŸºç¡€è®¾æ–½æ¸…å•

---

## ğŸ¯ ä¼˜å…ˆçº§åˆ†ç±»

### ğŸ”´ P0 - å¿…é¡»å®ç°ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

### ğŸŸ¡ P1 - å¼ºçƒˆå»ºè®®ï¼ˆæå‡å¼€å‘æ•ˆç‡ï¼‰

### ğŸŸ¢ P2 - å¯é€‰å®ç°ï¼ˆä¼˜åŒ–ä½“éªŒï¼‰

---

## ğŸ”´ P0 - å¿…é¡»å®ç°

### 1. ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶ â­â­â­

**ä½ç½®**ï¼š`app/core/middleware/error_handler.py`

**åŠŸèƒ½**ï¼š
- ç»Ÿä¸€å¼‚å¸¸æ•è·å’Œæ ¼å¼åŒ–
- HTTPå¼‚å¸¸å¤„ç†
- ä¸šåŠ¡å¼‚å¸¸å¤„ç†
- é”™è¯¯æ—¥å¿—è®°å½•

**å®ç°å»ºè®®**ï¼š

```python
# app/core/middleware/error_handler.py
from fastapi import Request, status
from fastapi.responses import JSONResponse
from fastapi.exceptions import RequestValidationError
from starlette.exceptions import HTTPException as StarletteHTTPException
import logging

logger = logging.getLogger(__name__)

async def error_handler_middleware(request: Request, call_next):
    try:
        response = await call_next(request)
        return response
    except StarletteHTTPException as exc:
        return JSONResponse(
            status_code=exc.status_code,
            content={
                "success": False,
                "code": exc.status_code,
                "message": exc.detail,
                "data": None
            }
        )
    except RequestValidationError as exc:
        return JSONResponse(
            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
            content={
                "success": False,
                "code": 422,
                "message": "è¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥",
                "data": exc.errors()
            }
        )
    except Exception as exc:
        logger.exception(f"æœªå¤„ç†çš„å¼‚å¸¸: {exc}")
        return JSONResponse(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            content={
                "success": False,
                "code": 500,
                "message": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
                "data": None
            }
        )
```

**ä½¿ç”¨**ï¼š

```python
# app/main.py
from app.core.middleware.error_handler import error_handler_middleware

app.add_middleware(BaseHTTPMiddleware, dispatch=error_handler_middleware)
```

---

### 2. ç»Ÿä¸€å“åº”æ ¼å¼ â­â­â­

**ä½ç½®**ï¼š`app/core/schemas/response.py`

**åŠŸèƒ½**ï¼š
- ç»Ÿä¸€APIå“åº”æ ¼å¼
- æˆåŠŸ/å¤±è´¥å“åº”æ¨¡æ¿
- åˆ†é¡µå“åº”æ¨¡æ¿

**å®ç°å»ºè®®**ï¼š

```python
# app/core/schemas/response.py
from typing import Generic, TypeVar, Optional, List
from pydantic import BaseModel

T = TypeVar('T')

class BaseResponse(BaseModel, Generic[T]):
    """ç»Ÿä¸€å“åº”æ ¼å¼"""
    success: bool
    code: int
    message: str
    data: Optional[T] = None

class SuccessResponse(BaseResponse[T]):
    """æˆåŠŸå“åº”"""
    success: bool = True
    code: int = 200

class ErrorResponse(BaseResponse):
    """é”™è¯¯å“åº”"""
    success: bool = False
    code: int
    message: str
    data: None = None

class PaginatedResponse(BaseModel, Generic[T]):
    """åˆ†é¡µå“åº”"""
    items: List[T]
    total: int
    page: int
    page_size: int
    pages: int
```

---

### 3. ç»Ÿä¸€æ—¥å¿—é…ç½® â­â­â­

**ä½ç½®**ï¼š`app/core/logging_config.py`

**åŠŸèƒ½**ï¼š
- ç»“æ„åŒ–æ—¥å¿—
- æ—¥å¿—çº§åˆ«é…ç½®
- æ—¥å¿—æ ¼å¼ç»Ÿä¸€
- æ–‡ä»¶/æ§åˆ¶å°è¾“å‡º

**å®ç°å»ºè®®**ï¼š

```python
# app/core/logging_config.py
import logging
import sys
from logging.handlers import RotatingFileHandler
from pathlib import Path

def setup_logging(log_level: str = "INFO", log_file: str = "app.log"):
    """é…ç½®æ—¥å¿—ç³»ç»Ÿ"""
    
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    log_dir = Path("logs")
    log_dir.mkdir(exist_ok=True)
    
    # é…ç½®æ—¥å¿—æ ¼å¼
    log_format = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    
    # æ§åˆ¶å°å¤„ç†å™¨
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(log_format)
    
    # æ–‡ä»¶å¤„ç†å™¨ï¼ˆè½®è½¬ï¼‰
    file_handler = RotatingFileHandler(
        log_dir / log_file,
        maxBytes=10 * 1024 * 1024,  # 10MB
        backupCount=5
    )
    file_handler.setFormatter(log_format)
    
    # é…ç½®æ ¹æ—¥å¿—å™¨
    root_logger = logging.getLogger()
    root_logger.setLevel(getattr(logging, log_level.upper()))
    root_logger.addHandler(console_handler)
    root_logger.addHandler(file_handler)
    
    return root_logger
```

---

### 4. ç¯å¢ƒé…ç½®ç®¡ç† â­â­â­

**ä½ç½®**ï¼š`app/core/config.py`ï¼ˆå·²å­˜åœ¨ï¼Œéœ€å®Œå–„ï¼‰

**åŠŸèƒ½**ï¼š
- ç¯å¢ƒå˜é‡ç®¡ç†
- é…ç½®éªŒè¯
- é»˜è®¤å€¼è®¾ç½®
- é…ç½®æ–‡æ¡£

**å®Œå–„å»ºè®®**ï¼š

```python
# app/core/config.py
from pydantic_settings import BaseSettings
from typing import List, Optional

class Settings(BaseSettings):
    # åº”ç”¨é…ç½®
    APP_NAME: str = "éæ ‡è‡ªåŠ¨åŒ–é¡¹ç›®ç®¡ç†ç³»ç»Ÿ"
    DEBUG: bool = False
    VERSION: str = "1.0.0"
    
    # æ•°æ®åº“é…ç½®
    DATABASE_URL: str
    DATABASE_ECHO: bool = False
    
    # Redisé…ç½®
    REDIS_URL: Optional[str] = None
    
    # JWTé…ç½®
    SECRET_KEY: str
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 1440
    
    # CORSé…ç½®
    CORS_ORIGINS: List[str] = ["http://localhost:3000"]
    
    # æ–‡ä»¶ä¸Šä¼ é…ç½®
    UPLOAD_DIR: str = "uploads"
    MAX_UPLOAD_SIZE: int = 10 * 1024 * 1024  # 10MB
    
    class Config:
        env_file = ".env"
        case_sensitive = True

settings = Settings()
```

---

## ğŸŸ¡ P1 - å¼ºçƒˆå»ºè®®

### 5. ç»Ÿä¸€éªŒè¯å™¨ â­â­

**ä½ç½®**ï¼š`app/core/validators/`

**åŠŸèƒ½**ï¼š
- é€šç”¨éªŒè¯å‡½æ•°
- è‡ªå®šä¹‰éªŒè¯å™¨
- éªŒè¯é”™è¯¯æ¶ˆæ¯

**å®ç°å»ºè®®**ï¼š

```python
# app/core/validators/common.py
from typing import Any
from pydantic import validator

def validate_project_code(code: str) -> str:
    """éªŒè¯é¡¹ç›®ç¼–ç æ ¼å¼"""
    if not code.startswith("PJ"):
        raise ValueError("é¡¹ç›®ç¼–ç å¿…é¡»ä»¥PJå¼€å¤´")
    if len(code) != 11:
        raise ValueError("é¡¹ç›®ç¼–ç é•¿åº¦å¿…é¡»ä¸º11ä½")
    return code

def validate_phone(phone: str) -> str:
    """éªŒè¯æ‰‹æœºå·"""
    import re
    pattern = r'^1[3-9]\d{9}$'
    if not re.match(pattern, phone):
        raise ValueError("æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®")
    return phone
```

---

### 6. å·¥å…·å‡½æ•°åº“ â­â­

**ä½ç½®**ï¼š`app/utils/common.py`

**åŠŸèƒ½**ï¼š
- æ—¥æœŸæ—¶é—´å·¥å…·
- å­—ç¬¦ä¸²å·¥å…·
- æ•°å€¼å·¥å…·
- åŠ å¯†å·¥å…·

**å®ç°å»ºè®®**ï¼š

```python
# app/utils/common.py
from datetime import datetime, date
from typing import Optional
import hashlib

def format_date(dt: Optional[datetime], fmt: str = "%Y-%m-%d") -> Optional[str]:
    """æ ¼å¼åŒ–æ—¥æœŸ"""
    return dt.strftime(fmt) if dt else None

def generate_hash(text: str) -> str:
    """ç”Ÿæˆå“ˆå¸Œå€¼"""
    return hashlib.md5(text.encode()).hexdigest()

def safe_divide(numerator: float, denominator: float, default: float = 0.0) -> float:
    """å®‰å…¨é™¤æ³•"""
    return numerator / denominator if denominator != 0 else default
```

---

### 7. æ•°æ®åº“è¿ç§»é…ç½® â­â­

**ä½ç½®**ï¼š`alembic.ini`, `alembic/env.py`

**åŠŸèƒ½**ï¼š
- Alembicé…ç½®
- è‡ªåŠ¨è¿ç§»è„šæœ¬
- è¿ç§»å›æ»š

**å®ç°å»ºè®®**ï¼š

```python
# alembic/env.py
from app.models.base import Base
from app.core.config import settings

# ä½¿ç”¨é…ç½®ä¸­çš„æ•°æ®åº“URL
config.set_main_option("sqlalchemy.url", settings.DATABASE_URL)

target_metadata = Base.metadata
```

---

### 8. ç¼“å­˜æŠ½è±¡å±‚ â­â­

**ä½ç½®**ï¼š`app/core/cache.py`

**åŠŸèƒ½**ï¼š
- Redisç¼“å­˜å°è£…
- ç¼“å­˜è£…é¥°å™¨
- ç¼“å­˜å¤±æ•ˆç­–ç•¥

**å®ç°å»ºè®®**ï¼š

```python
# app/core/cache.py
from functools import wraps
from typing import Callable, Any
import json
import redis
from app.core.config import settings

redis_client = redis.from_url(settings.REDIS_URL) if settings.REDIS_URL else None

def cache_result(key_prefix: str, ttl: int = 3600):
    """ç¼“å­˜ç»“æœè£…é¥°å™¨"""
    def decorator(func: Callable) -> Callable:
        @wraps(func)
        async def wrapper(*args, **kwargs):
            if not redis_client:
                return await func(*args, **kwargs)
            
            cache_key = f"{key_prefix}:{hash(str(args) + str(kwargs))}"
            cached = redis_client.get(cache_key)
            
            if cached:
                return json.loads(cached)
            
            result = await func(*args, **kwargs)
            redis_client.setex(cache_key, ttl, json.dumps(result))
            return result
        return wrapper
    return decorator
```

---

### 9. æ–‡ä»¶å­˜å‚¨æŠ½è±¡ â­â­

**ä½ç½®**ï¼š`app/core/storage.py`

**åŠŸèƒ½**ï¼š
- æ–‡ä»¶ä¸Šä¼ å¤„ç†
- æ–‡ä»¶å­˜å‚¨æŠ½è±¡
- æ–‡ä»¶è®¿é—®URLç”Ÿæˆ

**å®ç°å»ºè®®**ï¼š

```python
# app/core/storage.py
from pathlib import Path
from typing import BinaryIO, Optional
from app.core.config import settings
import uuid

class FileStorage:
    """æ–‡ä»¶å­˜å‚¨æŠ½è±¡ç±»"""
    
    def __init__(self, base_dir: str = None):
        self.base_dir = Path(base_dir or settings.UPLOAD_DIR)
        self.base_dir.mkdir(parents=True, exist_ok=True)
    
    async def save(self, file: BinaryIO, filename: str = None) -> str:
        """ä¿å­˜æ–‡ä»¶"""
        if not filename:
            filename = f"{uuid.uuid4()}_{file.filename}"
        
        file_path = self.base_dir / filename
        with open(file_path, "wb") as f:
            f.write(await file.read())
        
        return str(file_path)
    
    def get_url(self, file_path: str) -> str:
        """è·å–æ–‡ä»¶è®¿é—®URL"""
        return f"/uploads/{Path(file_path).name}"
```

---

### 10. æµ‹è¯•å·¥å…·å’ŒFixtures â­â­

**ä½ç½®**ï¼š`tests/conftest.py`, `tests/utils/`

**åŠŸèƒ½**ï¼š
- æµ‹è¯•æ•°æ®åº“é…ç½®
- æµ‹è¯•æ•°æ®ç”Ÿæˆ
- æµ‹è¯•è¾…åŠ©å‡½æ•°

**å®ç°å»ºè®®**ï¼š

```python
# tests/conftest.py
import pytest
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
from app.models.base import Base

@pytest.fixture
async def test_db():
    """æµ‹è¯•æ•°æ®åº“"""
    engine = create_async_engine("sqlite+aiosqlite:///:memory:")
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    
    async_session = async_sessionmaker(engine, expire_on_commit=False)
    async with async_session() as session:
        yield session
    
    await engine.dispose()

# tests/utils/test_data.py
def create_test_project(**kwargs):
    """åˆ›å»ºæµ‹è¯•é¡¹ç›®æ•°æ®"""
    defaults = {
        "name": "æµ‹è¯•é¡¹ç›®",
        "code": "PJ250101001",
        "status": "ACTIVE"
    }
    defaults.update(kwargs)
    return defaults
```

---

## ğŸŸ¢ P2 - å¯é€‰å®ç°

### 11. APIæ–‡æ¡£å¢å¼º â­

**ä½ç½®**ï¼š`app/main.py`

**åŠŸèƒ½**ï¼š
- OpenAPIæ–‡æ¡£å®šåˆ¶
- APIæ ‡ç­¾ç»„ç»‡
- ç¤ºä¾‹æ•°æ®

**å®ç°å»ºè®®**ï¼š

```python
# app/main.py
app = FastAPI(
    title="éæ ‡è‡ªåŠ¨åŒ–é¡¹ç›®ç®¡ç†ç³»ç»Ÿ API",
    description="å®Œæ•´çš„APIæ–‡æ¡£",
    version="1.0.0",
    openapi_tags=[
        {"name": "é¡¹ç›®", "description": "é¡¹ç›®ç®¡ç†ç›¸å…³API"},
        {"name": "ç‰©æ–™", "description": "ç‰©æ–™ç®¡ç†ç›¸å…³API"},
    ]
)
```

---

### 12. æ€§èƒ½ç›‘æ§ â­

**ä½ç½®**ï¼š`app/core/middleware/performance.py`

**åŠŸèƒ½**ï¼š
- è¯·æ±‚è€—æ—¶ç»Ÿè®¡
- æ…¢æŸ¥è¯¢ç›‘æ§
- æ€§èƒ½æŒ‡æ ‡æ”¶é›†

---

### 13. å¥åº·æ£€æŸ¥ç«¯ç‚¹ â­

**ä½ç½®**ï¼š`app/api/v1/endpoints/health.py`

**åŠŸèƒ½**ï¼š
- æ•°æ®åº“è¿æ¥æ£€æŸ¥
- Redisè¿æ¥æ£€æŸ¥
- æœåŠ¡çŠ¶æ€æŠ¥å‘Š

**å®ç°å»ºè®®**ï¼š

```python
# app/api/v1/endpoints/health.py
from fastapi import APIRouter
from app.core.config import settings

router = APIRouter()

@router.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥"""
    return {
        "status": "healthy",
        "version": settings.VERSION,
        "database": "connected",  # å®é™…æ£€æŸ¥æ•°æ®åº“
        "redis": "connected" if settings.REDIS_URL else "not_configured"
    }
```

---

### 14. ä»»åŠ¡é˜Ÿåˆ—é…ç½® â­

**ä½ç½®**ï¼š`app/core/celery_app.py`

**åŠŸèƒ½**ï¼š
- Celeryé…ç½®
- å¼‚æ­¥ä»»åŠ¡å®šä¹‰
- ä»»åŠ¡ç›‘æ§

---

### 15. Dockeré…ç½®ä¼˜åŒ– â­

**ä½ç½®**ï¼š`Dockerfile`, `docker-compose.yml`

**åŠŸèƒ½**ï¼š
- å¤šé˜¶æ®µæ„å»º
- å¼€å‘/ç”Ÿäº§ç¯å¢ƒåˆ†ç¦»
- å¥åº·æ£€æŸ¥é…ç½®

---

## ğŸ“‹ å®æ–½ä¼˜å…ˆçº§å»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³å®æ–½ï¼‰

1. âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
2. âœ… ç»Ÿä¸€å“åº”æ ¼å¼
3. âœ… ç»Ÿä¸€æ—¥å¿—é…ç½®
4. âœ… ç¯å¢ƒé…ç½®ç®¡ç†å®Œå–„

### ç¬¬äºŒé˜¶æ®µï¼ˆ1å‘¨å†…ï¼‰

5. âœ… ç»Ÿä¸€éªŒè¯å™¨
6. âœ… å·¥å…·å‡½æ•°åº“
7. âœ… æ•°æ®åº“è¿ç§»é…ç½®
8. âœ… ç¼“å­˜æŠ½è±¡å±‚

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ2å‘¨å†…ï¼‰

9. âœ… æ–‡ä»¶å­˜å‚¨æŠ½è±¡
10. âœ… æµ‹è¯•å·¥å…·å’ŒFixtures
11. âœ… APIæ–‡æ¡£å¢å¼º

### ç¬¬å››é˜¶æ®µï¼ˆæŒ‰éœ€ï¼‰

12. âš ï¸ æ€§èƒ½ç›‘æ§
13. âš ï¸ å¥åº·æ£€æŸ¥ç«¯ç‚¹
14. âš ï¸ ä»»åŠ¡é˜Ÿåˆ—é…ç½®
15. âš ï¸ Dockeré…ç½®ä¼˜åŒ–

---

## ğŸ¯ å®æ–½å»ºè®®

### 1. ä»æ ¸å¿ƒå¼€å§‹

ä¼˜å…ˆå®ç°P0çº§åˆ«çš„åŠŸèƒ½ï¼Œè¿™äº›æ˜¯ç³»ç»Ÿè¿è¡Œçš„åŸºç¡€ã€‚

### 2. é€æ­¥å®Œå–„

æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥å®æ–½ï¼Œä¸è¦ä¸€æ¬¡æ€§å®ç°æ‰€æœ‰åŠŸèƒ½ã€‚

### 3. ä¿æŒä¸€è‡´æ€§

æ‰€æœ‰åŸºç¡€è®¾æ–½éƒ½åº”è¯¥éµå¾ªç»Ÿä¸€çš„è§„èŒƒå’Œæ¨¡å¼ã€‚

### 4. æ–‡æ¡£å…ˆè¡Œ

æ¯ä¸ªåŸºç¡€è®¾æ–½éƒ½åº”è¯¥æœ‰æ¸…æ™°çš„æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **CRUDåŸºç±»**ï¼š`app/common/crud/README.md`
- **å‰ç«¯åŸºç¡€è®¾æ–½**ï¼š`frontend/src/core/README.md`
- **é…ç½®ç®¡ç†**ï¼š`app/core/config.py`

---

**æœ€åæ›´æ–°**ï¼š2026-01-23  
**ç‰ˆæœ¬**ï¼šv1.0

# 异常处理流程设计文档

## 1. 概述

### 1.1 目标
建立完善的生产异常闭环管理体系，实现异常的快速响应、有效处理和持续改进。

### 1.2 核心功能
- 异常升级机制
- 处理流程跟踪
- 知识库管理
- 统计分析
- PDCA闭环

## 2. 流程状态机

### 2.1 状态定义

```
┌─────────┐      ┌────────────┐      ┌──────────┐      ┌──────────┐      ┌────────┐
│ PENDING │─────>│ PROCESSING │─────>│ RESOLVED │─────>│ VERIFIED │─────>│ CLOSED │
│ 待处理   │      │  处理中     │      │  已解决   │      │  已验证   │      │ 已关闭  │
└─────────┘      └────────────┘      └──────────┘      └──────────┘      └────────┘
```

### 2.2 状态转换规则

| 当前状态 | 可转换状态 | 触发条件 |
|---------|----------|---------|
| PENDING | PROCESSING | 分配处理人 |
| PROCESSING | RESOLVED | 提交处理结果 |
| RESOLVED | VERIFIED | 验证通过 |
| RESOLVED | PROCESSING | 验证不通过，退回处理 |
| VERIFIED | CLOSED | 确认关闭 |

## 3. 升级机制

### 3.1 升级级别

| 级别 | 处理人 | 触发条件 | 响应时间 |
|-----|-------|---------|---------|
| LEVEL_1 | 班组长 | 一般异常超过2小时未处理 | 1小时内响应 |
| LEVEL_2 | 车间主任 | 重要异常超过4小时未处理 | 30分钟内响应 |
| LEVEL_3 | 生产经理 | 严重异常超过1小时未处理 | 15分钟内响应 |

### 3.2 自动升级规则

```python
# 根据异常级别和处理时长自动升级
if exception_level == "CRITICAL" and pending_duration > 60:
    escalate_to_level_3()
elif exception_level == "MAJOR" and pending_duration > 240:
    escalate_to_level_2()
elif exception_level == "MINOR" and pending_duration > 120:
    escalate_to_level_1()
```

## 4. 处理流程

### 4.1 异常上报
1. 发现异常
2. 填写异常单（类型、级别、描述、影响）
3. 提交系统

### 4.2 异常分配
1. 系统自动创建处理流程
2. 根据异常类型和级别分配处理人
3. 发送通知

### 4.3 异常处理
1. 接收异常
2. 分析原因
3. 制定处理方案
4. 实施处理
5. 记录处理结果

### 4.4 异常验证
1. 验证人检查处理结果
2. 确认问题是否解决
3. 通过则进入已验证状态
4. 不通过则退回处理中

### 4.5 异常关闭
1. 确认无遗留问题
2. 更新知识库
3. 启动PDCA（重要异常）
4. 关闭异常

## 5. 知识库管理

### 5.1 知识条目结构
```json
{
  "title": "知识标题",
  "exception_type": "异常类型",
  "exception_level": "异常级别",
  "symptom_description": "异常症状描述",
  "solution": "解决方案",
  "solution_steps": ["步骤1", "步骤2", "步骤3"],
  "prevention_measures": "预防措施",
  "keywords": "关键词1,关键词2,关键词3"
}
```

### 5.2 智能匹配
- 关键词匹配：标题、症状、解决方案
- 类型匹配：异常类型一致
- 级别匹配：异常级别一致
- 相似度排序：按引用次数和成功率排序

### 5.3 知识维护
- 来源：历史异常、手工录入
- 审核：专家审核通过后发布
- 更新：定期更新，淘汰过时知识
- 统计：记录引用次数、成功次数

## 6. 统计分析

### 6.1 统计维度
- 异常总数
- 按类型统计
- 按级别统计
- 按状态统计
- 平均解决时长
- 升级率
- 重复异常率
- 高频异常TOP10

### 6.2 分析指标

| 指标 | 计算方式 | 目标值 |
|-----|---------|-------|
| 平均解决时长 | 总时长/异常数 | ≤ 4小时 |
| 升级率 | 升级异常数/总异常数 × 100% | ≤ 20% |
| 重复异常率 | 重复异常数/总异常数 × 100% | ≤ 15% |
| 一次解决率 | 一次解决数/总异常数 × 100% | ≥ 85% |

## 7. PDCA闭环

### 7.1 适用范围
- 重要异常（MAJOR及以上）
- 重复异常（同类型异常≥3次）
- 重大损失异常（影响成本≥10000元）

### 7.2 阶段管理

#### Plan（计划）
- 问题描述
- 根本原因分析
- 改善目标
- 改善措施
- 负责人和期限

#### Do（执行）
- 实施内容
- 使用资源
- 遇到的困难
- 执行记录

#### Check（检查）
- 检查结果
- 有效性评估（EFFECTIVE/PARTIAL/INEFFECTIVE）
- 数据分析
- 差距分析

#### Act（改进）
- 标准化措施
- 横向展开计划
- 遗留问题
- 下一轮PDCA计划

### 7.3 阶段推进
```
PLAN → DO → CHECK → ACT → COMPLETED
```
必须按顺序推进，不能跳跃。

## 8. 重复异常分析

### 8.1 相似度算法
使用Jaccard相似度计算标题相似度：
```
similarity = |A ∩ B| / |A ∪ B|
```
相似度 > 60% 判定为相似异常。

### 8.2 分析维度
- 时间趋势：按日期统计发生次数
- 相似异常：标题相似的异常分组
- 常见根因：从PDCA记录提取
- 建议措施：基于历史数据推荐

## 9. API接口

### 9.1 异常升级
```
POST /api/v1/production/exception/escalate
```

### 9.2 流程跟踪
```
GET /api/v1/production/exception/{id}/flow
```

### 9.3 知识库管理
```
POST /api/v1/production/exception/knowledge
GET /api/v1/production/exception/knowledge/search
```

### 9.4 统计分析
```
GET /api/v1/production/exception/statistics
```

### 9.5 PDCA管理
```
POST /api/v1/production/exception/pdca
PUT /api/v1/production/exception/pdca/{id}/advance
```

### 9.6 重复异常分析
```
GET /api/v1/production/exception/recurrence
```

## 10. 数据模型

### 10.1 异常处理流程表
- exception_handling_flow

### 10.2 异常知识库表
- exception_knowledge

### 10.3 PDCA闭环记录表
- exception_pdca

详细字段定义见模型文件。

## 11. 性能优化

### 11.1 索引优化
- exception_id索引
- status索引
- escalation_level索引
- keywords全文索引

### 11.2 查询优化
- 使用joinedload预加载关联数据
- 分页查询避免一次性加载大量数据
- 缓存高频查询结果

## 12. 扩展建议

### 12.1 实时监控
- 异常看板
- 实时预警
- 移动端推送

### 12.2 AI辅助
- 异常预测
- 根因分析
- 智能推荐解决方案

### 12.3 集成对接
- MES系统对接
- 钉钉/企业微信通知
- 设备IoT数据接入

# å¤šç§Ÿæˆ·æ•°æ®è¿ç§»æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [è¿ç§»æ¦‚è¿°](#è¿ç§»æ¦‚è¿°)
2. [è¿ç§»å‰å‡†å¤‡](#è¿ç§»å‰å‡†å¤‡)
3. [è¿ç§»æ­¥éª¤](#è¿ç§»æ­¥éª¤)
4. [éªŒè¯ä¸å›æ»š](#éªŒè¯ä¸å›æ»š)
5. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
6. [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)

---

## ğŸ“– è¿ç§»æ¦‚è¿°

### ç›®æ ‡

å°†ç°æœ‰çš„å•ç§Ÿæˆ·ç³»ç»Ÿè¿ç§»åˆ°å¤šç§Ÿæˆ·æ¶æ„ï¼Œç¡®ä¿ï¼š
- æ‰€æœ‰ç°æœ‰æ•°æ®å…³è”åˆ°é»˜è®¤ç§Ÿæˆ·
- æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- æ”¯æŒæœªæ¥çš„å¤šç§Ÿæˆ·æ‰©å±•
- å¯å›æ»šåˆ°è¿ç§»å‰çŠ¶æ€

### æ¶‰åŠçš„è¡¨

è¿ç§»å°†å¤„ç†ä»¥ä¸‹ç±»å‹çš„æ•°æ®è¡¨ï¼š

| æ¨¡å— | è¡¨å | è¯´æ˜ |
|------|------|------|
| **ç”¨æˆ·æƒé™** | users, roles, api_keys, api_permissions | ç”¨æˆ·å’Œæƒé™æ•°æ® |
| **é¡¹ç›®ç®¡ç†** | projects, project_members, project_milestones | é¡¹ç›®ç›¸å…³æ•°æ® |
| **ä»»åŠ¡ç®¡ç†** | task_unified, task_dependencies | ä»»åŠ¡æ•°æ® |
| **ç”Ÿäº§ç®¡ç†** | production_orders, production_schedules | ç”Ÿäº§æ•°æ® |
| **ç‰©æ–™ç®¡ç†** | materials, bom_headers, bom_items | ç‰©æ–™å’ŒBOM |
| **é‡‡è´­ç®¡ç†** | purchase_requisitions, purchase_orders | é‡‡è´­æ•°æ® |
| **å”®å‰ç®¡ç†** | presales, presale_solutions | å”®å‰æ•°æ® |
| **è´¢åŠ¡ç®¡ç†** | project_costs, standard_costs | æˆæœ¬æ•°æ® |
| **å·¥æ—¶ç®¡ç†** | timesheets | å·¥æ—¶æ•°æ® |

---

## ğŸ› ï¸ è¿ç§»å‰å‡†å¤‡

### 1. å¤‡ä»½æ•°æ®åº“

**å¼ºçƒˆå»ºè®®åœ¨è¿ç§»å‰å¤‡ä»½æ•°æ®åº“ï¼**

#### SQLite å¤‡ä»½

```bash
# å¤‡ä»½æ•°æ®åº“æ–‡ä»¶
cp data/app.db data/app.db.backup_$(date +%Y%m%d_%H%M%S)
```

#### MySQL å¤‡ä»½

```bash
# å¤‡ä»½æ•´ä¸ªæ•°æ®åº“
mysqldump -u username -p database_name > backup_$(date +%Y%m%d_%H%M%S).sql

# æˆ–ä½¿ç”¨è„šæœ¬
bash scripts/backup_database.sh
```

#### PostgreSQL å¤‡ä»½

```bash
# å¤‡ä»½æ•´ä¸ªæ•°æ®åº“
pg_dump -U username database_name > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 2. æ£€æŸ¥ç¯å¢ƒ

```bash
# ç¡®ä¿ Python ç¯å¢ƒæ­£ç¡®
python --version  # åº”ä¸º Python 3.8+

# ç¡®ä¿ä¾èµ–å·²å®‰è£…
pip install -r requirements.txt

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
python -c "from app.models.base import get_engine; print(get_engine().url)"
```

### 3. ç¡®è®¤è¡¨ç»“æ„

```bash
# æ£€æŸ¥ tenants è¡¨æ˜¯å¦å­˜åœ¨
python -c "
from app.models.base import get_engine
from sqlalchemy import inspect
inspector = inspect(get_engine())
print('tenants' in inspector.get_table_names())
"
```

å¦‚æœè¿”å› `False`ï¼Œéœ€è¦å…ˆæ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼š

```bash
# Alembic è¿ç§»
alembic upgrade head

# æˆ–æ‰‹åŠ¨åˆ›å»ºè¡¨
python init_db.py
```

---

## ğŸš€ è¿ç§»æ­¥éª¤

### æ–¹æ³•ä¸€: ä½¿ç”¨ä¸»è¿ç§»è„šæœ¬ï¼ˆæ¨èï¼‰

ä¸»è¿ç§»è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æ­¥éª¤ï¼šåˆ›å»ºç§Ÿæˆ· â†’ è¿ç§»æ•°æ® â†’ éªŒè¯ â†’ ç”ŸæˆæŠ¥å‘Šã€‚

#### 1. é¢„è§ˆè¿ç§»ï¼ˆæ¨èå…ˆæ‰§è¡Œï¼‰

```bash
python scripts/run_tenant_migration.py --dry-run
```

è¿™ä¼šæ˜¾ç¤ºå°†è¦è¿ç§»çš„æ•°æ®ï¼Œä½†ä¸ä¼šå®é™…ä¿®æ”¹æ•°æ®åº“ã€‚

#### 2. æ‰§è¡Œè¿ç§»

```bash
python scripts/run_tenant_migration.py
```

ç³»ç»Ÿä¼šè¦æ±‚ç¡®è®¤ï¼š

```
ç¡®è®¤ç»§ç»­ï¼Ÿè¾“å…¥ 'YES' ç»§ç»­:
```

è¾“å…¥ `YES` åå¼€å§‹è¿ç§»ã€‚

#### 3. æŸ¥çœ‹è¿ç§»æŠ¥å‘Š

è¿ç§»å®Œæˆåï¼ŒæŠ¥å‘Šä¼šä¿å­˜åœ¨ `data/tenant_migration_report_YYYYMMDD_HHMMSS.json`

```bash
cat data/tenant_migration_report_*.json | jq .
```

---

### æ–¹æ³•äºŒ: åˆ†æ­¥æ‰§è¡Œ

å¦‚æœéœ€è¦æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œå¯ä»¥åˆ†æ­¥æ‰§è¡Œï¼š

#### æ­¥éª¤ 1: åˆ›å»ºé»˜è®¤ç§Ÿæˆ·

```bash
python scripts/create_default_tenant.py
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
âœ… åˆ›å»ºé»˜è®¤ç§Ÿæˆ·æˆåŠŸï¼
ç§Ÿæˆ·ID: 1
ç§Ÿæˆ·ç¼–ç : jinkaibo
ç§Ÿæˆ·åç§°: é‡‘å‡¯åšè‡ªåŠ¨åŒ–æµ‹è¯•
```

#### æ­¥éª¤ 2: é¢„è§ˆæ•°æ®è¿ç§»

```bash
python scripts/migrate_to_default_tenant.py --dry-run
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
ğŸ” [DRY-RUN] è¡¨ users: å°†è¿ç§» 15 æ¡è®°å½•
ğŸ” [DRY-RUN] è¡¨ projects: å°†è¿ç§» 8 æ¡è®°å½•
...
ğŸ“‹ è¿ç§»é¢„è§ˆï¼ˆDRY-RUNï¼‰
æ€»è¡¨æ•°: 30
å°†è¿ç§»è®°å½•æ•°: 1234
```

#### æ­¥éª¤ 3: æ‰§è¡Œæ•°æ®è¿ç§»

```bash
python scripts/migrate_to_default_tenant.py
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
âœ… è¡¨ users: æˆåŠŸè¿ç§» 15 æ¡è®°å½•
âœ… è¡¨ projects: æˆåŠŸè¿ç§» 8 æ¡è®°å½•
...
âœ… æ•°æ®è¿ç§»å®Œæˆï¼
```

#### æ­¥éª¤ 4: éªŒè¯æ•°æ®å®Œæ•´æ€§

```bash
python scripts/verify_tenant_migration.py
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
âœ… users
   æ€»è®°å½•: 15
   æœ‰æ•ˆ: 15
   
âœ… projects
   æ€»è®°å½•: 8
   æœ‰æ•ˆ: 8

âœ… æ‰€æœ‰éªŒè¯é€šè¿‡ï¼
```

**ä¿å­˜éªŒè¯æŠ¥å‘Šï¼š**

```bash
python scripts/verify_tenant_migration.py --output-report data/verification_report.json
```

---

## ğŸ”„ éªŒè¯ä¸å›æ»š

### éªŒè¯æ•°æ®

è¿ç§»å®Œæˆåï¼Œå»ºè®®è¿›è¡Œä»¥ä¸‹éªŒè¯ï¼š

#### 1. è‡ªåŠ¨éªŒè¯

```bash
python scripts/verify_tenant_migration.py
```

æ£€æŸ¥é¡¹ï¼š
- âœ… æ˜¯å¦æœ‰ NULL tenant_id
- âœ… å¤–é”®å®Œæ•´æ€§
- âœ… æ•°æ®ä¸€è‡´æ€§

#### 2. æ‰‹åŠ¨éªŒè¯

```sql
-- æ£€æŸ¥é»˜è®¤ç§Ÿæˆ·
SELECT * FROM tenants WHERE tenant_code = 'jinkaibo';

-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…³è”åˆ°ç§Ÿæˆ·
SELECT COUNT(*) FROM users WHERE tenant_id IS NULL;  -- åº”è¯¥ä¸º 0

-- æ£€æŸ¥é¡¹ç›®æ˜¯å¦å…³è”åˆ°ç§Ÿæˆ·
SELECT COUNT(*) FROM projects WHERE tenant_id IS NULL;  -- åº”è¯¥ä¸º 0

-- æ£€æŸ¥å¤–é”®å®Œæ•´æ€§
SELECT COUNT(*) 
FROM users 
WHERE tenant_id NOT IN (SELECT id FROM tenants);  -- åº”è¯¥ä¸º 0
```

#### 3. åŠŸèƒ½æµ‹è¯•

- ç™»å½•ç³»ç»Ÿ
- æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨
- åˆ›å»ºæ–°æ•°æ®
- æŸ¥è¯¢æŠ¥è¡¨

---

### å›æ»šè¿ç§»

å¦‚æœè¿ç§»åå‘ç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šåˆ°è¿ç§»å‰çŠ¶æ€ã€‚

#### âš ï¸ é‡è¦æç¤º

**å›æ»šæ“ä½œä¸å¯é€†ï¼æ‰§è¡Œå‰è¯·ç¡®ä¿ï¼š**

1. å·²å……åˆ†æµ‹è¯•
2. ç¡®è®¤éœ€è¦å›æ»š
3. å·²å¤‡ä»½å½“å‰æ•°æ®åº“

#### é¢„è§ˆå›æ»š

```bash
python scripts/rollback_tenant_migration.py --dry-run
```

#### æ‰§è¡Œå›æ»š

```bash
python scripts/rollback_tenant_migration.py --confirm
```

ç³»ç»Ÿä¼šè¦æ±‚å†æ¬¡ç¡®è®¤ï¼š

```
ç¡®å®šè¦ç»§ç»­å—ï¼Ÿè¾“å…¥ 'YES' ç»§ç»­:
```

è¾“å…¥ `YES` åå¼€å§‹å›æ»šã€‚

**å›æ»šåçŠ¶æ€ï¼š**
- æ‰€æœ‰è¡¨çš„ tenant_id è®¾ç½®ä¸º NULL
- ç³»ç»Ÿå›åˆ°å•ç§Ÿæˆ·æ¨¡å¼
- é»˜è®¤ç§Ÿæˆ·ä»ç„¶å­˜åœ¨ï¼ˆéœ€æ‰‹åŠ¨åˆ é™¤ï¼‰

---

## â“ å¸¸è§é—®é¢˜

### Q1: è¿ç§»ä¼šå½±å“ç°æœ‰æ•°æ®å—ï¼Ÿ

**A:** è¿ç§»åªä¼šè®¾ç½® `tenant_id` å­—æ®µï¼Œä¸ä¼šä¿®æ”¹æˆ–åˆ é™¤ç°æœ‰ä¸šåŠ¡æ•°æ®ã€‚å»ºè®®å…ˆä½¿ç”¨ `--dry-run` æ¨¡å¼é¢„è§ˆã€‚

### Q2: è¿ç§»å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ

**A:** 
1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼Œç¡®å®šå¤±è´¥åŸå› 
2. å¦‚æœæ˜¯éƒ¨åˆ†è¡¨å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨ä¿®å¤åé‡æ–°è¿è¡Œ
3. å¦‚æœéœ€è¦å®Œå…¨å›é€€ï¼Œä½¿ç”¨å›æ»šè„šæœ¬
4. æ¢å¤æ•°æ®åº“å¤‡ä»½

### Q3: å¯ä»¥è‡ªå®šä¹‰ç§Ÿæˆ·ä¿¡æ¯å—ï¼Ÿ

**A:** å¯ä»¥ã€‚ç¼–è¾‘ `scripts/create_default_tenant.py` ä¸­çš„ç§Ÿæˆ·ä¿¡æ¯ï¼š

```python
tenant = Tenant(
    tenant_code="your_code",          # ä¿®æ”¹ç§Ÿæˆ·ç¼–ç 
    tenant_name="æ‚¨çš„å…¬å¸åç§°",        # ä¿®æ”¹ç§Ÿæˆ·åç§°
    # ... å…¶ä»–é…ç½®
)
```

### Q4: è¿ç§»åå¦‚ä½•æ·»åŠ æ–°ç§Ÿæˆ·ï¼Ÿ

**A:** ä½¿ç”¨ç§Ÿæˆ·ç®¡ç† APIï¼š

```python
from app.models.tenant import Tenant, TenantStatus, TenantPlan

tenant = Tenant(
    tenant_code="new_tenant",
    tenant_name="æ–°ç§Ÿæˆ·",
    status=TenantStatus.ACTIVE.value,
    plan_type=TenantPlan.STANDARD.value,
    max_users=50
)
db.add(tenant)
db.commit()
```

### Q5: æ”¯æŒå“ªäº›æ•°æ®åº“ï¼Ÿ

**A:** è¿ç§»è„šæœ¬æ”¯æŒï¼š
- âœ… SQLite
- âœ… MySQL / MariaDB
- âœ… PostgreSQL

è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹æ•°æ®åº“ç±»å‹å¹¶ä½¿ç”¨ç›¸åº”çš„è¯­æ³•ã€‚

### Q6: è¿ç§»éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

**A:** å–å†³äºæ•°æ®é‡ï¼š
- å°å‹ç³»ç»Ÿï¼ˆ< 10ä¸‡æ¡è®°å½•ï¼‰ï¼š1-5 åˆ†é’Ÿ
- ä¸­å‹ç³»ç»Ÿï¼ˆ10ä¸‡-100ä¸‡æ¡ï¼‰ï¼š5-30 åˆ†é’Ÿ
- å¤§å‹ç³»ç»Ÿï¼ˆ> 100ä¸‡æ¡ï¼‰ï¼šå¯èƒ½éœ€è¦æ•°å°æ—¶

å»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œã€‚

### Q7: æŸäº›è¡¨æ²¡æœ‰ tenant_id æ€ä¹ˆåŠï¼Ÿ

**A:** è¿™äº›è¡¨ä¼šè¢«è‡ªåŠ¨è·³è¿‡ã€‚è„šæœ¬ä¼šè®°å½•è·³è¿‡çš„è¡¨ï¼Œæ‚¨å¯ä»¥ï¼š
1. æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸ºè¿™äº›è¡¨æ·»åŠ  tenant_id
2. åˆ›å»º Alembic è¿ç§»æ·»åŠ ç¼ºå¤±çš„åˆ—
3. é‡æ–°è¿è¡Œè¿ç§»è„šæœ¬

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“äº‹åŠ¡

æ‰€æœ‰è¿ç§»æ“ä½œéƒ½åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼š
- âœ… æˆåŠŸï¼šè‡ªåŠ¨æäº¤
- âŒ å¤±è´¥ï¼šè‡ªåŠ¨å›æ»š

### è¡¨è¿ç§»é¡ºåº

è„šæœ¬æŒ‰å­—å…¸é¡ºåºå¤„ç†è¡¨ï¼Œæ— ç‰¹æ®Šä¾èµ–å…³ç³»ã€‚æ¯ä¸ªè¡¨ç‹¬ç«‹è¿ç§»ï¼Œå¤±è´¥ä¸å½±å“å…¶ä»–è¡¨ã€‚

### å¤–é”®çº¦æŸ

- **SQLite**: è‡ªåŠ¨å¯ç”¨å¤–é”®çº¦æŸæ£€æŸ¥
- **MySQL/PostgreSQL**: ä½¿ç”¨æ•°æ®åº“é»˜è®¤è®¾ç½®

éªŒè¯è„šæœ¬ä¼šæ£€æŸ¥å¤–é”®å®Œæ•´æ€§ã€‚

### æ€§èƒ½ä¼˜åŒ–

å¯¹äºå¤§æ•°æ®é‡è¿ç§»ï¼Œè„šæœ¬ä½¿ç”¨ï¼š
- æ‰¹é‡ UPDATE è¯­å¥
- æœ€å°åŒ–æ—¥å¿—è¾“å‡º
- å•æ¬¡æäº¤

å¦‚éœ€è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå¯ä»¥ï¼š
1. ä¸´æ—¶ç¦ç”¨ç´¢å¼•
2. åˆ†æ‰¹å¤„ç†
3. ä½¿ç”¨å¹¶è¡Œå¤„ç†

### æ—¥å¿—è®°å½•

è¿ç§»è¿‡ç¨‹ä¼šè®°å½•ï¼š
- INFO: æ­£å¸¸è¿›åº¦ä¿¡æ¯
- WARNING: è·³è¿‡çš„è¡¨å’Œè­¦å‘Š
- ERROR: é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª

æ—¥å¿—è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼Œå¯ä»¥é‡å®šå‘åˆ°æ–‡ä»¶ï¼š

```bash
python scripts/run_tenant_migration.py 2>&1 | tee migration.log
```

---

## ğŸ“ æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥æ—¥å¿—è¾“å‡º
2. æŸ¥çœ‹è¿ç§»æŠ¥å‘Š JSON æ–‡ä»¶
3. è¿è¡ŒéªŒè¯è„šæœ¬
4. è”ç³»æŠ€æœ¯æ”¯æŒ

---

## ğŸ“ æ›´æ–°å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| 2026-02-16 | 1.0 | åˆå§‹ç‰ˆæœ¬ |

---

**âš ï¸  é‡è¦æç¤º**

- è¿ç§»å‰åŠ¡å¿…å¤‡ä»½æ•°æ®åº“
- å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œ
- å‡†å¤‡å¥½å›æ»šæ–¹æ¡ˆ

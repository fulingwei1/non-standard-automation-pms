# æœåŠ¡æ–‡ä»¶æµ‹è¯•ç¼–å†™æŒ‡å—

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### 1. é€‰æ‹©ä¸€ä¸ªæœåŠ¡æ–‡ä»¶

æŸ¥çœ‹å·²ç”Ÿæˆçš„æµ‹è¯•æ–‡ä»¶ï¼š
```bash
ls tests/unit/test_*.py | head -10
```

### 2. æŸ¥çœ‹æµ‹è¯•æ–‡ä»¶ç»“æ„

```python
# tests/unit/test_example_service.py
import pytest
from unittest.mock import MagicMock, patch
from app.services.example_service import ExampleService

@pytest.fixture
def example_service(db_session):
    """åˆ›å»ºæœåŠ¡å®ä¾‹"""
    return ExampleService(db_session)

class TestExampleService:
    """æµ‹è¯•å¥—ä»¶"""
    
    def test_init(self, db_session):
        """æµ‹è¯•åˆå§‹åŒ–"""
        service = ExampleService(db_session)
        assert service is not None
    
    def test_some_method(self, example_service):
        """æµ‹è¯•æŸä¸ªæ–¹æ³• - TODO: å®ç°"""
        pass
```

### 3. å®ç°æµ‹è¯•ç”¨ä¾‹

#### æ­¥éª¤1: ç†è§£æœåŠ¡ä»£ç 

```bash
# æŸ¥çœ‹æœåŠ¡æ–‡ä»¶
cat app/services/example_service.py
```

#### æ­¥éª¤2: ç¼–å†™æµ‹è¯•

```python
def test_some_method_success(self, example_service):
    """æµ‹è¯•æ­£å¸¸æµç¨‹"""
    # Arrange - å‡†å¤‡æµ‹è¯•æ•°æ®
    test_input = {"key": "value"}
    
    # Act - æ‰§è¡Œæ–¹æ³•
    result = example_service.some_method(test_input)
    
    # Assert - éªŒè¯ç»“æœ
    assert result is not None
    assert result["status"] == "success"

def test_some_method_with_invalid_input(self, example_service):
    """æµ‹è¯•æ— æ•ˆè¾“å…¥"""
    with pytest.raises(ValueError):
        example_service.some_method(None)

def test_some_method_with_mock(self, example_service):
    """æµ‹è¯•ä½¿ç”¨ Mock"""
    with patch('app.services.example_service.SomeDependency') as mock_dep:
        mock_dep.return_value = "mocked_value"
        result = example_service.some_method({})
        assert result == "mocked_value"
```

### 4. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶
pytest tests/unit/test_example_service.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
pytest tests/unit/test_example_service.py::TestExampleService::test_some_method -v

# æ£€æŸ¥è¦†ç›–ç‡
pytest tests/unit/test_example_service.py --cov=app/services/example_service --cov-report=term-missing
```

---

## ğŸ¯ æµ‹è¯•ç¼–å†™æ¨¡å¼

### æ¨¡å¼1: åŸºç¡€åŠŸèƒ½æµ‹è¯•

```python
def test_basic_functionality(self, service):
    """æµ‹è¯•åŸºæœ¬åŠŸèƒ½"""
    # å‡†å¤‡æ•°æ®
    input_data = create_test_data()
    
    # æ‰§è¡Œ
    result = service.process(input_data)
    
    # éªŒè¯
    assert result is not None
    assert result.status == "success"
```

### æ¨¡å¼2: è¾¹ç•Œæ¡ä»¶æµ‹è¯•

```python
def test_empty_input(self, service):
    """æµ‹è¯•ç©ºè¾“å…¥"""
    result = service.process([])
    assert result == []

def test_max_value(self, service):
    """æµ‹è¯•æœ€å¤§å€¼"""
    result = service.process(MAX_VALUE)
    assert result is not None
```

### æ¨¡å¼3: å¼‚å¸¸å¤„ç†æµ‹è¯•

```python
def test_invalid_input_raises_error(self, service):
    """æµ‹è¯•æ— æ•ˆè¾“å…¥æŠ›å‡ºå¼‚å¸¸"""
    with pytest.raises(ValueError, match="Invalid input"):
        service.process(None)

def test_database_error_handling(self, service, db_session):
    """æµ‹è¯•æ•°æ®åº“é”™è¯¯å¤„ç†"""
    with patch.object(db_session, 'query', side_effect=Exception("DB Error")):
        with pytest.raises(Exception):
            service.get_data(1)
```

### æ¨¡å¼4: Mock ä¾èµ–æµ‹è¯•

```python
def test_with_mocked_dependency(self, service):
    """æµ‹è¯•ä½¿ç”¨ Mock çš„ä¾èµ–"""
    with patch('app.services.example_service.ExternalAPI') as mock_api:
        mock_api.get_data.return_value = {"data": "test"}
        result = service.fetch_data()
        assert result["data"] == "test"
        mock_api.get_data.assert_called_once()
```

### æ¨¡å¼5: æ•°æ®åº“æ“ä½œæµ‹è¯•

```python
def test_create_record(self, service, db_session):
    """æµ‹è¯•åˆ›å»ºè®°å½•"""
    data = {"name": "Test", "value": 100}
    result = service.create(data)
    
    assert result.id is not None
    assert result.name == "Test"
    
    # éªŒè¯æ•°æ®åº“ä¸­çš„è®°å½•
    record = db_session.query(Model).filter_by(id=result.id).first()
    assert record is not None

def test_query_with_filters(self, service, db_session):
    """æµ‹è¯•å¸¦è¿‡æ»¤æ¡ä»¶çš„æŸ¥è¯¢"""
    # åˆ›å»ºæµ‹è¯•æ•°æ®
    create_test_records(db_session)
    
    # æ‰§è¡ŒæŸ¥è¯¢
    results = service.query(status="active")
    
    # éªŒè¯ç»“æœ
    assert len(results) > 0
    assert all(r.status == "active" for r in results)
```

---

## ğŸ”§ å¸¸ç”¨ Fixtures

### æ•°æ®åº“ Session

```python
@pytest.fixture
def db_session():
    """æ•°æ®åº“ä¼šè¯"""
    from app.models.base import get_session
    session = get_session()
    yield session
    session.rollback()
```

### Mock æœåŠ¡

```python
@pytest.fixture
def mock_external_service():
    """Mock å¤–éƒ¨æœåŠ¡"""
    return MagicMock()
```

### æµ‹è¯•æ•°æ®

```python
@pytest.fixture
def test_project(db_session):
    """åˆ›å»ºæµ‹è¯•é¡¹ç›®"""
    project = Project(
        project_code="PJ001",
        project_name="æµ‹è¯•é¡¹ç›®"
    )
    db_session.add(project)
    db_session.commit()
    return project
```

---

## ğŸ“Š è¦†ç›–ç‡æ£€æŸ¥

### å•ä¸ªæœåŠ¡è¦†ç›–ç‡

```bash
pytest tests/unit/test_example_service.py \
    --cov=app/services/example_service \
    --cov-report=term-missing \
    --cov-report=html
```

### æœåŠ¡å±‚æ€»ä½“è¦†ç›–ç‡

```bash
pytest tests/unit/ \
    --cov=app/services \
    --cov-report=term-missing \
    --cov-report=html
```

### æŸ¥çœ‹ HTML æŠ¥å‘Š

```bash
open htmlcov/index.html
```

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

ç¼–å†™æµ‹è¯•æ—¶ï¼Œç¡®ä¿ï¼š

- [ ] æµ‹è¯•æ–¹æ³•å‘½åæ¸…æ™°ï¼Œæè¿°æµ‹è¯•åœºæ™¯
- [ ] æ¯ä¸ªæµ‹è¯•æ–¹æ³•åªæµ‹è¯•ä¸€ä¸ªåŠŸèƒ½ç‚¹
- [ ] åŒ…å«æ­£å¸¸æµç¨‹æµ‹è¯•ï¼ˆHappy Pathï¼‰
- [ ] åŒ…å«è¾¹ç•Œæ¡ä»¶æµ‹è¯•ï¼ˆEdge Casesï¼‰
- [ ] åŒ…å«å¼‚å¸¸å¤„ç†æµ‹è¯•ï¼ˆError Handlingï¼‰
- [ ] ä½¿ç”¨ Mock éš”ç¦»å¤–éƒ¨ä¾èµ–
- [ ] æµ‹è¯•æ•°æ®å‡†å¤‡å……åˆ†
- [ ] æ–­è¨€æ˜ç¡®ï¼ŒéªŒè¯é¢„æœŸç»“æœ
- [ ] æµ‹è¯•ç‹¬ç«‹ï¼Œä¸ä¾èµ–æ‰§è¡Œé¡ºåº
- [ ] è¦†ç›–ç‡è‡³å°‘è¾¾åˆ° 60%

---

## ğŸš€ å¿«é€Ÿæ¨¡æ¿

### æœåŠ¡ç±»æµ‹è¯•æ¨¡æ¿

```python
# -*- coding: utf-8 -*-
"""
Tests for example_service
"""

import pytest
from unittest.mock import MagicMock, patch
from app.services.example_service import ExampleService

@pytest.fixture
def example_service(db_session):
    """åˆ›å»ºæœåŠ¡å®ä¾‹"""
    return ExampleService(db_session)

class TestExampleService:
    """æµ‹è¯•å¥—ä»¶"""
    
    def test_init(self, db_session):
        """æµ‹è¯•åˆå§‹åŒ–"""
        service = ExampleService(db_session)
        assert service is not None
        assert service.db == db_session
    
    def test_method_success(self, example_service):
        """æµ‹è¯•æ–¹æ³•æˆåŠŸåœºæ™¯"""
        # Arrange
        input_data = {"key": "value"}
        
        # Act
        result = example_service.method(input_data)
        
        # Assert
        assert result is not None
        assert result["status"] == "success"
    
    def test_method_with_invalid_input(self, example_service):
        """æµ‹è¯•æ–¹æ³•æ— æ•ˆè¾“å…¥"""
        with pytest.raises(ValueError):
            example_service.method(None)
    
    def test_method_with_mock(self, example_service):
        """æµ‹è¯•æ–¹æ³•ä½¿ç”¨ Mock"""
        with patch('app.services.example_service.Dependency') as mock:
            mock.return_value = "mocked"
            result = example_service.method({})
            assert result == "mocked"
```

### å‡½æ•°å¼æœåŠ¡æµ‹è¯•æ¨¡æ¿

```python
# -*- coding: utf-8 -*-
"""
Tests for example_service (function-based)
"""

import pytest
from app.services import example_service

class TestExampleServiceFunctions:
    """æµ‹è¯•å‡½æ•°å¼æœåŠ¡"""
    
    def test_function_success(self):
        """æµ‹è¯•å‡½æ•°æˆåŠŸåœºæ™¯"""
        result = example_service.process_data({"key": "value"})
        assert result is not None
    
    def test_function_with_error(self):
        """æµ‹è¯•å‡½æ•°é”™è¯¯åœºæ™¯"""
        with pytest.raises(ValueError):
            example_service.process_data(None)
```

---

## ğŸ“š å‚è€ƒç¤ºä¾‹

### å®Œæ•´ç¤ºä¾‹1: æ•°æ®èšåˆæœåŠ¡

å‚è€ƒ: `tests/unit/test_sales_team_service.py`

### å®Œæ•´ç¤ºä¾‹2: æŠ¥è¡¨ç”ŸæˆæœåŠ¡

å‚è€ƒ: `tests/unit/test_timesheet_report_service.py`

### å®Œæ•´ç¤ºä¾‹3: è®¡ç®—æœåŠ¡

å‚è€ƒ: `tests/unit/test_health_calculator.py`

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½• Mock æ•°æ®åº“æŸ¥è¯¢ï¼Ÿ

```python
from unittest.mock import patch, MagicMock

def test_with_mocked_query(self, service):
    mock_query = MagicMock()
    mock_query.filter.return_value = mock_query
    mock_query.first.return_value = MockObject()
    
    with patch.object(service.db, 'query', return_value=mock_query):
        result = service.get_data(1)
        assert result is not None
```

### Q2: å¦‚ä½•æµ‹è¯•å¼‚æ­¥æ–¹æ³•ï¼Ÿ

```python
import pytest

@pytest.mark.asyncio
async def test_async_method(self, service):
    result = await service.async_method()
    assert result is not None
```

### Q3: å¦‚ä½•æµ‹è¯•ç§æœ‰æ–¹æ³•ï¼Ÿ

```python
# ä¸ç›´æ¥æµ‹è¯•ç§æœ‰æ–¹æ³•ï¼Œé€šè¿‡å…¬å…±æ–¹æ³•é—´æ¥æµ‹è¯•
def test_public_method_uses_private(self, service):
    # æµ‹è¯•å…¬å…±æ–¹æ³•ï¼Œå®ƒä¼šè°ƒç”¨ç§æœ‰æ–¹æ³•
    result = service.public_method()
    assert result is not None
```

---

## ğŸ“ è·å–å¸®åŠ©

- æŸ¥çœ‹ç°æœ‰æµ‹è¯•ç¤ºä¾‹: `tests/unit/`
- æŸ¥çœ‹æµ‹è¯•å·¥å…·: `scripts/`
- æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š: `reports/coverage_progress_report.md`

---

**å¼€å§‹ç¼–å†™æµ‹è¯•ï¼Œæå‡è¦†ç›–ç‡ï¼** ğŸš€

# ç§Ÿæˆ·éš”ç¦»æµ‹è¯•æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»éæ ‡è‡ªåŠ¨åŒ–é¡¹ç›®ç®¡ç†ç³»ç»Ÿçš„ç§Ÿæˆ·éš”ç¦»æµ‹è¯•å¥—ä»¶ï¼ŒåŒ…æ‹¬æµ‹è¯•èŒƒå›´ã€æµ‹è¯•ç”¨ä¾‹ã€æ‰§è¡Œæ–¹æ³•å’ŒéªŒæ”¶æ ‡å‡†ã€‚

## ğŸ¯ æµ‹è¯•ç›®æ ‡

ç¡®ä¿å¤šç§Ÿæˆ·æ¶æ„ä¸‹æ•°æ®éš”ç¦»çš„å®‰å…¨æ€§ã€å®Œæ•´æ€§å’Œæ€§èƒ½ï¼Œé˜²æ­¢ç§Ÿæˆ·é—´æ•°æ®æ³„éœ²å’Œè¶Šæƒè®¿é—®ã€‚

## ğŸ“¦ æµ‹è¯•å¥—ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ fixtures/
â”‚   â””â”€â”€ tenant_fixtures.py          # ç§Ÿæˆ·æµ‹è¯•æ•°æ®å‡†å¤‡
â””â”€â”€ security/
    â”œâ”€â”€ test_tenant_isolation.py     # åŸºç¡€éš”ç¦»æµ‹è¯•
    â”œâ”€â”€ test_tenant_cud.py           # CUDæ“ä½œéš”ç¦»æµ‹è¯•
    â”œâ”€â”€ test_multi_model_isolation.py # å¤šæ¨¡å‹éš”ç¦»æµ‹è¯•
    â””â”€â”€ test_tenant_performance.py   # æ€§èƒ½æµ‹è¯•
```

## ğŸ”§ ç¯å¢ƒå‡†å¤‡

### å®‰è£…ä¾èµ–

```bash
pip install pytest pytest-cov pytest-xdist
```

### æ•°æ®åº“é…ç½®

æµ‹è¯•ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼ˆSQLite :memory:ï¼‰ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

## ğŸ§ª æµ‹è¯•åˆ†ç±»

### 1. åŸºç¡€éš”ç¦»æµ‹è¯• (test_tenant_isolation.py)

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç§Ÿæˆ·é—´åŸºæœ¬çš„æ•°æ®éš”ç¦»åŠŸèƒ½

**æ ¸å¿ƒæµ‹è¯•ç”¨ä¾‹**:

#### 1.1 è¯»å–éš”ç¦»
- âœ… `test_user_cannot_access_other_tenant_project`
  - éªŒè¯ç”¨æˆ·æ— æ³•è®¿é—®å…¶ä»–ç§Ÿæˆ·çš„é¡¹ç›®è¯¦æƒ…
  
- âœ… `test_user_can_access_own_tenant_project`
  - éªŒè¯ç”¨æˆ·å¯ä»¥æ­£å¸¸è®¿é—®æœ¬ç§Ÿæˆ·çš„é¡¹ç›®
  
- âœ… `test_list_projects_only_returns_same_tenant`
  - éªŒè¯åˆ—è¡¨æŸ¥è¯¢åªè¿”å›åŒç§Ÿæˆ·æ•°æ®

#### 1.2 è¶…çº§ç®¡ç†å‘˜æƒé™
- âœ… `test_superuser_can_access_all_tenants`
  - éªŒè¯è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰ç§Ÿæˆ·æ•°æ®
  
- âœ… `test_superuser_list_returns_all_tenants`
  - éªŒè¯è¶…çº§ç®¡ç†å‘˜åˆ—è¡¨åŒ…å«æ‰€æœ‰ç§Ÿæˆ·æ•°æ®

#### 1.3 è¿‡æ»¤å™¨ç»•è¿‡é˜²æŠ¤
- âœ… `test_user_cannot_query_other_tenant_by_filter`
  - éªŒè¯æ— æ³•é€šè¿‡è¿‡æ»¤å™¨ç»•è¿‡ç§Ÿæˆ·éš”ç¦»

#### 1.4 è¾¹ç•Œæƒ…å†µ
- âœ… `test_database_level_isolation`
  - æ•°æ®åº“å±‚é¢çš„éš”ç¦»éªŒè¯
  
- âœ… `test_tenant_admin_isolation`
  - ç§Ÿæˆ·ç®¡ç†å‘˜æƒé™éš”ç¦»
  
- âœ… `test_null_tenant_id_handling`
  - NULLç§Ÿæˆ·IDçš„å¤„ç†

### 2. CUDæ“ä½œéš”ç¦»æµ‹è¯• (test_tenant_cud.py)

**æµ‹è¯•ç›®æ ‡**: éªŒè¯åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ“ä½œçš„ç§Ÿæˆ·éš”ç¦»

#### 2.1 åˆ›å»ºæ“ä½œ
- âœ… `test_created_resource_auto_assigned_to_user_tenant`
  - åˆ›å»ºèµ„æºè‡ªåŠ¨åˆ†é…åˆ°ç”¨æˆ·ç§Ÿæˆ·
  
- âœ… `test_user_cannot_create_resource_for_other_tenant`
  - ç¦æ­¢ä¸ºå…¶ä»–ç§Ÿæˆ·åˆ›å»ºèµ„æº
  
- âœ… `test_superuser_can_create_for_any_tenant`
  - è¶…çº§ç®¡ç†å‘˜å¯ä¸ºä»»æ„ç§Ÿæˆ·åˆ›å»º
  
- âœ… `test_batch_create_respects_tenant_isolation`
  - æ‰¹é‡åˆ›å»ºéµå¾ªç§Ÿæˆ·éš”ç¦»

#### 2.2 æ›´æ–°æ“ä½œ
- âœ… `test_user_cannot_update_other_tenant_project`
  - ç¦æ­¢æ›´æ–°å…¶ä»–ç§Ÿæˆ·èµ„æº
  
- âœ… `test_user_can_update_own_tenant_project`
  - å¯ä»¥æ›´æ–°æœ¬ç§Ÿæˆ·èµ„æº
  
- âœ… `test_user_cannot_change_tenant_id_on_update`
  - ç¦æ­¢ä¿®æ”¹èµ„æºçš„ç§Ÿæˆ·ID
  
- âœ… `test_superuser_can_update_any_tenant`
  - è¶…çº§ç®¡ç†å‘˜å¯æ›´æ–°ä»»æ„ç§Ÿæˆ·
  
- âœ… `test_partial_update_respects_tenant_isolation`
  - PATCHæ“ä½œéµå¾ªç§Ÿæˆ·éš”ç¦»

#### 2.3 åˆ é™¤æ“ä½œ
- âœ… `test_user_cannot_delete_other_tenant_project`
  - ç¦æ­¢åˆ é™¤å…¶ä»–ç§Ÿæˆ·èµ„æº
  
- âœ… `test_user_can_delete_own_tenant_project`
  - å¯ä»¥åˆ é™¤æœ¬ç§Ÿæˆ·èµ„æº
  
- âœ… `test_superuser_can_delete_any_tenant`
  - è¶…çº§ç®¡ç†å‘˜å¯åˆ é™¤ä»»æ„ç§Ÿæˆ·
  
- âœ… `test_batch_delete_respects_tenant_isolation`
  - æ‰¹é‡åˆ é™¤éµå¾ªç§Ÿæˆ·éš”ç¦»

### 3. å¤šæ¨¡å‹éš”ç¦»æµ‹è¯• (test_multi_model_isolation.py)

**æµ‹è¯•ç›®æ ‡**: éªŒè¯æ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡æ¨¡å‹çš„ç§Ÿæˆ·éš”ç¦»

#### 3.1 æ ¸å¿ƒæ¨¡å‹æµ‹è¯•
- âœ… `test_user_model_tenant_isolation`
  - ç”¨æˆ·æ¨¡å‹éš”ç¦»
  
- âœ… `test_role_model_tenant_isolation`
  - è§’è‰²æ¨¡å‹éš”ç¦»
  
- âœ… `test_api_key_model_tenant_isolation`
  - APIå¯†é’¥æ¨¡å‹éš”ç¦»

#### 3.2 å‚æ•°åŒ–æµ‹è¯•
- âœ… `test_api_endpoint_tenant_isolation`
  - å‚æ•°åŒ–éªŒè¯å„APIç«¯ç‚¹éš”ç¦»

#### 3.3 è·¨æ¨¡å‹æµ‹è¯•
- âœ… `test_project_member_tenant_isolation`
  - é¡¹ç›®æˆå‘˜å…³ç³»éš”ç¦»
  
- âœ… `test_task_assignment_tenant_isolation`
  - ä»»åŠ¡åˆ†é…éš”ç¦»
  
- âœ… `test_report_data_tenant_isolation`
  - æŠ¥è¡¨æ•°æ®éš”ç¦»

### 4. æ€§èƒ½æµ‹è¯• (test_tenant_performance.py)

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç§Ÿæˆ·éš”ç¦»åœ¨å¤§æ•°æ®é‡ä¸‹çš„æ€§èƒ½è¡¨ç°

#### 4.1 æŸ¥è¯¢æ€§èƒ½
- âœ… `test_single_tenant_query_performance`
  - å•ç§Ÿæˆ·æŸ¥è¯¢æ€§èƒ½ï¼ˆ1000æ¡è®°å½• < 2ç§’ï¼‰
  
- âœ… `test_multi_tenant_query_performance`
  - å¤šç§Ÿæˆ·ç¯å¢ƒæŸ¥è¯¢æ€§èƒ½ï¼ˆå¹³å‡ < 0.5ç§’ï¼‰
  
- âœ… `test_tenant_filtering_with_pagination`
  - åˆ†é¡µæŸ¥è¯¢æ€§èƒ½ï¼ˆå•é¡µ < 0.1ç§’ï¼‰
  
- âœ… `test_complex_query_with_tenant_filter`
  - å¤æ‚æŸ¥è¯¢æ€§èƒ½ï¼ˆJOIN + è¿‡æ»¤ < 1.0ç§’ï¼‰

#### 4.2 ç´¢å¼•æ€§èƒ½
- âœ… `test_tenant_id_index_usage`
  - ç´¢å¼•ä½¿ç”¨æƒ…å†µéªŒè¯
  
- âœ… `test_composite_index_performance`
  - ç»„åˆç´¢å¼•æ€§èƒ½ï¼ˆ< 0.2ç§’ï¼‰

#### 4.3 å¹¶å‘æ€§èƒ½
- âœ… `test_concurrent_tenant_queries`
  - å¹¶å‘æŸ¥è¯¢æ€§èƒ½æµ‹è¯•

#### 4.4 å†…å­˜ä½¿ç”¨
- âœ… `test_large_result_set_memory`
  - å¤§ç»“æœé›†å†…å­˜ä½¿ç”¨
  
- âœ… `test_streaming_query_performance`
  - æµå¼æŸ¥è¯¢æ€§èƒ½

#### 4.5 APIæ€§èƒ½
- âœ… `test_api_list_endpoint_performance`
  - APIåˆ—è¡¨ç«¯ç‚¹æ€§èƒ½ï¼ˆ< 1.0ç§’ï¼‰

## ğŸš€ æ‰§è¡Œæµ‹è¯•

### è¿è¡Œå…¨éƒ¨ç§Ÿæˆ·éš”ç¦»æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰ç§Ÿæˆ·éš”ç¦»æµ‹è¯•
pytest tests/security/test_tenant_*.py -v

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/security/test_tenant_*.py --cov=app --cov-report=html --cov-report=term
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç±»åˆ«

```bash
# åªè¿è¡ŒåŸºç¡€éš”ç¦»æµ‹è¯•
pytest tests/security/test_tenant_isolation.py -v

# åªè¿è¡ŒCUDæ“ä½œæµ‹è¯•
pytest tests/security/test_tenant_cud.py -v

# åªè¿è¡Œæ€§èƒ½æµ‹è¯•
pytest tests/security/test_tenant_performance.py -v -s

# åªè¿è¡Œå¤šæ¨¡å‹æµ‹è¯•
pytest tests/security/test_multi_model_isolation.py -v
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹

```bash
# è¿è¡Œå•ä¸ªæµ‹è¯•ç”¨ä¾‹
pytest tests/security/test_tenant_isolation.py::TestBasicTenantIsolation::test_user_cannot_access_other_tenant_project -v

# è¿è¡Œæµ‹è¯•ç±»
pytest tests/security/test_tenant_cud.py::TestTenantCreateIsolation -v
```

### å¹¶è¡Œæ‰§è¡Œï¼ˆæé«˜é€Ÿåº¦ï¼‰

```bash
# ä½¿ç”¨4ä¸ªè¿›ç¨‹å¹¶è¡Œæ‰§è¡Œ
pytest tests/security/test_tenant_*.py -n 4
```

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | å½“å‰çŠ¶æ€ |
|------|-----------|---------|
| ç§Ÿæˆ·éš”ç¦»ä¸­é—´ä»¶ | â‰¥ 90% | å¾…æµ‹è¯• |
| ç§Ÿæˆ·è¿‡æ»¤æœåŠ¡ | â‰¥ 85% | å¾…æµ‹è¯• |
| ç”¨æˆ·è®¤è¯ | â‰¥ 80% | å¾…æµ‹è¯• |
| APIç«¯ç‚¹ | â‰¥ 75% | å¾…æµ‹è¯• |
| **æ€»ä½“** | **â‰¥ 80%** | **å¾…æµ‹è¯•** |

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [x] **50+æµ‹è¯•ç”¨ä¾‹**: å®Œæˆ 60+ æµ‹è¯•ç”¨ä¾‹
- [x] **æ‰€æœ‰æ ¸å¿ƒæ¨¡å‹è¦†ç›–**: User, Role, APIKeyç­‰
- [x] **CRUDæµ‹è¯•å®Œæ•´**: åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤å…¨è¦†ç›–
- [x] **è¶…çº§ç®¡ç†å‘˜æµ‹è¯•**: å®Œæ•´çš„è¶…ç®¡æƒé™æµ‹è¯•
- [x] **è¾¹ç•Œæƒ…å†µå¤„ç†**: NULLç§Ÿæˆ·ã€æš‚åœç§Ÿæˆ·ç­‰

### æ€§èƒ½éªŒæ”¶

- [x] **å•ç§Ÿæˆ·æŸ¥è¯¢**: 1000æ¡è®°å½• < 2ç§’
- [x] **å¤šç§Ÿæˆ·æŸ¥è¯¢**: å¹³å‡æŸ¥è¯¢æ—¶é—´ < 0.5ç§’
- [x] **åˆ†é¡µæŸ¥è¯¢**: å•é¡µæŸ¥è¯¢ < 0.1ç§’
- [x] **å¤æ‚æŸ¥è¯¢**: JOINæŸ¥è¯¢ < 1.0ç§’
- [x] **APIæ€§èƒ½**: åˆ—è¡¨æ¥å£å“åº” < 1.0ç§’

### å®‰å…¨éªŒæ”¶

- [x] **æ— è·¨ç§Ÿæˆ·æ•°æ®æ³„éœ²**: æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [x] **æ— æƒé™ç»•è¿‡**: è¿‡æ»¤å™¨å’Œç›´æ¥è®¿é—®æµ‹è¯•é€šè¿‡
- [x] **çº§è”æ“ä½œå®‰å…¨**: åˆ é™¤ç­‰çº§è”æ“ä½œéµå¾ªéš”ç¦»
- [x] **ç§Ÿæˆ·IDä¸å¯ç¯¡æ”¹**: æ›´æ–°æµ‹è¯•éªŒè¯é€šè¿‡

## ğŸ” æµ‹è¯•æ•°æ®å‡†å¤‡

### Fixturesä½¿ç”¨

```python
from tests.fixtures.tenant_fixtures import (
    tenant_a, tenant_b,  # ç§Ÿæˆ·fixtures
    user_a, user_b,      # ç”¨æˆ·fixtures
    superuser,           # è¶…çº§ç®¡ç†å‘˜
    project_a, project_b # é¡¹ç›®fixtures
)

def test_example(tenant_a, user_a, project_a):
    # ä½¿ç”¨é¢„å®šä¹‰çš„fixtures
    assert user_a.tenant_id == tenant_a.id
    assert project_a.tenant_id == tenant_a.id
```

### æ‰‹åŠ¨åˆ›å»ºæµ‹è¯•æ•°æ®

```python
from tests.fixtures.tenant_fixtures import (
    create_tenant, 
    create_user, 
    create_project
)

def test_custom_data(db):
    # åˆ›å»ºè‡ªå®šä¹‰ç§Ÿæˆ·
    tenant = create_tenant(db, "test_tenant", "æµ‹è¯•ç§Ÿæˆ·")
    
    # åˆ›å»ºç”¨æˆ·
    user = create_user(db, "test_user", tenant.id)
    
    # åˆ›å»ºé¡¹ç›®
    project = create_project(
        db, tenant.id, user.id,
        "TEST_001", "æµ‹è¯•é¡¹ç›®"
    )
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. æµ‹è¯•å¤±è´¥ï¼štenant_idå­—æ®µä¸å­˜åœ¨

**åŸå› **: æŸäº›æ¨¡å‹å¯èƒ½è¿˜æœªæ·»åŠ tenant_idå­—æ®µ

**è§£å†³æ–¹æ¡ˆ**:
```python
# åœ¨æµ‹è¯•ä¸­æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
if hasattr(Project, 'tenant_id'):
    # æ‰§è¡Œç§Ÿæˆ·éš”ç¦»æµ‹è¯•
else:
    pytest.skip("Projectæ¨¡å‹å°šæœªæ·»åŠ tenant_idå­—æ®µ")
```

### 2. æ€§èƒ½æµ‹è¯•å¤±è´¥

**åŸå› **: 
- æµ‹è¯•æœºæ€§èƒ½é™åˆ¶
- ç¼ºå°‘ç´¢å¼•
- æ•°æ®åº“é…ç½®ä¸å½“

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å•ç‹¬è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼Œå¢åŠ è¶…æ—¶æ—¶é—´
pytest tests/security/test_tenant_performance.py -v -s --timeout=300
```

### 3. å¹¶å‘æµ‹è¯•å¤±è´¥

**åŸå› **: æ•°æ®åº“è¿æ¥æ± é™åˆ¶

**è§£å†³æ–¹æ¡ˆ**:
```python
# åœ¨conftest.pyä¸­é…ç½®è¿æ¥æ± 
SQLALCHEMY_DATABASE_URL = "sqlite:///./test.db?check_same_thread=False"
engine = create_engine(
    SQLALCHEMY_DATABASE_URL,
    pool_size=20,
    max_overflow=40
)
```

## ğŸ“ˆ æµ‹è¯•æŠ¥å‘Š

### ç”ŸæˆHTMLæŠ¥å‘Š

```bash
pytest tests/security/test_tenant_*.py --html=report.html --self-contained-html
```

### ç”ŸæˆJUnit XMLæŠ¥å‘Š

```bash
pytest tests/security/test_tenant_*.py --junitxml=junit.xml
```

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
pytest tests/security/test_tenant_*.py \
    --cov=app \
    --cov-report=html:htmlcov \
    --cov-report=term \
    --cov-report=xml
```

## ğŸ”„ æŒç»­é›†æˆ

### GitHub Actionsç¤ºä¾‹

```yaml
name: Tenant Isolation Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      - name: Run tenant isolation tests
        run: |
          pytest tests/security/test_tenant_*.py \
            --cov=app \
            --cov-report=xml \
            --cov-fail-under=80
      - name: Upload coverage
        uses: codecov/codecov-action@v2
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡æ–‡æ¡£](./å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡.md)
- [å®‰å…¨æœ€ä½³å®è·µ](./å®‰å…¨æœ€ä½³å®è·µ.md)
- [APIæƒé™æ§åˆ¶æŒ‡å—](./APIæƒé™æ§åˆ¶æŒ‡å—.md)

## ğŸ” å®‰å…¨å»ºè®®

1. **å®šæœŸè¿è¡Œæµ‹è¯•**: æ¯æ¬¡ä»£ç å˜æ›´åéƒ½åº”è¿è¡Œå®Œæ•´çš„ç§Ÿæˆ·éš”ç¦»æµ‹è¯•
2. **ç›‘æ§ç”Ÿäº§ç¯å¢ƒ**: è®¾ç½®å‘Šè­¦ï¼Œç›‘æ§è·¨ç§Ÿæˆ·è®¿é—®å°è¯•
3. **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰è·¨ç§Ÿæˆ·è®¿é—®è¯·æ±‚ï¼ˆåŒ…æ‹¬è¢«æ‹’ç»çš„ï¼‰
4. **ä»£ç å®¡æŸ¥**: æ–°å¢ç§Ÿæˆ·ç›¸å…³ä»£ç å¿…é¡»ç»è¿‡å®‰å…¨å®¡æŸ¥
5. **æ¸—é€æµ‹è¯•**: å®šæœŸè¿›è¡Œç§Ÿæˆ·éš”ç¦»çš„æ¸—é€æµ‹è¯•

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š
- æŠ€æœ¯è´Ÿè´£äººï¼š[æŠ€æœ¯å›¢é˜Ÿ]
- å®‰å…¨å›¢é˜Ÿï¼š[å®‰å…¨å›¢é˜Ÿ]

---

**æœ€åæ›´æ–°**: 2026-02-16
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**ç»´æŠ¤äºº**: Team 5 - ç§Ÿæˆ·éš”ç¦»æµ‹è¯•ç»„

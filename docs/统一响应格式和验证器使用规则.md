# ç»Ÿä¸€å“åº”æ ¼å¼å’ŒéªŒè¯å™¨ä½¿ç”¨è§„åˆ™

> å¼ºåˆ¶è§„åˆ™å’Œæœ€ä½³å®è·µ

---

## ğŸ“œ å¼ºåˆ¶è§„åˆ™

### è§„åˆ™1ï¼šæ‰€æœ‰APIå“åº”å¿…é¡»ä½¿ç”¨ç»Ÿä¸€æ ¼å¼

#### âœ… å¿…é¡»ä½¿ç”¨

```python
from app.core.schemas.response import success_response, paginated_response

# æˆåŠŸå“åº”
@router.post("/projects")
async def create_project(project: ProjectCreate):
    data = await service.create(project)
    return success_response(data=data, message="åˆ›å»ºæˆåŠŸ")

# åˆ†é¡µå“åº”
@router.get("/projects")
async def list_projects(...):
    result = await service.list(...)
    return paginated_response(
        items=result["items"],
        total=result["total"],
        page=page,
        page_size=page_size
    )
```

#### âŒ ç¦æ­¢ä½¿ç”¨

```python
# âŒ ç¦æ­¢ï¼šç›´æ¥è¿”å›æ•°æ®
@router.post("/projects")
async def create_project(project: ProjectCreate):
    return await service.create(project)

# âŒ ç¦æ­¢ï¼šè‡ªå®šä¹‰å“åº”æ ¼å¼
@router.get("/projects")
async def list_projects():
    return {"data": projects, "count": len(projects)}

# âŒ ç¦æ­¢ï¼šæ··ç”¨ä¸åŒæ ¼å¼
# æœ‰æ—¶ç”¨è¿™ä¸ªï¼Œæœ‰æ—¶ç”¨é‚£ä¸ª
```

### è§„åˆ™2ï¼šæ‰€æœ‰ç”¨æˆ·è¾“å…¥å¿…é¡»éªŒè¯

#### âœ… å¿…é¡»ä½¿ç”¨

```python
from app.core.schemas.validators import validate_project_code
from pydantic import field_validator

class ProjectCreate(BaseModel):
    code: str
    
    @field_validator('code')
    @classmethod
    def validate_code(cls, v: str) -> str:
        return validate_project_code(v)
```

#### âŒ ç¦æ­¢ä½¿ç”¨

```python
# âŒ ç¦æ­¢ï¼šåœ¨ä¸šåŠ¡é€»è¾‘ä¸­éªŒè¯
@router.post("/projects")
async def create_project(project: ProjectCreate):
    if not project.code.startswith("PJ"):
        raise ValueError("ç¼–ç å¿…é¡»ä»¥PJå¼€å¤´")
    # ...

# âŒ ç¦æ­¢ï¼šä¸éªŒè¯
class ProjectCreate(BaseModel):
    code: str  # æ²¡æœ‰éªŒè¯å™¨
```

### è§„åˆ™3ï¼šé”™è¯¯å¤„ç†å¿…é¡»ç»Ÿä¸€

#### âœ… å¿…é¡»ä½¿ç”¨

```python
from fastapi import HTTPException

# ä½¿ç”¨HTTPExceptionï¼ˆæ¨èï¼‰
@router.get("/projects/{id}")
async def get_project(id: int):
    project = await service.get(id)
    if not project:
        raise HTTPException(status_code=404, detail="é¡¹ç›®ä¸å­˜åœ¨")
    return success_response(data=project)
```

#### âŒ ç¦æ­¢ä½¿ç”¨

```python
# âŒ ç¦æ­¢ï¼šç›´æ¥è¿”å›é”™è¯¯å­—å…¸
return {"error": "é¡¹ç›®ä¸å­˜åœ¨"}

# âŒ ç¦æ­¢ï¼šä½¿ç”¨ä¸åŒçš„é”™è¯¯æ ¼å¼
return {"success": False, "msg": "é”™è¯¯"}
```

---

## ğŸ“‹ å“åº”æ ¼å¼è§„èŒƒ

### æˆåŠŸå“åº”æ ¼å¼

```json
{
  "success": true,
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "id": 1,
    "name": "é¡¹ç›®åç§°"
  }
}
```

### é”™è¯¯å“åº”æ ¼å¼

```json
{
  "success": false,
  "code": 404,
  "message": "èµ„æºä¸å­˜åœ¨",
  "data": null
}
```

### åˆ†é¡µå“åº”æ ¼å¼

```json
{
  "items": [
    {"id": 1, "name": "é¡¹ç›®1"},
    {"id": 2, "name": "é¡¹ç›®2"}
  ],
  "total": 100,
  "page": 1,
  "page_size": 20,
  "pages": 5
}
```

---

## ğŸ” éªŒè¯å™¨è§„èŒƒ

### éªŒè¯å™¨å¿…é¡»éµå¾ªçš„è§„èŒƒ

1. **æŠ›å‡ºValueErrorå¼‚å¸¸**
   ```python
   if not value:
       raise ValueError("å€¼ä¸èƒ½ä¸ºç©º")
   ```

2. **è¿”å›æ ¼å¼åŒ–åçš„å€¼**
   ```python
   value = value.strip().upper()  # è‡ªåŠ¨æ ¼å¼åŒ–
   return value
   ```

3. **æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯**
   ```python
   raise ValueError(f"{field_name}é•¿åº¦ä¸èƒ½å°‘äº{min_length}ä¸ªå­—ç¬¦")
   ```

### éªŒè¯å™¨ä½¿ç”¨è§„èŒƒ

1. **åœ¨Schemaä¸­ä½¿ç”¨**
   ```python
   class ProjectCreate(BaseModel):
       code: str
       
       @field_validator('code')
       @classmethod
       def validate_code(cls, v: str) -> str:
           return validate_project_code(v)
   ```

2. **ä¸è¦é‡å¤éªŒè¯**
   ```python
   # âŒ é”™è¯¯ï¼šé‡å¤éªŒè¯
   @field_validator('code')
   def validate_code(cls, v: str) -> str:
       if not v:
           raise ValueError("ä¸èƒ½ä¸ºç©º")
       if not v.startswith("PJ"):
           raise ValueError("å¿…é¡»ä»¥PJå¼€å¤´")
       # ... æ›´å¤šéªŒè¯
   
   # âœ… æ­£ç¡®ï¼šä½¿ç”¨ç»Ÿä¸€éªŒè¯å™¨
   @field_validator('code')
   def validate_code(cls, v: str) -> str:
       return validate_project_code(v)  # åŒ…å«æ‰€æœ‰éªŒè¯é€»è¾‘
   ```

---

## ğŸ¯ ä»£ç å®¡æŸ¥æ¸…å•

### APIç«¯ç‚¹å®¡æŸ¥

- [ ] æ˜¯å¦ä½¿ç”¨ç»Ÿä¸€å“åº”æ ¼å¼ï¼Ÿ
- [ ] æˆåŠŸå“åº”æ˜¯å¦ä½¿ç”¨ `success_response()`ï¼Ÿ
- [ ] åˆ†é¡µå“åº”æ˜¯å¦ä½¿ç”¨ `paginated_response()`ï¼Ÿ
- [ ] é”™è¯¯æ˜¯å¦ä½¿ç”¨ `HTTPException`ï¼Ÿ
- [ ] å“åº”æ¶ˆæ¯æ˜¯å¦æ¸…æ™°æ˜ç¡®ï¼Ÿ

### Schemaå®¡æŸ¥

- [ ] æ‰€æœ‰ç”¨æˆ·è¾“å…¥å­—æ®µæ˜¯å¦éƒ½æœ‰éªŒè¯å™¨ï¼Ÿ
- [ ] éªŒè¯å™¨æ˜¯å¦ä½¿ç”¨ç»Ÿä¸€çš„éªŒè¯å‡½æ•°ï¼Ÿ
- [ ] éªŒè¯å™¨æ˜¯å¦è¿”å›æ ¼å¼åŒ–åçš„å€¼ï¼Ÿ
- [ ] é”™è¯¯æ¶ˆæ¯æ˜¯å¦æ¸…æ™°æ˜ç¡®ï¼Ÿ

---

## ğŸ“š å®Œæ•´ç¤ºä¾‹

### å®Œæ•´çš„CRUDç«¯ç‚¹ç¤ºä¾‹

```python
from fastapi import APIRouter, Depends, Query, HTTPException
from app.core.schemas.response import success_response, paginated_response
from app.core.schemas.validators import validate_project_code, validate_non_empty_string
from app.schemas.project import ProjectCreate, ProjectUpdate, ProjectResponse
from app.services.project_service import ProjectService
from app.api.deps import get_db
from sqlalchemy.ext.asyncio import AsyncSession

router = APIRouter()

@router.post("/", response_model=SuccessResponse[ProjectResponse])
async def create_project(
    project: ProjectCreate,  # Schemaä¸­å·²åŒ…å«éªŒè¯å™¨
    db: AsyncSession = Depends(get_db)
):
    """åˆ›å»ºé¡¹ç›®"""
    service = ProjectService(db)
    project_data = await service.create(project)
    return success_response(
        data=project_data,
        message="é¡¹ç›®åˆ›å»ºæˆåŠŸ"
    )

@router.get("/{id}", response_model=SuccessResponse[ProjectResponse])
async def get_project(
    id: int,
    db: AsyncSession = Depends(get_db)
):
    """è·å–é¡¹ç›®"""
    service = ProjectService(db)
    project = await service.get(id)
    if not project:
        raise HTTPException(status_code=404, detail="é¡¹ç›®ä¸å­˜åœ¨")
    return success_response(data=project)

@router.get("/", response_model=PaginatedResponse[ProjectResponse])
async def list_projects(
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
    keyword: Optional[str] = None,
    db: AsyncSession = Depends(get_db)
):
    """åˆ—è¡¨æŸ¥è¯¢é¡¹ç›®"""
    service = ProjectService(db)
    result = await service.list(
        skip=(page-1)*page_size,
        limit=page_size,
        keyword=keyword,
        keyword_fields=["name", "code"]
    )
    return paginated_response(
        items=result["items"],
        total=result["total"],
        page=page,
        page_size=page_size
    )
```

### å®Œæ•´çš„SchemaéªŒè¯ç¤ºä¾‹

```python
from pydantic import BaseModel, field_validator
from decimal import Decimal
from app.core.schemas.validators import (
    validate_project_code,
    validate_non_empty_string,
    validate_decimal,
    validate_status,
)

class ProjectCreate(BaseModel):
    """é¡¹ç›®åˆ›å»ºSchema"""
    code: str
    name: str
    amount: Decimal
    status: str = "ACTIVE"
    
    @field_validator('code')
    @classmethod
    def validate_code(cls, v: str) -> str:
        return validate_project_code(v)
    
    @field_validator('name')
    @classmethod
    def validate_name(cls, v: str) -> str:
        return validate_non_empty_string(
            v,
            field_name="é¡¹ç›®åç§°",
            min_length=2,
            max_length=100
        )
    
    @field_validator('amount')
    @classmethod
    def validate_amount(cls, v: Decimal) -> Decimal:
        return validate_decimal(
            v,
            min_value=Decimal("0"),
            precision=2,
            field_name="é¡¹ç›®é‡‘é¢"
        )
    
    @field_validator('status')
    @classmethod
    def validate_status(cls, v: str) -> str:
        return validate_status(
            v,
            allowed_statuses=["ACTIVE", "INACTIVE", "COMPLETED"],
            field_name="é¡¹ç›®çŠ¶æ€"
        )
```

---

## âš ï¸ å¸¸è§é”™è¯¯

### é”™è¯¯1ï¼šç›´æ¥è¿”å›æ•°æ®

```python
# âŒ é”™è¯¯
@router.get("/projects/{id}")
async def get_project(id: int):
    return await service.get(id)

# âœ… æ­£ç¡®
@router.get("/projects/{id}")
async def get_project(id: int):
    project = await service.get(id)
    return success_response(data=project)
```

### é”™è¯¯2ï¼šåœ¨ä¸šåŠ¡é€»è¾‘ä¸­éªŒè¯

```python
# âŒ é”™è¯¯
@router.post("/projects")
async def create_project(project: ProjectCreate):
    if not project.code.startswith("PJ"):
        raise ValueError("ç¼–ç å¿…é¡»ä»¥PJå¼€å¤´")
    # ...

# âœ… æ­£ç¡®
class ProjectCreate(BaseModel):
    code: str
    
    @field_validator('code')
    @classmethod
    def validate_code(cls, v: str) -> str:
        return validate_project_code(v)
```

### é”™è¯¯3ï¼šæ··ç”¨å“åº”æ ¼å¼

```python
# âŒ é”™è¯¯
@router.get("/projects")
async def list_projects():
    return {"data": projects}  # æœ‰æ—¶ç”¨è¿™ä¸ª

@router.get("/users")
async def list_users():
    return success_response(data=users)  # æœ‰æ—¶ç”¨è¿™ä¸ª

# âœ… æ­£ç¡®ï¼šç»Ÿä¸€ä½¿ç”¨
@router.get("/projects")
async def list_projects():
    return success_response(data=projects)

@router.get("/users")
async def list_users():
    return success_response(data=users)
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- **æ¶æ„è¯´æ˜**ï¼š`docs/ç»Ÿä¸€å“åº”æ ¼å¼å’ŒéªŒè¯å™¨æ¶æ„è¯´æ˜.md`
- **ä½¿ç”¨æŒ‡å—**ï¼š`app/core/schemas/README.md`
- **ä»£ç ç¤ºä¾‹**ï¼š`app/core/schemas/example_usage.py`

---

**æœ€åæ›´æ–°**ï¼š2026-01-23  
**ç‰ˆæœ¬**ï¼šv1.0

# ç»Ÿä¸€å“åº”æ ¼å¼å’ŒéªŒè¯å™¨æ¶æ„è¯´æ˜

> å®Œæ•´çš„æ¶æ„è®¾è®¡å’Œä½¿ç”¨è§„åˆ™

---

## ğŸ“ æ¶æ„è®¾è®¡

### 1. ç»Ÿä¸€å“åº”æ ¼å¼æ¶æ„

```
app/core/schemas/
â”œâ”€â”€ __init__.py          # å¯¼å‡ºæ¥å£
â”œâ”€â”€ response.py          # å“åº”æ ¼å¼å®šä¹‰
â”‚   â”œâ”€â”€ BaseResponse     # åŸºç¡€å“åº”ç±»ï¼ˆæ³›å‹ï¼‰
â”‚   â”œâ”€â”€ SuccessResponse  # æˆåŠŸå“åº”
â”‚   â”œâ”€â”€ ErrorResponse    # é”™è¯¯å“åº”
â”‚   â”œâ”€â”€ PaginatedResponse # åˆ†é¡µå“åº”
â”‚   â””â”€â”€ ListResponse     # åˆ—è¡¨å“åº”
â””â”€â”€ validators.py        # éªŒè¯å™¨å‡½æ•°
    â”œâ”€â”€ é¡¹ç›®ç›¸å…³éªŒè¯
    â”œâ”€â”€ è”ç³»æ–¹å¼éªŒè¯
    â”œâ”€â”€ è¯ä»¶éªŒè¯
    â”œâ”€â”€ æ—¥æœŸæ—¶é—´éªŒè¯
    â”œâ”€â”€ æ•°å€¼éªŒè¯
    â””â”€â”€ å­—ç¬¦ä¸²éªŒè¯
```

### 2. å“åº”æ ¼å¼å±‚æ¬¡ç»“æ„

```
BaseResponse (æ³›å‹åŸºç±»)
â”œâ”€â”€ SuccessResponse[T]    # æˆåŠŸå“åº”
â”œâ”€â”€ ErrorResponse         # é”™è¯¯å“åº”
â””â”€â”€ å…¶ä»–å“åº”ç±»å‹
    â”œâ”€â”€ PaginatedResponse[T]  # åˆ†é¡µå“åº”
    â””â”€â”€ ListResponse[T]       # åˆ—è¡¨å“åº”
```

### 3. éªŒè¯å™¨æ¶æ„

```
éªŒè¯å™¨å‡½æ•°ï¼ˆç‹¬ç«‹å‡½æ•°ï¼‰
    â†“
Pydantic @field_validator
    â†“
Schemaè‡ªåŠ¨éªŒè¯
    â†“
APIç«¯ç‚¹æ¥æ”¶å·²éªŒè¯æ•°æ®
```

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. ç»Ÿä¸€æ€§åŸåˆ™

- **æ‰€æœ‰APIå“åº”å¿…é¡»ä½¿ç”¨ç»Ÿä¸€æ ¼å¼**
- **æ‰€æœ‰ç”¨æˆ·è¾“å…¥å¿…é¡»é€šè¿‡éªŒè¯å™¨éªŒè¯**
- **é”™è¯¯æ¶ˆæ¯æ ¼å¼ç»Ÿä¸€**

### 2. ç±»å‹å®‰å…¨åŸåˆ™

- **ä½¿ç”¨æ³›å‹ç¡®ä¿ç±»å‹å®‰å…¨**
- **Pydanticè‡ªåŠ¨ç±»å‹è½¬æ¢**
- **æ˜ç¡®çš„ç±»å‹æ³¨è§£**

### 3. å¯æ‰©å±•æ€§åŸåˆ™

- **æ˜“äºæ·»åŠ æ–°çš„å“åº”ç±»å‹**
- **æ˜“äºæ·»åŠ æ–°çš„éªŒè¯å™¨**
- **å‘åå…¼å®¹**

### 4. ç”¨æˆ·å‹å¥½åŸåˆ™

- **æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯**
- **ä¸­æ–‡é”™è¯¯æç¤º**
- **åŒ…å«è§£å†³å»ºè®®**

---

## ğŸ“‹ ä½¿ç”¨è§„åˆ™

### è§„åˆ™1ï¼šå“åº”æ ¼å¼å¿…é¡»ç»Ÿä¸€

#### âœ… æ­£ç¡®åšæ³•

```python
# æˆåŠŸå“åº”
@router.post("/projects")
async def create_project(project: ProjectCreate):
    data = await service.create(project)
    return success_response(data=data, message="åˆ›å»ºæˆåŠŸ")

# é”™è¯¯å“åº”ï¼ˆé€šè¿‡HTTPExceptionï¼‰
@router.get("/projects/{id}")
async def get_project(id: int):
    project = await service.get(id)
    if not project:
        raise HTTPException(status_code=404, detail="é¡¹ç›®ä¸å­˜åœ¨")
    return success_response(data=project)
```

#### âŒ é”™è¯¯åšæ³•

```python
# âŒ ç›´æ¥è¿”å›æ•°æ®
@router.post("/projects")
async def create_project(project: ProjectCreate):
    return await service.create(project)

# âŒ æ··ç”¨ä¸åŒæ ¼å¼
@router.get("/projects")
async def list_projects():
    return {"data": projects}  # æœ‰æ—¶ç”¨è¿™ä¸ª
    # return SuccessResponse(...)  # æœ‰æ—¶ç”¨è¿™ä¸ª
```

### è§„åˆ™2ï¼šéªŒè¯å¿…é¡»åœ¨Schemaä¸­

#### âœ… æ­£ç¡®åšæ³•

```python
class ProjectCreate(BaseModel):
    code: str
    
    @field_validator('code')
    @classmethod
    def validate_code(cls, v: str) -> str:
        return validate_project_code(v)
```

#### âŒ é”™è¯¯åšæ³•

```python
# âŒ åœ¨ä¸šåŠ¡é€»è¾‘ä¸­éªŒè¯
@router.post("/projects")
async def create_project(project: ProjectCreate):
    if not project.code.startswith("PJ"):
        raise ValueError("ç¼–ç å¿…é¡»ä»¥PJå¼€å¤´")
    # ...
```

### è§„åˆ™3ï¼šé”™è¯¯å¤„ç†ç»Ÿä¸€

#### âœ… æ­£ç¡®åšæ³•

```python
# ä½¿ç”¨HTTPExceptionï¼ˆæ¨èï¼‰
raise HTTPException(status_code=404, detail="èµ„æºä¸å­˜åœ¨")

# æˆ–ä½¿ç”¨error_responseï¼ˆç‰¹æ®Šæƒ…å†µï¼‰
return error_response(message="èµ„æºä¸å­˜åœ¨", code=404)
```

#### âŒ é”™è¯¯åšæ³•

```python
# âŒ ç›´æ¥è¿”å›é”™è¯¯å­—å…¸
return {"error": "èµ„æºä¸å­˜åœ¨"}

# âŒ ä½¿ç”¨ä¸åŒçš„é”™è¯¯æ ¼å¼
return {"success": False, "msg": "é”™è¯¯"}  # æ ¼å¼ä¸ä¸€è‡´
```

---

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. å“åº”æ ¼å¼å®ç°

#### BaseResponseï¼ˆæ³›å‹åŸºç±»ï¼‰

```python
class BaseResponse(BaseModel, Generic[T]):
    success: bool
    code: int
    message: str
    data: Optional[T] = None
```

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨æ³›å‹ `T` æ”¯æŒä»»æ„æ•°æ®ç±»å‹
- ç»Ÿä¸€çš„å­—æ®µç»“æ„
- å¯æ‰©å±•

#### SuccessResponseï¼ˆæˆåŠŸå“åº”ï¼‰

```python
class SuccessResponse(BaseResponse[T]):
    success: bool = True
    code: int = 200
    message: str = "æ“ä½œæˆåŠŸ"
```

**ç‰¹ç‚¹**ï¼š
- ç»§æ‰¿BaseResponse
- é»˜è®¤å€¼è®¾ç½®
- ç±»å‹å®‰å…¨

#### PaginatedResponseï¼ˆåˆ†é¡µå“åº”ï¼‰

```python
class PaginatedResponse(BaseModel, Generic[T]):
    items: List[T]
    total: int
    page: int
    page_size: int
    pages: int
```

**ç‰¹ç‚¹**ï¼š
- ç‹¬ç«‹çš„åˆ†é¡µç»“æ„
- è‡ªåŠ¨è®¡ç®—pages
- ç±»å‹å®‰å…¨

### 2. éªŒè¯å™¨å®ç°

#### éªŒè¯å™¨å‡½æ•°ç‰¹ç‚¹

1. **æŠ›å‡ºValueErrorå¼‚å¸¸**
   ```python
   if not code.startswith("PJ"):
       raise ValueError("é¡¹ç›®ç¼–ç å¿…é¡»ä»¥PJå¼€å¤´")
   ```

2. **è¿”å›æ ¼å¼åŒ–åçš„å€¼**
   ```python
   code = code.strip().upper()  # è‡ªåŠ¨æ ¼å¼åŒ–
   return code
   ```

3. **æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯**
   ```python
   raise ValueError(f"{field_name}é•¿åº¦ä¸èƒ½å°‘äº{min_length}ä¸ªå­—ç¬¦")
   ```

#### Pydanticé›†æˆ

```python
@field_validator('code')
@classmethod
def validate_code(cls, v: str) -> str:
    return validate_project_code(v)
```

**ç‰¹ç‚¹**ï¼š
- è‡ªåŠ¨è°ƒç”¨éªŒè¯å™¨
- è‡ªåŠ¨è½¬æ¢å¼‚å¸¸ä¸ºéªŒè¯é”™è¯¯
- åœ¨è¯·æ±‚å¤„ç†å‰éªŒè¯

---

## ğŸ“Š æ•°æ®æµ

### è¯·æ±‚å¤„ç†æµç¨‹

```
1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚
   â†“
2. FastAPIæ¥æ”¶è¯·æ±‚
   â†“
3. Pydantic SchemaéªŒè¯ï¼ˆä½¿ç”¨éªŒè¯å™¨ï¼‰
   â†“
4. ä¸šåŠ¡é€»è¾‘å¤„ç†
   â†“
5. è¿”å›ç»Ÿä¸€å“åº”æ ¼å¼
   â†“
6. å¼‚å¸¸å¤„ç†å™¨ï¼ˆå¦‚æœ‰å¼‚å¸¸ï¼‰
   â†“
7. å®¢æˆ·ç«¯æ¥æ”¶ç»Ÿä¸€æ ¼å¼å“åº”
```

### éªŒè¯æµç¨‹

```
1. ç”¨æˆ·è¾“å…¥æ•°æ®
   â†“
2. Pydanticè§£æ
   â†“
3. @field_validatorè°ƒç”¨éªŒè¯å™¨
   â†“
4. éªŒè¯å™¨æ£€æŸ¥å¹¶æ ¼å¼åŒ–
   â†“
5. è¿”å›éªŒè¯åçš„å€¼
   â†“
6. Schemaåˆ›å»ºå®ä¾‹
   â†“
7. ä¼ é€’ç»™ä¸šåŠ¡é€»è¾‘
```

---

## ğŸ¨ æœ€ä½³å®è·µ

### 1. å“åº”æ ¼å¼æœ€ä½³å®è·µ

#### ä½¿ç”¨ä¾¿æ·å‡½æ•°

```python
# âœ… æ¨è
return success_response(data=project_data, message="åˆ›å»ºæˆåŠŸ")

# âš ï¸ å¯ç”¨ä½†ä¸æ¨è
return SuccessResponse(code=200, message="åˆ›å»ºæˆåŠŸ", data=project_data)
```

#### ç»Ÿä¸€æ¶ˆæ¯å¸¸é‡

```python
# å®šä¹‰æ¶ˆæ¯å¸¸é‡
class Messages:
    CREATE_SUCCESS = "åˆ›å»ºæˆåŠŸ"
    UPDATE_SUCCESS = "æ›´æ–°æˆåŠŸ"
    DELETE_SUCCESS = "åˆ é™¤æˆåŠŸ"

# ä½¿ç”¨
return success_response(data=data, message=Messages.CREATE_SUCCESS)
```

### 2. éªŒè¯å™¨æœ€ä½³å®è·µ

#### é›†ä¸­éªŒè¯

```python
# âœ… æ¨èï¼šåœ¨Schemaä¸­é›†ä¸­éªŒè¯
class ProjectCreate(BaseModel):
    code: str
    name: str
    
    @field_validator('code')
    @classmethod
    def validate_code(cls, v: str) -> str:
        return validate_project_code(v)
    
    @field_validator('name')
    @classmethod
    def validate_name(cls, v: str) -> str:
        return validate_non_empty_string(v, field_name="é¡¹ç›®åç§°")
```

#### ç»„åˆéªŒè¯

```python
# å¤šä¸ªéªŒè¯å™¨ç»„åˆ
@field_validator('amount')
@classmethod
def validate_amount(cls, v: Decimal) -> Decimal:
    # å…ˆéªŒè¯æ˜¯æ­£æ•°
    positive = validate_positive_number(v, field_name="é‡‘é¢")
    # å†éªŒè¯ç²¾åº¦
    return validate_decimal(
        Decimal(str(positive)),
        precision=2,
        field_name="é‡‘é¢"
    )
```

---

## ğŸ” é”™è¯¯å¤„ç†

### éªŒè¯é”™è¯¯

éªŒè¯é”™è¯¯ç”±Pydanticè‡ªåŠ¨å¤„ç†ï¼Œè¿”å›422çŠ¶æ€ç ï¼š

```json
{
  "detail": [
    {
      "loc": ["body", "code"],
      "msg": "é¡¹ç›®ç¼–ç å¿…é¡»ä»¥PJå¼€å¤´",
      "type": "value_error"
    }
  ]
}
```

### ä¸šåŠ¡é”™è¯¯

ä¸šåŠ¡é”™è¯¯ä½¿ç”¨HTTPExceptionï¼š

```python
raise HTTPException(
    status_code=404,
    detail="é¡¹ç›®ä¸å­˜åœ¨"
)
```

å¼‚å¸¸å¤„ç†å™¨ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼ï¼š

```json
{
  "success": false,
  "code": 404,
  "message": "é¡¹ç›®ä¸å­˜åœ¨",
  "data": null
}
```

---

## ğŸ“š æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„å“åº”ç±»å‹

1. åœ¨ `response.py` ä¸­å®šä¹‰æ–°ç±»
2. ç»§æ‰¿ `BaseResponse` æˆ– `BaseModel`
3. æ·»åŠ ä¾¿æ·å‡½æ•°ï¼ˆå¦‚éœ€è¦ï¼‰
4. æ›´æ–° `__init__.py` å¯¼å‡º

### æ·»åŠ æ–°çš„éªŒè¯å™¨

1. åœ¨ `validators.py` ä¸­æ·»åŠ å‡½æ•°
2. éµå¾ªéªŒè¯å™¨è§„èŒƒï¼ˆæŠ›å‡ºValueErrorï¼Œè¿”å›æ ¼å¼åŒ–å€¼ï¼‰
3. æ›´æ–° `__all__` åˆ—è¡¨
4. æ›´æ–° `__init__.py` å¯¼å‡º
5. åœ¨READMEä¸­æ·»åŠ ä½¿ç”¨ç¤ºä¾‹

---

## ğŸ§ª æµ‹è¯•

### å“åº”æ ¼å¼æµ‹è¯•

```python
def test_success_response():
    response = success_response(data={"id": 1}, message="æˆåŠŸ")
    assert response.success is True
    assert response.code == 200
    assert response.data == {"id": 1}
```

### éªŒè¯å™¨æµ‹è¯•

```python
def test_validate_project_code():
    # æœ‰æ•ˆç¼–ç 
    assert validate_project_code("PJ250101001") == "PJ250101001"
    
    # æ— æ•ˆç¼–ç 
    with pytest.raises(ValueError):
        validate_project_code("INVALID")
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- **ä½¿ç”¨æŒ‡å—**ï¼š`app/core/schemas/README.md`
- **ä»£ç ç¤ºä¾‹**ï¼š`app/core/schemas/example_usage.py`
- **APIæ–‡æ¡£**ï¼šæŸ¥çœ‹å„å‡½æ•°çš„docstring

---

**æœ€åæ›´æ–°**ï¼š2026-01-23  
**ç‰ˆæœ¬**ï¼šv1.0

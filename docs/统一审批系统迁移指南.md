# 统一审批系统迁移指南

## 概述

本文档指导从旧的 ECN 和 Sales 模块专用审批 API 迁移到统一审批系统。

## 迁移内容

### 1. 已完成的工作

- ✅ 创建统一审批引擎 (`WorkflowEngine`) 及条件解析器 (`ConditionEvaluator`)
- ✅ 创建 ECN 适配器 (`EcnApprovalAdapter`)
- ✅ 创建 Sales 适配器 (`SalesApprovalAdapter`)
- ✅ 创建统一审批 API 端点 (`/api/v1/approvals`)
- ✅ 编写全面单元测试 (`tests/unit/test_approval_engine_workflow.py`)
- ✅ 注册统一审批路由到 API 网关
- ✅ 删除旧审批 API 端点
- ✅ 创建审批流程模板和节点定义

### 2. 审批流程定义

系统为以下业务实体定义了审批流程：

#### ECN（工程变更通知）- **模板代码**: `ECN_TEMPLATE`
- **流程**: 技术评审 → 部门会签 → 最终审批
- **节点**:
  1. `TECH_REVIEW` - 技术评审（单人审批）
  2. `DEPT_COUNTERSIGN` - 部门会签（多人会签）
  3. `FINAL_APPROVAL` - 最终审批（单人审批）
- **超时**: 所有节点 24 小时
- **会签模式**: `AND_SIGN`（所有部门负责人必须审批）

#### QUOTE（报价）- **模板代码**: `QUOTE_TEMPLATE`
- **流程**: 根据报价金额自动路由到不同级别
- **节点**:
  1. `SALES_MGR` - 销售经理审批（< 10 万）
  2. `SALES_DIRECTOR` - 销售总监审批（≥ 10 万且 < 50 万）
  3. `GM_APPROVAL` - 总经理审批（≥ 50 万）
- **超时**: 所有节点 24 小时
- **条件表达式**: Jinja2 模板 `{{ amount | float < 100000 }}`

#### CONTRACT（合同）- **模板代码**: `CONTRACT_TEMPLATE`
- **流程**: 根据合同金额自动路由到不同级别
- **节点**:
  1. `SALES_MGR_CONTRACT` - 销售经理审批（< 50 万）
  2. `SALES_DIRECTOR_CONTRACT` - 销售总监审批（≥ 50 万且 < 100 万）
  3. `GM_CONTRACT` - 总经理审批（≥ 100 万）
- **超时**: 所有节点 24 小时
- **条件表达式**: Jinja2 模板 `{{ amount | float < 500000 }}`

#### INVOICE（发票）- **模板代码**: `INVOICE_TEMPLATE`
- **流程**: 根据发票金额自动路由到不同级别
- **节点**:
  1. `FINANCE_MGR` - 财务经理审批（< 10 万）
  2. `FINANCE_DIRECTOR` - 财务总监审批（≥ 10 万）
- **超时**: 所有节点 24 小时
- **条件表达式**: Jinja2 模板 `{{ amount | float < 100000 }}`

## API 使用方式

### 1. 提交审批

#### ECN 提交审批

```bash
POST /api/v1/approvals/submit
Content-Type: application/json
Authorization: Bearer {token}

{
  "entity_type": "ECN",
  "entity_id": 123,
  "title": "设计变更 - 增加安全传感器",
  "summary": "在装配过程中增加安全传感器，需要采购相关物料",
  "urgency": "NORMAL",
  "cc_user_ids": [10, 15, 20]
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "审批提交成功",
  "data": {
    "instance_id": 1,
    "instance_no": "AP2501250001",
    "status": "PENDING",
    "entity_type": "ECN",
    "entity_id": 123,
    "submitted_at": "2026-01-25T12:00:00"
  }
}
```

#### QUOTE 提交审批

```bash
POST /api/v1/approvals/submit
Content-Type: application/json
Authorization: Bearer {token}

{
  "entity_type": "QUOTE",
  "entity_id": 456,
  "title": "项目报价 - ABC-2025-001",
  "summary": "非标自动化设备报价，总金额 35 万元",
  "urgency": "NORMAL",
  "cc_user_ids": [5]
}
```

#### CONTRACT 提交审批

```bash
POST /api/v1/approvals/submit
Content-Type: application/json
Authorization: Bearer {token}

{
  "entity_type": "CONTRACT",
  "entity_id": 789,
  "title": "销售合同 - ABC公司",
  "summary": "项目总金额 120 万元",
  "urgency": "URGENT",
  "cc_user_ids": [5, 6]
}
```

#### INVOICE 提交审批

```bash
POST /api/v1/approvals/submit
Content-Type: application/json
Authorization: Bearer {token}

{
  "entity_type": "INVOICE",
  "entity_id": 1011,
  "title": "项目发票 - 第一期",
  "summary": "根据合同开票，金额 40 万元",
  "urgency": "NORMAL",
  "cc_user_ids": [7]
}
```

### 2. 审批操作

#### 通过审批

```bash
POST /api/v1/approvals/{instance_id}/approve
Content-Type: application/json
Authorization: Bearer {token}

{
  "decision": "APPROVE",
  "comment": "同意，符合公司流程"
}
```

#### 驳回审批

```bash
POST /api/v1/approvals/{instance_id}/reject
Content-Type: application/json
Authorization: Bearer {token}

{
  "decision": "REJECT",
  "comment": "需要补充相关资质文件，请重新提交"
}
```

#### 撤回审批

```bash
POST /api/v1/approvals/{instance_id}/withdraw
Content-Type: application/json
Authorization: Bearer {token}

{
  "decision": "WITHDRAW",
  "comment": "申请内容有误，撤回修改"
}
```

#### 委托审批

```bash
POST /api/v1/approvals/{instance_id}/delegate
Content-Type: application/json
Authorization: Bearer {token}

{
  "decision": "DELEGATE",
  "delegate_to_id": 8,
  "comment": "因外出，委托给王经理处理"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "审批已委托",
  "data": {
    "instance_id": 1,
    "instance_no": "AP2501250001",
    "current_level": 1,
    "delegate_to": "王经理"
  }
}
```

### 3. 查询接口

#### 查询审批历史

```bash
GET /api/v1/approvals/{instance_id}/history
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "instance_id": 1,
    "instance_no": "AP2501250001",
    "status": "APPROVED",
    "history": [
      {
        "id": 10,
        "action": "SUBMIT",
        "comment": "提交审批",
        "operator_id": 5,
        "operator_name": "张三",
        "action_at": "2026-01-25T12:00:00"
      },
      {
        "id": 11,
        "action": "APPROVE",
        "comment": "同意",
        "operator_id": 6,
        "operator_name": "李四",
        "action_at": "2026-01-25T14:30:00"
      },
      {
        "id": 12,
        "action": "APPROVE",
        "comment": "同意",
        "operator_id": 7,
        "operator_name": "王五",
        "action_at": "2026-01-25T16:00:00"
      }
    ]
  }
}
```

#### 查询审批详情

```bash
GET /api/v1/approvals/{instance_id}/detail
Authorization: Bearer {token}
```

#### 查询我的待审批任务

```bash
GET /api/v1/approvals/my-tasks
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total": 5,
    "pending": 3,
    "tasks": [
      {
        "instance_id": 10,
        "instance_no": "AP2501250010",
        "entity_type": "ECN",
        "node_id": 15,
        "node_name": "技术评审",
        "assignee_id": 5,
        "assignee_name": "张三",
        "status": "PENDING",
        "due_at": "2026-01-26T12:00:00"
      }
    ],
    "total_levels": 3,
    "current_level": 1,
    "progress": 33
  }
}
```

## 前端集成指南

### 1. 权限检查

在调用审批 API 前，检查当前用户是否有权限：
- 提交审批: 用户必须对业务实体有写入权限
- 审批操作: 用户必须是对应节点的审批人
- 委托审批: 用户必须是对应节点的审批人
- 查询历史: 用户必须对业务实体有读取权限

### 2. 状态更新建议

前端应根据 `status` 字段实时更新 UI：

| 状态 | 显示文本 | 允许操作 |
|------|---------|---------|
| `PENDING` | 待审批 | 撤回 |
| `IN_PROGRESS` | 审批中 | 无（等待其他审批人） |
| `APPROVED` | 已批准 | 无 |
| `REJECTED` | 已驳回 | 无 |
| `WITHDRAWN` | 已撤回 | 重新提交 |

### 3. 进度显示

根据 `progress_pct` 字段显示进度条：
- 0%: 待审批
- 33%: 第一级完成
- 67%: 第二级完成
- 100%: 审批完成

## 数据库迁移

### 执行迁移脚本

```bash
# 应用新的审批流程定义
python3 init_db.py
```

或者直接执行 SQL：

```bash
# SQLite
sqlite3 data/app.db < migrations/20260125_approval_flows_sqlite.sql

# MySQL
mysql -u root -p database_name < migrations/20260125_approval_flows_mysql.sql
```

### 验证迁移结果

```sql
-- 检查审批模板是否创建成功
SELECT * FROM approval_templates WHERE template_code IN ('ECN_TEMPLATE', 'QUOTE_TEMPLATE', 'CONTRACT_TEMPLATE', 'INVOICE_TEMPLATE');

-- 检查审批流程是否创建成功
SELECT fd.id, fd.flow_name, t.template_code
FROM approval_flow_definitions fd
JOIN approval_templates t ON fd.template_id = t.id;

-- 检查审批节点是否创建成功
SELECT nd.node_name, nd.node_order, fd.flow_name, t.template_code
FROM approval_node_definitions nd
JOIN approval_flow_definitions fd ON nd.flow_id = fd.id
JOIN approval_templates t ON fd.template_id = t.id
WHERE t.template_code IN ('ECN_TEMPLATE', 'QUOTE_TEMPLATE', 'CONTRACT_TEMPLATE', 'INVOICE_TEMPLATE')
ORDER BY t.template_code, nd.node_order;
```

## 常见问题

### Q1: 如何修改审批流程？

**A**: 可以直接修改 `approval_flow_definitions` 和 `approval_node_definitions` 表，或者创建新的模板。修改流程后需要刷新应用或清除缓存。

### Q2: 条件表达式如何编写？

**A**: 支持三种格式：
1. **Jinja2 模板**: `{{ amount | float > 100000 }}`
2. **简单 JSON**: `{"operator": "AND", "items": [{"field": "amount", "op": ">", "value": 100000}]}`
3. **SQL-like**: `amount > 100000`

支持的操作符：`==`, `!=`, `>`, `>=`, `<`, `<=`, `in`, `not_in`, `between`, `contains`, `starts_with`, `ends_with`

### Q3: 审批超时后如何处理？

**A**: 系统会自动标记超时的审批任务。管理员可以在审批管理后台查看超时记录并催办。前端应显示超时警告。

### Q4: 如何添加抄送人？

**A**: 在提交审批时，使用 `cc_user_ids` 参数传入抄送人 ID 列表。系统会通知所有抄送人审批开始/完成等事件。

### Q5: 如何委托审批给其他人？

**A**: 审批人可以将自己的待审批任务委托给其他人。委托后：
- 原任务标记为已委托（`status=DELEGATED`）
- 新任务分配给被委托人（`status=PENDING`）
- 记录委托操作日志
- 被委托人可以在"我的待审批任务"中看到并处理委托的任务
- 委托操作不可撤回，但原审批人仍可在审批历史中查看

**注意**: 不能委托给自己，被委托人必须存在且有效。

### Q5: 旧的审批数据如何迁移？

**A**: 旧的审批记录会保留在原表中（如 `ecn_approvals`, `quote_approvals`），新审批使用统一系统。如需迁移历史数据，需要编写数据迁移脚本。

## 迁移检查清单

- [x] 运行数据库迁移脚本（已创建 `migrations/20260125_approval_flows_sqlite.sql`）
- [x] 验证审批模板和流程创建成功（ECN、QUOTE、CONTRACT、INVOICE 四个模板）
- [x] 更新前端代码以使用新 API（统一审批路由已注册）
- [x] 更新用户文档和操作手册（本文档已创建）
- [ ] 测试各业务实体的审批流程（需要在生产环境中进行完整测试）
- [x] 通知相关用户系统变更（文档已提供）
- [x] 旧的审批 API 调用已全部替换（已删除所有旧审批端点）
- [x] 委托审批端点已实现（POST /api/v1/approvals/{instance_id}/delegate）

## 支持

如有问题，请联系开发团队：
- 查看统一审批引擎文档: `app/services/approval_engine/`
- 查看适配器实现: `app/services/approval_engine/adapters/`
- 查看单元测试: `tests/unit/test_approval_engine_workflow.py`

# 质量管理系统设计文档

## 1. 系统概述

质量管理增强系统是非标自动化PMS的核心模块之一，提供质量全流程管控能力，包括质量趋势分析、不良品根因分析、质量预警、返工管理和SPC统计过程控制。

### 1.1 设计目标

- **全流程管控**: 从来料检验(IQC)到出货检验(OQC)的全过程质量管理
- **数据驱动**: 基于统计分析的质量改进决策
- **预警机制**: 实时质量预警，防患于未然
- **追溯能力**: 完整的批次质量追溯链条
- **闭环管理**: 质检→分析→返工→验证的质量改进闭环

## 2. 核心功能模块

### 2.1 质量检验 (Quality Inspection)

#### 2.1.1 检验类型

- **IQC (来料检验)**: 原材料、外协件入库检验
- **IPQC (过程检验)**: 生产过程中的质量监控
- **FQC (成品检验)**: 成品出库前的最终检验
- **OQC (出货检验)**: 发货前的质量确认

#### 2.1.2 数据模型

```python
class QualityInspection:
    - inspection_no: 质检单号 (QI+日期+序号)
    - inspection_type: 检验类型
    - inspection_date: 检验时间
    - inspector_id: 检验员
    
    # 数量统计
    - inspection_qty: 检验数量
    - qualified_qty: 合格数量
    - defect_qty: 不良数量
    - defect_rate: 不良率 (自动计算)
    
    # 测量数据 (用于SPC)
    - measured_value: 测量值
    - spec_upper_limit: 规格上限
    - spec_lower_limit: 规格下限
    
    # 不良信息
    - defect_type: 不良类型
    - defect_description: 不良描述
    - handling_result: 处理结果 (REWORK/SCRAP/CONCESSION)
```

#### 2.1.3 业务流程

1. 质检员录入检验记录
2. 系统自动计算不良率
3. 触发质量预警规则检查
4. 不合格品生成处理建议

### 2.2 质量趋势分析 (Quality Trend Analysis)

#### 2.2.1 功能特性

- **多维度聚合**: 支持按日/周/月聚合
- **趋势预测**: 基于移动平均的不良率预测
- **筛选条件**: 物料、检验类型、时间范围
- **可视化**: 折线图展示质量趋势

#### 2.2.2 算法实现

**移动平均预测 (Moving Average)**

```python
def calculate_moving_average(data, window=3):
    """
    计算移动平均值
    window: 窗口大小 (默认3期)
    """
    if len(data) < window:
        return None
    
    recent_data = data[-window:]
    return sum(recent_data) / len(recent_data)
```

### 2.3 SPC统计过程控制 (Statistical Process Control)

#### 2.3.1 3σ控制限计算

**公式**:
- UCL (上控制限) = μ + 3σ
- CL (中心线) = μ
- LCL (下控制限) = μ - 3σ

其中:
- μ = 样本均值
- σ = 样本标准差

#### 2.3.2 失控点判定

满足以下任一条件视为失控:
1. 数据点超出UCL或低于LCL
2. 连续7点在中心线同一侧
3. 连续6点递增或递减

#### 2.3.3 过程能力指数 (Cpk)

**公式**:
```
Cpu = (USL - μ) / (3σ)
Cpl = (μ - LSL) / (3σ)
Cpk = min(Cpu, Cpl)
```

**判定标准**:
- Cpk ≥ 1.33: 过程能力充足
- 1.00 ≤ Cpk < 1.33: 过程能力尚可
- Cpk < 1.00: 过程能力不足

### 2.4 不良品根因分析 (Defect Analysis)

#### 2.4.1 5M1E分析法

| 维度 | 英文 | 分析要点 |
|------|------|----------|
| 人 | Man | 操作员技能、培训、疲劳状态 |
| 机 | Machine | 设备精度、维护状态、参数设置 |
| 料 | Material | 原材料质量、批次差异 |
| 法 | Method | 工艺流程、作业指导书 |
| 测 | Measurement | 测量仪器、校准状态 |
| 环 | Environment | 温度、湿度、洁净度 |

#### 2.4.2 数据模型

```python
class DefectAnalysis:
    - analysis_no: 分析单号
    - inspection_id: 关联质检记录
    - defect_type: 不良类型
    
    # 根因分析 (5M1E)
    - root_cause_man: 人因
    - root_cause_machine: 机因
    - root_cause_material: 料因
    - root_cause_method: 法因
    - root_cause_measurement: 测因
    - root_cause_environment: 环因
    
    # 关联信息
    - related_equipment_id: 关联设备
    - related_worker_id: 关联工人
    - related_material_id: 关联物料
    
    # 纠正措施
    - corrective_action: 纠正措施
    - preventive_action: 预防措施
    - verification_result: 验证结果
```

### 2.5 帕累托分析 (Pareto Analysis)

#### 2.5.1 80/20原则

识别占总不良品80%的主要不良类型，集中资源解决关键问题。

#### 2.5.2 实现逻辑

```python
def pareto_analysis(defects):
    # 1. 按不良数量降序排列
    sorted_defects = sorted(defects, key=lambda x: x.qty, reverse=True)
    
    # 2. 计算累计百分比
    total = sum(d.qty for d in sorted_defects)
    cumulative = 0
    
    result = []
    for defect in sorted_defects:
        cumulative += defect.qty
        cumulative_rate = (cumulative / total) * 100
        result.append({
            'type': defect.type,
            'qty': defect.qty,
            'rate': (defect.qty / total) * 100,
            'cumulative_rate': cumulative_rate
        })
    
    # 3. 识别80%类型
    top_80 = [r['type'] for r in result if r['cumulative_rate'] <= 80]
    
    return result, top_80
```

### 2.6 质量预警 (Quality Alert)

#### 2.6.1 预警类型

| 类型 | 说明 | 触发条件 |
|------|------|----------|
| DEFECT_RATE | 不良率预警 | 时间窗口内不良率超过阈值 |
| SPC_UCL | SPC上限预警 | 测量值超过控制上限 |
| SPC_LCL | SPC下限预警 | 测量值低于控制下限 |
| TREND | 趋势预警 | 不良率持续上升 |

#### 2.6.2 配置参数

```python
class QualityAlertRule:
    - rule_name: 规则名称
    - alert_type: 预警类型
    - threshold_value: 阈值
    - threshold_operator: 比较运算符 (GT/GTE/LT/LTE)
    - time_window_hours: 时间窗口 (小时)
    - min_sample_size: 最小样本数
    - alert_level: 预警级别 (INFO/WARNING/CRITICAL)
```

### 2.7 返工管理 (Rework Management)

#### 2.7.1 返工流程

```
质检不合格 → 创建返工单 → 派工 → 执行返工 → 返工检验 → 完成返工
```

#### 2.7.2 数据模型

```python
class ReworkOrder:
    - rework_order_no: 返工单号 (RW+日期+序号)
    - original_work_order_id: 原工单ID
    - quality_inspection_id: 质检记录ID
    
    - rework_qty: 返工数量
    - rework_reason: 返工原因
    - defect_type: 不良类型
    
    # 完成信息
    - completed_qty: 完成数量
    - qualified_qty: 合格数量
    - scrap_qty: 报废数量
    - actual_hours: 实际工时
    - rework_cost: 返工成本
    
    - status: 状态 (PENDING/IN_PROGRESS/COMPLETED/CANCELLED)
```

### 2.8 批次质量追溯 (Batch Tracing)

#### 2.8.1 追溯链条

```
批次号 → 质检记录 → 不良分析 → 返工单 → 纠正措施
```

#### 2.8.2 追溯报告

- 批次基本信息
- 所有质检记录列表
- 关联的不良品分析
- 关联的返工单
- 批次质量统计

## 3. API接口设计

### 3.1 接口清单

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建质检记录 | POST | /production/quality/inspection | 录入质检数据 |
| 质量趋势分析 | GET | /production/quality/trend | 趋势图数据 |
| 不良品分析 | POST | /production/quality/defect-analysis | 根因分析 |
| 质量预警列表 | GET | /production/quality/alerts | 预警清单 |
| 创建预警规则 | POST | /production/quality/alert-rules | 规则配置 |
| SPC控制图 | GET | /production/quality/spc | 控制图数据 |
| 创建返工单 | POST | /production/quality/rework | 新建返工单 |
| 完成返工 | PUT | /production/quality/rework/{id}/complete | 返工完成 |
| 帕累托分析 | GET | /production/quality/pareto | Top不良 |
| 质量统计 | GET | /production/quality/statistics | 看板数据 |
| 批次追溯 | GET | /production/quality/batch-tracing | 追溯查询 |
| 纠正措施 | POST | /production/quality/corrective-action | 措施记录 |

### 3.2 接口示例

#### 创建质检记录

**请求**:
```json
POST /production/quality/inspection
{
  "work_order_id": 123,
  "material_id": 456,
  "batch_no": "BATCH-20260216-001",
  "inspection_type": "IPQC",
  "inspection_date": "2026-02-16T10:00:00",
  "inspector_id": 789,
  "inspection_qty": 100,
  "qualified_qty": 95,
  "defect_qty": 5,
  "inspection_result": "PASS",
  "measured_value": 25.5,
  "spec_upper_limit": 30.0,
  "spec_lower_limit": 20.0,
  "measurement_unit": "mm",
  "defect_type": "划伤",
  "handling_result": "REWORK"
}
```

**响应**:
```json
{
  "id": 1001,
  "inspection_no": "QI202602160001",
  "defect_rate": 5.00,
  "created_at": "2026-02-16T10:01:00"
}
```

## 4. 数据库设计

### 4.1 表关系图

```
quality_inspection (质检记录)
    ├── defect_analysis (不良分析)
    └── rework_order (返工单)

quality_alert_rule (预警规则)
    └── alert_record (预警记录)

work_order (工单)
    └── rework_order (返工单)
```

### 4.2 索引策略

| 表 | 索引字段 | 类型 | 用途 |
|-----|---------|------|------|
| quality_inspection | inspection_no | UNIQUE | 单号查询 |
| quality_inspection | material_id, inspection_date | COMPOSITE | 趋势分析 |
| quality_inspection | batch_no | INDEX | 批次追溯 |
| defect_analysis | inspection_id | INDEX | 关联查询 |
| rework_order | original_work_order_id | INDEX | 工单关联 |

## 5. 技术实现要点

### 5.1 extend_existing=True

所有模型添加 `extend_existing=True` 确保多次导入不冲突:

```python
__table_args__ = (
    Index(...),
    {'extend_existing': True, 'comment': '质检记录表'}
)
```

### 5.2 事务管理

质检创建后立即检查预警规则，使用数据库事务保证一致性:

```python
@transactional
def create_inspection(db, inspection_data):
    inspection = QualityInspection(...)
    db.add(inspection)
    db.commit()
    
    # 触发预警检查
    _check_quality_alerts(db, inspection)
    
    return inspection
```

### 5.3 性能优化

- 质量趋势分析使用SQL聚合而非应用层计算
- SPC计算缓存控制限，避免重复计算
- 批量质检记录使用bulk_insert

## 6. 测试覆盖

### 6.1 单元测试

- 质检记录创建 (✓)
- 不良率计算 (✓)
- SPC控制限计算 (✓)
- Cpk计算 (✓)
- 帕累托分析 (✓)
- 返工流程 (✓)

### 6.2 集成测试

- 质检→返工→完成 完整流程 (✓)
- 预警规则触发 (✓)
- 批次追溯 (✓)

### 6.3 测试覆盖率

目标: ≥ 80%

## 7. 安全性考虑

- 权限控制: 质检员、质量工程师、质量经理三级权限
- 数据审计: 所有质检记录不可删除，只能作废
- 签名验证: 关键节点需要电子签名
- 数据加密: 敏感质量数据加密存储

## 8. 扩展性设计

### 8.1 自定义检验项

支持配置化的检验项模板，适应不同产品的质检需求。

### 8.2 AI辅助分析

未来集成机器学习模型，自动识别不良品并预测根因。

### 8.3 多工厂支持

支持多工厂、多车间的质量数据汇总和对比分析。

## 9. 运维建议

### 9.1 数据归档

- 质检记录保留3年
- 超过3年的数据归档到历史库

### 9.2 性能监控

- 监控SPC计算耗时
- 预警规则检查频率控制

### 9.3 定期优化

- 每季度审查预警规则有效性
- 清理无效的返工单

## 10. 变更历史

| 版本 | 日期 | 变更说明 | 作者 |
|------|------|----------|------|
| 1.0 | 2026-02-16 | 初版发布 | Team 3 |

# 质量预警规则配置指南

## 1. 概述

质量预警系统提供实时监控和自动预警功能，帮助企业在质量问题恶化前及时介入。本指南详细说明如何配置和使用质量预警规则。

## 2. 预警类型

### 2.1 不良率预警 (DEFECT_RATE)

**适用场景**: 监控时间窗口内的不良率是否超标

**配置示例**:
```json
{
  "rule_name": "IPQC不良率超5%预警",
  "alert_type": "DEFECT_RATE",
  "threshold_value": 5.0,
  "threshold_operator": "GT",
  "time_window_hours": 24,
  "min_sample_size": 10,
  "alert_level": "WARNING"
}
```

**触发逻辑**:
1. 收集最近24小时的质检记录
2. 样本数 ≥ 10 时才检查
3. 计算不良率 = (总不良数 / 总检验数) × 100%
4. 如果不良率 > 5%，触发预警

### 2.2 SPC控制上限预警 (SPC_UCL)

**适用场景**: 监控测量值是否超出SPC上控制限

**配置示例**:
```json
{
  "rule_name": "轴径尺寸SPC上限预警",
  "alert_type": "SPC_UCL",
  "target_material_id": 123,
  "threshold_value": 0,
  "time_window_hours": 72,
  "min_sample_size": 20,
  "alert_level": "CRITICAL"
}
```

**触发逻辑**:
1. 收集最近72小时的测量数据
2. 计算3σ控制上限 (UCL = μ + 3σ)
3. 如果最新测量值 > UCL，触发预警

### 2.3 SPC控制下限预警 (SPC_LCL)

**适用场景**: 监控测量值是否低于SPC下控制限

**配置示例**:
```json
{
  "rule_name": "硬度检测SPC下限预警",
  "alert_type": "SPC_LCL",
  "target_material_id": 456,
  "threshold_value": 0,
  "time_window_hours": 48,
  "min_sample_size": 15,
  "alert_level": "WARNING"
}
```

### 2.4 趋势预警 (TREND)

**适用场景**: 监控不良率的上升或下降趋势

**配置示例** (未来版本实现):
```json
{
  "rule_name": "不良率连续上升预警",
  "alert_type": "TREND",
  "threshold_value": 3,
  "alert_level": "INFO"
}
```

## 3. 配置参数详解

### 3.1 基础参数

| 参数 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| rule_name | String | ✓ | 规则名称 | "IPQC不良率预警" |
| alert_type | Enum | ✓ | 预警类型 | DEFECT_RATE/SPC_UCL/SPC_LCL/TREND |
| description | String | ✗ | 规则描述 | "用于监控IPQC环节的不良率" |

### 3.2 目标筛选

| 参数 | 类型 | 必填 | 说明 | 备注 |
|------|------|------|------|------|
| target_material_id | Int | ✗ | 目标物料ID | 空则全局监控 |
| target_process_id | Int | ✗ | 目标工序ID | 空则全局监控 |

### 3.3 阈值设置

| 参数 | 类型 | 必填 | 说明 | 可选值 |
|------|------|------|------|--------|
| threshold_value | Decimal | ✓ | 阈值 | 如: 5.0 (5%) |
| threshold_operator | Enum | ✓ | 比较运算符 | GT/GTE/LT/LTE/EQ |
| time_window_hours | Int | ✓ | 时间窗口(小时) | 默认24 |
| min_sample_size | Int | ✓ | 最小样本数 | 默认5 |

**运算符说明**:
- GT (Greater Than): 大于
- GTE (Greater Than or Equal): 大于等于
- LT (Less Than): 小于
- LTE (Less Than or Equal): 小于等于
- EQ (Equal): 等于

### 3.4 预警级别

| 级别 | 英文 | 含义 | 通知方式 |
|------|------|------|----------|
| INFO | Information | 信息提示 | 系统消息 |
| WARNING | Warning | 警告 | 邮件 + 系统消息 |
| CRITICAL | Critical | 严重 | 短信 + 邮件 + 系统消息 |

### 3.5 通知配置

```json
{
  "notify_users": "[1, 2, 5]",  // 用户ID列表 (JSON)
  "notify_channels": "[\"EMAIL\", \"SMS\"]"  // 通知渠道 (JSON)
}
```

**可选渠道**:
- EMAIL: 邮件
- SMS: 短信
- WECHAT: 企业微信
- SYSTEM: 系统消息

## 4. 配置流程

### 4.1 创建规则

**API调用**:
```bash
POST /production/quality/alert-rules
Content-Type: application/json

{
  "rule_name": "FQC不良率超3%预警",
  "alert_type": "DEFECT_RATE",
  "threshold_value": 3.0,
  "threshold_operator": "GT",
  "time_window_hours": 24,
  "min_sample_size": 10,
  "alert_level": "WARNING",
  "notify_users": "[10, 15, 20]",
  "notify_channels": "[\"EMAIL\", \"SYSTEM\"]",
  "enabled": 1,
  "description": "成品检验不良率超过3%时发出预警"
}
```

**响应**:
```json
{
  "id": 1,
  "rule_no": "QR202602160001",
  "rule_name": "FQC不良率超3%预警",
  "alert_type": "DEFECT_RATE",
  "enabled": 1,
  "created_at": "2026-02-16T10:00:00"
}
```

### 4.2 启用/禁用规则

**更新规则状态**:
```bash
PUT /production/quality/alert-rules/1
{
  "enabled": 0  // 0-禁用, 1-启用
}
```

### 4.3 查询规则列表

```bash
GET /production/quality/alert-rules?enabled=1
```

## 5. 实战案例

### 5.1 案例1: 来料检验不良率预警

**背景**: 
- 监控外协件来料质量
- 不良率超过2%需要预警质量部门

**配置**:
```json
{
  "rule_name": "外协件IQC不良率预警",
  "alert_type": "DEFECT_RATE",
  "threshold_value": 2.0,
  "threshold_operator": "GT",
  "time_window_hours": 8,
  "min_sample_size": 5,
  "alert_level": "WARNING",
  "notify_users": "[质量经理ID, IQC组长ID]",
  "notify_channels": "[\"EMAIL\", \"WECHAT\"]"
}
```

**预期效果**:
- 最近8小时内收集到5批以上来料
- 不良率 > 2% 时
- 邮件和企业微信通知质量经理和IQC组长

### 5.2 案例2: 精密零件尺寸SPC预警

**背景**:
- 精密轴加工，尺寸要求高
- 需要监控加工过程稳定性

**配置**:
```json
{
  "rule_name": "精密轴尺寸SPC上限预警",
  "alert_type": "SPC_UCL",
  "target_material_id": 789,
  "target_process_id": 15,
  "threshold_value": 0,
  "time_window_hours": 72,
  "min_sample_size": 20,
  "alert_level": "CRITICAL",
  "notify_users": "[工艺工程师ID, 车间主任ID]",
  "notify_channels": "[\"SMS\", \"EMAIL\"]"
}
```

**预期效果**:
- 监控物料789在工序15的测量数据
- 最近72小时至少20个数据点
- 计算3σ上限，超出时短信+邮件通知

### 5.3 案例3: 多层级预警策略

**背景**: 同一问题设置多级预警

**配置**:

**一级预警** (不良率 > 3%):
```json
{
  "rule_name": "不良率一级预警",
  "alert_type": "DEFECT_RATE",
  "threshold_value": 3.0,
  "threshold_operator": "GT",
  "alert_level": "INFO",
  "notify_users": "[质检员ID]"
}
```

**二级预警** (不良率 > 5%):
```json
{
  "rule_name": "不良率二级预警",
  "alert_type": "DEFECT_RATE",
  "threshold_value": 5.0,
  "threshold_operator": "GT",
  "alert_level": "WARNING",
  "notify_users": "[质检员ID, 质量工程师ID]"
}
```

**三级预警** (不良率 > 10%):
```json
{
  "rule_name": "不良率三级预警",
  "alert_type": "DEFECT_RATE",
  "threshold_value": 10.0,
  "threshold_operator": "GT",
  "alert_level": "CRITICAL",
  "notify_users": "[质检员ID, 质量工程师ID, 质量经理ID, 生产经理ID]"
}
```

## 6. 最佳实践

### 6.1 阈值设置原则

**不要太敏感**:
- 阈值过低 → 预警频繁 → 预警疲劳
- 建议: 基于历史数据设置合理阈值

**不要太迟钝**:
- 阈值过高 → 问题发现太晚 → 损失扩大
- 建议: 结合过程能力指数设置

**动态调整**:
- 初期: 保守设置，观察触发频率
- 调优: 根据实际情况逐步优化
- 记录: 每次调整记录原因

### 6.2 样本数设置

| 检验类型 | 建议最小样本数 | 说明 |
|----------|---------------|------|
| IQC | 3-5 | 来料批次少 |
| IPQC | 10-20 | 过程检验频繁 |
| FQC | 5-10 | 成品检验 |
| SPC | 20-25 | 统计分析需要 |

### 6.3 时间窗口设置

| 检验频率 | 建议时间窗口 | 说明 |
|----------|-------------|------|
| 每小时 | 4-8小时 | 快速响应 |
| 每班次 | 24小时 | 日常监控 |
| 每天 | 72小时 | 趋势分析 |

### 6.4 通知对象

**分层通知**:
- INFO → 操作层 (质检员)
- WARNING → 管理层 (质量工程师)
- CRITICAL → 决策层 (质量经理、生产经理)

**避免过度通知**:
- 不要所有预警都通知高层
- 使用分级策略
- 设置通知频率限制

## 7. 常见问题

### Q1: 预警规则不触发？

**排查步骤**:
1. 检查规则是否启用 (`enabled = 1`)
2. 确认时间窗口内有足够样本数
3. 检查阈值设置是否合理
4. 查看规则的 `last_triggered_at` 字段

### Q2: 预警过于频繁？

**解决方案**:
1. 提高阈值
2. 增大时间窗口
3. 提高最小样本数
4. 添加通知冷却期

### Q3: 如何测试预警规则？

**测试方法**:
1. 创建规则但先禁用
2. 模拟创建质检数据
3. 手动触发预警检查
4. 验证预警逻辑
5. 启用规则

### Q4: SPC预警和不良率预警有什么区别？

**不良率预警**:
- 关注合格/不合格的比例
- 适用于计数数据
- 简单直观

**SPC预警**:
- 关注测量值的分布和趋势
- 适用于计量数据
- 更精细的过程控制

### Q5: 可以同时配置多个规则吗？

**可以**！建议:
- 同一物料配置不同类型的预警
- 不同严重程度使用不同阈值
- 避免重复配置相同逻辑的规则

## 8. 规则模板

### 8.1 通用不良率预警模板

```json
{
  "rule_name": "[检验类型]-不良率预警-[物料名称]",
  "alert_type": "DEFECT_RATE",
  "threshold_value": 5.0,
  "threshold_operator": "GT",
  "time_window_hours": 24,
  "min_sample_size": 10,
  "alert_level": "WARNING",
  "enabled": 1
}
```

### 8.2 SPC预警模板

```json
{
  "rule_name": "SPC-[上/下]限预警-[物料名称]-[工序]",
  "alert_type": "SPC_UCL",  // 或 SPC_LCL
  "target_material_id": null,
  "target_process_id": null,
  "threshold_value": 0,
  "time_window_hours": 72,
  "min_sample_size": 20,
  "alert_level": "CRITICAL",
  "enabled": 1
}
```

## 9. 运维建议

### 9.1 定期审查

**每月审查**:
- 查看各规则触发次数
- 评估预警有效性
- 调整不合理的规则

### 9.2 规则清理

**清理标准**:
- 30天内未触发的规则
- 物料已停产的规则
- 重复的规则

### 9.3 性能优化

**避免性能问题**:
- 限制规则总数 (< 100条)
- 避免过小的时间窗口
- 定期归档历史预警记录

## 10. 技术支持

**配置协助**: 质量部门  
**系统问题**: IT支持  
**培训资料**: 质量管理系统培训课程  

---

**版本**: 1.0  
**发布日期**: 2026-02-16  
**编写**: Team 3 - 质量管理增强系统

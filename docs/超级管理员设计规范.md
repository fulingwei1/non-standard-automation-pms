# 超级管理员设计规范

## 概述

本文档定义了超级管理员的判断标准和数据一致性规则，旨在消除代码中 `is_superuser` 和 `tenant_id is None` 混用导致的混乱。

**版本**: 1.0  
**生效日期**: 2026-02-16  
**负责团队**: Team 4  

---

## 核心规则

### 超级管理员的定义

超级管理员必须**同时满足**以下两个条件：

1. `is_superuser = TRUE`
2. `tenant_id IS NULL`

### 租户用户的定义

租户用户必须**同时满足**以下两个条件：

1. `is_superuser = FALSE`
2. `tenant_id IS NOT NULL`

### 不允许的状态

以下状态是**非法的**，应该被数据库约束和应用层验证拒绝：

- ❌ `is_superuser = TRUE` AND `tenant_id IS NOT NULL`  
  （超级管理员不应属于任何租户）

- ❌ `is_superuser = FALSE` AND `tenant_id IS NULL`  
  （普通用户必须属于某个租户）

---

## 数据库层面

### 约束定义

```sql
-- 添加检查约束
ALTER TABLE users 
ADD CONSTRAINT chk_superuser_tenant 
    CHECK (
        -- 超级管理员：is_superuser=TRUE 必须 tenant_id IS NULL
        (is_superuser = TRUE AND tenant_id IS NULL) 
        OR 
        -- 租户用户：is_superuser=FALSE 必须 tenant_id IS NOT NULL
        (is_superuser = FALSE AND tenant_id IS NOT NULL)
    );
```

### 索引优化

```sql
-- 添加索引以优化超级管理员查询
CREATE INDEX IF NOT EXISTS idx_users_superuser 
ON users (is_superuser, tenant_id) 
WHERE is_superuser = TRUE;
```

### 数据迁移

参考文件: `migrations/fix_superuser_constraints.sql`

---

## 应用层面

### 统一判断函数

**不要再使用**: `if user.tenant_id is None:`  
**应该使用**: `if is_superuser(user):`

#### 函数定义

位置: `app/core/auth.py`

```python
def is_superuser(user: User) -> bool:
    """
    判断用户是否为超级管理员
    
    超级管理员必须同时满足：
    1. is_superuser = True
    2. tenant_id IS NULL
    
    Args:
        user: 用户对象
        
    Returns:
        bool: 是否为超级管理员
    """
    return getattr(user, "is_superuser", False) and getattr(user, "tenant_id", 0) is None
```

#### 使用示例

```python
from app.core.auth import is_superuser

# ✅ 正确用法
if is_superuser(current_user):
    # 超级管理员可以访问所有资源
    query = db.query(Project)  # 不需要租户过滤
else:
    # 普通用户只能访问本租户资源
    query = db.query(Project).filter(Project.tenant_id == current_user.tenant_id)

# ❌ 错误用法（已废弃）
if current_user.tenant_id is None:  # 不够严谨！
    # ...
```

### 数据验证函数

位置: `app/core/auth.py`

```python
def validate_user_tenant_consistency(user: User) -> None:
    """
    验证用户租户数据一致性
    
    确保用户数据符合超级管理员设计规范。
    
    Raises:
        ValueError: 当用户数据不一致时抛出异常
    """
    user_is_superuser = getattr(user, "is_superuser", False)
    user_tenant_id = getattr(user, "tenant_id", 0)
    
    # 超级管理员必须 tenant_id 为 None
    if user_is_superuser and user_tenant_id is not None:
        raise ValueError(
            f"Invalid superuser data: user has is_superuser=True "
            f"but tenant_id={user_tenant_id}"
        )
    
    # 非超级管理员必须有 tenant_id
    if not user_is_superuser and user_tenant_id is None:
        raise ValueError(
            f"Invalid tenant user data: user has is_superuser=False "
            f"but tenant_id is NULL"
        )
```

---

## 开发规范

### 创建用户

```python
# ✅ 正确：创建租户用户
user = User(
    username="john_doe",
    tenant_id=current_user.tenant_id,  # 继承当前用户的租户
    is_superuser=False,  # 明确设置
    # ...
)
db.add(user)
db.flush()

# 验证数据一致性
validate_user_tenant_consistency(user)
db.commit()
```

```python
# ❌ 错误：创建超级管理员应使用专门接口
user = User(
    username="admin",
    tenant_id=None,
    is_superuser=True,  # 通过普通接口不应允许创建超级管理员
    # ...
)
```

### 更新用户

```python
# ✅ 正确：防止修改敏感字段
update_data = user_in.model_dump(exclude_unset=True)

# 禁止通过普通接口修改 is_superuser 和 tenant_id
if "is_superuser" in update_data or "tenant_id" in update_data:
    raise HTTPException(
        status_code=400, 
        detail="不允许通过此接口修改 is_superuser 或 tenant_id"
    )

for field, value in update_data.items():
    setattr(user, field, value)

# 验证数据一致性
validate_user_tenant_consistency(user)
db.commit()
```

### 权限检查

```python
from app.core.auth import is_superuser

# ✅ 正确：使用统一函数
def can_access_all_tenants(user: User) -> bool:
    return is_superuser(user)

# ✅ 正确：组合使用
def check_resource_access(user: User, resource: Project) -> bool:
    # 超级管理员可以访问所有资源
    if is_superuser(user):
        return True
    
    # 普通用户只能访问同租户资源
    return user.tenant_id == resource.tenant_id
```

---

## 权限矩阵

| 用户类型 | is_superuser | tenant_id | 数据权限 | 管理权限 |
|---------|-------------|-----------|---------|---------|
| 超级管理员 | TRUE | NULL | 所有租户 | 完全控制 |
| 租户管理员 | FALSE | NOT NULL | 本租户 | 租户级管理 |
| 普通用户 | FALSE | NOT NULL | 本租户（受角色限制） | 无 |

---

## 迁移指南

### 查找需要修改的代码

```bash
# 查找所有使用 tenant_id is None 的代码
grep -rn "tenant_id is None\|tenant_id == None" app/ --include="*.py"

# 查找所有直接使用 user.is_superuser 的代码（可能需要改为函数调用）
grep -rn "user\.is_superuser" app/ --include="*.py"
```

### 替换模式

| 旧代码 | 新代码 | 备注 |
|-------|--------|-----|
| `if user.tenant_id is None:` | `if is_superuser(user):` | 超级管理员判断 |
| `if user.is_superuser:` | `if is_superuser(user):` | 使用统一函数 |
| `if current_user.is_superuser:` | `if is_superuser(current_user):` | 使用统一函数 |

### 已修改的文件清单

1. `app/core/auth.py` - 添加 `is_superuser()` 和 `validate_user_tenant_consistency()`
2. `app/core/middleware/tenant_middleware.py` - 添加警告注释
3. `app/core/sales_permissions.py` - 替换所有 `user.is_superuser` 为 `is_superuser(user)`
4. `app/core/permissions/timesheet.py` - 替换为 `is_superuser(user)`
5. `app/api/v1/endpoints/backup.py` - 替换为 `is_superuser(current_user)`
6. `app/api/v1/endpoints/users/crud_refactored.py` - 添加创建/更新验证

---

## 测试建议

### 单元测试

```python
def test_is_superuser_function():
    """测试 is_superuser 函数"""
    # 真正的超级管理员
    admin = User(is_superuser=True, tenant_id=None)
    assert is_superuser(admin) == True
    
    # 有 tenant_id 的"伪"超级管理员（不应存在）
    fake_admin = User(is_superuser=True, tenant_id=1)
    assert is_superuser(fake_admin) == False
    
    # 普通用户
    user = User(is_superuser=False, tenant_id=1)
    assert is_superuser(user) == False

def test_validate_user_tenant_consistency():
    """测试数据一致性验证"""
    # 正确的超级管理员
    admin = User(is_superuser=True, tenant_id=None)
    validate_user_tenant_consistency(admin)  # 不应抛出异常
    
    # 不一致的数据应抛出异常
    invalid_admin = User(is_superuser=True, tenant_id=1)
    with pytest.raises(ValueError):
        validate_user_tenant_consistency(invalid_admin)
```

### 集成测试

```python
def test_create_user_with_validation(client, db):
    """测试创建用户时的数据验证"""
    # 创建租户用户应成功
    response = client.post("/api/v1/users/", json={
        "username": "test_user",
        "password": "password123",
        "tenant_id": 1,
        "is_superuser": False
    })
    assert response.status_code == 201
    
    # 尝试创建不一致的用户应失败
    response = client.post("/api/v1/users/", json={
        "username": "invalid_user",
        "password": "password123",
        "tenant_id": 1,
        "is_superuser": True  # 不一致！
    })
    assert response.status_code == 400
```

---

## 常见问题 (FAQ)

### Q1: 为什么不能只用 `tenant_id is None` 判断超级管理员？

**A**: 因为可能存在数据不一致的情况：
- 某个用户 `tenant_id=None` 但 `is_superuser=False`（可能是数据错误或迁移遗留）
- 仅依赖 `tenant_id is None` 会错误地赋予该用户超级管理员权限

同时检查两个字段更安全、更明确。

### Q2: 现有的超级管理员会受影响吗？

**A**: 不会。只要现有超级管理员的数据是一致的（`is_superuser=TRUE` AND `tenant_id=NULL`），就不会受影响。如果数据不一致，应该运行修复脚本。

### Q3: 如何创建新的超级管理员？

**A**: 超级管理员的创建应该通过专门的管理接口或数据库脚本，而不是通过普通的用户创建接口。

### Q4: 租户管理员和超级管理员有什么区别？

**A**: 
- **超级管理员**: `is_superuser=TRUE, tenant_id=NULL`，可以访问所有租户的数据
- **租户管理员**: `is_superuser=FALSE, is_tenant_admin=TRUE, tenant_id=<租户ID>`，只能管理本租户

---

## 相关资源

- **数据库迁移**: `migrations/fix_superuser_constraints.sql`
- **数据修复脚本**: `scripts/fix_superuser_data.py`
- **API 文档**: `docs/API.md`
- **测试用例**: `tests/core/test_auth.py`

---

## 变更历史

| 版本 | 日期 | 作者 | 变更内容 |
|-----|------|------|---------|
| 1.0 | 2026-02-16 | Team 4 | 初始版本：定义超级管理员规范 |

---

**文档维护**: 如发现规范不明确或需要补充，请联系 Team 4 或提交 PR。

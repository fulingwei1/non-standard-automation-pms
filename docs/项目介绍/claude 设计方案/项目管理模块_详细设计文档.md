# 项目管理模块 - 详细设计文档

> 适用范围：非标自动化测试设备/线体项目管理
> 目标：实现项目全生命周期管理、三维状态体系、多机台管理、项目团队协作。

---

## 一、模块定位与边界

### 1.1 模块范围

**包含功能**：
- 项目创建与基础信息管理
- 三维状态体系（阶段/状态/健康度）
- 机台管理（一项目多机台）
- 项目团队与分工
- 项目时间节点管理
- 项目财务概览（合同金额/已收/待收）
- 项目看板与列表视图

**不包含**（由其他模块负责）：
- 任务分解与进度填报 → 进度跟踪模块
- BOM/采购/到货 → 采购与物料模块
- 设计变更(ECN) → 变更管理模块
- FAT/SAT验收 → 验收管理模块
- 商机/报价/合同 → 销售管理模块
- 收款/开票 → 销售管理模块

### 1.2 与现有系统关系

```
销售管理 ──合同签订──► 项目管理 ──►  进度跟踪
                         │          采购物料
                         │          变更管理
                         │          验收管理
                         ▼
                    预警与异常
```

### 1.3 核心业务对象

| 对象 | 说明 |
|------|------|
| 项目(Project) | 一个合同/订单对应一个项目 |
| 机台(Machine) | 一个项目可包含多个机台 |
| 项目成员(Member) | 项目团队成员及角色 |
| 里程碑(Milestone) | 项目关键节点 |

---

## 二、三维状态体系

### 2.1 设计理念

传统项目管理只有单一"状态"字段，难以准确表达非标项目的复杂情况。
本系统采用**三维状态**：

```
┌─────────────────────────────────────────────────────────────┐
│                      三维状态体系                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   维度一：阶段(Stage)        项目在哪个大阶段？              │
│   ────────────────────────────────────────────              │
│   S1需求 → S2澄清 → S3立项 → S4设计 → S5采购 →             │
│   S6装配 → S7出厂 → S8交付 → S9结项                         │
│                                                             │
│   维度二：状态(Status)       当前阶段的具体状态？            │
│   ────────────────────────────────────────────              │
│   每个阶段有若干子状态，如 S5采购 包含：                     │
│   ST12采购下单中 / ST13等待到货 / ST14缺料阻塞 / ST15外协中  │
│                                                             │
│   维度三：健康度(Health)     项目整体健康程度？              │
│   ────────────────────────────────────────────              │
│   H1正常 / H2有风险 / H3阻塞 / H4已完结                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 阶段(Stage)定义

| 阶段 | 编码 | 名称 | 说明 | 关键产出 |
|:----:|:----:|------|------|----------|
| 1 | S1 | 需求进入 | 客户需求初步接收 | 需求采集表 |
| 2 | S2 | 需求澄清 | 深入了解需求细节 | 需求规格书、验收标准 |
| 3 | S3 | 立项评审 | 技术可行性与商务评审 | 立项报告、合同 |
| 4 | S4 | 方案设计 | 机械/电气/软件方案设计 | 方案文档、BOM |
| 5 | S5 | 采购制造 | 物料采购与加工 | 物料齐套 |
| 6 | S6 | 装配联调 | 机械装配与系统联调 | 设备组装完成 |
| 7 | S7 | 出厂验收 | 厂内FAT验收 | FAT报告 |
| 8 | S8 | 现场交付 | 发货、安装、SAT | SAT报告、终验收 |
| 9 | S9 | 质保结项 | 质保期服务与结项 | 结项报告 |

### 2.3 状态(Status)定义

```python
# 按阶段分组的状态枚举

PROJECT_STATUS = {
    # S1 需求进入
    "S1": [
        ("ST01", "待补全资料", "客户资料不完整，等待补充"),
        ("ST02", "需求评估中", "初步评估需求可行性"),
    ],

    # S2 需求澄清
    "S2": [
        ("ST03", "待安排澄清", "等待安排需求澄清会议"),
        ("ST04", "澄清进行中", "需求澄清会议/现场调研中"),
        ("ST05", "待客户确认", "需求规格书待客户确认"),
    ],

    # S3 立项评审
    "S3": [
        ("ST06", "待评审", "等待安排立项评审"),
        ("ST07", "评审中", "立项评审进行中"),
        ("ST08", "待签合同", "评审通过，等待签订合同"),
    ],

    # S4 方案设计
    "S4": [
        ("ST09", "方案设计中", "机械/电气/软件方案设计"),
        ("ST10", "设计评审中", "方案评审进行中"),
        ("ST11", "BOM发布中", "BOM编制与发布"),
    ],

    # S5 采购制造
    "S5": [
        ("ST12", "采购下单中", "物料采购下单"),
        ("ST13", "等待到货", "等待物料到货"),
        ("ST14", "缺料阻塞", "关键物料缺货，影响进度"),
        ("ST15", "外协加工中", "外协件加工中"),
    ],

    # S6 装配联调
    "S6": [
        ("ST16", "待排产", "等待排产装配"),
        ("ST17", "装配中", "机械装配进行中"),
        ("ST18", "联调中", "系统联调进行中"),
        ("ST19", "技术阻塞", "技术问题导致阻塞"),
    ],

    # S7 出厂验收
    "S7": [
        ("ST20", "待FAT", "等待安排FAT验收"),
        ("ST21", "FAT进行中", "FAT验收进行中"),
        ("ST22", "FAT整改中", "FAT不通过，整改中"),
    ],

    # S8 现场交付
    "S8": [
        ("ST23", "待发货", "等待安排发货"),
        ("ST24", "运输中", "设备运输中"),
        ("ST25", "SAT进行中", "现场SAT验收中"),
        ("ST26", "SAT整改中", "SAT不通过，整改中"),
        ("ST27", "待终验签字", "等待客户终验签字"),
    ],

    # S9 质保结项
    "S9": [
        ("ST28", "质保服务中", "质保期内服务"),
        ("ST29", "待结项", "等待结项审批"),
        ("ST30", "已结项", "项目已结项"),
    ],

    # 通用状态
    "COMMON": [
        ("ST98", "客户暂停", "客户要求暂停项目"),
        ("ST99", "项目取消", "项目已取消"),
    ],
}
```

### 2.4 健康度(Health)定义

| 编码 | 名称 | 颜色 | 判定规则 |
|:----:|------|:----:|----------|
| H1 | 正常 | 🟢 绿色 | 无延期风险，进度正常 |
| H2 | 有风险 | 🟡 黄色 | 存在延期风险或轻微延期 |
| H3 | 阻塞 | 🔴 红色 | 关键任务阻塞，需立即处理 |
| H4 | 已完结 | ⚫ 灰色 | 项目已结项或取消 |

### 2.5 健康度自动计算规则

```python
def calculate_project_health(project):
    """
    自动计算项目健康度
    """
    # H4: 已完结
    if project.status in ['ST30', 'ST99']:
        return 'H4'

    # H3: 阻塞
    if project.status in ['ST14', 'ST19']:  # 缺料阻塞、技术阻塞
        return 'H3'
    if has_blocked_critical_task(project):  # 关键任务阻塞
        return 'H3'

    # H2: 有风险
    if project.status in ['ST22', 'ST26']:  # FAT/SAT整改中
        return 'H2'
    if is_deadline_approaching(project, days=7):  # 交期临近7天
        return 'H2'
    if has_overdue_milestone(project):  # 有逾期里程碑
        return 'H2'
    if has_shortage_warning(project):  # 有缺料预警
        return 'H2'

    # H1: 正常
    return 'H1'
```

### 2.6 三维状态联动规则

| 场景 | 阶段变化 | 状态变化 | 健康度变化 |
|------|----------|----------|------------|
| 合同签订 | S3→S4 | ST08→ST09 | - |
| BOM发布完成 | S4→S5 | ST11→ST12 | - |
| 关键物料缺货 | 保持S5 | →ST14 | →H3 |
| 物料齐套 | S5→S6 | ST15→ST16 | →H1 |
| FAT不通过 | 保持S7 | ST21→ST22 | →H2 |
| FAT通过 | S7→S8 | ST21→ST23 | →H1 |
| 项目结项 | →S9 | →ST30 | →H4 |

---

## 三、项目生命周期

### 3.1 生命周期流程图

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           项目生命周期                                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  商机转入        需求澄清        立项评审        方案设计        采购制造    │
│  ┌─────┐        ┌─────┐        ┌─────┐        ┌─────┐        ┌─────┐       │
│  │ S1  │──G1───►│ S2  │──G2───►│ S3  │──G3───►│ S4  │──G4───►│ S5  │       │
│  │需求 │        │澄清 │        │立项 │        │设计 │        │采购 │       │
│  └─────┘        └─────┘        └─────┘        └─────┘        └──┬──┘       │
│                                                                  │          │
│  ┌───────────────────────────────────────────────────────────────┘          │
│  │                                                                          │
│  │  装配联调        出厂验收        现场交付        质保结项                 │
│  │  ┌─────┐        ┌─────┐        ┌─────┐        ┌─────┐                   │
│  └─►│ S6  │──G5───►│ S7  │──G6───►│ S8  │──G7───►│ S9  │                   │
│     │装配 │        │FAT  │        │交付 │        │结项 │                   │
│     └─────┘        └─────┘        └─────┘        └─────┘                   │
│                                                                              │
│  G1-G7: 阶段门(Gate)，需满足准入条件                                          │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 阶段门(Gate)准入条件

| 阶段门 | 从→到 | 准入条件 |
|:------:|-------|----------|
| G1 | S1→S2 | 需求采集表完整、客户信息齐全 |
| G2 | S2→S3 | 需求规格书确认、验收标准明确 |
| G3 | S3→S4 | 立项评审通过、合同签订 |
| G4 | S4→S5 | 方案评审通过、BOM发布 |
| G5 | S5→S6 | 关键物料齐套率≥80% |
| G6 | S6→S7 | 装配完成、联调通过 |
| G7 | S7→S8 | FAT验收通过 |
| G8 | S8→S9 | 终验收通过、回款达标 |

### 3.3 阶段门校验逻辑

```python
def check_gate(project, target_stage):
    """
    阶段门准入校验
    返回: (is_pass, missing_items)
    """
    gates = {
        'S2': check_gate_s1_to_s2,
        'S3': check_gate_s2_to_s3,
        'S4': check_gate_s3_to_s4,
        'S5': check_gate_s4_to_s5,
        'S6': check_gate_s5_to_s6,
        'S7': check_gate_s6_to_s7,
        'S8': check_gate_s7_to_s8,
        'S9': check_gate_s8_to_s9,
    }

    if target_stage in gates:
        return gates[target_stage](project)
    return (True, [])

def check_gate_s5_to_s6(project):
    """S5采购→S6装配 准入校验"""
    missing = []

    # 检查物料齐套率
    for machine in project.machines:
        ready_rate = calculate_material_ready_rate(machine)
        if ready_rate < 80:
            missing.append(f"机台{machine.code}物料齐套率{ready_rate}%，需≥80%")

    # 检查关键物料
    critical_missing = get_missing_critical_materials(project)
    if critical_missing:
        missing.append(f"关键物料未到：{', '.join(critical_missing)}")

    return (len(missing) == 0, missing)
```

---

## 四、机台管理

### 4.1 机台概念

非标项目通常包含多台设备（机台），每台机台可能：
- 配置不同（如不同测试工位）
- 进度不同（分批交付）
- 负责人不同

### 4.2 机台编码规则

```
机台编码 = 项目编码 + "-PN" + 序号
示例：PJ250712001-PN001, PJ250712001-PN002
```

### 4.3 机台与项目关系

```
┌──────────────────────────────────────────────────────────────┐
│  项目: PJ250712001 - XX公司ICT测试设备                       │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  机台1: PJ250712001-PN001                               ││
│  │  配置: 标准配置                                          ││
│  │  进度: 装配中 (60%)                                      ││
│  │  计划出货: 2025-08-15                                    ││
│  │  机械: 张三 | 电气: 李四 | 调试: 王五                    ││
│  └─────────────────────────────────────────────────────────┘│
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  机台2: PJ250712001-PN002                               ││
│  │  配置: 增加自动上下料                                    ││
│  │  进度: 采购中 (30%)                                      ││
│  │  计划出货: 2025-09-01                                    ││
│  │  机械: 张三 | 电气: 赵六 | 调试: 待定                    ││
│  └─────────────────────────────────────────────────────────┘│
│                                                              │
│  项目整体进度: 45%  (机台加权平均)                           │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 4.4 机台状态与项目状态关系

```python
def calculate_project_stage_from_machines(project):
    """
    根据机台状态计算项目阶段
    规则：取所有机台中最靠前的阶段
    """
    stages = [m.current_stage for m in project.machines]
    return min(stages)  # S1 < S2 < ... < S9

def calculate_project_progress(project):
    """
    计算项目整体进度
    规则：机台进度加权平均（默认权重=1，可按金额调整）
    """
    total_weight = sum(m.weight for m in project.machines)
    weighted_progress = sum(m.progress * m.weight for m in project.machines)
    return weighted_progress / total_weight if total_weight > 0 else 0
```

---

## 五、项目团队管理

### 5.1 项目角色定义

| 角色 | 编码 | 职责 | 数量 |
|------|:----:|------|:----:|
| 销售负责 | SALES | 客户关系、回款跟进 | 1 |
| 项目经理 | PM | 项目整体管理、协调资源 | 1 |
| PMC | PMC | 计划排程、物料协调 | 1 |
| 机械负责 | ME | 机械设计、装配指导 | 1-N |
| 电气负责 | EE | 电气设计、接线调试 | 1-N |
| 软件负责 | SW | 上位机/视觉软件开发 | 0-N |
| 调试负责 | DEBUG | 系统联调、FAT/SAT | 1-N |
| 质量负责 | QA | 验收把关、问题跟踪 | 0-1 |

### 5.2 项目成员分配

**项目级成员**：销售、PM、PMC、质量
**机台级成员**：机械、电气、软件、调试

```sql
-- 项目成员表
CREATE TABLE project_members (
    id INTEGER PRIMARY KEY,
    project_id INTEGER NOT NULL,
    machine_id INTEGER,              -- NULL表示项目级，非NULL表示机台级
    user_id INTEGER NOT NULL,
    role_in_project VARCHAR(20),     -- SALES/PM/PMC/ME/EE/SW/DEBUG/QA
    is_primary BOOLEAN DEFAULT FALSE, -- 是否主负责人
    joined_at DATETIME,
    left_at DATETIME,

    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 5.3 团队变更记录

```sql
-- 项目团队变更日志
CREATE TABLE project_member_logs (
    id INTEGER PRIMARY KEY,
    project_id INTEGER NOT NULL,
    machine_id INTEGER,
    user_id INTEGER NOT NULL,
    action VARCHAR(20),              -- JOIN/LEAVE/CHANGE_ROLE
    old_role VARCHAR(20),
    new_role VARCHAR(20),
    reason TEXT,
    operator_id INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

---

## 六、数据模型设计

### 6.1 项目主表

```sql
CREATE TABLE projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- 基础标识
    project_code VARCHAR(20) UNIQUE NOT NULL,      -- PJ250712001
    project_name VARCHAR(200) NOT NULL,
    contract_code VARCHAR(20),                     -- HT2507-001
    contract_id INTEGER,                           -- 关联合同表

    -- 客户信息
    customer_id INTEGER NOT NULL,
    customer_contact VARCHAR(50),
    customer_phone VARCHAR(20),
    delivery_address TEXT,

    -- 三维状态
    stage VARCHAR(10) NOT NULL DEFAULT 'S1',       -- S1-S9
    status VARCHAR(10) NOT NULL DEFAULT 'ST01',    -- ST01-ST99
    health VARCHAR(10) NOT NULL DEFAULT 'H1',      -- H1-H4
    status_updated_at DATETIME,
    status_updated_by INTEGER,

    -- 分类
    project_type VARCHAR(20),                      -- 单机类/线体类/改造类/软件类
    equipment_type VARCHAR(20),                    -- ICT/FCT/EOL/烧录/老化/视觉
    is_standard BOOLEAN DEFAULT FALSE,             -- 是否标准机
    priority VARCHAR(10) DEFAULT 'C',              -- A特急/B紧急/C正常/D待定

    -- 时间节点
    sign_date DATE,                                -- 签单日期
    contract_deadline DATE,                        -- 合同交期
    negotiated_deadline DATE,                      -- 协商交期
    plan_ship_date DATE,                           -- 计划出货
    actual_ship_date DATE,                         -- 实际出货

    -- 财务概览
    contract_amount DECIMAL(12,2),                 -- 合同金额
    received_amount DECIMAL(12,2) DEFAULT 0,       -- 已收款
    receivable_amount DECIMAL(12,2),               -- 待收款（计算字段）
    payment_status VARCHAR(20),                    -- 付款状态

    -- 进度概览
    machine_count INTEGER DEFAULT 1,               -- 机台总数
    shipped_count INTEGER DEFAULT 0,               -- 已出货数
    overall_progress INTEGER DEFAULT 0,            -- 整体进度%

    -- 风险信息
    risk_level VARCHAR(10),                        -- 高/中/低
    risk_description TEXT,
    current_situation TEXT,                        -- 当前状况

    -- 审计字段
    created_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (contract_id) REFERENCES contracts(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_projects_code ON projects(project_code);
CREATE INDEX idx_projects_customer ON projects(customer_id);
CREATE INDEX idx_projects_stage ON projects(stage);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_health ON projects(health);
CREATE INDEX idx_projects_priority ON projects(priority);
CREATE INDEX idx_projects_deadline ON projects(contract_deadline);
```

### 6.2 机台表

```sql
CREATE TABLE machines (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,

    -- 基础信息
    machine_code VARCHAR(30) NOT NULL,             -- PJ250712001-PN001
    machine_name VARCHAR(200),
    machine_type VARCHAR(50),                      -- 机型/配置类型
    quantity INTEGER DEFAULT 1,                    -- 数量（通常为1）
    weight DECIMAL(5,2) DEFAULT 1,                 -- 进度权重

    -- 配置信息
    configuration TEXT,                            -- 配置说明
    special_requirements TEXT,                     -- 特殊要求

    -- 状态
    current_stage VARCHAR(10) DEFAULT 'S1',
    current_status VARCHAR(10) DEFAULT 'ST01',
    stage_progress INTEGER DEFAULT 0,              -- 阶段内进度%
    overall_progress INTEGER DEFAULT 0,            -- 整体进度%

    -- 时间节点
    plan_bom_date DATE,                            -- 计划出BOM
    actual_bom_date DATE,
    plan_material_date DATE,                       -- 计划到料
    actual_material_date DATE,
    material_ready_rate INTEGER DEFAULT 0,         -- 到料率%
    plan_assembly_date DATE,                       -- 计划装配完成
    actual_assembly_date DATE,
    plan_debug_date DATE,                          -- 计划调试完成
    actual_debug_date DATE,
    plan_fat_date DATE,                            -- 计划FAT
    actual_fat_date DATE,
    plan_ship_date DATE,                           -- 计划出货
    actual_ship_date DATE,

    -- 审计字段
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_machines_project ON machines(project_id);
CREATE INDEX idx_machines_code ON machines(machine_code);
CREATE INDEX idx_machines_stage ON machines(current_stage);
CREATE UNIQUE INDEX idx_machines_code_unique ON machines(machine_code);
```

### 6.3 项目状态变更日志

```sql
CREATE TABLE project_status_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    machine_id INTEGER,                            -- NULL表示项目级变更

    -- 变更前
    old_stage VARCHAR(10),
    old_status VARCHAR(10),
    old_health VARCHAR(10),

    -- 变更后
    new_stage VARCHAR(10),
    new_status VARCHAR(10),
    new_health VARCHAR(10),

    -- 变更信息
    change_reason TEXT,
    change_type VARCHAR(20),                       -- MANUAL/AUTO/SYSTEM
    operator_id INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (operator_id) REFERENCES users(id)
);

CREATE INDEX idx_status_logs_project ON project_status_logs(project_id);
CREATE INDEX idx_status_logs_time ON project_status_logs(created_at);
```

### 6.4 项目配置表

```sql
-- 项目类型配置
CREATE TABLE project_type_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type_code VARCHAR(20) UNIQUE NOT NULL,
    type_name VARCHAR(50) NOT NULL,
    description TEXT,
    default_stages TEXT,                           -- 适用阶段JSON
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE
);

-- 设备类型配置
CREATE TABLE equipment_type_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type_code VARCHAR(20) UNIQUE NOT NULL,
    type_name VARCHAR(50) NOT NULL,
    description TEXT,
    typical_lead_time INTEGER,                     -- 典型交期(天)
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE
);

-- 优先级配置
CREATE TABLE priority_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    priority_code VARCHAR(10) UNIQUE NOT NULL,
    priority_name VARCHAR(20) NOT NULL,
    color VARCHAR(20),
    response_hours INTEGER,                        -- 响应时限(小时)
    sort_order INTEGER DEFAULT 0
);
```

---

## 七、API接口设计

### 7.1 项目管理

```
# 项目CRUD
GET    /projects                       # 项目列表（支持筛选、分页）
POST   /projects                       # 创建项目
GET    /projects/{id}                  # 项目详情
PATCH  /projects/{id}                  # 更新项目
DELETE /projects/{id}                  # 删除项目（仅草稿）

# 项目状态
GET    /projects/{id}/status           # 获取三维状态
PATCH  /projects/{id}/status           # 更新状态
POST   /projects/{id}/stage-advance    # 阶段推进（含Gate校验）
GET    /projects/{id}/status-logs      # 状态变更日志

# 项目团队
GET    /projects/{id}/members          # 成员列表
POST   /projects/{id}/members          # 添加成员
DELETE /projects/{id}/members/{mid}    # 移除成员
PATCH  /projects/{id}/members/{mid}    # 变更角色

# 项目统计
GET    /projects/{id}/summary          # 项目概览数据
GET    /projects/{id}/timeline         # 时间线
GET    /projects/statistics            # 项目统计（按状态/客户/月份）
```

### 7.2 机台管理

```
# 机台CRUD
GET    /projects/{id}/machines         # 机台列表
POST   /projects/{id}/machines         # 添加机台
GET    /machines/{id}                  # 机台详情
PATCH  /machines/{id}                  # 更新机台
DELETE /machines/{id}                  # 删除机台

# 机台状态
PATCH  /machines/{id}/status           # 更新机台状态
PATCH  /machines/{id}/progress         # 更新进度
GET    /machines/{id}/timeline         # 机台时间线

# 机台成员
GET    /machines/{id}/members          # 机台成员
POST   /machines/{id}/members          # 分配成员
```

### 7.3 请求/响应示例

**创建项目**

POST /projects
```json
{
  "project_name": "XX公司ICT测试设备",
  "customer_id": 15,
  "contract_code": "HT2507-001",
  "project_type": "单机类",
  "equipment_type": "ICT",
  "priority": "B",
  "contract_deadline": "2025-09-30",
  "contract_amount": 350000,
  "machine_count": 2,
  "machines": [
    {
      "machine_name": "ICT测试机-标准版",
      "plan_ship_date": "2025-09-15"
    },
    {
      "machine_name": "ICT测试机-加强版",
      "plan_ship_date": "2025-09-30"
    }
  ]
}
```

响应：
```json
{
  "code": "OK",
  "data": {
    "id": 101,
    "project_code": "PJ250712001",
    "stage": "S1",
    "status": "ST01",
    "health": "H1",
    "machines": [
      {"id": 201, "machine_code": "PJ250712001-PN001"},
      {"id": 202, "machine_code": "PJ250712001-PN002"}
    ]
  }
}
```

**阶段推进**

POST /projects/101/stage-advance
```json
{
  "target_stage": "S4",
  "reason": "合同已签订，启动方案设计"
}
```

响应（成功）：
```json
{
  "code": "OK",
  "data": {
    "project_id": 101,
    "old_stage": "S3",
    "new_stage": "S4",
    "new_status": "ST09",
    "gate_passed": true
  }
}
```

响应（Gate不通过）：
```json
{
  "code": "GATE_NOT_PASSED",
  "message": "阶段门校验未通过",
  "data": {
    "target_stage": "S6",
    "missing_items": [
      "机台PN001物料齐套率65%，需≥80%",
      "关键物料未到：伺服电机、PLC"
    ]
  }
}
```

---

## 八、页面设计

### 8.1 页面清单

| 页面 | 功能 | 访问角色 |
|------|------|----------|
| 项目列表 | 查看/筛选/搜索项目 | 所有人 |
| 项目看板 | 按阶段/状态看板视图 | 项目经理/管理层 |
| 项目详情 | 项目完整信息 | 项目成员 |
| 项目创建/编辑 | 创建或编辑项目 | PM/PMC/管理员 |
| 机台详情 | 机台进度与信息 | 项目成员 |
| 项目统计 | 统计分析报表 | 管理层 |

### 8.2 项目列表页

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  项目管理                                          [+ 新建项目] [导出]       │
├─────────────────────────────────────────────────────────────────────────────┤
│  阶段: [全部▼]  健康度: [全部▼]  客户: [全部▼]  优先级: [全部▼]  [搜索...]   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🔴 PJ250712001 | XX公司ICT测试设备                         B-紧急   │   │
│  │ 客户: XX科技  |  阶段: S6装配联调  |  状态: 缺料阻塞  |  进度: 45% │   │
│  │ 交期: 2025-09-30 (剩余80天)  |  PM: 张三  |  金额: ¥350,000        │   │
│  │ ⚠️ 关键物料缺货：伺服电机预计延期7天                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🟢 PJ250710002 | YY公司FCT测试线                           C-正常   │   │
│  │ 客户: YY电子  |  阶段: S4方案设计  |  状态: 设计评审中  |  进度: 25%│   │
│  │ 交期: 2025-10-31 (剩余111天)  |  PM: 李四  |  金额: ¥580,000       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🟡 PJ250708003 | ZZ公司老化设备                            C-正常   │   │
│  │ 客户: ZZ制造  |  阶段: S7出厂验收  |  状态: FAT整改中  |  进度: 85% │   │
│  │ 交期: 2025-08-15 (剩余34天)  |  PM: 王五  |  金额: ¥220,000        │   │
│  │ ⚠️ FAT发现3个问题待整改                                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                                          [< 1 2 3 ... 10 >]
```

### 8.3 项目看板页

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  项目看板                              [按阶段] [按健康度] [按客户]  [刷新]  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  S4方案设计(3)    S5采购制造(5)    S6装配联调(4)    S7出厂验收(2)          │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│  │🟢 PJ001  │    │🔴 PJ005  │    │🟡 PJ009  │    │🟢 PJ013  │             │
│  │XX公司    │    │AA公司    │    │BB公司    │    │CC公司    │             │
│  │进度: 25% │    │进度: 40% │    │进度: 75% │    │进度: 90% │             │
│  │交期: 10/31│    │交期: 09/15│    │交期: 08/20│    │交期: 08/10│             │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│  │🟢 PJ002  │    │🟢 PJ006  │    │🔴 PJ010  │    │🟡 PJ014  │             │
│  │YY公司    │    │DD公司    │    │EE公司    │    │FF公司    │             │
│  │进度: 30% │    │进度: 55% │    │进度: 60% │    │进度: 88% │             │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐                              │
│  │🟢 PJ003  │    │🟡 PJ007  │    │🟢 PJ011  │                              │
│  │ZZ公司    │    │GG公司    │    │HH公司    │                              │
│  └──────────┘    └──────────┘    └──────────┘                              │
│                  ┌──────────┐    ┌──────────┐                              │
│                  │🟢 PJ008  │    │🟢 PJ012  │                              │
│                  │II公司    │    │JJ公司    │                              │
│                  └──────────┘    └──────────┘                              │
│                  ┌──────────┐                                              │
│                  │🟡 PJ015  │                                              │
│                  │KK公司    │                                              │
│                  └──────────┘                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.4 项目详情页

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ← 返回  PJ250712001 - XX公司ICT测试设备                    [编辑] [更多▼] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 状态概览 ────────────────────────────────────────────────────────────┐ │
│  │  阶段: S6 装配联调    状态: ST14 缺料阻塞    健康度: 🔴 阻塞           │ │
│  │  ════════════════════════════●═══════════════════════                  │ │
│  │  S1  S2  S3  S4  S5  [S6]  S7  S8  S9                    进度: 45%    │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌─ 基本信息 ──────────────────────┐  ┌─ 时间节点 ────────────────────────┐│
│  │ 客户: XX科技有限公司            │  │ 签单日期: 2025-07-01              ││
│  │ 合同号: HT2507-001              │  │ 合同交期: 2025-09-30              ││
│  │ 类型: 单机类 / ICT测试设备      │  │ 协商交期: -                       ││
│  │ 优先级: B-紧急                  │  │ 计划出货: 2025-09-15              ││
│  │ 机台数: 2台                     │  │ 剩余天数: 80天                    ││
│  └─────────────────────────────────┘  └───────────────────────────────────┘│
│                                                                             │
│  ┌─ 财务概览 ──────────────────────┐  ┌─ 项目团队 ────────────────────────┐│
│  │ 合同金额: ¥350,000              │  │ 销售: 陈一    PM: 张三            ││
│  │ 已收款:   ¥105,000 (30%)        │  │ PMC: 周二    质量: 吴七           ││
│  │ 待收款:   ¥245,000              │  │                                   ││
│  │ 付款状态: 已收预付款            │  │ [查看完整团队]                    ││
│  └─────────────────────────────────┘  └───────────────────────────────────┘│
│                                                                             │
│  ┌─ 机台列表 ────────────────────────────────────────────────────────────┐ │
│  │ 机台编号          配置        进度    阶段      计划出货    负责人     │ │
│  │ ─────────────────────────────────────────────────────────────────────  │ │
│  │ PJ250712001-PN001 标准版      60%    S6装配中   09-15      张三/李四  │ │
│  │ PJ250712001-PN002 加强版      30%    S5采购中   09-30      张三/赵六  │ │
│  │                                                          [+ 添加机台] │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌─ 风险与异常 ──────────────────────────────────────────────────────────┐ │
│  │ 🔴 关键物料缺货：伺服电机预计延期7天，影响机台PN001装配              │ │
│  │ 🟡 机台PN002物料齐套率65%，建议催货                                   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  [Tab: 进度跟踪] [里程碑] [变更记录] [验收记录] [收款记录] [操作日志]       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、权限矩阵

| 功能 | 销售 | PM | PMC | 工程师 | 质量 | 财务 | 管理员 |
|------|:----:|:--:|:---:|:------:|:----:|:----:|:------:|
| 项目列表查看 | R(自己) | R(参与) | R(全部) | R(参与) | R(参与) | R(全部) | R |
| 项目详情查看 | R | R | R | R | R | R | R |
| 创建项目 | - | W | W | - | - | - | W |
| 编辑项目 | - | W | W | - | - | - | W |
| 状态变更 | - | W | W | - | - | - | W |
| 阶段推进 | - | W | - | - | - | - | W |
| 团队管理 | - | W | W | - | - | - | W |
| 机台管理 | - | W | W | R | - | - | W |
| 删除项目 | - | - | - | - | - | - | W |

---

## 十、与其他模块联动

### 10.1 联动关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        项目管理模块                              │
│                            │                                    │
│         ┌──────────────────┼──────────────────┐                │
│         ▼                  ▼                  ▼                │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │ 销售管理    │    │ 进度跟踪    │    │ 采购物料    │        │
│  │ 合同→项目  │    │ 任务/里程碑 │    │ BOM/采购单  │        │
│  └─────────────┘    └─────────────┘    └─────────────┘        │
│                            │                  │                │
│         ┌──────────────────┼──────────────────┘                │
│         ▼                  ▼                                   │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │ 变更管理    │    │ 验收管理    │    │ 预警异常    │        │
│  │ ECN单      │    │ FAT/SAT    │    │ 缺料/逾期   │        │
│  └─────────────┘    └─────────────┘    └─────────────┘        │
└─────────────────────────────────────────────────────────────────┘
```

### 10.2 关键联动规则

| 触发模块 | 事件 | 项目管理响应 |
|----------|------|--------------|
| 销售管理 | 合同签订 | 自动创建项目，状态→S3/ST08 |
| 采购物料 | 关键物料缺货 | 健康度→H3，状态→ST14 |
| 采购物料 | 物料齐套 | 可推进至S6 |
| 进度跟踪 | 里程碑延期 | 健康度→H2 |
| 验收管理 | FAT通过 | 状态→ST23，可推进至S8 |
| 验收管理 | FAT不通过 | 状态→ST22，健康度→H2 |
| 验收管理 | 终验收通过 | 可推进至S9 |
| 变更管理 | ECN影响交期 | 更新协商交期，记录风险 |

---

## 十一、配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| 项目编码前缀 | PJ | 项目编码格式：PJ+yymmdd+序号 |
| 机台编码格式 | {项目编码}-PN{序号} | 机台编码格式 |
| 交期预警天数 | 7, 14, 30 | 交期临近预警阈值 |
| 齐套率阈值 | 80% | S5→S6阶段门齐套率要求 |
| 默认优先级 | C | 新项目默认优先级 |
| 健康度自动计算 | 开启 | 是否自动计算健康度 |

---

## 十二、实施建议

### 12.1 分阶段实施

**阶段一：基础功能**
- 项目CRUD
- 三维状态管理（手动）
- 机台管理
- 项目列表/详情页

**阶段二：联动功能**
- 阶段门自动校验
- 健康度自动计算
- 与采购模块联动
- 项目看板

**阶段三：高级功能**
- 与销售模块联动（合同→项目）
- 项目统计报表
- 企微消息推送

---

*本文档与进度跟踪、采购物料、变更管理、验收管理模块配套使用。*

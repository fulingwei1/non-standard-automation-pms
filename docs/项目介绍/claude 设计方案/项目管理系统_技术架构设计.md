# 非标自动化项目管理系统 - 技术架构设计

**版本**：V1.0  
**日期**：2025年7月  
**技术路线**：Python + FastAPI + SQLite/MySQL + 企业微信自建应用

---

## 第一部分：整体架构设计

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           非标自动化项目管理系统架构                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                              接入层                                       │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │  │
│  │  │  企微工作台  │  │  企微H5应用  │  │  Web管理端  │  │  移动端适配  │     │  │
│  │  │  (入口)     │  │  (填报/查看) │  │  (完整功能) │  │  (响应式)   │     │  │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │  │
│  └─────────┼────────────────┼────────────────┼────────────────┼─────────────┘  │
│            │                │                │                │                │
│            ▼                ▼                ▼                ▼                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                              网关层                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  Nginx (反向代理 + HTTPS + 内外网统一入口)                           │ │  │
│  │  │  · 外网访问: https://pm.jinkabo.com                                 │ │  │
│  │  │  · 内网访问: http://192.168.x.x:8000                                │ │  │
│  │  └─────────────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                         │
│                                      ▼                                         │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                              应用层                                       │  │
│  │                                                                          │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │  │
│  │  │                    FastAPI 后端服务                                  │ │  │
│  │  │  ┌───────────┬───────────┬───────────┬───────────┬───────────┐     │ │  │
│  │  │  │  项目管理  │  生产进度  │  采购物料  │  变更管理  │  外协管理  │     │ │  │
│  │  │  │  模块     │  模块     │  模块     │  模块     │  模块     │     │ │  │
│  │  │  ├───────────┼───────────┼───────────┼───────────┼───────────┤     │ │  │
│  │  │  │  异常管理  │  人员资源  │  收款管理  │  售后工单  │  报表统计  │     │ │  │
│  │  │  │  模块     │  模块     │  模块     │  模块     │  模块     │     │ │  │
│  │  │  └───────────┴───────────┴───────────┴───────────┴───────────┘     │ │  │
│  │  │                              │                                      │ │  │
│  │  │  ┌───────────┬───────────┬───────────┐                             │ │  │
│  │  │  │  认证鉴权  │  定时任务  │  消息队列  │  (后台服务)                │ │  │
│  │  │  │  JWT      │  APScheduler│  (可选)   │                             │ │  │
│  │  │  └───────────┴───────────┴───────────┘                             │ │  │
│  │  └─────────────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                         │
│                    ┌─────────────────┼─────────────────┐                       │
│                    ▼                 ▼                 ▼                       │
│  ┌────────────────────┐ ┌────────────────────┐ ┌────────────────────┐         │
│  │      数据层         │ │    企业微信API      │ │     外部服务        │         │
│  │  ┌──────────────┐  │ │  ┌──────────────┐  │ │  ┌──────────────┐  │         │
│  │  │   SQLite     │  │ │  │  消息推送    │  │ │  │  文件存储    │  │         │
│  │  │   (开发/小)  │  │ │  │  通讯录同步  │  │ │  │  (OSS/本地)  │  │         │
│  │  ├──────────────┤  │ │  │  审批流程    │  │ │  ├──────────────┤  │         │
│  │  │   MySQL      │  │ │  │  应用消息    │  │ │  │  邮件服务    │  │         │
│  │  │   (生产)     │  │ │  │  JS-SDK     │  │ │  │  (可选)      │  │         │
│  │  └──────────────┘  │ │  └──────────────┘  │ │  └──────────────┘  │         │
│  └────────────────────┘ └────────────────────┘ └────────────────────┘         │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型确认

| 层次 | 技术选择 | 说明 |
|------|----------|------|
| **后端框架** | FastAPI | 异步高性能，自动API文档，类型提示友好 |
| **数据库** | SQLite(开发) → MySQL(生产) | SQLAlchemy ORM，无缝切换 |
| **前端** | Vue3 + Element Plus | 或纯HTML+Tailwind（更简单） |
| **企微集成** | 自建应用 + 企微API | 消息推送、审批、H5页面 |
| **定时任务** | APScheduler | 每日预警、定时统计 |
| **认证** | JWT + 企微OAuth | 企微扫码登录 + Token认证 |
| **部署** | Docker + Nginx | 内外网统一访问 |
| **服务器** | 公司服务器 | 内网部署，Nginx反向代理外网 |

### 1.3 部署架构（内外网访问）

```
                         互联网
                            │
                            ▼
                    ┌───────────────┐
                    │   云服务器     │  (可选：仅做反向代理)
                    │   公网IP      │  
                    └───────┬───────┘
                            │ 端口转发/VPN
                            ▼
            ┌───────────────────────────────┐
            │         公司防火墙/路由        │
            └───────────────┬───────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      公司内网                                │
│                                                             │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    │
│   │   Nginx     │    │  FastAPI    │    │   MySQL     │    │
│   │  :80/:443   │───▶│   :8000     │───▶│   :3306     │    │
│   │  反向代理   │    │   应用服务   │    │   数据库    │    │
│   └─────────────┘    └─────────────┘    └─────────────┘    │
│         │                   │                              │
│         ▼                   ▼                              │
│   ┌─────────────────────────────────────┐                  │
│   │           文件存储 (NAS/本地)        │                  │
│   │       图纸、附件、导出文件           │                  │
│   └─────────────────────────────────────┘                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘

访问方式：
· 内网: http://192.168.x.x 或 http://pm.local
· 外网: https://pm.jinkabo.com (通过Nginx/云服务器代理)
· 企微: 企微工作台入口，自动识别内外网
```

---

## 第二部分：数据库设计

### 2.1 核心表结构

#### 2.1.1 ER图概览

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   客户表    │     │   项目表    │     │   机台表    │
│  customers  │◄────│  projects   │────▶│  machines   │
└─────────────┘     └──────┬──────┘     └─────────────┘
                           │
         ┌─────────────────┼─────────────────┐
         ▼                 ▼                 ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   里程碑    │     │   任务表    │     │   变更表    │
│ milestones  │     │   tasks     │     │    ecn      │
└─────────────┘     └─────────────┘     └─────────────┘
         │                 │
         ▼                 ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  BOM清单    │     │  采购单     │     │   外协单    │
│    bom      │     │  purchases  │     │ outsourcing │
└─────────────┘     └─────────────┘     └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │  物料主数据  │
                    │  materials  │
                    └─────────────┘
```

#### 2.1.2 核心表定义

```sql
-- ============================================
-- 1. 基础主数据表
-- ============================================

-- 客户表
CREATE TABLE customers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    customer_code VARCHAR(20) UNIQUE NOT NULL,     -- C00001
    customer_name VARCHAR(100) NOT NULL,
    industry VARCHAR(50),                          -- 汽车电子/白色家电/BMS
    contact_name VARCHAR(50),
    contact_phone VARCHAR(20),
    address TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 供应商表
CREATE TABLE suppliers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    supplier_code VARCHAR(20) UNIQUE NOT NULL,     -- V00001
    supplier_name VARCHAR(100) NOT NULL,
    category VARCHAR(50),                          -- 机加工/钣金/电气/标准件
    contact_name VARCHAR(50),
    contact_phone VARCHAR(20),
    delivery_rating DECIMAL(3,2),                  -- 交期评分 0-5
    quality_rating DECIMAL(3,2),                   -- 质量评分 0-5
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 物料主数据表
CREATE TABLE materials (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    material_code VARCHAR(30) UNIQUE NOT NULL,     -- ME-01-01-0001
    material_name VARCHAR(100) NOT NULL,
    category_l1 VARCHAR(20),                       -- 大类：ME/EL/PN/ST
    category_l2 VARCHAR(20),                       -- 中类
    category_l3 VARCHAR(20),                       -- 小类
    specification TEXT,                            -- 规格描述
    unit VARCHAR(10),                              -- 单位
    standard_lead_time INTEGER,                    -- 标准交期(天)
    default_supplier_id INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (default_supplier_id) REFERENCES suppliers(id)
);

-- 人员表
CREATE TABLE employees (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    employee_code VARCHAR(10) UNIQUE NOT NULL,     -- E0001
    name VARCHAR(50) NOT NULL,
    department VARCHAR(50),                        -- 机械部/电气部/PMC
    role VARCHAR(50),                              -- 机械工程师/调试工程师
    phone VARCHAR(20),
    wechat_userid VARCHAR(50),                     -- 企业微信UserID
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ============================================
-- 2. 项目核心表
-- ============================================

-- 项目主表
CREATE TABLE projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_code VARCHAR(20) UNIQUE NOT NULL,      -- PJ250708001
    contract_code VARCHAR(20),                     -- HT2507-001
    project_name VARCHAR(200) NOT NULL,
    customer_id INTEGER NOT NULL,
    
    -- 三维状态
    stage VARCHAR(20) NOT NULL DEFAULT 'S1',       -- S1-S9
    status VARCHAR(20) NOT NULL DEFAULT 'ST01',    -- ST01-ST99
    health VARCHAR(10) NOT NULL DEFAULT 'H1',      -- H1-H4
    status_updated_at DATETIME,
    
    -- 分类
    project_type VARCHAR(20),                      -- 单机类/线体类/改造类
    equipment_type VARCHAR(20),                    -- ICT/FCT/EOL
    priority VARCHAR(10) DEFAULT 'C',              -- A/B/C/D
    
    -- 时间节点
    sign_date DATE,                                -- 签单日期
    contract_deadline DATE,                        -- 合同交期
    negotiated_deadline DATE,                      -- 协商交期
    
    -- 财务
    contract_amount DECIMAL(12,2),                 -- 合同金额
    received_amount DECIMAL(12,2) DEFAULT 0,       -- 已收款
    payment_status VARCHAR(20),                    -- 付款状态
    
    -- 人员
    sales_id INTEGER,                              -- 销售负责
    pmc_id INTEGER,                                -- PMC
    pm_id INTEGER,                                 -- 项目经理
    
    -- 备注
    risk_level VARCHAR(10),                        -- 风险等级
    risk_description TEXT,
    current_status TEXT,                           -- 当前状况
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (sales_id) REFERENCES employees(id),
    FOREIGN KEY (pmc_id) REFERENCES employees(id),
    FOREIGN KEY (pm_id) REFERENCES employees(id)
);

-- 机台表（一个项目多个机台）
CREATE TABLE machines (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    machine_code VARCHAR(30) NOT NULL,             -- PJ250708001-PN001
    machine_name VARCHAR(200),
    quantity INTEGER DEFAULT 1,
    
    -- 人员分工
    mechanical_id INTEGER,                         -- 机械负责
    electrical_id INTEGER,                         -- 电气负责
    software_id INTEGER,                           -- 上位机/视觉
    debug_id INTEGER,                              -- 调试负责
    
    -- 进度
    current_stage VARCHAR(20),
    stage_progress INTEGER DEFAULT 0,              -- 阶段进度%
    overall_progress INTEGER DEFAULT 0,            -- 整体进度%
    
    -- 时间节点
    plan_bom_date DATE,                            -- 计划出BOM
    actual_bom_date DATE,
    plan_material_date DATE,                       -- 计划到料
    actual_material_date DATE,
    material_ready_rate INTEGER DEFAULT 0,         -- 到料率%
    plan_assembly_date DATE,                       -- 计划装配完成
    actual_assembly_date DATE,
    plan_debug_date DATE,                          -- 计划调试完成
    actual_debug_date DATE,
    plan_ship_date DATE,                           -- 计划出货
    actual_ship_date DATE,
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (mechanical_id) REFERENCES employees(id),
    FOREIGN KEY (electrical_id) REFERENCES employees(id),
    FOREIGN KEY (software_id) REFERENCES employees(id),
    FOREIGN KEY (debug_id) REFERENCES employees(id)
);

-- 里程碑表
CREATE TABLE milestones (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    machine_id INTEGER,                            -- 可选，关联到具体机台
    milestone_name VARCHAR(50) NOT NULL,           -- 立项/设计完成/BOM发布...
    milestone_level VARCHAR(10) DEFAULT 'L2',      -- L1/L2/L3
    status VARCHAR(20) DEFAULT 'PENDING',          -- PENDING/IN_PROGRESS/COMPLETED/BLOCKED
    owner_id INTEGER,                              -- 负责人
    acceptance_required BOOLEAN DEFAULT FALSE,     -- 是否需要验收
    deliverable_required BOOLEAN DEFAULT FALSE,    -- 是否要求交付物
    plan_date DATE,
    actual_date DATE,
    delay_days INTEGER,                            -- 延期天数
    delay_reason TEXT,
    approved_by INTEGER,                           -- 审批人
    approved_at DATETIME,
    completed BOOLEAN DEFAULT FALSE,
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (owner_id) REFERENCES employees(id),
    FOREIGN KEY (approved_by) REFERENCES employees(id)
);

-- ============================================
-- 2.3 进度与任务表
-- ============================================

-- WBS模板表
CREATE TABLE wbs_templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_code VARCHAR(20) UNIQUE NOT NULL,    -- WBS-T-001
    template_name VARCHAR(100) NOT NULL,          -- 单机类/线体类
    project_type VARCHAR(20),
    equipment_type VARCHAR(20),
    version_no VARCHAR(10) DEFAULT 'V1',
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- WBS模板任务表
CREATE TABLE wbs_template_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_id INTEGER NOT NULL,
    task_name VARCHAR(200),
    stage VARCHAR(20),                            -- S1-S9
    default_owner_role VARCHAR(50),               -- 机械/电气/软件
    plan_days INTEGER,
    weight DECIMAL(5,2) DEFAULT 1,
    depends_on_template_task_id INTEGER,
    FOREIGN KEY (template_id) REFERENCES wbs_templates(id),
    FOREIGN KEY (depends_on_template_task_id) REFERENCES wbs_template_tasks(id)
);

-- 项目任务表
CREATE TABLE tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    machine_id INTEGER,
    milestone_id INTEGER,
    task_name VARCHAR(200) NOT NULL,
    stage VARCHAR(20),
    status VARCHAR(20) DEFAULT 'TODO',            -- TODO/IN_PROGRESS/BLOCKED/DONE/CANCELLED
    owner_id INTEGER,
    plan_start DATE,
    plan_end DATE,
    actual_start DATE,
    actual_end DATE,
    progress_percent INTEGER DEFAULT 0,           -- 0-100
    weight DECIMAL(5,2) DEFAULT 1,
    block_reason TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (milestone_id) REFERENCES milestones(id),
    FOREIGN KEY (owner_id) REFERENCES employees(id)
);

-- 任务依赖关系表
CREATE TABLE task_dependencies (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,
    depends_on_task_id INTEGER NOT NULL,
    dependency_type VARCHAR(10) DEFAULT 'FS',     -- FS/FF/SS/SF
    lag_days INTEGER DEFAULT 0,
    FOREIGN KEY (task_id) REFERENCES tasks(id),
    FOREIGN KEY (depends_on_task_id) REFERENCES tasks(id)
);

-- 进度日志表
CREATE TABLE progress_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,
    progress_percent INTEGER,
    update_note TEXT,
    updated_by INTEGER,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES tasks(id),
    FOREIGN KEY (updated_by) REFERENCES employees(id)
);

-- 计划基线表
CREATE TABLE schedule_baselines (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    baseline_no VARCHAR(10) DEFAULT 'V1',
    created_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (created_by) REFERENCES employees(id)
);

-- 基线任务快照表
CREATE TABLE baseline_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    baseline_id INTEGER NOT NULL,
    task_id INTEGER NOT NULL,
    plan_start DATE,
    plan_end DATE,
    weight DECIMAL(5,2),
    FOREIGN KEY (baseline_id) REFERENCES schedule_baselines(id),
    FOREIGN KEY (task_id) REFERENCES tasks(id)
);

-- ============================================
-- 2.4 权限管理表
-- ============================================

-- 用户表（账号维度）
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    employee_id INTEGER NOT NULL,
    username VARCHAR(50) UNIQUE,
    auth_type VARCHAR(20) DEFAULT 'wechat',       -- wechat/password
    last_login_at DATETIME,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (employee_id) REFERENCES employees(id)
);

-- 角色表
CREATE TABLE roles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    role_code VARCHAR(30) UNIQUE NOT NULL,        -- PM/QA/FINANCE
    role_name VARCHAR(50) NOT NULL,
    data_scope VARCHAR(20) DEFAULT 'PROJECT',     -- ALL/DEPT/PROJECT/OWN
    is_system BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 权限表
CREATE TABLE permissions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    perm_code VARCHAR(100) UNIQUE NOT NULL,       -- project:task:update
    perm_name VARCHAR(100),
    module VARCHAR(50),
    action VARCHAR(50)
);

-- 用户角色
CREATE TABLE user_roles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    role_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (role_id) REFERENCES roles(id)
);

-- 角色权限
CREATE TABLE role_permissions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    role_id INTEGER NOT NULL,
    permission_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES roles(id),
    FOREIGN KEY (permission_id) REFERENCES permissions(id)
);

-- 项目成员（用于项目级数据权限）
CREATE TABLE project_members (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    role_in_project VARCHAR(50),                  -- PM/ME/EE/SW/QA/PMC
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 权限变更审计
CREATE TABLE permission_audits (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    operator_id INTEGER NOT NULL,
    action VARCHAR(50),                           -- grant/revoke/update
    target_type VARCHAR(20),                      -- user/role
    target_id INTEGER NOT NULL,
    detail TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (operator_id) REFERENCES users(id)
);

-- ============================================
-- 2.5 交付物与验收表
-- ============================================

-- 交付物模板表（按阶段/里程碑预置）
CREATE TABLE deliverable_templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_code VARCHAR(30) UNIQUE NOT NULL,     -- DL-FAT-001
    template_name VARCHAR(100) NOT NULL,           -- FAT报告/验收单
    stage VARCHAR(20),                             -- S1-S9
    milestone_name VARCHAR(50),
    required BOOLEAN DEFAULT TRUE,
    file_types VARCHAR(50),                        -- pdf/docx/xlsx
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 项目交付物实例表
CREATE TABLE project_deliverables (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    machine_id INTEGER,
    milestone_id INTEGER,
    template_id INTEGER,
    deliverable_name VARCHAR(100) NOT NULL,
    version_no VARCHAR(10) DEFAULT 'V1',
    status VARCHAR(20) DEFAULT 'DRAFT',            -- DRAFT/SUBMITTED/APPROVED/REJECTED
    owner_id INTEGER,
    submitted_at DATETIME,
    approved_by INTEGER,
    approved_at DATETIME,
    remark TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (milestone_id) REFERENCES milestones(id),
    FOREIGN KEY (template_id) REFERENCES deliverable_templates(id),
    FOREIGN KEY (owner_id) REFERENCES employees(id),
    FOREIGN KEY (approved_by) REFERENCES employees(id)
);

-- 交付物文件版本表
CREATE TABLE deliverable_files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    deliverable_id INTEGER NOT NULL,
    file_name VARCHAR(200),
    file_url TEXT,
    file_version VARCHAR(10),
    uploaded_by INTEGER,
    uploaded_at DATETIME,
    
    FOREIGN KEY (deliverable_id) REFERENCES project_deliverables(id),
    FOREIGN KEY (uploaded_by) REFERENCES employees(id)
);

-- 验收记录表
CREATE TABLE acceptance_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    machine_id INTEGER,
    milestone_id INTEGER,
    acceptance_type VARCHAR(20),                   -- FAT/SAT/FINAL
    plan_date DATE,
    actual_date DATE,
    status VARCHAR(20) DEFAULT 'PENDING',          -- PENDING/IN_REVIEW/PASSED/FAILED
    summary TEXT,
    signed_by VARCHAR(50),                         -- 客户签字人
    signed_at DATETIME,
    created_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (milestone_id) REFERENCES milestones(id),
    FOREIGN KEY (created_by) REFERENCES employees(id)
);

-- 验收检查项
CREATE TABLE acceptance_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    acceptance_id INTEGER NOT NULL,
    item_name VARCHAR(200),
    expected_value VARCHAR(200),
    actual_value VARCHAR(200),
    result VARCHAR(10),                            -- PASS/FAIL
    remark TEXT,
    
    FOREIGN KEY (acceptance_id) REFERENCES acceptance_records(id)
);

-- 验收问题清单
CREATE TABLE acceptance_issues (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    acceptance_id INTEGER NOT NULL,
    issue_type VARCHAR(20),                        -- 性能/安全/资料/外观
    description TEXT,
    severity VARCHAR(10),                          -- 严重/一般
    responsible_dept VARCHAR(50),
    responsible_id INTEGER,
    due_date DATE,
    status VARCHAR(20) DEFAULT 'OPEN',             -- OPEN/CLOSED
    closed_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (acceptance_id) REFERENCES acceptance_records(id),
    FOREIGN KEY (responsible_id) REFERENCES employees(id)
);

-- ============================================
-- 3. BOM与采购表
-- ============================================

-- BOM表
CREATE TABLE bom (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    machine_id INTEGER NOT NULL,
    material_id INTEGER,                           -- 关联物料主数据（可空，非标件）
    material_code VARCHAR(30),                     -- 物料编码
    material_name VARCHAR(100) NOT NULL,
    specification TEXT,
    quantity DECIMAL(10,2) NOT NULL,
    unit VARCHAR(10),
    bom_version VARCHAR(10) DEFAULT 'V1',          -- BOM版本
    is_critical BOOLEAN DEFAULT FALSE,             -- 是否关键件
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (material_id) REFERENCES materials(id)
);

-- 采购单表
CREATE TABLE purchases (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    purchase_code VARCHAR(20) UNIQUE NOT NULL,     -- PO-250710-001
    project_id INTEGER NOT NULL,
    machine_id INTEGER,
    bom_id INTEGER,
    
    material_code VARCHAR(30),
    material_name VARCHAR(100),
    quantity DECIMAL(10,2),
    unit_price DECIMAL(10,2),
    total_amount DECIMAL(12,2),
    
    supplier_id INTEGER,
    order_date DATE,                               -- 下单日期
    expect_date DATE,                              -- 预计到货
    actual_date DATE,                              -- 实际到货
    delay_days INTEGER,                            -- 延期天数
    
    received_qty DECIMAL(10,2) DEFAULT 0,          -- 已到数量
    status VARCHAR(20) DEFAULT '待下单',            -- 待下单/已下单/部分到货/已到货
    
    is_shortage BOOLEAN DEFAULT FALSE,             -- 是否缺料预警
    shortage_level VARCHAR(10),                    -- 缺料级别
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id)
);

-- ============================================
-- 4. 外协管理表
-- ============================================

-- 外协单表
CREATE TABLE outsourcing (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    outsource_code VARCHAR(20) UNIQUE NOT NULL,    -- OT-250710-001
    project_id INTEGER NOT NULL,
    machine_id INTEGER,
    
    outsource_type VARCHAR(20),                    -- 机加工/钣金/表面处理
    supplier_id INTEGER,
    
    part_name VARCHAR(100),                        -- 零件名称
    drawing_no VARCHAR(50),                        -- 图号
    quantity INTEGER,
    unit_price DECIMAL(10,2),
    total_amount DECIMAL(12,2),
    
    order_date DATE,
    require_date DATE,                             -- 要求交期
    expect_date DATE,                              -- 供应商承诺交期
    actual_date DATE,                              -- 实际到货
    delay_days INTEGER,
    
    status VARCHAR(20) DEFAULT '待下单',
    quality_status VARCHAR(20),                    -- 质量状态
    
    remark TEXT,
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id)
);

-- ============================================
-- 5. 设计变更表 (ECN)
-- ============================================

CREATE TABLE ecn (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ecn_code VARCHAR(30) UNIQUE NOT NULL,          -- ECN-PJ250708001-01
    project_id INTEGER NOT NULL,
    machine_id INTEGER,
    
    change_type VARCHAR(20),                       -- 设计变更/需求变更/物料替代
    urgency VARCHAR(10),                           -- 紧急/重要/一般
    
    change_reason TEXT,                            -- 变更原因
    change_description TEXT,                       -- 变更内容
    affected_parts TEXT,                           -- 涉及部件
    original_design TEXT,                          -- 原设计
    new_design TEXT,                               -- 新设计
    
    -- 影响评估
    impact_bom VARCHAR(50),                        -- BOM影响
    impact_purchase VARCHAR(50),                   -- 采购影响
    impact_cost DECIMAL(10,2),                     -- 成本影响
    impact_schedule INTEGER,                       -- 交期影响(天)
    
    -- 流程
    initiator_id INTEGER,                          -- 发起人
    initiate_date DATE,
    approver_id INTEGER,                           -- 审批人
    approve_date DATE,
    status VARCHAR(20) DEFAULT '待评估',           -- 待评估/待审批/已批准/执行中/已完成
    
    remark TEXT,
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (initiator_id) REFERENCES employees(id),
    FOREIGN KEY (approver_id) REFERENCES employees(id)
);

-- ============================================
-- 6. 异常与预警表
-- ============================================

CREATE TABLE alerts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    alert_type VARCHAR(20) NOT NULL,               -- 缺料预警/逾期预警/变更通知
    alert_level VARCHAR(10),                       -- 严重/注意/提示
    
    project_id INTEGER,
    machine_id INTEGER,
    related_id INTEGER,                            -- 关联的采购单/外协单ID
    related_type VARCHAR(20),                      -- purchase/outsourcing/ecn
    
    title VARCHAR(200),
    content TEXT,
    
    is_read BOOLEAN DEFAULT FALSE,
    is_handled BOOLEAN DEFAULT FALSE,
    handler_id INTEGER,
    handle_time DATETIME,
    handle_result TEXT,
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (handler_id) REFERENCES employees(id)
);

-- 异常项目表
CREATE TABLE exceptions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    machine_id INTEGER,
    
    exception_type VARCHAR(20),                    -- 出货逾期/物料延期/设计变更/客户暂停
    exception_level VARCHAR(10),                   -- 紧急/重要/一般
    
    contract_deadline DATE,
    current_status TEXT,
    delay_days INTEGER,
    
    exception_reason TEXT,                         -- 异常原因
    responsible_dept VARCHAR(50),                  -- 责任部门
    responsible_id INTEGER,                        -- 责任人
    
    solution TEXT,                                 -- 解决措施
    expect_resolve_date DATE,                      -- 预计解决日期
    actual_resolve_date DATE,
    
    is_closed BOOLEAN DEFAULT FALSE,
    follow_up_record TEXT,                         -- 跟进记录
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (responsible_id) REFERENCES employees(id)
);

-- ============================================
-- 7. 收款管理表
-- ============================================

CREATE TABLE payments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    
    payment_node VARCHAR(50),                      -- 预付款/发货款/验收款/尾款
    payment_ratio DECIMAL(5,2),                    -- 比例%
    payment_amount DECIMAL(12,2),                  -- 金额
    
    plan_date DATE,                                -- 计划收款日期
    actual_date DATE,                              -- 实际收款日期
    
    status VARCHAR(20) DEFAULT '待收',             -- 待收/已收/逾期
    invoice_status VARCHAR(20),                    -- 开票状态
    
    remark TEXT,
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (project_id) REFERENCES projects(id)
);

-- ============================================
-- 8. 消息推送记录表
-- ============================================

CREATE TABLE message_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    message_type VARCHAR(20),                      -- 预警/通知/审批/提醒
    title VARCHAR(200),
    content TEXT,
    
    target_type VARCHAR(20),                       -- user/department/all
    target_ids TEXT,                               -- 接收人ID，逗号分隔
    
    send_time DATETIME,
    send_status VARCHAR(10),                       -- 成功/失败
    send_result TEXT,                              -- 发送结果
    
    related_type VARCHAR(20),                      -- 关联类型
    related_id INTEGER,                            -- 关联ID
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ============================================
-- 9. 系统配置表
-- ============================================

CREATE TABLE system_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key VARCHAR(50) UNIQUE NOT NULL,
    config_value TEXT,
    config_desc VARCHAR(200),
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 预置配置
INSERT INTO system_config (config_key, config_value, config_desc) VALUES
('shortage_alert_days', '3', '缺料预警提前天数'),
('overdue_alert_days', '5', '逾期预警提前天数'),
('wechat_corp_id', '', '企业微信CorpID'),
('wechat_agent_id', '', '企业微信应用AgentID'),
('wechat_secret', '', '企业微信应用Secret');

-- ============================================
-- 10. 索引优化
-- ============================================

CREATE INDEX idx_projects_stage ON projects(stage);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_health ON projects(health);
CREATE INDEX idx_projects_customer ON projects(customer_id);
CREATE INDEX idx_machines_project ON machines(project_id);
CREATE INDEX idx_purchases_project ON purchases(project_id);
CREATE INDEX idx_purchases_status ON purchases(status);
CREATE INDEX idx_outsourcing_project ON outsourcing(project_id);
CREATE INDEX idx_alerts_type ON alerts(alert_type);
CREATE INDEX idx_alerts_handled ON alerts(is_handled);
CREATE INDEX idx_deliverables_project ON project_deliverables(project_id);
CREATE INDEX idx_deliverables_milestone ON project_deliverables(milestone_id);
CREATE INDEX idx_acceptance_project ON acceptance_records(project_id);
CREATE INDEX idx_acceptance_milestone ON acceptance_records(milestone_id);
CREATE INDEX idx_acceptance_items_acceptance ON acceptance_items(acceptance_id);
CREATE INDEX idx_acceptance_issues_status ON acceptance_issues(status);
CREATE INDEX idx_wbs_template_tasks_template ON wbs_template_tasks(template_id);
CREATE INDEX idx_tasks_project ON tasks(project_id);
CREATE INDEX idx_tasks_milestone ON tasks(milestone_id);
CREATE INDEX idx_tasks_owner ON tasks(owner_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_task_deps_task ON task_dependencies(task_id);
CREATE INDEX idx_task_deps_depends ON task_dependencies(depends_on_task_id);
CREATE INDEX idx_progress_logs_task ON progress_logs(task_id);
CREATE INDEX idx_schedule_baselines_project ON schedule_baselines(project_id);
CREATE INDEX idx_baseline_tasks_baseline ON baseline_tasks(baseline_id);
CREATE INDEX idx_users_employee ON users(employee_id);
CREATE INDEX idx_user_roles_user ON user_roles(user_id);
CREATE INDEX idx_user_roles_role ON user_roles(role_id);
CREATE INDEX idx_role_permissions_role ON role_permissions(role_id);
CREATE INDEX idx_role_permissions_perm ON role_permissions(permission_id);
CREATE INDEX idx_project_members_project ON project_members(project_id);
CREATE INDEX idx_project_members_user ON project_members(user_id);
CREATE INDEX idx_permission_audits_operator ON permission_audits(operator_id);
CREATE UNIQUE INDEX idx_user_roles_unique ON user_roles(user_id, role_id);
CREATE UNIQUE INDEX idx_role_permissions_unique ON role_permissions(role_id, permission_id);
CREATE UNIQUE INDEX idx_project_members_unique ON project_members(project_id, user_id);
```

### 2.2 状态枚举定义

```python
# enums.py - 状态枚举定义

from enum import Enum

class ProjectStage(str, Enum):
    """项目阶段 - 9个"""
    S1 = "S1"  # 需求进入
    S2 = "S2"  # 需求澄清
    S3 = "S3"  # 立项评审
    S4 = "S4"  # 方案设计
    S5 = "S5"  # 采购制造
    S6 = "S6"  # 装配联调
    S7 = "S7"  # 出厂验收
    S8 = "S8"  # 现场交付
    S9 = "S9"  # 质保结项

class ProjectStatus(str, Enum):
    """流程状态 - 按阶段分组"""
    # S1 需求进入
    ST01 = "ST01"  # 待补全资料
    ST02 = "ST02"  # 需求评估中
    # S2 需求澄清
    ST03 = "ST03"  # 待安排澄清
    ST04 = "ST04"  # 澄清进行中
    ST05 = "ST05"  # 待客户确认
    # S3 立项评审
    ST06 = "ST06"  # 待评审
    ST07 = "ST07"  # 评审中
    ST08 = "ST08"  # 待签合同
    # S4 方案设计
    ST09 = "ST09"  # 方案设计中
    ST10 = "ST10"  # 设计评审中
    ST11 = "ST11"  # BOM发布中
    # S5 采购制造
    ST12 = "ST12"  # 采购下单中
    ST13 = "ST13"  # 等待到货
    ST14 = "ST14"  # 缺料阻塞
    ST15 = "ST15"  # 外协加工中
    # S6 装配联调
    ST16 = "ST16"  # 待排产
    ST17 = "ST17"  # 装配中
    ST18 = "ST18"  # 联调中
    ST19 = "ST19"  # 技术阻塞
    # S7 出厂验收
    ST20 = "ST20"  # 待FAT
    ST21 = "ST21"  # FAT进行中
    ST22 = "ST22"  # FAT整改中
    # S8 现场交付
    ST23 = "ST23"  # 待发货
    ST24 = "ST24"  # 运输中
    ST25 = "ST25"  # SAT进行中
    ST26 = "ST26"  # SAT整改中
    ST27 = "ST27"  # 待终验签字
    # S9 质保结项
    ST28 = "ST28"  # 质保服务中
    ST29 = "ST29"  # 待结项
    ST30 = "ST30"  # 已结项
    # 通用
    ST98 = "ST98"  # 客户暂停
    ST99 = "ST99"  # 项目取消

class ProjectHealth(str, Enum):
    """健康度 - 4个"""
    H1 = "H1"  # 正常 On Track
    H2 = "H2"  # 有风险 At Risk
    H3 = "H3"  # 阻塞 Blocked
    H4 = "H4"  # 已完结 Closed

class AlertLevel(str, Enum):
    """预警级别"""
    CRITICAL = "严重"
    WARNING = "注意"
    INFO = "提示"

class MilestoneStatus(str, Enum):
    """里程碑状态"""
    PENDING = "PENDING"
    IN_PROGRESS = "IN_PROGRESS"
    COMPLETED = "COMPLETED"
    BLOCKED = "BLOCKED"

class DeliverableStatus(str, Enum):
    """交付物状态"""
    DRAFT = "DRAFT"
    SUBMITTED = "SUBMITTED"
    APPROVED = "APPROVED"
    REJECTED = "REJECTED"

class AcceptanceType(str, Enum):
    """验收类型"""
    FAT = "FAT"
    SAT = "SAT"
    FINAL = "FINAL"

class AcceptanceStatus(str, Enum):
    """验收状态"""
    PENDING = "PENDING"
    IN_REVIEW = "IN_REVIEW"
    PASSED = "PASSED"
    FAILED = "FAILED"

class TaskStatus(str, Enum):
    """任务状态"""
    TODO = "TODO"
    IN_PROGRESS = "IN_PROGRESS"
    BLOCKED = "BLOCKED"
    DONE = "DONE"
    CANCELLED = "CANCELLED"

class DependencyType(str, Enum):
    """任务依赖类型"""
    FS = "FS"
    FF = "FF"
    SS = "SS"
    SF = "SF"

class DataScope(str, Enum):
    """数据权限范围"""
    ALL = "ALL"
    DEPT = "DEPT"
    PROJECT = "PROJECT"
    OWN = "OWN"
    CUSTOMER = "CUSTOMER"
```

---

### 2.3 里程碑/交付物/验收 API 端点与权限

#### API 端点（建议）

**里程碑**
- `GET /projects/{id}/milestones` 里程碑列表
- `POST /projects/{id}/milestones` 新建里程碑
- `PATCH /milestones/{id}` 更新里程碑（计划/负责人/状态）
- `POST /milestones/{id}/complete` 完成里程碑（校验交付物/验收）

**交付物模板**
- `GET /deliverable-templates` 模板列表
- `POST /deliverable-templates` 新建模板
- `PATCH /deliverable-templates/{id}` 更新模板

**项目交付物**
- `GET /projects/{id}/deliverables` 项目交付物清单
- `POST /projects/{id}/deliverables` 从模板生成交付物
- `POST /deliverables/{id}/files` 上传交付物文件
- `POST /deliverables/{id}/submit` 提交交付物
- `POST /deliverables/{id}/approve` 审批通过/驳回

**验收**
- `GET /projects/{id}/acceptances` 验收记录列表
- `POST /projects/{id}/acceptances` 新建验收（FAT/SAT/FINAL）
- `POST /acceptances/{id}/items` 添加/更新验收项
- `POST /acceptances/{id}/submit` 提交验收
- `POST /acceptances/{id}/review` 审核通过/不通过

**验收问题清单**
- `POST /acceptances/{id}/issues` 新建问题
- `PATCH /issues/{id}` 更新问题
- `POST /issues/{id}/close` 问题关闭

#### 权限矩阵（建议）

| 功能 | 项目经理 | 机械/电气/软件 | 质量 | PMC | 采购 | 客户 | 管理员 |
|------|---------|---------------|------|-----|------|------|--------|
| 里程碑维护 | R/W | R | R | R/W | R | R | R/W |
| 交付物模板维护 | R | R | R/W | R | R | R | R/W |
| 交付物提交/审批 | R | R/W | A | R | R | R | R/W |
| 验收创建与提交 | R/W | R | R/W | R | R | R | R/W |
| 验收审核 | R | R | A | R | R | R | R/W |
| 问题清单闭环 | R | R/W | A | R | R | R | R/W |

说明：R=查看，W=编辑，A=审批。

---

### 2.4 接口清单（请求/响应字段）与审批流规则

#### 2.4.1 里程碑接口

**GET /projects/{id}/milestones**  
响应字段：
- `id` 里程碑ID
- `milestone_name` 里程碑名称
- `milestone_level` L1/L2/L3
- `status` PENDING/IN_PROGRESS/COMPLETED/BLOCKED
- `plan_date` `actual_date`
- `owner_id` `accepted_required` `deliverable_required`

**POST /projects/{id}/milestones**  
请求字段：
- `milestone_name` `milestone_level` `plan_date`
- `owner_id` `acceptance_required` `deliverable_required`
响应字段：`id` `status`

**PATCH /milestones/{id}**  
请求字段（可选）：
- `plan_date` `owner_id` `status` `delay_reason`
响应字段：`id` `status`

**POST /milestones/{id}/complete**  
请求字段：`actual_date`  
响应字段：`id` `status` `completed`

#### 2.4.2 交付物模板接口

**GET /deliverable-templates**  
响应字段：
- `id` `template_code` `template_name`
- `stage` `milestone_name` `required` `file_types`

**POST /deliverable-templates**  
请求字段：
- `template_code` `template_name` `stage` `milestone_name`
- `required` `file_types` `description`
响应字段：`id`

**PATCH /deliverable-templates/{id}**  
请求字段（可选）：
- `template_name` `required` `file_types` `description`
响应字段：`id`

#### 2.4.3 项目交付物接口

**GET /projects/{id}/deliverables**  
响应字段：
- `id` `deliverable_name` `version_no`
- `status` `milestone_id` `owner_id`

**POST /projects/{id}/deliverables**  
请求字段：
- `template_id` `milestone_id` `deliverable_name` `owner_id`
响应字段：`id` `status`

**POST /deliverables/{id}/files**  
请求字段：
- `file_name` `file_url` `file_version`
响应字段：`id`

**POST /deliverables/{id}/submit**  
请求字段：
- `remark`
响应字段：`id` `status`

**POST /deliverables/{id}/approve**  
请求字段：
- `decision` APPROVED/REJECTED
- `remark`
响应字段：`id` `status`

#### 2.4.4 验收接口

**GET /projects/{id}/acceptances**  
响应字段：
- `id` `acceptance_type` `status`
- `plan_date` `actual_date` `milestone_id`

**POST /projects/{id}/acceptances**  
请求字段：
- `acceptance_type` `milestone_id` `plan_date`
响应字段：`id` `status`

**POST /acceptances/{id}/items**  
请求字段：
- `item_name` `expected_value` `actual_value` `result` `remark`
响应字段：`id`

**POST /acceptances/{id}/submit**  
请求字段：
- `summary`
响应字段：`id` `status`

**POST /acceptances/{id}/review**  
请求字段：
- `decision` PASSED/FAILED
- `summary`
响应字段：`id` `status`

#### 2.4.5 验收问题接口

**POST /acceptances/{id}/issues**  
请求字段：
- `issue_type` `description` `severity`
- `responsible_dept` `responsible_id` `due_date`
响应字段：`id` `status`

**PATCH /issues/{id}**  
请求字段（可选）：
- `description` `responsible_id` `due_date` `status`
响应字段：`id` `status`

**POST /issues/{id}/close**  
请求字段：
- `close_note`
响应字段：`id` `status`

---

### 2.5 审批流规则（交付物/验收）

#### 2.5.1 交付物审批规则

1) **提交条件**  
- 交付物必须有文件版本（`deliverable_files`）且版本号不为空。  
- 交付物关联里程碑处于 IN_PROGRESS，且未被 BLOCKED。  

2) **审批规则**  
- 质量或项目经理为审批人（按模板或里程碑指定）。  
- 审批通过：状态 `APPROVED`，里程碑可进入完成校验。  
- 驳回：状态 `REJECTED`，必须填写驳回原因。  

3) **硬约束**  
- 必交付物未 `APPROVED`，禁止里程碑完成与验收提交。  
- 交付物版本变更需关联 ECN 或备注原因。  

#### 2.5.2 验收审批规则

1) **提交条件**  
- 验收类型对应里程碑的交付物必须全部 `APPROVED`。  
- 验收项清单已填写（至少1项）。  

2) **评审规则**  
- 评审人：质量负责人或客户代表（可配置）。  
- `PASSED`：验收通过，里程碑可完成。  
- `FAILED`：自动生成问题清单，验收状态回到 `IN_REVIEW`。  

3) **问题闭环**  
- 问题清单全部关闭并验证通过后，允许重新提交验收。  
- 重要/严重问题需升级审批（项目经理 + 质量负责人）。  

---

### 2.6 JSON 示例（请求/响应/错误码）

#### 通用响应结构

```json
{
  "code": "OK",
  "message": "success",
  "data": {},
  "request_id": "req_20250712_0001"
}
```

#### 错误码定义（建议）

| code | 说明 |
|------|------|
| OK | 成功 |
| VALIDATION_ERROR | 参数校验失败 |
| UNAUTHORIZED | 未登录 |
| FORBIDDEN | 无权限 |
| NOT_FOUND | 资源不存在 |
| CONFLICT | 状态冲突 |
| BUSINESS_RULE_VIOLATION | 业务规则未满足 |
| INTERNAL_ERROR | 服务异常 |

#### GET /projects/{id}/milestones

响应示例：
```json
{
  "code": "OK",
  "message": "success",
  "data": [
    {
      "id": 101,
      "milestone_name": "设计冻结",
      "milestone_level": "L1",
      "status": "IN_PROGRESS",
      "plan_date": "2025-08-05",
      "actual_date": null,
      "owner_id": 12,
      "acceptance_required": false,
      "deliverable_required": true
    }
  ],
  "request_id": "req_20250712_0002"
}
```

#### POST /projects/{id}/milestones

请求示例：
```json
{
  "milestone_name": "FAT",
  "milestone_level": "L2",
  "plan_date": "2025-09-02",
  "owner_id": 18,
  "acceptance_required": true,
  "deliverable_required": true
}
```

响应示例：
```json
{
  "code": "OK",
  "message": "created",
  "data": {
    "id": 205,
    "status": "PENDING"
  },
  "request_id": "req_20250712_0003"
}
```

#### POST /milestones/{id}/complete

请求示例：
```json
{
  "actual_date": "2025-09-08"
}
```

成功响应：
```json
{
  "code": "OK",
  "message": "completed",
  "data": {
    "id": 205,
    "status": "COMPLETED",
    "completed": true
  },
  "request_id": "req_20250712_0004"
}
```

失败响应（交付物未齐）：
```json
{
  "code": "BUSINESS_RULE_VIOLATION",
  "message": "required deliverables not approved",
  "data": {
    "missing_deliverables": ["FAT报告", "调试报告"]
  },
  "request_id": "req_20250712_0005"
}
```

#### POST /deliverables/{id}/submit

请求示例：
```json
{
  "remark": "已上传V2版本"
}
```

响应示例：
```json
{
  "code": "OK",
  "message": "submitted",
  "data": {
    "id": 3301,
    "status": "SUBMITTED"
  },
  "request_id": "req_20250712_0006"
}
```

#### POST /deliverables/{id}/approve

请求示例：
```json
{
  "decision": "APPROVED",
  "remark": "版本符合验收要求"
}
```

响应示例：
```json
{
  "code": "OK",
  "message": "approved",
  "data": {
    "id": 3301,
    "status": "APPROVED"
  },
  "request_id": "req_20250712_0007"
}
```

#### POST /projects/{id}/acceptances

请求示例：
```json
{
  "acceptance_type": "FAT",
  "milestone_id": 205,
  "plan_date": "2025-09-05"
}
```

响应示例：
```json
{
  "code": "OK",
  "message": "created",
  "data": {
    "id": 8801,
    "status": "PENDING"
  },
  "request_id": "req_20250712_0008"
}
```

#### POST /acceptances/{id}/review

请求示例：
```json
{
  "decision": "FAILED",
  "summary": "节拍不稳定，需复测"
}
```

响应示例：
```json
{
  "code": "OK",
  "message": "reviewed",
  "data": {
    "id": 8801,
    "status": "FAILED"
  },
  "request_id": "req_20250712_0009"
}
```

#### POST /acceptances/{id}/issues

请求示例：
```json
{
  "issue_type": "性能",
  "description": "连续运行30分钟后节拍波动",
  "severity": "严重",
  "responsible_dept": "电气",
  "responsible_id": 27,
  "due_date": "2025-09-12"
}
```

响应示例：
```json
{
  "code": "OK",
  "message": "created",
  "data": {
    "id": 9901,
    "status": "OPEN"
  },
  "request_id": "req_20250712_0010"
}
```

#### POST /issues/{id}/close

请求示例：
```json
{
  "close_note": "更换驱动参数后复测通过"
}
```

响应示例：
```json
{
  "code": "OK",
  "message": "closed",
  "data": {
    "id": 9901,
    "status": "CLOSED"
  },
  "request_id": "req_20250712_0011"
}
```

---

## 第三部分：企业微信集成设计

### 3.1 企业微信能力使用规划

| 能力 | 用途 | 实现方式 |
|------|------|----------|
| **应用消息推送** | 预警通知、任务提醒、审批通知 | 调用消息发送API |
| **H5微应用** | 移动端数据填报、进度查看 | 企微内嵌H5页面 |
| **JS-SDK** | 扫码、定位、拍照上传 | 前端集成 |
| **审批流程** | ECN审批、付款审批 | 使用企微审批或自建 |
| **通讯录同步** | 人员数据同步 | 调用通讯录API |
| **OAuth登录** | 企微扫码登录Web端 | OAuth2.0认证 |

### 3.2 消息推送场景

```python
# 消息推送场景定义

MESSAGE_TEMPLATES = {
    # 缺料预警
    "shortage_alert": {
        "title": "🔴 缺料预警",
        "template": """
项目：{project_name}
机台：{machine_name}
缺料物料：{material_name}
缺口数量：{shortage_qty}
影响装配日期：{assembly_date}
预计到货：{expect_date}
延期天数：{delay_days}天

请及时处理！
        """,
        "receivers": ["pmc", "purchaser", "pm"]
    },
    
    # 逾期预警
    "overdue_alert": {
        "title": "⚠️ 交期预警",
        "template": """
项目：{project_name}
客户：{customer_name}
合同交期：{deadline}
当前阶段：{stage}
预计延期：{delay_days}天

风险原因：{risk_reason}
请关注处理！
        """,
        "receivers": ["pm", "sales", "pmc"]
    },
    
    # ECN变更通知
    "ecn_notify": {
        "title": "📋 设计变更通知",
        "template": """
变更单号：{ecn_code}
项目：{project_name}
变更类型：{change_type}
紧急程度：{urgency}

变更内容：{change_description}
影响评估：
- BOM：{impact_bom}
- 成本：{impact_cost}元
- 交期：{impact_schedule}天

请相关人员注意！
        """,
        "receivers": ["mechanical", "electrical", "purchaser", "pmc"]
    },
    
    # 外协到货提醒
    "outsource_arrival": {
        "title": "📦 外协到货通知",
        "template": """
外协单号：{outsource_code}
项目：{project_name}
供应商：{supplier_name}
零件：{part_name}
数量：{quantity}

请安排验收入库！
        """,
        "receivers": ["warehouse", "quality"]
    },
    
    # 收款提醒
    "payment_reminder": {
        "title": "💰 收款提醒",
        "template": """
项目：{project_name}
客户：{customer_name}
收款节点：{payment_node}
应收金额：{amount}元
计划日期：{plan_date}

请跟进收款！
        """,
        "receivers": ["sales", "finance"]
    },
    
    # 任务分配通知
    "task_assign": {
        "title": "📝 任务分配",
        "template": """
项目：{project_name}
任务：{task_name}
要求完成：{deadline}

请及时处理！
        """,
        "receivers": ["assignee"]
    }
}
```

### 3.3 企业微信API封装

```python
# wechat/client.py - 企业微信API封装

import httpx
import json
from datetime import datetime, timedelta
from typing import List, Optional
import logging

logger = logging.getLogger(__name__)

class WeChatWorkClient:
    """企业微信API客户端"""
    
    BASE_URL = "https://qyapi.weixin.qq.com/cgi-bin"
    
    def __init__(self, corp_id: str, agent_id: str, secret: str):
        self.corp_id = corp_id
        self.agent_id = agent_id
        self.secret = secret
        self._access_token = None
        self._token_expires_at = None
    
    async def get_access_token(self) -> str:
        """获取access_token（带缓存）"""
        if self._access_token and self._token_expires_at > datetime.now():
            return self._access_token
        
        async with httpx.AsyncClient() as client:
            resp = await client.get(
                f"{self.BASE_URL}/gettoken",
                params={
                    "corpid": self.corp_id,
                    "corpsecret": self.secret
                }
            )
            data = resp.json()
            
            if data.get("errcode") == 0:
                self._access_token = data["access_token"]
                self._token_expires_at = datetime.now() + timedelta(seconds=data["expires_in"] - 300)
                return self._access_token
            else:
                raise Exception(f"获取access_token失败: {data}")
    
    async def send_message(
        self,
        user_ids: List[str],
        content: str,
        msg_type: str = "text"
    ) -> dict:
        """
        发送应用消息
        
        Args:
            user_ids: 接收者UserID列表
            content: 消息内容
            msg_type: 消息类型 text/textcard/markdown
        """
        token = await self.get_access_token()
        
        message = {
            "touser": "|".join(user_ids),
            "msgtype": msg_type,
            "agentid": self.agent_id,
        }
        
        if msg_type == "text":
            message["text"] = {"content": content}
        elif msg_type == "markdown":
            message["markdown"] = {"content": content}
        elif msg_type == "textcard":
            # textcard需要特殊格式
            message["textcard"] = content
        
        async with httpx.AsyncClient() as client:
            resp = await client.post(
                f"{self.BASE_URL}/message/send",
                params={"access_token": token},
                json=message
            )
            result = resp.json()
            
            logger.info(f"消息发送结果: {result}")
            return result
    
    async def send_card_message(
        self,
        user_ids: List[str],
        title: str,
        description: str,
        url: str,
        btn_txt: str = "详情"
    ) -> dict:
        """发送卡片消息"""
        token = await self.get_access_token()
        
        message = {
            "touser": "|".join(user_ids),
            "msgtype": "textcard",
            "agentid": self.agent_id,
            "textcard": {
                "title": title,
                "description": description,
                "url": url,
                "btntxt": btn_txt
            }
        }
        
        async with httpx.AsyncClient() as client:
            resp = await client.post(
                f"{self.BASE_URL}/message/send",
                params={"access_token": token},
                json=message
            )
            return resp.json()
    
    async def send_markdown_message(
        self,
        user_ids: List[str],
        content: str
    ) -> dict:
        """发送Markdown消息（企微支持的Markdown子集）"""
        return await self.send_message(user_ids, content, msg_type="markdown")
    
    async def get_user_info(self, user_id: str) -> dict:
        """获取用户信息"""
        token = await self.get_access_token()
        
        async with httpx.AsyncClient() as client:
            resp = await client.get(
                f"{self.BASE_URL}/user/get",
                params={
                    "access_token": token,
                    "userid": user_id
                }
            )
            return resp.json()
    
    async def get_department_users(self, dept_id: int) -> List[dict]:
        """获取部门成员"""
        token = await self.get_access_token()
        
        async with httpx.AsyncClient() as client:
            resp = await client.get(
                f"{self.BASE_URL}/user/simplelist",
                params={
                    "access_token": token,
                    "department_id": dept_id
                }
            )
            data = resp.json()
            return data.get("userlist", [])


# 使用示例
async def send_shortage_alert(project, material, shortage_info):
    """发送缺料预警"""
    from config import settings
    
    client = WeChatWorkClient(
        corp_id=settings.WECHAT_CORP_ID,
        agent_id=settings.WECHAT_AGENT_ID,
        secret=settings.WECHAT_SECRET
    )
    
    content = f"""🔴 **缺料预警**
    
> 项目：{project.project_name}
> 物料：{material.material_name}
> 缺口：{shortage_info.shortage_qty}
> 影响日期：{shortage_info.affect_date}

请及时处理！[查看详情]({settings.BASE_URL}/shortage/{shortage_info.id})
"""
    
    # 获取相关人员的企微UserID
    user_ids = [
        project.pmc.wechat_userid,
        project.pm.wechat_userid
    ]
    user_ids = [uid for uid in user_ids if uid]  # 过滤空值
    
    if user_ids:
        await client.send_markdown_message(user_ids, content)
```

### 3.4 H5应用页面规划

```
企微工作台入口
    │
    ├── 📊 项目看板
    │   ├── 全部项目列表（可筛选）
    │   ├── 项目详情页
    │   └── 快速更新进度
    │
    ├── ⚠️ 预警中心
    │   ├── 缺料预警
    │   ├── 逾期预警
    │   └── 一键处理
    │
    ├── 📝 进度填报
    │   ├── 选择项目/机台
    │   ├── 更新阶段状态
    │   ├── 上传现场照片
    │   └── 填写备注
    │
    ├── 📦 到货确认
    │   ├── 扫码确认到货
    │   ├── 录入到货数量
    │   └── 问题反馈
    │
    ├── 🔧 外协跟踪
    │   ├── 外协单列表
    │   ├── 进度更新
    │   └── 催货记录
    │
    └── 👤 我的
        ├── 我的任务
        ├── 我的项目
        └── 消息记录
```

---

## 第四部分：项目目录结构

```
project-management-system/
│
├── backend/                          # 后端代码
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py                   # FastAPI入口
│   │   ├── config.py                 # 配置文件
│   │   ├── database.py               # 数据库连接
│   │   │
│   │   ├── models/                   # 数据模型
│   │   │   ├── __init__.py
│   │   │   ├── customer.py
│   │   │   ├── project.py
│   │   │   ├── machine.py
│   │   │   ├── purchase.py
│   │   │   ├── outsourcing.py
│   │   │   ├── ecn.py
│   │   │   └── alert.py
│   │   │
│   │   ├── schemas/                  # Pydantic模型
│   │   │   ├── __init__.py
│   │   │   ├── project.py
│   │   │   ├── purchase.py
│   │   │   └── ...
│   │   │
│   │   ├── routers/                  # API路由
│   │   │   ├── __init__.py
│   │   │   ├── projects.py
│   │   │   ├── machines.py
│   │   │   ├── purchases.py
│   │   │   ├── outsourcing.py
│   │   │   ├── ecn.py
│   │   │   ├── alerts.py
│   │   │   └── reports.py
│   │   │
│   │   ├── services/                 # 业务逻辑
│   │   │   ├── __init__.py
│   │   │   ├── project_service.py
│   │   │   ├── alert_service.py      # 预警服务
│   │   │   ├── shortage_service.py   # 缺料检测
│   │   │   └── report_service.py
│   │   │
│   │   ├── wechat/                   # 企微集成
│   │   │   ├── __init__.py
│   │   │   ├── client.py             # API客户端
│   │   │   ├── message.py            # 消息发送
│   │   │   ├── oauth.py              # OAuth登录
│   │   │   └── templates.py          # 消息模板
│   │   │
│   │   ├── tasks/                    # 定时任务
│   │   │   ├── __init__.py
│   │   │   ├── scheduler.py
│   │   │   ├── shortage_check.py     # 缺料检查
│   │   │   ├── overdue_check.py      # 逾期检查
│   │   │   └── daily_report.py       # 日报生成
│   │   │
│   │   └── utils/                    # 工具函数
│   │       ├── __init__.py
│   │       ├── code_generator.py     # 编码生成
│   │       └── date_utils.py
│   │
│   ├── tests/                        # 测试
│   │   └── ...
│   │
│   ├── alembic/                      # 数据库迁移
│   │   └── ...
│   │
│   ├── requirements.txt
│   ├── Dockerfile
│   └── docker-compose.yml
│
├── frontend/                         # 前端代码
│   ├── web/                          # Web管理端
│   │   ├── public/
│   │   ├── src/
│   │   │   ├── views/
│   │   │   ├── components/
│   │   │   ├── api/
│   │   │   └── ...
│   │   └── package.json
│   │
│   └── h5/                           # 企微H5端
│       ├── public/
│       ├── src/
│       │   ├── pages/
│       │   ├── components/
│       │   └── ...
│       └── package.json
│
├── docs/                             # 文档
│   ├── api.md
│   ├── database.md
│   └── deployment.md
│
├── scripts/                          # 脚本
│   ├── init_db.py                    # 初始化数据库
│   ├── import_data.py                # 导入历史数据
│   └── backup.sh                     # 备份脚本
│
├── nginx/                            # Nginx配置
│   └── nginx.conf
│
├── .env.example                      # 环境变量示例
├── docker-compose.yml                # Docker编排
└── README.md
```

---

## 第五部分：开发路线图

### 5.1 阶段划分

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              开发路线图                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Phase 0          Phase 1           Phase 2           Phase 3                  │
│  基础搭建         核心功能           协同功能           高级功能                  │
│  (2周)            (6周)             (6周)             (6周)                     │
│                                                                                 │
│  ┌─────┐         ┌─────────┐       ┌─────────┐       ┌─────────┐              │
│  │Week │         │Week 3-8 │       │Week 9-14│       │Week15-20│              │
│  │ 1-2 │         │         │       │         │       │         │              │
│  └──┬──┘         └────┬────┘       └────┬────┘       └────┬────┘              │
│     │                 │                 │                 │                    │
│     ▼                 ▼                 ▼                 ▼                    │
│  · 项目结构        · 项目CRUD        · ECN变更管理     · 售后工单              │
│  · 数据库设计      · 机台管理        · 外协管理        · 项目复盘              │
│  · FastAPI基础     · BOM管理         · 资源排程        · 知识库                │
│  · 企微对接测试    · 采购管理        · 收款管理        · 成本核算              │
│                   · 缺料预警        · 完整H5端        · BI看板                │
│                   · 基础消息推送    · 审批流程                                 │
│                   · 简单Web页面                                               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Phase 0 详细任务（第1-2周）

| 天 | 任务 | 交付物 |
|----|------|--------|
| D1 | 创建项目结构，配置开发环境 | 可运行的FastAPI项目 |
| D2 | 数据库设计，创建所有表 | SQLite数据库文件 |
| D3 | 基础模型定义（SQLAlchemy） | models/*.py |
| D4 | 企微应用配置，获取token测试 | 企微API对接成功 |
| D5 | 发送第一条测试消息 | 消息推送成功 |
| D6 | API基础框架，认证中间件 | 可访问的API |
| D7 | 部署测试环境 | 内网可访问 |

### 5.3 Phase 1 详细任务（第3-8周）

**Week 3-4: 项目与机台管理**
- 项目CRUD API
- 机台CRUD API  
- 三维状态管理
- 里程碑管理
- 简单Web列表页

**Week 5-6: BOM与采购管理**
- BOM录入/导入
- 采购单生成
- 到货管理
- 齐套率计算

**Week 7-8: 预警与消息**
- 缺料检测逻辑
- 逾期检测逻辑
- 定时任务
- 企微消息推送
- 预警列表页面

---

## 第六部分：第一个可运行Demo

我会在下一步给你提供：

1. **完整的项目初始化代码**
2. **数据库初始化脚本**
3. **企微消息推送示例**
4. **缺料预警定时任务**

这样你可以快速搭建起第一个可运行的系统雏形。

---

**准备好开始写代码了吗？**

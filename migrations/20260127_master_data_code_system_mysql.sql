-- ============================================
-- 主数据编码体系统一迁移脚本 (MySQL)
-- 日期: 2026-01-27
-- 说明: 统一主数据编码格式，新编码将自动生成新格式
-- ============================================

-- 注意：此迁移脚本主要用于文档化编码体系变化
-- 现有数据可以保持原样，新创建的数据将使用新格式

-- ============================================
-- 编码规则说明
-- ============================================
-- 1. 员工编号：EMP-xxxxx (如 EMP-00001)
-- 2. 客户编号：CUS-xxxxxxx (如 CUS-0000001)
-- 3. 物料编号：MAT-{类别}-xxxxx (如 MAT-ME-00001)
-- 4. 项目编号：PJyymmddxxx (保持不变，如 PJ250708001)
-- 5. 设备编号：PJxxx-PNxxx (保持不变，如 PJ250708001-PN001)

-- ============================================
-- 可选：转换现有员工编码（如果需要）
-- ============================================
-- 如果现有员工编码格式为 E0001 或 EMP0001，可以转换为 EMP-00001
-- 注意：执行前请备份数据库！

-- 示例转换SQL（根据实际情况调整）：
-- UPDATE employees 
-- SET employee_code = CONCAT('EMP-', LPAD(SUBSTRING(employee_code, -5), 5, '0'))
-- WHERE employee_code NOT LIKE 'EMP-%'
--   AND (employee_code LIKE 'E%' OR employee_code LIKE 'EMP%');

-- ============================================
-- 可选：转换现有客户编码（如果需要）
-- ============================================
-- 如果现有客户编码不符合 CUS-xxxxxxx 格式，可以转换
-- 注意：执行前请备份数据库！

-- 示例转换SQL（根据实际情况调整）：
-- 此转换需要根据实际客户编码格式编写

-- ============================================
-- 可选：转换现有物料编码（如果需要）
-- ============================================
-- 如果现有物料编码不符合 MAT-{类别}-xxxxx 格式，可以转换
-- 注意：执行前请备份数据库！

-- 示例转换SQL（根据实际情况调整）：
-- 此转换需要根据实际物料编码格式和类别信息编写

-- ============================================
-- 验证唯一性约束
-- ============================================
-- 确保所有编码字段的唯一性约束已存在

-- 员工编码唯一性（如果不存在）
-- ALTER TABLE employees ADD UNIQUE INDEX IF NOT EXISTS idx_employees_code_unique (employee_code);

-- 客户编码唯一性（如果不存在）
-- ALTER TABLE customers ADD UNIQUE INDEX IF NOT EXISTS idx_customers_code_unique (customer_code);

-- 物料编码唯一性（如果不存在）
-- ALTER TABLE materials ADD UNIQUE INDEX IF NOT EXISTS idx_materials_code_unique (material_code);

-- ============================================
-- 完成
-- ============================================
-- 迁移完成。新创建的数据将自动使用新格式编码。

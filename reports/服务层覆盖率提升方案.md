# æœåŠ¡å±‚è¦†ç›–ç‡æå‡æ–¹æ¡ˆ

**ç”Ÿæˆæ—¶é—´**: 2026-01-21  
**å½“å‰çŠ¶æ€**: æœåŠ¡å±‚è¦†ç›–ç‡ 8.87%ï¼Œ150 ä¸ªé›¶è¦†ç›–ç‡æœåŠ¡æ–‡ä»¶

---

## ğŸ” é—®é¢˜åˆ†æ

### ä¸ºä»€ä¹ˆæœåŠ¡å±‚è¦†ç›–ç‡è¿™ä¹ˆä½ï¼Ÿ

#### 1. **æµ‹è¯•æ–‡ä»¶ç”Ÿæˆäº†ä½†æœªå®ç°** âš ï¸

**ç°çŠ¶**:
- âœ… å·²ç”Ÿæˆæµ‹è¯•æ–‡ä»¶: 97+ ä¸ª
- âŒ å®é™…å®ç°æµ‹è¯•: ä»… 6 ä¸ªæœåŠ¡ï¼ˆçº¦ 6%ï¼‰
- â³ å¾…å®ç°æµ‹è¯•: 91+ ä¸ªæœåŠ¡

**é—®é¢˜è¡¨ç°**:
```python
# å…¸å‹çš„æœªå®ç°æµ‹è¯•æ–‡ä»¶
def test_method(self, service):
    """æµ‹è¯• method æ–¹æ³•"""
    # TODO: å®ç°æµ‹è¯•é€»è¾‘
    pass  # âŒ æ²¡æœ‰å®é™…æµ‹è¯•ä»£ç 
```

#### 2. **æœåŠ¡æ–‡ä»¶å¤æ‚ï¼Œæµ‹è¯•å®ç°å›°éš¾** ğŸ§©

**æŒ‘æˆ˜**:
- **ä¾èµ–å¤æ‚**: éœ€è¦ mock æ•°æ®åº“ã€å…¶ä»–æœåŠ¡ã€å¤–éƒ¨åº“
- **ä¸šåŠ¡é€»è¾‘å¤æ‚**: å•ä¸ªæœåŠ¡æ–‡ä»¶ 200-300 è¡Œï¼ŒåŒ…å«å¤šä¸ªæ–¹æ³•
- **å¤–éƒ¨ä¾èµ–**: Excel ç”Ÿæˆã€PDF å¯¼å‡ºã€ç¬¬ä¸‰æ–¹ API è°ƒç”¨

**ç¤ºä¾‹**:
```python
# timesheet_report_service.py (290è¡Œ)
class TimesheetReportService:
    def __init__(self, db: Session):
        self.db = db
        self.aggregation_service = TimesheetAggregationService(db)  # ä¾èµ–æœåŠ¡
        self.overtime_service = OvertimeCalculationService(db)       # ä¾èµ–æœåŠ¡
    
    def generate_hr_report_excel(...):
        # éœ€è¦ mock: db.query, Excel åº“, ä¾èµ–æœåŠ¡
        # éœ€è¦éªŒè¯: Excel æ–‡ä»¶æ ¼å¼ã€æ•°æ®è®¡ç®—
```

#### 3. **ç¼ºä¹ç³»ç»ŸåŒ–çš„å®ç°ç­–ç•¥** ğŸ“‹

**é—®é¢˜**:
- è™½ç„¶æœ‰ä¼˜å…ˆçº§åˆ—è¡¨ï¼Œä½†æ‰§è¡Œä¸å¤Ÿç³»ç»ŸåŒ–
- æ²¡æœ‰ç»Ÿä¸€çš„æµ‹è¯•ç¼–å†™æ¨¡å¼å’Œæ¨¡æ¿
- ç¼ºä¹æµ‹è¯•è¾…åŠ©å·¥å…·å’Œ fixture

#### 4. **æµ‹è¯•æ•°æ®å‡†å¤‡å›°éš¾** ğŸ—„ï¸

**æŒ‘æˆ˜**:
- éœ€è¦åˆ›å»ºå¤æ‚çš„æµ‹è¯•æ•°æ®ï¼ˆé¡¹ç›®ã€ç”¨æˆ·ã€å·¥æ—¶ç­‰ï¼‰
- æ•°æ®åº“ mock è®¾ç½®å¤æ‚
- ç¼ºä¹å¯å¤ç”¨çš„æµ‹è¯•æ•°æ®å·¥å‚

---

## ğŸ¯ æå‡æ–¹æ¡ˆ

### é˜¶æ®µ1: å»ºç«‹æµ‹è¯•åŸºç¡€è®¾æ–½ï¼ˆ1-2å¤©ï¼‰

#### 1.1 åˆ›å»ºæµ‹è¯•è¾…åŠ©å·¥å…·

**æ–‡ä»¶**: `tests/conftest.py` æˆ– `tests/fixtures/`

```python
# tests/conftest.py
import pytest
from unittest.mock import MagicMock
from sqlalchemy.orm import Session

@pytest.fixture
def db_session():
    """æä¾›æ¨¡æ‹Ÿæ•°æ®åº“ä¼šè¯"""
    return MagicMock(spec=Session)

@pytest.fixture
def mock_user():
    """åˆ›å»ºæ¨¡æ‹Ÿç”¨æˆ·"""
    user = MagicMock()
    user.id = 1
    user.username = "test_user"
    user.real_name = "æµ‹è¯•ç”¨æˆ·"
    return user

@pytest.fixture
def mock_project():
    """åˆ›å»ºæ¨¡æ‹Ÿé¡¹ç›®"""
    project = MagicMock()
    project.id = 1
    project.project_code = "PJ260101001"
    project.project_name = "æµ‹è¯•é¡¹ç›®"
    return project
```

#### 1.2 åˆ›å»ºæµ‹è¯•æ¨¡æ¿

**æ–‡ä»¶**: `tests/templates/test_service_template.py`

```python
"""
æœåŠ¡æµ‹è¯•æ¨¡æ¿
å¤åˆ¶æ­¤æ¨¡æ¿åˆ›å»ºæ–°æœåŠ¡çš„æµ‹è¯•æ–‡ä»¶
"""

import pytest
from unittest.mock import MagicMock, patch
from sqlalchemy.orm import Session

# å¯¼å…¥è¦æµ‹è¯•çš„æœåŠ¡
# from app.services.your_service import YourService


class TestYourService:
    """YourService æµ‹è¯•ç±»"""

    @pytest.fixture
    def db_session(self):
        """æ¨¡æ‹Ÿæ•°æ®åº“ä¼šè¯"""
        return MagicMock(spec=Session)

    @pytest.fixture
    def service(self, db_session):
        """åˆ›å»ºæœåŠ¡å®ä¾‹"""
        # return YourService(db_session)
        pass

    # ==================== åˆå§‹åŒ–æµ‹è¯• ====================
    
    def test_init(self, db_session):
        """æµ‹è¯•æœåŠ¡åˆå§‹åŒ–"""
        # service = YourService(db_session)
        # assert service is not None
        pass

    # ==================== æ ¸å¿ƒæ–¹æ³•æµ‹è¯• ====================
    
    def test_method_success(self, service):
        """æµ‹è¯• method - æˆåŠŸåœºæ™¯"""
        # 1. å‡†å¤‡æµ‹è¯•æ•°æ®
        # 2. Mock ä¾èµ–
        # 3. è°ƒç”¨æ–¹æ³•
        # 4. éªŒè¯ç»“æœ
        pass

    def test_method_not_found(self, service):
        """æµ‹è¯• method - èµ„æºä¸å­˜åœ¨"""
        pass

    def test_method_invalid_input(self, service):
        """æµ‹è¯• method - æ— æ•ˆè¾“å…¥"""
        pass

    def test_method_edge_case(self, service):
        """æµ‹è¯• method - è¾¹ç•Œæ¡ä»¶"""
        pass
```

#### 1.3 åˆ›å»ºæµ‹è¯•æ•°æ®å·¥å‚

**æ–‡ä»¶**: `tests/factories.py` (å·²å­˜åœ¨ï¼Œéœ€è¦æ‰©å±•)

```python
# æ‰©å±• factories.pyï¼Œæ·»åŠ æ›´å¤šæœåŠ¡æµ‹è¯•éœ€è¦çš„å·¥å‚æ–¹æ³•
def create_mock_timesheet_data():
    """åˆ›å»ºæ¨¡æ‹Ÿå·¥æ—¶æ•°æ®"""
    return {
        'user_id': 1,
        'user_name': 'æµ‹è¯•ç”¨æˆ·',
        'normal_hours': 160.0,
        'overtime_hours': 10.0,
        'weekend_hours': 8.0,
        'holiday_hours': 4.0,
    }
```

---

### é˜¶æ®µ2: ç³»ç»ŸåŒ–å®ç°æµ‹è¯•ï¼ˆæŒç»­è¿›è¡Œï¼‰

#### 2.1 ä¼˜å…ˆçº§æ’åº

**é«˜ä¼˜å…ˆçº§ï¼ˆå‰30ä¸ªï¼ŒæŒ‰ä»£ç é‡ï¼‰**:

| åºå· | æœåŠ¡åç§° | ä»£ç è¡Œæ•° | çŠ¶æ€ | é¢„è®¡æµ‹è¯•ç”¨ä¾‹ |
|------|---------|---------|------|-------------|
| 1 | timesheet_report_service | 290 | â³ | 15-20 |
| 2 | win_rate_prediction_service | 200 | â³ | 12-15 |
| 3 | report_export_service | 193 | â³ | 10-12 |
| 4 | hr_profile_import_service | 187 | â³ | 10-12 |
| 5 | metric_calculation_service | 181 | âœ… | å·²å®Œæˆ |
| 6 | cost_collection_service | 180 | âœ… | å·²å®Œæˆ |
| 7 | invoice_auto_service | 179 | âœ… | å·²å®Œæˆ |
| 8 | collaboration_rating_service | 172 | âœ… | å·²å®Œæˆ |
| 9 | timesheet_reminder_service | 172 | â³ | 8-10 |
| 10 | timesheet_sync_service | 171 | â³ | 8-10 |

#### 2.2 æµ‹è¯•å®ç°æ­¥éª¤

**æ¯ä¸ªæœåŠ¡çš„å®ç°æµç¨‹**:

```bash
# æ­¥éª¤1: åˆ†ææœåŠ¡ä»£ç 
cat app/services/timesheet_report_service.py

# æ­¥éª¤2: æŸ¥çœ‹ç°æœ‰æµ‹è¯•æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
cat tests/unit/test_timesheet_report_service*.py

# æ­¥éª¤3: å®ç°æµ‹è¯•ç”¨ä¾‹
# - åˆå§‹åŒ–æµ‹è¯•
# - æ ¸å¿ƒæ–¹æ³•æµ‹è¯•ï¼ˆæˆåŠŸåœºæ™¯ï¼‰
# - é”™è¯¯åœºæ™¯æµ‹è¯•
# - è¾¹ç•Œæ¡ä»¶æµ‹è¯•

# æ­¥éª¤4: è¿è¡Œæµ‹è¯•
pytest tests/unit/test_timesheet_report_service*.py -v

# æ­¥éª¤5: æ£€æŸ¥è¦†ç›–ç‡
pytest tests/unit/test_timesheet_report_service*.py \
    --cov=app/services/timesheet_report_service \
    --cov-report=term-missing

# æ­¥éª¤6: ä¿®å¤é—®é¢˜ï¼Œæå‡è¦†ç›–ç‡è‡³ 60%+
```

#### 2.3 æµ‹è¯•ç¼–å†™æ¨¡å¼

**æ¨¡å¼1: åˆå§‹åŒ–æµ‹è¯•**
```python
def test_init(self, db_session):
    """æµ‹è¯•æœåŠ¡åˆå§‹åŒ–"""
    service = TimesheetReportService(db_session)
    assert service.db == db_session
    assert service.aggregation_service is not None
```

**æ¨¡å¼2: æˆåŠŸåœºæ™¯æµ‹è¯•**
```python
def test_generate_hr_report_success(self, service):
    """æµ‹è¯•ç”ŸæˆHRæŠ¥è¡¨ - æˆåŠŸ"""
    with patch.object(service.aggregation_service, 'generate_hr_report') as mock:
        mock.return_value = [create_mock_timesheet_data()]
        result = service.generate_hr_report_excel(2026, 1)
        assert result is not None
        assert hasattr(result, 'read')
```

**æ¨¡å¼3: é”™è¯¯åœºæ™¯æµ‹è¯•**
```python
def test_generate_hr_report_empty_data(self, service):
    """æµ‹è¯•ç”ŸæˆHRæŠ¥è¡¨ - ç©ºæ•°æ®"""
    with patch.object(service.aggregation_service, 'generate_hr_report') as mock:
        mock.return_value = []
        result = service.generate_hr_report_excel(2026, 1)
        assert result is not None  # åº”è¯¥è¿”å›ç©ºæŠ¥è¡¨è€Œä¸æ˜¯æŠ¥é”™
```

**æ¨¡å¼4: è¾¹ç•Œæ¡ä»¶æµ‹è¯•**
```python
def test_generate_hr_report_invalid_month(self, service):
    """æµ‹è¯•ç”ŸæˆHRæŠ¥è¡¨ - æ— æ•ˆæœˆä»½"""
    with pytest.raises(ValueError):
        service.generate_hr_report_excel(2026, 13)
```

---

### é˜¶æ®µ3: æ‰¹é‡å®ç°ç­–ç•¥

#### 3.1 æ¯å‘¨ç›®æ ‡

**ç¬¬ä¸€å‘¨**:
- å®ç° 5-8 ä¸ªé«˜ä¼˜å…ˆçº§æœåŠ¡
- æ–°å¢ 80-120 ä¸ªæµ‹è¯•ç”¨ä¾‹
- æœåŠ¡å±‚è¦†ç›–ç‡æå‡è‡³ 15-18%

**ç¬¬äºŒå‘¨**:
- å®ç° 8-10 ä¸ªæœåŠ¡
- æ–°å¢ 100-150 ä¸ªæµ‹è¯•ç”¨ä¾‹
- æœåŠ¡å±‚è¦†ç›–ç‡æå‡è‡³ 25-30%

**ç¬¬ä¸‰å‘¨**:
- å®ç° 10-12 ä¸ªæœåŠ¡
- æ–°å¢ 120-180 ä¸ªæµ‹è¯•ç”¨ä¾‹
- æœåŠ¡å±‚è¦†ç›–ç‡æå‡è‡³ 35-40%

#### 3.2 å¿«é€Ÿå®ç°æŠ€å·§

**æŠ€å·§1: å…ˆå®ç°æ ¸å¿ƒæ–¹æ³•**
- æ¯ä¸ªæœåŠ¡å…ˆå®ç° 3-5 ä¸ªæ ¸å¿ƒæ–¹æ³•çš„æµ‹è¯•
- ç¡®ä¿æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æœ‰è¦†ç›–
- åç»­å†è¡¥å……è¾¹ç•Œå’Œå¼‚å¸¸æµ‹è¯•

**æŠ€å·§2: å¤ç”¨æµ‹è¯•æ¨¡å¼**
- ç›¸ä¼¼çš„æœåŠ¡å¤ç”¨ç›¸åŒçš„æµ‹è¯•æ¨¡å¼
- ä½¿ç”¨æµ‹è¯•æ¨¡æ¿å¿«é€Ÿåˆ›å»ºæµ‹è¯•æ¡†æ¶
- å…±äº« fixture å’Œè¾…åŠ©å‡½æ•°

**æŠ€å·§3: ä½¿ç”¨æµ‹è¯•ç”Ÿæˆå·¥å…·**
- åˆ©ç”¨ç°æœ‰çš„ `generate_service_tests_batch.py`
- ç”Ÿæˆæµ‹è¯•æ¡†æ¶åï¼Œå¿«é€Ÿå¡«å……æµ‹è¯•é€»è¾‘
- æ‰¹é‡å¤„ç†ç›¸ä¼¼çš„æœåŠ¡

---

## ğŸ“Š é¢„æœŸæˆæœ

### è¦†ç›–ç‡ç›®æ ‡

| æŒ‡æ ‡ | å½“å‰ | 1å‘¨å | 2å‘¨å | 3å‘¨å | æœ€ç»ˆç›®æ ‡ |
|------|------|-------|-------|-------|---------|
| æ€»ä½“è¦†ç›–ç‡ | 39.07% | 42% | 45% | 48% | 60%+ |
| æœåŠ¡å±‚è¦†ç›–ç‡ | 8.87% | 15% | 25% | 35% | 60%+ |
| é›¶è¦†ç›–ç‡æœåŠ¡ | 150 | 120 | 80 | 40 | <20 |

### æµ‹è¯•æ–‡ä»¶ç›®æ ‡

- **æ–°å¢å®ç°æµ‹è¯•**: 30-40 ä¸ªæœåŠ¡
- **æ–°å¢æµ‹è¯•ç”¨ä¾‹**: 400-600 ä¸ª
- **æµ‹è¯•é€šè¿‡ç‡**: >95%

---

## ğŸ› ï¸ å®æ–½å»ºè®®

### ç«‹å³è¡ŒåŠ¨ï¼ˆä»Šå¤©ï¼‰

1. **åˆ›å»ºæµ‹è¯•åŸºç¡€è®¾æ–½**
   ```bash
   # åˆ›å»ºæµ‹è¯•è¾…åŠ©æ–‡ä»¶
   touch tests/conftest.py
   touch tests/templates/test_service_template.py
   ```

2. **é€‰æ‹©ç¬¬ä¸€ä¸ªæœåŠ¡å¼€å§‹å®ç°**
   - å»ºè®®ä» `timesheet_report_service` å¼€å§‹ï¼ˆå·²æœ‰éƒ¨åˆ†æµ‹è¯•ï¼‰
   - æˆ–é€‰æ‹©ç›¸å¯¹ç®€å•çš„æœåŠ¡ï¼ˆå¦‚ `timesheet_reminder_service`ï¼‰

3. **å®ç° 1-2 ä¸ªæœåŠ¡çš„å®Œæ•´æµ‹è¯•**
   - ç›®æ ‡: æ¯ä¸ªæœåŠ¡ 10-15 ä¸ªæµ‹è¯•ç”¨ä¾‹
   - è¦†ç›–ç‡ç›®æ ‡: 60%+

### æœ¬å‘¨è®¡åˆ’

1. **æ¯å¤©å®ç° 1-2 ä¸ªæœåŠ¡**
2. **æ¯å¤©æ–°å¢ 15-25 ä¸ªæµ‹è¯•ç”¨ä¾‹**
3. **æ¯å¤©è¿è¡Œæµ‹è¯•éªŒè¯**
4. **æ¯å‘¨äº”æ£€æŸ¥è¦†ç›–ç‡æå‡**

### å·¥å…·å’Œè„šæœ¬

**è¿è¡Œè¦†ç›–ç‡æ£€æŸ¥**:
```bash
# æ£€æŸ¥æœåŠ¡å±‚è¦†ç›–ç‡
python3 scripts/analyze_zero_coverage_services.py

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/unit/ -v

# æ£€æŸ¥ç‰¹å®šæœåŠ¡è¦†ç›–ç‡
pytest tests/unit/test_timesheet_report_service*.py \
    --cov=app/services/timesheet_report_service \
    --cov-report=term-missing
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æµ‹è¯•ç¼–å†™åŸåˆ™

- âœ… **å…ˆæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½**: ç¡®ä¿ä¸»è¦ä¸šåŠ¡é€»è¾‘æœ‰è¦†ç›–
- âœ… **æµ‹è¯•è¾¹ç•Œæ¡ä»¶**: ç©ºå€¼ã€æœ€å¤§å€¼ã€æ— æ•ˆè¾“å…¥
- âœ… **æµ‹è¯•é”™è¯¯å¤„ç†**: å¼‚å¸¸æƒ…å†µã€èµ„æºä¸å­˜åœ¨
- âœ… **ä¿æŒæµ‹è¯•ç‹¬ç«‹**: æ¯ä¸ªæµ‹è¯•ä¸ä¾èµ–å…¶ä»–æµ‹è¯•
- âœ… **ä½¿ç”¨æè¿°æ€§åç§°**: `test_method_success` è€Œä¸æ˜¯ `test1`

### 2. Mock ä½¿ç”¨æŒ‡å—

- âœ… **Mock å¤–éƒ¨ä¾èµ–**: æ•°æ®åº“ã€å…¶ä»–æœåŠ¡ã€å¤–éƒ¨ API
- âœ… **Mock å¤æ‚å¯¹è±¡**: Excel æ–‡ä»¶ã€PDF æ–‡æ¡£
- âœ… **éªŒè¯ Mock è°ƒç”¨**: ç¡®ä¿ä¾èµ–è¢«æ­£ç¡®è°ƒç”¨
- âŒ **ä¸è¦è¿‡åº¦ Mock**: ç®€å•å¯¹è±¡å¯ä»¥ç›´æ¥åˆ›å»º

### 3. æµ‹è¯•æ•°æ®

- âœ… **ä½¿ç”¨å·¥å‚å‡½æ•°**: åˆ›å»ºæµ‹è¯•æ•°æ®
- âœ… **ä½¿ç”¨ fixture**: å…±äº«æµ‹è¯•æ•°æ®
- âœ… **ä¿æŒæ•°æ®ç®€å•**: åªåŒ…å«æµ‹è¯•éœ€è¦çš„æ•°æ®
- âŒ **é¿å…ç¡¬ç¼–ç **: ä½¿ç”¨å˜é‡å’Œå¸¸é‡

---

## ğŸ“ æ€»ç»“

### å…³é”®é—®é¢˜
1. **æµ‹è¯•æ–‡ä»¶ç”Ÿæˆäº†ä½†æœªå®ç°** - éœ€è¦ç³»ç»ŸåŒ–å®ç°
2. **æœåŠ¡å¤æ‚ï¼Œæµ‹è¯•å›°éš¾** - éœ€è¦å»ºç«‹æµ‹è¯•åŸºç¡€è®¾æ–½
3. **ç¼ºä¹å®ç°ç­–ç•¥** - éœ€è¦æ˜ç¡®çš„ä¼˜å…ˆçº§å’Œè®¡åˆ’

### è§£å†³æ–¹æ¡ˆ
1. **å»ºç«‹æµ‹è¯•åŸºç¡€è®¾æ–½** - fixtureã€æ¨¡æ¿ã€å·¥å…·
2. **ç³»ç»ŸåŒ–å®ç°** - æŒ‰ä¼˜å…ˆçº§é€ä¸ªå®ç°
3. **æŒç»­æ”¹è¿›** - æ¯å‘¨æ£€æŸ¥è¿›åº¦ï¼Œè°ƒæ•´ç­–ç•¥

### ä¸‹ä¸€æ­¥
1. âœ… åˆ›å»ºæµ‹è¯•åŸºç¡€è®¾æ–½ï¼ˆconftest.pyã€æ¨¡æ¿ï¼‰
2. âœ… é€‰æ‹©ç¬¬ä¸€ä¸ªæœåŠ¡å¼€å§‹å®ç°
3. âœ… å»ºç«‹æ¯å‘¨å®ç°è®¡åˆ’

---

**å¼€å§‹è¡ŒåŠ¨**: ä»ä»Šå¤©å¼€å§‹ï¼Œæ¯å¤©å®ç° 1-2 ä¸ªæœåŠ¡çš„æµ‹è¯•ï¼Œ3 å‘¨å†…å°†æœåŠ¡å±‚è¦†ç›–ç‡æå‡è‡³ 35%+ï¼

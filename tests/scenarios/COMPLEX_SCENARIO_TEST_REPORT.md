# 复杂业务场景测试报告

## 概述

本测试套件覆盖非标自动化项目管理系统的跨模块复杂业务场景，包括完整业务流程、审批流程、权限管理、并发场景和异常恢复等关键功能。

## 测试统计

- **测试场景数量**: 18个
- **测试用例总数**: 192个
- **测试类型**: 集成测试 + 复杂业务场景
- **平均每场景测试用例**: 10-14个

## 测试场景清单

### 一、完整业务流程测试（5个场景）

#### 1. test_scenario_01_lead_to_payment_flow.py
**场景**: 销售线索 → 商机 → 报价 → 合同 → 回款完整流程
- 测试用例数: 12个
- 覆盖范围:
  - 销售线索创建和转化
  - 商机管理
  - 报价单创建和审批
  - 合同签署
  - 发票开具
  - 回款登记
  - 销售漏斗转化率跟踪
  - 销售周期时间分析

#### 2. test_scenario_02_project_full_lifecycle.py
**场景**: 项目创建 → 执行 → 验收完整生命周期
- 测试用例数: 12个
- 覆盖范围:
  - 项目创建和团队分配
  - 里程碑规划
  - 项目执行和进度跟踪
  - 设备创建和管理
  - 出厂验收（FAT）
  - 现场验收（SAT）
  - 项目收尾
  - 项目指标计算

#### 3. test_scenario_03_purchase_request_to_receipt.py
**场景**: 采购申请 → 审批 → 订单 → 收货完整流程
- 测试用例数: 14个
- 覆盖范围:
  - 采购申请创建和审批
  - 采购订单生成和确认
  - 供应商管理
  - 质量检验
  - 采购收货
  - 部分交货处理
  - 采购提前期跟踪

#### 4. test_scenario_04_quote_to_contract_flow.py
**场景**: 报价 → 合同签订 → 项目启动流程
- 测试用例数: 10个
- 覆盖范围:
  - 销售报价创建
  - 客户接受报价
  - 合同条款协商
  - 合同签署
  - 项目创建和启动
  - 合同变更管理
  - 报价转合同转化率

#### 5. test_scenario_05_material_procurement_flow.py
**场景**: 物料需求 → 采购 → 入库 → 领用流程
- 测试用例数: 11个
- 覆盖范围:
  - 物料需求申请
  - 采购需求转采购申请
  - 物料入库
  - 物料领用
  - 物料退库
  - 物料预留和取消预留
  - 完整物料流程

### 二、审批流程测试（4个场景）

#### 6. test_scenario_06_multi_level_approval.py
**场景**: 多级审批流程
- 测试用例数: 10个
- 覆盖范围:
  - 多级审批任务链创建
  - 顺序审批流转
  - 中间级别驳回
  - 会签审批
  - 审批委托
  - 条件路由
  - 审批时间跟踪
  - 审批超时自动升级

#### 7. test_scenario_07_parallel_approval.py
**场景**: 并行审批
- 测试用例数: 10个
- 覆盖范围:
  - 并行审批任务创建
  - 部分审批人通过
  - 全部审批人通过
  - 一票否决
  - 最少通过数量要求
  - 并行审批超时处理
  - 混合并行和顺序审批
  - 审批通知机制

#### 8. test_scenario_08_approval_rejection.py
**场景**: 审批驳回和重新提交
- 测试用例数: 10个
- 覆盖范围:
  - 带理由驳回
  - 修改后重新提交
  - 创建新审批实例
  - 驳回通知
  - 多级审批部分驳回
  - 驳回修改建议
  - 重提交次数限制
  - 驳回升级处理
  - 批量驳回
  - 驳回历史跟踪

#### 9. test_scenario_09_approval_timeout.py
**场景**: 审批超时处理
- 测试用例数: 10个
- 覆盖范围:
  - 审批超时检测
  - 超时提醒
  - 自动升级
  - 超时统计

### 三、权限和角色测试（3个场景）

#### 10. test_scenario_10_role_permission_inheritance.py
**场景**: 角色权限继承
- 测试用例数: 11个
- 覆盖范围:
  - 基础角色权限分配
  - 子角色继承父角色权限
  - 子角色额外权限
  - 多级权限继承
  - 权限覆盖
  - 用户多角色权限
  - 权限层级关系
  - 动态角色修改
  - 非活跃角色过滤
  - 权限检查（含继承）

#### 11. test_scenario_11_dynamic_permission.py
**场景**: 动态权限分配
- 测试用例数: 10个
- 覆盖范围:
  - 运行时权限变更
  - 临时权限授予
  - 权限撤销
  - 权限有效期管理

#### 12. test_scenario_12_data_permission_filter.py
**场景**: 数据权限过滤
- 测试用例数: 10个
- 覆盖范围:
  - 部门数据权限
  - 项目数据权限
  - 个人数据权限
  - 数据范围过滤

### 四、并发场景测试（3个场景）

#### 13. test_scenario_13_inventory_concurrent_deduction.py
**场景**: 库存并发扣减
- 测试用例数: 11个
- 覆盖范围:
  - 使用行锁的并发扣减
  - 并发扣减超过库存
  - 乐观锁版本控制
  - 并发预留
  - 并发出库和退库
  - 死锁检测
  - 批量并发扣减
  - 并发库存调整
  - 并发库存转移
  - 事务隔离级别测试

#### 14. test_scenario_14_order_concurrent_creation.py
**场景**: 订单并发创建
- 测试用例数: 10个
- 覆盖范围:
  - 并发订单号生成
  - 并发库存检查
  - 并发价格计算
  - 订单创建限流

#### 15. test_scenario_15_approval_concurrent_processing.py
**场景**: 审批并发处理
- 测试用例数: 10个
- 覆盖范围:
  - 并发审批提交
  - 并发审批决策
  - 审批状态竞争
  - 并发通知处理

### 五、异常恢复测试（3个场景）

#### 16. test_scenario_16_transaction_rollback.py
**场景**: 事务回滚
- 测试用例数: 11个
- 覆盖范围:
  - 约束违反时回滚
  - 业务规则违反时回滚
  - 部分操作失败回滚
  - 嵌套事务回滚
  - 使用保存点回滚
  - 并发修改冲突回滚
  - 级联删除失败回滚
  - 复杂操作失败回滚
  - 触发器副作用回滚
  - 验证事务原子性

#### 17. test_scenario_17_data_consistency.py
**场景**: 数据一致性
- 测试用例数: 10个
- 覆盖范围:
  - 项目与合同金额一致性
  - 发票总额与合同金额一致性
  - 库存交易流水与余额一致性
  - 客户项目数量一致性
  - 外键完整性
  - 级联更新一致性
  - 聚合数据一致性
  - 冗余数据同步
  - 时间一致性
  - 跨模块数据一致性

#### 18. test_scenario_18_idempotency.py
**场景**: 幂等性验证
- 测试用例数: 10个
- 覆盖范围:
  - 使用幂等性键创建操作
  - 更新操作幂等性
  - 删除操作幂等性
  - 库存扣减幂等性
  - 审批提交幂等性
  - 回款记录幂等性
  - 状态流转幂等性
  - 批量操作幂等性
  - API请求幂等性头
  - 并发幂等操作

## 测试环境配置

```bash
# 环境变量
export SECRET_KEY="test-secret-key-for-ci-with-32-chars-minimum!"
export DATABASE_URL="sqlite:///:memory:"
export REDIS_URL="redis://localhost:6379/0"
```

## 执行测试

### 运行所有场景测试
```bash
cd /Users/fulingwei/.openclaw/workspace/non-standard-automation-pms
pytest tests/scenarios/ -v
```

### 运行特定场景
```bash
pytest tests/scenarios/test_scenario_01_lead_to_payment_flow.py -v
```

### 运行特定测试用例
```bash
pytest tests/scenarios/test_scenario_01_lead_to_payment_flow.py::TestLeadToPaymentFlow::test_01_create_lead_from_inquiry -v
```

### 生成覆盖率报告
```bash
pytest tests/scenarios/ --cov=app --cov-report=html --cov-report=term
```

## 测试特点

### 1. 真实数据流
- 使用真实的业务数据模型
- 模拟真实的业务流程
- 验证数据完整性和一致性

### 2. 跨模块集成
- 测试销售、项目、采购、财务等模块间的集成
- 验证模块间数据流转
- 确保端到端业务流程正常

### 3. 并发场景
- 模拟多用户并发操作
- 测试数据库锁机制
- 验证并发安全性

### 4. 异常处理
- 测试各种异常场景
- 验证事务回滚机制
- 确保数据一致性

### 5. 幂等性保证
- 验证API幂等性
- 防止重复操作
- 确保数据正确性

## 质量指标

- **代码覆盖率目标**: ≥80%
- **测试通过率**: 100%
- **平均测试执行时间**: <5秒/场景
- **并发测试压力**: 10-100并发请求

## 已知问题和改进建议

### 已知问题
1. SQLite不完全支持并发操作，生产环境应使用PostgreSQL
2. 部分测试依赖Redis，需确保Redis服务可用
3. 某些高级并发测试可能在CI环境中表现不一致

### 改进建议
1. 增加性能基准测试
2. 添加更多边界条件测试
3. 补充压力测试场景
4. 增加安全性测试
5. 添加API兼容性测试

## 维护指南

### 添加新场景
1. 在`tests/scenarios/`目录创建新文件
2. 遵循命名规范：`test_scenario_XX_description.py`
3. 每个场景包含8-12个测试用例
4. 更新本报告

### 更新测试数据
1. 使用fixture提供测试数据
2. 确保测试数据独立性
3. 测试后清理数据

### 调试失败测试
```bash
# 运行单个测试并查看详细输出
pytest tests/scenarios/test_scenario_XX.py::TestClass::test_method -vv -s

# 启用日志输出
pytest tests/scenarios/ --log-cli-level=DEBUG
```

## 总结

本测试套件全面覆盖了非标自动化项目管理系统的关键业务场景，确保系统在复杂业务流程、并发访问、异常情况下都能稳定可靠地运行。通过持续维护和扩展，将为系统质量提供坚实保障。

---

**创建日期**: 2026-02-21  
**最后更新**: 2026-02-21  
**维护人**: OpenClaw Agent

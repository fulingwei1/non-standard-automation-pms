# 非标自动化项目管理系统 - 功能重复问题分析总结

> 生成日期: 2026-01-23

## 一、总体统计

| 指标 | 数值 |
|------|------|
| 重复问题总类别 | 89 类 |
| 涉及文件数 | 600+ |
| 预估重复代码行数 | 25,000+ |
| 代码重复率 | 25-30% |
| API 端点文件总数 | 754 个 |

## 二、严重性分布

| 严重级别 | 数量 | 说明 |
|---------|------|------|
| 🔴 严重 | 28 | 需要立即处理 |
| 🟠 高 | 41 | 短期内处理 |
| 🟡 中 | 27 | 中期处理 |

## 三、按分类汇总

| 分类 | 🔴 严重 | 🟠 高 | 🟡 中 | 总计 |
|------|--------|-------|-------|------|
| 模型层 | 2 | 2 | 1 | 5 |
| API端点 | 15 | 7 | 1 | 23 |
| 服务层 | 4 | 14 | 4 | 22 |
| 权限检查 | 1 | 1 | 0 | 2 |
| 通用模式 | 2 | 2 | 7 | 11 |
| 前端常量 | 1 | 7 | 2 | 10 |
| 前端工具 | 0 | 4 | 1 | 5 |
| 前端组件 | 3 | 4 | 5 | 12 |
| 前端Hook | 0 | 0 | 1 | 1 |
| 前端API | 0 | 0 | 2 | 2 |
| 数据库 | 0 | 0 | 3 | 3 |
| **总计** | **28** | **41** | **27** | **96** |

## 四、主要重复问题类别

### 4.1 模型层重复 (5类)

| 问题 | 严重性 | 文件位置 |
|------|--------|----------|
| 组织架构模型 v1/v2 并存 | 🔴 严重 | `organization.py` vs `organization_v2.py` |
| 权限模型重复 | 🔴 严重 | `user.py` vs `permission_v2.py` |
| 枚举定义重复 | 🟡 中 | `enums/material.py`, `performance/enums.py` 等 |
| ProjectStage 与 ProjectStageInstance 字段重复 | 🟠 高 | `lifecycle.py`, `stage_instance.py` |
| 发票模型精度不一致 | 🟠 高 | `business_support/invoice.py`, `sales/invoices.py` |

### 4.2 API端点重复 (23类)

#### 模块级 API 重复 (9组)

| 模块 | 位置1 | 位置2 |
|------|-------|-------|
| approvals | `/approvals/` | `/projects/approvals/` |
| costs | `/costs/` | `/projects/costs/` |
| machines | `/machines/` | `/projects/machines/` |
| members | `/members/` | `/projects/members/` |
| milestones | `/milestones/` | `/projects/milestones/` |
| progress | `/progress/` | `/projects/progress/` |
| roles | `/roles/` | `/projects/roles/` |
| timesheet | `/timesheet/` | `/projects/timesheet/` |
| workload | `/workload/` | `/projects/workload/` |

#### 其他 API 重复

| 问题 | 数量 | 说明 |
|------|------|------|
| 审批流程重复实现 | 9个 | 每个模块独立实现审批 |
| 工作流状态机重复 | 8个 | 每个模块独立实现状态机 |
| Dashboard 仪表板重复 | 10个 | 每个模块独立实现仪表板 |
| 状态更新端点重复 | 10个 | 每个状态更新独立实现 |
| 批量操作重复 | 7个 | 每个批量操作独立实现 |

### 4.3 服务层重复 (22类)

| 问题 | 数量 | 说明 |
|------|------|------|
| 报表统计服务分散 | 50+ | 报表功能分散在各处 |
| 通知系统分散 | 15+ | 三套通知系统并存 |
| 导入导出服务重复 | 23+ | 每个模块自行实现 |
| Excel 导出服务重复 | 5+ | 多个 export_to_excel 实现 |
| PDF 导出服务重复 | 4个 | 多个 PDF 导出实现 |
| 统计服务重复 | 6+ | 每个模块独立统计服务 |
| 缓存服务重复 | 4个 | 多个缓存服务混用 |
| 劳动成本服务重复 | 3个 | 75% 代码重合 |
| 资源规划服务重复 | 2个 | 70% 代码重合 |
| 项目关联服务重复 | 2个 | 95% 代码重合 |

### 4.4 通用模式重复 (11类)

| 问题 | 数量 | 说明 |
|------|------|------|
| 分页逻辑重复 | 100+ | `offset = (page - 1) * page_size` |
| 搜索过滤重复 | 80+ | `filter(field.like('%keyword%'))` |
| CRUD 重复 | 35处 | 每个模块独立 CRUD |
| 权限检查函数重复 | 7处 | `check_timesheet_approval_permission` |
| 工具函数碎片化 | 29处 | 相似工具函数分散 |
| 查询模式重复 | 70+ | `filter(is_active == True)` |
| 时间范围筛选重复 | 13+ | `month_start = today.replace(day=1)` |

### 4.5 前端重复 (30类)

#### 常量文件重复 (10组)

| 模块 | 重复文件 |
|------|----------|
| 预警统计 | `alertStatisticsConstants.js` vs `alertStatsConstants.js` |
| 客户沟通 | `communicationConstants.js` vs `customerCommunicationConstants.js` |
| 采购订单 | 3个不同位置的 `purchaseOrderConstants.js` |
| ECN | `ecnConstants.js` vs `ecnManagementConstants.js` |
| 财务 | `financeDashboardConstants.js` vs `financeManagerConstants.js` |
| 付款 | `paymentManagementConstants.js` vs `paymentConstants.js` |
| 销售 | 3个不同位置的销售常量 |
| 服务工单 | 3个不同位置的服务工单常量 |

#### 组件重复 (12组)

| 组件类型 | 数量 | 位置 |
|---------|------|------|
| 发票对话框 | 5对 | `components/invoice-management/` vs `pages/invoice/` |
| 项目结项对话框 | 4对 | `components/project-closure/` vs `pages/ProjectClosureManagement/` |
| 装配任务对话框 | 4对 | `assembler-task/` vs `production/assembler/` |
| 审批组件 | 9个 | 多个 workstation 和 approval 相关组件 |
| 图表组件 | 3对 | 多个位置的图表组件 |

#### 工具函数重复 (5类)

| 函数 | 重复次数 | 说明 |
|------|---------|------|
| formatCurrency | 3处 | 货币格式化 |
| formatDate | 6+处 | 日期格式化 |
| getStatusBadge | 3处 | 状态标签 |
| handleApiError | 2处 | 错误处理 |
| fadeIn 动画 | 2处 | 动画定义 |

## 五、产生重复的原因分析

### 5.1 架构演进导致的历史遗留

- `organization.py` → `organization_v2.py` 新旧版本并存
- `data_scope_service.py` → `data_scope_service_v2.py` 未完成迁移
- API 从根路径迁移到 `/projects/{id}/` 下，但旧端点未删除

### 5.2 缺乏统一的基础框架

- 没有通用的 CRUD 基类，每个模块重新实现
- 没有统一的分页/过滤工具，100+ 处重复代码
- 没有统一的审批引擎，9 个模块各自实现审批流程
- 没有统一的状态机框架，8 个模块各自实现工作流

### 5.3 模块化开发缺乏协调

- 不同开发者/不同时期开发的模块互相独立
- 前端常量文件 `xxxConstants.js` vs `xxxManagementConstants.js` 命名不统一
- 相似功能在 `components/` 和 `pages/` 下各实现一份

### 5.4 复制粘贴开发模式

- 权限检查函数 `check_timesheet_approval_permission` 复制了 7 次
- `formatCurrency` 在 3 个 workstation 中完全相同
- Dialog 组件在多个位置复制

### 5.5 缺乏代码审查和重构机制

- 没有及时发现和合并重复代码
- 功能迭代时没有考虑复用现有代码
- 迁移文件逐步累积，ALTER TABLE 语句分散

## 六、修复优先级

### P0 - 立即处理 (本周)

| 问题 | 影响 |
|------|------|
| 权限检查函数 7 处重复 | 维护困难、安全隐患 |
| 组织架构模型 v1/v2 并存 | 数据一致性风险 |
| get_db 依赖注入重复 | 代码混乱 |
| 发票模型精度不一致 | 金额计算错误 |
| list_timesheets 路由重复 | 路由冲突 |

### P1 - 短期处理 (2周内)

| 问题 | 影响 |
|------|------|
| 9 个模块级 API 重复 | 路由混乱、功能不清 |
| 审批流程 9 处重复 | 维护困难 |
| 通知系统 15+ 处分散 | 消息发送不可靠 |
| 前端对话框 13 对重复 | 代码冗余 |
| 分页逻辑 100+ 处重复 | bug 修复困难 |

### P2 - 中期处理 (1月内)

| 问题 | 影响 |
|------|------|
| 报表统计 50+ 处分散 | 功能不一致 |
| 导入导出 23+ 处重复 | 格式不统一 |
| 前端常量 40+ 文件重复 | 维护困难 |
| CRUD 35 处重复 | 开发效率低 |
| Dashboard 10 处重复 | 代码冗余 |

### P3 - 长期处理 (季度内)

| 问题 | 影响 |
|------|------|
| 工具函数 29 处碎片化 | 维护成本高 |
| 枚举定义分散 | 不一致风险 |
| API 客户端 30 个重复 | 开发效率低 |

## 七、重构建议

| 序号 | 建议 | 涉及问题数 | 预计减少代码行数 | 难度 |
|------|------|-----------|-----------------|------|
| 1 | 创建统一审批框架 (ApprovalEngine) | 9+ | 2,000+ | 高 |
| 2 | 创建统一状态机框架 (StateMachine) | 8+ | 1,500+ | 高 |
| 3 | 创建统一导入导出框架 (ImportExportEngine) | 23+ | 3,000+ | 中 |
| 4 | 创建统一通知服务 (NotificationService) | 15+ | 1,500+ | 中 |
| 5 | 创建分页过滤工具类 (QueryHelper) | 180+ | 2,000+ | 低 |
| 6 | 创建 CRUD 基类 (CRUDBase) | 35+ | 1,500+ | 中 |
| 7 | 统一前端常量文件到 lib/constants/ | 40+ | 2,000+ | 低 |
| 8 | 提取通用 Dialog 组件库 | 13+ | 1,000+ | 低 |
| 9 | 创建统一报表框架 (ReportEngine) | 50+ | 3,000+ | 高 |
| 10 | 创建统一 Dashboard 基类 | 10+ | 800+ | 中 |
| 11 | 整合缓存服务 | 4 | 300+ | 低 |
| 12 | 统一格式化函数到 lib/formatters.js | 10+ | 500+ | 低 |
| 13 | 合并组织架构模型到 v2 | 2 | 500+ | 中 |
| 14 | 统一权限检查到 core/permissions/ | 8+ | 400+ | 低 |
| 15 | 优化 Project 表索引 | 18 | - | 低 |

## 八、改进方向

1. **建立统一的基础框架** - 审批、状态机、CRUD、分页
2. **制定代码规范** - 统一命名和目录结构
3. **定期进行代码审查和重构** - 及时发现和合并重复代码
4. **删除已废弃的旧版本代码** - 完成迁移后清理历史遗留

---

*详细问题清单请参考 `功能重复问题分析报告.xlsx`*

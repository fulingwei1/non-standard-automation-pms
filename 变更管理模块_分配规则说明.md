# 变更管理模块 - 分配规则说明

> 更新日期：2025-01-15  
> 状态：分配规则已实现 ✅

---

## 一、自动分配原则

### 1.1 评估任务分配原则

**分配依据**：根据评估部门名称和项目关联

**分配优先级**：
1. **项目相关的部门负责人**：如果ECN关联了项目，优先从项目成员中选择该部门的负责人
2. **项目相关的部门经理**：如果项目成员中没有负责人，选择项目成员中的部门经理/主管
3. **部门负责人**：如果项目成员中没有找到，从部门所有用户中选择负责人
4. **部门经理**：如果部门没有负责人，选择部门经理/主管
5. **不分配**：如果都没有，不分配给普通活跃用户

**分配逻辑**：
```python
1. 如果ECN关联了项目：
   a. 查找项目成员中属于该部门的用户
   b. 优先选择项目成员中的部门负责人
   c. 如果没有负责人，选择项目成员中的部门经理/主管
2. 如果项目成员中没有找到或ECN未关联项目：
   a. 从部门所有用户中选择负责人
   b. 如果没有负责人，选择部门经理/主管
3. 如果都没有，返回None（不分配）
```

**示例**：
- 评估部门：机械部
- ECN关联项目：PJ250708001
- 查找逻辑：
  1. 先查找项目成员中属于机械部的用户
  2. 优先选择项目成员中职位包含"负责人"的用户
  3. 如果没有，选择项目成员中职位包含"经理"或"主管"的用户
  4. 如果项目成员中没有，从机械部所有用户中选择负责人
  5. 如果都没有，不分配

---

### 1.2 审批任务分配原则

**分配依据**：根据审批角色名称和项目关联

**分配优先级**：
1. **项目相关的角色负责人**：如果ECN关联了项目，优先从项目成员中选择拥有该角色的负责人
2. **项目相关的角色经理**：如果项目成员中没有负责人，选择项目成员中的经理/主管
3. **角色负责人**：如果项目成员中没有找到，从所有拥有该角色的用户中选择负责人
4. **角色经理**：如果没有负责人，选择经理/主管
5. **不分配**：如果都没有，不分配给普通活跃用户

**分配逻辑**：
```python
1. 如果ECN关联了项目：
   a. 查找项目成员中拥有该角色的用户
   b. 优先选择项目成员中的负责人
   c. 如果没有负责人，选择项目成员中的经理/主管
2. 如果项目成员中没有找到或ECN未关联项目：
   a. 从所有拥有该角色的用户中选择负责人
   b. 如果没有负责人，选择经理/主管
3. 如果都没有，返回None（不分配）
```

**示例**：
- 审批角色：项目经理
- ECN关联项目：PJ250708001
- 查找逻辑：
  1. 先查找项目成员中拥有"项目经理"角色的用户
  2. 优先选择项目成员中职位包含"负责人"的用户
  3. 如果没有，选择项目成员中职位包含"经理"或"主管"的用户
  4. 如果项目成员中没有，从所有拥有"项目经理"角色的用户中选择负责人
  5. 如果都没有，不分配

---

### 1.3 执行任务分配原则

**分配依据**：根据任务部门名称和项目关联

**分配优先级**：
1. **项目相关的部门负责人**：如果ECN关联了项目，优先从项目成员中选择该部门的负责人
2. **项目相关的部门经理**：如果项目成员中没有负责人，选择项目成员中的部门经理/主管
3. **部门负责人**：如果项目成员中没有找到，从部门所有用户中选择负责人
4. **部门经理**：如果部门没有负责人，选择部门经理/主管
5. **不分配**：如果都没有，不分配给普通活跃用户

**分配逻辑**：
```python
1. 如果ECN关联了项目：
   a. 查找项目成员中属于该部门的用户
   b. 优先选择项目成员中的部门负责人
   c. 如果没有负责人，选择项目成员中的部门经理/主管
2. 如果项目成员中没有找到或ECN未关联项目：
   a. 从部门所有用户中选择负责人
   b. 如果没有负责人，选择部门经理/主管
3. 如果都没有，返回None（不分配）
```

**示例**：
- 任务部门：电气部
- ECN关联项目：PJ250708001
- 查找逻辑：
  1. 先查找项目成员中属于电气部的用户
  2. 优先选择项目成员中职位包含"负责人"的用户
  3. 如果没有，选择项目成员中职位包含"经理"或"主管"的用户
  4. 如果项目成员中没有，从电气部所有用户中选择负责人
  5. 如果都没有，不分配

---

## 二、手动首选功能

### 2.1 功能说明

系统支持两种分配模式：
1. **自动分配**：系统根据分配规则自动选择人员
2. **手动首选**：用户可以手动指定首选人员，如果手动指定无效或未指定，则自动分配

### 2.2 实现方式

#### 2.2.1 ECN提交时手动指定评估人员

**API参数**：
```json
{
  "remark": "提交备注",
  "preferred_evaluators": {
    "机械部": 123,  // 部门名: 用户ID
    "电气部": 456
  }
}
```

**分配逻辑**：
1. 如果提供了 `preferred_evaluators` 且包含该部门，使用手动指定的用户ID
2. 验证用户是否存在、属于该部门、且为活跃状态
3. 如果验证失败，回退到自动分配
4. 如果没有手动指定，直接使用自动分配

#### 2.2.2 创建审批时手动指定审批人员

**API参数**：
```json
{
  "ecn_id": 1,
  "approval_level": 1,
  "approval_role": "项目经理",
  "approver_id": 789  // 手动指定审批人员（可选）
}
```

**分配逻辑**：
1. 如果提供了 `approver_id`，使用手动指定的用户ID
2. 验证用户是否存在、拥有该角色、且为活跃状态
3. 如果验证失败，回退到自动分配
4. 如果没有手动指定，直接使用自动分配

#### 2.2.3 创建任务时手动指定执行人员

**API参数**：
```json
{
  "task_name": "更新BOM",
  "task_dept": "机械部",
  "assignee_id": 321  // 手动指定执行人员（可选）
}
```

**分配逻辑**：
1. 如果提供了 `assignee_id`，使用手动指定的用户ID
2. 验证用户是否存在、属于该部门、且为活跃状态
3. 如果验证失败，回退到自动分配
4. 如果没有手动指定，直接使用自动分配

---

## 三、分配流程

### 3.1 ECN提交流程（评估任务分配）

```
用户提交ECN
  ↓
提供 preferred_evaluators（可选）
  ↓
系统创建评估记录
  ↓
对每个评估部门：
  ├─ 如果手动指定了该部门的评估人员
  │   ├─ 验证用户（存在、部门匹配、活跃）
  │   ├─ 验证通过 → 使用手动指定
  │   └─ 验证失败 → 自动分配
  └─ 如果没有手动指定 → 自动分配
      ├─ 查找部门用户
      ├─ 优先选择部门负责人
      └─ 否则选择第一个用户
  ↓
发送通知给评估人员
```

### 3.2 评估完成流程（审批任务分配）

```
评估完成
  ↓
系统自动创建审批记录（根据审批矩阵）
  ↓
对每个审批记录：
  ├─ 如果创建审批时提供了 approver_id
  │   ├─ 验证用户（存在、角色匹配、活跃）
  │   ├─ 验证通过 → 使用手动指定
  │   └─ 验证失败 → 自动分配
  └─ 如果没有手动指定 → 自动分配
      ├─ 如果ECN关联了项目：
      │   ├─ 查找项目成员中拥有该角色的用户
      │   ├─ 优先选择项目成员中的负责人
      │   └─ 如果没有负责人，选择项目成员中的经理
      ├─ 如果项目成员中没有或ECN未关联项目：
      │   ├─ 从所有拥有该角色的用户中选择负责人
      │   └─ 如果没有负责人，选择经理
      └─ 如果都没有，不分配
  ↓
发送通知给审批人员
```

### 3.3 审批通过流程（执行任务分配）

```
审批通过
  ↓
创建执行任务
  ↓
对每个任务：
  ├─ 如果创建任务时提供了 assignee_id
  │   ├─ 验证用户（存在、部门匹配、活跃）
  │   ├─ 验证通过 → 使用手动指定
  │   └─ 验证失败 → 自动分配
  └─ 如果没有手动指定 → 自动分配
      ├─ 如果ECN关联了项目：
      │   ├─ 查找项目成员中属于该部门的用户
      │   ├─ 优先选择项目成员中的部门负责人
      │   └─ 如果没有负责人，选择项目成员中的部门经理
      ├─ 如果项目成员中没有或ECN未关联项目：
      │   ├─ 从部门所有用户中选择负责人
      │   └─ 如果没有负责人，选择部门经理
      └─ 如果都没有，不分配
  ↓
发送通知给执行人员
```

---

## 四、分配规则总结

### 4.1 评估任务分配规则

| 分配方式 | 依据 | 优先级 | 说明 |
|---------|------|--------|------|
| **手动指定** | 用户提供的 `preferred_evaluators` | 最高 | 需验证用户存在、部门匹配、活跃 |
| **自动分配** | 评估部门名称 | 高 | 优先选择部门负责人 |
| **自动分配** | 评估部门名称 | 中 | 如果没有负责人，选择第一个用户 |

### 4.2 审批任务分配规则

| 分配方式 | 依据 | 优先级 | 说明 |
|---------|------|--------|------|
| **手动指定** | 用户提供的 `approver_id` | 最高 | 需验证用户存在、角色匹配、活跃 |
| **自动分配** | 项目成员 + 审批角色名称 | 最高 | 优先选择项目成员中的角色负责人 |
| **自动分配** | 项目成员 + 审批角色名称 | 高 | 如果没有负责人，选择项目成员中的角色经理 |
| **自动分配** | 审批角色名称 | 中 | 如果项目成员中没有，选择角色负责人 |
| **自动分配** | 审批角色名称 | 低 | 如果没有负责人，选择角色经理 |
| **不分配** | - | - | 如果都没有，不分配给普通活跃用户 |

### 4.3 执行任务分配规则

| 分配方式 | 依据 | 优先级 | 说明 |
|---------|------|--------|------|
| **手动指定** | 用户提供的 `assignee_id` | 最高 | 需验证用户存在、部门匹配、活跃 |
| **自动分配** | 项目成员 + 任务部门名称 | 最高 | 优先选择项目成员中的部门负责人 |
| **自动分配** | 项目成员 + 任务部门名称 | 高 | 如果没有负责人，选择项目成员中的部门经理 |
| **自动分配** | 任务部门名称 | 中 | 如果项目成员中没有，选择部门负责人 |
| **自动分配** | 任务部门名称 | 低 | 如果没有负责人，选择部门经理 |
| **不分配** | - | - | 如果都没有，不分配给普通活跃用户 |

---

## 五、验证规则

### 5.1 评估人员验证

手动指定的评估人员必须满足：
- ✅ 用户存在
- ✅ 用户属于指定的评估部门
- ✅ 用户为活跃状态（`is_active == True`）

### 5.2 审批人员验证

手动指定的审批人员必须满足：
- ✅ 用户存在
- ✅ 用户拥有指定的审批角色
- ✅ 用户为活跃状态（`is_active == True`）

### 5.3 执行人员验证

手动指定的执行人员必须满足：
- ✅ 用户存在
- ✅ 用户属于指定的任务部门
- ✅ 用户为活跃状态（`is_active == True`）

---

## 六、使用示例

### 6.1 ECN提交时手动指定评估人员

```python
# API调用
POST /api/v1/ecns/{ecn_id}/submit
{
  "remark": "提交ECN申请",
  "preferred_evaluators": {
    "机械部": 123,  // 机械部评估人员：用户ID 123
    "电气部": 456   // 电气部评估人员：用户ID 456
  }
}
```

**结果**：
- 如果用户123存在、属于机械部、且活跃 → 分配给用户123
- 如果用户123不存在或不属于机械部 → 自动分配给机械部负责人
- 如果用户456存在、属于电气部、且活跃 → 分配给用户456
- 如果用户456不存在或不属于电气部 → 自动分配给电气部负责人

### 6.2 创建审批时手动指定审批人员

```python
# API调用
POST /api/v1/ecns/{ecn_id}/approvals
{
  "approval_level": 1,
  "approval_role": "项目经理",
  "approver_id": 789  // 手动指定审批人员
}
```

**结果**：
- 如果用户789存在、拥有"项目经理"角色、且活跃 → 分配给用户789
- 如果用户789不存在或不拥有该角色 → 自动分配给第一个拥有"项目经理"角色的用户

### 6.3 创建任务时手动指定执行人员

```python
# API调用
POST /api/v1/ecns/{ecn_id}/tasks
{
  "task_name": "更新BOM",
  "task_dept": "机械部",
  "assignee_id": 321  // 手动指定执行人员
}
```

**结果**：
- 如果用户321存在、属于机械部、且活跃 → 分配给用户321
- 如果用户321不存在或不属于机械部 → 自动分配给机械部负责人

---

## 七、代码实现位置

### 7.1 自动分配服务

**文件**：`app/services/ecn_auto_assign_service.py`

**函数**：
- `auto_assign_evaluation()` - 自动分配评估任务
- `auto_assign_approval()` - 自动分配审批任务
- `auto_assign_task()` - 自动分配执行任务

### 7.2 API端点集成

**文件**：`app/api/v1/endpoints/ecn.py`

**位置**：
- `submit_ecn()` - ECN提交时分配评估任务（支持手动首选）
- 审批记录创建时分配审批任务（支持手动首选）
- `create_ecn_task()` - 创建任务时分配执行任务（支持手动首选）

### 7.3 Schema定义

**文件**：`app/schemas/ecn.py`

**Schema**：
- `EcnSubmit` - 添加 `preferred_evaluators` 字段
- `EcnApprovalCreate` - `approver_id` 字段说明更新
- `EcnTaskCreate` - `assignee_id` 字段说明更新

---

## 八、分配规则配置（未来扩展）

### 8.1 可配置的分配规则

未来可以支持更灵活的分配规则配置：

```json
{
  "assignment_rules": {
    "evaluation": {
      "strategy": "ROUND_ROBIN",  // 轮询分配
      "priority": ["负责人", "经理", "主管", "其他"],
      "load_balance": true  // 负载均衡
    },
    "approval": {
      "strategy": "LEAST_BUSY",  // 最不忙的用户
      "priority": ["项目成员", "其他"]
    },
    "task": {
      "strategy": "ROUND_ROBIN",
      "priority": ["负责人", "经理", "主管", "其他"]
    }
  }
}
```

### 8.2 分配历史记录

记录每次分配的历史，用于：
- 分析分配效果
- 优化分配规则
- 负载均衡计算

---

**文档版本**：v1.0  
**最后更新**：2025-01-15  
**完成度**：分配规则已实现，支持自动分配和手动首选 ✅


# 变更管理模块 - 测试验证报告

> 测试日期：2025-01-15  
> 测试范围：阶段一完成功能  
> 测试状态：待执行

---

## 一、测试概述

### 1.1 测试目标

验证变更管理模块（ECN）阶段一完成的功能：
- ✅ 受影响物料/订单管理功能
- ✅ ECN类型配置管理功能
- ✅ 定时任务服务功能

### 1.2 测试环境

- **后端服务**：FastAPI (http://127.0.0.1:8000)
- **数据库**：SQLite (data/app.db)
- **测试工具**：Python requests库
- **测试脚本**：`test_ecn_apis.py`

### 1.3 测试方法

- **API接口测试**：使用自动化测试脚本
- **功能测试**：手动测试前端页面
- **集成测试**：端到端流程测试

---

## 二、测试用例

### 2.1 ECN基础管理测试

#### 测试用例 TC-ECN-001：创建ECN
- **前置条件**：已登录系统，存在至少一个项目
- **测试步骤**：
  1. 调用 `POST /api/v1/ecns` 创建ECN
  2. 验证返回状态码为200
  3. 验证返回数据包含ECN ID和编号
- **预期结果**：ECN创建成功，返回ECN信息
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-ECN-002：获取ECN列表
- **前置条件**：系统中存在ECN记录
- **测试步骤**：
  1. 调用 `GET /api/v1/ecns?page=1&page_size=10`
  2. 验证返回状态码为200
  3. 验证返回数据包含分页信息
- **预期结果**：返回ECN列表和分页信息
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-ECN-003：更新ECN
- **前置条件**：存在状态为DRAFT的ECN
- **测试步骤**：
  1. 调用 `PUT /api/v1/ecns/{ecn_id}` 更新ECN
  2. 验证返回状态码为200
  3. 验证ECN信息已更新
- **预期结果**：ECN更新成功
- **实际结果**：待测试
- **状态**：⏳ 待执行

---

### 2.2 受影响物料管理测试

#### 测试用例 TC-MAT-001：添加受影响物料
- **前置条件**：存在ECN（状态为DRAFT/SUBMITTED/EVALUATING）
- **测试步骤**：
  1. 调用 `POST /api/v1/ecns/{ecn_id}/affected-materials`
  2. 验证返回状态码为200
  3. 验证物料已添加到ECN
  4. 验证ECN成本影响已更新
- **预期结果**：物料添加成功，成本影响自动计算
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-MAT-002：更新受影响物料
- **前置条件**：ECN中存在受影响物料
- **测试步骤**：
  1. 调用 `PUT /api/v1/ecns/{ecn_id}/affected-materials/{material_id}`
  2. 验证返回状态码为200
  3. 验证物料信息已更新
- **预期结果**：物料更新成功
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-MAT-003：删除受影响物料
- **前置条件**：ECN中存在受影响物料
- **测试步骤**：
  1. 调用 `DELETE /api/v1/ecns/{ecn_id}/affected-materials/{material_id}`
  2. 验证返回状态码为200
  3. 验证物料已删除
- **预期结果**：物料删除成功
- **实际结果**：待测试
- **状态**：⏳ 待执行

---

### 2.3 受影响订单管理测试

#### 测试用例 TC-ORD-001：添加受影响订单
- **前置条件**：存在ECN（状态为DRAFT/SUBMITTED/EVALUATING），存在采购订单
- **测试步骤**：
  1. 调用 `POST /api/v1/ecns/{ecn_id}/affected-orders`
  2. 验证返回状态码为200
  3. 验证订单已添加到ECN
- **预期结果**：订单添加成功
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-ORD-002：更新受影响订单
- **前置条件**：ECN中存在受影响订单
- **测试步骤**：
  1. 调用 `PUT /api/v1/ecns/{ecn_id}/affected-orders/{order_id}`
  2. 验证返回状态码为200
  3. 验证订单信息已更新
- **预期结果**：订单更新成功
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-ORD-003：删除受影响订单
- **前置条件**：ECN中存在受影响订单
- **测试步骤**：
  1. 调用 `DELETE /api/v1/ecns/{ecn_id}/affected-orders/{order_id}`
  2. 验证返回状态码为200
  3. 验证订单已删除
- **预期结果**：订单删除成功
- **实际结果**：待测试
- **状态**：⏳ 待执行

---

### 2.4 ECN类型配置管理测试

#### 测试用例 TC-TYPE-001：创建ECN类型
- **前置条件**：已登录系统
- **测试步骤**：
  1. 调用 `POST /api/v1/ecn-types`
  2. 验证返回状态码为200
  3. 验证类型已创建
- **预期结果**：ECN类型创建成功
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-TYPE-002：获取ECN类型列表
- **前置条件**：系统中存在ECN类型
- **测试步骤**：
  1. 调用 `GET /api/v1/ecn-types`
  2. 验证返回状态码为200
  3. 验证返回类型列表
- **预期结果**：返回ECN类型列表
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-TYPE-003：更新ECN类型
- **前置条件**：存在ECN类型
- **测试步骤**：
  1. 调用 `PUT /api/v1/ecn-types/{type_id}`
  2. 验证返回状态码为200
  3. 验证类型信息已更新
- **预期结果**：ECN类型更新成功
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-TYPE-004：删除ECN类型
- **前置条件**：存在ECN类型
- **测试步骤**：
  1. 调用 `DELETE /api/v1/ecn-types/{type_id}`
  2. 验证返回状态码为200
  3. 验证类型已删除
- **预期结果**：ECN类型删除成功
- **实际结果**：待测试
- **状态**：⏳ 待执行

---

### 2.5 定时任务测试

#### 测试用例 TC-SCHED-001：超时检查功能
- **前置条件**：存在超时的评估/审批/任务
- **测试步骤**：
  1. 手动执行 `run_ecn_scheduler()` 函数
  2. 验证超时检查正常执行
  3. 验证超时提醒生成
- **预期结果**：超时检查正常，生成提醒列表
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-SCHED-002：定时任务调度
- **前置条件**：调度器已启动
- **测试步骤**：
  1. 验证调度器是否正常启动
  2. 验证ECN定时任务已注册
  3. 等待定时任务执行（或手动触发）
- **预期结果**：定时任务正常执行
- **实际结果**：待测试
- **状态**：⏳ 待执行

---

## 三、前端功能测试

### 3.1 受影响物料/订单管理界面测试

#### 测试用例 TC-FE-MAT-001：添加物料对话框
- **前置条件**：打开ECN详情页，切换到"影响分析"标签
- **测试步骤**：
  1. 点击"添加物料"按钮
  2. 填写物料信息
  3. 选择变更类型
  4. 填写变更前后信息
  5. 点击保存
- **预期结果**：物料添加成功，列表更新
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-FE-MAT-002：编辑物料功能
- **前置条件**：ECN中存在受影响物料
- **测试步骤**：
  1. 点击物料行的编辑按钮
  2. 修改物料信息
  3. 点击保存
- **预期结果**：物料信息更新成功
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-FE-MAT-003：删除物料功能
- **前置条件**：ECN中存在受影响物料
- **测试步骤**：
  1. 点击物料行的删除按钮
  2. 确认删除
- **预期结果**：物料删除成功，列表更新
- **实际结果**：待测试
- **状态**：⏳ 待执行

---

### 3.2 ECN类型配置管理页面测试

#### 测试用例 TC-FE-TYPE-001：创建ECN类型
- **前置条件**：访问 `/ecn-types` 页面
- **测试步骤**：
  1. 点击"新建类型"按钮
  2. 填写类型编码、名称、描述
  3. 选择必需和可选评估部门
  4. 配置审批矩阵（JSON格式）
  5. 点击保存
- **预期结果**：ECN类型创建成功
- **实际结果**：待测试
- **状态**：⏳ 待执行

#### 测试用例 TC-FE-TYPE-002：部门选择功能
- **前置条件**：打开创建/编辑ECN类型对话框
- **测试步骤**：
  1. 点击部门按钮选择必需部门
  2. 点击部门按钮选择可选部门
  3. 验证已选部门显示正确
- **预期结果**：部门选择功能正常
- **实际结果**：待测试
- **状态**：⏳ 待执行

---

## 四、端到端测试

### 测试用例 TC-E2E-001：完整ECN流程
- **前置条件**：已登录系统，存在项目
- **测试步骤**：
  1. 创建ECN（草稿状态）
  2. 添加受影响物料
  3. 添加受影响订单
  4. 提交ECN
  5. 创建评估
  6. 提交评估
  7. 创建审批
  8. 审批通过
  9. 创建执行任务
  10. 更新任务进度
  11. 完成任务
  12. 验证ECN日志
- **预期结果**：完整流程正常执行
- **实际结果**：待测试
- **状态**：⏳ 待执行

---

## 五、测试执行

### 5.1 执行API测试脚本

```bash
# 确保服务器运行
uvicorn app.main:app --reload

# 在另一个终端执行测试
python3 test_ecn_apis.py
```

### 5.2 执行前端功能测试

1. 启动前端开发服务器
2. 访问 `/ecns` 页面
3. 按照测试用例逐一测试

### 5.3 执行定时任务测试

```python
# 在Python交互式环境中执行
from app.services.ecn_scheduler import run_ecn_scheduler
run_ecn_scheduler()
```

---

## 六、测试结果汇总

### 6.1 API测试结果

| 测试模块 | 测试用例数 | 通过 | 失败 | 待执行 |
|---------|----------|------|------|--------|
| ECN基础管理 | 3 | 0 | 0 | 3 |
| 受影响物料管理 | 3 | 0 | 0 | 3 |
| 受影响订单管理 | 3 | 0 | 0 | 3 |
| ECN类型配置 | 4 | 0 | 0 | 4 |
| ECN评估 | 6 | 0 | 0 | 6 |
| ECN审批 | 4 | 0 | 0 | 4 |
| ECN执行任务 | 5 | 0 | 0 | 5 |
| ECN日志 | 1 | 0 | 0 | 1 |
| ECN统计 | 1 | 0 | 0 | 1 |
| 超时提醒 | 1 | 0 | 0 | 1 |
| **总计** | **31** | **0** | **0** | **31** |

### 6.2 前端测试结果

| 测试模块 | 测试用例数 | 通过 | 失败 | 待执行 |
|---------|----------|------|------|--------|
| 受影响物料/订单管理 | 3 | 0 | 0 | 3 |
| ECN类型配置管理 | 2 | 0 | 0 | 2 |
| **总计** | **5** | **0** | **0** | **5** |

### 6.3 端到端测试结果

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 完整ECN流程 | ⏳ 待执行 | - |

---

## 七、已知问题

### 7.1 待修复问题

- 暂无

### 7.2 待优化问题

- 定时任务通知发送接口需要集成实际通知服务
- 前端错误提示可以更友好
- 批量操作功能待实现

---

## 八、测试结论

### 8.1 测试完成度

- **API测试**：0% (0/31)
- **前端测试**：0% (0/5)
- **端到端测试**：0% (0/1)
- **总体完成度**：0%

### 8.2 建议

1. **立即执行**：运行 `test_ecn_apis.py` 进行API测试
2. **手动测试**：按照测试用例逐一测试前端功能
3. **集成测试**：执行端到端测试验证完整流程
4. **性能测试**：测试大数据量下的性能表现

---

**报告版本**：v1.0  
**最后更新**：2025-01-15  
**测试负责人**：待指定







# 回款管理权限问题排查指南

## 问题描述

商务支持角色登录后，无法访问回款管理页面（`/payments`），显示"无权限访问"。

---

## 一、已完成的修复

### 1. 前端权限配置 ✅
- **文件**: `frontend/src/lib/roleConfig.js`
- **函数**: `hasFinanceAccess()`
- **已添加角色**: `business_support`, `商务支持`, `商务支持专员`

### 2. 后端权限配置 ✅
- **文件**: `app/core/security.py`
- **函数**: `has_finance_access()`
- **已添加角色**: `business_support`, `商务支持`, `商务支持专员`
- **改进**: 同时检查 `role_code` 和 `role_name`

### 3. 菜单配置 ✅
- **文件**: `frontend/src/components/layout/Sidebar.jsx`
- **商务支持菜单**: 已包含"回款跟踪"菜单项（第593行）

---

## 二、可能的原因

### 原因1: 角色代码不匹配

**问题**: 用户登录时的角色代码可能与配置不一致

**检查方法**:
1. 打开浏览器控制台（F12）
2. 查看 `localStorage.getItem('user')` 的值
3. 确认 `role` 字段的值

**常见不匹配情况**:
- 大小写不一致：`Business_Support` vs `business_support`
- 中英文混用：`商务支持` vs `business_support`
- 空格或特殊字符：`business support` vs `business_support`

### 原因2: 权限检查逻辑问题

**问题**: 权限检查函数可能没有正确识别角色

**检查方法**:
1. 访问调试页面：`http://localhost:5173/debug/permissions`
2. 查看权限检查结果
3. 查看浏览器控制台的日志输出

### 原因3: 路由保护配置

**问题**: `FinanceProtectedRoute` 可能拦截了访问

**检查方法**:
1. 查看 `App.jsx` 中的路由配置（第649-653行）
2. 确认 `/payments` 路由是否被 `FinanceProtectedRoute` 包裹
3. 查看控制台中的权限检查日志

---

## 三、排查步骤

### 步骤1: 检查用户角色

1. **打开浏览器控制台**（F12）
2. **执行以下命令**:
   ```javascript
   const user = JSON.parse(localStorage.getItem('user'));
   console.log('用户角色:', user.role);
   console.log('是否超级管理员:', user.is_superuser);
   ```

3. **记录角色值**，确认是否为以下之一：
   - `business_support`
   - `商务支持`
   - `商务支持专员`

### 步骤2: 检查权限函数

1. **访问调试页面**: `http://localhost:5173/debug/permissions`
2. **查看权限检查结果**
3. **如果显示"无权限"**，检查：
   - 角色代码是否在允许列表中
   - 是否有大小写问题
   - 是否有特殊字符

### 步骤3: 检查控制台日志

1. **打开浏览器控制台**（F12）
2. **访问回款管理页面**: `http://localhost:5173/payments`
3. **查看日志输出**，应该看到：
   ```
   ProtectedRoute: User role = business_support, isSuperuser = false, permissionName = 财务管理模块
   ProtectedRoute: checkPermission result = true/false
   ```

### 步骤4: 手动测试权限函数

在浏览器控制台执行：
```javascript
// 导入权限检查函数（需要先加载页面）
// 或者直接在控制台测试
const testRole = 'business_support';
console.log('测试角色:', testRole);
// 查看 hasFinanceAccess 函数的实现
```

---

## 四、解决方案

### 方案1: 确认角色代码

如果用户角色代码不是 `business_support`，需要：

1. **检查后端用户数据**，确认角色代码
2. **更新权限配置**，添加实际使用的角色代码
3. **或者修改用户角色**，统一使用 `business_support`

### 方案2: 临时绕过权限检查

**仅用于测试**，在 `ProtectedRoute.jsx` 中临时添加：

```javascript
// 临时测试：允许所有角色访问
if (role === 'business_support' || role === '商务支持') {
  console.log('临时允许商务支持访问');
  return children;
}
```

### 方案3: 使用超级管理员账号测试

使用超级管理员账号登录，确认页面功能正常。

---

## 五、权限配置同步机制

### 当前状态

已创建权限同步检查工具：
- **文件**: `scripts/check_permission_sync.py`
- **功能**: 自动检查前后端权限配置是否一致

### 使用方法

```bash
cd /Users/flw/non-standard-automation-pm
python3 scripts/check_permission_sync.py
```

### 同步规则

1. **前端配置** (`frontend/src/lib/roleConfig.js`)
2. **后端配置** (`app/core/security.py`)
3. **必须保持一致**，包括：
   - 角色代码列表
   - 中英文角色名
   - 大小写规范

### 同步文档

已创建同步指南：
- **文件**: `docs/PERMISSION_SYNC_GUIDE.md`
- **内容**: 详细的同步规则和检查清单

---

## 六、调试工具

### 1. 权限调试页面

**访问地址**: `http://localhost:5173/debug/permissions`

**功能**:
- 显示当前用户信息
- 显示角色代码
- 显示权限检查结果
- 显示原始用户数据

### 2. 控制台日志

权限检查时会输出详细日志：
- 用户角色
- 是否超级管理员
- 权限检查结果
- 权限名称

---

## 七、常见问题

### Q1: 为什么菜单显示了，但点击后提示无权限？

**A**: 菜单显示由 `Sidebar.jsx` 控制，页面访问由 `ProtectedRoute` 控制。可能是：
1. 菜单配置允许，但路由权限检查失败
2. 角色代码不匹配
3. 权限检查函数逻辑问题

### Q2: 如何确认用户的实际角色代码？

**A**: 
1. 查看浏览器控制台：`localStorage.getItem('user')`
2. 访问调试页面：`/debug/permissions`
3. 查看后端数据库中的用户角色

### Q3: 修改权限配置后，需要重启服务吗？

**A**: 
- **前端**: 修改后自动热重载（Vite）
- **后端**: 需要重启 FastAPI 服务

---

## 八、下一步行动

1. ✅ **已完成**: 前后端权限配置已更新
2. ✅ **已完成**: 创建权限同步检查工具
3. ✅ **已完成**: 创建权限调试页面
4. ⏳ **待完成**: 确认用户实际角色代码
5. ⏳ **待完成**: 测试商务支持角色访问

---

**最后更新**: 2026-01-XX  
**问题状态**: 排查中

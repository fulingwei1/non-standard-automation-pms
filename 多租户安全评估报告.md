# å¤šç§Ÿæˆ·æ–¹æ¡ˆå®‰å…¨è¯„ä¼°æŠ¥å‘Š

**è¯„ä¼°æ—¥æœŸ**: 2026-02-16  
**è¯„ä¼°èŒƒå›´**: éæ ‡è‡ªåŠ¨åŒ–é¡¹ç›®ç®¡ç†ç³»ç»Ÿ - å¤šç§Ÿæˆ·æ¶æ„ã€æ•°æ®å®‰å…¨ã€è¶…çº§ç®¡ç†å‘˜æƒé™  
**ä¸¥é‡ç¨‹åº¦**: ğŸš¨ **é«˜å±** (P0çº§åˆ«)

---

## ğŸ”´ æ ¸å¿ƒé—®é¢˜æ€»ç»“

**å½“å‰ç³»ç»Ÿå­˜åœ¨ä¸¥é‡çš„å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ç¼ºé™·ï¼Œå¯èƒ½å¯¼è‡´è·¨ç§Ÿæˆ·æ•°æ®æ³„éœ²ã€‚**

---

## ğŸ“Š é—®é¢˜æ¸…å•

### ğŸš¨ P0 - ä¸¥é‡å®‰å…¨æ¼æ´

#### 1. **æ ¸å¿ƒä¸šåŠ¡æ•°æ®ç¼ºå°‘ç§Ÿæˆ·éš”ç¦»å­—æ®µ**

**é—®é¢˜**: å¤§éƒ¨åˆ†æ ¸å¿ƒä¸šåŠ¡è¡¨æ²¡æœ‰ `tenant_id` å­—æ®µ

**å—å½±å“çš„æ¨¡å‹** (ç»æŠ½æŸ¥):
- âŒ `Project` (é¡¹ç›®è¡¨) - **æ²¡æœ‰ tenant_id**
- âŒ `RdProject` (ç ”å‘é¡¹ç›®) - **æ²¡æœ‰ tenant_id**
- âŒ `SalesContract` (é”€å”®åˆåŒ) - **æ²¡æœ‰ tenant_id**
- âŒ `WorkOrder` (ç”Ÿäº§å·¥å•) - **æ²¡æœ‰ tenant_id**
- âœ… `User` (ç”¨æˆ·è¡¨) - **æœ‰ tenant_id** âœ“
- âœ… `Role` (è§’è‰²è¡¨) - **æœ‰ tenant_id** âœ“

**å½±å“**:
- ä»»ä½•ç§Ÿæˆ·çš„ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®æ‰€æœ‰ç§Ÿæˆ·çš„é¡¹ç›®ã€åˆåŒã€å·¥å•æ•°æ®
- **æ•°æ®éš”ç¦»å®Œå…¨å¤±æ•ˆ**
- ä¸¥é‡è¿åSaaSå¤šç§Ÿæˆ·å®‰å…¨åŸåˆ™

**çœŸå®é£é™©åœºæ™¯**:
```
ç§Ÿæˆ·A (æ·±åœ³å…¬å¸) åˆ›å»ºé¡¹ç›® project_id=100
ç§Ÿæˆ·B (ä¸Šæµ·å…¬å¸) ç”¨æˆ·ç›´æ¥è®¿é—® GET /api/v1/projects/100
â†’ æˆåŠŸè·å–ç§Ÿæˆ·Açš„é¡¹ç›®æ•°æ®ï¼ğŸ’¥
```

---

#### 2. **è¶…çº§ç®¡ç†å‘˜æƒé™è®¾è®¡æ··ä¹±**

**å‘ç°çš„é—®é¢˜**:

**2.1 åŒé‡è¶…çº§ç®¡ç†å‘˜æ ‡è¯†**
```python
# Useræ¨¡å‹ä¸­æœ‰ä¸¤ä¸ªå­—æ®µæ ‡è¯†è¶…çº§ç®¡ç†å‘˜ï¼š
is_superuser = Column(Boolean, default=False)  # å­—æ®µ1
tenant_id = Column(Integer, ForeignKey("tenants.id"), nullable=True)  # å­—æ®µ2 (NULLè¡¨ç¤ºè¶…çº§ç®¡ç†å‘˜?)
```

**2.2 æƒé™åˆ¤æ–­ä¸ä¸€è‡´**
```python
# app/core/middleware/tenant_middleware.py: require_same_tenant()
def require_same_tenant(user_tenant_id, resource_tenant_id):
    # è¶…çº§ç®¡ç†å‘˜ï¼ˆtenant_id=Noneï¼‰å¯ä»¥è®¿é—®æ‰€æœ‰èµ„æº âš ï¸
    if user_tenant_id is None:
        return True  # å±é™©ï¼
```

**æ³¨é‡Šè¯´**: "è¶…çº§ç®¡ç†å‘˜ (tenant_id=None)"  
**å®é™…åˆ¤æ–­**: `tenant_id is None`ï¼ˆè€Œä¸æ˜¯ `is_superuser`ï¼‰

**2.3 æƒé™æ£€æŸ¥å‡½æ•°çŸ›ç›¾**
```python
# app/core/auth.py
async def get_current_active_superuser(current_user):
    if not (current_user.is_superuser or is_system_admin(current_user)):  # ä½¿ç”¨ is_superuser
        raise HTTPException(403)
```

**æ··ä¹±ç‚¹**:
- æœ‰æ—¶ç”¨ `is_superuser` å­—æ®µåˆ¤æ–­
- æœ‰æ—¶ç”¨ `tenant_id is None` åˆ¤æ–­
- ä¸¤ä¸ªæ¡ä»¶ä¸ç­‰ä»·ï¼

**é£é™©**:
- ä¸€ä¸ª `tenant_id=None` çš„æ™®é€šç”¨æˆ·ï¼ˆéè¶…çº§ç®¡ç†å‘˜ï¼‰å¯ä»¥ç»•è¿‡æƒé™æ£€æŸ¥
- è¶…çº§ç®¡ç†å‘˜çš„åˆ¤æ–­æ ‡å‡†ä¸ç»Ÿä¸€

---

#### 3. **æ•°æ®æŸ¥è¯¢ç¼ºå°‘è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤**

**é—®é¢˜**: è™½ç„¶æä¾›äº† `TenantAwareQuery` å·¥å…·ï¼Œä½†ä¸æ˜¯å¼ºåˆ¶ä½¿ç”¨

**ä»£ç å®¡æŸ¥**:
```python
# app/core/middleware/tenant_middleware.py
class TenantAwareQuery:
    def query(self, model, auto_filter: bool = True):
        query = self.db.query(model)
        # è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·è¿‡æ»¤
        if auto_filter and self.tenant_id and hasattr(model, "tenant_id"):
            query = query.filter(model.tenant_id == self.tenant_id)
        return query
```

**é—®é¢˜ç‚¹**:
1. `auto_filter=True` æ˜¯é»˜è®¤å‚æ•°ï¼Œä½†å¯ä»¥è¢«å…³é—­
2. **ä¾èµ–å¼€å‘è€…ä¸»åŠ¨ä½¿ç”¨** `TenantAwareQuery`ï¼Œè€Œä¸æ˜¯å¼ºåˆ¶æ‰§è¡Œ
3. å¤§éƒ¨åˆ†APIç«¯ç‚¹ç›´æ¥ä½¿ç”¨ `db.query(Model)`ï¼Œæ²¡æœ‰ç§Ÿæˆ·è¿‡æ»¤

**çœŸå®ä»£ç ç¤ºä¾‹** (å‡è®¾):
```python
# âŒ é”™è¯¯åšæ³•ï¼ˆå¤§éƒ¨åˆ†APIç«¯ç‚¹ï¼‰
@router.get("/projects")
def list_projects(db: Session = Depends(get_db)):
    projects = db.query(Project).all()  # æ²¡æœ‰tenant_idè¿‡æ»¤ï¼
    return projects

# âœ… æ­£ç¡®åšæ³•ï¼ˆä½†æ²¡æœ‰å¼ºåˆ¶æ‰§è¡Œï¼‰
@router.get("/projects")
def list_projects(db: Session = Depends(get_db), current_user: User = Depends(get_current_active_user)):
    query = TenantAwareQuery(db).query(Project)  # ä¸»åŠ¨ä½¿ç”¨ç§Ÿæˆ·è¿‡æ»¤
    projects = query.all()
    return projects
```

**é£é™©**:
- å¼€å‘è€…å¿˜è®°ä½¿ç”¨ `TenantAwareQuery` â†’ æ•°æ®æ³„éœ²
- æ–°åŠŸèƒ½å¼€å‘å®¹æ˜“é—æ¼ç§Ÿæˆ·è¿‡æ»¤
- æ²¡æœ‰æ¡†æ¶çº§å¼ºåˆ¶ä¿éšœ

---

### âš ï¸ P1 - é«˜ä¼˜å…ˆçº§é—®é¢˜

#### 4. **ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¾èµ–è®¤è¯ä¸­é—´ä»¶é¡ºåº**

**é—®é¢˜**: `TenantContextMiddleware` ä¾èµ– `GlobalAuthMiddleware` å…ˆæ‰§è¡Œ

```python
# app/core/middleware/tenant_middleware.py
class TenantContextMiddleware(BaseHTTPMiddleware):
    """åœ¨ GlobalAuthMiddleware ä¹‹åè¿è¡Œ"""
    async def dispatch(self, request: Request, call_next):
        user = getattr(request.state, "user", None)  # ä¾èµ–ä¸­é—´ä»¶é¡ºåº
        if user:
            tenant_id = getattr(user, "tenant_id", None)
```

**é£é™©**:
- ä¸­é—´ä»¶é¡ºåºé”™è¯¯ â†’ ç§Ÿæˆ·ä¸Šä¸‹æ–‡å¤±æ•ˆ
- æ²¡æœ‰æ˜¾å¼çš„é¡ºåºä¿è¯æœºåˆ¶
- æœªæ¥é‡æ„å®¹æ˜“ç ´å

---

#### 5. **ç¼ºå°‘ç§Ÿæˆ·çº§æƒé™éš”ç¦»**

**é—®é¢˜**: æƒé™ç³»ç»Ÿæ”¯æŒç§Ÿæˆ·çº§æƒé™ï¼Œä½†æ²¡æœ‰å¼ºåˆ¶éš”ç¦»

```python
# app/models/user.py
class APIPermission:
    tenant_id = Column(Integer, ForeignKey("tenants.id"), nullable=True)
    # tenant_id = NULL: ç³»ç»Ÿçº§æƒé™
    # tenant_id = N: ç§Ÿæˆ·è‡ªå®šä¹‰æƒé™
```

**ç°çŠ¶**:
- æƒé™æŸ¥è¯¢æ—¶ä¼šè¿‡æ»¤ `tenant_id`ï¼ˆæ­£ç¡® âœ“ï¼‰
- ä½†æƒé™æ£€æŸ¥å‡½æ•° `check_permission()` æ²¡æœ‰éªŒè¯ç”¨æˆ·æ˜¯å¦å±äºè¯¥ç§Ÿæˆ·
- ç§Ÿæˆ·Açš„ç”¨æˆ·å¯èƒ½ä½¿ç”¨ç§Ÿæˆ·Bçš„æƒé™ï¼ˆå¦‚æœæƒé™ç ç›¸åŒï¼‰

---

#### 6. **è¶…çº§ç®¡ç†å‘˜æ— æ—¥å¿—å®¡è®¡**

**é—®é¢˜**: è¶…çº§ç®¡ç†å‘˜è·¨ç§Ÿæˆ·æ“ä½œæ²¡æœ‰ç‰¹æ®Šæ ‡è®°

**å®¡è®¡æ—¥å¿—è®¾è®¡** (å‡è®¾):
```python
# å½“å‰è®¾è®¡
set_audit_context(operator_id=user.id, tenant_id=user.tenant_id)
# tenant_id=None æ—¶ï¼Œæ—¥å¿—ä¸­çœ‹ä¸å‡ºæ˜¯è¶…çº§ç®¡ç†å‘˜æ“ä½œè¿˜æ˜¯ç³»ç»Ÿæ“ä½œ
```

**é£é™©**:
- è¶…çº§ç®¡ç†å‘˜è¯¯æ“ä½œæˆ–æ¶æ„æ“ä½œéš¾ä»¥è¿½æº¯
- è·¨ç§Ÿæˆ·æ•°æ®è®¿é—®æ— æ³•åŒºåˆ†åˆæ³•/éæ³•

---

## ğŸ¯ ä¿®å¤å»ºè®®

### é˜¶æ®µä¸€: ç´§æ€¥ä¿®å¤ (P0, 1å‘¨å†…å®Œæˆ)

#### ä¿®å¤1: ä¸ºæ ¸å¿ƒä¸šåŠ¡è¡¨æ·»åŠ  `tenant_id` å­—æ®µ

**æ–¹æ¡ˆ**:
```sql
-- æ•°æ®åº“è¿ç§»
ALTER TABLE projects ADD COLUMN tenant_id INT NULL;
ALTER TABLE rd_projects ADD COLUMN tenant_id INT NULL;
ALTER TABLE sales_contracts ADD COLUMN tenant_id INT NULL;
ALTER TABLE work_orders ADD COLUMN tenant_id INT NULL;
-- ... å…¶ä»–æ ¸å¿ƒè¡¨

-- æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE projects ADD CONSTRAINT fk_projects_tenant 
    FOREIGN KEY (tenant_id) REFERENCES tenants(id);

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_projects_tenant ON projects(tenant_id);
```

**æ•°æ®è¿ç§»ç­–ç•¥**:
1. **ç°æœ‰æ•°æ®**: å¦‚æœå½“å‰æ˜¯å•ç§Ÿæˆ·ä½¿ç”¨ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤ç§Ÿæˆ·ï¼Œå°†æ‰€æœ‰æ•°æ®çš„ `tenant_id` è®¾ç½®ä¸ºè¯¥ç§Ÿæˆ·ID
2. **æ–°æ•°æ®**: å¼ºåˆ¶è¦æ±‚ `tenant_id NOT NULL`ï¼ˆåˆæœŸå¯ä»¥å…è®¸NULLï¼Œè¿ç§»å®Œæˆåæ”¹ä¸ºNOT NULLï¼‰

**å½±å“èŒƒå›´**: 50+ ä¸šåŠ¡è¡¨ï¼ˆé¢„ä¼°ï¼‰

---

#### ä¿®å¤2: ç»Ÿä¸€è¶…çº§ç®¡ç†å‘˜åˆ¤æ–­æ ‡å‡†

**æ–¹æ¡ˆA: åªä½¿ç”¨ `is_superuser` å­—æ®µ (æ¨è)**

```python
# app/core/middleware/tenant_middleware.py
def require_same_tenant(user, resource_tenant_id):
    """æ£€æŸ¥èµ„æºæ˜¯å¦å±äºç”¨æˆ·çš„ç§Ÿæˆ·"""
    # è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰èµ„æº
    if user.is_superuser:  # âœ… ä½¿ç”¨ is_superuser å­—æ®µ
        return True
    
    # ç³»ç»Ÿçº§èµ„æºï¼ˆtenant_id=NULLï¼‰æ‰€æœ‰ç§Ÿæˆ·å¯è®¿é—®
    if resource_tenant_id is None:
        return True
    
    # åŒä¸€ç§Ÿæˆ·
    return user.tenant_id == resource_tenant_id
```

**æ–¹æ¡ˆB: åŒé‡æ£€æŸ¥ (æ›´å®‰å…¨)**

```python
def require_same_tenant(user, resource_tenant_id):
    """æ£€æŸ¥èµ„æºæ˜¯å¦å±äºç”¨æˆ·çš„ç§Ÿæˆ·"""
    # è¶…çº§ç®¡ç†å‘˜ï¼šåŒæ—¶æ»¡è¶³ is_superuser=True å’Œ tenant_id=None
    if user.is_superuser and user.tenant_id is None:
        return True
    
    # ç§Ÿæˆ·ç®¡ç†å‘˜ï¼šä»…èƒ½è®¿é—®æœ¬ç§Ÿæˆ·èµ„æº
    if user.tenant_id is None and not user.is_superuser:
        raise ValueError("éæ³•ç”¨æˆ·ï¼štenant_id=None ä½† is_superuser=False")
    
    # ç³»ç»Ÿçº§èµ„æº
    if resource_tenant_id is None:
        return True
    
    # åŒä¸€ç§Ÿæˆ·
    return user.tenant_id == resource_tenant_id
```

**ä¿®æ”¹ç‚¹**:
- `app/core/middleware/tenant_middleware.py`: `require_same_tenant()`
- `app/core/auth.py`: æ‰€æœ‰è¶…çº§ç®¡ç†å‘˜åˆ¤æ–­
- æ•°æ®çº¦æŸ: æ·»åŠ æ£€æŸ¥çº¦æŸ `CHECK (tenant_id IS NOT NULL OR is_superuser = TRUE)`

---

#### ä¿®å¤3: å¼ºåˆ¶ç§Ÿæˆ·æ•°æ®éš”ç¦»ï¼ˆæ¡†æ¶çº§ï¼‰

**æ–¹æ¡ˆA: SQLAlchemy Queryäº‹ä»¶ç›‘å¬ (æ¨è)**

```python
# app/core/middleware/tenant_filter.py
from sqlalchemy import event
from sqlalchemy.orm import Session

def enable_tenant_filter(session: Session, tenant_id: int):
    """åœ¨Sessionä¸Šå¯ç”¨ç§Ÿæˆ·è¿‡æ»¤"""
    @event.listens_for(Session, "after_attach")
    def receive_after_attach(session, instance):
        # ä¸ºæ‰€æœ‰æœ‰ tenant_id çš„æ¨¡å‹è‡ªåŠ¨æ·»åŠ è¿‡æ»¤æ¡ä»¶
        if hasattr(instance.__class__, 'tenant_id'):
            session.query(instance.__class__).filter(
                instance.__class__.tenant_id == tenant_id
            )
```

**æ–¹æ¡ˆB: è‡ªå®šä¹‰Queryç±» (ç®€å•ç›´æ¥)**

```python
# app/core/database.py
from sqlalchemy.orm import Query

class TenantQuery(Query):
    """è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·è¿‡æ»¤çš„Queryç±»"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self._auto_filter_applied = False
    
    def __iter__(self):
        # æ‰§è¡ŒæŸ¥è¯¢å‰è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·è¿‡æ»¤
        if not self._auto_filter_applied:
            self._apply_tenant_filter()
        return super().__iter__()
    
    def _apply_tenant_filter(self):
        tenant_id = get_current_tenant_id()
        if tenant_id and hasattr(self.column_descriptions[0]['type'], 'tenant_id'):
            self.filter(self.column_descriptions[0]['type'].tenant_id == tenant_id)
        self._auto_filter_applied = True

# é…ç½®Sessionä½¿ç”¨TenantQuery
from sqlalchemy.orm import sessionmaker
SessionLocal = sessionmaker(query_cls=TenantQuery, ...)
```

**æ–¹æ¡ˆC: APIè£…é¥°å™¨å¼ºåˆ¶æ£€æŸ¥**

```python
# app/core/decorators.py
from functools import wraps

def require_tenant_isolation(func):
    """è£…é¥°å™¨ï¼šå¼ºåˆ¶APIç«¯ç‚¹æ‰§è¡Œç§Ÿæˆ·éš”ç¦»æ£€æŸ¥"""
    @wraps(func)
    async def wrapper(*args, db: Session = None, current_user: User = None, **kwargs):
        # ä¸ºå½“å‰Sessionå¯ç”¨ç§Ÿæˆ·è¿‡æ»¤
        if db and current_user:
            db.info['tenant_id'] = current_user.tenant_id
        return await func(*args, db=db, current_user=current_user, **kwargs)
    return wrapper

# ä½¿ç”¨
@router.get("/projects")
@require_tenant_isolation  # å¼ºåˆ¶è£…é¥°å™¨
async def list_projects(db: Session = Depends(get_db), current_user: User = Depends(get_current_active_user)):
    projects = db.query(Project).all()  # è‡ªåŠ¨è¿‡æ»¤tenant_id
    return projects
```

**æ¨è**: æ–¹æ¡ˆB (è‡ªå®šä¹‰Query) + æ–¹æ¡ˆC (è£…é¥°å™¨) ç»„åˆ

---

### é˜¶æ®µäºŒ: å®‰å…¨åŠ å›º (P1, 1ä¸ªæœˆå†…)

#### ä¿®å¤4: å®¡è®¡æ—¥å¿—å¢å¼º

```python
# app/common/context.py
def set_audit_context(operator_id: int, tenant_id: Optional[int], is_superuser: bool = False):
    """è®¾ç½®å®¡è®¡ä¸Šä¸‹æ–‡"""
    _audit_context.set({
        'operator_id': operator_id,
        'tenant_id': tenant_id,
        'is_superuser': is_superuser,  # âœ… æ–°å¢å­—æ®µ
        'cross_tenant': tenant_id is None,  # âœ… æ ‡è®°è·¨ç§Ÿæˆ·æ“ä½œ
        'timestamp': datetime.utcnow()
    })
```

**å®¡è®¡æ—¥å¿—è¡¨**:
```sql
CREATE TABLE audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    operator_id INT NOT NULL,
    operator_tenant_id INT,
    is_superuser BOOLEAN DEFAULT FALSE,  -- æ˜¯å¦è¶…çº§ç®¡ç†å‘˜
    cross_tenant BOOLEAN DEFAULT FALSE,   -- æ˜¯å¦è·¨ç§Ÿæˆ·æ“ä½œ
    resource_type VARCHAR(100),
    resource_id INT,
    resource_tenant_id INT,               -- è¢«è®¿é—®èµ„æºçš„ç§Ÿæˆ·ID
    action VARCHAR(50),
    ip_address VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_cross_tenant (cross_tenant, created_at),
    INDEX idx_superuser_ops (is_superuser, created_at)
);
```

---

#### ä¿®å¤5: ç§Ÿæˆ·éš”ç¦»æµ‹è¯•å¥—ä»¶

```python
# tests/security/test_tenant_isolation.py
import pytest

class TestTenantIsolation:
    """å¤šç§Ÿæˆ·éš”ç¦»æµ‹è¯•"""
    
    def test_user_cannot_access_other_tenant_projects(self):
        """ç”¨æˆ·ä¸èƒ½è®¿é—®å…¶ä»–ç§Ÿæˆ·çš„é¡¹ç›®"""
        # ç§Ÿæˆ·Aç”¨æˆ·
        user_a = create_user(tenant_id=1)
        token_a = login(user_a)
        
        # ç§Ÿæˆ·Bé¡¹ç›®
        project_b = create_project(tenant_id=2)
        
        # ç§Ÿæˆ·Aç”¨æˆ·å°è¯•è®¿é—®ç§Ÿæˆ·Bé¡¹ç›®
        response = client.get(
            f"/api/v1/projects/{project_b.id}",
            headers={"Authorization": f"Bearer {token_a}"}
        )
        assert response.status_code == 404  # æˆ– 403
    
    def test_superuser_can_access_all_tenants(self):
        """è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰ç§Ÿæˆ·æ•°æ®"""
        superuser = create_superuser(tenant_id=None, is_superuser=True)
        token = login(superuser)
        
        project_a = create_project(tenant_id=1)
        project_b = create_project(tenant_id=2)
        
        # è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®ç§Ÿæˆ·Aé¡¹ç›®
        response = client.get(f"/api/v1/projects/{project_a.id}", headers={"Authorization": f"Bearer {token}"})
        assert response.status_code == 200
        
        # è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®ç§Ÿæˆ·Bé¡¹ç›®
        response = client.get(f"/api/v1/projects/{project_b.id}", headers={"Authorization": f"Bearer {token}"})
        assert response.status_code == 200
    
    def test_list_projects_only_returns_same_tenant(self):
        """åˆ—è¡¨æ¥å£åªè¿”å›åŒç§Ÿæˆ·æ•°æ®"""
        user = create_user(tenant_id=1)
        token = login(user)
        
        create_project(tenant_id=1, name="Project A1")
        create_project(tenant_id=1, name="Project A2")
        create_project(tenant_id=2, name="Project B1")  # ç§Ÿæˆ·B
        
        response = client.get("/api/v1/projects", headers={"Authorization": f"Bearer {token}"})
        projects = response.json()
        
        assert len(projects) == 2
        assert all(p['name'].startswith('Project A') for p in projects)
```

---

#### ä¿®å¤6: æ•°æ®åº“çº¦æŸå¼ºåŒ–

```sql
-- 1. æ·»åŠ æ£€æŸ¥çº¦æŸï¼štenant_id å’Œ is_superuser äº’æ–¥
ALTER TABLE users ADD CONSTRAINT chk_superuser_tenant 
    CHECK (
        (tenant_id IS NOT NULL AND is_superuser = FALSE) OR
        (tenant_id IS NULL AND is_superuser = TRUE)
    );

-- 2. æ ¸å¿ƒä¸šåŠ¡è¡¨å¼ºåˆ¶ tenant_id NOT NULL
ALTER TABLE projects MODIFY COLUMN tenant_id INT NOT NULL;
ALTER TABLE sales_contracts MODIFY COLUMN tenant_id INT NOT NULL;

-- 3. æ·»åŠ å¤–é”®çº¦æŸï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
ALTER TABLE projects ADD CONSTRAINT fk_projects_tenant 
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT;
```

---

## ğŸ“Š å½±å“è¯„ä¼°

### ä¿®å¤å·¥ä½œé‡

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|------|------|--------|--------|
| P0-1 | æ·»åŠ  tenant_id å­—æ®µ | 3-5å¤© | ğŸ”´ ç´§æ€¥ |
| P0-2 | ç»Ÿä¸€è¶…çº§ç®¡ç†å‘˜åˆ¤æ–­ | 1å¤© | ğŸ”´ ç´§æ€¥ |
| P0-3 | å¼ºåˆ¶ç§Ÿæˆ·è¿‡æ»¤ï¼ˆæ¡†æ¶çº§ï¼‰ | 2-3å¤© | ğŸ”´ ç´§æ€¥ |
| P1-4 | å®¡è®¡æ—¥å¿—å¢å¼º | 1-2å¤© | ğŸŸ¡ é«˜ |
| P1-5 | éš”ç¦»æµ‹è¯•å¥—ä»¶ | 2-3å¤© | ğŸŸ¡ é«˜ |
| P1-6 | æ•°æ®åº“çº¦æŸå¼ºåŒ– | 1å¤© | ğŸŸ¡ é«˜ |
| **æ€»è®¡** | | **10-17å¤©** | |

### æ•°æ®è¿ç§»é£é™©

**ä½é£é™©** (å½“å‰ä¸ºå•ç§Ÿæˆ·ç¯å¢ƒ):
- åˆ›å»ºä¸€ä¸ªé»˜è®¤ç§Ÿæˆ·
- æ‰€æœ‰ç°æœ‰æ•°æ® `tenant_id` è®¾ç½®ä¸ºè¯¥ç§Ÿæˆ·ID
- æ— æ•°æ®æŸå¤±é£é™©

**é«˜é£é™©** (å·²æœ‰å¤šç§Ÿæˆ·æ•°æ®):
- éœ€è¦æ ¹æ®ä¸šåŠ¡é€»è¾‘æ¨æ–­ `tenant_id`
- å¯èƒ½éœ€è¦äººå·¥å®¡æ ¸
- å»ºè®®å…ˆå¤‡ä»½æ•°æ®åº“

---

## ğŸ’¡ ä¸´æ—¶ç¼“è§£æªæ–½ (ç´§æ€¥)

åœ¨å®Œæˆå®Œæ•´ä¿®å¤å‰ï¼Œå¯é‡‡å–ä»¥ä¸‹ä¸´æ—¶æªæ–½é™ä½é£é™©ï¼š

### 1. ç¦ç”¨è·¨ç§Ÿæˆ·APIè®¿é—®

```python
# app/core/middleware/emergency_tenant_check.py
class EmergencyTenantCheckMiddleware(BaseHTTPMiddleware):
    """ç´§æ€¥ç§Ÿæˆ·æ£€æŸ¥ä¸­é—´ä»¶ï¼ˆä¸´æ—¶æªæ–½ï¼‰"""
    
    async def dispatch(self, request: Request, call_next):
        # è·å–èµ„æºIDï¼ˆå‡è®¾ä»è·¯å¾„æå–ï¼‰
        resource_id = extract_resource_id(request.url.path)
        if resource_id:
            # æ£€æŸ¥èµ„æºå½’å±ï¼ˆç¡¬ç¼–ç æ£€æŸ¥ï¼‰
            user = getattr(request.state, 'user', None)
            if user and user.tenant_id:
                # æŸ¥è¯¢èµ„æºçš„tenant_idï¼ˆå¦‚æœå­˜åœ¨è¯¥å­—æ®µï¼‰
                resource_tenant_id = db.query(Resource).filter(
                    Resource.id == resource_id
                ).value(Resource.tenant_id)
                
                if resource_tenant_id and resource_tenant_id != user.tenant_id:
                    if not user.is_superuser:
                        return JSONResponse(
                            status_code=403,
                            content={"detail": "æ— æƒè®¿é—®å…¶ä»–ç§Ÿæˆ·çš„èµ„æº"}
                        )
        
        return await call_next(request)
```

### 2. é™åˆ¶è¶…çº§ç®¡ç†å‘˜æ•°é‡

```sql
-- æ£€æŸ¥å½“å‰è¶…çº§ç®¡ç†å‘˜
SELECT id, username, tenant_id, is_superuser FROM users WHERE is_superuser = TRUE OR tenant_id IS NULL;

-- ä¸´æ—¶ç¦ç”¨å¯ç–‘çš„è¶…çº§ç®¡ç†å‘˜
UPDATE users SET is_active = FALSE WHERE tenant_id IS NULL AND is_superuser = FALSE;
```

### 3. åŠ å¼ºæ—¥å¿—ç›‘æ§

```python
# è®°å½•æ‰€æœ‰è·¨ç§Ÿæˆ·è®¿é—®
@app.middleware("http")
async def log_cross_tenant_access(request: Request, call_next):
    user = getattr(request.state, 'user', None)
    if user and user.tenant_id is None:
        logger.warning(
            f"CROSS_TENANT_ACCESS: user_id={user.id}, "
            f"path={request.url.path}, method={request.method}"
        )
    return await call_next(request)
```

---

## ğŸ¯ æ€»ç»“

### å½“å‰çŠ¶æ€

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| æ•°æ®éš”ç¦» | â­â˜†â˜†â˜†â˜† (20%) | å¤§éƒ¨åˆ†è¡¨ç¼ºå°‘ tenant_id |
| æƒé™æ§åˆ¶ | â­â­â˜†â˜†â˜† (40%) | è¶…çº§ç®¡ç†å‘˜åˆ¤æ–­æ··ä¹± |
| å®¡è®¡èƒ½åŠ› | â­â­â­â˜†â˜† (60%) | ç¼ºå°‘è·¨ç§Ÿæˆ·æ“ä½œæ ‡è®° |
| å®‰å…¨æµ‹è¯• | â­â˜†â˜†â˜†â˜† (20%) | ç¼ºå°‘éš”ç¦»æµ‹è¯• |
| **æ€»ä½“è¯„åˆ†** | **â­â­â˜†â˜†â˜† (35%)** | **ä¸åˆæ ¼** ğŸ”´ |

### æ ¸å¿ƒé—®é¢˜

1. âŒ **æ ¸å¿ƒä¸šåŠ¡è¡¨æ²¡æœ‰ tenant_id** â†’ æ•°æ®éš”ç¦»å®Œå…¨å¤±æ•ˆ
2. âŒ **è¶…çº§ç®¡ç†å‘˜åˆ¤æ–­ä¸ä¸€è‡´** â†’ æƒé™ç»•è¿‡é£é™©
3. âŒ **ç¼ºå°‘å¼ºåˆ¶ç§Ÿæˆ·è¿‡æ»¤** â†’ ä¾èµ–å¼€å‘è€…ä¸»åŠ¨æ€§

### æ¨èè¡ŒåŠ¨

**ç«‹å³æ‰§è¡Œ** (1å‘¨å†…):
1. ä¸ºæ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡è¡¨æ·»åŠ  `tenant_id` å­—æ®µ
2. ç»Ÿä¸€è¶…çº§ç®¡ç†å‘˜åˆ¤æ–­æ ‡å‡†ï¼ˆåªç”¨ `is_superuser`ï¼‰
3. å®ç°æ¡†æ¶çº§å¼ºåˆ¶ç§Ÿæˆ·è¿‡æ»¤ï¼ˆè‡ªå®šä¹‰Queryç±»ï¼‰

**çŸ­æœŸæ‰§è¡Œ** (1ä¸ªæœˆå†…):
4. å¢å¼ºå®¡è®¡æ—¥å¿—ï¼ˆæ ‡è®°è·¨ç§Ÿæˆ·æ“ä½œï¼‰
5. ç¼–å†™å®Œæ•´çš„éš”ç¦»æµ‹è¯•å¥—ä»¶
6. å¼ºåŒ–æ•°æ®åº“çº¦æŸ

**é•¿æœŸè§„åˆ’**:
- å®šæœŸå®‰å…¨å®¡è®¡
- è‡ªåŠ¨åŒ–å®‰å…¨æµ‹è¯•
- æ¸—é€æµ‹è¯•

---

**è¯„ä¼°ç»“è®º**: å½“å‰å¤šç§Ÿæˆ·æ–¹æ¡ˆå­˜åœ¨ä¸¥é‡å®‰å…¨ç¼ºé™·ï¼Œ**ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**ã€‚å»ºè®®ç«‹å³å¯åŠ¨P0ä¿®å¤å·¥ä½œã€‚

**é£é™©ç­‰çº§**: ğŸ”´ **é«˜å±** - å¯èƒ½å¯¼è‡´å®¢æˆ·æ•°æ®æ³„éœ²ã€æ³•å¾‹é£é™©ã€å•†ä¸šä¿¡èª‰æŸå¤±

**ä¿®å¤ä¼˜å…ˆçº§**: P0 (æœ€é«˜)

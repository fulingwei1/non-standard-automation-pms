# 奖金发放流程实现总结

## 一、功能概述

实现了完整的奖金发放流程，包括：
1. 线下确认（财务部、人力资源部、总经理）- 在系统中记录确认状态
2. 系统发放：上传分配明细表，点击"同意发放"按钮批量创建发放记录
3. 结果展示：在个人绩效奖金中显示历史发放记录

---

## 二、实现内容

### 2.1 数据模型扩展

**文件**: `app/models/bonus.py`

新增 `BonusAllocationSheet` 模型：

```python
class BonusAllocationSheet(Base, TimestampMixin):
    """奖金分配明细表上传记录表"""
    - sheet_code: 明细表编号
    - sheet_name: 明细表名称
    - file_path: 文件路径
    - project_id/period_id: 关联信息
    - total_rows/valid_rows/invalid_rows: 统计信息
    - status: 状态（UPLOADED/PARSED/DISTRIBUTED）
    - parse_result/parse_errors: 解析结果
    - finance_confirmed/hr_confirmed/manager_confirmed: 线下确认标记
    - distributed_at/distributed_by: 发放信息
```

### 2.2 Excel 模板设计

**模板格式**：

| 计算记录ID* | 受益人ID* | 受益人姓名 | 计算金额* | 发放金额* | 发放日期* | 发放方式 | 凭证号 | 付款账户 | 付款备注 |
|------------|----------|----------|----------|----------|----------|---------|--------|---------|---------|
| 101        | 10       | 张三     | 5000.00  | 5000.00  | 2025-01-15 | 银行转账 | V001   | 中国银行 | 项目奖金 |

**必填字段**（带*）：
- 计算记录ID*
- 受益人ID*
- 计算金额*
- 发放金额*
- 发放日期*

### 2.3 API 端点

#### 2.3.1 下载分配明细表模板

**端点**: `GET /api/v1/bonus/allocation-sheets/template`

**功能**：下载Excel模板文件

**响应**：Excel文件（.xlsx）

#### 2.3.2 上传分配明细表

**端点**: `POST /api/v1/bonus/allocation-sheets/upload`

**功能**：
- 上传Excel分配明细表
- 自动解析和验证数据
- 验证计算记录和受益人是否存在

**请求参数**：
- `file`: Excel文件（multipart/form-data）
- `sheet_name`: 明细表名称
- `project_id`: 项目ID（可选）
- `period_id`: 考核周期ID（可选）

**响应**：返回解析结果，包括有效行数和无效行数

#### 2.3.3 确认分配明细表（线下确认）

**端点**: `POST /api/v1/bonus/allocation-sheets/{sheet_id}/confirm`

**功能**：记录财务部、人力资源部、总经理的线下确认状态

**请求参数**：
```json
{
  "finance_confirmed": true,
  "hr_confirmed": true,
  "manager_confirmed": true
}
```

#### 2.3.4 同意发放（批量创建发放记录）

**端点**: `POST /api/v1/bonus/allocation-sheets/{sheet_id}/distribute`

**功能**：
- 根据分配明细表批量创建发放记录
- 只有线下确认完成的明细表才能发放
- 自动更新计算记录状态为 `DISTRIBUTED`
- 发放记录直接标记为 `PAID`

**验证规则**：
- 财务部、人力资源部、总经理必须全部确认
- 明细表中必须有有效数据

#### 2.3.5 获取分配明细表列表

**端点**: `GET /api/v1/bonus/allocation-sheets`

**功能**：获取分配明细表列表，支持状态筛选

#### 2.3.6 获取分配明细表详情

**端点**: `GET /api/v1/bonus/allocation-sheets/{sheet_id}`

**功能**：获取分配明细表详细信息

#### 2.3.7 下载已上传的分配明细表

**端点**: `GET /api/v1/bonus/allocation-sheets/{sheet_id}/download`

**功能**：下载上传的原始Excel文件，便于财务/人力复核、留档或重新分发。

#### 2.3.8 查看分配明细表解析结果

**端点**: `GET /api/v1/bonus/allocation-sheets/{sheet_id}/rows`

**功能**：
- 通过 `row_type=valid/error` 查询有效行或错误行
- 支持分页参数 `page`、`page_size`
- 有效行以结构化数据返回，错误行包含Excel行号与错误原因

#### 2.3.9 获取我的奖金（已包含历史发放记录）

**端点**: `GET /api/v1/bonus/my`

**功能**：获取当前用户的奖金信息，包括：
- 计算记录列表
- **历史发放记录列表**（distributions）
- 总金额、待发放金额、已发放金额

---

## 三、业务流程

### 3.1 完整发放流程

```
1. 奖金计算完成
   ↓
2. 下载分配明细表模板
   ↓
3. 填写分配明细表（Excel）
   ↓
4. 上传分配明细表
   ↓
5. 系统自动解析和验证
   ↓
6. 线下确认（财务部、人力资源部、总经理）
   ↓
7. 在系统中记录确认状态
   ↓
8. 点击"同意发放"按钮
   ↓
9. 系统批量创建发放记录
   ↓
10. 发放记录显示在个人绩效奖金中
```

### 3.2 状态流转

```
UPLOADED（已上传）
  ↓ 解析成功
PARSED（已解析）
  ↓ 线下确认完成
（确认标记：finance_confirmed, hr_confirmed, manager_confirmed = true）
  ↓ 点击"同意发放"
DISTRIBUTED（已发放）
```

---

## 四、数据库迁移

### 4.1 MySQL 迁移文件

**文件**: `migrations/20250115_bonus_allocation_sheet_mysql.sql`

创建 `bonus_allocation_sheets` 表

### 4.2 SQLite 迁移文件

**文件**: `migrations/20250115_bonus_allocation_sheet_sqlite.sql`

创建 `bonus_allocation_sheets` 表

---

## 五、API 使用示例

### 5.1 下载模板

```bash
GET /api/v1/bonus/allocation-sheets/template
```

**响应**：下载Excel模板文件

### 5.2 上传分配明细表

```bash
POST /api/v1/bonus/allocation-sheets/upload
Content-Type: multipart/form-data

file: [Excel文件]
sheet_name: "2025年1月项目奖金分配"
project_id: 1
```

**响应示例**：
```json
{
  "code": 201,
  "message": "上传成功，有效行数：10，无效行数：0",
  "data": {
    "id": 1,
    "sheet_code": "BAS-250115-A1B2C3",
    "sheet_name": "2025年1月项目奖金分配",
    "status": "PARSED",
    "valid_rows": 10,
    "invalid_rows": 0
  }
}
```

### 5.3 确认分配明细表

```bash
POST /api/v1/bonus/allocation-sheets/1/confirm
{
  "finance_confirmed": true,
  "hr_confirmed": true,
  "manager_confirmed": true
}
```

### 5.4 同意发放

```bash
POST /api/v1/bonus/allocation-sheets/1/distribute
```

**响应示例**：
```json
{
  "code": 200,
  "message": "发放成功，共创建 10 条发放记录",
  "data": {
    "sheet_id": 1,
    "sheet_code": "BAS-250115-A1B2C3",
    "distributed_count": 10,
    "error_count": 0
  }
}
```

### 5.5 查看我的奖金（包含历史发放记录）

```bash
GET /api/v1/bonus/my
```

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "total_amount": 50000.00,
    "pending_amount": 0.00,
    "paid_amount": 50000.00,
    "calculations": [
      {
        "id": 101,
        "calculation_code": "BC-250115-001",
        "calculated_amount": 5000.00,
        "status": "DISTRIBUTED"
      }
    ],
    "distributions": [
      {
        "id": 201,
        "distribution_code": "BD20250115143000",
        "distributed_amount": 5000.00,
        "distribution_date": "2025-01-15",
        "status": "PAID",
        "paid_at": "2025-01-15T14:30:00"
      }
    ]
  }
}
```

---

## 六、Excel 模板字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| 计算记录ID* | 整数 | 是 | 奖金计算记录的ID |
| 受益人ID* | 整数 | 是 | 受益人的用户ID |
| 受益人姓名 | 字符串 | 否 | 受益人姓名（可选，用于显示） |
| 计算金额* | 数字 | 是 | 计算出的奖金金额 |
| 发放金额* | 数字 | 是 | 实际发放的金额 |
| 发放日期* | 日期 | 是 | 发放日期（格式：YYYY-MM-DD） |
| 发放方式 | 字符串 | 否 | 发放方式（如：银行转账、现金等） |
| 凭证号 | 字符串 | 否 | 财务凭证号 |
| 付款账户 | 字符串 | 否 | 付款账户信息 |
| 付款备注 | 字符串 | 否 | 付款备注信息 |

---

## 七、文件存储

分配明细表文件存储在：
- **路径**: `uploads/bonus_allocation_sheets/`
- **命名规则**: `{UUID}.xlsx`
- **模板路径**: `uploads/templates/奖金分配明细表模板.xlsx`

---

## 八、权限控制

- **下载模板**: 需要登录用户权限
- **上传明细表**: 需要登录用户权限
- **确认明细表**: 需要登录用户权限
- **同意发放**: 需要登录用户权限
- **查看列表**: 需要登录用户权限

---

## 九、注意事项

1. **线下确认**：
   - 财务部、人力资源部、总经理的确认在系统外完成
   - 系统只记录确认状态，不控制确认流程

2. **数据验证**：
   - 上传时会验证计算记录ID和受益人ID是否存在
   - 验证金额和日期格式
   - 无效行会记录错误信息

3. **发放记录**：
   - 发放记录创建后直接标记为 `PAID`
   - 计算记录状态自动更新为 `DISTRIBUTED`
   - 防止重复发放（已发放的计算记录不能再次发放）

4. **历史记录**：
   - 所有发放记录都会存储在 `bonus_distributions` 表中
   - 个人绩效奖金API会自动包含历史发放记录

---

## 十、总结

✅ **已完成功能**：
- Excel分配明细表模板生成
- 分配明细表上传和解析
- 线下确认状态记录
- 批量创建发放记录（同意发放）
- 个人绩效奖金包含历史发放记录
- 完整的API端点

✅ **数据模型**：
- 新增 `BonusAllocationSheet` 模型
- 创建数据库迁移文件

✅ **业务流程**：
- 完整的发放流程
- 状态流转控制
- 数据验证和错误处理

所有功能已完整实现，可以投入使用！


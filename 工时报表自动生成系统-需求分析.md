# 工时报表自动生成系统 - 需求分析

**创建时间**: 2026-02-15 17:33  
**项目**: 非标自动化项目管理系统  
**目标**: 实现工时报表自动生成、归档和分发功能

---

## 🎯 业务目标

### 痛点分析
1. **手动导出效率低** - 每月需要HR/财务手动导出工时报表
2. **数据不及时** - 管理层无法第一时间获取上月工时统计
3. **格式不统一** - 不同人导出的报表格式可能不一致
4. **历史查询困难** - 缺少报表归档，历史数据难以追溯

### 预期效果
- ✅ 每月自动生成上月工时报表（零人工介入）
- ✅ 自动发送给管理层/财务/HR
- ✅ 历史报表完整归档，随时查询
- ✅ 报表格式统一、专业
- ✅ 支持多维度报表（按人员/部门/项目）

---

## 📋 功能需求

### 1️⃣ 报表模板管理

#### 1.1 预定义报表类型
```python
ReportType:
  - USER_MONTHLY: 人员月度工时报表
  - DEPT_MONTHLY: 部门月度工时报表
  - PROJECT_MONTHLY: 项目月度工时报表
  - COMPANY_MONTHLY: 公司整体工时报表
  - OVERTIME_MONTHLY: 加班统计报表
```

#### 1.2 报表模板配置
- 报表名称
- 报表类型
- 包含字段（可自定义）
- 筛选条件（部门、角色等）
- 生成频率（月度/季度/年度）
- 输出格式（Excel/PDF/CSV）

#### 1.3 模板字段配置
```
可选字段：
- 基础信息：姓名、工号、部门、岗位
- 工时统计：正常工时、加班工时、总工时、出勤天数
- 项目分布：各项目工时占比
- 效率指标：人均工时、工时饱和度
- 异常标记：超时工时、缺勤记录
```

---

### 2️⃣ 自动生成引擎

#### 2.1 定时任务
```python
# 每月1号 09:00 自动生成上月报表
@cron("0 9 1 * *")
def auto_generate_monthly_reports():
    # 获取所有启用的报表模板
    templates = get_active_templates()
    
    for template in templates:
        # 生成报表数据
        data = generate_report_data(template, last_month)
        
        # 导出为文件
        file_path = export_report(data, template.format)
        
        # 归档
        archive_report(file_path, template)
        
        # 发送
        send_report(file_path, template.recipients)
```

#### 2.2 报表数据生成
- 从 Timesheet 表查询数据
- 按模板配置汇总统计
- 计算衍生指标（人均工时、饱和度等）
- 异常数据标记

#### 2.3 报表文件生成
- **Excel 格式**：
  - 多 sheet（总览 + 明细）
  - 图表（工时趋势、项目分布）
  - 条件格式（异常高亮）
- **PDF 格式**：
  - 专业排版
  - 公司 Logo
  - 签名栏
- **CSV 格式**：
  - 原始数据导出

---

### 3️⃣ 报表归档系统

#### 3.1 文件存储
```
报表存储路径：
/reports/
  /{year}/
    /{month}/
      /{report_type}/
        - user_monthly_2026-01.xlsx
        - dept_monthly_2026-01.xlsx
        - project_monthly_2026-01.xlsx
```

#### 3.2 数据库记录
```python
ReportArchive:
  - id
  - template_id (关联模板)
  - report_type
  - period (2026-01)
  - file_path
  - file_size
  - generated_at
  - generated_by (系统/用户)
  - status (SUCCESS/FAILED)
```

#### 3.3 归档策略
- 自动归档：定时任务生成后自动归档
- 手动归档：用户手动导出后可选归档
- 清理策略：3年以上归档转为冷存储

---

### 4️⃣ 报表分发系统

#### 4.1 收件人配置
```python
ReportRecipient:
  - template_id
  - recipient_type (USER/ROLE/DEPT/EMAIL)
  - recipient_id (用户ID/角色ID/部门ID)
  - recipient_email (外部邮箱)
  - delivery_method (EMAIL/WECHAT/DOWNLOAD)
```

#### 4.2 发送规则
- **邮件发送**：
  - 标题：【工时报表】2026年1月人员工时统计
  - 正文：报表摘要 + 附件下载链接
  - 附件：Excel/PDF 文件
- **企业微信**：
  - 消息通知 + 下载链接
- **系统通知**：
  - 站内消息 + 下载入口

#### 4.3 发送时机
- 定时自动发送（每月1号 09:00）
- 手动触发发送
- 失败重试机制

---

### 5️⃣ 报表查询下载

#### 5.1 历史报表查询
```
筛选条件：
- 报表类型
- 时间周期（年/月）
- 生成时间范围
- 生成方式（自动/手动）
```

#### 5.2 在线预览
- Excel 在线预览
- PDF 在线预览
- 数据表格预览

#### 5.3 下载功能
- 单个下载
- 批量打包下载（ZIP）
- 权限控制（只能下载有权限的报表）

---

### 6️⃣ 权限控制

#### 6.1 报表模板权限
- 创建/编辑模板：HR/Admin
- 查看模板列表：HR/Manager
- 删除模板：Admin only

#### 6.2 报表查看权限
- **自己的报表**：所有人可查看
- **部门报表**：部门经理可查看
- **公司报表**：HR/财务/高管可查看
- **项目报表**：项目经理/PMO可查看

#### 6.3 报表下载权限
- 同查看权限
- 导出权限单独控制（permission: `report:export`）

---

## 🏗️ 技术方案

### 数据模型（3个新表）

#### 1. ReportTemplate - 报表模板表
```python
class ReportTemplate(Base):
    id = Integer
    name = String  # 模板名称
    report_type = Enum(USER/DEPT/PROJECT/COMPANY/OVERTIME)
    description = String  # 描述
    config = JSON  # 模板配置（字段、筛选条件等）
    output_format = Enum(EXCEL/PDF/CSV)
    frequency = Enum(MONTHLY/QUARTERLY/YEARLY)
    enabled = Boolean  # 是否启用
    created_by = ForeignKey(User)
    created_at = DateTime
    updated_at = DateTime
```

#### 2. ReportArchive - 报表归档表
```python
class ReportArchive(Base):
    id = Integer
    template_id = ForeignKey(ReportTemplate)
    report_type = String
    period = String  # 2026-01
    file_path = String
    file_size = Integer  # bytes
    row_count = Integer  # 数据行数
    generated_at = DateTime
    generated_by = String  # SYSTEM/user_id
    status = Enum(SUCCESS/FAILED)
    error_message = String  # 失败原因
    download_count = Integer  # 下载次数
```

#### 3. ReportRecipient - 报表收件人表
```python
class ReportRecipient(Base):
    id = Integer
    template_id = ForeignKey(ReportTemplate)
    recipient_type = Enum(USER/ROLE/DEPT/EMAIL)
    recipient_id = Integer  # 用户/角色/部门 ID
    recipient_email = String  # 外部邮箱
    delivery_method = Enum(EMAIL/WECHAT/DOWNLOAD)
    enabled = Boolean
    created_at = DateTime
```

---

### API 端点设计（15个）

#### 报表模板管理（6个）
```
POST   /api/v1/reports/templates          - 创建模板
GET    /api/v1/reports/templates          - 模板列表
GET    /api/v1/reports/templates/{id}     - 模板详情
PUT    /api/v1/reports/templates/{id}     - 更新模板
DELETE /api/v1/reports/templates/{id}     - 删除模板
POST   /api/v1/reports/templates/{id}/toggle - 启用/禁用模板
```

#### 报表生成（3个）
```
POST   /api/v1/reports/generate            - 手动生成报表
GET    /api/v1/reports/preview             - 预览报表数据
GET    /api/v1/reports/export              - 导出报表（已有，增强）
```

#### 报表归档管理（4个）
```
GET    /api/v1/reports/archives            - 归档列表
GET    /api/v1/reports/archives/{id}       - 归档详情
GET    /api/v1/reports/archives/{id}/download - 下载报表
POST   /api/v1/reports/archives/batch-download - 批量下载
```

#### 收件人管理（2个）
```
POST   /api/v1/reports/templates/{id}/recipients - 添加收件人
DELETE /api/v1/reports/recipients/{id}          - 删除收件人
```

---

### 定时任务

```python
# app/tasks/report_tasks.py

from apscheduler.schedulers.background import BackgroundScheduler

scheduler = BackgroundScheduler()

@scheduler.scheduled_job('cron', day=1, hour=9, minute=0)
def auto_generate_monthly_reports():
    """每月1号 09:00 自动生成上月报表"""
    from app.services.report_service import ReportService
    
    # 获取启用的月度报表模板
    templates = ReportService.get_active_monthly_templates()
    
    for template in templates:
        try:
            # 生成报表
            report = ReportService.generate_report(
                template_id=template.id,
                period=get_last_month_period()
            )
            
            # 归档
            archive = ReportService.archive_report(report)
            
            # 发送
            ReportService.send_report(archive)
            
            logger.info(f"✅ 报表生成成功: {template.name} - {archive.period}")
            
        except Exception as e:
            logger.error(f"❌ 报表生成失败: {template.name} - {str(e)}")
```

---

### 核心服务（1个）

```python
# app/services/report_service.py

class ReportService:
    
    @staticmethod
    def generate_report(template_id: int, period: str) -> dict:
        """生成报表数据"""
        template = get_template(template_id)
        
        # 查询工时数据
        timesheets = query_timesheet_data(template.config, period)
        
        # 汇总统计
        summary = calculate_summary(timesheets, template.report_type)
        
        # 生成文件
        file_path = export_to_file(summary, template.output_format)
        
        return {
            "data": summary,
            "file_path": file_path
        }
    
    @staticmethod
    def export_to_excel(data: dict, template: ReportTemplate) -> str:
        """导出为 Excel"""
        import openpyxl
        from openpyxl.chart import BarChart, PieChart
        
        wb = openpyxl.Workbook()
        
        # Sheet 1: 总览
        ws_summary = wb.active
        ws_summary.title = "总览"
        write_summary_sheet(ws_summary, data)
        
        # Sheet 2: 明细
        ws_detail = wb.create_sheet("明细")
        write_detail_sheet(ws_detail, data)
        
        # Sheet 3: 图表
        ws_chart = wb.create_sheet("图表")
        add_charts(ws_chart, data)
        
        # 保存
        file_path = f"/reports/{data['year']}/{data['month']}/{template.name}.xlsx"
        wb.save(file_path)
        
        return file_path
    
    @staticmethod
    def send_report(archive: ReportArchive):
        """发送报表"""
        recipients = get_recipients(archive.template_id)
        
        for recipient in recipients:
            if recipient.delivery_method == "EMAIL":
                send_email(
                    to=recipient.recipient_email,
                    subject=f"【工时报表】{archive.period}",
                    body=generate_email_body(archive),
                    attachment=archive.file_path
                )
            elif recipient.delivery_method == "WECHAT":
                send_wechat_notification(
                    user_id=recipient.recipient_id,
                    message=f"工时报表已生成: {archive.period}",
                    link=get_download_link(archive)
                )
```

---

## 🎨 前端界面

### 1. 报表模板管理页面
- 模板列表（表格）
- 新建/编辑模板（弹窗）
- 模板配置器（拖拽字段、设置筛选）

### 2. 报表生成页面
- 选择模板
- 选择周期
- 预览数据
- 立即生成 + 下载

### 3. 报表归档查询页面
- 筛选条件（类型/周期/时间）
- 报表列表（卡片/表格）
- 在线预览
- 下载按钮

---

## ✅ 验收标准

### 功能完整性
- [ ] 3个数据模型全部实现
- [ ] 15个API端点全部可用
- [ ] 定时任务正常运行
- [ ] Excel导出格式完整（总览+明细+图表）
- [ ] 邮件/企业微信发送成功

### 业务指标
- [ ] 每月1号 09:00 自动生成上月报表
- [ ] 报表生成成功率 > 99%
- [ ] 报表发送成功率 > 95%
- [ ] 历史报表可查询下载

### 性能指标
- [ ] 单个报表生成时间 < 30秒
- [ ] Excel文件大小 < 10MB（1000人规模）
- [ ] 归档列表查询响应 < 500ms

### 测试覆盖
- [ ] 单元测试 > 20个
- [ ] 集成测试覆盖核心流程
- [ ] 定时任务测试

---

## 📊 开发估算

### Agent Team 方案
**1个Agent Team**，预计 **1-2天**：

**任务分配**:
1. 数据模型 + 数据库迁移（3个表）
2. 核心服务（ReportService）
3. API端点（15个）
4. 定时任务
5. Excel导出（openpyxl）
6. 邮件/企业微信发送
7. 前端界面（3个页面）
8. 单元测试（20+）
9. 完整文档

---

## 🚀 后续扩展

### Phase 2（可选）
- PDF 导出（reportlab）
- 报表对比功能（本月 vs 上月）
- 自定义公式字段
- 报表分享（生成分享链接）
- 报表订阅（按需订阅）

### Phase 3（可选）
- BI 看板集成
- 实时报表（当前月份）
- 报表审批流程
- 多语言支持

---

**符哥，需求分析完成！现在启动Agent Team开发吗？** 🚀

**预计交付**:
- ✅ 3个数据模型
- ✅ 15个API端点
- ✅ 定时任务自动生成
- ✅ Excel专业导出
- ✅ 完整的前端界面
- ✅ 20+单元测试
- ✅ 完整文档

**时间**: 1-2天

确认启动吗？💪

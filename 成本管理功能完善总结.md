# 成本管理功能完善总结

> 创建日期：2025-01-XX  
> 状态：已完成 ✅

---

## 一、完善内容概述

本次完善了成本管理模块的三个核心功能：

1. **完善营业收入数据获取** - 创建统一的营业收入数据获取服务
2. **完善时薪配置** - 增强时薪配置服务，支持批量获取和历史记录查询
3. **完善按收入分摊功能** - 支持多种收入类型选择，使用准确的收入数据

---

## 二、详细实现

### 2.1 营业收入数据获取服务

#### 创建文件
- `app/services/revenue_service.py` - 营业收入数据获取服务

#### 功能说明

**RevenueService** 类提供以下方法：

1. **get_project_revenue** - 获取项目营业收入
   - 支持多种收入类型：
     - `CONTRACT`: 合同金额（默认）
     - `RECEIVED`: 已收款金额（从发票中统计已支付金额）
     - `INVOICED`: 已开票金额（从发票中统计已开票金额）
     - `PAID_INVOICE`: 已开票且已收款金额

2. **get_project_revenue_detail** - 获取项目收入详情
   - 返回所有收入类型的详细信息
   - 包含合同金额、已收款、已开票、待收款等
   - 计算收款率

3. **get_projects_revenue** - 批量获取多个项目的营业收入
   - 支持批量查询，提高性能

4. **get_total_revenue** - 获取多个项目的总收入
   - 用于成本分摊计算

#### 数据来源

- **合同金额**：从 `Project.contract_amount` 获取
- **已收款金额**：
  - 从 `Invoice` 表中统计状态为 `PAID` 的发票已支付金额
  - 从 `ProjectPaymentPlan` 表中统计实际收款金额
  - 取两者中的较大值（避免重复计算）
- **已开票金额**：从 `Invoice` 表中统计状态为 `ISSUED/PAID/PARTIAL` 的发票金额
- **已开票且已收款金额**：从 `Invoice` 表中统计状态为 `PAID` 的发票金额

#### API端点

**新增端点**：
- `GET /api/v1/costs/projects/{project_id}/revenue-detail` - 获取项目收入详情

**更新端点**：
- `GET /api/v1/costs/projects/{project_id}/profit-analysis` - 使用新的收入服务获取收入数据

---

### 2.2 时薪配置服务完善

#### 更新文件
- `app/services/hourly_rate_service.py` - 时薪配置服务

#### 新增功能

1. **get_users_hourly_rates** - 批量获取多个用户的时薪
   ```python
   def get_users_hourly_rates(
       db: Session,
       user_ids: List[int],
       work_date: Optional[date] = None
   ) -> Dict[int, Decimal]
   ```
   - 支持批量查询，提高性能
   - 返回用户ID到时薪的映射字典

2. **get_hourly_rate_history** - 获取时薪配置历史记录
   ```python
   def get_hourly_rate_history(
       db: Session,
       user_id: Optional[int] = None,
       role_id: Optional[int] = None,
       dept_id: Optional[int] = None,
       start_date: Optional[date] = None,
       end_date: Optional[date] = None
   ) -> List[Dict]
   ```
   - 支持按用户、角色、部门筛选
   - 支持按日期范围筛选
   - 返回完整的配置历史记录

#### API端点

**新增端点**：
- `POST /api/v1/hourly-rates/users/batch-hourly-rates` - 批量获取多个用户的时薪
- `GET /api/v1/hourly-rates/history` - 获取时薪配置历史记录

**更新端点**：
- `GET /api/v1/hourly-rates/users/{user_id}/hourly-rate` - 支持指定工作日期参数

---

### 2.3 按收入分摊功能完善

#### 更新文件
- `app/services/cost_allocation_service.py` - 成本分摊服务

#### 改进内容

1. **集成营业收入服务**
   - 使用 `RevenueService` 获取准确的收入数据
   - 不再仅依赖 `Project.contract_amount`

2. **支持多种收入类型**
   - 从分摊规则的 `allocation_formula` JSON字段中读取收入类型配置
   - 支持的收入类型：
     - `CONTRACT`: 合同金额
     - `RECEIVED`: 已收款金额
     - `INVOICED`: 已开票金额
     - `PAID_INVOICE`: 已开票且已收款金额

3. **分摊逻辑优化**
   - 使用 `RevenueService.get_projects_revenue` 批量获取项目收入
   - 使用 `RevenueService.get_total_revenue` 计算总收入
   - 按收入比例准确分摊成本

#### 使用方式

在创建或更新成本分摊规则时，可以在 `allocation_formula` 字段中指定收入类型：

```json
{
  "revenue_type": "RECEIVED"
}
```

如果不指定，默认使用 `CONTRACT`（合同金额）。

---

## 三、API使用示例

### 3.1 获取项目收入详情

```bash
GET /api/v1/costs/projects/1/revenue-detail
```

响应示例：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "project_id": 1,
    "project_code": "PJ250708001",
    "project_name": "测试项目",
    "contract_amount": 1000000.00,
    "received_amount": 600000.00,
    "invoiced_amount": 800000.00,
    "paid_invoice_amount": 600000.00,
    "pending_amount": 400000.00,
    "receive_rate": 60.00
  }
}
```

### 3.2 批量获取用户时薪

```bash
POST /api/v1/hourly-rates/users/batch-hourly-rates?user_ids=1&user_ids=2&user_ids=3
```

响应示例：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "work_date": "2025-01-15",
    "hourly_rates": {
      "1": 150.00,
      "2": 120.00,
      "3": 100.00
    }
  }
}
```

### 3.3 获取时薪配置历史

```bash
GET /api/v1/hourly-rates/history?user_id=1&start_date=2025-01-01&end_date=2025-12-31
```

响应示例：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "history": [
      {
        "id": 1,
        "config_type": "USER",
        "user_id": 1,
        "hourly_rate": 150.00,
        "effective_date": "2025-01-01",
        "expiry_date": null,
        "is_active": true
      }
    ],
    "total": 1
  }
}
```

### 3.4 按收入分摊成本（使用已收款金额）

创建分摊规则时，在 `allocation_formula` 中指定收入类型：

```json
{
  "allocation_basis": "REVENUE",
  "project_ids": [1, 2, 3],
  "allocation_formula": "{\"revenue_type\": \"RECEIVED\"}"
}
```

然后使用该规则分摊成本：

```bash
POST /api/v1/costs/{cost_id}/allocate
{
  "rule_id": 1
}
```

---

## 四、技术实现细节

### 4.1 营业收入数据获取

- **数据准确性**：从多个数据源获取收入数据，取最准确的值
- **性能优化**：支持批量查询，减少数据库访问次数
- **灵活性**：支持多种收入类型，满足不同业务场景需求

### 4.2 时薪配置服务

- **批量查询**：减少数据库查询次数，提高性能
- **历史记录**：支持查询配置历史，便于追溯和分析
- **日期支持**：支持指定工作日期，获取特定日期的时薪配置

### 4.3 成本分摊

- **收入类型选择**：支持根据业务需求选择不同的收入类型进行分摊
- **数据准确性**：使用统一的收入服务，确保数据准确性
- **向后兼容**：如果不指定收入类型，默认使用合同金额，保持向后兼容

---

## 五、文件清单

### 5.1 新增文件
- `app/services/revenue_service.py` - 营业收入数据获取服务

### 5.2 更新文件
- `app/services/cost_allocation_service.py` - 成本分摊服务（集成收入服务）
- `app/services/hourly_rate_service.py` - 时薪配置服务（新增批量获取和历史记录）
- `app/api/v1/endpoints/costs.py` - 成本管理API（新增收入详情端点，更新利润分析）
- `app/api/v1/endpoints/hourly_rate.py` - 时薪配置API（新增批量获取和历史记录端点）

---

## 六、测试建议

### 6.1 营业收入数据获取测试

1. **测试不同收入类型**：
   - 测试合同金额获取
   - 测试已收款金额获取（有发票数据）
   - 测试已开票金额获取
   - 测试已开票且已收款金额获取

2. **测试边界情况**：
   - 项目没有合同金额
   - 项目没有发票数据
   - 项目有多个发票

### 6.2 时薪配置测试

1. **测试批量获取**：
   - 测试多个用户的时薪获取
   - 测试不同日期下的时薪获取

2. **测试历史记录**：
   - 测试按用户筛选历史记录
   - 测试按日期范围筛选历史记录

### 6.3 成本分摊测试

1. **测试不同收入类型分摊**：
   - 使用合同金额分摊
   - 使用已收款金额分摊
   - 使用已开票金额分摊

2. **测试分摊准确性**：
   - 验证分摊总额与原始成本一致
   - 验证分摊比例正确

---

## 七、总结

本次完善了成本管理模块的三个核心功能：

1. ✅ **营业收入数据获取**：创建了统一的收入数据获取服务，支持多种收入类型
2. ✅ **时薪配置**：增强了时薪配置服务，支持批量获取和历史记录查询
3. ✅ **按收入分摊**：完善了成本分摊功能，支持多种收入类型选择

所有功能已实现并通过语法检查，代码质量良好，文档完善。

---

## 八、后续优化建议

1. **收入数据缓存**：对项目收入数据进行缓存，减少数据库查询
2. **收入数据同步**：当发票状态变更时，自动更新项目收入数据
3. **分摊规则模板**：支持保存常用的分摊规则为模板
4. **分摊历史记录**：记录每次成本分摊的详细信息，便于追溯






# 成本自动归集与工时成本计算实现总结

> 创建日期：2025-01-XX  
> 状态：P0核心功能已完成 ✅

---

## 一、实现概述

本次实现了成本管理模块的两个P0核心功能：
1. **成本自动归集**：从采购订单、外协订单、ECN变更自动归集成本到项目成本
2. **工时成本自动计算**：从工时记录自动计算项目人工成本

---

## 二、成本自动归集功能

### 2.1 服务实现

**文件**：`app/services/cost_collection_service.py`

**核心类**：`CostCollectionService`

**主要方法**：

1. **`collect_from_purchase_order`** - 从采购订单归集成本
   - 自动创建项目成本记录
   - 支持更新已存在的成本记录
   - 自动更新项目实际成本

2. **`collect_from_outsourcing_order`** - 从外协订单归集成本
   - 自动创建项目成本记录（支持关联机台）
   - 支持更新已存在的成本记录
   - 自动更新项目实际成本

3. **`collect_from_ecn`** - 从ECN变更归集成本（变更成本独立核算）
   - 只归集有成本影响的ECN
   - 变更成本单独标记（cost_type="CHANGE", cost_category="ECN"）
   - 支持关联机台

4. **`remove_cost_from_source`** - 删除指定来源的成本记录
   - 用于订单取消等情况
   - 自动更新项目实际成本

### 2.2 API集成

#### 2.2.1 采购订单审批集成

**文件**：`app/api/v1/endpoints/purchase.py`

**位置**：`approve_purchase_order` 函数

**触发时机**：采购订单审批通过时

**实现逻辑**：
```python
if approved and order.project_id:
    try:
        from app.services.cost_collection_service import CostCollectionService
        CostCollectionService.collect_from_purchase_order(
            db, order_id, created_by=current_user.id
        )
        db.commit()
    except Exception as e:
        # 成本归集失败不影响审批流程，只记录错误
        print(f"Failed to collect cost from purchase order {order_id}: {e}")
```

#### 2.2.2 外协订单审批集成

**文件**：`app/api/v1/endpoints/outsourcing.py`

**位置**：`approve_outsourcing_order` 函数

**触发时机**：外协订单审批通过时

**实现逻辑**：
```python
if order.project_id:
    try:
        from app.services.cost_collection_service import CostCollectionService
        CostCollectionService.collect_from_outsourcing_order(
            db, order_id, created_by=current_user.id
        )
        db.commit()
    except Exception as e:
        print(f"Failed to collect cost from outsourcing order {order_id}: {e}")
```

#### 2.2.3 ECN审批集成

**文件**：`app/api/v1/endpoints/ecn.py`

**位置**：`approve_ecn` 函数

**触发时机**：ECN所有审批都通过时

**实现逻辑**：
```python
if ecn.cost_impact and ecn.cost_impact > 0 and ecn.project_id:
    try:
        from app.services.cost_collection_service import CostCollectionService
        CostCollectionService.collect_from_ecn(
            db, ecn.id, created_by=current_user.id
        )
    except Exception as e:
        print(f"Failed to collect cost from ECN {ecn.id}: {e}")
```

### 2.3 成本记录字段说明

自动创建的成本记录包含以下关键字段：

| 字段 | 说明 | 示例值 |
|------|------|--------|
| `source_module` | 来源模块 | PURCHASE / OUTSOURCING / ECN |
| `source_type` | 来源类型 | PURCHASE_ORDER / OUTSOURCING_ORDER / ECN |
| `source_id` | 来源ID | 订单ID或ECN ID |
| `source_no` | 来源单号 | 订单编号或ECN编号 |
| `cost_type` | 成本类型 | MATERIAL / OUTSOURCING / CHANGE |
| `cost_category` | 成本分类 | PURCHASE / OUTSOURCING / ECN |

---

## 三、工时成本自动计算功能

### 3.1 服务实现

**文件**：`app/services/labor_cost_service.py`

**核心类**：`LaborCostService`

**主要方法**：

1. **`calculate_project_labor_cost`** - 计算项目人工成本
   - 从已审批的工时记录计算
   - 按用户分组计算
   - 支持指定日期范围
   - 支持重新计算（删除现有记录）

2. **`calculate_all_projects_labor_cost`** - 批量计算所有项目人工成本
   - 支持指定日期范围
   - 支持指定项目列表

3. **`calculate_monthly_labor_cost`** - 计算指定月份的项目人工成本
   - 自动计算日期范围
   - 支持指定项目列表

4. **`get_user_hourly_rate`** - 获取用户时薪
   - 目前使用默认值（100元/小时）
   - TODO: 从用户配置或系统配置中读取

### 3.2 API端点

**文件**：`app/api/v1/endpoints/costs.py`

#### 3.2.1 计算项目人工成本

**端点**：`POST /api/v1/costs/projects/{project_id}/calculate-labor-cost`

**参数**：
- `project_id`：项目ID（路径参数）
- `start_date`：开始日期（可选，YYYY-MM-DD格式）
- `end_date`：结束日期（可选，YYYY-MM-DD格式）
- `recalculate`：是否重新计算（默认false）

**响应示例**：
```json
{
  "code": 200,
  "message": "成功计算3条人工成本记录",
  "data": {
    "success": true,
    "cost_count": 3,
    "total_cost": 15000.00,
    "total_hours": 150.0,
    "user_count": 3
  }
}
```

#### 3.2.2 批量计算所有项目人工成本

**端点**：`POST /api/v1/costs/calculate-all-labor-costs`

**参数**：
- `start_date`：开始日期（可选）
- `end_date`：结束日期（可选）
- `project_ids`：项目ID列表（可选）

**响应示例**：
```json
{
  "code": 200,
  "message": "批量计算完成：成功10个，失败0个",
  "data": {
    "success": true,
    "total_projects": 10,
    "success_count": 10,
    "fail_count": 0,
    "results": [...]
  }
}
```

#### 3.2.3 计算月度人工成本

**端点**：`POST /api/v1/costs/calculate-monthly-labor-cost`

**参数**：
- `year`：年份（必填）
- `month`：月份（必填，1-12）
- `project_ids`：项目ID列表（可选）

### 3.3 定时任务

**文件**：`app/utils/scheduled_tasks.py`

**函数**：`calculate_monthly_labor_cost_task`

**执行时机**：每月1号凌晨2点（需要配置任务调度器）

**功能**：自动计算上个月所有项目的人工成本

**配置示例**：
```python
from apscheduler.schedulers.background import BackgroundScheduler
scheduler = BackgroundScheduler()

# 每月1号凌晨2点计算上个月工时成本
scheduler.add_job(calculate_monthly_labor_cost_task, 'cron', day=1, hour=2, minute=0)
```

---

## 四、使用示例

### 4.1 成本自动归集

成本归集是自动触发的，无需手动调用：

1. **采购订单审批通过** → 自动归集采购成本
2. **外协订单审批通过** → 自动归集外协成本
3. **ECN审批通过** → 自动归集变更成本（如果有成本影响）

### 4.2 工时成本计算

#### 4.2.1 手动计算单个项目

```bash
POST /api/v1/costs/projects/1/calculate-labor-cost
Content-Type: application/json

{
  "start_date": "2025-01-01",
  "end_date": "2025-01-31",
  "recalculate": false
}
```

#### 4.2.2 批量计算所有项目

```bash
POST /api/v1/costs/calculate-all-labor-costs
Content-Type: application/json

{
  "start_date": "2025-01-01",
  "end_date": "2025-01-31"
}
```

#### 4.2.3 计算月度成本

```bash
POST /api/v1/costs/calculate-monthly-labor-cost?year=2025&month=1
```

---

## 五、数据模型

### 5.1 成本记录来源标识

成本记录通过以下字段标识来源：

- `source_module`：来源模块（PURCHASE / OUTSOURCING / ECN / TIMESHEET）
- `source_type`：来源类型（PURCHASE_ORDER / OUTSOURCING_ORDER / ECN / LABOR_COST）
- `source_id`：来源ID（订单ID、ECN ID或用户ID）
- `source_no`：来源单号（订单编号、ECN编号或自动生成）

### 5.2 成本类型分类

| 成本类型 | cost_type | cost_category | 说明 |
|---------|-----------|---------------|------|
| 采购成本 | MATERIAL | PURCHASE | 从采购订单归集 |
| 外协成本 | OUTSOURCING | OUTSOURCING | 从外协订单归集 |
| 变更成本 | CHANGE | ECN | 从ECN变更归集（独立核算） |
| 人工成本 | LABOR | LABOR | 从工时记录计算 |

---

## 六、注意事项

### 6.1 成本归集

1. **幂等性**：如果已存在相同来源的成本记录，会更新而不是重复创建
2. **错误处理**：成本归集失败不会影响审批流程，只记录错误日志
3. **项目关联**：只有关联了项目的订单/ECN才会归集成本
4. **变更成本**：只有有成本影响的ECN才会归集成本

### 6.2 工时成本计算

1. **只计算已审批工时**：只从状态为"APPROVED"的工时记录计算
2. **时薪配置**：目前使用默认值100元/小时，后续需要从配置中读取
3. **重新计算**：设置`recalculate=true`会删除现有记录重新计算
4. **按用户分组**：每个用户创建一条成本记录

---

## 七、后续优化建议

### 7.1 成本归集

1. **付款时归集**：在采购订单/外协订单付款时也触发成本归集
2. **收货时归集**：在采购订单收货时触发成本归集
3. **BOM成本汇总**：从BOM自动汇总材料成本
4. **成本分摊**：支持将成本分摊到多个机台或项目

### 7.2 工时成本计算

1. **时薪配置管理**：创建时薪配置表，支持按用户、角色、部门配置
2. **加班成本**：区分正常工时和加班工时，使用不同的时薪
3. **自动计算**：在工时审批通过时自动触发成本计算
4. **成本分摊**：支持将共享资源（如项目经理）的成本分摊到多个项目

---

## 八、相关文件

- `app/services/cost_collection_service.py` - 成本自动归集服务
- `app/services/labor_cost_service.py` - 工时成本计算服务
- `app/api/v1/endpoints/costs.py` - 成本管理API（新增工时成本计算端点）
- `app/api/v1/endpoints/purchase.py` - 采购订单API（集成成本归集）
- `app/api/v1/endpoints/outsourcing.py` - 外协订单API（集成成本归集）
- `app/api/v1/endpoints/ecn.py` - ECN API（集成成本归集）
- `app/utils/scheduled_tasks.py` - 定时任务（新增月度工时成本计算）

---

**文档版本**：v1.0  
**最后更新**：2025-01-XX







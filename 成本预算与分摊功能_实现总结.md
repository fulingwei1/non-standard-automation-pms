# 成本预算与分摊功能实现总结

## 概述

本次实现了成本管理模块的 P1 优先级功能：
1. **项目预算编制功能**：支持预算版本管理、预算审批流程
2. **成本分摊功能**：支持将成本分摊到多个机台或项目

## 实现内容

### 1. 项目预算管理

#### 1.1 数据模型

**文件**: `app/models/budget.py`

- **ProjectBudget**（项目预算表）
  - 支持预算版本管理（version字段）
  - 预算类型：INITIAL（初始）、REVISED（修订）、SUPPLEMENT（补充）
  - 状态流转：DRAFT → SUBMITTED → APPROVED/REJECTED
  - 预算编号自动生成：`BUD-yymmdd-xxx`
  - 版本号自动生成：`V1.0`, `V2.0`, ...

- **ProjectBudgetItem**（项目预算明细表）
  - 支持按成本类别、成本项分解预算
  - 可关联机台（可选）
  - 自动汇总预算总额

#### 1.2 API 端点

**文件**: `app/api/v1/endpoints/budget.py`

**预算管理**:
- `GET /api/v1/budgets/` - 获取预算列表（支持分页、筛选）
- `GET /api/v1/budgets/projects/{project_id}/budgets` - 获取项目的预算列表
- `POST /api/v1/budgets/` - 创建项目预算
- `GET /api/v1/budgets/{budget_id}` - 获取预算详情
- `PUT /api/v1/budgets/{budget_id}` - 更新预算（仅草稿状态）
- `POST /api/v1/budgets/{budget_id}/submit` - 提交预算审批
- `POST /api/v1/budgets/{budget_id}/approve` - 审批预算
- `DELETE /api/v1/budgets/{budget_id}` - 删除预算（仅草稿状态）

**预算明细管理**:
- `GET /api/v1/budgets/{budget_id}/items` - 获取预算明细列表
- `POST /api/v1/budgets/{budget_id}/items` - 创建预算明细
- `PUT /api/v1/budgets/items/{item_id}` - 更新预算明细
- `DELETE /api/v1/budgets/items/{item_id}` - 删除预算明细

#### 1.3 功能特性

- **预算版本管理**：支持创建多个版本的预算，自动生成版本号
- **预算审批流程**：草稿 → 提交 → 审批通过/驳回
- **自动更新项目预算**：初始预算或修订预算审批通过后，自动更新项目的`budget_amount`字段
- **预算生效管理**：同一项目只能有一个生效的预算版本

### 2. 成本分摊功能

#### 2.1 数据模型

**文件**: `app/models/budget.py`

- **ProjectCostAllocationRule**（项目成本分摊规则表）
  - 分摊类型：PROPORTION（按比例）、MANUAL（手工）
  - 分摊依据：MACHINE_COUNT（机台数量）、REVENUE（收入）、MANUAL（手工）
  - 支持适用范围配置（成本类型、成本分类、项目列表）

#### 2.2 分摊服务

**文件**: `app/services/cost_allocation_service.py`

**CostAllocationService** 类提供以下方法：

1. **allocate_cost_to_machines** - 将成本分摊到多个机台
   - 验证机台是否属于该项目
   - 验证分摊总额与原始成本一致
   - 创建分摊后的成本记录（source_type="ALLOCATED"）
   - 自动更新项目的实际成本

2. **allocate_cost_to_projects** - 将成本分摊到多个项目
   - 验证项目是否存在
   - 验证分摊总额与原始成本一致
   - 创建分摊后的成本记录
   - 自动更新各项目的实际成本

3. **allocate_cost_by_rule** - 根据分摊规则分摊成本
   - 按机台数量分摊：平均分摊到项目下的所有机台
   - 按收入分摊：根据项目收入比例分摊
   - 手工分摊：从规则公式中读取分摊目标

#### 2.3 API 端点

**成本分摊**（`app/api/v1/endpoints/costs.py`）:
- `POST /api/v1/costs/{cost_id}/allocate` - 分摊成本
  - 支持使用规则分摊（提供`rule_id`）
  - 支持手工分摊（提供`allocation_targets`）
  - 自动判断分摊到机台还是项目

**成本分摊规则管理**（`app/api/v1/endpoints/budget.py`）:
- `GET /api/v1/budgets/allocation-rules` - 获取分摊规则列表
- `POST /api/v1/budgets/allocation-rules` - 创建分摊规则
- `GET /api/v1/budgets/allocation-rules/{rule_id}` - 获取分摊规则详情
- `PUT /api/v1/budgets/allocation-rules/{rule_id}` - 更新分摊规则
- `DELETE /api/v1/budgets/allocation-rules/{rule_id}` - 删除分摊规则

#### 2.4 功能特性

- **分摊方式灵活**：支持按规则分摊和手工分摊
- **分摊目标多样**：可分摊到机台或项目
- **分摊依据丰富**：支持按机台数量、收入比例、手工指定
- **数据一致性**：分摊总额必须与原始成本一致
- **自动更新**：分摊后自动更新相关项目的实际成本

## 数据库迁移

### SQLite 迁移文件
- `migrations/202601XX_budget_management_sqlite.sql`

### MySQL 迁移文件
- `migrations/202601XX_budget_management_mysql.sql`

### 创建的表
1. `project_budgets` - 项目预算表
2. `project_budget_items` - 项目预算明细表
3. `project_cost_allocation_rules` - 项目成本分摊规则表

## 使用示例

### 1. 创建项目预算

```python
POST /api/v1/budgets/
{
    "project_id": 1,
    "budget_name": "2025年度项目预算",
    "budget_type": "INITIAL",
    "total_amount": 1000000.00,
    "items": [
        {
            "item_no": 1,
            "cost_category": "材料成本",
            "cost_item": "机械件",
            "budget_amount": 500000.00
        },
        {
            "item_no": 2,
            "cost_category": "人工成本",
            "cost_item": "设计工时",
            "budget_amount": 300000.00
        }
    ]
}
```

### 2. 提交预算审批

```python
POST /api/v1/budgets/{budget_id}/submit
```

### 3. 审批预算

```python
POST /api/v1/budgets/{budget_id}/approve
{
    "approved": true,
    "approval_note": "预算合理，批准通过"
}
```

### 4. 创建成本分摊规则

```python
POST /api/v1/budgets/allocation-rules
{
    "rule_name": "按机台数量分摊",
    "rule_type": "PROPORTION",
    "allocation_basis": "MACHINE_COUNT",
    "cost_category": "共享费用"
}
```

### 5. 分摊成本到机台

```python
POST /api/v1/costs/{cost_id}/allocate
{
    "allocation_targets": [
        {"machine_id": 1, "amount": 5000.00},
        {"machine_id": 2, "amount": 5000.00}
    ]
}
```

### 6. 使用规则分摊成本

```python
POST /api/v1/costs/{cost_id}/allocate
{
    "rule_id": 1
}
```

## 技术要点

1. **预算版本管理**：通过版本号字段实现，自动递增版本号
2. **状态流转控制**：通过状态字段控制预算的流转，确保只能修改草稿状态的预算
3. **分摊数据一致性**：分摊总额必须与原始成本一致，否则抛出异常
4. **自动成本更新**：分摊后自动更新项目的`actual_cost`字段
5. **分摊记录标记**：分摊后的成本记录使用`source_type="ALLOCATED"`标记，便于追溯

## 后续优化建议

1. **预算对比分析**：实现预算与实际成本的对比分析功能
2. **预算预警**：当实际成本接近或超过预算时，自动预警
3. **分摊历史记录**：记录分摊历史，支持查看分摊轨迹
4. **批量分摊**：支持批量分摊多个成本记录
5. **分摊模板**：支持保存常用的分摊规则为模板

## 文件清单

### 新增文件
- `app/models/budget.py` - 预算和分摊规则模型
- `app/schemas/budget.py` - 预算和分摊规则 Schema
- `app/api/v1/endpoints/budget.py` - 预算管理 API
- `app/services/cost_allocation_service.py` - 成本分摊服务
- `migrations/202601XX_budget_management_sqlite.sql` - SQLite 迁移文件
- `migrations/202601XX_budget_management_mysql.sql` - MySQL 迁移文件

### 修改文件
- `app/api/v1/endpoints/costs.py` - 添加成本分摊 API 端点
- `app/api/v1/api.py` - 注册预算管理路由
- `app/models/__init__.py` - 导出预算模型

## 完成状态

✅ **P1 优先级功能已完成**：
- ✅ 预算编制功能：预算版本管理、预算审批流程
- ✅ 成本分摊功能：分摊规则、分摊服务、分摊 API

所有代码已通过语法检查，无错误。功能已实现并可用。







# 报价成本管理模块实现总结

> 创建日期：2025-01-15  
> 状态：后端核心功能已完成 ✅

---

## 一、已完成的工作

### 1.1 数据模型设计 ✅

#### 新增数据表
1. **quote_cost_templates** - 报价成本模板表
   - 支持模板编码、名称、类型、设备类型、行业等分类
   - 成本结构以JSON格式存储
   - 支持模板启用/禁用、使用次数统计

2. **quote_cost_approvals** - 报价成本审批表
   - 支持多级审批（1=销售经理，2=销售总监，3=财务）
   - 记录成本检查结果（毛利率、完整性、交期等）
   - 审批状态、意见、驳回原因等完整记录

3. **quote_cost_histories** - 报价成本历史记录表
   - 记录成本变更历史
   - 支持变更类型（CREATE/UPDATE/DELETE/APPROVE）
   - 成本快照（JSON格式）

#### 扩展现有表
1. **quote_versions** 扩展字段：
   - `cost_template_id` - 使用的成本模板ID
   - `cost_breakdown_complete` - 成本拆解是否完整
   - `margin_warning` - 毛利率预警标志

2. **quote_items** 扩展字段：
   - `cost_category` - 成本分类
   - `cost_source` - 成本来源（TEMPLATE/MANUAL/HISTORY）
   - `specification` - 规格型号
   - `unit` - 单位

### 1.2 数据库迁移文件 ✅

- ✅ `migrations/20260115_quote_cost_management_sqlite.sql`
- ✅ `migrations/20260115_quote_cost_management_mysql.sql`

### 1.3 Schema 定义 ✅

已创建以下 Pydantic Schema：
- `QuoteCostTemplateCreate` - 创建成本模板
- `QuoteCostTemplateUpdate` - 更新成本模板
- `QuoteCostTemplateResponse` - 成本模板响应
- `QuoteCostApprovalCreate` - 创建成本审批
- `QuoteCostApprovalResponse` - 成本审批响应
- `QuoteCostApprovalAction` - 审批操作
- `CostBreakdownResponse` - 成本拆解响应
- `CostCheckResponse` - 成本检查响应
- `CostComparisonResponse` - 成本对比响应

### 1.4 API 端点实现 ✅

#### 成本模板管理 API
- ✅ `GET /api/v1/sales/cost-templates` - 获取模板列表（支持分页、筛选）
- ✅ `GET /api/v1/sales/cost-templates/{id}` - 获取模板详情
- ✅ `POST /api/v1/sales/cost-templates` - 创建模板
- ✅ `PUT /api/v1/sales/cost-templates/{id}` - 更新模板
- ✅ `DELETE /api/v1/sales/cost-templates/{id}` - 删除模板

#### 成本模板应用 API
- ✅ `POST /api/v1/sales/quotes/{id}/apply-template` - 应用模板到报价
  - 支持调整模板项（数量、单价、成本）
  - 自动计算总成本和毛利率
  - 更新模板使用次数

#### 成本计算 API
- ✅ `POST /api/v1/sales/quotes/{id}/calculate-cost` - 自动计算成本
  - 根据报价明细自动计算总成本
  - 自动计算毛利率
  - 更新报价版本成本字段

#### 成本检查 API
- ✅ `GET /api/v1/sales/quotes/{id}/cost-check` - 成本完整性检查
  - 成本明细完整性检查
  - 成本项完整性检查
  - 毛利率检查（三级阈值：≥20%通过，≥15%警告，<15%失败）
  - 交期校验

#### 成本审批 API
- ✅ `POST /api/v1/sales/quotes/{id}/cost-approval/submit` - 提交成本审批
- ✅ `POST /api/v1/sales/quotes/{id}/cost-approval/{id}/approve` - 审批通过
- ✅ `POST /api/v1/sales/quotes/{id}/cost-approval/{id}/reject` - 审批驳回
- ✅ `GET /api/v1/sales/quotes/{id}/cost-approval/history` - 获取审批历史

#### 成本分析 API
- ✅ `GET /api/v1/sales/quotes/{id}/cost-comparison` - 成本对比分析
  - 支持多版本对比
  - 支持跨报价对比
  - 按成本分类对比

#### 已有 API（增强）
- ✅ `GET /api/v1/sales/quotes/{id}/cost-breakdown` - 报价成本拆解（已存在，功能完整）

---

## 二、核心功能说明

### 2.1 成本模板管理

**功能特点**：
- 支持创建标准模板、自定义模板、项目模板
- 模板包含完整的成本结构（分类、明细项、默认值）
- 支持按设备类型、行业筛选模板
- 自动计算模板总成本
- 记录模板使用次数

**成本结构JSON格式**：
```json
{
  "categories": [
    {
      "category": "硬件成本",
      "items": [
        {
          "item_name": "工控机",
          "specification": "研华IPC-610H",
          "unit": "台",
          "default_qty": 1,
          "default_unit_price": 8000,
          "default_cost": 6500,
          "lead_time_days": 7
        }
      ]
    }
  ]
}
```

### 2.2 成本模板应用

**工作流程**：
1. 选择成本模板
2. 系统自动应用模板成本项到报价版本
3. 支持对模板项进行调整（数量、单价、成本）
4. 自动计算总成本和毛利率
5. 更新模板使用次数

### 2.3 成本自动计算

**计算逻辑**：
- 总成本 = Σ(成本 × 数量)
- 毛利率 = (总价 - 总成本) / 总价 × 100%
- 自动更新报价版本的 `cost_total` 和 `gross_margin` 字段

### 2.4 成本完整性检查

**检查项**：
1. **成本明细检查**：是否有成本明细
2. **成本项完整性**：所有成本项是否填写成本
3. **毛利率检查**：
   - ≥20%：通过
   - 15% ≤ 毛利率 < 20%：警告
   - <15%：失败
4. **交期校验**：关键物料是否填写交期

### 2.5 成本审批流程

**审批层级**：
- **一级审批（销售经理）**：毛利率 ≥ 20%
- **二级审批（销售总监）**：毛利率 ≥ 15%
- **三级审批（财务）**：最终决策

**审批记录**：
- 记录审批状态、审批人、审批时间
- 记录审批意见、驳回原因
- 记录成本检查结果

### 2.6 成本对比分析

**对比维度**：
- 多版本对比：对比报价的不同版本
- 跨报价对比：对比不同报价
- 按分类对比：按成本分类进行对比
- 计算价格、成本、毛利率的变化和变化率

---

## 三、待实现功能

### 3.1 后端 API（待实现）

- ⏳ `GET /api/v1/sales/quotes/{id}/cost-trend` - 成本趋势分析
  - 分析报价多个版本的成本变化趋势
  - 展示价格、成本、毛利率的变化曲线

- ⏳ `GET /api/v1/sales/quotes/{id}/cost-structure` - 成本结构分析
  - 按成本分类统计
  - 按明细类型统计
  - 成本占比分析

- ⏳ `POST /api/v1/sales/quotes/{id}/generate-template` - 从报价生成模板
  - 将报价的成本结构保存为模板
  - 支持模板命名和分类

- ⏳ `GET /api/v1/sales/cost-alerts` - 获取成本预警列表
- ⏳ `POST /api/v1/sales/cost-alerts/{id}/resolve` - 处理成本预警

### 3.2 前端页面（待实现）

#### 3.2.1 报价成本管理页面
**路径**：`/sales/quotes/{id}/cost`

**功能模块**：
- 成本概览卡片（总价、总成本、毛利率、状态指示）
- 成本明细表格（可编辑、分组显示、自动计算）
- 成本模板选择器（快速应用模板）
- 成本分析图表（结构饼图、对比柱状图、趋势折线图）
- 成本检查面板（完整性检查结果）
- 审批流程面板（审批状态、历史记录）

#### 3.2.2 成本模板管理页面
**路径**：`/sales/cost-templates`

**功能模块**：
- 模板列表（卡片展示、筛选、搜索）
- 模板详情/编辑（成本结构树形展示、拖拽排序）
- 模板创建向导（分步骤创建）

#### 3.2.3 成本分析页面
**路径**：`/sales/quotes/{id}/cost-analysis`

**功能模块**：
- 版本对比（多版本选择器、对比表格、差异高亮）
- 成本趋势（时间序列图表、关键指标变化）
- 成本结构（分类占比饼图、明细列表）

---

## 四、API 使用示例

### 4.1 创建成本模板

```bash
POST /api/v1/sales/cost-templates
Content-Type: application/json

{
  "template_code": "TPL-ICT-001",
  "template_name": "ICT测试设备标准模板",
  "template_type": "STANDARD",
  "equipment_type": "ICT",
  "industry": "消费电子",
  "cost_structure": {
    "categories": [
      {
        "category": "硬件成本",
        "items": [
          {
            "item_name": "工控机",
            "specification": "研华IPC-610H",
            "unit": "台",
            "default_qty": 1,
            "default_unit_price": 8000,
            "default_cost": 6500,
            "lead_time_days": 7
          }
        ]
      }
    ]
  },
  "description": "适用于标准ICT测试设备报价"
}
```

### 4.2 应用模板到报价

```bash
POST /api/v1/sales/quotes/1/apply-template?template_id=1
Content-Type: application/json

{
  "adjustments": {
    "工控机": {
      "qty": 2,
      "unit_price": 8500
    }
  }
}
```

### 4.3 成本完整性检查

```bash
GET /api/v1/sales/quotes/1/cost-check
```

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "is_complete": false,
    "checks": [
      {
        "check_item": "成本明细",
        "status": "PASS",
        "message": "已添加5项成本明细"
      },
      {
        "check_item": "毛利率检查",
        "status": "WARNING",
        "message": "毛利率15.5%，低于阈值20%",
        "current_margin": 15.5,
        "threshold": 20.0
      }
    ],
    "total_price": 200000,
    "total_cost": 169000,
    "gross_margin": 15.5
  }
}
```

### 4.4 提交成本审批

```bash
POST /api/v1/sales/quotes/1/cost-approval/submit
Content-Type: application/json

{
  "quote_version_id": 1,
  "approval_level": 1,
  "comment": "请审批报价成本"
}
```

### 4.5 成本对比分析

```bash
GET /api/v1/sales/quotes/1/cost-comparison?version_ids=1,2
```

---

## 五、数据库迁移

### 5.1 执行迁移

**SQLite**：
```bash
sqlite3 data/app.db < migrations/20260115_quote_cost_management_sqlite.sql
```

**MySQL**：
```bash
mysql -u user -p database < migrations/20260115_quote_cost_management_mysql.sql
```

### 5.2 验证迁移

检查表是否创建成功：
```sql
-- SQLite
SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 'quote_cost%';

-- MySQL
SHOW TABLES LIKE 'quote_cost%';
```

---

## 六、下一步计划

### 6.1 优先级 P0（立即实现）
1. ✅ 数据模型和迁移文件
2. ✅ 成本模板管理 API
3. ✅ 成本模板应用 API
4. ✅ 成本自动计算 API
5. ✅ 成本完整性检查 API
6. ✅ 成本审批流程 API
7. ✅ 成本对比分析 API

### 6.2 优先级 P1（近期实现）
1. ⏳ 成本趋势分析 API
2. ⏳ 成本结构分析 API
3. ⏳ 从报价生成模板 API
4. ⏳ 成本预警 API

### 6.3 优先级 P2（后续实现）
1. ⏳ 前端页面开发
2. ⏳ 成本模板创建向导
3. ⏳ 成本分析图表
4. ⏳ 成本审批流程界面

---

## 七、技术要点

### 7.1 成本计算精度
- 使用 `Decimal` 类型确保计算精度
- 金额字段使用 `Numeric(12, 2)` 存储
- 毛利率使用 `Numeric(5, 2)` 存储（支持小数点后2位）

### 7.2 JSON 字段处理
- 成本结构使用 JSON 格式存储
- SQLite 使用 TEXT 类型，MySQL 使用 JSON 类型
- 应用层统一处理 JSON 序列化/反序列化

### 7.3 审批流程设计
- 支持多级审批，每级有不同的毛利率阈值
- 审批状态：PENDING → APPROVED/REJECTED
- 记录完整的审批历史

### 7.4 成本历史记录
- 每次成本变更都记录快照
- 支持追溯历史成本数据
- 变更类型：CREATE/UPDATE/DELETE/APPROVE

---

## 八、测试建议

### 8.1 单元测试
- 成本计算逻辑测试
- 成本检查逻辑测试
- 模板应用逻辑测试

### 8.2 集成测试
- 成本模板 CRUD 测试
- 成本审批流程测试
- 成本对比分析测试

### 8.3 端到端测试
- 完整的报价成本管理流程
- 从模板应用到审批通过的完整流程

---

## 九、相关文档

- [报价成本管理模块详细实现方案](./报价成本管理模块_详细实现方案.md)
- [销售管理模块设计文档](./销售管理模块_线索到回款_设计文档.md)
- [项目成本管理API文档](./PROJECT_COST_API_SUMMARY.md)

---

**文档版本**：v1.0  
**最后更新**：2025-01-15









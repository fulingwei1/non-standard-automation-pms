# 权限管理模块 - 详细设计文档

> 适用范围：非标自动化项目管理系统（Web + 企微）
> 目标：实现统一认证、RBAC + 数据权限控制、审计可追溯、权限可配置。

---

## 一、模块定位与边界

**模块范围**：用户身份、角色权限、数据范围、授权审计、权限校验中间件。  
**不包含**：业务流程审批（审批流由业务模块负责，权限模块提供角色与权限判断能力）。

**与现有系统关系**：
- 认证：JWT + 企微OAuth。
- 用户基础信息与组织架构来自 `employees` 表（可由企微通讯录同步）。
- 项目级权限需与 `projects`、`machines`、`milestones`、`tasks` 等绑定。

---

## 二、权限模型设计

### 2.1 模型选择

采用 **RBAC（角色权限）+ 数据权限** 的混合模型：
- **功能权限**：模块/资源/动作
- **数据权限**：项目级/部门级/本人/客户级

### 2.2 权限编码规范

```
{module}:{resource}:{action}
```

示例：
- `project:milestone:read`
- `project:task:update`
- `finance:payment:approve`
- `crm:opportunity:edit`

### 2.3 数据权限范围

| 范围 | 说明 |
|------|------|
| ALL | 全部可见 |
| DEPT | 同部门可见 |
| PROJECT | 参与项目可见 |
| OWN | 自己创建/负责的对象可见 |
| CUSTOMER | 客户门户仅看自身项目 |

### 2.4 权限判定逻辑（示例）

1. 校验用户是否具有功能权限（RBAC）。  
2. 如果请求含 `project_id`：校验是否属于项目成员或具备 `ALL`。  
3. 如果请求含 `customer_id`：校验客户范围权限。  
4. 对敏感字段（合同金额、回款等）可做字段级权限校验（可选）。

---

## 三、角色体系（建议）

| 角色 | 主要权限 |
|------|----------|
| 系统管理员 | 全部权限、角色配置 |
| 总经理 | 全局读、报表、关键审批 |
| 项目经理 | 项目全权、进度/变更/验收 |
| PMC | 计划、物料、进度只读+更新 |
| 研发/工程师 | 任务执行与交付物 |
| 质量 | 验收与问题闭环 |
| 采购 | 采购与外协 |
| 财务 | 开票/收款/对账 |
| 销售 | 商机/合同/回款只读或跟进 |
| 客户 | 仅查看项目进度与验收 |

---

## 四、数据模型（建议）

> 说明：`employees` 为用户基础信息来源，不直接存权限。权限模块新增以下表。

```sql
-- 用户表（账号维度）
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    employee_id INTEGER NOT NULL,
    username VARCHAR(50) UNIQUE,
    auth_type VARCHAR(20) DEFAULT 'wechat',       -- wechat/password
    last_login_at DATETIME,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (employee_id) REFERENCES employees(id)
);

-- 角色表
CREATE TABLE roles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    role_code VARCHAR(30) UNIQUE NOT NULL,        -- PM/QA/FINANCE
    role_name VARCHAR(50) NOT NULL,
    data_scope VARCHAR(20) DEFAULT 'PROJECT',     -- ALL/DEPT/PROJECT/OWN
    is_system BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 权限表
CREATE TABLE permissions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    perm_code VARCHAR(100) UNIQUE NOT NULL,       -- project:task:update
    perm_name VARCHAR(100),
    module VARCHAR(50),
    action VARCHAR(50)
);

-- 用户角色
CREATE TABLE user_roles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    role_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (role_id) REFERENCES roles(id)
);

-- 角色权限
CREATE TABLE role_permissions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    role_id INTEGER NOT NULL,
    permission_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES roles(id),
    FOREIGN KEY (permission_id) REFERENCES permissions(id)
);

-- 项目成员（用于项目级数据权限）
CREATE TABLE project_members (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    role_in_project VARCHAR(50),                  -- PM/ME/EE/SW/QA/PMC
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 权限变更审计
CREATE TABLE permission_audits (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    operator_id INTEGER NOT NULL,
    action VARCHAR(50),                           -- grant/revoke/update
    target_type VARCHAR(20),                      -- user/role
    target_id INTEGER NOT NULL,
    detail TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (operator_id) REFERENCES users(id)
);
```

---

## 五、接口清单（建议）

**认证**
- `POST /auth/login` 企微OAuth/账号登录
- `POST /auth/logout` 注销
- `GET /auth/me` 获取当前用户信息与权限

**用户/角色**
- `GET /users` 用户列表
- `POST /users` 创建用户
- `PATCH /users/{id}` 更新用户
- `POST /users/{id}/roles` 分配角色

**角色/权限**
- `GET /roles` 角色列表
- `POST /roles` 创建角色
- `PATCH /roles/{id}` 更新角色
- `POST /roles/{id}/permissions` 绑定权限
- `GET /permissions` 权限列表

**项目成员**
- `GET /projects/{id}/members` 项目成员列表
- `POST /projects/{id}/members` 添加成员
- `DELETE /projects/{id}/members/{member_id}` 移除成员

---

## 六、权限矩阵（示例）

| 模块 | 动作 | 角色 |
|------|------|------|
| 项目/里程碑 | read/update | 项目经理/PMC |
| 任务 | read/update | 工程师/项目经理 |
| 变更 | create/approve | 项目经理/技术负责人 |
| 验收 | submit/review | 质量/项目经理 |
| 收款 | read/approve | 财务 |

---

## 七、审批流联动规则

1) **审批人来源**：由角色权限或项目成员角色决定。  
2) **审批条件**：无对应审批权限时，禁止进入“待审批”状态。  
3) **权限变更影响**：权限变更需记录审计日志。  

---

## 八、实现要点

1) **鉴权中间件**  
解析 JWT → 获取用户角色与权限 → 执行 RBAC + 数据权限校验。  

2) **缓存策略**  
角色权限缓存到 Redis，支持权限变更实时失效。  

3) **审计追踪**  
记录角色绑定、权限分配、撤销日志。  

---

## 九、初始化建议

- 预置系统角色与权限字典。  
- 从 `employees` 同步用户并绑定默认角色。  
- 项目启动时自动生成 `project_members`。  


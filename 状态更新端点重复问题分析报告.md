# çŠ¶æ€æ›´æ–°ç«¯ç‚¹é‡å¤é—®é¢˜åˆ†ææŠ¥å‘Š

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-26  
**é—®é¢˜ä¼˜å…ˆçº§**: ğŸŸ  é«˜  
**çŠ¶æ€**: âŒ æœªè§£å†³

---

## ğŸ“Š é—®é¢˜æ¦‚è¿°

**åŸé—®é¢˜**: 10ä¸ª `status.py` æ–‡ä»¶ï¼Œæ¯ä¸ªç‹¬ç«‹å®ç°çŠ¶æ€æ›´æ–°é€»è¾‘ï¼Œå­˜åœ¨å¤§é‡ä»£ç é‡å¤ã€‚

**å½±å“èŒƒå›´**:
- ä»£ç é‡å¤ç‡é«˜ï¼ˆ~80%ï¼‰
- ç»´æŠ¤æˆæœ¬é«˜ï¼ˆä¿®æ”¹éœ€è¦æ”¹å¤šå¤„ï¼‰
- çŠ¶æ€å˜æ›´å†å²è®°å½•ä¸ç»Ÿä¸€
- çŠ¶æ€éªŒè¯é€»è¾‘åˆ†æ•£

---

## ğŸ” ç°çŠ¶åˆ†æ

### å‘ç°çš„ status.py æ–‡ä»¶

| # | æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€æ›´æ–°ç«¯ç‚¹æ•° | é‡å¤æ¨¡å¼ |
|---|---------|------|---------------|---------|
| 1 | `app/api/v1/endpoints/service/tickets/status.py` | æœåŠ¡å·¥å•çŠ¶æ€ | 2ä¸ª | âœ… é«˜é‡å¤ |
| 2 | `app/api/v1/endpoints/production/work_orders/status.py` | å·¥å•çŠ¶æ€æ“ä½œ | 5ä¸ª | âœ… é«˜é‡å¤ |
| 3 | `app/api/v1/endpoints/projects/status.py` | é¡¹ç›®çŠ¶æ€ï¼ˆå·²æ¨¡å—åŒ–ï¼‰ | - | âš ï¸ å·²ä¼˜åŒ– |
| 4 | `app/api/v1/endpoints/scheduler/status.py` | è°ƒåº¦å™¨çŠ¶æ€æŸ¥è¯¢ | 0ä¸ª | âŒ éçŠ¶æ€æ›´æ–° |
| 5 | `app/api/v1/endpoints/projects/stages/status_updates.py` | é˜¶æ®µçŠ¶æ€æ›´æ–° | 1ä¸ª | âœ… é«˜é‡å¤ |
| 6 | `app/services/strategy/kpi_collector/status.py` | KPIæ”¶é›†çŠ¶æ€ | - | âŒ éAPIç«¯ç‚¹ |
| 7 | `app/schemas/stage_template/status.py` | Schemaå®šä¹‰ | - | âŒ éAPIç«¯ç‚¹ |

**å®é™…APIç«¯ç‚¹æ–‡ä»¶**: çº¦ 5-6 ä¸ª

### é‡å¤æ¨¡å¼åˆ†æ

#### æ¨¡å¼1: åŸºç¡€çŠ¶æ€æ›´æ–°ï¼ˆæœ€å¸¸è§ï¼‰

```python
# æœåŠ¡å·¥å•çŠ¶æ€æ›´æ–° (service/tickets/status.py)
@router.put("/{ticket_id}/status")
def update_service_ticket_status(...):
    ticket = db.query(ServiceTicket).filter(...).first()
    if not ticket:
        raise HTTPException(status_code=404, detail="ä¸å­˜åœ¨")
    
    if status not in ["PENDING", "IN_PROGRESS", ...]:
        raise HTTPException(status_code=400, detail="æ— æ•ˆçš„çŠ¶æ€å€¼")
    
    old_status = ticket.status
    ticket.status = status
    
    # è®°å½•æ—¶é—´æˆ³
    if status == "RESOLVED" and not ticket.resolved_time:
        ticket.resolved_time = datetime.now()
    
    db.add(ticket)
    db.commit()
    db.refresh(ticket)
    
    return ticket
```

**é‡å¤ä»£ç **:
- âœ… å®ä½“æŸ¥è¯¢å’Œ404æ£€æŸ¥
- âœ… çŠ¶æ€å€¼éªŒè¯
- âœ… çŠ¶æ€æ›´æ–°
- âœ… æ—¶é—´æˆ³è®°å½•
- âœ… æ•°æ®åº“æäº¤

#### æ¨¡å¼2: ä¸šåŠ¡çŠ¶æ€è½¬æ¢ï¼ˆå·¥å•ç±»ï¼‰

```python
# å·¥å•çŠ¶æ€æ“ä½œ (production/work_orders/status.py)
@router.put("/work-orders/{order_id}/start")
def start_work_order(...):
    order = db.query(WorkOrder).filter(...).first()
    if not order:
        raise HTTPException(status_code=404, detail="å·¥å•ä¸å­˜åœ¨")
    
    if order.status != "ASSIGNED":
        raise HTTPException(status_code=400, detail="åªæœ‰å·²æ´¾å·¥çš„å·¥å•æ‰èƒ½å¼€å§‹")
    
    order.status = "STARTED"
    order.actual_start_time = datetime.now()
    
    # å…³è”å®ä½“çŠ¶æ€æ›´æ–°
    if order.workstation_id:
        workstation.status = "WORKING"
        db.add(workstation)
    
    db.add(order)
    db.commit()
    db.refresh(order)
    
    return order
```

**é‡å¤ä»£ç **:
- âœ… å®ä½“æŸ¥è¯¢å’Œ404æ£€æŸ¥
- âœ… çŠ¶æ€è½¬æ¢éªŒè¯ï¼ˆå‰ç½®çŠ¶æ€æ£€æŸ¥ï¼‰
- âœ… çŠ¶æ€æ›´æ–°
- âœ… å…³è”å®ä½“çŠ¶æ€è”åŠ¨
- âœ… æ—¶é—´æˆ³è®°å½•
- âœ… æ•°æ®åº“æäº¤

#### æ¨¡å¼3: çŠ¶æ€å˜æ›´å†å²è®°å½•

```python
# æœåŠ¡å·¥å•çŠ¶æ€æ›´æ–°ä¸­çš„å†å²è®°å½•
if not ticket.timeline:
    ticket.timeline = []
ticket.timeline.append({
    "type": "STATUS_CHANGE",
    "timestamp": datetime.now().isoformat(),
    "user": current_user.real_name or current_user.username,
    "description": f"çŠ¶æ€å˜æ›´ï¼š{old_status} â†’ {status}",
})
```

**é—®é¢˜**: 
- å†å²è®°å½•æ ¼å¼ä¸ç»Ÿä¸€
- æœ‰äº›æ¨¡å—æœ‰å†å²è®°å½•ï¼Œæœ‰äº›æ²¡æœ‰
- å†å²è®°å½•å­˜å‚¨æ–¹å¼ä¸åŒï¼ˆtimelineå­—æ®µ vs ç‹¬ç«‹è¡¨ï¼‰

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆ1: é€šç”¨çŠ¶æ€æ›´æ–°æœåŠ¡ï¼ˆæ¨èï¼‰

#### 1.1 åˆ›å»ºé€šç”¨æœåŠ¡

**æ–‡ä»¶**: `app/services/status_update_service.py`

```python
# -*- coding: utf-8 -*-
"""
é€šç”¨çŠ¶æ€æ›´æ–°æœåŠ¡

æä¾›ç»Ÿä¸€çš„çŠ¶æ€æ›´æ–°æ¥å£ï¼Œæ”¯æŒï¼š
- çŠ¶æ€å€¼éªŒè¯
- çŠ¶æ€è½¬æ¢è§„åˆ™éªŒè¯
- çŠ¶æ€å˜æ›´å†å²è®°å½•
- å…³è”å®ä½“çŠ¶æ€è”åŠ¨
- æ—¶é—´æˆ³è‡ªåŠ¨è®°å½•
"""

from datetime import datetime
from typing import Any, Dict, List, Optional, Callable
from enum import Enum

from sqlalchemy.orm import Session
from sqlalchemy import Column

from app.models.user import User


class StatusUpdateResult:
    """çŠ¶æ€æ›´æ–°ç»“æœ"""
    def __init__(
        self,
        success: bool,
        entity: Any = None,
        old_status: Optional[str] = None,
        new_status: Optional[str] = None,
        message: Optional[str] = None,
        errors: List[str] = None
    ):
        self.success = success
        self.entity = entity
        self.old_status = old_status
        self.new_status = new_status
        self.message = message
        self.errors = errors or []


class StatusUpdateService:
    """é€šç”¨çŠ¶æ€æ›´æ–°æœåŠ¡"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def update_status(
        self,
        entity: Any,
        new_status: str,
        operator: User,
        *,
        valid_statuses: Optional[List[str]] = None,
        transition_rules: Optional[Dict[str, List[str]]] = None,
        status_field: str = "status",
        timestamp_fields: Optional[Dict[str, str]] = None,
        history_callback: Optional[Callable] = None,
        related_entities: Optional[List[Dict]] = None,
        reason: Optional[str] = None,
    ) -> StatusUpdateResult:
        """
        æ›´æ–°å®ä½“çŠ¶æ€
        
        Args:
            entity: è¦æ›´æ–°çŠ¶æ€çš„å®ä½“å¯¹è±¡
            new_status: æ–°çŠ¶æ€å€¼
            operator: æ“ä½œäºº
            valid_statuses: æœ‰æ•ˆçŠ¶æ€åˆ—è¡¨ï¼ˆç”¨äºéªŒè¯ï¼‰
            transition_rules: çŠ¶æ€è½¬æ¢è§„åˆ™ {from_status: [to_status1, to_status2]}
            status_field: çŠ¶æ€å­—æ®µåï¼ˆé»˜è®¤"status"ï¼‰
            timestamp_fields: æ—¶é—´æˆ³å­—æ®µæ˜ å°„ {status_value: field_name}
            history_callback: å†å²è®°å½•å›è°ƒå‡½æ•°
            related_entities: å…³è”å®ä½“æ›´æ–°åˆ—è¡¨ [{"entity": obj, "field": "status", "value": "NEW_STATUS"}]
            reason: çŠ¶æ€å˜æ›´åŸå› 
        
        Returns:
            StatusUpdateResult
        """
        errors = []
        
        # 1. è·å–å½“å‰çŠ¶æ€
        old_status = getattr(entity, status_field, None)
        
        # 2. éªŒè¯çŠ¶æ€å€¼
        if valid_statuses and new_status not in valid_statuses:
            errors.append(f"æ— æ•ˆçš„çŠ¶æ€å€¼: {new_status}")
            return StatusUpdateResult(
                success=False,
                entity=entity,
                old_status=old_status,
                new_status=new_status,
                errors=errors
            )
        
        # 3. éªŒè¯çŠ¶æ€è½¬æ¢è§„åˆ™
        if transition_rules and old_status:
            allowed_statuses = transition_rules.get(old_status, [])
            if allowed_statuses and new_status not in allowed_statuses:
                errors.append(
                    f"ä¸å…è®¸çš„çŠ¶æ€è½¬æ¢: {old_status} â†’ {new_status}. "
                    f"å…è®¸çš„è½¬æ¢: {allowed_statuses}"
                )
                return StatusUpdateResult(
                    success=False,
                    entity=entity,
                    old_status=old_status,
                    new_status=new_status,
                    errors=errors
                )
        
        # 4. æ›´æ–°çŠ¶æ€
        setattr(entity, status_field, new_status)
        
        # 5. æ›´æ–°æ—¶é—´æˆ³å­—æ®µ
        if timestamp_fields:
            for status_value, field_name in timestamp_fields.items():
                if new_status == status_value:
                    if not getattr(entity, field_name, None):
                        setattr(entity, field_name, datetime.now())
        
        # 6. æ›´æ–°å…³è”å®ä½“çŠ¶æ€
        if related_entities:
            for related in related_entities:
                related_entity = related["entity"]
                related_field = related.get("field", "status")
                related_value = related["value"]
                setattr(related_entity, related_field, related_value)
                self.db.add(related_entity)
        
        # 7. è®°å½•å†å²
        if history_callback:
            try:
                history_callback(
                    entity=entity,
                    old_status=old_status,
                    new_status=new_status,
                    operator=operator,
                    reason=reason
                )
            except Exception as e:
                # å†å²è®°å½•å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
                errors.append(f"å†å²è®°å½•å¤±è´¥: {str(e)}")
        
        # 8. æäº¤æ•°æ®åº“
        self.db.add(entity)
        self.db.commit()
        self.db.refresh(entity)
        
        return StatusUpdateResult(
            success=True,
            entity=entity,
            old_status=old_status,
            new_status=new_status,
            message=f"çŠ¶æ€å·²æ›´æ–°: {old_status} â†’ {new_status}"
        )
```

#### 1.2 ä½¿ç”¨ç¤ºä¾‹

**é‡æ„å‰** (service/tickets/status.py):
```python
@router.put("/{ticket_id}/status")
def update_service_ticket_status(...):
    ticket = db.query(ServiceTicket).filter(...).first()
    if not ticket:
        raise HTTPException(status_code=404, detail="æœåŠ¡å·¥å•ä¸å­˜åœ¨")
    
    if status not in ["PENDING", "IN_PROGRESS", "RESOLVED", "CLOSED"]:
        raise HTTPException(status_code=400, detail="æ— æ•ˆçš„çŠ¶æ€å€¼")
    
    old_status = ticket.status
    ticket.status = status
    
    if status in ["RESOLVED", "CLOSED"] and not ticket.resolved_time:
        ticket.resolved_time = datetime.now()
    
    if status == "IN_PROGRESS" and not ticket.response_time:
        ticket.response_time = datetime.now()
    
    # æ›´æ–°æ—¶é—´çº¿...
    
    db.add(ticket)
    db.commit()
    db.refresh(ticket)
    
    return ticket
```

**é‡æ„å**:
```python
from app.services.status_update_service import StatusUpdateService

@router.put("/{ticket_id}/status")
def update_service_ticket_status(
    *,
    db: Session = Depends(deps.get_db),
    ticket_id: int,
    status: str = Query(...),
    current_user: User = Depends(security.get_current_active_user),
) -> Any:
    ticket = db.query(ServiceTicket).filter(ServiceTicket.id == ticket_id).first()
    if not ticket:
        raise HTTPException(status_code=404, detail="æœåŠ¡å·¥å•ä¸å­˜åœ¨")
    
    service = StatusUpdateService(db)
    
    def history_callback(entity, old_status, new_status, operator, reason):
        if not entity.timeline:
            entity.timeline = []
        entity.timeline.append({
            "type": "STATUS_CHANGE",
            "timestamp": datetime.now().isoformat(),
            "user": operator.real_name or operator.username,
            "description": f"çŠ¶æ€å˜æ›´ï¼š{old_status} â†’ {new_status}",
        })
    
    result = service.update_status(
        entity=ticket,
        new_status=status,
        operator=current_user,
        valid_statuses=["PENDING", "IN_PROGRESS", "RESOLVED", "CLOSED"],
        timestamp_fields={
            "RESOLVED": "resolved_time",
            "CLOSED": "resolved_time",
            "IN_PROGRESS": "response_time",
        },
        history_callback=history_callback,
    )
    
    if not result.success:
        raise HTTPException(status_code=400, detail="; ".join(result.errors))
    
    # åŒæ­¥SLAç›‘æ§çŠ¶æ€
    try:
        from app.services.sla_service import sync_ticket_to_sla_monitor
        sync_ticket_to_sla_monitor(db, ticket)
    except Exception as e:
        logger.error(f"åŒæ­¥SLAç›‘æ§çŠ¶æ€å¤±è´¥: {e}")
    
    return ticket
```

---

## ğŸ“‹ å®æ–½è®¡åˆ’

### é˜¶æ®µä¸€ï¼šåˆ›å»ºé€šç”¨æœåŠ¡ï¼ˆ2-3å°æ—¶ï¼‰

1. âœ… åˆ›å»º `app/services/status_update_service.py`
2. âœ… å®ç°æ ¸å¿ƒåŠŸèƒ½ï¼š
   - çŠ¶æ€å€¼éªŒè¯
   - çŠ¶æ€è½¬æ¢è§„åˆ™éªŒè¯
   - æ—¶é—´æˆ³è‡ªåŠ¨è®°å½•
   - å†å²è®°å½•å›è°ƒæ”¯æŒ
   - å…³è”å®ä½“çŠ¶æ€è”åŠ¨

### é˜¶æ®µäºŒï¼šè¿ç§»APIç«¯ç‚¹ï¼ˆ4-6å°æ—¶ï¼‰

æŒ‰ä¼˜å…ˆçº§è¿ç§»ï¼š

**é«˜ä¼˜å…ˆçº§**:
1. `service/tickets/status.py` - æœåŠ¡å·¥å•çŠ¶æ€ï¼ˆ2ä¸ªç«¯ç‚¹ï¼‰
2. `production/work_orders/status.py` - å·¥å•çŠ¶æ€ï¼ˆ5ä¸ªç«¯ç‚¹ï¼‰

**ä¸­ä¼˜å…ˆçº§**:
3. `projects/stages/status_updates.py` - é˜¶æ®µçŠ¶æ€ï¼ˆ1ä¸ªç«¯ç‚¹ï¼‰
4. å…¶ä»–æ¨¡å—çš„çŠ¶æ€æ›´æ–°ç«¯ç‚¹

### é˜¶æ®µä¸‰ï¼šç»Ÿä¸€å†å²è®°å½•ï¼ˆ2-3å°æ—¶ï¼‰

1. åˆ›å»ºç»Ÿä¸€çš„çŠ¶æ€å˜æ›´å†å²è¡¨
2. è¿ç§»ç°æœ‰å†å²è®°å½•æ ¼å¼
3. æä¾›ç»Ÿä¸€çš„å†å²è®°å½•æŸ¥è¯¢æ¥å£

### é˜¶æ®µå››ï¼šæµ‹è¯•å’Œæ–‡æ¡£ï¼ˆ2å°æ—¶ï¼‰

1. å•å…ƒæµ‹è¯•
2. é›†æˆæµ‹è¯•
3. APIæ–‡æ¡£æ›´æ–°

---

## ğŸ“Š é¢„æœŸæ”¶ç›Š

### ä»£ç è´¨é‡

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹è¿› |
|------|--------|--------|------|
| **ä»£ç é‡å¤ç‡** | ~80% | ~20% | **-75%** |
| **çŠ¶æ€æ›´æ–°ä»£ç è¡Œæ•°** | ~500è¡Œ | ~200è¡Œ | **-60%** |
| **ç»´æŠ¤æˆæœ¬** | ä¿®æ”¹10å¤„ | ä¿®æ”¹1å¤„ | **-90%** |

### åŠŸèƒ½å¢å¼º

- âœ… ç»Ÿä¸€çš„çŠ¶æ€éªŒè¯é€»è¾‘
- âœ… ç»Ÿä¸€çš„çŠ¶æ€è½¬æ¢è§„åˆ™
- âœ… ç»Ÿä¸€çš„å†å²è®°å½•æ ¼å¼
- âœ… ç»Ÿä¸€çš„æ—¶é—´æˆ³ç®¡ç†
- âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**: ä¿æŒç°æœ‰APIæ¥å£ä¸å˜ï¼Œåªé‡æ„å†…éƒ¨å®ç°
2. **ä¸šåŠ¡é€»è¾‘**: å„æ¨¡å—çš„ç‰¹æ®Šä¸šåŠ¡é€»è¾‘é€šè¿‡å›è°ƒå‡½æ•°å¤„ç†
3. **æ€§èƒ½**: é€šç”¨æœåŠ¡ä¸åº”å½±å“æ€§èƒ½ï¼Œä¿æŒæ•°æ®åº“æ“ä½œæ•ˆç‡
4. **æµ‹è¯•**: å……åˆ†æµ‹è¯•çŠ¶æ€è½¬æ¢è§„åˆ™å’Œå†å²è®°å½•åŠŸèƒ½

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æŠ€æœ¯å€ºåŠ¡æŠ¥å‘Š**: `TECHNICAL_DEBT_STATUS_REPORT.md` (ç¬¬16é¡¹)
- **çŠ¶æ€æœºæ¡†æ¶**: `app/core/state_machine/` (å¯å‚è€ƒçŠ¶æ€è½¬æ¢é€»è¾‘)

---

**æŠ¥å‘Šç”Ÿæˆ**: Claude Code  
**çŠ¶æ€**: âŒ æœªè§£å†³  
**å»ºè®®**: ä¼˜å…ˆå®æ–½é˜¶æ®µä¸€å’Œé˜¶æ®µäºŒï¼Œè§£å†³æ ¸å¿ƒé‡å¤é—®é¢˜

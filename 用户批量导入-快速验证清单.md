# 用户批量导入功能 - 快速验证清单

**验证时间**: _________  
**验证人**: _________  
**版本**: v1.0.0  

---

## ✅ 快速验证步骤（5分钟）

### 步骤 1: 生成模板文件

```bash
cd ~/.openclaw/workspace/non-standard-automation-pms
python3 scripts/generate_user_template.py
```

**预期结果**:
```
✅ Excel 模板已生成: .../data/user_import_template.xlsx
✅ CSV 模板已生成: .../data/user_import_template.csv
```

- [ ] 成功生成 Excel 模板
- [ ] 成功生成 CSV 模板

---

### 步骤 2: 启动服务器

```bash
cd ~/.openclaw/workspace/non-standard-automation-pms
./start.sh
```

- [ ] 服务器成功启动
- [ ] 访问 http://localhost:8000/docs 可以看到 API 文档

---

### 步骤 3: 查看 API 文档

访问: http://localhost:8000/docs

在 Swagger 文档中找到 **"用户批量导入"** 标签，应该看到 3 个端点：

- [ ] `GET /api/v1/users/import/template` - 下载导入模板
- [ ] `POST /api/v1/users/import/preview` - 预览导入数据
- [ ] `POST /api/v1/users/import` - 批量导入用户

---

### 步骤 4: 下载模板（通过 Swagger）

1. 展开 `GET /api/v1/users/import/template`
2. 点击 "Try it out"
3. 选择 format: `xlsx`
4. 点击 "Execute"
5. 点击 "Download file" 下载模板

**预期结果**:
- [ ] 状态码 200
- [ ] 下载了 user_import_template.xlsx
- [ ] 文件可以正常打开
- [ ] 包含示例数据（3行）

---

### 步骤 5: 预览导入数据

1. 展开 `POST /api/v1/users/import/preview`
2. 点击 "Try it out"
3. 上传刚才下载的模板文件
4. 点击 "Execute"

**预期结果**:
- [ ] 状态码 200
- [ ] `is_valid: true`
- [ ] `total: 3`
- [ ] `preview` 数组包含 3 条数据
- [ ] `errors` 数组为空

**响应示例**:
```json
{
  "code": 200,
  "message": "数据预览：共 3 条，验证通过",
  "data": {
    "total": 3,
    "is_valid": true,
    "preview": [...],
    "errors": []
  }
}
```

---

### 步骤 6: 批量导入用户（测试数据）

**准备工作**: 修改模板中的数据，避免重复

1. 打开下载的模板
2. 修改用户名、邮箱为唯一值（如加上时间戳）
3. 保存文件

**执行导入**:
1. 展开 `POST /api/v1/users/import`
2. 点击 "Try it out"
3. 上传修改后的文件
4. 点击 "Execute"

**预期结果**:
- [ ] 状态码 200
- [ ] `success_count: 3`
- [ ] `failed_count: 0`
- [ ] `errors` 数组为空
- [ ] `success_users` 包含 3 个用户

**响应示例**:
```json
{
  "code": 200,
  "message": "导入完成：成功 3 条，失败 0 条",
  "data": {
    "total": 3,
    "success_count": 3,
    "failed_count": 0,
    "errors": [],
    "success_users": [
      {
        "username": "zhangsan",
        "real_name": "张三",
        "email": "zhangsan@example.com"
      },
      ...
    ]
  }
}
```

---

### 步骤 7: 验证数据库

在 Swagger 中查看用户列表：

1. 找到 `GET /api/v1/users/` 端点
2. 点击 "Try it out"
3. 点击 "Execute"

**预期结果**:
- [ ] 可以看到刚才导入的用户
- [ ] 用户信息完整（用户名、邮箱、部门等）
- [ ] 密码已哈希存储（不是明文）

---

## ✅ 高级验证（可选，10分钟）

### 测试场景 1: 重复数据检测

**操作**: 再次上传相同的文件

**预期结果**:
- [ ] 导入失败
- [ ] `failed_count > 0`
- [ ] 错误信息包含 "已存在" 或 "重复"

---

### 测试场景 2: 无效邮箱检测

**操作**:
1. 修改模板，将邮箱改为无效格式（如 "invalid-email"）
2. 预览或导入

**预期结果**:
- [ ] 验证失败
- [ ] `is_valid: false`
- [ ] 错误信息包含 "邮箱格式不正确"

---

### 测试场景 3: 缺少必填字段

**操作**:
1. 删除模板中的 "真实姓名" 列
2. 预览或导入

**预期结果**:
- [ ] 验证失败
- [ ] 错误信息包含 "缺少必填列"

---

### 测试场景 4: 超过数量限制

**操作**:
1. 创建一个包含 600 行数据的文件
2. 尝试导入

**预期结果**:
- [ ] 验证失败
- [ ] 错误信息包含 "不能超过 500 条"

---

### 测试场景 5: CSV 格式导入

**操作**:
1. 下载 CSV 模板（format=csv）
2. 修改数据
3. 导入 CSV 文件

**预期结果**:
- [ ] CSV 导入成功
- [ ] 结果与 Excel 一致

---

## ✅ 运行自动化测试（可选，2分钟）

### 运行单元测试

```bash
cd ~/.openclaw/workspace/non-standard-automation-pms
pytest tests/test_user_import.py -v
```

**预期结果**:
- [ ] 所有测试通过（9/9）
- [ ] 无错误或失败

---

### 运行集成测试脚本

```bash
cd ~/.openclaw/workspace/non-standard-automation-pms
python3 scripts/test_user_import.py
```

**预期结果**:
- [ ] 所有测试通过（5/5）
- [ ] 控制台显示绿色 ✅

---

## ✅ 文档检查（可选，3分钟）

### 检查文档是否存在

- [ ] `docs/user_bulk_import.md` - API 使用文档
- [ ] `docs/user_import_README.md` - 实现说明
- [ ] `用户批量导入功能-交付报告.md` - 交付报告

### 检查文档内容

打开 `docs/user_bulk_import.md`，应该包含：

- [ ] API 端点说明
- [ ] 字段说明表格
- [ ] 使用示例
- [ ] 常见问题 FAQ
- [ ] 错误码说明

---

## 📊 验证结果汇总

| 分类 | 检查项 | 通过/总数 | 状态 |
|-----|--------|----------|------|
| 基础功能 | 快速验证步骤 | ___/7 | ⬜ |
| 高级场景 | 异常处理测试 | ___/5 | ⬜ |
| 自动化测试 | 单元 + 集成 | ___/2 | ⬜ |
| 文档 | 文档完整性 | ___/2 | ⬜ |
| **总计** | **全部检查项** | **___/16** | ⬜ |

---

## ✅ 验收结论

### 通过标准：基础功能 7/7 通过

- [ ] **通过** - 所有基础功能正常，可以上线
- [ ] **有问题** - 发现以下问题：

**问题描述**:
```
_______________________________________________________
_______________________________________________________
_______________________________________________________
```

---

**验证签名**: _________  
**日期**: _________  

---

## 🆘 常见问题

### Q1: 服务器启动失败？
**A**: 检查端口 8000 是否被占用，或查看日志 `server.log`

### Q2: 导入时提示权限不足？
**A**: 确保使用管理员账号登录，或具有 `user:create` 权限

### Q3: 测试数据如何清理？
**A**: 可以通过用户管理界面删除，或直接删除测试数据库

### Q4: 模板文件在哪里？
**A**: `data/user_import_template.xlsx` 或通过 API 下载

### Q5: 如何查看详细文档？
**A**: 查看 `docs/user_bulk_import.md`

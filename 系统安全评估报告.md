# 非标自动化PMS系统 - 安全评估报告

**评估时间**: 2026-02-15  
**评估对象**: 非标自动化项目管理系统 v1.0.0  
**评估人**: AI Security Analyst  

---

## 📊 总体安全评级

```
总体安全评分: 85/100 🟢

评级: B+ (良好，需要改进)
```

---

## 🎯 评估维度详细分析

### 1️⃣ 认证与授权 ⭐⭐⭐⭐⭐ (95/100)

#### ✅ 优势

**强项**:
- ✅ **JWT认证机制完善**
  - 使用 HS256 算法
  - Access Token (24小时) + Refresh Token (7天) 双Token机制
  - JWT ID (jti) 用于会话管理和撤销
  - Token黑名单机制（Redis优先，降级到内存）
  
- ✅ **密码安全**
  - bcrypt 哈希算法 (成本因子可配置)
  - passlib 库管理密码上下文
  - 不存储明文密码
  
- ✅ **权限控制完善**
  - 数据库驱动的RBAC权限模型
  - 细粒度权限（module:action格式）
  - 数据范围控制（个人/部门/全部）
  - 销售模块独立权限系统
  
- ✅ **2FA双因素认证**
  - 支持TOTP双因素认证
  - 增强账户安全性

**代码示例**:
```python
# JWT Token创建（含jti和token类型）
def create_access_token(data: dict, jti: Optional[str] = None):
    to_encode = data.copy()
    to_encode.update({
        "exp": expire,
        "iat": now,
        "jti": jti or secrets.token_hex(16),
        "token_type": "access",
    })
    return jwt.encode(to_encode, SECRET_KEY, algorithm="HS256")
```

#### ⚠️ 风险点

1. **SECRET_KEY管理** (中风险)
   - 开发环境自动生成临时密钥
   - 生产环境强制要求环境变量设置
   - 建议: 使用密钥管理服务（AWS Secrets Manager/Azure Key Vault）

2. **Token过期时间** (低风险)
   - Access Token 24小时有效期较长
   - 建议: 生产环境缩短到2-4小时

3. **缺少账户锁定机制** (中风险)
   - 未实现登录失败次数限制
   - 建议: 5次失败后锁定15分钟

#### 💡 改进建议

```python
# 建议1: 实现登录失败限制
LOGIN_ATTEMPT_LIMIT = 5
LOCKOUT_DURATION_MINUTES = 15

def check_login_attempts(username: str) -> bool:
    """检查登录尝试次数"""
    attempts = redis_client.get(f"login_attempts:{username}")
    if attempts and int(attempts) >= LOGIN_ATTEMPT_LIMIT:
        # 账户已锁定
        return False
    return True
```

---

### 2️⃣ 数据安全 ⭐⭐⭐⭐ (80/100)

#### ✅ 优势

- ✅ **SQL注入防护**
  - 完全使用SQLAlchemy ORM
  - 参数化查询
  - 无原始SQL拼接

- ✅ **输入验证完善**
  - Pydantic数据验证
  - 统一验证器（validators.py）
  - 项目编码、手机号、邮箱等格式验证

- ✅ **敏感数据保护**
  - 密码bcrypt加密
  - Token黑名单机制
  - 敏感端点禁止缓存

**代码示例**:
```python
# Pydantic自动验证
class UserCreate(BaseModel):
    username: str = Field(..., min_length=3, max_length=50)
    email: EmailStr  # 自动验证邮箱格式
    password: str = Field(..., min_length=8)
    phone: Optional[str] = Field(None, regex=r'^1[3-9]\d{9}$')
```

#### ⚠️ 风险点

1. **缺少数据加密** (中风险)
   - 数据库数据未加密存储
   - 建议: 敏感字段（身份证、银行卡）使用AES-256加密

2. **缺少数据备份策略** (中风险)
   - 未见自动备份配置
   - 建议: 每日数据库备份 + 异地存储

3. **文件上传安全** (中风险)
   - 有文件类型白名单（.jpg/.pdf等）
   - 缺少文件内容验证（魔术字节检查）
   - 最大10MB限制合理

#### 💡 改进建议

```python
# 建议1: 敏感字段加密
from cryptography.fernet import Fernet

class EncryptedField:
    def __init__(self, key: bytes):
        self.cipher = Fernet(key)
    
    def encrypt(self, data: str) -> str:
        return self.cipher.encrypt(data.encode()).decode()
    
    def decrypt(self, encrypted: str) -> str:
        return self.cipher.decrypt(encrypted.encode()).decode()
```

---

### 3️⃣ API安全 ⭐⭐⭐⭐⭐ (90/100)

#### ✅ 优势

- ✅ **CSRF防护完善**
  - 智能区分API vs Web请求
  - Origin/Referer头验证
  - CORS配置严格
  - 豁免路径白名单（/health, /docs等）
  
- ✅ **安全响应头全面**
  - X-Frame-Options: DENY（防点击劫持）
  - X-Content-Type-Options: nosniff
  - Content-Security-Policy（严格CSP）
  - Strict-Transport-Security（HSTS）
  - Permissions-Policy（禁用不必要的浏览器API）
  - 隐藏Server信息
  
- ✅ **CORS配置合理**
  - 白名单机制
  - 开发/生产环境区分
  - 拒绝通配符（生产环境）

**代码示例**:
```python
# CSRF防护 - API请求验证
def _validate_api_request(self, request: Request):
    # 1. 检查JWT Token
    auth_header = request.headers.get("Authorization", "")
    if not auth_header.startswith("Bearer "):
        raise HTTPException(401, "需要JWT认证")
    
    # 2. 验证Origin/Referer
    origin = request.headers.get("Origin")
    if not origin or not self._is_origin_allowed(origin):
        raise HTTPException(403, "CSRF验证失败")
```

**安全响应头**:
```
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
Content-Security-Policy: default-src 'self'; script-src 'self' 'nonce-xxx'
Strict-Transport-Security: max-age=31536000; includeSubDomains
Permissions-Policy: geolocation=(), camera=(), microphone=()
```

#### ⚠️ 风险点

1. **API速率限制缺失** (高风险)
   - 未见全局速率限制
   - 建议: 实现基于IP/用户的限流

2. **缺少API版本管理** (低风险)
   - 当前仅有 /api/v1
   - 建议: 规划v2时做好向后兼容

#### 💡 改进建议

```python
# 建议1: 实现速率限制
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/api/v1/auth/login")
@limiter.limit("5/minute")  # 每分钟5次登录尝试
async def login(request: Request, ...):
    pass
```

---

### 4️⃣ 日志与审计 ⭐⭐⭐⭐ (85/100)

#### ✅ 优势

- ✅ **审计日志系统**
  - 审计上下文（set_audit_context）
  - 记录操作人和IP
  - 支持审计日志查询API

- ✅ **安全事件日志**
  - CSRF验证失败
  - 登录失败
  - Token撤销

**代码示例**:
```python
# 审计上下文设置
from ..common.context import set_audit_context

async def get_current_user(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):
    user = verify_token(token)
    set_audit_context(user_id=user.id, username=user.username, ip=request.client.host)
    return user
```

#### ⚠️ 风险点

1. **日志未集中存储** (中风险)
   - 应用日志分散在本地文件
   - 建议: ELK/Loki集中日志管理

2. **缺少安全事件告警** (中风险)
   - 无实时告警机制
   - 建议: 异常登录、权限提升等事件触发告警

#### 💡 改进建议

```python
# 建议1: 安全事件告警
import logging

security_logger = logging.getLogger("security")

def log_security_event(event_type: str, details: dict):
    security_logger.warning(f"{event_type}: {details}")
    
    # 触发告警（企业微信/钉钉/邮件）
    if event_type in ["login_failed_5_times", "privilege_escalation"]:
        send_alert(event_type, details)
```

---

### 5️⃣ 网络安全 ⭐⭐⭐ (75/100)

#### ✅ 优势

- ✅ **HTTPS强制**
  - HSTS头（生产环境）
  - upgrade-insecure-requests（CSP）
  
- ✅ **CORS严格控制**
  - 白名单机制
  - 拒绝通配符（生产）

#### ⚠️ 风险点

1. **缺少WAF** (高风险)
   - 无Web应用防火墙
   - 建议: 部署Nginx + ModSecurity 或云WAF

2. **未配置防DDoS** (中风险)
   - 无DDoS防护
   - 建议: Cloudflare/阿里云DDoS防护

3. **缺少IP白名单** (低风险)
   - 管理后台未限制IP
   - 建议: VPN或IP白名单访问

---

### 6️⃣ 依赖安全 ⭐⭐⭐⭐ (80/100)

#### ✅ 优势

- ✅ **使用成熟的安全库**
  - passlib (密码哈希)
  - python-jose (JWT)
  - pydantic (数据验证)
  - SQLAlchemy (ORM防注入)

#### ⚠️ 风险点

1. **依赖版本未锁定** (中风险)
   - requirements.txt未固定版本
   - 建议: 使用 == 锁定版本，定期更新

2. **缺少依赖扫描** (中风险)
   - 未见安全扫描工具
   - 建议: 使用 safety/snyk 扫描漏洞

#### 💡 改进建议

```bash
# 建议1: 锁定依赖版本
# requirements.txt
fastapi==0.104.1  # 而不是 fastapi>=0.100.0
passlib==1.7.4
python-jose==3.3.0

# 建议2: 定期扫描漏洞
pip install safety
safety check
```

---

### 7️⃣ 部署安全 ⭐⭐⭐ (70/100)

#### ✅ 优势

- ✅ **Docker容器化**
  - 隔离运行环境
  - 便于部署管理

#### ⚠️ 风险点

1. **Docker镜像安全** (中风险)
   - 未见基础镜像安全扫描
   - 建议: 使用官方镜像 + Trivy扫描

2. **环境变量管理** (中风险)
   - .env文件存储敏感信息
   - 建议: 使用Docker Secrets或K8s ConfigMap

3. **容器权限过高** (中风险)
   - 未见non-root用户配置
   - 建议: 容器以非root用户运行

#### 💡 改进建议

```dockerfile
# Dockerfile优化
FROM python:3.11-slim

# 创建非root用户
RUN useradd -m -u 1000 appuser

# 切换到非root用户
USER appuser

# 安全扫描
RUN pip install safety && safety check

EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

## 🚨 高风险问题清单

### 🔴 P0 - 立即修复

1. **缺少API速率限制**
   - 影响: 暴力破解、DDoS攻击
   - 修复: 实现全局限流 + 登录端点独立限流
   
2. **缺少账户锁定机制**
   - 影响: 暴力破解攻击
   - 修复: 5次失败锁定15分钟

3. **缺少WAF防护**
   - 影响: 各类Web攻击
   - 修复: 部署Nginx + ModSecurity

### 🟠 P1 - 高优先级

4. **SECRET_KEY管理不安全**
   - 影响: 开发环境临时密钥，重启失效
   - 修复: 使用环境变量 + 密钥轮转机制

5. **敏感数据未加密**
   - 影响: 数据库泄露风险
   - 修复: AES-256加密敏感字段

6. **缺少数据备份**
   - 影响: 数据丢失风险
   - 修复: 每日自动备份 + 异地存储

### 🟡 P2 - 中优先级

7. **依赖版本未锁定**
   - 影响: 引入漏洞依赖
   - 修复: 锁定版本 + 定期扫描

8. **日志未集中管理**
   - 影响: 难以追踪攻击
   - 修复: ELK/Loki集中日志

9. **容器权限过高**
   - 影响: 容器逃逸风险
   - 修复: 非root用户运行

---

## 📋 安全改进优先级路线图

### 🚀 第一阶段（1周内）- 紧急修复

```
Day 1-2: 实现API速率限制
Day 3-4: 实现账户锁定机制
Day 5-7: 部署WAF（Nginx + ModSecurity）
```

**预期效果**: 防止90%的常见攻击

---

### 🔧 第二阶段（2-4周）- 加固防护

```
Week 2: SECRET_KEY管理优化 + 密钥轮转
Week 3: 敏感数据加密 + 数据备份策略
Week 4: 依赖管理 + 安全扫描集成
```

**预期效果**: 数据安全性提升至企业级

---

### 📊 第三阶段（1-3个月）- 完善体系

```
Month 1: 集中日志管理（ELK）
Month 2: 安全事件告警系统
Month 3: 渗透测试 + 安全审计
```

**预期效果**: 建立完整的安全运营体系

---

## 💰 安全投入预算估算

| 项目 | 成本 | 说明 |
|------|------|------|
| WAF部署 | ¥0（开源）| Nginx + ModSecurity |
| 云WAF服务 | ¥5,000/年 | 阿里云/腾讯云WAF（可选） |
| 日志管理 | ¥0（自建）| ELK Stack |
| 日志服务 | ¥2,000/月 | 阿里云SLS（可选） |
| 密钥管理 | ¥0（AWS Free Tier）| AWS Secrets Manager |
| 依赖扫描 | ¥0（开源）| Safety / Snyk Free |
| 安全审计 | ¥20,000-50,000 | 第三方安全公司（年度） |
| **总计** | **¥0-¥74,000/年** | 看选择自建还是云服务 |

**建议**: 初期自建（¥0成本），后期根据规模选择云服务。

---

## 🎯 最佳实践建议

### 1. 开发安全

- ✅ 使用IDE安全插件（Bandit/SonarLint）
- ✅ 代码审查必须包含安全检查
- ✅ 禁止硬编码密钥/密码
- ✅ 遵循OWASP Top 10指南

### 2. 部署安全

- ✅ 最小权限原则
- ✅ 网络隔离（VPC/防火墙）
- ✅ HTTPS强制
- ✅ 定期更新系统补丁

### 3. 运维安全

- ✅ 定期安全审计
- ✅ 日志监控和告警
- ✅ 应急响应预案
- ✅ 定期安全培训

---

## 📈 对标行业标准

| 标准 | 当前状态 | 目标 |
|------|----------|------|
| OWASP Top 10 | 7/10防护 | 10/10 |
| ISO 27001 | 部分符合 | 全面符合 |
| 等保2.0三级 | 基本满足 | 完全满足 |
| SOC 2 Type II | 未认证 | 认证（可选） |

---

## ✅ 总结与建议

### 🎉 优势总结

1. **认证授权体系完善** - JWT + RBAC + 2FA
2. **API安全基础扎实** - CSRF防护 + 安全响应头
3. **代码质量较高** - ORM防注入 + Pydantic验证

### ⚠️ 主要风险

1. **缺少速率限制** - 容易被暴力破解
2. **WAF未部署** - 缺少第一道防线
3. **敏感数据未加密** - 数据库泄露风险

### 💡 符哥的行动建议

#### 立即行动（本周内）:
1. ✅ 实现API速率限制（1天）
2. ✅ 实现登录锁定机制（1天）
3. ✅ 部署Nginx + ModSecurity WAF（2天）

#### 短期计划（1个月内）:
4. ✅ 优化SECRET_KEY管理
5. ✅ 实现敏感数据加密
6. ✅ 建立数据备份策略

#### 中期规划（3个月内）:
7. ✅ 部署ELK集中日志
8. ✅ 建立安全告警系统
9. ✅ 进行渗透测试

---

**评估结论**: 

系统安全基础良好（85/100），核心认证和API安全机制完善，但在速率限制、WAF防护、数据加密等方面需要加强。建议按照优先级路线图逐步改进，1周内可完成紧急修复，1-3个月内达到企业级安全标准。

---

**报告生成时间**: 2026-02-15  
**下次评估建议**: 3个月后（2026-05-15）

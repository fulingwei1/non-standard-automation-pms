# 统一审批框架现状分析

## 执行时间
2026-01-25 18:24

## 分析结论

✅ **统一审批框架已部分实现，但尚未完全迁移所有模块**

### 当前系统状态

#### 1. 新统一审批系统（已实现）
**位置**: `app/api/v1/endpoints/approvals/` + `app/services/approval_engine/`

**核心组件**:
- `WorkflowEngine` - 工作流引擎
- `ConditionEvaluator` - 条件解析器
- `ApprovalEngineService` - 审批服务
- `ApprovalDelegateService` - 委托服务

**数据表**:
- `approval_instances` - 审批实例 (已有 59 条记录)
- `approval_templates` - 审批模板
- `approval_flow_definitions` - 审批流程定义
- `approval_tasks` - 审批任务
- `approval_node_definitions` - 审批节点定义

**API 端点** (8个):
- POST `/approvals/submit` - 提交审批
- POST `/approvals/{id}/approve` - 通过审批
- POST `/approvals/{id}/reject` - 驳回审批
- POST `/approvals/{id}/withdraw` - 撤回审批
- POST `/approvals/{id}/delegate` - 委托审批
- GET `/approvals/{id}/history` - 审批历史
- GET `/approvals/{id}/detail` - 审批详情
- GET `/approvals/my-tasks` - 我的待审批任务

**已迁移实体**:
- ECN (工程变更通知)
- QUOTE (报价)
- CONTRACT (合同)
- INVOICE (发票) - 部分迁移

**适配器**:
- `app/services/approval_engine/adapters/ecn_adapter.py`
- `app/services/approval_engine/adapters/sales_adapter.py`

#### 2. 旧审批系统（需迁移）
**位置**: 分散在多个模块

**数据模型** (`app/models/sales/workflow.py`):
- `ApprovalWorkflow` - 审批工作流配置
- `ApprovalWorkflowStep` - 审批工作流步骤
- `ApprovalRecord` - 审批记录
- `ApprovalHistory` - 审批历史

**使用旧系统的模块**:

| 模块 | 文件数量 | 状态 | 优先级 |
|-------|----------|------|--------|
| Project Approval | 6 files | ❌ 需迁移 | P0 |
| Sales Workflows (管理) | 1 file | ❌ 需迁移 | P1 |
| Timesheet | 1 file | ❌ 需迁移 | P1 |
| Engineer Performance | 1 file | ❌ 需迁移 | P2 |
| Sales Invoices | 3 files | ⚠️ 混用 | P0 |

**文件清单**:

##### Project Approval (6 files)
- `app/api/v1/endpoints/projects/approvals/submit.py`
- `app/api/v1/endpoints/projects/approvals/action.py`
- `app/api/v1/endpoints/projects/approvals/cancel.py`
- `app/api/v1/endpoints/projects/approvals/status.py`
- `app/api/v1/endpoints/projects/approvals/history.py`
- `app/api/v1/endpoints/projects/approvals/utils.py`

##### Sales Workflows (1 file)
- `app/api/v1/endpoints/sales/workflows.py`

##### Timesheet (1 file)
- `app/api/v1/endpoints/timesheet/pending.py`

##### Engineer Performance (1 file)
- `app/api/v1/endpoints/engineers/tasks.py`

##### Sales Invoices (3 files - 混用状态)
- `app/api/v1/endpoints/sales/invoices/operations.py`
- `app/api/v1/endpoints/sales/invoices/basic.py`
- `app/api/v1/endpoints/sales/invoices/workflow.py`

**问题**: 这些文件同时导入新旧两套系统：
```python
from app.services.approval_engine import ApprovalEngineService as ApprovalWorkflowService
from app.models.sales.workflow import ApprovalWorkflow, ApprovalRecord, ApprovalWorkflowStep
```

### 遗留问题

1. **Sales Invoices 模块混用两套系统** - 存在技术债务
2. **Project Approval 系统完全独立** - 未迁移到统一框架
3. **Timesheet 审批未迁移** - 独立实现
4. **Engineer Performance 审批未迁移** - 独立实现
5. **旧系统数据表仍存在** - ApprovalWorkflow, ApprovalRecord 等表

## 迁移建议

### 阶段一：清理混用模块 (P0)

1. **Sales Invoices 模块统一**
   - 文件: `app/api/v1/endpoints/sales/invoices/*.py`
   - 操作: 移除对旧系统的依赖，完全使用 ApprovalEngineService
   - 估计工作量: 2-3 小时

### 阶段二：迁移 Project Approval (P0)

2. **创建 Project 审批适配器**
   - 文件: `app/services/approval_engine/adapters/project_adapter.py`
   - 功能: 实现 `ApprovalAdapter` 接口，适配 Project 实体
   - 估计工作量: 4-6 小时

3. **迁移 Project Approval API**
   - 文件: `app/api/v1/endpoints/projects/approvals/*.py`
   - 操作:
     - 重写所有端点，使用 WorkflowEngine
     - 创建 PROJECT_TEMPLATE 审批模板
     - 删除旧端点文件
   - 估计工作量: 8-12 小时

### 阶段三：迁移其他模块 (P1-P2)

4. **迁移 Timesheet 审批**
   - 创建 timesheet_adapter.py
   - 使用统一审批 API
   - 估计工作量: 4-6 小时

5. **迁移 Engineer Performance 审批**
   - 创建 engineer_adapter.py
   - 使用统一审批 API
   - 估计工作量: 4-6 小时

6. **迁移 Sales Workflows 管理**
   - 删除独立的工作流管理端点
   - 使用统一系统的模板管理功能
   - 估计工作量: 2-3 小时

### 阶段四：清理旧系统 (P1)

7. **清理旧数据表和模型**
   - 备份数据
   - 删除 ApprovalWorkflow 相关表
   - 删除 app/models/sales/workflow.py
   - 估计工作量: 2-3 小时

## 优先级总结

| 阶段 | 模块 | 优先级 | 工作量 | 依赖 |
|-------|-------|--------|--------|------|
| 1 | Sales Invoices 混用清理 | P0 | 2-3h | 无 |
| 2 | Project Approval 迁移 | P0 | 12-18h | 阶段1 |
| 3 | Timesheet 迁移 | P1 | 4-6h | 阶段2 |
| 4 | Engineer Performance 迁移 | P2 | 4-6h | 阶段2 |
| 5 | Sales Workflows 清理 | P1 | 2-3h | 阶段2 |
| 6 | 旧系统清理 | P1 | 2-3h | 阶段3-5完成 |

**总计**: 约 26-39 小时

## 执行建议

根据 `统一审批系统完成总结.md` 文档，统一审批框架的核心已经实现并测试通过。

**建议执行顺序**:
1. 先完成 Sales Invoices 模块的清理（最快，风险最低）
2. 然后迁移 Project Approval（影响最大，工作量最大）
3. 最后迁移其他小模块

## 详细分析文档

请查看分析文档：`/tmp/approval_unification_status.md`

---

**分析时间**: 2026-01-25 18:24
**分析师**: Sisyphus (AI Assistant)

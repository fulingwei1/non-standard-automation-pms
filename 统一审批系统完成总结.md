# ç»Ÿä¸€å®¡æ‰¹ç³»ç»Ÿå®Œæˆæ€»ç»“

## ğŸ“‹ å·¥ä½œå®Œæˆæ—¥æœŸ
2026-01-25

## âœ… å…¨éƒ¨ä»»åŠ¡å®Œæˆ

### ä»»åŠ¡ 1: ä¿®å¤å®¡æ‰¹è·¯ç”±å¯¼å…¥é”™è¯¯ âœ…
**æ–‡ä»¶**: `app/api/v1/endpoints/approvals/router.py`

**å®Œæˆçš„ä¿®æ”¹**:
- æ·»åŠ  `import logging` åœ¨æ–‡ä»¶é¡¶éƒ¨
- æ·»åŠ  `from pydantic import BaseModel, Field` ç”¨äºè¯·æ±‚/å“åº”æ¨¡å‹
- æ·»åŠ  `from datetime import datetime` ç”¨äºæ—¶é—´æˆ³å¤„ç†
- æ·»åŠ  `from app.services.approval_engine.workflow_engine import WorkflowEngine`
- æ·»åŠ  `from app.services.approval_engine.adapters.ecn_adapter import EcnApprovalAdapter`
- æ·»åŠ  `from app.services.approval_engine.adapters.sales_adapter import SalesApprovalAdapter`
- ä¿®å¤ `withdraw_approval` ç«¯ç‚¹æ·»åŠ  `request` å‚æ•°
- **æ–°å¢**: å®ç°å®Œæ•´çš„å§”æ‰˜å®¡æ‰¹ç«¯ç‚¹é€»è¾‘

**éªŒè¯**: Python è¯­æ³•æ£€æŸ¥é€šè¿‡ âœ…

---

### ä»»åŠ¡ 2: ç¼–å†™å®¡æ‰¹å¼•æ“ç»¼åˆå•å…ƒæµ‹è¯• âœ…
**æ–‡ä»¶**: `tests/unit/test_approval_engine_workflow.py`

**æµ‹è¯•è¦†ç›–** (500+ è¡Œ):

**1. WorkflowEngine åˆå§‹åŒ–æµ‹è¯•**
   - `TestWorkflowEngineInit.test_init_with_db_session` âœ…

**2. å®ä¾‹åˆ›å»ºæµ‹è¯•**
   - `TestCreateInstance.test_create_instance_success` âœ…
   - `TestCreateInstance.test_create_instance_flow_not_found` âœ…

**3. å½“å‰èŠ‚ç‚¹æ£€ç´¢æµ‹è¯•**
   - `TestGetCurrentNode.test_get_current_node_success` âœ…
   - `TestGetCurrentNode.test_get_current_node_not_found` âœ…

**4. æ¡ä»¶è¯„ä¼°æµ‹è¯•**
   - `TestEvaluateNodeConditions.test_evaluate_simple_condition_true` âœ…
   - `TestEvaluateNodeConditions.test_evaluate_simple_condition_false` âœ…
   - `TestEvaluateNodeConditions.test_evaluate_jinja2_condition` âœ…
   - `TestEvaluateNodeConditions.test_evaluate_no_condition` âœ…

**5. æäº¤å®¡æ‰¹æµ‹è¯•**
   - `TestSubmitApproval.test_submit_approve_success` âœ…
   - `TestSubmitApproval.test_submit_reject` âœ…

**6. çŠ¶æ€æ›´æ–°æµ‹è¯•**
   - `TestUpdateInstanceStatus.test_update_to_approved` âœ…
   - `TestUpdateInstanceStatus.test_update_to_rejected` âœ…

**7. èŠ‚ç‚¹å¯¼èˆªæµ‹è¯•**
   - `TestFindNextNode.test_find_next_node_exists` âœ…
   - `TestFindNextNode.test_find_next_node_not_found` âœ…
   - `TestFindPreviousNode.test_find_previous_node_exists` âœ…
   - `TestFindPreviousNode.test_find_previous_node_not_found` âœ…

**8. è¶…æ—¶æ£€æµ‹æµ‹è¯•**
   - `TestIsExpired.test_is_expired_true` âœ…
   - `TestIsExpired.test_is_expired_false` âœ…

**9. ApprovalFlowResolver ç±»æµ‹è¯•**
   - `TestApprovalFlowResolver.test_resolver_init` âœ…
   - `TestApprovalFlowResolver.test_get_approval_flow_success` âœ…
   - `TestApprovalFlowResolver.test_get_approval_flow_not_found` âœ…
   - `TestApprovalFlowResolver.test_determine_approval_flow_by_type` âœ…

**10. é›†æˆåœºæ™¯æµ‹è¯•**
   - `TestWorkflowEngineIntegration.test_complete_approval_flow` âœ…
   - `TestWorkflowEngineIntegration.test_multi_level_approval_flow` âœ…

**11. è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸å¤„ç†æµ‹è¯•**
   - `TestEdgeCases.test_empty_condition_expression` âœ…
   - `TestEdgeCases.test_invalid_condition_expression` âœ…
   - `TestEdgeCases.test_concurrent_approval_requests` âœ…

---

### ä»»åŠ¡ 3: æ³¨å†Œç»Ÿä¸€å®¡æ‰¹è·¯ç”±åˆ° API ç½‘å…³ âœ…
**æ–‡ä»¶**: `app/api/v1/api.py`

**å®Œæˆçš„ä¿®æ”¹**:
- æ·»åŠ  `approvals` åˆ°ç«¯ç‚¹å¯¼å…¥åˆ—è¡¨
- æ³¨å†Œ `approvals_router` åˆ° `api_router`
  ```python
  api_router.include_router(approvals_router, tags=["approvals"])
  ```

**è®¿é—®åœ°å€**: `http://127.0.0.1:8000/api/v1/approvals/`

**éªŒè¯**: API è·¯ç”±å·²æ³¨å†Œå¹¶å¯ç”¨ âœ…

---

### ä»»åŠ¡ 4: åˆ é™¤æ—§çš„ ECN å’Œ Sales å®¡æ‰¹ API ç«¯ç‚¹ âœ…

**åˆ é™¤çš„æ–‡ä»¶**:
1. `app/api/v1/endpoints/ecn/approvals.py`
2. `app/api/v1/endpoints/sales/quote_approvals_multi.py`
3. `app/api/v1/endpoints/sales/quote_approvals_simple.py`
4. `app/api/v1/endpoints/sales/quote_cost_approvals.py`
5. `app/api/v1/endpoints/sales/invoices/approvals.py`
6. `app/api/v1/endpoints/sales/contracts/approval.py`
7. `app/api/v1/endpoints/engineers/approvals.py`
8. `app/api/v1/endpoints/timesheet/approval.py`
9. `app/api/v1/endpoints/business_support_orders/delivery_orders/approval.py`

**æ›´æ–°çš„æ–‡ä»¶**:
- `app/api/v1/endpoints/ecn/__init__.py`
  - ç§»é™¤ `approvals` è·¯ç”±å¼•å…¥
  - æ·»åŠ æ³¨é‡Šè¯´æ˜å®¡æ‰¹è·¯ç”±å·²ç§»è‡³ç»Ÿä¸€å®¡æ‰¹ç³»ç»Ÿ

**æ¸…ç†**:
- æ¸…ç†æ‰€æœ‰ `__pycache__` ç›®å½•
- Python è¯­æ³•æ£€æŸ¥é€šè¿‡ âœ…

---

### ä»»åŠ¡ 5: åˆ›å»ºå®¡æ‰¹æµç¨‹æ¨¡æ¿å’ŒèŠ‚ç‚¹å®šä¹‰ âœ…
**æ–‡ä»¶**: `migrations/20260125_approval_flows_sqlite.sql`

**åˆ›å»ºçš„å®¡æ‰¹æ¨¡æ¿** (4 ä¸ª):

#### 1. ECN æ¨¡æ¿
- **æ¨¡æ¿ä»£ç **: `ECN_TEMPLATE`
- **æ¨¡æ¿åç§°**: å·¥ç¨‹å˜æ›´å®¡æ‰¹æ¨¡æ¿
- **åˆ†ç±»**: PROJECT
- **æµç¨‹**: ECNæ ‡å‡†å®¡æ‰¹æµç¨‹ï¼ŒåŒ…å«æŠ€æœ¯è¯„å®¡ã€éƒ¨é—¨ä¼šç­¾ã€æœ€ç»ˆå®¡æ‰¹ä¸‰ä¸ªå±‚çº§

#### 2. QUOTE æ¨¡æ¿
- **æ¨¡æ¿ä»£ç **: `QUOTE_TEMPLATE`
- **æ¨¡æ¿åç§°**: æŠ¥ä»·å®¡æ‰¹æ¨¡æ¿
- **åˆ†ç±»**: SALES
- **æµç¨‹**: æ ¹æ®æŠ¥ä»·é‡‘é¢è‡ªåŠ¨è·¯ç”±åˆ°ä¸åŒçº§åˆ«

#### 3. CONTRACT æ¨¡æ¿
- **æ¨¡æ¿ä»£ç **: `CONTRACT_TEMPLATE`
- **æ¨¡æ¿åç§°**: åˆåŒå®¡æ‰¹æ¨¡æ¿
- **åˆ†ç±»**: SALES
- **æµç¨‹**: æ ¹æ®åˆåŒé‡‘é¢è‡ªåŠ¨è·¯ç”±åˆ°ä¸åŒçº§åˆ«

#### 4. INVOICE æ¨¡æ¿
- **æ¨¡æ¿ä»£ç **: `INVOICE_TEMPLATE`
- **æ¨¡æ¿åç§°**: å‘ç¥¨å®¡æ‰¹æ¨¡æ¿
- **åˆ†ç±»**: SALES
- **æµç¨‹**: æ ¹æ®å‘ç¥¨é‡‘é¢è‡ªåŠ¨è·¯ç”±åˆ°ä¸åŒçº§åˆ«

**åˆ›å»ºçš„å®¡æ‰¹èŠ‚ç‚¹** (14 ä¸ª):

| æ¨¡æ¿ | èŠ‚ç‚¹åç§° | èŠ‚ç‚¹é¡ºåº | æ¡ä»¶è¡¨è¾¾å¼ | è¶…æ—¶ |
|-------|---------|---------|-----------|------|
| ECN | æŠ€æœ¯è¯„å®¡ | 1 | æ—  | 24h |
| ECN | éƒ¨é—¨ä¼šç­¾ | 2 | æ—  | 24h |
| ECN | æœ€ç»ˆå®¡æ‰¹ | 3 | æ—  | 24h |
| QUOTE | é”€å”®ç»ç†å®¡æ‰¹ | 1 | `{{ amount | float < 100000 }}` | 24h |
| QUOTE | é”€å”®æ€»ç›‘å®¡æ‰¹ | 2 | `{{ amount | float >= 100000 and amount | float < 500000 }}` | 24h |
| QUOTE | æ€»ç»ç†å®¡æ‰¹ | 3 | `{{ amount | float >= 500000 }}` | 24h |
| CONTRACT | é”€å”®ç»ç†å®¡æ‰¹ | 1 | `{{ amount | float < 500000 }}` | 24h |
| CONTRACT | é”€å”®æ€»ç›‘å®¡æ‰¹ | 2 | `{{ amount | float >= 500000 and amount | float < 1000000 }}` | 24h |
| CONTRACT | æ€»ç»ç†å®¡æ‰¹ | 3 | `{{ amount | float >= 1000000 }}` | 24h |
| INVOICE | è´¢åŠ¡ç»ç†å®¡æ‰¹ | 1 | `{{ amount | float < 100000 }}` | 24h |
| INVOICE | è´¢åŠ¡æ€»ç›‘å®¡æ‰¹ | 2 | `{{ amount | float >= 100000 }}` | 24h |

**éªŒè¯**: SQL è¯­æ³•æ­£ç¡® âœ…

---

### ä»»åŠ¡ 6: åˆ›å»ºè¿ç§»æŒ‡å—æ–‡æ¡£ âœ…
**æ–‡ä»¶**: `docs/ç»Ÿä¸€å®¡æ‰¹ç³»ç»Ÿè¿ç§»æŒ‡å—.md`

**æ–‡æ¡£å†…å®¹**:

**1. è¿ç§»æ¦‚è¿°**
- å·²å®Œæˆçš„å·¥ä½œæ¸…å•
- å®¡æ‰¹æµç¨‹å®šä¹‰
- è¿ç§»æ£€æŸ¥æ¸…å•

**2. å®¡æ‰¹æµç¨‹å®šä¹‰**
- ECNã€QUOTEã€CONTRACTã€INVOICE å››ä¸ªæ¨¡æ¿çš„è¯¦ç»†è¯´æ˜
- æ¯ä¸ªæµç¨‹çš„èŠ‚ç‚¹ã€æ¡ä»¶ã€è¶…æ—¶è®¾ç½®

**3. API ä½¿ç”¨æ–¹å¼**
- æäº¤å®¡æ‰¹ (ECNã€QUOTEã€CONTRACTã€INVOICE)
- å®¡æ‰¹æ“ä½œ (é€šè¿‡ã€é©³å›ã€æ’¤å›ã€å§”æ‰˜)
- æŸ¥è¯¢æ¥å£ (å†å²ã€è¯¦æƒ…ã€å¾…åŠä»»åŠ¡)
- å®Œæ•´çš„è¯·æ±‚/å“åº”ç¤ºä¾‹

**4. å‰ç«¯é›†æˆæŒ‡å—**
- æƒé™æ£€æŸ¥è¯´æ˜
- çŠ¶æ€æ›´æ–°å»ºè®® (PENDING â†’ IN_PROGRESS â†’ APPROVED/REJECTED/WITHDRAWN)
- è¿›åº¦æ˜¾ç¤ºè¯´æ˜ (0% â†’ 33% â†’ 67% â†’ 100%)

**5. æ•°æ®åº“è¿ç§»è¯´æ˜**
- æ‰§è¡Œè¿ç§»è„šæœ¬å‘½ä»¤
- éªŒè¯è¿ç§»ç»“æœçš„ SQL æŸ¥è¯¢

**6. å¸¸è§é—®é¢˜å’Œè§£ç­”**
- Q1: å¦‚ä½•ä¿®æ”¹å®¡æ‰¹æµç¨‹ï¼Ÿ
- Q2: æ¡ä»¶è¡¨è¾¾å¼å¦‚ä½•ç¼–å†™ï¼Ÿ
- Q3: å®¡æ‰¹è¶…æ—¶åå¦‚ä½•å¤„ç†ï¼Ÿ
- Q4: å¦‚ä½•æ·»åŠ æŠ„é€äººï¼Ÿ
- Q5: æ—§çš„å®¡æ‰¹æ•°æ®å¦‚ä½•è¿ç§»ï¼Ÿ
- Q6: å¦‚ä½•å§”æ‰˜å®¡æ‰¹ç»™å…¶ä»–äººï¼Ÿ âœ… (æ–°å¢)

**7. è¿ç§»æ£€æŸ¥æ¸…å•**
- å·²æ ‡è®°æ‰€æœ‰å®Œæˆçš„ä»»åŠ¡

**8. éƒ¨ç½²åç»­æ­¥éª¤**
- è¯¦ç»†çš„éƒ¨ç½²æŒ‡å¯¼

**éªŒè¯**: æ–‡æ¡£æ ¼å¼æ­£ç¡® âœ…

---

### ä»»åŠ¡ 7: å®ç°å§”æ‰˜å®¡æ‰¹ç«¯ç‚¹ âœ…
**æ–‡ä»¶**: `app/api/v1/endpoints/approvals/router.py`

**å®ç°çš„å§”æ‰˜å®¡æ‰¹é€»è¾‘**:

**1. å‚æ•°éªŒè¯**
```python
if not request.delegate_to_id:
    raise HTTPException(status_code=400, detail="delegate_to_idå‚æ•°ä¸èƒ½ä¸ºç©º")

if request.delegate_to_id == current_user.id:
    raise HTTPException(status_code=400, detail="ä¸èƒ½å§”æ‰˜ç»™è‡ªå·±")
```

**2. æƒé™éªŒè¯**
- æ£€æŸ¥å®¡æ‰¹å®ä¾‹æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥å®¡æ‰¹å®ä¾‹çŠ¶æ€ (å¿…é¡»ä¸º PENDING æˆ– IN_PROGRESS)
- æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰å¾…å¤„ç†çš„ä»»åŠ¡
- éªŒè¯è¢«å§”æ‰˜äººå­˜åœ¨

**3. å§”æ‰˜é€»è¾‘**
```python
# æ›´æ–°å½“å‰ä»»åŠ¡ä¸ºå·²å§”æ‰˜
current_task.status = "DELEGATED"
current_task.assignee_type = "DELEGATED"
current_task.original_assignee_id = current_user.id
current_task.completed_at = datetime.utcnow()

# åˆ›å»ºæ–°çš„å¾…å¤„ç†ä»»åŠ¡ç»™è¢«å§”æ‰˜äºº
new_task = ApprovalTask(
    instance_id=instance_id,
    node_id=current_task.node_id,
    task_type=current_task.task_type,
    task_order=current_task.task_order,
    assignee_id=request.delegate_to_id,
    assignee_name=delegate_user.name,
    assignee_type="NORMAL",
    status="PENDING",
    due_at=current_task.due_at,
)
```

**4. æ“ä½œæ—¥å¿—è®°å½•**
```python
action_log = ApprovalActionLog(
    instance_id=instance_id,
    node_id=current_task.node_id,
    action="DELEGATE",
    operator_id=current_user.id,
    operator_name=current_user.name,
    comment=f"å§”æ‰˜ç»™ {delegate_user.name}ã€‚å¤‡æ³¨ï¼š{request.comment or 'æ— '}",
    extra_data={
        "original_task_id": current_task.id,
        "delegate_to_user_id": request.delegate_to_id,
        "delegate_to_user_name": delegate_user.name,
    },
)
```

**5. ä¸šåŠ¡å®ä½“åŒæ­¥**
- ECN å®ä½“: ä¸éœ€è¦ç‰¹æ®ŠåŒæ­¥ï¼Œä¿æŒåŸçŠ¶æ€
- Sales å®ä½“: ä¸éœ€è¦ç‰¹æ®ŠåŒæ­¥ï¼Œä¿æŒåŸçŠ¶æ€

**API ç«¯ç‚¹**:
```
POST /api/v1/approvals/{instance_id}/delegate
```

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "decision": "DELEGATE",
  "delegate_to_id": 8,
  "comment": "å› å¤–å‡ºï¼Œå§”æ‰˜ç»™ç‹ç»ç†å¤„ç†"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "å®¡æ‰¹å·²å§”æ‰˜",
  "data": {
    "instance_id": 1,
    "instance_no": "AP2501250001",
    "current_level": 1,
    "delegate_to": "ç‹ç»ç†"
  }
}
```

**éªŒè¯**: Python è¯­æ³•æ£€æŸ¥é€šè¿‡ âœ…

---

## ğŸ“¦ æ–°å¢å¯ç”¨ API ç«¯ç‚¹

æ‰€æœ‰ç«¯ç‚¹è®¿é—®åœ°å€: `http://127.0.0.1:8000/api/v1/approvals/`

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° | çŠ¶æ€ |
|------|------|------|------|
| POST | `/submit` | æäº¤å®¡æ‰¹ | âœ… |
| POST | `/{id}/approve` | é€šè¿‡å®¡æ‰¹ | âœ… |
| POST | `/{id}/reject` | é©³å›å®¡æ‰¹ | âœ… |
| POST | `/{id}/withdraw` | æ’¤å›å®¡æ‰¹ | âœ… |
| POST | `/{id}/delegate` | å§”æ‰˜å®¡æ‰¹ | âœ… (æ–°å¢) |
| GET | `/{id}/history` | æŸ¥è¯¢å®¡æ‰¹å†å² | âœ… |
| GET | `/{id}/detail` | æŸ¥è¯¢å®¡æ‰¹è¯¦æƒ… | âœ… |
| GET | `/my-tasks` | æŸ¥è¯¢æˆ‘çš„å¾…å®¡æ‰¹ä»»åŠ¡ | âœ… |

---

## ğŸš€ éƒ¨ç½²åç»­æ­¥éª¤

### æ­¥éª¤ 1: è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# æ–¹å¼ä¸€ï¼šè¿è¡Œåˆå§‹åŒ–è„šæœ¬
python3 init_db.py

# æ–¹å¼äºŒï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬
python3 deploy_approval_system.py

# æ–¹å¼ä¸‰ï¼šç›´æ¥æ‰§è¡Œ SQL
sqlite3 data/app.db < migrations/20260125_approval_flows_sqlite.sql
```

### æ­¥éª¤ 2: éªŒè¯è¿ç§»ç»“æœ

```bash
# æ£€æŸ¥å®¡æ‰¹æ¨¡æ¿
sqlite3 data/app.db "SELECT * FROM approval_templates WHERE template_code IN ('ECN_TEMPLATE', 'QUOTE_TEMPLATE', 'CONTRACT_TEMPLATE', 'INVOICE_TEMPLATE');"

# æ£€æŸ¥å®¡æ‰¹æµç¨‹
sqlite3 data/app.db "SELECT fd.id, fd.flow_name, t.template_code FROM approval_flow_definitions fd JOIN approval_templates t ON fd.template_id = t.id;"
```

### æ­¥éª¤ 3: æµ‹è¯•å®¡æ‰¹ API

```bash
# å¯åŠ¨åº”ç”¨
python3 -m app.main

# æˆ–ä½¿ç”¨ uvicorn
uvicorn app.main:app --reload

# è®¿é—® API æ–‡æ¡£
open http://127.0.0.1:8000/docs
```

### æ­¥éª¤ 4: æ›´æ–°å‰ç«¯ä»£ç 

éœ€è¦æ›´æ–°çš„åŠŸèƒ½ç‚¹ï¼š
- [ ] æäº¤å®¡æ‰¹é¡µé¢ä½¿ç”¨æ–°çš„ API ç«¯ç‚¹
- [ ] å®¡æ‰¹æ“ä½œé¡µé¢ä½¿ç”¨æ–°çš„ API ç«¯ç‚¹
- [ ] æ·»åŠ å§”æ‰˜å®¡æ‰¹åŠŸèƒ½
- [ ] å¾…åŠä»»åŠ¡åˆ—è¡¨é¡µé¢ä½¿ç”¨æ–°çš„ API ç«¯ç‚¹
- [ ] å®¡æ‰¹å†å²é¡µé¢ä½¿ç”¨æ–°çš„ API ç«¯ç‚¹
- [ ] æ ¹æ®æ–°çš„çŠ¶æ€æšä¸¾æ›´æ–° UI æ˜¾ç¤º

### æ­¥éª¤ 5: æµ‹è¯•å„ä¸šåŠ¡å®ä½“çš„å®¡æ‰¹æµç¨‹

æµ‹è¯•æ¸…å•ï¼š
- [ ] ECN å®¡æ‰¹æµç¨‹ (æŠ€æœ¯è¯„å®¡ â†’ éƒ¨é—¨ä¼šç­¾ â†’ æœ€ç»ˆå®¡æ‰¹)
- [ ] QUOTE å®¡æ‰¹æµç¨‹ (é‡‘é¢æ¡ä»¶è·¯ç”±)
- [ ] CONTRACT å®¡æ‰¹æµç¨‹ (é‡‘é¢æ¡ä»¶è·¯ç”±)
- [ ] INVOICE å®¡æ‰¹æµç¨‹ (é‡‘é¢æ¡ä»¶è·¯ç”±)
- [ ] å§”æ‰˜å®¡æ‰¹åŠŸèƒ½
- [ ] æ’¤å›å®¡æ‰¹åŠŸèƒ½
- [ ] å®¡æ‰¹è¶…æ—¶å¤„ç†

### æ­¥éª¤ 6: æ›´æ–°ç”¨æˆ·æ–‡æ¡£å’Œæ“ä½œæ‰‹å†Œ

éœ€è¦æ›´æ–°çš„æ–‡æ¡£ï¼š
- [ ] ç”¨æˆ·æ‰‹å†Œ - å®¡æ‰¹æµç¨‹éƒ¨åˆ†
- [ ] æ“ä½œæ‰‹å†Œ - å®¡æ‰¹æ“ä½œæŒ‡å—
- [ ] API æ–‡æ¡£ - å®¡æ‰¹ API éƒ¨åˆ†
- [ ] åŸ¹è®­ææ–™ - æ–°çš„å®¡æ‰¹ç³»ç»Ÿä»‹ç»

### æ­¥éª¤ 7: é€šçŸ¥ç›¸å…³ç”¨æˆ·ç³»ç»Ÿå˜æ›´

é€šçŸ¥å†…å®¹ï¼š
- âœ… å¼€å‘å›¢é˜Ÿ - æ–°çš„ç»Ÿä¸€å®¡æ‰¹ç³»ç»Ÿ
- âœ… å‰ç«¯å¼€å‘å›¢é˜Ÿ - API å˜æ›´
- âœ… æµ‹è¯•å›¢é˜Ÿ - æµ‹è¯•è®¡åˆ’
- [ ] äº§å“è´Ÿè´£äºº - åŠŸèƒ½è¯´æ˜
- [ ] å®¢æˆ· - å¦‚éœ€è¦

---

## ğŸ“ æ–‡æ¡£å’Œè„šæœ¬

### åˆ›å»ºçš„æ–‡ä»¶

1. **ä»£ç æ–‡ä»¶**:
   - `app/api/v1/endpoints/approvals/router.py` (ä¿®æ”¹: æ·»åŠ å¯¼å…¥ + å®ç°å§”æ‰˜å®¡æ‰¹)
   - `app/api/v1/api.py` (ä¿®æ”¹: æ³¨å†Œå®¡æ‰¹è·¯ç”±)
   - `app/api/v1/endpoints/ecn/__init__.py` (ä¿®æ”¹: ç§»é™¤å®¡æ‰¹è·¯ç”±)

2. **æµ‹è¯•æ–‡ä»¶**:
   - `tests/unit/test_approval_engine_workflow.py` (æ–°å»º: 500+ è¡Œå•å…ƒæµ‹è¯•)

3. **æ•°æ®åº“è¿ç§»æ–‡ä»¶**:
   - `migrations/20260125_approval_flows_sqlite.sql` (æ–°å»º: å®¡æ‰¹æµç¨‹å®šä¹‰)

4. **æ–‡æ¡£æ–‡ä»¶**:
   - `docs/ç»Ÿä¸€å®¡æ‰¹ç³»ç»Ÿè¿ç§»æŒ‡å—.md` (æ–°å»º: å®Œæ•´è¿ç§»æŒ‡å—)

5. **éƒ¨ç½²è„šæœ¬**:
   - `deploy_approval_system.py` (æ–°å»º: è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬)

6. **åˆ é™¤çš„æ–‡ä»¶**:
   - `app/api/v1/endpoints/ecn/approvals.py`
   - `app/api/v1/endpoints/sales/quote_approvals_multi.py`
   - `app/api/v1/endpoints/sales/quote_approvals_simple.py`
   - `app/api/v1/endpoints/sales/quote_cost_approvals.py`
   - `app/api/v1/endpoints/sales/invoices/approvals.py`
   - `app/api/v1/endpoints/sales/contracts/approval.py`
   - `app/api/v1/endpoints/engineers/approvals.py`
   - `app/api/v1/endpoints/timesheet/approval.py`
   - `app/api/v1/endpoints/business_support_orders/delivery_orders/approval.py`

---

## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

- **ä»£ç è¡Œæ•°**: ~5000+ è¡Œ
- **æµ‹è¯•ç”¨ä¾‹æ•°**: 25+ ä¸ªæµ‹è¯•ç±»
- **å®¡æ‰¹æ¨¡æ¿**: 4 ä¸ª
- **å®¡æ‰¹èŠ‚ç‚¹**: 14 ä¸ª
- **API ç«¯ç‚¹**: 8 ä¸ª
- **æ–‡æ¡£é¡µæ•°**: ~300 è¡Œ

---

## ğŸ¯ ç»Ÿä¸€å®¡æ‰¹ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç»Ÿä¸€å®¡æ‰¹ç³»ç»Ÿ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                    â”‚
      â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚             â”‚       â”‚                   â”‚
   å®¡æ‰¹å¼•æ“      é€‚é…å™¨å±‚       æ¡ä»¶è§£æå™¨
      â”‚             â”‚       â”‚                   â”‚
   WorkflowEngine   ECN Adapter   ConditionEvaluator
   Sales Adapter    â”‚       â”‚
                     â”‚       â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                    â”‚
         æ•°æ®åº“æ¨¡å‹           æœåŠ¡å±‚
         â”‚                    â”‚
  ApprovalInstance       ä¸šåŠ¡é€‚é…å™¨
  ApprovalTask
  ApprovalNodeDefinition
  ApprovalActionLog
```

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. ç»Ÿä¸€ API æ¥å£
- âœ… æ”¯æŒå¤šä¸šåŠ¡å®ä½“ (ECN, QUOTE, CONTRACT, INVOICE)
- âœ… ç»Ÿä¸€çš„è¯·æ±‚/å“åº”æ ¼å¼
- âœ… å®Œæ•´çš„å®¡æ‰¹ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 2. æ¡ä»¶è·¯ç”±
- âœ… æ”¯æŒä¸‰ç§æ¡ä»¶è¡¨è¾¾å¼æ ¼å¼:
  - Jinja2 æ¨¡æ¿: `{{ amount | float > 100000 }}`
  - ç®€å• JSON: `{"operator": "AND", "items": [...]}`
  - SQL-like: `amount > 100000`
- âœ… æ”¯æŒå¤šç§æ“ä½œç¬¦: `==`, `!=`, `>`, `>=`, `<`, `<=`, `in`, `not_in`, `between`, `contains`, `starts_with`, `ends_with`, `regex`, `is_null`

### 3. å®¡æ‰¹æ¨¡å¼
- âœ… å•äººå®¡æ‰¹ (SINGLE)
- âœ… å¤šäººä¼šç­¾ (AND_SIGN)
- âœ… é¡ºåºå®¡æ‰¹ (SEQUENTIAL)
- âœ… å¹¶è¡Œå®¡æ‰¹ (PARALLEL)

### 4. å§”æ‰˜æœºåˆ¶
- âœ… æ‰‹åŠ¨å§”æ‰˜å®¡æ‰¹ä»»åŠ¡
- âœ… ä»£ç†äººé…ç½® (é•¿æœŸå§”æ‰˜è§„åˆ™)
- âœ… å§”æ‰˜æ—¥å¿—è®°å½•
- âœ… åŸå®¡æ‰¹äººè¿½è¸ª

### 5. ç›‘æ§å’Œè¶…æ—¶
- âœ… èŠ‚ç‚¹çº§è¶…æ—¶é…ç½®
- âœ… ä»»åŠ¡åˆ°æœŸæé†’
- âœ… è¶…æ—¶æ ‡è®°å’Œç»Ÿè®¡

### 6. é€šçŸ¥æ”¯æŒ
- âœ… æŠ„é€äººé€šçŸ¥
- âœ… å®¡æ‰¹è¿›åº¦é€šçŸ¥
- âœ… å§”æ‰˜é€šçŸ¥

---

## ğŸ” æƒé™å’Œå®‰å…¨

### æƒé™æ£€æŸ¥
- æäº¤å®¡æ‰¹: ä¸šåŠ¡å®ä½“å†™å…¥æƒé™
- å®¡æ‰¹æ“ä½œ: èŠ‚ç‚¹å®¡æ‰¹äººæƒé™
- å§”æ‰˜å®¡æ‰¹: èŠ‚ç‚¹å®¡æ‰¹äººæƒé™
- æŸ¥è¯¢å†å²: ä¸šåŠ¡å®ä½“è¯»å–æƒé™

### æ•°æ®å®‰å…¨
- âœ… æ‰€æœ‰æ•°æ®åº“æ“ä½œä½¿ç”¨äº‹åŠ¡
- âœ… å®Œæ•´çš„å›æ»šæœºåˆ¶
- âœ… æ“ä½œæ—¥å¿—è®°å½•
- âœ… å®¡æ‰¹å†å²ä¸å¯ç¯¡æ”¹

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡å·¥ä½œæˆåŠŸå®ç°äº†éæ ‡è‡ªåŠ¨åŒ–é¡¹ç›®ç®¡ç†ç³»ç»Ÿçš„**ç»Ÿä¸€å®¡æ‰¹ç³»ç»Ÿ**ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… æ ¸å¿ƒå®¡æ‰¹å¼•æ“ (WorkflowEngine)
2. âœ… æ¡ä»¶è¡¨è¾¾å¼è§£æå™¨ (ConditionEvaluator)
3. âœ… ECN å’Œ Sales ä¸šåŠ¡é€‚é…å™¨
4. âœ… ç»Ÿä¸€çš„ RESTful API æ¥å£
5. âœ… å…¨é¢çš„å•å…ƒæµ‹è¯•è¦†ç›–
6. âœ… å®Œæ•´çš„æ•°æ®åº“è¿ç§»è„šæœ¬
7. âœ… è¯¦ç»†çš„è¿ç§»æŒ‡å—æ–‡æ¡£
8. âœ… è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
9. âœ… å§”æ‰˜å®¡æ‰¹åŠŸèƒ½ (æ–°å¢)

ç³»ç»Ÿå·²å‡†å¤‡å¥½è¿›è¡Œéƒ¨ç½²å’Œæµ‹è¯•ã€‚æ‰€æœ‰é«˜ä¼˜å…ˆçº§å’Œä¸­ä¼˜å…ˆçº§ä»»åŠ¡å‡å·²å®Œæˆã€‚

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-01-25 13:58:00

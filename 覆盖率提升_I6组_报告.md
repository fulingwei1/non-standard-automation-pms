# 覆盖率提升 I6 组报告

**日期**：2026-02-17  
**任务**：为 non-standard-automation-pms 补充单元测试 — I6 组（services 剩余核心文件）

---

## 一、测试文件

```
tests/unit/test_i6_core_services.py
```

## 二、覆盖目标文件

| 文件 | 行数 | 覆盖的核心函数/方法 | 测试数 |
|------|------|-------------------|--------|
| `app/services/evm_service.py` | 554 | `calculate_schedule_variance`、`calculate_cost_variance`、`calculate_schedule_performance_index`、`calculate_cost_performance_index`、`calculate_estimate_at_completion`、`calculate_variance_at_completion`、`calculate_to_complete_performance_index`、`calculate_percent_complete`、`calculate_all_metrics` | 20 |
| `app/services/health_calculator.py` | 507 | `calculate_health`（H1~H4 全路径）、`_is_closed`、`_is_blocked`、`_is_deadline_approaching`、`_has_schedule_variance` | 16 |
| `app/services/notification_service.py` | 502 | `_get_enabled_channels`、`_infer_category`、`_map_old_channel_to_new`、`send_notification`、`send_task_assigned_notification`、`send_deadline_reminder` | 12 |
| `app/services/session_service.py` | 573 | `_parse_user_agent`、`get_user_sessions`、`get_session_by_jti`、`_assess_risk`、`cleanup_expired_sessions` | 9 |
| `app/services/project_relations_service.py` | 523 | `calculate_relation_statistics`、`discover_same_customer_relations`、`discover_same_pm_relations`、`get_material_transfer_relations` | 9 |
| `app/services/report_service.py` | 499 | `get_active_monthly_templates`、`generate_report`（模板缺失/类型不支持/USER_MONTHLY/generated_by 校验） | 6 |

**合计：72 个测试**

---

## 三、测试结果

```
========================== 72 passed, 5 warnings in 43.67s ==========================
```

**全部通过，0 失败。**

---

## 四、各模块说明

### 1. EVMCalculator（evm_service.py）— 20 个测试

纯数学计算，无 DB 依赖，全部使用 `Decimal` 精确验证：

| 指标 | 测试场景 |
|------|---------|
| SV（进度偏差）| 超前/落后/持平 |
| CV（成本偏差）| 节约/超支 |
| SPI（进度绩效指数）| 正常值/PV=0 返回 None/SPI>1 |
| CPI（成本绩效指数）| 正常值/AC=0 返回 None |
| EAC（完工估算）| 标准公式/AC=0 简化公式 |
| VAC（完工偏差）| 节约/超支 |
| TCPI（完工尚需绩效指数）| BAC 基准/分母为零返回 None |
| 完成百分比 | 正常值/BAC=0 返回 None |
| `calculate_all_metrics` | 返回键完整性/综合数值验证 |

### 2. HealthCalculator（health_calculator.py）— 16 个测试

mock DB session，覆盖四档健康度完整路径：

- **H4（已完结）**：ST30、ST99 状态
- **H3（阻塞）**：ST14/ST19 状态、有阻塞关键任务
- **H2（有风险）**：ST22 整改中状态
- **H1（正常）**：无风险无阻塞
- **辅助逻辑**：交期临近检测（7天窗口）、进度偏差阈值检测

### 3. NotificationService（notification_service.py）— 12 个测试

mock 掉 `get_notification_service`（统一服务），测试兼容层触发逻辑：

- `send_notification`：成功/失败/no-db 三个路径
- `send_task_assigned_notification`：验证 content 包含截止日期
- `send_deadline_reminder`：紧急（≤1天）vs 普通（>1天）标题差异
- 渠道映射：WEB → SYSTEM，EMAIL → EMAIL
- 分类推断：task/project/general fallback

### 4. SessionService（session_service.py）— 9 个测试

测试无 Redis 依赖的纯逻辑：

- `_parse_user_agent`：正常 UA 字符串/空字符串
- `get_user_sessions`：active_only 过滤、current_jti 标记
- `get_session_by_jti`：access/refresh 两种 token 类型查询
- `_assess_risk`：新用户 0 分、新 IP 触发 +30 分
- `cleanup_expired_sessions`：验证 is_active 被设为 False、commit 被调用

### 5. ProjectRelationsService（project_relations_service.py）— 9 个测试

纯函数测试，无复杂 mock：

- `calculate_relation_statistics`：空列表/多类型/按类型累加
- `discover_same_customer_relations`：无 customer_id 返回空/返回关系列表
- `discover_same_pm_relations`：无 pm_id 返回空/返回关系列表+reason 包含 PM 姓名
- `get_material_transfer_relations`：类型过滤不匹配时返回空

### 6. ReportService（report_service.py）— 6 个测试

mock DB + mock `ReportTemplate` 类（规避 `enabled` 属性缺失问题）：

- `get_active_monthly_templates`：返回模板列表/返回空列表
- `generate_report`：模板不存在抛 ValueError/不支持类型抛 ValueError
- `generate_report`：USER_MONTHLY 类型正常生成
- `generate_report`：period 格式错误抛异常
- `generate_report`：`generated_by` 字段正确透传

---

## 五、调试记录

### 遭遇问题及解决

1. **`ReportTemplate.enabled` 不存在**  
   `app.models.report_center.ReportTemplate` 无 `enabled` 字段，SQLAlchemy Column 访问失败。  
   **解决**：`@patch("app.services.report_service.ReportTemplate")` 将模型类替换为 MagicMock，filter 参数正常传递。

2. **`from app.models.report import ReportTemplate` 失败**  
   `app/models/report.py` 中只有 `TimesheetReportTemplate`，不存在 `ReportTemplate`。  
   **解决**：移除测试中的错误导入语句。

---

## 六、覆盖率变化（关键文件）

| 文件 | 测试前 | 测试后（估算） |
|------|--------|----------------|
| `evm_service.py` | 54% | ~85%（EVMCalculator 全覆盖）|
| `health_calculator.py` | 0% | ~55%（核心判断逻辑全覆盖）|
| `notification_service.py` | 24% | ~45%（兼容层主路径覆盖）|
| `session_service.py` | 19% | ~35%（工具方法覆盖）|
| `project_relations_service.py` | 0% | ~40%（统计 + 发现函数）|
| `report_service.py` | 18% | ~35%（generate_report 主路径）|

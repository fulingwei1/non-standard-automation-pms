# 覆盖率提升 M3组 报告

**日期**：2026-02-17  
**测试文件**：`tests/unit/test_m3_services.py`  
**测试数量**：83 个用例，全部通过 ✅

---

## 各文件覆盖率对比

| 文件 | 行数 | 测试前覆盖率 | 测试后覆盖率 | 提升幅度 | 测试数 |
|------|------|------------|------------|---------|--------|
| `services/staff_matching/score_calculators.py` | 137 | 11% | **44%** | +33% | 10 |
| `services/project_import_service.py` | 137 | 10% | **34%** | +24% | 10 |
| `services/report_framework/renderers/excel_renderer.py` | 137 | 10% | **93%** | +83% | 8 |
| `services/alert/alert_statistics_service.py` | 137 | 8% | **52%** | +44% | 11 |
| `services/timesheet_reminder/anomaly_detector.py` | 135 | 10% | **52%** | +42% | 7 |
| `services/pipeline_break_analysis_service.py` | 134 | 10% | **36%** | +26% | 7 |
| `services/manager_evaluation_service.py` | 125 | 0% | **35%** | +35% | 11 |
| `services/employee_import_service.py` | 130/154 | ~0% | **36%** | +36% | 12 |
| `services/user_sync_service.py` | 105/130 | ~0% | **50%** | +50% | 7 |

---

## 测试类说明

### 1. `TestSkillScoreCalculator` + `TestWorkloadScoreCalculator`
- 覆盖 `SkillScoreCalculator.calculate_skill_score`（无技能/有技能/缺失技能/奖励分/100封顶）
- 覆盖 `WorkloadScoreCalculator.calculate_workload_score`（无档案/完全可用/部分可用/不可用）
- 覆盖 `QualityScoreCalculator.calculate_quality_score`（无绩效记录→60分）

### 2. `TestProjectImportService`
- 覆盖文件验证 `validate_excel_file`（合法/非法扩展名）
- 覆盖列值获取 `get_column_value`（带星号/回退alt）
- 覆盖行解析 `parse_project_row`（缺字段/正常）
- 覆盖列验证 `validate_project_columns`（缺少必需列）
- 覆盖客户查询 `find_or_create_customer`（不存在返回 None）
- 覆盖日期/金额解析（NaN/正常值）

### 3. `TestExcelRenderer`
- 实际运行 `ExcelRenderer.render()`（使用真实 openpyxl）
- 覆盖 `format_name`、`content_type` 属性
- 覆盖表格类型 section（table/metrics/chart）
- 覆盖超过1000行的截断提示
- 覆盖创建目录失败时抛出 `RenderError`

### 4. `TestAlertStatisticsService`
- 覆盖 `get_alert_statistics`（默认日期/自定义日期/project_id过滤）
- 覆盖 `get_alert_trends`
- 覆盖 `get_response_metrics`（空结果）
- 覆盖 `_calculate_efficiency_metrics`
- 覆盖 `_format_seconds`（小时/分钟/None）
- 覆盖 `_get_percentile`（空列表/单元素）

> **注意**：`AlertRecord` 模型缺少 `resolved_at` 列（服务代码 bug），测试中通过 `_patch_alert_record()` 动态注入缺失属性来绕过。

### 5. `TestTimesheetAnomalyDetector`
- 覆盖全部 5 类异常检测方法空结果路径
- 覆盖 `detect_all_anomalies` 主入口
- 覆盖 `detect_progress_mismatch` 4h无进度变化→触发异常记录

### 6. `TestPipelineBreakAnalysisService`
- 覆盖 `analyze_pipeline_breaks` 返回结构验证
- 覆盖 `_detect_lead_to_opp_breaks`、`_detect_opp_to_quote_breaks` 空结果
- 覆盖 `break_rate` 计算（0-100范围）
- 覆盖 `get_break_reasons`、`get_break_warnings`

> **注意**：`Contract.sign_date` 不存在（应为 `signing_date`），`Invoice.invoice_date` 不存在，涉及这两个属性的方法通过 `patch.object` 绕过。

### 7. `TestManagerEvaluationService`
- 覆盖 `_calculate_level`（S/A/B/C/D 全等级）
- 覆盖 `adjust_performance` 校验（空理由/太短/result不存在）
- 覆盖 `check_manager_permission`（manager不存在→False）
- 覆盖 `get_manager_evaluation_tasks`（manager不存在→空列表）
- 覆盖 `get_adjustment_history`（空历史）

### 8. `TestEmployeeImportService`
- 覆盖列名查找（find_name/find_department/find_other）
- 覆盖数据清理（clean_name/clean_phone/is_active）
- 覆盖部门层级合并（一级+二级→"一级-二级"）
- 覆盖科学计数法手机号处理

### 9. `TestUserSyncService`
- 覆盖 `get_role_by_position`（空/使用默认映射）
- 覆盖 `reset_user_password`（用户不存在）
- 覆盖 `toggle_user_active`（不存在/超管/正常激活）
- 覆盖 `batch_toggle_active`（批量成功）
- 覆盖 `create_user_from_employee`（已有账号）

---

## 执行结果

```
======================= 83 passed, 5 warnings in 32.47s ========================
```

所有 83 个测试用例全部通过，无失败。

---

## 已知 Bug（服务代码本身）

| 服务文件 | Bug 描述 |
|---------|---------|
| `alert_statistics_service.py` | 引用 `AlertRecord.resolved_at`，但模型中该字段不存在（实际字段为 `handle_end_at`） |
| `pipeline_break_analysis_service.py` | 引用 `Contract.sign_date`，应为 `Contract.signing_date` |
| `pipeline_break_analysis_service.py` | 引用 `Invoice.invoice_date`，该字段在模型中不存在 |

以上 bug 不影响测试通过（通过 mock 绕过），但建议后续修复服务代码。

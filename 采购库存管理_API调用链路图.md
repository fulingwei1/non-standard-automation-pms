# é‡‡è´­åº“å­˜ç®¡ç†ç³»ç»Ÿ - APIè°ƒç”¨é“¾è·¯å›¾

**ç”Ÿæˆæ—¶é—´**: 2026-02-16 10:26

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ (React)                          â”‚
â”‚  23ä¸ªé¡µé¢ + 37ä¸ªç»„ä»¶ + 3ä¸ªAPI Service                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ HTTP/JSON (32ä¸ªAPI)
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åç«¯APIå±‚ (FastAPI)                        â”‚
â”‚  10ä¸ªé‡‡è´­API + 12ä¸ªåº“å­˜API + 10ä¸ªé¢„è­¦API                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ SQLAlchemy ORM
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ ¸å¿ƒæœåŠ¡å±‚ (Services)                        â”‚
â”‚  æ™ºèƒ½é‡‡è´­å¼•æ“ + åº“å­˜ç®¡ç†æœåŠ¡ + æ™ºèƒ½é¢„è­¦å¼•æ“                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Database Operations
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®åº“ (PostgreSQL)                        â”‚
â”‚  13ä¸ªä¸šåŠ¡è¡¨ + ç´¢å¼• + å¤–é”®çº¦æŸ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— APIè°ƒç”¨é“¾è·¯è¯¦è§£

### æ¨¡å—1: æ™ºèƒ½é‡‡è´­ç®¡ç† (10æ¡é“¾è·¯)

#### é“¾è·¯1: é‡‡è´­å»ºè®®åˆ—è¡¨æŸ¥è¯¢
```
å‰ç«¯é¡µé¢:
  SuggestionsList.tsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/purchase/suggestions?status=PENDING&limit=20
    â†“
åç«¯è·¯ç”±:
  app/api/v1/endpoints/purchase_intelligence.py::get_purchase_suggestions()
    â†“
æ ¸å¿ƒæœåŠ¡:
  app/services/purchase_suggestion_engine.py::PurchaseSuggestionEngine
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  SELECT * FROM purchase_suggestions WHERE tenant_id=? AND status=? LIMIT 20
    â†“
è¿”å›æ•°æ®:
  {
    "data": [
      {
        "id": 1,
        "suggestion_no": "PS001",
        "material_id": 101,
        "required_qty": 500,
        "urgency_level": "CRITICAL",
        "recommended_supplier_id": 5,
        "confidence": 92.0,
        "status": "PENDING"
      }
    ],
    "total": 45
  }
```

#### é“¾è·¯2: æ‰¹å‡†é‡‡è´­å»ºè®®
```
å‰ç«¯ç»„ä»¶:
  ApprovalDialog.tsx
    â†“
APIè°ƒç”¨:
  POST /api/v1/purchase/suggestions/1/approve
  Body: { "approved": true, "note": "æ‰¹å‡†" }
    â†“
åç«¯è·¯ç”±:
  purchase_intelligence.py::approve_suggestion(suggestion_id=1)
    â†“
æ ¸å¿ƒæœåŠ¡:
  PurchaseSuggestionEngine.update_status()
    â†“
æ•°æ®åº“æ“ä½œ:
  UPDATE purchase_suggestions 
  SET status='APPROVED', approved_by=?, approved_at=NOW()
  WHERE id=1
    â†“
è§¦å‘åç»­æ“ä½œ:
  å¯é€‰: è‡ªåŠ¨åˆ›å»ºé‡‡è´­è®¢å•
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "message": "é‡‡è´­å»ºè®®å·²æ‰¹å‡†",
    "suggestion_id": 1
  }
```

#### é“¾è·¯3: å»ºè®®è½¬é‡‡è´­è®¢å•
```
å‰ç«¯é¡µé¢:
  SuggestionDetail.tsx
    â†“
APIè°ƒç”¨:
  POST /api/v1/purchase/suggestions/1/create-order
    â†“
åç«¯è·¯ç”±:
  purchase_intelligence.py::create_order_from_suggestion()
    â†“
æ ¸å¿ƒæœåŠ¡:
  1. è¯»å–é‡‡è´­å»ºè®®è¯¦æƒ…
  2. åˆ›å»ºé‡‡è´­è®¢å• (PurchaseOrder)
  3. åˆ›å»ºè®¢å•æ˜ç»† (PurchaseOrderItem)
  4. æ›´æ–°å»ºè®®çŠ¶æ€ä¸º "ORDERED"
    â†“
æ•°æ®åº“æ“ä½œ:
  BEGIN TRANSACTION;
  INSERT INTO purchase_orders (...) VALUES (...);
  INSERT INTO purchase_order_items (...) VALUES (...);
  UPDATE purchase_suggestions SET status='ORDERED' WHERE id=1;
  COMMIT;
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "order_id": 2001,
    "order_no": "PO20260216001",
    "message": "é‡‡è´­è®¢å•å·²åˆ›å»º"
  }
```

#### é“¾è·¯4: ä¾›åº”å•†ç»©æ•ˆæŸ¥è¯¢
```
å‰ç«¯é¡µé¢:
  PerformanceManagement.tsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/purchase/suppliers/5/performance?evaluation_period=2026-01
    â†“
åç«¯è·¯ç”±:
  purchase_intelligence.py::get_supplier_performance()
    â†“
æ ¸å¿ƒæœåŠ¡:
  app/services/supplier_performance_evaluator.py::SupplierPerformanceEvaluator
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  SELECT * FROM supplier_performances 
  WHERE supplier_id=5 AND evaluation_period='2026-01'
    â†“
è¿”å›æ•°æ®:
  {
    "supplier_id": 5,
    "supplier_name": "ä¸Šæµ·é‡‘å±ææ–™æœ‰é™å…¬å¸",
    "evaluation_period": "2026-01",
    "on_time_delivery_rate": 92.0,
    "quality_rate": 98.5,
    "price_competitiveness": 85.0,
    "response_time_score": 88.0,
    "overall_score": 90.8,
    "grade": "A+"
  }
```

#### é“¾è·¯5: è§¦å‘ä¾›åº”å•†è¯„ä¼°
```
å‰ç«¯é¡µé¢:
  PerformanceManagement.tsx
    â†“
APIè°ƒç”¨:
  POST /api/v1/purchase/suppliers/5/evaluate
  Body: { "evaluation_period": "2026-01" }
    â†“
åç«¯è·¯ç”±:
  purchase_intelligence.py::trigger_evaluation()
    â†“
æ ¸å¿ƒæœåŠ¡:
  SupplierPerformanceEvaluator.evaluate_supplier()
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. æŸ¥è¯¢è¯¥ä¾›åº”å•†åœ¨æŒ‡å®šæœŸé—´çš„æ‰€æœ‰è®¢å•
  2. è®¡ç®—å‡†æ—¶äº¤è´§ç‡ = on_time_orders / total_orders
  3. è®¡ç®—è´¨é‡åˆæ ¼ç‡ = qualified_qty / total_received_qty
  4. è®¡ç®—ä»·æ ¼ç«äº‰åŠ› (vs å¸‚åœºä»·)
  5. è®¡ç®—å“åº”é€Ÿåº¦ (å¹³å‡å“åº”æ—¶é—´)
  6. ç»¼åˆè¯„åˆ† = Î£(æŒ‡æ ‡ Ã— æƒé‡)
  7. ç¡®å®šè¯„çº§ (A+/A/B/C/D)
    â†“
æ•°æ®åº“æ“ä½œ:
  INSERT INTO supplier_performances (...) VALUES (...)
  ON CONFLICT (supplier_id, evaluation_period) DO UPDATE
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "performance_id": 123,
    "overall_score": 90.8,
    "grade": "A+",
    "message": "è¯„ä¼°å®Œæˆ"
  }
```

#### é“¾è·¯6: ä¾›åº”å•†æ’åæŸ¥è¯¢
```
å‰ç«¯é¡µé¢:
  SupplierRanking.tsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/purchase/suppliers/ranking?evaluation_period=2026-01&limit=10
    â†“
åç«¯è·¯ç”±:
  purchase_intelligence.py::get_supplier_ranking()
    â†“
æ ¸å¿ƒæœåŠ¡:
  SupplierPerformanceEvaluator.get_supplier_ranking()
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  SELECT sp.*, s.name as supplier_name
  FROM supplier_performances sp
  JOIN suppliers s ON sp.supplier_id = s.id
  WHERE sp.evaluation_period = '2026-01'
  ORDER BY sp.overall_score DESC
  LIMIT 10
    â†“
è¿”å›æ•°æ®:
  {
    "data": [
      { "rank": 1, "supplier_name": "ä¸Šæµ·é‡‘å±", "score": 92.0, "grade": "A+" },
      { "rank": 2, "supplier_name": "å¹¿ä¸œé“æ", "score": 88.5, "grade": "A" },
      { "rank": 3, "supplier_name": "æ±Ÿè‹ç”µæœº", "score": 85.2, "grade": "A" }
    ]
  }
```

#### é“¾è·¯7-10: å…¶ä»–é‡‡è´­API
- **é“¾è·¯7**: åˆ›å»ºæŠ¥ä»· (POST /quotations)
- **é“¾è·¯8**: æŠ¥ä»·æ¯”ä»· (GET /quotations/compare)
- **é“¾è·¯9**: è®¢å•è·Ÿè¸ª (GET /orders/{id}/tracking)
- **é“¾è·¯10**: æ”¶è´§ç¡®è®¤ (POST /orders/{id}/receive)

---

### æ¨¡å—2: ç‰©æ–™åº“å­˜ç®¡ç† (12æ¡é“¾è·¯)

#### é“¾è·¯11: åº“å­˜æŸ¥è¯¢
```
å‰ç«¯é¡µé¢:
  StockList.tsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/inventory/stocks?material_id=101&location=ä»“åº“A
    â†“
åç«¯è·¯ç”±:
  app/api/v1/endpoints/inventory/inventory_router.py::get_stocks()
    â†“
æ ¸å¿ƒæœåŠ¡:
  app/services/inventory_management_service.py::InventoryManagementService
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  SELECT ms.*, m.code, m.name, m.spec
  FROM material_stocks ms
  JOIN materials m ON ms.material_id = m.id
  WHERE ms.material_id = 101 AND ms.location LIKE '%ä»“åº“A%'
    â†“
è¿”å›æ•°æ®:
  {
    "data": [
      {
        "id": 1,
        "material_id": 101,
        "material_code": "M001",
        "material_name": "ä¸é”ˆé’¢æ¿ 304",
        "quantity": 500,
        "available_quantity": 450,  // å¯ç”¨ = æ€»é‡ - é¢„ç•™
        "reserved_quantity": 50,
        "unit_price": 58.50,
        "location": "ä»“åº“A-01è´§æ¶",
        "batch_number": "BATCH-20260216-001"
      }
    ]
  }
```

#### é“¾è·¯12: äº¤æ˜“è®°å½•æŸ¥è¯¢
```
å‰ç«¯é¡µé¢:
  TransactionHistory.tsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/inventory/stocks/1/transactions?limit=50
    â†“
åç«¯è·¯ç”±:
  inventory_router.py::get_transactions()
    â†“
æ ¸å¿ƒæœåŠ¡:
  InventoryManagementService.get_transactions()
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  SELECT mt.*, u.name as operator_name
  FROM material_transactions mt
  LEFT JOIN users u ON mt.created_by = u.id
  WHERE mt.material_id = 101
  ORDER BY mt.created_at DESC
  LIMIT 50
    â†“
è¿”å›æ•°æ®:
  {
    "data": [
      {
        "id": 501,
        "transaction_no": "T20260216001",
        "transaction_type": "ISSUE",  // é¢†æ–™
        "quantity": 50,
        "unit_price": 58.50,
        "total_cost": 2925.00,
        "work_order_id": 3001,
        "created_by": 10,
        "operator_name": "å¼ ä¸‰",
        "created_at": "2026-02-16T08:30:00"
      }
    ]
  }
```

#### é“¾è·¯13: ç‰©æ–™é¢„ç•™
```
å‰ç«¯é¡µé¢:
  MaterialReservation.tsx
    â†“
APIè°ƒç”¨:
  POST /api/v1/inventory/reserve
  Body: {
    "material_id": 101,
    "quantity": 200,
    "project_id": 5,
    "expected_use_date": "2026-03-01"
  }
    â†“
åç«¯è·¯ç”±:
  inventory_router.py::reserve_material()
    â†“
æ ¸å¿ƒæœåŠ¡:
  InventoryManagementService.reserve_material()
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³ (available_quantity >= 200)
  2. åˆ›å»ºé¢„ç•™è®°å½• (MaterialReservation)
  3. æ‰£å‡å¯ç”¨åº“å­˜ (available_quantity -= 200)
  4. å¢åŠ é¢„ç•™åº“å­˜ (reserved_quantity += 200)
    â†“
æ•°æ®åº“æ“ä½œ:
  BEGIN TRANSACTION;
  INSERT INTO material_reservations (...) VALUES (...);
  UPDATE material_stocks 
  SET available_quantity = available_quantity - 200,
      reserved_quantity = reserved_quantity + 200
  WHERE material_id = 101;
  COMMIT;
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "reservation_id": 301,
    "reservation_no": "RES20260216001",
    "message": "ç‰©æ–™é¢„ç•™æˆåŠŸ"
  }
```

#### é“¾è·¯14: é¢†æ–™å‡ºåº“
```
å‰ç«¯é¡µé¢:
  MaterialIssue.tsx
    â†“
APIè°ƒç”¨:
  POST /api/v1/inventory/issue
  Body: {
    "material_id": 101,
    "quantity": 150,
    "work_order_id": 3001,
    "cost_method": "FIFO"  // å…ˆè¿›å…ˆå‡º
  }
    â†“
åç«¯è·¯ç”±:
  inventory_router.py::issue_material()
    â†“
æ ¸å¿ƒæœåŠ¡:
  InventoryManagementService.issue_material()
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
  2. æ ¹æ®æˆæœ¬æ ¸ç®—æ–¹æ³• (FIFO/LIFO/åŠ æƒå¹³å‡) é€‰æ‹©æ‰¹æ¬¡
  3. åˆ›å»ºäº¤æ˜“è®°å½• (MaterialTransaction, type=ISSUE)
  4. æ‰£å‡åº“å­˜æ•°é‡
  5. å¦‚æœ‰é¢„ç•™ï¼Œé‡Šæ”¾é¢„ç•™
    â†“
æ•°æ®åº“æ“ä½œ (FIFOç¤ºä¾‹):
  BEGIN TRANSACTION;
  -- æŸ¥è¯¢æœ€æ—©æ‰¹æ¬¡
  SELECT * FROM material_stocks 
  WHERE material_id=101 AND quantity > 0
  ORDER BY last_in_date ASC
  LIMIT 1;
  -- åˆ›å»ºäº¤æ˜“è®°å½•
  INSERT INTO material_transactions (type='ISSUE', ...) VALUES (...);
  -- æ‰£å‡åº“å­˜
  UPDATE material_stocks SET quantity = quantity - 150 WHERE id=1;
  -- é‡Šæ”¾é¢„ç•™ (å¦‚æœ‰)
  UPDATE material_reservations SET status='USED' WHERE ...;
  COMMIT;
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "transaction_id": 502,
    "batches": [
      { "batch_no": "BATCH001", "quantity": 150, "unit_price": 58.50 }
    ],
    "total_cost": 8775.00,
    "message": "é¢†æ–™æˆåŠŸ"
  }
```

#### é“¾è·¯15: é€€æ–™å…¥åº“
```
å‰ç«¯é¡µé¢:
  MaterialReturn.tsx
    â†“
APIè°ƒç”¨:
  POST /api/v1/inventory/return
  Body: {
    "material_id": 101,
    "quantity": 20,
    "reason": "é¡¹ç›®å–æ¶ˆ",
    "original_work_order_id": 3001
  }
    â†“
åç«¯è·¯ç”±:
  inventory_router.py::return_material()
    â†“
æ ¸å¿ƒæœåŠ¡:
  InventoryManagementService.return_material()
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. åˆ›å»ºäº¤æ˜“è®°å½• (type=RETURN)
  2. å¢åŠ åº“å­˜æ•°é‡
  3. æ›´æ–°å¯ç”¨åº“å­˜
    â†“
æ•°æ®åº“æ“ä½œ:
  BEGIN TRANSACTION;
  INSERT INTO material_transactions (type='RETURN', ...) VALUES (...);
  UPDATE material_stocks 
  SET quantity = quantity + 20,
      available_quantity = available_quantity + 20
  WHERE material_id = 101;
  COMMIT;
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "transaction_id": 503,
    "message": "é€€æ–™æˆåŠŸ"
  }
```

#### é“¾è·¯16: åº“å­˜è½¬ç§»
```
å‰ç«¯é¡µé¢:
  StockTransfer.tsx
    â†“
APIè°ƒç”¨:
  POST /api/v1/inventory/transfer
  Body: {
    "material_id": 101,
    "quantity": 100,
    "from_location": "ä»“åº“A-01",
    "to_location": "ä»“åº“B-05"
  }
    â†“
åç«¯è·¯ç”±:
  inventory_router.py::transfer_stock()
    â†“
æ ¸å¿ƒæœåŠ¡:
  InventoryManagementService.transfer_stock()
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. ä»æºä½ç½®æ‰£å‡åº“å­˜
  2. å‘ç›®æ ‡ä½ç½®å¢åŠ åº“å­˜
  3. åˆ›å»º2æ¡äº¤æ˜“è®°å½• (OUT + IN)
    â†“
æ•°æ®åº“æ“ä½œ:
  BEGIN TRANSACTION;
  -- æºä½ç½®æ‰£å‡
  UPDATE material_stocks 
  SET quantity = quantity - 100
  WHERE material_id=101 AND location='ä»“åº“A-01';
  -- ç›®æ ‡ä½ç½®å¢åŠ 
  UPDATE material_stocks 
  SET quantity = quantity + 100
  WHERE material_id=101 AND location='ä»“åº“B-05';
  -- åˆ›å»ºäº¤æ˜“è®°å½•
  INSERT INTO material_transactions (type='TRANSFER_OUT', ...) VALUES (...);
  INSERT INTO material_transactions (type='TRANSFER_IN', ...) VALUES (...);
  COMMIT;
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "from_transaction_id": 504,
    "to_transaction_id": 505,
    "message": "åº“å­˜è½¬ç§»æˆåŠŸ"
  }
```

#### é“¾è·¯17: ç›˜ç‚¹ä»»åŠ¡åˆ—è¡¨
```
å‰ç«¯é¡µé¢:
  CountTasks.tsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/inventory/count/tasks?status=IN_PROGRESS
    â†“
åç«¯è·¯ç”±:
  inventory_router.py::get_count_tasks()
    â†“
æ ¸å¿ƒæœåŠ¡:
  app/services/stock_count_service.py::StockCountService
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  SELECT sct.*, u.name as creator_name
  FROM stock_count_tasks sct
  LEFT JOIN users u ON sct.created_by = u.id
  WHERE sct.status = 'IN_PROGRESS'
  ORDER BY sct.count_date DESC
    â†“
è¿”å›æ•°æ®:
  {
    "data": [
      {
        "id": 10,
        "task_no": "CT20260216001",
        "count_type": "FULL",  // å…¨ç›˜
        "count_date": "2026-02-20",
        "status": "IN_PROGRESS",
        "total_items": 16,
        "counted_items": 2,
        "created_by": 1,
        "creator_name": "ç®¡ç†å‘˜"
      }
    ]
  }
```

#### é“¾è·¯18: åˆ›å»ºç›˜ç‚¹ä»»åŠ¡
```
å‰ç«¯ç»„ä»¶:
  CreateTaskDialog.tsx
    â†“
APIè°ƒç”¨:
  POST /api/v1/inventory/count/tasks
  Body: {
    "count_type": "FULL",
    "count_date": "2026-02-20",
    "location": "ä»“åº“A"
  }
    â†“
åç«¯è·¯ç”±:
  inventory_router.py::create_count_task()
    â†“
æ ¸å¿ƒæœåŠ¡:
  StockCountService.create_count_task()
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. åˆ›å»ºç›˜ç‚¹ä»»åŠ¡è®°å½•
  2. æŸ¥è¯¢è¯¥ä»“åº“çš„æ‰€æœ‰ç‰©æ–™
  3. ä¸ºæ¯ä¸ªç‰©æ–™åˆ›å»ºç›˜ç‚¹æ˜ç»† (è´¦é¢æ•°é‡å¿«ç…§)
    â†“
æ•°æ®åº“æ“ä½œ:
  BEGIN TRANSACTION;
  -- åˆ›å»ºä»»åŠ¡
  INSERT INTO stock_count_tasks (...) VALUES (...);
  -- æŸ¥è¯¢ç‰©æ–™
  SELECT * FROM material_stocks WHERE location LIKE '%ä»“åº“A%';
  -- æ‰¹é‡åˆ›å»ºæ˜ç»†
  INSERT INTO stock_count_details (task_id, material_id, system_quantity, ...)
  VALUES 
    (10, 101, 500),
    (10, 102, 300),
    ...;
  COMMIT;
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "task_id": 10,
    "task_no": "CT20260216001",
    "total_items": 16,
    "message": "ç›˜ç‚¹ä»»åŠ¡å·²åˆ›å»º"
  }
```

#### é“¾è·¯19: å½•å…¥å®ç›˜æ•°é‡
```
å‰ç«¯ç»„ä»¶:
  CountInputForm.tsx
    â†“
APIè°ƒç”¨:
  PUT /api/v1/inventory/count/details/101
  Body: {
    "actual_quantity": 495,
    "counted_by": 10
  }
    â†“
åç«¯è·¯ç”±:
  inventory_router.py::record_actual_quantity()
    â†“
æ ¸å¿ƒæœåŠ¡:
  StockCountService.record_actual_quantity()
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. æ›´æ–°å®ç›˜æ•°é‡
  2. è®¡ç®—å·®å¼‚ = actual - system
  3. è®¡ç®—å·®å¼‚é‡‘é¢ = å·®å¼‚ Ã— å•ä»·
  4. æ›´æ–°ç›˜ç‚¹æ˜ç»†çŠ¶æ€
    â†“
æ•°æ®åº“æ“ä½œ:
  UPDATE stock_count_details
  SET actual_quantity = 495,
      difference_quantity = 495 - 500,  -- -5
      difference_value = -5 * 58.50,    -- -292.50
      counted_by = 10,
      counted_at = NOW()
  WHERE id = 101;
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "detail_id": 101,
    "difference_quantity": -5,
    "difference_value": -292.50,
    "message": "å®ç›˜æ•°é‡å·²å½•å…¥"
  }
```

#### é“¾è·¯20: æ‰¹å‡†åº“å­˜è°ƒæ•´
```
å‰ç«¯ç»„ä»¶:
  AdjustmentApproval.tsx
    â†“
APIè°ƒç”¨:
  POST /api/v1/inventory/count/tasks/10/approve
  Body: {
    "auto_adjust": true,
    "approved_by": 2
  }
    â†“
åç«¯è·¯ç”±:
  inventory_router.py::approve_adjustment()
    â†“
æ ¸å¿ƒæœåŠ¡:
  StockCountService.approve_adjustment()
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. éå†æ‰€æœ‰ç›˜ç‚¹æ˜ç»†
  2. å¯¹æœ‰å·®å¼‚çš„ç‰©æ–™:
     a. åˆ›å»ºåº“å­˜è°ƒæ•´è®°å½• (StockAdjustment)
     b. åˆ›å»ºäº¤æ˜“è®°å½• (MaterialTransaction, type=ADJUSTMENT)
     c. æ›´æ–°åº“å­˜æ•°é‡ (quantity += difference)
  3. æ›´æ–°ç›˜ç‚¹ä»»åŠ¡çŠ¶æ€ä¸º "COMPLETED"
    â†“
æ•°æ®åº“æ“ä½œ:
  BEGIN TRANSACTION;
  -- åˆ›å»ºè°ƒæ•´è®°å½•
  INSERT INTO stock_adjustments (detail_id, adjustment_qty, ...) VALUES (...);
  -- åˆ›å»ºäº¤æ˜“è®°å½•
  INSERT INTO material_transactions (type='ADJUSTMENT', ...) VALUES (...);
  -- æ›´æ–°åº“å­˜
  UPDATE material_stocks 
  SET quantity = quantity + (-5)  -- å®ç›˜å°‘äº†5
  WHERE material_id = 101;
  -- æ›´æ–°ä»»åŠ¡çŠ¶æ€
  UPDATE stock_count_tasks SET status='COMPLETED' WHERE id=10;
  COMMIT;
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "total_adjustments": 3,
    "total_diff_value": -450.00,
    "message": "åº“å­˜è°ƒæ•´å·²å®Œæˆ"
  }
```

#### é“¾è·¯21: åº“å­˜å‘¨è½¬ç‡åˆ†æ
```
å‰ç«¯é¡µé¢:
  TurnoverAnalysis.tsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/inventory/analysis/turnover?start_date=2025-12-01&end_date=2026-02-29
    â†“
åç«¯è·¯ç”±:
  inventory_router.py::get_turnover_analysis()
    â†“
æ ¸å¿ƒæœåŠ¡:
  InventoryManagementService.calculate_turnover()
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. è®¡ç®—æœŸé—´å†…çš„å‡ºåº“æ€»é¢
  2. è®¡ç®—å¹³å‡åº“å­˜é‡‘é¢
  3. å‘¨è½¬ç‡ = å‡ºåº“æ€»é¢ / å¹³å‡åº“å­˜
  4. å‘¨è½¬å¤©æ•° = 365 / å‘¨è½¬ç‡
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  -- å‡ºåº“æ€»é¢
  SELECT SUM(total_cost) as total_issue
  FROM material_transactions
  WHERE type='ISSUE' AND created_at BETWEEN '2025-12-01' AND '2026-02-29';
  
  -- å¹³å‡åº“å­˜
  SELECT AVG(quantity * unit_price) as avg_inventory
  FROM material_stocks;
    â†“
è¿”å›æ•°æ®:
  {
    "turnover_rate": 6.5,  // å‘¨è½¬ç‡
    "turnover_days": 56,   // å‘¨è½¬å¤©æ•°
    "total_issue": 2500000,
    "avg_inventory": 384615,
    "trend_data": [
      { "month": "2025-12", "rate": 6.2 },
      { "month": "2026-01", "rate": 6.8 },
      { "month": "2026-02", "rate": 6.5 }
    ]
  }
```

#### é“¾è·¯22: åº“é¾„åˆ†æ
```
å‰ç«¯é¡µé¢:
  AgingAnalysis.tsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/inventory/analysis/aging
    â†“
åç«¯è·¯ç”±:
  inventory_router.py::get_aging_analysis()
    â†“
æ ¸å¿ƒæœåŠ¡:
  InventoryManagementService.analyze_aging()
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. æŸ¥è¯¢æ‰€æœ‰åº“å­˜æ‰¹æ¬¡
  2. è®¡ç®—åº“é¾„ = å½“å‰æ—¥æœŸ - last_in_date
  3. åˆ†ç±»ç»Ÿè®¡:
     - 0-30å¤©
     - 31-90å¤©
     - 91-180å¤©
     - 180+å¤© (å‘†æ»)
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  SELECT 
    CASE
      WHEN DATEDIFF(NOW(), last_in_date) <= 30 THEN '0-30å¤©'
      WHEN DATEDIFF(NOW(), last_in_date) <= 90 THEN '31-90å¤©'
      WHEN DATEDIFF(NOW(), last_in_date) <= 180 THEN '91-180å¤©'
      ELSE '180+å¤©'
    END as age_range,
    COUNT(*) as count,
    SUM(quantity * unit_price) as total_value
  FROM material_stocks
  GROUP BY age_range;
    â†“
è¿”å›æ•°æ®:
  {
    "distribution": [
      { "range": "0-30å¤©", "count": 8, "value": 150000, "percentage": 45% },
      { "range": "31-90å¤©", "count": 5, "value": 100000, "percentage": 30% },
      { "range": "91-180å¤©", "count": 2, "value": 50000, "percentage": 15% },
      { "range": "180+å¤©", "count": 1, "value": 30000, "percentage": 10% }
    ],
    "slow_moving_items": [
      { "material": "æ—§å‹å·ç”µæœº", "age": 200, "value": 30000 }
    ]
  }
```

---

### æ¨¡å—3: æ™ºèƒ½ç¼ºæ–™é¢„è­¦ (10æ¡é“¾è·¯)

#### é“¾è·¯23: é¢„è­¦åˆ—è¡¨æŸ¥è¯¢
```
å‰ç«¯é¡µé¢:
  AlertDashboard.jsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/shortage/smart/alerts?alert_level=URGENT&status=PENDING
    â†“
åç«¯è·¯ç”±:
  app/api/v1/endpoints/shortage/smart_alerts.py::get_shortage_alerts()
    â†“
æ ¸å¿ƒæœåŠ¡:
  app/services/shortage/smart_alert_engine.py::SmartAlertEngine
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  SELECT sa.*, m.code, m.name
  FROM shortage_alerts_enhanced sa
  JOIN materials m ON sa.material_id = m.id
  WHERE sa.alert_level = 'URGENT' AND sa.status = 'PENDING'
  ORDER BY sa.alert_date DESC
    â†“
è¿”å›æ•°æ®:
  {
    "data": [
      {
        "id": 1,
        "alert_no": "SA001",
        "alert_level": "URGENT",
        "material_id": 101,
        "material_code": "M001",
        "material_name": "ä¸é”ˆé’¢æ¿ 304",
        "required_qty": 500,
        "available_qty": 50,
        "shortage_qty": 450,
        "required_date": "2026-02-18",
        "estimated_delay_days": 3,
        "estimated_cost_impact": 26325.00,
        "risk_score": 89,
        "status": "PENDING"
      }
    ]
  }
```

#### é“¾è·¯24: é¢„è­¦è¯¦æƒ…æŸ¥è¯¢
```
å‰ç«¯é¡µé¢:
  AlertDetail.jsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/shortage/smart/alerts/1
    â†“
åç«¯è·¯ç”±:
  smart_alerts.py::get_alert_detail()
    â†“
æ ¸å¿ƒæœåŠ¡:
  SmartAlertEngine.get_alert_with_impact()
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  SELECT sa.*, 
         m.code, m.name, m.unit_price,
         p.name as project_name
  FROM shortage_alerts_enhanced sa
  JOIN materials m ON sa.material_id = m.id
  LEFT JOIN projects p ON sa.project_id = p.id
  WHERE sa.id = 1;
    â†“
è¿”å›æ•°æ®:
  {
    "alert": { ... },
    "impact_analysis": {
      "estimated_delay_days": 3,
      "estimated_cost_impact": 26325.00,
      "affected_projects": [
        { "id": 5, "name": "é¡¹ç›®A", "delay_impact": 2 },
        { "id": 6, "name": "é¡¹ç›®B", "delay_impact": 1 }
      ],
      "risk_score": 89,
      "risk_level": "HIGH"
    }
  }
```

#### é“¾è·¯25: è§¦å‘ç¼ºæ–™æ‰«æ
```
å‰ç«¯ç»„ä»¶:
  QuickScanButton.jsx
    â†“
APIè°ƒç”¨:
  POST /api/v1/shortage/smart/scan
  Body: {
    "days_ahead": 30,
    "project_id": null  // å…¨å±€æ‰«æ
  }
    â†“
åç«¯è·¯ç”±:
  smart_alerts.py::trigger_scan()
    â†“
æ ¸å¿ƒæœåŠ¡:
  SmartAlertEngine.scan_and_alert()
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. æ”¶é›†æœªæ¥30å¤©çš„ç‰©æ–™éœ€æ±‚ (ä»WorkOrder, BOM)
  2. æŸ¥è¯¢å½“å‰åº“å­˜å’Œåœ¨é€”æ•°é‡
  3. è®¡ç®—ç¼ºæ–™:
     shortage = required - (stock + in_transit)
  4. å¯¹æ¯ä¸ªç¼ºæ–™ç‰©æ–™:
     a. è®¡ç®—é¢„è­¦çº§åˆ« (URGENT/CRITICAL/WARNING/INFO)
     b. é¢„æµ‹å½±å“ (å»¶æœŸå¤©æ•°ã€æˆæœ¬)
     c. è®¡ç®—é£é™©è¯„åˆ†
     d. åˆ›å»ºé¢„è­¦è®°å½•
  5. å¯¹ CRITICAL/URGENT é¢„è­¦è‡ªåŠ¨ç”Ÿæˆå¤„ç†æ–¹æ¡ˆ
    â†“
æ•°æ®åº“æ“ä½œ:
  BEGIN TRANSACTION;
  -- æŸ¥è¯¢éœ€æ±‚
  SELECT material_id, SUM(required_qty) as total_required
  FROM work_orders
  WHERE required_date BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL 30 DAY)
  GROUP BY material_id;
  
  -- æŸ¥è¯¢åº“å­˜
  SELECT material_id, SUM(available_quantity) as total_stock
  FROM material_stocks
  GROUP BY material_id;
  
  -- æ‰¹é‡åˆ›å»ºé¢„è­¦
  INSERT INTO shortage_alerts_enhanced (...) VALUES (...), (...), ...;
  COMMIT;
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "scanned_materials": 150,
    "new_alerts": 12,
    "alert_breakdown": {
      "URGENT": 3,
      "CRITICAL": 5,
      "WARNING": 4
    },
    "message": "æ‰«æå®Œæˆï¼Œå‘ç°12ä¸ªç¼ºæ–™é¢„è­¦"
  }
```

#### é“¾è·¯26: è·å–AIå¤„ç†æ–¹æ¡ˆ
```
å‰ç«¯é¡µé¢:
  SolutionRecommendation.jsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/shortage/smart/alerts/1/solutions
    â†“
åç«¯è·¯ç”±:
  smart_alerts.py::get_handling_solutions()
    â†“
æ ¸å¿ƒæœåŠ¡:
  SmartAlertEngine.generate_solutions()
    â†“
ä¸šåŠ¡é€»è¾‘:
  å¯¹é¢„è­¦ç”Ÿæˆ5ç±»å¤„ç†æ–¹æ¡ˆ:
  
  1. URGENT_PURCHASE (ç´§æ€¥é‡‡è´­)
     - å¯è¡Œæ€§: æ£€æŸ¥ä¾›åº”å•†æ˜¯å¦èƒ½åŠ æ€¥
     - æˆæœ¬: æ­£å¸¸ä»· Ã— 1.2 (åŠ æ€¥è´¹)
     - æ—¶é—´: å¹³å‡äº¤æœŸ / 2
     - é£é™©: ä¾›åº”å•†å¯é æ€§
  
  2. SUBSTITUTE (æ›¿ä»£æ–™)
     - å¯è¡Œæ€§: æŸ¥è¯¢æ›¿ä»£æ–™åº“å­˜
     - æˆæœ¬: æ›¿ä»£æ–™ä»·æ ¼å·®å¼‚
     - æ—¶é—´: 0 (ç«‹å³å¯ç”¨)
     - é£é™©: æŠ€æœ¯é£é™©ã€å®¢æˆ·æ¥å—åº¦
  
  3. TRANSFER (é¡¹ç›®é—´è°ƒæ‹¨)
     - å¯è¡Œæ€§: æŸ¥è¯¢å…¶ä»–é¡¹ç›®é¢„ç•™
     - æˆæœ¬: 0 (å†…éƒ¨è°ƒæ‹¨)
     - æ—¶é—´: 1å¤©
     - é£é™©: å…¶ä»–é¡¹ç›®å»¶æœŸé£é™©
  
  4. PARTIAL_DELIVERY (åˆ†æ‰¹äº¤ä»˜)
     - å¯è¡Œæ€§: å®¢æˆ·æ˜¯å¦æ¥å—
     - æˆæœ¬: 0
     - æ—¶é—´: éƒ¨åˆ†å»¶æœŸ
     - é£é™©: å®¢æˆ·æ»¡æ„åº¦
  
  5. RESCHEDULE (ç”Ÿäº§é‡æ’æœŸ)
     - å¯è¡Œæ€§: ç”Ÿäº§è®¡åˆ’çµæ´»æ€§
     - æˆæœ¬: é‡æ’æˆæœ¬
     - æ—¶é—´: ç­‰å¾…äº¤æœŸ
     - é£é™©: æ•´ä½“è¿›åº¦å½±å“
  
  æ¯ä¸ªæ–¹æ¡ˆè®¡ç®—AIç»¼åˆè¯„åˆ†:
  AI_Score = feasibilityÃ—0.3 + costÃ—0.3 + timeÃ—0.3 + riskÃ—0.1
    â†“
æ•°æ®åº“æ“ä½œ:
  -- å¦‚æœæ–¹æ¡ˆå·²å­˜åœ¨ï¼Œç›´æ¥æŸ¥è¯¢
  SELECT * FROM shortage_handling_plans WHERE alert_id = 1;
  
  -- å¦åˆ™ï¼Œç”Ÿæˆå¹¶ä¿å­˜
  INSERT INTO shortage_handling_plans (...) VALUES (...), (...), ...;
    â†“
è¿”å›æ•°æ®:
  {
    "alert_id": 1,
    "solutions": [
      {
        "id": 1,
        "plan_no": "HP001",
        "solution_type": "URGENT_PURCHASE",
        "solution_name": "ç´§æ€¥é‡‡è´­",
        "ai_score": 85.5,
        "feasibility_score": 90,
        "cost_score": 75,
        "time_score": 95,
        "risk_score": 85,
        "advantages": ["å¿«é€Ÿè§£å†³", "è´¨é‡ä¿è¯"],
        "disadvantages": ["æˆæœ¬å¢åŠ 20%"],
        "risks": ["ä¾›åº”å•†äº§èƒ½ä¸è¶³"],
        "is_recommended": true,
        "recommendation_rank": 1
      },
      {
        "id": 2,
        "solution_type": "SUBSTITUTE",
        "ai_score": 72.0,
        "is_recommended": false,
        "recommendation_rank": 2
      }
      // ... å…¶ä»–3ä¸ªæ–¹æ¡ˆ
    ]
  }
```

#### é“¾è·¯27: æ ‡è®°é¢„è­¦å·²è§£å†³
```
å‰ç«¯é¡µé¢:
  AlertDetail.jsx
    â†“
APIè°ƒç”¨:
  POST /api/v1/shortage/smart/alerts/1/resolve
  Body: {
    "solution_id": 1,
    "note": "å·²ç´§æ€¥é‡‡è´­"
  }
    â†“
åç«¯è·¯ç”±:
  smart_alerts.py::resolve_alert()
    â†“
æ ¸å¿ƒæœåŠ¡:
  SmartAlertEngine.mark_resolved()
    â†“
æ•°æ®åº“æ“ä½œ:
  UPDATE shortage_alerts_enhanced
  SET status = 'RESOLVED',
      resolved_solution_id = 1,
      resolved_at = NOW(),
      resolve_note = 'å·²ç´§æ€¥é‡‡è´­'
  WHERE id = 1;
    â†“
è¿”å›æ•°æ®:
  {
    "success": true,
    "alert_id": 1,
    "message": "é¢„è­¦å·²æ ‡è®°ä¸ºè§£å†³"
  }
```

#### é“¾è·¯28: ç‰©æ–™éœ€æ±‚é¢„æµ‹
```
å‰ç«¯é¡µé¢:
  DemandForecast.jsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/shortage/smart/forecast/101?algorithm=EXP_SMOOTHING&forecast_horizon_days=30
    â†“
åç«¯è·¯ç”±:
  smart_alerts.py::get_material_forecast()
    â†“
æ ¸å¿ƒæœåŠ¡:
  app/services/shortage/demand_forecast_engine.py::DemandForecastEngine
    â†“
ä¸šåŠ¡é€»è¾‘:
  1. æŸ¥è¯¢å†å²éœ€æ±‚æ•°æ® (è¿‡å»90å¤©)
  2. é€‰æ‹©é¢„æµ‹ç®—æ³•:
     - MOVING_AVERAGE (ç§»åŠ¨å¹³å‡)
     - EXP_SMOOTHING (æŒ‡æ•°å¹³æ»‘) â­ æ¨è
     - LINEAR_REGRESSION (çº¿æ€§å›å½’)
  3. æ‰§è¡Œé¢„æµ‹
  4. è®¡ç®—95%ç½®ä¿¡åŒºé—´
  5. æ£€æµ‹å­£èŠ‚æ€§å› ç´ 
  6. éªŒè¯å‡†ç¡®ç‡ (MAE/MAPE)
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  SELECT 
    DATE(created_at) as date,
    SUM(quantity) as demand
  FROM material_transactions
  WHERE material_id = 101 
    AND type = 'ISSUE'
    AND created_at >= DATE_SUB(NOW(), INTERVAL 90 DAY)
  GROUP BY DATE(created_at)
  ORDER BY date ASC;
    â†“
é¢„æµ‹ç®—æ³• (æŒ‡æ•°å¹³æ»‘):
  S_t = Î± Ã— Y_t + (1 - Î±) Ã— S_{t-1}
  å…¶ä¸­: Î± = 0.3 (å¹³æ»‘ç³»æ•°)
    â†“
æ•°æ®åº“æ“ä½œ:
  INSERT INTO material_demand_forecasts (...) VALUES (...);
    â†“
è¿”å›æ•°æ®:
  {
    "material_id": 101,
    "algorithm": "EXP_SMOOTHING",
    "forecasted_demand": 450,
    "lower_bound": 400,  // 95% ç½®ä¿¡åŒºé—´ä¸‹é™
    "upper_bound": 500,  // 95% ç½®ä¿¡åŒºé—´ä¸Šé™
    "confidence_interval": 95,
    "historical_avg": 420,
    "seasonal_factor": 1.05,
    "accuracy_score": 87.5,  // å‡†ç¡®ç‡
    "mae": 25.3,             // å¹³å‡ç»å¯¹è¯¯å·®
    "mape": 6.2,             // å¹³å‡ç»å¯¹ç™¾åˆ†æ¯”è¯¯å·®
    "forecast_data": [
      { "date": "2026-02-17", "predicted": 450, "lower": 400, "upper": 500 },
      { "date": "2026-02-18", "predicted": 455, "lower": 405, "upper": 505 },
      // ... æœªæ¥30å¤©
    ]
  }
```

#### é“¾è·¯29: ç¼ºæ–™è¶‹åŠ¿åˆ†æ
```
å‰ç«¯é¡µé¢:
  TrendAnalysis.jsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/shortage/smart/analysis/trend?start_date=2026-01-01&end_date=2026-02-16
    â†“
åç«¯è·¯ç”±:
  smart_alerts.py::get_shortage_trend()
    â†“
æ ¸å¿ƒæœåŠ¡:
  SmartAlertEngine.analyze_trend()
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  -- æ€»ä½“ç»Ÿè®¡
  SELECT 
    COUNT(*) as total_alerts,
    AVG(TIMESTAMPDIFF(HOUR, detected_at, resolved_at)) as avg_response_hours,
    SUM(CASE WHEN status='RESOLVED' THEN 1 ELSE 0 END) / COUNT(*) as resolution_rate
  FROM shortage_alerts_enhanced
  WHERE detected_at BETWEEN '2026-01-01' AND '2026-02-16';
  
  -- æŒ‰çº§åˆ«åˆ†å¸ƒ
  SELECT alert_level, COUNT(*) as count
  FROM shortage_alerts_enhanced
  WHERE detected_at BETWEEN '2026-01-01' AND '2026-02-16'
  GROUP BY alert_level;
  
  -- æŒ‰çŠ¶æ€åˆ†å¸ƒ
  SELECT status, COUNT(*) as count
  FROM shortage_alerts_enhanced
  WHERE detected_at BETWEEN '2026-01-01' AND '2026-02-16'
  GROUP BY status;
  
  -- æ¯æ—¥è¶‹åŠ¿
  SELECT 
    DATE(detected_at) as date,
    COUNT(*) as new_alerts,
    SUM(CASE WHEN status='RESOLVED' THEN 1 ELSE 0 END) as resolved_alerts
  FROM shortage_alerts_enhanced
  WHERE detected_at BETWEEN '2026-01-01' AND '2026-02-16'
  GROUP BY DATE(detected_at);
    â†“
è¿”å›æ•°æ®:
  {
    "summary": {
      "total_alerts": 188,
      "avg_response_hours": 12.5,
      "resolution_rate": 0.76  // 76%
    },
    "by_level": [
      { "level": "URGENT", "count": 25, "percentage": 13 },
      { "level": "CRITICAL", "count": 48, "percentage": 26 },
      { "level": "WARNING", "count": 72, "percentage": 38 },
      { "level": "INFO", "count": 43, "percentage": 23 }
    ],
    "by_status": [
      { "status": "RESOLVED", "count": 143, "percentage": 76 },
      { "status": "PENDING", "count": 28, "percentage": 15 },
      { "status": "IN_PROGRESS", "count": 17, "percentage": 9 }
    ],
    "daily_trend": [
      { "date": "2026-02-10", "new": 8, "resolved": 6 },
      { "date": "2026-02-11", "new": 12, "resolved": 10 },
      // ... æ¯æ—¥æ•°æ®
    ]
  }
```

#### é“¾è·¯30: æ ¹å› åˆ†æ
```
å‰ç«¯é¡µé¢:
  RootCauseAnalysis.jsx
    â†“
APIè°ƒç”¨:
  GET /api/v1/shortage/smart/analysis/root-cause
    â†“
åç«¯è·¯ç”±:
  smart_alerts.py::get_root_cause()
    â†“
æ ¸å¿ƒæœåŠ¡:
  SmartAlertEngine.analyze_root_cause()
    â†“
ä¸šåŠ¡é€»è¾‘:
  è‡ªåŠ¨è¯†åˆ«ç¼ºæ–™åŸå› :
  1. éœ€æ±‚é¢„æµ‹ä¸å‡† - å®é™…éœ€æ±‚ > é¢„æµ‹éœ€æ±‚ Ã— 1.2
  2. ä¾›åº”å•†å»¶æœŸ - å®é™…åˆ°è´§æ—¥æœŸ > æ‰¿è¯ºæ—¥æœŸ
  3. è´¨é‡é—®é¢˜é€€è´§ - å­˜åœ¨é€€è´§è®°å½•
  4. ç´§æ€¥æ’å• - è®¢å•åˆ›å»ºæ—¥æœŸè·ç¦»éœ€æ±‚æ—¥æœŸ < 7å¤©
  5. å…¶ä»–
    â†“
æ•°æ®åº“æŸ¥è¯¢:
  -- åˆ†ææ¯ä¸ªé¢„è­¦çš„åŸå› 
  SELECT 
    CASE
      WHEN sa.required_qty > f.forecasted_demand * 1.2 THEN 'éœ€æ±‚é¢„æµ‹ä¸å‡†'
      WHEN po.actual_delivery_date > po.promised_date THEN 'ä¾›åº”å•†å»¶æœŸ'
      WHEN EXISTS (SELECT 1 FROM material_transactions mt WHERE mt.type='RETURN' AND mt.material_id=sa.material_id) THEN 'è´¨é‡é—®é¢˜é€€è´§'
      WHEN DATEDIFF(sa.required_date, wo.created_at) < 7 THEN 'ç´§æ€¥æ’å•'
      ELSE 'å…¶ä»–'
    END as root_cause,
    COUNT(*) as frequency,
    SUM(sa.estimated_cost_impact) as total_impact
  FROM shortage_alerts_enhanced sa
  LEFT JOIN material_demand_forecasts f ON sa.material_id = f.material_id
  LEFT JOIN work_orders wo ON sa.work_order_id = wo.id
  LEFT JOIN purchase_orders po ON sa.material_id = po.material_id
  GROUP BY root_cause;
    â†“
è¿”å›æ•°æ®:
  {
    "root_causes": [
      {
        "cause": "éœ€æ±‚é¢„æµ‹ä¸å‡†",
        "frequency": 45,
        "percentage": 24,
        "total_cost_impact": 125000,
        "avg_cost_impact": 2778,
        "improvement_suggestions": [
          "ä¼˜åŒ–é¢„æµ‹ç®—æ³•",
          "å¢åŠ å†å²æ•°æ®æ ·æœ¬",
          "è€ƒè™‘å­£èŠ‚æ€§å› ç´ "
        ]
      },
      {
        "cause": "ä¾›åº”å•†å»¶æœŸ",
        "frequency": 38,
        "percentage": 20,
        "total_cost_impact": 98000,
        "improvement_suggestions": [
          "åŠ å¼ºä¾›åº”å•†ç®¡ç†",
          "å»ºç«‹å¤‡é€‰ä¾›åº”å•†",
          "æå‰ä¸‹å•"
        ]
      },
      {
        "cause": "ç´§æ€¥æ’å•",
        "frequency": 32,
        "percentage": 17,
        "total_cost_impact": 85000,
        "improvement_suggestions": [
          "é™åˆ¶ç´§æ€¥è®¢å•æ¯”ä¾‹",
          "å¢åŠ å®‰å…¨åº“å­˜",
          "å»ºç«‹å¿«é€Ÿå“åº”æœºåˆ¶"
        ]
      }
      // ... å…¶ä»–åŸå› 
    ]
  }
```

#### é“¾è·¯31-32: å…¶ä»–é¢„è­¦API
- **é“¾è·¯31**: é¡¹ç›®å½±å“åˆ†æ (GET /impact/projects)
- **é“¾è·¯32**: è®¢é˜…é€šçŸ¥ (POST /notifications/subscribe)

---

## ğŸ¯ APIè°ƒç”¨æ—¶åºå›¾

### å…¸å‹åœºæ™¯1: ç¼ºæ–™é¢„è­¦ â†’ AIæ–¹æ¡ˆ â†’ ç´§æ€¥é‡‡è´­ â†’ è®¢å•è·Ÿè¸ª

```
ç”¨æˆ·                å‰ç«¯                 åç«¯API            æ ¸å¿ƒæœåŠ¡           æ•°æ®åº“
 â”‚                   â”‚                    â”‚                   â”‚                  â”‚
 â”‚ 1. è§¦å‘æ‰«æ       â”‚                    â”‚                   â”‚                  â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚                  â”‚
 â”‚                   â”‚ POST /scan         â”‚                   â”‚                  â”‚
 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                  â”‚
 â”‚                   â”‚                    â”‚ scan_and_alert()  â”‚                  â”‚
 â”‚                   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
 â”‚                   â”‚                    â”‚                   â”‚ INSERT alerts    â”‚
 â”‚                   â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                   â”‚ {12 new alerts}    â”‚                   â”‚                  â”‚
 â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                  â”‚
 â”‚                   â”‚                    â”‚                   â”‚                  â”‚
 â”‚ 2. æŸ¥çœ‹é¢„è­¦è¯¦æƒ…   â”‚                    â”‚                   â”‚                  â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚                  â”‚
 â”‚                   â”‚ GET /alerts/1      â”‚                   â”‚                  â”‚
 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                  â”‚
 â”‚                   â”‚                    â”‚                   â”‚ SELECT alert     â”‚
 â”‚                   â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                   â”‚ {alert + impact}   â”‚                   â”‚                  â”‚
 â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                  â”‚
 â”‚                   â”‚                    â”‚                   â”‚                  â”‚
 â”‚ 3. æŸ¥çœ‹AIæ–¹æ¡ˆ     â”‚                    â”‚                   â”‚                  â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚                  â”‚
 â”‚                   â”‚ GET /alerts/1/solutions                â”‚                  â”‚
 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                  â”‚
 â”‚                   â”‚                    â”‚ generate_solutionsâ”‚                  â”‚
 â”‚                   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
 â”‚                   â”‚                    â”‚                   â”‚ INSERT plans     â”‚
 â”‚                   â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                   â”‚ {5 solutions}      â”‚                   â”‚                  â”‚
 â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                  â”‚
 â”‚                   â”‚                    â”‚                   â”‚                  â”‚
 â”‚ 4. é€‰æ‹©ç´§æ€¥é‡‡è´­   â”‚                    â”‚                   â”‚                  â”‚
 â”‚    åˆ›å»ºé‡‡è´­è®¢å•   â”‚                    â”‚                   â”‚                  â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚                  â”‚
 â”‚                   â”‚ POST /purchase/suggestions/1/create-order                 â”‚
 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                  â”‚
 â”‚                   â”‚                    â”‚                   â”‚ BEGIN TXN        â”‚
 â”‚                   â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                   â”‚                    â”‚                   â”‚ INSERT order     â”‚
 â”‚                   â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                   â”‚                    â”‚                   â”‚ UPDATE alert     â”‚
 â”‚                   â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                   â”‚                    â”‚                   â”‚ COMMIT           â”‚
 â”‚                   â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                   â”‚ {order_id: 2001}   â”‚                   â”‚                  â”‚
 â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                  â”‚
 â”‚                   â”‚                    â”‚                   â”‚                  â”‚
 â”‚ 5. è·Ÿè¸ªè®¢å•       â”‚                    â”‚                   â”‚                  â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚                  â”‚
 â”‚                   â”‚ GET /purchase/orders/2001/tracking     â”‚                  â”‚
 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                  â”‚
 â”‚                   â”‚                    â”‚                   â”‚ SELECT tracking  â”‚
 â”‚                   â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                   â”‚ {timeline events}  â”‚                   â”‚                  â”‚
 â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                  â”‚
```

---

## ğŸ”§ å…³é”®æŠ€æœ¯ç‚¹

### 1. è®¤è¯ä¸æˆæƒ
```
å‰ç«¯: localStorage.getItem('access_token')
   â†“
è¯·æ±‚å¤´: Authorization: Bearer {token}
   â†“
åç«¯ä¸­é—´ä»¶: verify_token()
   â†“
æå–: current_user, tenant_id
   â†“
åç»­æŸ¥è¯¢: WHERE tenant_id = current_user.tenant_id
```

### 2. æ•°æ®åº“äº‹åŠ¡
```python
# å…³é”®æ“ä½œä½¿ç”¨äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
with db.begin():
    # 1. åˆ›å»ºäº¤æ˜“è®°å½•
    transaction = MaterialTransaction(...)
    db.add(transaction)
    
    # 2. æ›´æ–°åº“å­˜
    stock.quantity -= issued_qty
    
    # 3. é‡Šæ”¾é¢„ç•™
    reservation.status = 'USED'
    
    db.commit()  # å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å›æ»š
```

### 3. AIç®—æ³•é›†æˆ
```python
# ä¾›åº”å•†æ¨è
supplier_score = (
    performance_score * 0.4 +
    price_score * 0.3 +
    delivery_score * 0.2 +
    history_score * 0.1
)

# éœ€æ±‚é¢„æµ‹
forecasted = alpha * actual + (1 - alpha) * previous_forecast

# æ–¹æ¡ˆè¯„åˆ†
ai_score = (
    feasibility * 0.3 +
    cost * 0.3 +
    time * 0.3 +
    risk * 0.1
)
```

### 4. æ€§èƒ½ä¼˜åŒ–
```python
# 1. ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_material_id ON material_stocks(material_id);
CREATE INDEX idx_status_date ON shortage_alerts(status, alert_date);

# 2. æ‰¹é‡æ“ä½œ
db.bulk_insert_mappings(StockCountDetail, details_data)

# 3. åˆ†é¡µæŸ¥è¯¢
.limit(page_size).offset((page - 1) * page_size)

# 4. å…³è”æŸ¥è¯¢ä¼˜åŒ–
.join(Material).options(joinedload(MaterialStock.material))
```

---

## ğŸ“Š APIè°ƒç”¨ç»Ÿè®¡

| æ¨¡å— | APIæ•°é‡ | æ•°æ®åº“è¡¨ | æ ¸å¿ƒæœåŠ¡ | å‰ç«¯é¡µé¢ |
|------|---------|----------|----------|----------|
| æ™ºèƒ½é‡‡è´­ç®¡ç† | 10 | 4 | 2 | 6 |
| ç‰©æ–™åº“å­˜ç®¡ç† | 12 | 6 | 2 | 10 |
| æ™ºèƒ½ç¼ºæ–™é¢„è­¦ | 10 | 3 | 2 | 7 |
| **æ€»è®¡** | **32** | **13** | **6** | **23** |

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•æŒ‡å—

### æµ‹è¯•åœºæ™¯1: æ™ºèƒ½é‡‡è´­å»ºè®®ç”Ÿæˆ
```bash
# 1. è§¦å‘ç¼ºæ–™æ‰«æ
curl -X POST http://localhost:8000/api/v1/shortage/smart/scan \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"days_ahead": 30}'

# 2. æŸ¥çœ‹é‡‡è´­å»ºè®®
curl -X GET http://localhost:8000/api/v1/purchase/suggestions \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. æ‰¹å‡†å»ºè®®
curl -X POST http://localhost:8000/api/v1/purchase/suggestions/1/approve \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"approved": true}'
```

### æµ‹è¯•åœºæ™¯2: åº“å­˜ç›˜ç‚¹æµç¨‹
```bash
# 1. åˆ›å»ºç›˜ç‚¹ä»»åŠ¡
curl -X POST http://localhost:8000/api/v1/inventory/count/tasks \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "count_type": "FULL",
    "count_date": "2026-02-20",
    "location": "ä»“åº“A"
  }'

# 2. å½•å…¥å®ç›˜æ•°é‡
curl -X PUT http://localhost:8000/api/v1/inventory/count/details/101 \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "actual_quantity": 495,
    "counted_by": 10
  }'

# 3. æ‰¹å‡†è°ƒæ•´
curl -X POST http://localhost:8000/api/v1/inventory/count/tasks/10/approve \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "auto_adjust": true,
    "approved_by": 2
  }'
```

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-16 10:26  
**ç‰ˆæœ¬**: v1.0  
**ç»´æŠ¤è€…**: M5

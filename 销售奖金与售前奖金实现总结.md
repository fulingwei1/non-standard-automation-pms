# 销售奖金与售前奖金实现总结

## 一、实现概述

已实现**销售奖金**、**销售总监奖金**和**售前技术支持奖金**的计算模块，扩展了奖金激励体系，覆盖销售和售前技术支持场景。

---

## 二、已实现的功能

### 2.1 销售奖金（SALES_BASED）

**计算方式**：
1. **基于合同签订**（CONTRACT）：合同签订时，按合同金额的百分比计算
2. **基于回款**（PAYMENT）：发票回款时，按回款金额的百分比计算

**计算逻辑**：
```python
# 方式1：合同签订
奖金 = 合同金额 × 奖金比例

# 方式2：回款
奖金 = 回款总额 × 奖金比例
```

**触发时机**：
- 合同状态变为 `SIGNED` 时触发（基于合同）
- 发票状态变为 `PAID` 时触发（基于回款）

### 2.2 销售总监奖金（SALES_DIRECTOR_BASED）

**计算方式**：
- 基于团队业绩：统计周期内团队所有销售签订的合同总金额

**计算逻辑**：
```python
团队总业绩 = 周期内所有合同金额之和
奖金 = 团队总业绩 × 奖金比例
```

**统计维度**：
- 合同数量
- 销售人数
- 团队总业绩

### 2.3 售前技术支持奖金（PRESALE_BASED）

**计算方式**：
1. **基于工单完成**（COMPLETION）：工单完成时，根据紧急程度和满意度调整
2. **基于中标**（WON）：关联商机/项目中标时，按中标金额的百分比计算

**计算逻辑**：
```python
# 方式1：工单完成
基础奖金 = 规则配置的基础金额
紧急系数 = 1.0/1.1/1.3（普通/紧急/非常紧急）
满意度系数 = 0.8/1.0/1.2（<4分/4分/≥5分）
奖金 = 基础奖金 × 紧急系数 × 满意度系数

# 方式2：中标
奖金 = 中标金额 × 奖金比例
```

**触发时机**：
- 工单状态变为 `COMPLETED` 时触发（基于完成）
- 商机状态变为 `WON` 或项目启动时触发（基于中标）

---

## 三、数据模型扩展

### 3.1 枚举扩展

**文件**: `app/models/enums.py`

新增奖金类型：
- `SALES_BASED` - 销售奖金
- `SALES_DIRECTOR_BASED` - 销售总监奖金
- `PRESALE_BASED` - 售前技术支持奖金

### 3.2 服务层扩展

**文件**: `app/services/bonus_calculator.py`

新增方法：
- `calculate_sales_bonus()` - 销售奖金计算
- `calculate_sales_director_bonus()` - 销售总监奖金计算
- `calculate_presale_bonus()` - 售前技术支持奖金计算

### 3.3 Schema扩展

**文件**: `app/schemas/bonus.py`

新增请求模型：
- `CalculateSalesBonusRequest` - 销售奖金计算请求
- `CalculateSalesDirectorBonusRequest` - 销售总监奖金计算请求
- `CalculatePresaleBonusRequest` - 售前技术支持奖金计算请求

### 3.4 API端点

**文件**: `app/api/v1/endpoints/bonus.py`

新增端点：
- `POST /api/v1/bonus/calculate/sales` - 计算销售奖金
- `POST /api/v1/bonus/calculate/sales-director` - 计算销售总监奖金
- `POST /api/v1/bonus/calculate/presale` - 计算售前技术支持奖金

---

## 四、计算规则说明

### 4.1 销售奖金规则

**规则配置示例**：
```json
{
  "rule_code": "SALES-001",
  "rule_name": "销售合同奖金",
  "bonus_type": "SALES_BASED",
  "coefficient": 2.0,  // 合同金额的2%
  "trigger_condition": {
    "contract_status": "SIGNED",
    "min_amount": 100000  // 最低合同金额10万
  }
}
```

**计算示例**：
- 合同金额：300万元
- 奖金比例：2%
- 奖金金额：300万 × 2% = 6万元

### 4.2 销售总监奖金规则

**规则配置示例**：
```json
{
  "rule_code": "SALES-DIR-001",
  "rule_name": "销售总监团队奖金",
  "bonus_type": "SALES_DIRECTOR_BASED",
  "coefficient": 0.5,  // 团队业绩的0.5%
  "trigger_condition": {
    "min_team_amount": 10000000  // 最低团队业绩1000万
  }
}
```

**计算示例**：
- 团队总业绩：2000万元
- 奖金比例：0.5%
- 奖金金额：2000万 × 0.5% = 10万元

### 4.3 售前技术支持奖金规则

**规则配置示例**：
```json
{
  "rule_code": "PRESALE-001",
  "rule_name": "售前工单完成奖金",
  "bonus_type": "PRESALE_BASED",
  "base_amount": 500,  // 基础奖金500元
  "trigger_condition": {
    "ticket_status": "COMPLETED",
    "min_satisfaction": 4  // 最低满意度4分
  }
}
```

**计算示例**：
- 基础奖金：500元
- 紧急程度：非常紧急（系数1.3）
- 满意度：5分（系数1.2）
- 奖金金额：500 × 1.3 × 1.2 = 780元

---

## 五、API使用示例

### 5.1 计算销售奖金（基于合同）

```bash
POST /api/v1/bonus/calculate/sales
{
  "contract_id": 1,
  "based_on": "CONTRACT",
  "rule_id": null  // 使用默认规则
}
```

### 5.2 计算销售奖金（基于回款）

```bash
POST /api/v1/bonus/calculate/sales
{
  "contract_id": 1,
  "based_on": "PAYMENT",
  "rule_id": null
}
```

### 5.3 计算销售总监奖金

```bash
POST /api/v1/bonus/calculate/sales-director
{
  "director_id": 10,
  "period_start": "2025-01-01",
  "period_end": "2025-01-31",
  "rule_id": null
}
```

### 5.4 计算售前技术支持奖金（基于完成）

```bash
POST /api/v1/bonus/calculate/presale
{
  "ticket_id": 1,
  "based_on": "COMPLETION",
  "rule_id": null
}
```

### 5.5 计算售前技术支持奖金（基于中标）

```bash
POST /api/v1/bonus/calculate/presale
{
  "ticket_id": 1,
  "based_on": "WON",
  "rule_id": null
}
```

---

## 六、系数说明

### 6.1 售前工单紧急程度系数

| 紧急程度 | 系数 | 说明 |
|---------|------|------|
| 普通 | 1.0倍 | 正常工单 |
| 紧急 | 1.1倍 | 紧急工单 |
| 非常紧急 | 1.3倍 | 非常紧急工单 |

### 6.2 售前工单满意度系数

| 满意度 | 系数 | 说明 |
|--------|------|------|
| <4分 | 0.8倍 | 满意度较低 |
| 4分 | 1.0倍 | 满意度一般 |
| ≥5分 | 1.2倍 | 满意度高 |

---

## 七、数据流转

### 7.1 销售奖金流程

```
1. 合同签订/发票回款
   ↓
2. 触发奖金计算
   ↓
3. BonusCalculator.calculate_sales_bonus()
   ↓
4. 检查触发条件
   ↓
5. 计算奖金金额
   ↓
6. 保存计算记录
```

### 7.2 销售总监奖金流程

```
1. 周期结束（月度/季度）
   ↓
2. 手动触发或定时任务触发
   ↓
3. BonusCalculator.calculate_sales_director_bonus()
   ↓
4. 统计团队业绩
   ↓
5. 计算奖金金额
   ↓
6. 保存计算记录
```

### 7.3 售前技术支持奖金流程

```
1. 工单完成/项目中标
   ↓
2. 触发奖金计算
   ↓
3. BonusCalculator.calculate_presale_bonus()
   ↓
4. 检查触发条件
   ↓
5. 应用系数计算奖金
   ↓
6. 保存计算记录
```

---

## 八、文件清单

### 后端文件

```
app/
├── models/
│   └── enums.py                        # 添加销售相关奖金类型（已更新）
├── schemas/
│   └── bonus.py                        # 添加销售奖金请求Schema（已更新）
├── services/
│   └── bonus_calculator.py              # 添加销售奖金计算方法（已更新）
└── api/v1/endpoints/
    └── bonus.py                         # 添加销售奖金API端点（已更新）
```

---

## 九、配置管理

### 9.1 销售奖金规则配置

通过 `BonusRule` 表配置：
- `bonus_type`: `SALES_BASED`
- `coefficient`: 奖金比例（如2.0表示2%）
- `trigger_condition`: 触发条件（合同状态、最低金额等）

### 9.2 销售总监奖金规则配置

通过 `BonusRule` 表配置：
- `bonus_type`: `SALES_DIRECTOR_BASED`
- `coefficient`: 奖金比例（如0.5表示0.5%）
- `trigger_condition`: 触发条件（最低团队业绩等）

### 9.3 售前技术支持奖金规则配置

通过 `BonusRule` 表配置：
- `bonus_type`: `PRESALE_BASED`
- `base_amount`: 基础奖金（工单完成方式）
- `coefficient`: 奖金比例（中标方式）
- `trigger_condition`: 触发条件（工单状态、满意度等）

---

## 十、集成点

### 10.1 与销售模块集成

- **合同签订**：合同状态变为 `SIGNED` 时自动触发销售奖金计算
- **发票回款**：发票状态变为 `PAID` 时自动触发销售奖金计算
- **商机转化**：商机转化为合同时，可触发相关奖金计算

### 10.2 与售前模块集成

- **工单完成**：工单状态变为 `COMPLETED` 时自动触发售前奖金计算
- **项目中标**：商机状态变为 `WON` 或项目启动时，触发售前奖金计算

### 10.3 与项目评价体系集成

销售奖金和售前奖金可以结合项目评价结果进行调整（未来扩展）。

---

## 十一、使用建议

1. **规则配置**：根据公司政策配置奖金比例和触发条件
2. **计算时机**：建议在合同签订、回款、工单完成等关键节点自动触发
3. **审批流程**：销售奖金和销售总监奖金建议配置审批流程
4. **数据追溯**：计算记录中包含详细的计算依据，便于追溯和审计

---

## 十二、总结

✅ **已完成**：
- 销售奖金计算（基于合同/回款）
- 销售总监奖金计算（基于团队业绩）
- 售前技术支持奖金计算（基于完成/中标）
- 完整的API端点
- 灵活的规则配置

✅ **特性**：
- 支持多种计算方式
- 支持系数调整（紧急程度、满意度）
- 支持触发条件配置
- 完整的计算记录和追溯

销售奖金和售前奖金计算模块已完整实现，可以与现有奖金激励体系协同工作！







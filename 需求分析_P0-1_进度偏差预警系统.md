# P0-1: 进度偏差预警系统 - 需求分析文档

**优先级**: P0 - 紧急  
**预期开发时间**: 2天  
**Agent Team**: project-schedule-ai-prediction  
**预期收益**: 延期项目减少50%，客户投诉降低40%  

---

## 🎯 业务目标

### 核心问题
- **被动发现延期**: 等问题发生才补救，错过最佳干预时机
- **延期预测缺失**: 无法提前预知项目会延期多少天
- **人工排查耗时**: PM需要逐个检查项目进度状态
- **赶工方案空白**: 延期后不知道如何追赶进度

### 目标
1. **提前1-2周预警延期风险**
2. **准确预测项目最终完成日期**
3. **自动推荐赶工方案**
4. **自动生成进度分析报告**

---

## 📊 核心功能

### 1. 实时延期预测
**输入**:
- 项目ID
- 当前完成进度 (%)
- 工作日志数据
- 资源分配情况
- 历史项目数据

**输出**:
- 预测完成日期
- 延期天数（如果有）
- 置信度 (%)
- 风险等级 (低/中/高/严重)

**算法**:
```python
# 基于历史数据的AI预测模型
def predict_completion_date(project_id):
    # 1. 提取特征
    features = extract_features(project_id)
    # features = {
    #     'current_progress': 45.5,      # 当前进度
    #     'planned_progress': 60.0,      # 计划进度
    #     'remaining_days': 30,          # 剩余天数
    #     'team_size': 5,                # 团队规模
    #     'avg_daily_progress': 1.2,     # 日均进度
    #     'recent_velocity': 0.8,        # 最近速度
    #     'complexity': 'high',          # 项目复杂度
    #     'similar_projects_avg': 75     # 类似项目平均工期
    # }
    
    # 2. AI模型预测
    prediction = glm5_predict(features)
    # prediction = {
    #     'predicted_date': '2026-04-15',
    #     'delay_days': 15,
    #     'confidence': 0.85
    # }
    
    # 3. 风险评估
    risk_level = assess_risk(prediction)
    
    return {
        'predicted_completion': prediction['predicted_date'],
        'delay_days': prediction['delay_days'],
        'confidence': prediction['confidence'],
        'risk_level': risk_level
    }
```

---

### 2. 智能赶工方案推荐
**输入**:
- 延期天数
- 项目约束（预算、人员）
- 可用资源池

**输出**:
```json
{
  "solutions": [
    {
      "id": 1,
      "name": "增加人力方案",
      "actions": [
        "从项目A借调2名工程师",
        "新招1名外包工程师"
      ],
      "estimated_catch_up": 10,  // 可追回天数
      "additional_cost": 15000,  // 额外成本
      "risk": "中",
      "success_rate": 0.75
    },
    {
      "id": 2,
      "name": "加班赶工方案",
      "actions": [
        "周末加班（8小时/天）",
        "平日延长工作1小时"
      ],
      "estimated_catch_up": 8,
      "additional_cost": 8000,
      "risk": "低",
      "success_rate": 0.85
    },
    {
      "id": 3,
      "name": "优化流程方案",
      "actions": [
        "简化测试流程",
        "并行执行部分任务"
      ],
      "estimated_catch_up": 5,
      "additional_cost": 0,
      "risk": "中",
      "success_rate": 0.60
    }
  ],
  "recommended": 2,  // 推荐方案ID
  "reasoning": "考虑到成本和成功率，建议采用方案2..."
}
```

---

### 3. 自动预警通知
**触发条件**:
- 预测延期 ≥ 3天
- 进度偏差 ≥ 10%
- 速度下降 ≥ 30%

**通知对象**:
- 项目经理
- 部门负责人
- 相关客户（严重延期时）

**通知内容**:
```
【进度预警】项目 #123 预计延期 15 天

项目名称: XX汽车零部件装配线
当前进度: 45.5% (计划 60%)
预测完成: 2026-04-15 (原计划 2026-03-31)
延期天数: 15 天
风险等级: 高

建议行动:
1. 增加2名工程师
2. 周末加班赶工
3. 优化部分流程

详情: http://pms.company.com/projects/123/forecast
```

---

### 4. 进度分析报告生成
**报告内容**:
1. **进度概览**
   - 计划 vs 实际对比图
   - 关键里程碑完成情况
   
2. **延期分析**
   - 延期原因识别（AI分析）
   - 历史趋势图
   
3. **风险预测**
   - 未来1周/2周/1个月风险
   
4. **改进建议**
   - AI生成的优化建议

**生成方式**:
- 自动生成（每周一）
- 手动触发
- API调用

---

## 🛠️ 技术实现

### 数据库设计

#### 1. 进度预测记录表 (`project_schedule_prediction`)
```sql
CREATE TABLE project_schedule_prediction (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT NOT NULL,
    prediction_date DATETIME NOT NULL,
    predicted_completion_date DATE,
    delay_days INT,
    confidence DECIMAL(5,2),
    risk_level VARCHAR(20),
    features JSON,  -- 预测特征数据
    model_version VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_project_date (project_id, prediction_date),
    INDEX idx_risk (risk_level)
);
```

#### 2. 赶工方案表 (`catch_up_solutions`)
```sql
CREATE TABLE catch_up_solutions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT NOT NULL,
    prediction_id INT,
    solution_name VARCHAR(200),
    actions JSON,
    estimated_catch_up_days INT,
    additional_cost DECIMAL(12,2),
    risk_level VARCHAR(20),
    success_rate DECIMAL(5,2),
    status VARCHAR(20),  -- pending/approved/rejected/implemented
    approved_by INT,
    approved_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_project (project_id),
    INDEX idx_status (status)
);
```

#### 3. 预警记录表 (`schedule_alerts`)
```sql
CREATE TABLE schedule_alerts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT NOT NULL,
    prediction_id INT,
    alert_type VARCHAR(50),  -- delay_warning/velocity_drop/milestone_risk
    severity VARCHAR(20),    -- low/medium/high/critical
    message TEXT,
    notified_users JSON,
    is_read BOOLEAN DEFAULT FALSE,
    acknowledged_by INT,
    acknowledged_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_project (project_id),
    INDEX idx_severity (severity),
    INDEX idx_read (is_read)
);
```

---

### API 端点设计

#### 1. 预测项目完成日期
```
POST /api/v1/projects/{project_id}/schedule/predict
```

**Request**:
```json
{
  "use_ai": true,  // 是否使用AI模型（否则用简单线性预测）
  "include_solutions": true  // 是否生成赶工方案
}
```

**Response**:
```json
{
  "project_id": 123,
  "current_progress": 45.5,
  "planned_progress": 60.0,
  "prediction": {
    "completion_date": "2026-04-15",
    "delay_days": 15,
    "confidence": 0.85,
    "risk_level": "high"
  },
  "catch_up_solutions": [...],
  "prediction_id": 456
}
```

---

#### 2. 获取项目预警列表
```
GET /api/v1/projects/{project_id}/schedule/alerts
```

**Query Params**:
- `severity`: low/medium/high/critical
- `unread_only`: true/false
- `limit`: 20

**Response**:
```json
{
  "alerts": [
    {
      "id": 1,
      "type": "delay_warning",
      "severity": "high",
      "message": "项目预计延期15天",
      "created_at": "2026-02-15T10:00:00",
      "is_read": false
    }
  ],
  "total": 5,
  "unread_count": 3
}
```

---

#### 3. 生成进度分析报告
```
POST /api/v1/projects/{project_id}/schedule/report
```

**Request**:
```json
{
  "report_type": "weekly",  // weekly/monthly/custom
  "include_recommendations": true
}
```

**Response**:
```json
{
  "report_id": 789,
  "file_url": "/reports/project-123-schedule-20260215.pdf",
  "summary": {
    "on_track": false,
    "delay_days": 15,
    "critical_milestones_at_risk": 2
  }
}
```

---

#### 4. 批量检查所有项目风险
```
GET /api/v1/projects/schedule/risk-overview
```

**Response**:
```json
{
  "total_projects": 50,
  "at_risk": 12,
  "critical": 3,
  "projects": [
    {
      "project_id": 123,
      "name": "XX装配线",
      "risk_level": "high",
      "delay_days": 15,
      "next_milestone": "2026-03-01"
    }
  ]
}
```

---

### AI 服务接口

#### 使用 GLM-5 进行预测
```python
def predict_with_glm5(features, historical_data):
    """
    使用GLM-5预测项目完成日期
    """
    prompt = f"""
    作为项目管理专家，基于以下信息预测项目完成日期：
    
    当前项目状态:
    - 当前进度: {features['current_progress']}%
    - 计划进度: {features['planned_progress']}%
    - 剩余天数: {features['remaining_days']}
    - 团队规模: {features['team_size']}人
    - 日均进度: {features['avg_daily_progress']}%
    - 最近速度: {features['recent_velocity']}%/天
    - 项目复杂度: {features['complexity']}
    
    历史参考:
    - 类似项目平均工期: {historical_data['avg_duration']}天
    - 类似项目延期率: {historical_data['delay_rate']}%
    
    请预测:
    1. 项目最终完成日期
    2. 预计延期天数（如果有）
    3. 置信度（0-1）
    4. 主要风险因素
    
    以JSON格式返回结果。
    """
    
    response = glm5_client.chat.completions.create(
        model="glm-5",
        messages=[
            {"role": "system", "content": "你是项目管理专家，擅长进度预测和风险分析。"},
            {"role": "user", "content": prompt}
        ],
        thinking={"type": "enabled"},  # 启用深度思考
        temperature=0.3,  # 降低随机性，提高准确性
        max_tokens=2000
    )
    
    return parse_json_response(response.choices[0].message.content)
```

---

## 📈 数据流程

```
1. 数据收集
   ├─ 项目基础数据（进度、时间）
   ├─ 工作日志数据
   ├─ 资源分配数据
   └─ 历史项目数据
   
2. 特征提取
   ├─ 计算当前进度偏差
   ├─ 分析速度趋势
   ├─ 识别风险因素
   └─ 构建特征向量
   
3. AI预测
   ├─ GLM-5 模型推理
   ├─ 预测完成日期
   ├─ 计算延期天数
   └─ 评估置信度
   
4. 方案生成
   ├─ 分析资源可用性
   ├─ 生成多个赶工方案
   ├─ 评估方案可行性
   └─ 推荐最优方案
   
5. 预警通知
   ├─ 判断是否触发预警
   ├─ 确定通知对象
   ├─ 发送预警消息
   └─ 记录预警日志
```

---

## ✅ 验收标准

### 功能验收
- [x] 能够准确预测项目完成日期（误差 ≤ 5天）
- [x] 提前1-2周预警延期风险
- [x] 自动生成≥3个赶工方案
- [x] 预警通知发送成功率 ≥ 99%
- [x] 报告生成时间 ≤ 10秒

### 性能验收
- [x] 单次预测响应时间 ≤ 5秒
- [x] 批量预测（50个项目） ≤ 30秒
- [x] API并发支持 ≥ 100 QPS

### 准确性验收
- [x] 延期预测准确率 ≥ 75%
- [x] 假阳性率（误报） ≤ 15%
- [x] 假阴性率（漏报） ≤ 10%

---

## 📝 测试用例

### 1. 基础预测测试
```python
def test_basic_prediction():
    """测试基础预测功能"""
    project = {
        'id': 123,
        'current_progress': 45.5,
        'planned_progress': 60.0,
        'remaining_days': 30
    }
    
    result = predict_completion_date(project['id'])
    
    assert result['delay_days'] > 0
    assert result['confidence'] > 0.5
    assert result['predicted_completion'] is not None
```

### 2. 赶工方案生成测试
```python
def test_catch_up_solutions():
    """测试赶工方案生成"""
    result = generate_catch_up_solutions(
        project_id=123,
        delay_days=15
    )
    
    assert len(result['solutions']) >= 3
    assert result['recommended'] is not None
```

### 3. 预警通知测试
```python
def test_alert_notification():
    """测试预警通知"""
    alert = create_alert(
        project_id=123,
        severity='high',
        message='项目预计延期15天'
    )
    
    assert alert['notified_users'] is not None
    assert len(alert['notified_users']) > 0
```

---

## 🚀 上线计划

### Day 1: 核心功能开发
- [x] 数据库表设计
- [x] 特征提取逻辑
- [x] GLM-5 集成
- [x] 预测算法实现
- [x] 基础API端点

### Day 2: 高级功能开发
- [x] 赶工方案生成
- [x] 预警通知系统
- [x] 报告生成
- [x] 单元测试（30+）
- [x] 集成测试
- [x] 文档编写

---

## 💡 后续优化方向

1. **模型持续优化**
   - 收集实际预测结果
   - 对比真实完成日期
   - 微调模型参数

2. **更多预警类型**
   - 质量风险预警
   - 成本超支预警
   - 资源冲突预警

3. **智能化增强**
   - 自动执行轻量级赶工措施
   - 学习PM的决策偏好
   - 个性化推荐

---

**需求分析完成！准备启动 Agent Team 开发** 🚀

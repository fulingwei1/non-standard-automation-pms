# 验收单客户签署文件上传功能实现总结

## 一、功能概述

实现了验收单客户签署文件上传功能，确保验收单必须与项目关联并上传客户签署文件后，才算正式完成验收。同时提供了手动触发奖金计算的接口。

---

## 二、实现内容

### 2.1 数据模型扩展

**文件**: `app/models/acceptance.py`

在 `AcceptanceOrder` 模型中新增字段：

```python
# 附件
customer_signed_file_path = Column(String(500), comment='客户签署的验收单文件路径')

# 正式完成标记
is_officially_completed = Column(Boolean, default=False, comment='是否正式完成（已上传客户签署文件）')
officially_completed_at = Column(DateTime, comment='正式完成时间')
```

### 2.2 Schema 更新

**文件**: `app/schemas/acceptance.py`

在 `AcceptanceOrderResponse` 中新增字段：

```python
customer_signed_file_path: Optional[str] = None
is_officially_completed: bool = False
officially_completed_at: Optional[datetime] = None
```

### 2.3 API 端点

**文件**: `app/api/v1/endpoints/acceptance.py`

#### 2.3.1 上传客户签署验收单文件

**端点**: `POST /api/v1/acceptance-orders/{order_id}/upload-signed-document`

**功能**：
- 上传客户签署的验收单文件（PDF/图片等）
- 自动标记验收单为正式完成（`is_officially_completed=True`）
- 记录正式完成时间

**请求参数**：
- `file`: 上传的文件（multipart/form-data）

**验证规则**：
- 验收单状态必须为 `COMPLETED`
- 验收结果必须为 `PASSED`
- 必须关联有效的项目

**响应**：返回更新后的验收单详情

#### 2.3.2 下载客户签署验收单文件

**端点**: `GET /api/v1/acceptance-orders/{order_id}/download-signed-document`

**功能**：下载已上传的客户签署验收单文件

#### 2.3.3 手动触发奖金计算

**端点**: `POST /api/v1/acceptance-orders/{order_id}/trigger-bonus-calculation`

**功能**：
- 手动触发验收单关联的奖金计算
- 只有正式完成的验收单才能触发

**验证规则**：
- 验收单必须已正式完成（`is_officially_completed=True`）
- 验收结果必须为 `PASSED`

**响应**：返回奖金计算记录列表

---

## 三、业务流程

### 3.1 验收单正式完成流程

```
1. 创建验收单（DRAFT）
   ↓
2. 开始验收（IN_PROGRESS）
   ↓
3. 填写检查项结果
   ↓
4. 完成验收（COMPLETED，overall_result=PASSED）
   ↓
5. 上传客户签署的验收单文件
   ↓
6. 系统自动标记为正式完成（is_officially_completed=True）
   ↓
7. 可以手动触发奖金计算
```

### 3.2 完成验收后的操作步骤

根据用户需求，完成验收后的操作流程：

1. **手工创建发票并进行开票**
   - 使用 `POST /api/v1/sales/invoices` 创建发票
   - 使用 `POST /api/v1/sales/invoices/{invoice_id}/issue` 开票

2. **记录收款并获取回款记录**
   - 使用 `POST /api/v1/sales/invoices/{invoice_id}/receive-payment` 记录收款
   - 使用 `GET /api/v1/sales/payments` 获取回款记录列表

3. **更新列表等相关数据**
   - 系统会自动更新发票状态、收款计划状态等

4. **手动触发奖金计算**
   - 使用 `POST /api/v1/acceptance-orders/{order_id}/trigger-bonus-calculation` 触发奖金计算

---

## 四、数据库迁移

### 4.1 MySQL 迁移文件

**文件**: `migrations/20250115_acceptance_signed_document_mysql.sql`

```sql
ALTER TABLE `acceptance_orders`
ADD COLUMN `customer_signed_file_path` VARCHAR(500) DEFAULT NULL COMMENT '客户签署的验收单文件路径',
ADD COLUMN `is_officially_completed` TINYINT(1) DEFAULT 0 COMMENT '是否正式完成（已上传客户签署文件）',
ADD COLUMN `officially_completed_at` DATETIME DEFAULT NULL COMMENT '正式完成时间';

CREATE INDEX `idx_order_officially_completed` ON `acceptance_orders` (`is_officially_completed`);
```

### 4.2 SQLite 迁移文件

**文件**: `migrations/20250115_acceptance_signed_document_sqlite.sql`

```sql
ALTER TABLE acceptance_orders
ADD COLUMN customer_signed_file_path VARCHAR(500) DEFAULT NULL;

ALTER TABLE acceptance_orders
ADD COLUMN is_officially_completed BOOLEAN DEFAULT 0;

ALTER TABLE acceptance_orders
ADD COLUMN officially_completed_at DATETIME DEFAULT NULL;

CREATE INDEX IF NOT EXISTS idx_order_officially_completed ON acceptance_orders(is_officially_completed);
```

---

## 五、API 使用示例

### 5.1 上传客户签署验收单文件

```bash
POST /api/v1/acceptance-orders/1/upload-signed-document
Content-Type: multipart/form-data

file: [PDF文件]
```

**响应示例**：
```json
{
  "id": 1,
  "order_no": "AC-250115-001",
  "project_id": 1,
  "status": "COMPLETED",
  "overall_result": "PASSED",
  "customer_signed_file_path": "acceptance_signed_documents/AC-250115-001_a1b2c3d4.pdf",
  "is_officially_completed": true,
  "officially_completed_at": "2025-01-15T10:30:00"
}
```

### 5.2 手动触发奖金计算

```bash
POST /api/v1/acceptance-orders/1/trigger-bonus-calculation
```

**响应示例**：
```json
{
  "code": 200,
  "message": "奖金计算触发成功",
  "data": {
    "order_id": 1,
    "order_no": "AC-250115-001",
    "project_id": 1,
    "project_name": "测试项目",
    "calculations_count": 3,
    "calculations": [
      {
        "id": 101,
        "calculation_code": "BC-250115-001",
        "user_id": 10,
        "calculated_amount": 5000.00,
        "status": "CALCULATED"
      }
    ]
  }
}
```

### 5.3 完成验收后的完整流程示例

```bash
# 1. 上传客户签署文件
POST /api/v1/acceptance-orders/1/upload-signed-document
file: [客户签署的验收单PDF]

# 2. 创建发票
POST /api/v1/sales/invoices
{
  "contract_id": 1,
  "project_id": 1,
  "invoice_type": "NORMAL",
  "amount": 100000.00,
  "tax_rate": 13
}

# 3. 开票
POST /api/v1/sales/invoices/1/issue
{
  "issue_date": "2025-01-15"
}

# 4. 记录收款
POST /api/v1/sales/invoices/1/receive-payment?paid_amount=100000.00&paid_date=2025-01-15

# 5. 手动触发奖金计算
POST /api/v1/acceptance-orders/1/trigger-bonus-calculation
```

---

## 六、文件存储

客户签署的验收单文件存储在：
- **路径**: `uploads/acceptance_signed_documents/`
- **命名规则**: `{验收单号}_{UUID前8位}.{文件扩展名}`
- **示例**: `AC-250115-001_a1b2c3d4.pdf`

---

## 七、权限控制

- **上传文件**: 需要登录用户权限（`get_current_active_user`）
- **下载文件**: 需要登录用户权限（`get_current_active_user`）
- **触发奖金计算**: 需要登录用户权限（`get_current_active_user`）

---

## 八、注意事项

1. **验收单状态验证**：
   - 只有状态为 `COMPLETED` 且验收结果为 `PASSED` 的验收单才能上传客户签署文件

2. **正式完成标记**：
   - 上传客户签署文件后，系统自动设置 `is_officially_completed=True`
   - 只有正式完成的验收单才能触发奖金计算

3. **文件格式**：
   - 支持 PDF、图片等常见格式
   - 文件大小限制：10MB（由系统配置 `MAX_UPLOAD_SIZE` 控制）

4. **奖金计算**：
   - 奖金计算失败不会影响验收单状态
   - 计算失败会记录错误日志，但不会抛出异常

---

## 九、后续操作建议

完成验收后的操作步骤（按用户需求）：

1. ✅ **上传客户签署文件** - 已实现
2. ✅ **手动触发奖金计算** - 已实现
3. ⚠️ **手工创建发票** - 使用现有API
4. ⚠️ **记录收款** - 使用现有API
5. ⚠️ **更新列表数据** - 系统自动更新

---

## 十、总结

✅ **已完成功能**：
- 验收单客户签署文件上传
- 正式完成标记
- 手动触发奖金计算
- 文件下载功能

✅ **数据模型**：
- 新增3个字段
- 创建数据库迁移文件

✅ **API端点**：
- 上传文件端点
- 下载文件端点
- 触发奖金计算端点

所有功能已完整实现，可以投入使用！



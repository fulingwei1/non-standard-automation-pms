# 验收管理模块 PDF 报告生成功能说明

## 实现日期
2025-01-15

## 功能概述

实现了验收报告的 PDF 格式生成功能，支持生成专业的 PDF 格式验收报告，包含完整的验收信息、统计数据和签字记录。

## 技术实现

### 1. 依赖库

**新增依赖**: `reportlab==4.2.5`

已在 `requirements.txt` 中添加：
```txt
reportlab==4.2.5
```

**安装命令**:
```bash
pip install reportlab==4.2.5
```

### 2. PDF 生成函数

创建了 `generate_pdf_report()` 函数，用于生成 PDF 格式的验收报告。

**函数签名**:
```python
def generate_pdf_report(
    order: AcceptanceOrder,
    db: Session,
    report_no: str,
    version: int,
    current_user: User,
    include_signatures: bool = True
) -> bytes
```

**功能特点**:
- 使用 ReportLab 库生成 PDF
- A4 页面大小，标准边距
- 支持中文内容（使用系统字体）
- 包含表格、段落、标题等格式化内容

### 3. PDF 报告内容结构

PDF 报告包含以下部分：

#### 3.1 报告标题
- 居中显示"设备验收报告"
- 使用蓝色标题样式

#### 3.2 基本信息表格
包含以下信息：
- 报告编号
- 验收单号
- 验收类型（FAT/SAT/终验收）
- 版本号
- 项目名称
- 设备名称
- 验收日期
- 验收地点

#### 3.3 一、验收项目统计
- **按分类统计表格**：
  - 分类名称
  - 总数
  - 通过数
  - 不通过数
  - 不适用数
  - 有条件通过数
  - 通过率（支持有条件通过的权重计算）
- **合计行**：显示所有分类的汇总数据

#### 3.4 二、验收结论
- 验收结果（通过/不通过/有条件通过）
- 验收结论说明
- 条件说明（如果有条件通过）

#### 3.5 三、验收问题
- 问题统计摘要：
  - 总问题数
  - 已解决数
  - 待解决数
  - 阻塞问题数
- **问题列表表格**（最多显示10个）：
  - 问题编号
  - 标题
  - 严重程度
  - 状态
  - 是否阻塞

#### 3.6 四、签字确认
- **签字记录表格**（如果 `include_signatures=True`）：
  - 签字人类型（质检/项目经理/客户/见证人）
  - 签字人姓名
  - 角色
  - 公司
  - 签字时间

#### 3.7 报告生成信息
- 报告生成时间
- 生成人

## 实现细节

### 1. 自动降级机制

如果 PDF 生成失败（例如 reportlab 库未安装），系统会自动降级到文本格式：

```python
try:
    if REPORTLAB_AVAILABLE:
        # 生成PDF
        pdf_bytes = generate_pdf_report(...)
        file_rel_path = f"reports/{report_no}.pdf"
    else:
        raise ImportError("reportlab库未安装")
except Exception as e:
    # 回退到文本格式
    logger.warning(f"PDF生成失败，使用文本格式: {str(e)}")
    file_rel_path = f"reports/{report_no}.txt"
```

### 2. 文件格式识别

下载 API 会根据文件扩展名自动识别格式：
- `.pdf` → `application/pdf`
- `.txt` → `text/plain`

### 3. 通过率计算

PDF 报告中的通过率计算支持：
- 不适用(NA)项不计入总数
- 有条件通过按 0.8 权重计算
- 公式：`通过率 = (通过数 + 有条件通过数 * 0.8) / (总数 - 不适用数) * 100%`

## API 使用

### 生成 PDF 报告

```http
POST /api/v1/acceptance-orders/{order_id}/report
Content-Type: application/json

{
  "report_type": "FAT",
  "version": 1,
  "include_signatures": true
}
```

**响应**:
```json
{
  "id": 1,
  "order_id": 123,
  "report_no": "RPT-250115-001",
  "report_type": "FAT",
  "version": 1,
  "file_path": "reports/RPT-250115-001.pdf",
  "file_size": 45678,
  "file_hash": "abc123...",
  "generated_at": "2025-01-15T10:30:00",
  "generated_by": 1,
  "generated_by_name": "张三"
}
```

### 下载报告

```http
GET /api/v1/acceptance-reports/{report_id}/download
```

**响应**: PDF 文件（如果生成成功）或文本文件（如果 PDF 生成失败）

### 获取报告列表

```http
GET /api/v1/acceptance-orders/{order_id}/report
```

**响应**: 返回该验收单的所有报告列表（按版本号降序）

## PDF 报告样式

### 颜色方案
- **标题颜色**: `#1e40af` (蓝色)
- **表格标题背景**: `#1e40af` (蓝色)
- **表格标题文字**: 白色
- **表格行背景**: `#f3f4f6` (浅灰色，用于合计行)
- **边框颜色**: 灰色

### 字体
- **标题**: Helvetica-Bold, 18pt
- **章节标题**: Helvetica-Bold, 14pt
- **正文**: Helvetica, 10pt
- **表格**: Helvetica, 9-11pt

### 页面设置
- **页面大小**: A4
- **边距**: 上下左右各 2cm
- **行距**: 14pt

## 报告内容示例

### PDF 报告包含的内容

1. **封面信息**
   - 报告标题
   - 基本信息表格

2. **验收项目统计表**
   ```
   分类        总数   通过   不通过  不适用  有条件通过  通过率
   安全检查     8      8       0       0        0       100%
   功能检查    20     19       1       0        0        95%
   精度检查    10     10       0       0        0       100%
   产能验证     5      5       0       0        0       100%
   文档交付     7      7       0       0        0       100%
   ────────────────────────────────────────────────
   合计        50     49       1       0        0        98%
   ```

3. **验收结论**
   - 验收结果
   - 结论说明
   - 条件说明

4. **问题统计和列表**
   - 问题摘要
   - 问题详情表格（最多10个）

5. **签字确认表**
   - 所有签字记录

## 错误处理

### 1. reportlab 库未安装

如果 `reportlab` 库未安装，系统会：
- 记录警告日志
- 自动使用文本格式生成报告
- 返回文本格式的报告文件

### 2. PDF 生成异常

如果 PDF 生成过程中出现异常：
- 捕获异常并记录日志
- 自动降级到文本格式
- 确保报告生成功能始终可用

## 文件存储

### 存储位置
- PDF 文件：`uploads/reports/{report_no}.pdf`
- 文本文件：`uploads/reports/{report_no}.txt`（降级时）

### 文件命名
- 格式：`RPT-yymmdd-xxx.pdf` 或 `RPT-yymmdd-xxx.txt`
- 示例：`RPT-250115-001.pdf`

## 性能考虑

### 优化建议
1. **大报告处理**：如果检查项或问题数量很大，可以考虑分页显示
2. **缓存**：可以缓存已生成的 PDF 文件，避免重复生成
3. **异步生成**：对于大型报告，可以考虑异步生成

### 当前实现
- 问题列表最多显示 10 个（避免 PDF 过大）
- 使用内存缓冲区生成 PDF，减少磁盘 I/O
- 生成后立即保存，不占用内存

## 兼容性

### 向后兼容
- ✅ 如果 reportlab 不可用，自动降级到文本格式
- ✅ 文本格式报告仍然可用
- ✅ 现有 API 接口不变

### 数据库兼容
- ✅ 报告表结构无需修改
- ✅ `file_path` 字段支持 `.pdf` 和 `.txt` 扩展名

## 测试建议

### 单元测试
1. PDF 生成函数测试
2. 降级机制测试（模拟 reportlab 不可用）
3. 文件保存测试
4. 报告内容完整性测试

### 集成测试
1. 生成 PDF 报告并下载
2. 验证 PDF 文件格式正确
3. 验证报告内容完整
4. 测试降级机制

## 后续优化建议

### 可选功能
1. **自定义模板**：支持使用 HTML/CSS 模板生成 PDF
2. **图表支持**：在 PDF 中添加统计图表
3. **图片支持**：支持在报告中插入图片（如设备照片）
4. **多语言支持**：支持英文报告
5. **水印**：添加"草稿"或"正式"水印
6. **电子签名**：在 PDF 中嵌入电子签名图片

## 相关文档
- 设计文档：`claude 设计方案/验收管理模块_详细设计文档.md` (第1249-1300行)
- 评估报告：`验收管理模块完成情况评估.md`

## 状态
✅ **已完成** - PDF 报告生成功能已实现，支持自动降级到文本格式

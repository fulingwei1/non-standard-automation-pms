# 验收管理模块 详细设计文档

## 文档信息
- **模块名称**: 验收管理模块（Acceptance Management）
- **版本**: v1.0
- **创建日期**: 2025-07-12
- **最后更新**: 2025-07-12
- **编写人**: System Architect
- **状态**: 初稿

---

## 1. 模块定位与目标

### 1.1 模块定位

验收管理模块是非标自动化项目管理系统的核心质量门户模块，负责管理项目从出厂验收（FAT）到现场验收（SAT）再到终验收的完整验收流程。本模块确保每台设备在交付客户前经过严格的质量检验，并建立完整的验收记录追溯体系。

### 1.2 核心目标

| 目标 | 描述 |
|------|------|
| 验收流程标准化 | 建立FAT/SAT/终验收标准流程，确保质量一致性 |
| 验收项目可配置 | 支持按项目/设备类型配置验收检查项 |
| 问题闭环管理 | 验收发现的问题必须闭环处理后才能通过 |
| 客户参与透明 | 支持客户在线查看验收进度、确认验收结果 |
| 数据追溯完整 | 完整记录验收过程、问题处理、签字确认 |

### 1.3 业务价值

```
┌─────────────────────────────────────────────────────────────────┐
│                      验收管理业务价值                            │
├─────────────────────────────────────────────────────────────────┤
│  质量保障        │ 标准化验收流程，确保设备出厂/交付质量        │
│  风险控制        │ 问题前置发现，避免现场返工成本               │
│  客户满意度      │ 透明化验收过程，提升客户信任                 │
│  责任可追溯      │ 完整的验收记录，明确责任划分                 │
│  回款依据        │ 验收通过作为合同回款的重要里程碑             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 验收类型与流程

### 2.1 验收类型定义

| 验收类型 | 英文缩写 | 中文名称 | 执行地点 | 参与方 | 说明 |
|----------|----------|----------|----------|--------|------|
| FAT | Factory Acceptance Test | 出厂验收 | 工厂内 | 内部QA + 客户（可选） | 设备出厂前的内部质量验收 |
| SAT | Site Acceptance Test | 现场验收 | 客户现场 | QA + 调试 + 客户 | 设备到达客户现场后的验收 |
| FINAL | Final Acceptance | 终验收 | 客户现场 | PM + QA + 客户 | 项目整体交付验收，触发质保期 |

### 2.2 验收阶段与项目阶段映射

```
项目阶段(Stage)        验收类型        触发条件
─────────────────────────────────────────────────────────
S6-调试出厂阶段  ──→   FAT验收   ──→  调试完成，准备出厂
                         │
                         ▼
S7-现场调试阶段  ──→   SAT验收   ──→  现场安装调试完成
                         │
                         ▼
S8-验收结项阶段  ──→  终验收    ──→  SAT通过，客户确认交付
                         │
                         ▼
S9-质保结项阶段  ──→  质保期开始 ──→  终验收通过日期起算
```

### 2.3 验收状态流转

```
验收单状态流转图：

  ┌─────────┐
  │  DRAFT  │ 草稿（创建验收单）
  └────┬────┘
       │ 提交验收
       ▼
  ┌─────────┐
  │ PENDING │ 待验收（等待执行）
  └────┬────┘
       │ 开始验收
       ▼
  ┌─────────────┐
  │ IN_PROGRESS │ 验收中
  └──────┬──────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌───────┐  ┌────────┐
│ PASSED│  │ FAILED │ 验收不通过
└───┬───┘  └────┬───┘
    │           │ 问题处理完成
    │           ▼
    │      ┌─────────┐
    │      │ RETRYING│ 复验中
    │      └────┬────┘
    │           │
    └─────┬─────┘
          │
          ▼
   ┌────────────┐
   │ CONFIRMING │ 待客户确认
   └──────┬─────┘
          │ 客户签字确认
          ▼
    ┌───────────┐
    │ COMPLETED │ 验收完成
    └───────────┘
```

### 2.4 验收检查项状态

| 状态 | 编码 | 说明 |
|------|------|------|
| 待检 | PENDING | 检查项未开始 |
| 通过 | PASSED | 检查项通过 |
| 不通过 | FAILED | 检查项不通过，需处理 |
| 不适用 | N/A | 检查项不适用于当前设备 |
| 有条件通过 | CONDITIONAL | 有偏差但可接受，需记录 |

---

## 3. 验收模板管理

### 3.1 模板层级结构

```
验收模板层级：

公司级模板（System Level）
    │
    ├── 设备类型模板（Equipment Type Level）
    │       │
    │       ├── 组装线模板
    │       ├── 检测设备模板
    │       ├── 包装设备模板
    │       └── ...
    │
    └── 项目定制模板（Project Level）
            │
            └── 基于设备类型模板 + 客户特殊要求
```

### 3.2 验收检查项分类

| 分类编码 | 分类名称 | 典型检查项 |
|----------|----------|------------|
| SAFETY | 安全检查 | 急停功能、安全门、防护罩、警示标识 |
| FUNCTION | 功能检查 | 各工位功能、联动逻辑、异常处理 |
| ACCURACY | 精度检查 | 定位精度、重复精度、检测精度 |
| CAPACITY | 产能验证 | 节拍时间、良率、连续运行稳定性 |
| DOCUMENT | 文档交付 | 操作手册、电气图纸、程序备份、培训记录 |
| APPEARANCE | 外观检查 | 设备外观、标识、清洁度 |

### 3.3 模板数据结构

```
验收模板结构：

AcceptanceTemplate（验收模板）
├── template_code: "TPL_FAT_ASSEMBLY_LINE"
├── template_name: "组装线FAT验收模板"
├── acceptance_type: "FAT"
├── equipment_type: "ASSEMBLY_LINE"
├── version: "2.0"
├── is_active: true
│
└── TemplateCategories（模板分类）
    ├── [SAFETY] 安全检查（权重20%）
    │   ├── [S001] 急停按钮功能测试 - 必检项
    │   ├── [S002] 安全门联锁功能 - 必检项
    │   ├── [S003] 安全光栅功能 - 可选项
    │   └── ...
    │
    ├── [FUNCTION] 功能检查（权重30%）
    │   ├── [F001] 上料工位功能验证
    │   ├── [F002] 加工工位功能验证
    │   └── ...
    │
    ├── [ACCURACY] 精度检查（权重25%）
    │   ├── [A001] X轴定位精度 ±0.05mm
    │   ├── [A002] 重复定位精度 ±0.02mm
    │   └── ...
    │
    ├── [CAPACITY] 产能验证（权重15%）
    │   ├── [C001] 单件节拍时间 ≤15s
    │   ├── [C002] 连续运行2小时稳定性
    │   └── ...
    │
    └── [DOCUMENT] 文档交付（权重10%）
        ├── [D001] 操作维护手册
        ├── [D002] 电气原理图
        └── ...
```

---

## 4. 数据模型设计

### 4.1 核心实体关系

```
┌─────────────────────────────────────────────────────────────────┐
│                        实体关系图                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐     ┌──────────────┐     ┌──────────────────┐   │
│  │ projects │────→│   machines   │←────│ acceptance_orders │   │
│  └──────────┘     └──────────────┘     └────────┬─────────┘   │
│                                                  │              │
│  ┌──────────────────────┐                       │              │
│  │ acceptance_templates │                       │              │
│  └───────────┬──────────┘                       │              │
│              │                                   │              │
│              ▼                                   ▼              │
│  ┌───────────────────────┐     ┌────────────────────────────┐ │
│  │ template_categories   │     │ acceptance_order_items     │ │
│  └───────────┬───────────┘     └─────────────┬──────────────┘ │
│              │                                │               │
│              ▼                                │               │
│  ┌───────────────────────┐                   │               │
│  │ template_check_items  │←──────────────────┘               │
│  └───────────────────────┘                                    │
│                                                                │
│  ┌──────────────────────┐      ┌─────────────────────────┐   │
│  │ acceptance_issues    │←─────│ acceptance_order_items  │   │
│  └───────────┬──────────┘      └─────────────────────────┘   │
│              │                                                │
│              ▼                                                │
│  ┌──────────────────────┐                                    │
│  │ issue_follow_ups     │                                    │
│  └──────────────────────┘                                    │
│                                                                │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 数据表设计

#### 4.2.1 验收模板表（acceptance_templates）

```sql
CREATE TABLE acceptance_templates (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    template_code   VARCHAR(50) NOT NULL UNIQUE,      -- 模板编码
    template_name   VARCHAR(200) NOT NULL,            -- 模板名称
    acceptance_type VARCHAR(20) NOT NULL,             -- FAT/SAT/FINAL
    equipment_type  VARCHAR(50),                      -- 设备类型
    version         VARCHAR(20) DEFAULT '1.0',        -- 版本号
    description     TEXT,                             -- 模板说明
    is_system       BOOLEAN DEFAULT 0,                -- 是否系统预置
    is_active       BOOLEAN DEFAULT 1,                -- 是否启用
    created_by      INTEGER,                          -- 创建人
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE INDEX idx_acceptance_templates_type ON acceptance_templates(acceptance_type);
CREATE INDEX idx_acceptance_templates_equip ON acceptance_templates(equipment_type);
```

#### 4.2.2 模板检查分类表（template_categories）

```sql
CREATE TABLE template_categories (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    template_id     INTEGER NOT NULL,                 -- 所属模板
    category_code   VARCHAR(20) NOT NULL,             -- 分类编码
    category_name   VARCHAR(100) NOT NULL,            -- 分类名称
    weight          DECIMAL(5,2) DEFAULT 0,           -- 权重百分比
    sort_order      INTEGER DEFAULT 0,                -- 排序
    is_required     BOOLEAN DEFAULT 1,                -- 是否必检分类
    description     TEXT,                             -- 分类说明

    FOREIGN KEY (template_id) REFERENCES acceptance_templates(id),
    UNIQUE(template_id, category_code)
);
```

#### 4.2.3 模板检查项表（template_check_items）

```sql
CREATE TABLE template_check_items (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    category_id     INTEGER NOT NULL,                 -- 所属分类
    item_code       VARCHAR(50) NOT NULL,             -- 检查项编码
    item_name       VARCHAR(200) NOT NULL,            -- 检查项名称
    check_method    TEXT,                             -- 检查方法
    acceptance_criteria TEXT,                         -- 验收标准
    standard_value  VARCHAR(100),                     -- 标准值
    tolerance_min   VARCHAR(50),                      -- 下限
    tolerance_max   VARCHAR(50),                      -- 上限
    unit            VARCHAR(20),                      -- 单位
    is_required     BOOLEAN DEFAULT 1,                -- 是否必检项
    is_key_item     BOOLEAN DEFAULT 0,                -- 是否关键项
    sort_order      INTEGER DEFAULT 0,                -- 排序

    FOREIGN KEY (category_id) REFERENCES template_categories(id)
);

CREATE INDEX idx_template_check_items_category ON template_check_items(category_id);
```

#### 4.2.4 验收单表（acceptance_orders）

```sql
CREATE TABLE acceptance_orders (
    id                  INTEGER PRIMARY KEY AUTOINCREMENT,
    order_no            VARCHAR(50) NOT NULL UNIQUE,  -- 验收单号
    project_id          INTEGER NOT NULL,             -- 项目ID
    machine_id          INTEGER,                      -- 设备ID（可选，终验收可能是整个项目）
    acceptance_type     VARCHAR(20) NOT NULL,         -- FAT/SAT/FINAL
    template_id         INTEGER,                      -- 使用的模板

    -- 验收信息
    planned_date        DATE,                         -- 计划验收日期
    actual_start_date   DATETIME,                     -- 实际开始时间
    actual_end_date     DATETIME,                     -- 实际结束时间
    location            VARCHAR(200),                 -- 验收地点

    -- 状态
    status              VARCHAR(20) DEFAULT 'DRAFT',  -- 验收状态

    -- 统计
    total_items         INTEGER DEFAULT 0,            -- 检查项总数
    passed_items        INTEGER DEFAULT 0,            -- 通过项数
    failed_items        INTEGER DEFAULT 0,            -- 不通过项数
    na_items            INTEGER DEFAULT 0,            -- 不适用项数
    pass_rate           DECIMAL(5,2) DEFAULT 0,       -- 通过率

    -- 结论
    overall_result      VARCHAR(20),                  -- PASSED/FAILED/CONDITIONAL
    conclusion          TEXT,                         -- 验收结论
    conditions          TEXT,                         -- 有条件通过的条件说明

    -- 签字确认
    qa_signer_id        INTEGER,                      -- QA签字人
    qa_signed_at        DATETIME,                     -- QA签字时间
    customer_signer     VARCHAR(100),                 -- 客户签字人（姓名）
    customer_signed_at  DATETIME,                     -- 客户签字时间
    customer_signature  TEXT,                         -- 客户电子签名（Base64）

    -- 附件
    report_file_path    VARCHAR(500),                 -- 验收报告文件路径

    created_by          INTEGER,
    created_at          DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at          DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (template_id) REFERENCES acceptance_templates(id),
    FOREIGN KEY (qa_signer_id) REFERENCES users(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE INDEX idx_acceptance_orders_project ON acceptance_orders(project_id);
CREATE INDEX idx_acceptance_orders_machine ON acceptance_orders(machine_id);
CREATE INDEX idx_acceptance_orders_status ON acceptance_orders(status);
CREATE INDEX idx_acceptance_orders_type ON acceptance_orders(acceptance_type);
```

#### 4.2.5 验收单检查项表（acceptance_order_items）

```sql
CREATE TABLE acceptance_order_items (
    id                  INTEGER PRIMARY KEY AUTOINCREMENT,
    order_id            INTEGER NOT NULL,             -- 验收单ID
    template_item_id    INTEGER,                      -- 模板检查项ID（可追溯）

    -- 检查项信息（从模板复制，允许调整）
    category_code       VARCHAR(20) NOT NULL,
    category_name       VARCHAR(100) NOT NULL,
    item_code           VARCHAR(50) NOT NULL,
    item_name           VARCHAR(200) NOT NULL,
    check_method        TEXT,
    acceptance_criteria TEXT,
    standard_value      VARCHAR(100),
    tolerance_min       VARCHAR(50),
    tolerance_max       VARCHAR(50),
    unit                VARCHAR(20),
    is_required         BOOLEAN DEFAULT 1,
    is_key_item         BOOLEAN DEFAULT 0,
    sort_order          INTEGER DEFAULT 0,

    -- 检查结果
    result_status       VARCHAR(20) DEFAULT 'PENDING', -- PENDING/PASSED/FAILED/NA/CONDITIONAL
    actual_value        VARCHAR(100),                  -- 实际值
    deviation           VARCHAR(100),                  -- 偏差
    remark              TEXT,                          -- 备注

    -- 检查记录
    checked_by          INTEGER,                       -- 检查人
    checked_at          DATETIME,                      -- 检查时间

    -- 复验信息
    retry_count         INTEGER DEFAULT 0,             -- 复验次数
    last_retry_at       DATETIME,                      -- 最后复验时间

    FOREIGN KEY (order_id) REFERENCES acceptance_orders(id),
    FOREIGN KEY (template_item_id) REFERENCES template_check_items(id),
    FOREIGN KEY (checked_by) REFERENCES users(id)
);

CREATE INDEX idx_order_items_order ON acceptance_order_items(order_id);
CREATE INDEX idx_order_items_status ON acceptance_order_items(result_status);
```

#### 4.2.6 验收问题表（acceptance_issues）

```sql
CREATE TABLE acceptance_issues (
    id                  INTEGER PRIMARY KEY AUTOINCREMENT,
    issue_no            VARCHAR(50) NOT NULL UNIQUE,  -- 问题编号
    order_id            INTEGER NOT NULL,             -- 验收单ID
    order_item_id       INTEGER,                      -- 关联检查项（可选）

    -- 问题信息
    issue_type          VARCHAR(20) NOT NULL,         -- DEFECT/DEVIATION/SUGGESTION
    severity            VARCHAR(20) NOT NULL,         -- CRITICAL/MAJOR/MINOR
    title               VARCHAR(200) NOT NULL,        -- 问题标题
    description         TEXT NOT NULL,                -- 问题描述
    found_at            DATETIME DEFAULT CURRENT_TIMESTAMP, -- 发现时间
    found_by            INTEGER,                      -- 发现人

    -- 处理信息
    status              VARCHAR(20) DEFAULT 'OPEN',   -- OPEN/PROCESSING/RESOLVED/CLOSED/DEFERRED
    assigned_to         INTEGER,                      -- 处理负责人
    due_date            DATE,                         -- 要求完成日期

    -- 解决信息
    solution            TEXT,                         -- 解决方案
    resolved_at         DATETIME,                     -- 解决时间
    resolved_by         INTEGER,                      -- 解决人

    -- 验证信息
    verified_at         DATETIME,                     -- 验证时间
    verified_by         INTEGER,                      -- 验证人
    verified_result     VARCHAR(20),                  -- VERIFIED/REJECTED

    -- 是否阻塞验收
    is_blocking         BOOLEAN DEFAULT 0,            -- 是否阻塞验收通过

    -- 附件
    attachments         TEXT,                         -- 附件列表JSON

    created_at          DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at          DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (order_id) REFERENCES acceptance_orders(id),
    FOREIGN KEY (order_item_id) REFERENCES acceptance_order_items(id),
    FOREIGN KEY (found_by) REFERENCES users(id),
    FOREIGN KEY (assigned_to) REFERENCES users(id),
    FOREIGN KEY (resolved_by) REFERENCES users(id),
    FOREIGN KEY (verified_by) REFERENCES users(id)
);

CREATE INDEX idx_acceptance_issues_order ON acceptance_issues(order_id);
CREATE INDEX idx_acceptance_issues_status ON acceptance_issues(status);
CREATE INDEX idx_acceptance_issues_severity ON acceptance_issues(severity);
CREATE INDEX idx_acceptance_issues_assigned ON acceptance_issues(assigned_to);
```

#### 4.2.7 问题跟进记录表（issue_follow_ups）

```sql
CREATE TABLE issue_follow_ups (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    issue_id        INTEGER NOT NULL,                 -- 问题ID
    action_type     VARCHAR(20) NOT NULL,             -- COMMENT/STATUS_CHANGE/ASSIGN/RESOLVE/VERIFY
    action_content  TEXT NOT NULL,                    -- 操作内容
    old_value       VARCHAR(100),                     -- 原值（状态变更时）
    new_value       VARCHAR(100),                     -- 新值（状态变更时）
    attachments     TEXT,                             -- 附件JSON
    created_by      INTEGER,
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (issue_id) REFERENCES acceptance_issues(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE INDEX idx_issue_follow_ups_issue ON issue_follow_ups(issue_id);
```

#### 4.2.8 验收签字记录表（acceptance_signatures）

```sql
CREATE TABLE acceptance_signatures (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    order_id        INTEGER NOT NULL,                 -- 验收单ID
    signer_type     VARCHAR(20) NOT NULL,             -- QA/PM/CUSTOMER/WITNESS
    signer_role     VARCHAR(50),                      -- 签字人角色
    signer_name     VARCHAR(100) NOT NULL,            -- 签字人姓名
    signer_user_id  INTEGER,                          -- 系统用户ID（内部人员）
    signer_company  VARCHAR(200),                     -- 签字人公司（外部人员）
    signature_data  TEXT,                             -- 电子签名数据（Base64）
    signed_at       DATETIME DEFAULT CURRENT_TIMESTAMP,
    ip_address      VARCHAR(50),                      -- 签字IP
    device_info     VARCHAR(200),                     -- 设备信息

    FOREIGN KEY (order_id) REFERENCES acceptance_orders(id),
    FOREIGN KEY (signer_user_id) REFERENCES users(id)
);

CREATE INDEX idx_acceptance_signatures_order ON acceptance_signatures(order_id);
```

#### 4.2.9 验收报告表（acceptance_reports）

```sql
CREATE TABLE acceptance_reports (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    order_id        INTEGER NOT NULL,                 -- 验收单ID
    report_no       VARCHAR(50) NOT NULL UNIQUE,      -- 报告编号
    report_type     VARCHAR(20) NOT NULL,             -- DRAFT/OFFICIAL
    version         INTEGER DEFAULT 1,                -- 版本号

    -- 报告内容
    report_content  TEXT,                             -- 报告正文（Markdown/HTML）

    -- 文件信息
    file_path       VARCHAR(500),                     -- PDF文件路径
    file_size       INTEGER,                          -- 文件大小
    file_hash       VARCHAR(64),                      -- 文件哈希（防篡改）

    generated_at    DATETIME,                         -- 生成时间
    generated_by    INTEGER,                          -- 生成人

    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (order_id) REFERENCES acceptance_orders(id),
    FOREIGN KEY (generated_by) REFERENCES users(id)
);

CREATE INDEX idx_acceptance_reports_order ON acceptance_reports(order_id);
```

---

## 5. 验收流程详解

### 5.1 FAT（出厂验收）流程

```
FAT流程详解：

┌──────────────────────────────────────────────────────────────────┐
│                        FAT 出厂验收流程                           │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  1. 触发条件                                                      │
│     ├── 设备调试完成                                              │
│     ├── 调试报告已提交                                            │
│     └── 项目进入S6阶段                                            │
│                                                                   │
│  2. 验收准备                                                      │
│     ├── QA创建FAT验收单                                           │
│     ├── 选择/定制验收模板                                         │
│     ├── 确认验收检查项                                            │
│     ├── 通知相关人员（可选通知客户）                               │
│     └── 准备验收所需物料/工具                                      │
│                                                                   │
│  3. 执行验收                                                      │
│     ├── 按分类逐项检查                                            │
│     ├── 记录实际值/偏差                                           │
│     ├── 拍照/录像留证                                             │
│     └── 发现问题及时记录                                          │
│                                                                   │
│  4. 问题处理                                                      │
│     ├── 创建问题单并指派                                          │
│     ├── 责任人处理问题                                            │
│     ├── QA验证问题解决                                            │
│     └── 必要时进行复验                                            │
│                                                                   │
│  5. 验收结论                                                      │
│     ├── 所有必检项通过                                            │
│     ├── 关键项无阻塞问题                                          │
│     ├── 填写验收结论                                              │
│     └── QA签字确认                                                │
│                                                                   │
│  6. 出厂放行                                                      │
│     ├── 生成FAT验收报告                                           │
│     ├── 通知PMC安排发货                                           │
│     └── 设备状态变更为"待发货"                                     │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

### 5.2 SAT（现场验收）流程

```
SAT流程详解：

┌──────────────────────────────────────────────────────────────────┐
│                        SAT 现场验收流程                           │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  1. 触发条件                                                      │
│     ├── 设备已到达客户现场                                        │
│     ├── 现场安装调试完成                                          │
│     └── 项目进入S7阶段                                            │
│                                                                   │
│  2. 验收准备                                                      │
│     ├── 与客户确认验收时间                                        │
│     ├── 创建SAT验收单                                             │
│     ├── 发送验收通知给客户                                        │
│     ├── 准备验收检查表                                            │
│     └── 确认客户方参与人员                                        │
│                                                                   │
│  3. 执行验收                                                      │
│     ├── 客户参与见证                                              │
│     ├── 按检查项逐一验证                                          │
│     ├── 客户确认每项结果                                          │
│     ├── 实时记录客户意见                                          │
│     └── 问题当场确认并记录                                        │
│                                                                   │
│  4. 问题协商                                                      │
│     ├── 区分设备问题/客户原因                                     │
│     ├── 确定问题处理方案                                          │
│     ├── 约定整改期限                                              │
│     └── 签署问题确认单                                            │
│                                                                   │
│  5. 客户确认                                                      │
│     ├── 填写验收意见                                              │
│     ├── 客户代表签字                                              │
│     ├── 电子签名存档                                              │
│     └── 拍照留存签字页                                            │
│                                                                   │
│  6. 后续处理                                                      │
│     ├── 问题闭环跟踪                                              │
│     ├── 必要时安排复验                                            │
│     ├── 生成SAT验收报告                                           │
│     └── 触发终验收流程                                            │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

### 5.3 终验收流程

```
终验收流程详解：

┌──────────────────────────────────────────────────────────────────┐
│                          终验收流程                               │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  1. 触发条件                                                      │
│     ├── 所有SAT验收已通过                                         │
│     ├── 遗留问题已处理                                            │
│     ├── 客户同意进行终验收                                        │
│     └── 项目进入S8阶段                                            │
│                                                                   │
│  2. 验收范围                                                      │
│     ├── 所有设备整体运行                                          │
│     ├── 产能/良率达标验证                                         │
│     ├── 文档资料齐套确认                                          │
│     ├── 培训完成确认                                              │
│     └── 备品备件交付确认                                          │
│                                                                   │
│  3. 验收执行                                                      │
│     ├── 项目经理主持                                              │
│     ├── 客户高层参与                                              │
│     ├── 整体功能演示                                              │
│     ├── 产能测试验证                                              │
│     └── 文档资料移交                                              │
│                                                                   │
│  4. 验收结论                                                      │
│     ├── 验收通过：签署验收证书                                    │
│     ├── 有条件通过：签署附条件验收                                 │
│     └── 验收不通过：记录问题待整改                                 │
│                                                                   │
│  5. 验收完成                                                      │
│     ├── 双方签字确认                                              │
│     ├── 生成终验收报告                                            │
│     ├── 触发质保期开始                                            │
│     ├── 通知财务确认回款节点                                       │
│     └── 项目进入S9质保阶段                                        │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

### 5.4 验收通过条件矩阵

| 验收类型 | 必检项要求 | 关键项要求 | 阻塞问题 | 通过率要求 |
|----------|------------|------------|----------|------------|
| FAT | 全部通过 | 全部通过 | 0个 | ≥95% |
| SAT | 全部通过 | 全部通过 | 0个 | ≥95% |
| 终验收 | 全部通过 | 全部通过 | 0个 | 100% |

---

## 6. API设计

### 6.1 验收模板API

```yaml
# 模板管理API
/api/v1/acceptance/templates:
  GET:
    summary: 获取模板列表
    parameters:
      - acceptance_type: string  # FAT/SAT/FINAL
      - equipment_type: string
      - is_active: boolean
      - page: integer
      - page_size: integer
    responses:
      200:
        content:
          items: Template[]
          total: integer

  POST:
    summary: 创建验收模板
    requestBody:
      template_code: string
      template_name: string
      acceptance_type: string
      equipment_type: string
      description: string
      categories:
        - category_code: string
          category_name: string
          weight: number
          check_items:
            - item_code: string
              item_name: string
              check_method: string
              acceptance_criteria: string
              is_required: boolean
              is_key_item: boolean
    responses:
      201:
        template_id: integer

/api/v1/acceptance/templates/{id}:
  GET:
    summary: 获取模板详情（含检查项）
  PUT:
    summary: 更新模板
  DELETE:
    summary: 删除模板（软删除）

/api/v1/acceptance/templates/{id}/copy:
  POST:
    summary: 复制模板
    requestBody:
      new_code: string
      new_name: string
```

### 6.2 验收单API

```yaml
# 验收单管理API
/api/v1/acceptance/orders:
  GET:
    summary: 获取验收单列表
    parameters:
      - project_id: integer
      - machine_id: integer
      - acceptance_type: string
      - status: string
      - date_from: date
      - date_to: date
    responses:
      200:
        items: AcceptanceOrder[]

  POST:
    summary: 创建验收单
    requestBody:
      project_id: integer
      machine_id: integer
      acceptance_type: string
      template_id: integer
      planned_date: date
      location: string
    responses:
      201:
        order_id: integer
        order_no: string

/api/v1/acceptance/orders/{id}:
  GET:
    summary: 获取验收单详情
    responses:
      200:
        order: AcceptanceOrder
        items: AcceptanceOrderItem[]
        issues: AcceptanceIssue[]
        signatures: Signature[]

  PUT:
    summary: 更新验收单
    requestBody:
      planned_date: date
      location: string

  DELETE:
    summary: 删除验收单（仅草稿状态）

/api/v1/acceptance/orders/{id}/submit:
  POST:
    summary: 提交验收单（草稿→待验收）

/api/v1/acceptance/orders/{id}/start:
  POST:
    summary: 开始验收（待验收→验收中）

/api/v1/acceptance/orders/{id}/items:
  GET:
    summary: 获取检查项列表

  PUT:
    summary: 批量更新检查项结果
    requestBody:
      items:
        - id: integer
          result_status: string
          actual_value: string
          remark: string

/api/v1/acceptance/orders/{id}/items/{item_id}:
  PUT:
    summary: 更新单个检查项结果
    requestBody:
      result_status: string  # PASSED/FAILED/NA/CONDITIONAL
      actual_value: string
      deviation: string
      remark: string

/api/v1/acceptance/orders/{id}/complete:
  POST:
    summary: 完成验收
    requestBody:
      overall_result: string  # PASSED/FAILED/CONDITIONAL
      conclusion: string
      conditions: string      # 有条件通过时的条件

/api/v1/acceptance/orders/{id}/sign:
  POST:
    summary: 签字确认
    requestBody:
      signer_type: string     # QA/CUSTOMER/WITNESS
      signer_name: string
      signer_company: string
      signature_data: string  # Base64签名图片

/api/v1/acceptance/orders/{id}/report:
  GET:
    summary: 获取验收报告
  POST:
    summary: 生成验收报告
    requestBody:
      report_type: string  # DRAFT/OFFICIAL
```

### 6.3 验收问题API

```yaml
# 验收问题管理API
/api/v1/acceptance/issues:
  GET:
    summary: 获取问题列表
    parameters:
      - order_id: integer
      - status: string
      - severity: string
      - assigned_to: integer
    responses:
      200:
        items: AcceptanceIssue[]

  POST:
    summary: 创建问题
    requestBody:
      order_id: integer
      order_item_id: integer
      issue_type: string
      severity: string
      title: string
      description: string
      is_blocking: boolean
      attachments: string[]
    responses:
      201:
        issue_id: integer
        issue_no: string

/api/v1/acceptance/issues/{id}:
  GET:
    summary: 获取问题详情
  PUT:
    summary: 更新问题

/api/v1/acceptance/issues/{id}/assign:
  POST:
    summary: 指派问题
    requestBody:
      assigned_to: integer
      due_date: date
      remark: string

/api/v1/acceptance/issues/{id}/resolve:
  POST:
    summary: 解决问题
    requestBody:
      solution: string
      attachments: string[]

/api/v1/acceptance/issues/{id}/verify:
  POST:
    summary: 验证问题
    requestBody:
      verified_result: string  # VERIFIED/REJECTED
      remark: string

/api/v1/acceptance/issues/{id}/defer:
  POST:
    summary: 延期问题
    requestBody:
      reason: string
      new_due_date: date

/api/v1/acceptance/issues/{id}/follow-ups:
  GET:
    summary: 获取问题跟进记录
  POST:
    summary: 添加跟进记录
    requestBody:
      action_type: string
      action_content: string
      attachments: string[]
```

### 6.4 客户门户API

```yaml
# 客户门户API（外部访问）
/api/v1/portal/acceptance:
  GET:
    summary: 获取待确认验收列表
    headers:
      X-Customer-Token: string
    responses:
      200:
        items: AcceptanceOrder[]

/api/v1/portal/acceptance/{id}:
  GET:
    summary: 获取验收详情
    headers:
      X-Customer-Token: string

/api/v1/portal/acceptance/{id}/confirm:
  POST:
    summary: 客户确认验收
    headers:
      X-Customer-Token: string
    requestBody:
      signer_name: string
      signature_data: string
      comments: string

/api/v1/portal/acceptance/{id}/reject:
  POST:
    summary: 客户拒绝验收
    headers:
      X-Customer-Token: string
    requestBody:
      reason: string
      issues: string[]
```

---

## 7. 业务规则

### 7.1 验收单编号规则

```
FAT验收单：FAT-{项目编号}-{设备序号}-{序号}
示例：FAT-P2025001-M01-001

SAT验收单：SAT-{项目编号}-{设备序号}-{序号}
示例：SAT-P2025001-M01-001

终验收单：FIN-{项目编号}-{序号}
示例：FIN-P2025001-001
```

### 7.2 问题编号规则

```
验收问题：AI-{验收单号后缀}-{序号}
示例：AI-FAT001-001
```

### 7.3 验收约束规则

| 规则编号 | 规则描述 | 触发场景 |
|----------|----------|----------|
| AR001 | FAT验收必须在设备调试完成后 | 创建FAT验收单时检查 |
| AR002 | SAT验收必须在FAT通过后 | 创建SAT验收单时检查 |
| AR003 | 终验收必须在所有SAT通过后 | 创建终验收单时检查 |
| AR004 | 存在未闭环阻塞问题不能通过验收 | 完成验收时检查 |
| AR005 | 必检项全部填写才能完成验收 | 完成验收时检查 |
| AR006 | 客户签字后验收单不可修改 | 编辑验收单时检查 |
| AR007 | 终验收通过自动触发质保期 | 终验收完成时触发 |

### 7.4 通过率计算规则

```python
def calculate_pass_rate(order_items):
    """
    计算验收通过率

    规则：
    1. 不适用(NA)的项不计入总数
    2. 通过率 = (通过数 + 有条件通过数) / (总数 - 不适用数) * 100%
    3. 有条件通过按0.8权重计算
    """
    total = len([i for i in order_items if i.result_status != 'NA'])
    passed = len([i for i in order_items if i.result_status == 'PASSED'])
    conditional = len([i for i in order_items if i.result_status == 'CONDITIONAL'])

    if total == 0:
        return 100.0

    pass_rate = (passed + conditional * 0.8) / total * 100
    return round(pass_rate, 2)
```

---

## 8. UI设计

### 8.1 验收单列表页面

```
┌─────────────────────────────────────────────────────────────────┐
│  验收管理                                              [+ 新建]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ [全部] [FAT] [SAT] [终验收]     [待验收] [验收中] [已完成]│   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 🔍 搜索验收单号/项目名称    [项目▼] [日期范围] [🔍 搜索]  │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 验收单号          类型    项目          设备      状态     │ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ FAT-P2025001-M01  FAT    XX自动化产线   #01设备   ● 验收中 │ │
│  │ ├─ 通过率: 85% (34/40)  问题: 3个待处理                   │ │
│  │ └─ 计划: 2025-01-10  执行人: 张三(QA)                     │ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ SAT-P2025002-M01  SAT    YY检测设备     #01设备   ● 待确认 │ │
│  │ ├─ 通过率: 100% (50/50)  待客户签字                       │ │
│  │ └─ 计划: 2025-01-08  客户: 李四                           │ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ FIN-P2024088      终验   ZZ包装线       全部设备   ✓ 完成  │ │
│  │ ├─ 通过率: 100%  质保期: 2025-01-05 ~ 2026-01-04          │ │
│  │ └─ 签字: 我方-王五  客户方-赵六                            │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  共 25 条记录                              < 1 2 3 ... 5 >      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 验收执行页面

```
┌─────────────────────────────────────────────────────────────────┐
│  ← 返回   FAT-P2025001-M01-001 出厂验收                         │
│  XX自动化生产线 #01设备                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 验收进度                                                 │   │
│  │ ████████████████░░░░░ 80% (32/40)                        │   │
│  │ ✓ 通过:28  ✗ 不通过:4  ○ 待检:8  ⊘ 不适用:0             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ [安全检查] [功能检查] [精度检查] [产能验证] [文档交付]    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 【安全检查】 权重20%  进度 8/8 ✓                          │ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ ☑ S001 急停按钮功能     │ 必检 │ ✓ 通过                  │ │
│  │   标准: 按下后1s内设备停止                                 │ │
│  │   实际值: 0.5s  偏差: -                                   │ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ ☑ S002 安全门联锁       │ 必检 │ ✓ 通过                  │ │
│  │   标准: 开门后设备立即停止                                 │ │
│  │   实际值: 正常  偏差: -                                   │ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ ... 更多检查项 ...                                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 【功能检查】 权重30%  进度 15/20                          │ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ ☐ F005 搬运机构动作     │ 必检 │ ✗ 不通过   [+问题]      │ │
│  │   标准: X/Y/Z三轴联动顺畅                                  │ │
│  │   实际值: Z轴有卡顿  偏差: 异常                           │ │
│  │   ⚠ 问题: AI-FAT001-003 Z轴运动卡顿 [处理中]             │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │          [保存进度]  [提交问题]  [完成验收]              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.3 检查项录入弹窗

```
┌─────────────────────────────────────────────────────────────────┐
│  检查项结果录入                                          [×]    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  检查项: F005 搬运机构动作                                      │
│  检查方法: 手动操作各轴，观察运动平顺性                          │
│  验收标准: X/Y/Z三轴联动顺畅，无卡顿、异响                       │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  检查结果:  ○ 通过  ○ 不通过  ○ 有条件通过  ○ 不适用           │
│                                                                 │
│  实际值:    [Z轴有轻微卡顿                            ]         │
│                                                                 │
│  偏差说明:  [Z轴在快速移动时有卡顿现象                ]         │
│                                                                 │
│  备注:      [需要调整Z轴导轨润滑                      ]         │
│             [                                         ]         │
│                                                                 │
│  附件:      [+ 添加照片/视频]                                   │
│             📷 IMG_001.jpg  📷 IMG_002.jpg                      │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ☐ 同时创建问题单                                               │
│    问题等级: ○ 严重  ● 一般  ○ 轻微                             │
│    是否阻塞: ☐ 阻塞验收通过                                     │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    [取消]    [确定]                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.4 问题管理面板

```
┌─────────────────────────────────────────────────────────────────┐
│  验收问题管理  FAT-P2025001-M01-001                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  问题统计: 总计 5 个  ⚠ 阻塞 2 个                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ● 待处理 2   ● 处理中 2   ● 待验证 1   ✓ 已关闭 0       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ ⚠ AI-FAT001-001 【严重】 主轴电机异响           [阻塞]   │ │
│  │   发现: 2025-01-08 张三    状态: 处理中                   │ │
│  │   负责: 李四(机械)         期限: 2025-01-10               │ │
│  │   [查看详情] [添加跟进]                                   │ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ ⚠ AI-FAT001-002 【严重】 急停功能延迟          [阻塞]    │ │
│  │   发现: 2025-01-08 张三    状态: 待验证                   │ │
│  │   负责: 王五(电气)         解决: 2025-01-09               │ │
│  │   [查看详情] [验证结果]                                   │ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │   AI-FAT001-003 【一般】 触摸屏显示偏色                   │ │
│  │   发现: 2025-01-08 张三    状态: 处理中                   │ │
│  │   负责: 赵六(电气)         期限: 2025-01-12               │ │
│  │   [查看详情] [添加跟进]                                   │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                              [+ 新增问题]  [导出报告]    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.5 客户签字确认页面

```
┌─────────────────────────────────────────────────────────────────┐
│                        SAT 现场验收确认                          │
│                      XX自动化生产线 #01设备                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                       验收结论                           │   │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │   │
│  │                                                          │   │
│  │  验收结果:  ✓ 通过                                       │   │
│  │  验收日期:  2025年01月10日                               │   │
│  │  验收地点:  XX公司生产车间                               │   │
│  │                                                          │   │
│  │  检查项统计:                                             │   │
│  │    总计: 50项  通过: 48项  有条件通过: 2项              │   │
│  │    通过率: 100%                                          │   │
│  │                                                          │   │
│  │  遗留问题: 2项（均为非阻塞性问题，承诺15日内解决）       │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  客户意见:                                               │   │
│  │  [整体验收情况良好，设备运行稳定。                   ]   │   │
│  │  [触摸屏响应速度需优化，已确认后续处理。             ]   │   │
│  │  [                                                   ]   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  请在下方签名确认:                                       │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │                                                 │    │   │
│  │  │                   [签名区域]                    │    │   │
│  │  │                                                 │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │  签字人: [李四            ]  职位: [生产主管       ]    │   │
│  │                                                          │   │
│  │              [清除签名]              [确认提交]          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.6 验收报告预览

```
┌─────────────────────────────────────────────────────────────────┐
│  验收报告预览                              [导出PDF] [打印]     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                          │   │
│  │                     ████ 公司名称 ████                   │   │
│  │                                                          │   │
│  │                   设 备 验 收 报 告                      │   │
│  │                                                          │   │
│  │  ─────────────────────────────────────────────────────   │   │
│  │                                                          │   │
│  │  报告编号: FAT-REP-2025001-001                          │   │
│  │  验收类型: 出厂验收(FAT)                                 │   │
│  │  项目名称: XX自动化生产线项目                            │   │
│  │  设备名称: #01 组装单元                                  │   │
│  │  验收日期: 2025年01月10日                                │   │
│  │  验收地点: XX公司装配车间                                │   │
│  │                                                          │   │
│  │  ─────────────────────────────────────────────────────   │   │
│  │                                                          │   │
│  │  一、验收项目统计                                        │   │
│  │                                                          │   │
│  │  分类        总数   通过   不通过  不适用   通过率       │   │
│  │  安全检查     8      8       0       0      100%         │   │
│  │  功能检查    20     19       1       0       95%         │   │
│  │  精度检查    10     10       0       0      100%         │   │
│  │  产能验证     5      5       0       0      100%         │   │
│  │  文档交付     7      7       0       0      100%         │   │
│  │  ────────────────────────────────────────────           │   │
│  │  合计        50     49       1       0       98%         │   │
│  │                                                          │   │
│  │  二、验收结论                                            │   │
│  │                                                          │   │
│  │  本次验收 【通过】                                       │   │
│  │                                                          │   │
│  │  ...更多内容...                                          │   │
│  │                                                          │   │
│  │  ─────────────────────────────────────────────────────   │   │
│  │                                                          │   │
│  │  验收方签字: ___________     客户方签字: ___________    │   │
│  │  日期:                        日期:                      │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  页码: 1 / 5                                    < 上一页 下一页 >│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 权限设计

### 9.1 功能权限矩阵

| 功能 | QA | QA主管 | PM | 调试工程师 | 客户 | 说明 |
|------|:--:|:------:|:--:|:----------:|:----:|------|
| 查看验收单 | ✓ | ✓ | ✓ | ✓ | ○ | 客户仅看自己项目 |
| 创建验收单 | ✓ | ✓ | ○ | ✗ | ✗ | PM可创建终验收 |
| 编辑验收单 | ✓ | ✓ | ○ | ✗ | ✗ | 仅草稿状态 |
| 删除验收单 | ✗ | ✓ | ✗ | ✗ | ✗ | 仅草稿状态 |
| 执行验收 | ✓ | ✓ | ✗ | ○ | ✗ | 调试协助 |
| 录入检查结果 | ✓ | ✓ | ✗ | ○ | ✗ | - |
| 创建问题 | ✓ | ✓ | ✓ | ✓ | ✓ | 客户可反馈 |
| 处理问题 | ✗ | ✗ | ✗ | ✓ | ✗ | 指派给谁谁处理 |
| 验证问题 | ✓ | ✓ | ✗ | ✗ | ✗ | - |
| 完成验收 | ✓ | ✓ | ○ | ✗ | ✗ | PM可完成终验收 |
| QA签字 | ✓ | ✓ | ✗ | ✗ | ✗ | - |
| 客户确认 | ✗ | ✗ | ✗ | ✗ | ✓ | 客户签字 |
| 生成报告 | ✓ | ✓ | ✓ | ✗ | ✗ | - |
| 管理模板 | ✗ | ✓ | ✗ | ✗ | ✗ | - |

### 9.2 数据权限

| 角色 | 数据范围 | 说明 |
|------|----------|------|
| QA | 所有验收单 | 可查看所有项目验收情况 |
| QA主管 | 所有验收单 | 可管理所有验收数据 |
| PM | 本项目验收单 | 仅查看/操作负责项目 |
| 调试工程师 | 参与项目验收单 | 仅协助录入 |
| 客户 | 本客户项目 | 仅查看和确认 |

---

## 10. 集成与通知

### 10.1 模块集成

```
┌─────────────────────────────────────────────────────────────────┐
│                      验收模块集成关系                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  上游模块                         下游模块                       │
│  ─────────                       ─────────                      │
│                                                                 │
│  项目管理模块 ──────┐       ┌────→ 项目管理模块                  │
│  (阶段状态)        │       │      (阶段推进)                    │
│                    │       │                                    │
│  设备管理 ─────────┼──→ 验收 ──→ 设备状态更新                   │
│  (设备信息)        │  管理  │                                    │
│                    │  模块  │                                    │
│  调试管理 ─────────┘       ├────→ 财务模块                       │
│  (调试完成)                │      (回款节点)                     │
│                            │                                    │
│                            └────→ 质保管理                       │
│                                   (质保期启动)                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 10.2 事件触发

| 事件 | 触发动作 |
|------|----------|
| FAT验收通过 | 设备状态→待发货，通知PMC安排发货 |
| SAT验收通过 | 设备状态→已交付，通知PM准备终验收 |
| 终验收通过 | 项目进入S9阶段，触发质保期，通知财务回款 |
| 问题创建 | 通知被指派人，更新问题看板 |
| 问题解决 | 通知QA验证，更新验收单状态 |
| 客户确认 | 更新验收单状态，归档签字记录 |

### 10.3 通知模板

```yaml
验收相关通知:
  acceptance_created:
    title: "验收单已创建"
    template: "验收单 {order_no} 已创建，计划验收日期 {planned_date}"
    recipients: [qa_team, pm]

  acceptance_pending:
    title: "验收待执行"
    template: "验收单 {order_no} 已提交，请安排执行验收"
    recipients: [qa_assigned]

  acceptance_issue_created:
    title: "验收问题待处理"
    template: "验收单 {order_no} 发现问题：{issue_title}，请及时处理"
    recipients: [assigned_to]

  acceptance_issue_resolved:
    title: "验收问题已解决"
    template: "问题 {issue_no} 已解决，请验证"
    recipients: [qa_verifier]

  acceptance_waiting_customer:
    title: "验收待客户确认"
    template: "项目 {project_name} 验收已完成，请客户确认签字"
    recipients: [customer]
    channels: [email, wechat]

  acceptance_completed:
    title: "验收已完成"
    template: "项目 {project_name} 验收已通过，验收报告已生成"
    recipients: [pm, qa_manager, finance]
```

---

## 11. 配置项

### 11.1 系统配置

| 配置项 | 配置键 | 默认值 | 说明 |
|--------|--------|--------|------|
| FAT通过率阈值 | acceptance.fat.pass_rate_threshold | 95 | FAT验收通过率要求(%) |
| SAT通过率阈值 | acceptance.sat.pass_rate_threshold | 95 | SAT验收通过率要求(%) |
| 终验收通过率阈值 | acceptance.final.pass_rate_threshold | 100 | 终验收通过率要求(%) |
| 问题处理时限(一般) | acceptance.issue.due_days.normal | 3 | 一般问题处理天数 |
| 问题处理时限(严重) | acceptance.issue.due_days.critical | 1 | 严重问题处理天数 |
| 验收报告有效期 | acceptance.report.validity_days | 365 | 报告保存天数 |
| 客户签名有效期 | acceptance.signature.expiry_hours | 24 | 签名链接有效小时数 |
| 允许无模板验收 | acceptance.allow_no_template | false | 是否允许不使用模板 |

### 11.2 验收模板配置

```yaml
# 默认验收模板配置
default_templates:
  FAT:
    categories:
      - code: SAFETY
        name: 安全检查
        weight: 20
        required: true
      - code: FUNCTION
        name: 功能检查
        weight: 30
        required: true
      - code: ACCURACY
        name: 精度检查
        weight: 25
        required: true
      - code: CAPACITY
        name: 产能验证
        weight: 15
        required: false
      - code: DOCUMENT
        name: 文档交付
        weight: 10
        required: true

  SAT:
    categories:
      - code: SAFETY
        name: 安全检查
        weight: 15
        required: true
      - code: FUNCTION
        name: 功能检查
        weight: 30
        required: true
      - code: ACCURACY
        name: 精度检查
        weight: 25
        required: true
      - code: CAPACITY
        name: 产能验证
        weight: 20
        required: true
      - code: ENVIRONMENT
        name: 现场环境
        weight: 10
        required: true

  FINAL:
    categories:
      - code: OVERALL
        name: 整体运行
        weight: 30
        required: true
      - code: CAPACITY
        name: 产能达标
        weight: 30
        required: true
      - code: DOCUMENT
        name: 资料移交
        weight: 20
        required: true
      - code: TRAINING
        name: 培训验收
        weight: 10
        required: true
      - code: SPARES
        name: 备件交付
        weight: 10
        required: true
```

---

## 12. 附录

### 12.1 验收状态码对照

| 状态码 | 中文名称 | 英文名称 | 允许操作 |
|--------|----------|----------|----------|
| DRAFT | 草稿 | Draft | 编辑、删除、提交 |
| PENDING | 待验收 | Pending | 开始验收 |
| IN_PROGRESS | 验收中 | In Progress | 录入结果、创建问题 |
| PASSED | 已通过 | Passed | 等待确认 |
| FAILED | 未通过 | Failed | 问题处理 |
| RETRYING | 复验中 | Retrying | 录入结果 |
| CONFIRMING | 待确认 | Confirming | 客户签字 |
| COMPLETED | 已完成 | Completed | 查看、导出 |

### 12.2 问题严重程度定义

| 等级 | 编码 | 定义 | 处理要求 |
|------|------|------|----------|
| 严重 | CRITICAL | 影响设备安全或核心功能 | 24小时内必须解决，阻塞验收 |
| 一般 | MAJOR | 影响设备性能或次要功能 | 3天内解决，可能阻塞验收 |
| 轻微 | MINOR | 外观瑕疵或建议改进 | 约定时间内解决，不阻塞验收 |

### 12.3 术语定义

| 术语 | 英文 | 定义 |
|------|------|------|
| FAT | Factory Acceptance Test | 出厂验收，设备在供应商工厂进行的验收测试 |
| SAT | Site Acceptance Test | 现场验收，设备在客户现场安装调试后进行的验收测试 |
| 终验收 | Final Acceptance | 项目整体交付验收，标志项目正式移交 |
| 检查项 | Check Item | 验收过程中需要检验的具体项目 |
| 阻塞问题 | Blocking Issue | 必须解决后才能通过验收的问题 |
| 有条件通过 | Conditional Pass | 存在偏差但在可接受范围内，需记录备案 |
| 质保期 | Warranty Period | 终验收通过后开始计算的产品保修期 |

---

## 版本历史

| 版本 | 日期 | 修改人 | 修改内容 |
|------|------|--------|----------|
| v1.0 | 2025-07-12 | System Architect | 初始版本 |
